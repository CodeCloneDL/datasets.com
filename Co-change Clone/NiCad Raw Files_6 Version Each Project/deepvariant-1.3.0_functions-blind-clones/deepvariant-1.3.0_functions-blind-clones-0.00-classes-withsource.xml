<clones>
<systeminfo processor="nicad6" system="deepvariant-1.3.0" granularity="functions-blind" threshold="0%" minlines="10" maxlines="2500"/>
<cloneinfo npcs="838" npairs="12"/>
<runinfo ncompares="1580" cputime="43244"/>
<classinfo nclasses="10"/>

<class classid="1" nclones="2" nlines="12" similarity="100">
<source file="systems/deepvariant-1.3.0/deepvariant/very_sensitive_caller_trio_test.py" startline="57" endline="72" pcid="3">
  def fake_allele_counter(self, start_pos, counts):
    allele_counter = mock.Mock()
    # pylint: disable=g-complex-comprehension
    allele_counter.summary_counts.return_value = [
        deepvariant_pb2.AlleleCountSummary(
            ref_supporting_read_count=n_ref,
            total_read_count=n_ref + n_alt,
            ref_base=ref,
            reference_name='chr1',
            position=start_pos + i)
        for i, (n_alt, n_ref, ref) in enumerate(counts)
    ]
    # pylint: enable=g-complex-comprehension
    allele_counter.counts.return_value = counts
    return allele_counter

</source>
<source file="systems/deepvariant-1.3.0/deepvariant/very_sensitive_caller_test.py" startline="63" endline="78" pcid="284">
  def fake_allele_counter(self, start_pos, counts):
    allele_counter = mock.Mock()
    # pylint: disable=g-complex-comprehension
    allele_counter.summary_counts.return_value = [
        deepvariant_pb2.AlleleCountSummary(
            ref_supporting_read_count=n_ref,
            total_read_count=n_ref + n_alt,
            ref_base=ref,
            reference_name='chr1',
            position=start_pos + i)
        for i, (n_alt, n_ref, ref) in enumerate(counts)
    ]
    # pylint: enable=g-complex-comprehension
    allele_counter.counts.return_value = counts
    return allele_counter

</source>
</class>

<class classid="2" nclones="3" nlines="12" similarity="100">
<source file="systems/deepvariant-1.3.0/deepvariant/make_examples.py" startline="151" endline="172" pcid="117">
def main(argv=()):
  with errors.clean_commandline_error_exit():
    if len(argv) > 1:
      errors.log_and_raise(
          'Command line parsing failure: make_examples does not accept '
          'positional arguments but some are present on the command line: '
          '"{}".'.format(str(argv)), errors.CommandLineError)
    del argv  # Unused.

    proto_utils.uses_fast_cpp_protos_or_die()

    logging_level.set_from_flag()
    hts_verbose.set(hts_verbose.htsLogLevel[FLAGS.hts_logging_level])

    # Set up options; may do I/O.
    options = default_options(add_flags=True, flags_obj=FLAGS)
    check_options_are_valid(options)

    # Run!
    make_examples_core.make_examples_runner(options)


</source>
<source file="systems/deepvariant-1.3.0/deeptrio/make_examples.py" startline="283" endline="304" pcid="433">
def main(argv=()):
  with errors.clean_commandline_error_exit():
    if len(argv) > 1:
      errors.log_and_raise(
          'Command line parsing failure: make_examples does not accept '
          'positional arguments but some are present on the command line: '
          '"{}".'.format(str(argv)), errors.CommandLineError)
    del argv  # Unused.

    proto_utils.uses_fast_cpp_protos_or_die()

    logging_level.set_from_flag()
    hts_verbose.set(hts_verbose.htsLogLevel[FLAGS.hts_logging_level])

    # Set up options; may do I/O.
    options = default_options(add_flags=True, flags_obj=FLAGS)
    check_options_are_valid(options)

    # Run!
    make_examples_core.make_examples_runner(options)


</source>
<source file="systems/deepvariant-1.3.0/deepvariant/multisample_make_examples.py" startline="207" endline="228" pcid="150">
def main(argv=()):
  with errors.clean_commandline_error_exit():
    if len(argv) > 1:
      errors.log_and_raise(
          'Command line parsing failure: make_examples does not accept '
          'positional arguments but some are present on the command line: '
          '"{}".'.format(str(argv)), errors.CommandLineError)
    del argv  # Unused.

    proto_utils.uses_fast_cpp_protos_or_die()

    logging_level.set_from_flag()
    hts_verbose.set(hts_verbose.htsLogLevel[FLAGS.hts_logging_level])

    # Set up options; may do I/O.
    options = default_options(add_flags=True, flags_obj=FLAGS)
    check_options_are_valid(options)

    # Run!
    make_examples_core.make_examples_runner(options)


</source>
</class>

<class classid="3" nclones="2" nlines="12" similarity="100">
<source file="systems/deepvariant-1.3.0/deepvariant/labeler/variant_labeler.py" startline="250" endline="265" pcid="230">
  def _match_one_allele(true_allele):
    if true_allele == truth_variant.reference_bases:
      return 0
    else:
      simplifed_true_allele = variant_utils.simplify_alleles(
          truth_variant.reference_bases, true_allele)
      for alt_index, alt_allele in enumerate(candidate_variant.alternate_bases):
        simplifed_alt_allele = variant_utils.simplify_alleles(
            candidate_variant.reference_bases, alt_allele)
        if simplifed_true_allele == simplifed_alt_allele:
          return alt_index + 1
      # If nothing matched, we don't have this alt, so the alt allele index for
      # should be 0 (i.e., not any alt).
      return 0

  # If our candidate_variant is a reference call, return a (0, 0) genotype.
</source>
<source file="systems/deepvariant-1.3.0/deepvariant/labeler/positional_labeler.py" startline="210" endline="225" pcid="246">
  def _match_one_allele(true_allele):
    if true_allele == truth_variant.reference_bases:
      return 0
    else:
      simplified_true_allele = variant_utils.simplify_alleles(
          truth_variant.reference_bases, true_allele)
      for alt_index, alt_allele in enumerate(candidate_variant.alternate_bases):
        simplified_alt_allele = variant_utils.simplify_alleles(
            candidate_variant.reference_bases, alt_allele)
        if simplified_true_allele == simplified_alt_allele:
          return alt_index + 1
      # If nothing matched, we don't have this alt, so the alt allele index for
      # should be 0 (i.e., not any alt).
      return 0

  # If our candidate_variant is a reference call, return a (0, 0) genotype.
</source>
</class>

<class classid="4" nclones="2" nlines="13" similarity="100">
<source file="systems/deepvariant-1.3.0/deepvariant/show_examples_test.py" startline="134" endline="147" pcid="256">
  def test_show_examples_end2end_calling_examples(self):
    output_prefix = test_utils.test_tmpfile('calling')
    FLAGS.examples = testdata.GOLDEN_CALLING_EXAMPLES
    FLAGS.output = output_prefix
    show_examples.run()
    ls = glob.glob('{}*'.format(output_prefix))
    filenames = [os.path.basename(path) for path in ls]
    self.assertTrue(
        all(['calling_channels' in filename for filename in filenames]))
    self.assertTrue(all([filename.endswith('.png') for filename in filenames]))
    self.assertFalse(
        any(['label' in filename for filename in filenames]),
        msg='Calling examples should NOT produce labeled images.')

</source>
<source file="systems/deepvariant-1.3.0/deepvariant/show_examples_test.py" startline="149" endline="162" pcid="257">
  def test_show_examples_end2end_training_examples(self):
    output_prefix = test_utils.test_tmpfile('training')
    FLAGS.examples = testdata.GOLDEN_TRAINING_EXAMPLES
    FLAGS.output = output_prefix
    show_examples.run()
    ls = glob.glob('{}*'.format(output_prefix))
    filenames = [os.path.basename(path) for path in ls]
    self.assertTrue(
        all(['training_channels' in filename for filename in filenames]))
    self.assertTrue(all([filename.endswith('.png') for filename in filenames]))
    self.assertTrue(
        all(['label' in filename for filename in filenames]),
        msg='Training examples should produce labeled images.')

</source>
</class>

<class classid="5" nclones="2" nlines="18" similarity="100">
<source file="systems/deepvariant-1.3.0/deepvariant/realigner/python/ssw_misc_test.py" startline="44" endline="64" pcid="328">
  def test_short(self):
    """Test very short strings."""
    ref = 'tttt'
    query = 'ttAtt'
    match = 4
    mismatch = 2
    gap_extend_penalty = 2
    gap_open_penalty = 4

    aligner = ssw.Aligner.construct(
        match_score=match,
        mismatch_penalty=mismatch,
        gap_opening_penalty=gap_open_penalty,
        gap_extending_penalty=gap_extend_penalty)
    filter_ = ssw.Filter()
    length = aligner.set_reference_sequence(ref)
    self.assertLen(ref, length)
    alignment = aligner.align(query, filter_)
    p(alignment)
    self.assertEqual(six.b('2=1I2='), alignment.cigar_string)

</source>
<source file="systems/deepvariant-1.3.0/deepvariant/realigner/python/ssw_misc_test.py" startline="65" endline="86" pcid="329">
  def test_longer(self):
    """Test longer strings, so the second-best alignment is considered."""
    ref = 'TTTTGGGGGGGGGGGGG'
    query = 'TTATTGGGGGGGGGGGGG'
    match = 4
    mismatch = 2
    gap_extend_penalty = 2
    gap_open_penalty = 4

    aligner = ssw.Aligner.construct(
        match_score=match,
        mismatch_penalty=mismatch,
        gap_opening_penalty=gap_open_penalty,
        gap_extending_penalty=gap_extend_penalty)
    filter_ = ssw.Filter()
    length = aligner.set_reference_sequence(ref)
    self.assertLen(ref, length)
    alignment = aligner.align(query, filter_)
    p(alignment)
    self.assertEqual(six.b('2=1I15='), alignment.cigar_string)


</source>
</class>

<class classid="6" nclones="2" nlines="13" similarity="100">
<source file="systems/deepvariant-1.3.0/scripts/run_deepvariant.py" startline="161" endline="177" pcid="388">
def _extra_args_to_dict(extra_args):
  """Parses comma-separated list of flag_name=flag_value to dict."""
  args_dict = {}
  if extra_args is None:
    return args_dict
  for extra_arg in extra_args.split(','):
    (flag_name, flag_value) = extra_arg.split('=')
    flag_name = flag_name.strip('-')
    # Check for boolean values.
    if flag_value.lower() == 'true':
      flag_value = True
    elif flag_value.lower() == 'false':
      flag_value = False
    args_dict[flag_name] = flag_value
  return args_dict


</source>
<source file="systems/deepvariant-1.3.0/scripts/run_deeptrio.py" startline="234" endline="250" pcid="407">
def _extra_args_to_dict(extra_args):
  """Parses comma-separated list of flag_name=flag_value to dict."""
  args_dict = {}
  if extra_args is None:
    return args_dict
  for extra_arg in extra_args.split(','):
    (flag_name, flag_value) = extra_arg.split('=')
    flag_name = flag_name.strip('-')
    # Check for boolean values.
    if flag_value.lower() == 'true':
      flag_value = True
    elif flag_value.lower() == 'false':
      flag_value = False
    args_dict[flag_name] = flag_value
  return args_dict


</source>
</class>

<class classid="7" nclones="2" nlines="12" similarity="100">
<source file="systems/deepvariant-1.3.0/scripts/run_deepvariant.py" startline="178" endline="192" pcid="389">
def _extend_command_by_args_dict(command, extra_args):
  """Adds `extra_args` to the command string."""
  for key in sorted(extra_args):
    value = extra_args[key]
    if value is None:
      continue
    if isinstance(value, bool):
      added_arg = '' if value else 'no'
      added_arg += key
      command.extend(['--' + added_arg])
    else:
      command.extend(['--' + key, _add_quotes(value)])
  return command


</source>
<source file="systems/deepvariant-1.3.0/scripts/run_deeptrio.py" startline="251" endline="265" pcid="408">
def _extend_command_by_args_dict(command, extra_args):
  """Adds `extra_args` to the command string."""
  for key in sorted(extra_args):
    value = extra_args[key]
    if value is None:
      continue
    if isinstance(value, bool):
      added_arg = '' if value else 'no'
      added_arg += key
      command.extend(['--' + added_arg])
    else:
      command.extend(['--' + key, _add_quotes(value)])
  return command


</source>
</class>

<class classid="8" nclones="2" nlines="11" similarity="100">
<source file="systems/deepvariant-1.3.0/scripts/run_deepvariant.py" startline="193" endline="212" pcid="390">
def _update_kwargs_with_warning(kwargs, extra_args, conflict_args=None):
  """Updates `kwargs` with `extra_args`; crashes if `conflict_args` changed."""
  for k, v in extra_args.items():
    if k in kwargs:
      if conflict_args is not None and k in conflict_args and kwargs[k] != v:
        raise ValueError(
            'The extra_args "{}" might have conflicts with other flags. '
            'See '
            'https://github.com/google/deepvariant/blob/r1.3/docs/'
            'deepvariant-pacbio-model-case-study.md#clarification-'
            'of-the---use_hp_information-flag '
            'for an explanation, or report this issue on '
            'https://github.com/google/deepvariant/issues.'.format(k))
      if kwargs[k] != v:
        print('\nWarning: --{} is previously set to {}, now to {}.'.format(
            k, kwargs[k], v))
    kwargs[k] = v
  return kwargs


</source>
<source file="systems/deepvariant-1.3.0/scripts/run_deeptrio.py" startline="266" endline="285" pcid="409">
def _update_kwargs_with_warning(kwargs, extra_args, conflict_args=None):
  """Updates `kwargs` with `extra_args`; crashes if `conflict_args` changed."""
  for k, v in extra_args.items():
    if k in kwargs:
      if conflict_args is not None and k in conflict_args and kwargs[k] != v:
        raise ValueError(
            'The extra_args "{}" might have conflicts with other flags. '
            'See '
            'https://github.com/google/deepvariant/blob/r1.3/docs/'
            'deepvariant-pacbio-model-case-study.md#clarification-'
            'of-the---use_hp_information-flag '
            'for an explanation, or report this issue on '
            'https://github.com/google/deepvariant/issues.'.format(k))
      if kwargs[k] != v:
        print('\nWarning: --{} is previously set to {}, now to {}.'.format(
            k, kwargs[k], v))
    kwargs[k] = v
  return kwargs


</source>
</class>

<class classid="9" nclones="2" nlines="11" similarity="100">
<source file="systems/deepvariant-1.3.0/scripts/run_deepvariant.py" startline="336" endline="349" pcid="395">
def check_or_create_intermediate_results_dir(intermediate_results_dir):
  """Checks or creates the path to the directory for intermediate results."""
  if intermediate_results_dir is None:
    intermediate_results_dir = tempfile.mkdtemp()
  if not os.path.isdir(intermediate_results_dir):
    logging.info('Creating a directory for intermediate results in %s',
                 intermediate_results_dir)
    os.makedirs(intermediate_results_dir)
  else:
    logging.info('Re-using the directory for intermediate results in %s',
                 intermediate_results_dir)
  return intermediate_results_dir


</source>
<source file="systems/deepvariant-1.3.0/scripts/run_deeptrio.py" startline="435" endline="448" pcid="414">
def check_or_create_intermediate_results_dir(intermediate_results_dir):
  """Checks or creates the path to the directory for intermediate results."""
  if intermediate_results_dir is None:
    intermediate_results_dir = tempfile.mkdtemp()
  if not os.path.isdir(intermediate_results_dir):
    logging.info('Creating a directory for intermediate results in %s',
                 intermediate_results_dir)
    os.makedirs(intermediate_results_dir)
  else:
    logging.info('Re-using the directory for intermediate results in %s',
                 intermediate_results_dir)
  return intermediate_results_dir


</source>
</class>

<class classid="10" nclones="2" nlines="11" similarity="100">
<source file="systems/deepvariant-1.3.0/scripts/run_deepvariant.py" startline="350" endline="371" pcid="396">
def check_flags():
  """Additional logic to make sure flags are set appropriately."""
  if FLAGS.customized_model is not None:
    if (not tf.compat.v1.gfile.Exists(FLAGS.customized_model +
                                      '.data-00000-of-00001') or
        not tf.compat.v1.gfile.Exists(FLAGS.customized_model + '.index') or
        not tf.compat.v1.gfile.Exists(FLAGS.customized_model + '.meta')):
      raise RuntimeError('The model files {}* do not exist. Potentially '
                         'relevant issue: '
                         'https://github.com/google/deepvariant/blob/r1.3/docs/'
                         'FAQ.md#why-cant-it-find-one-of-the-input-files-eg-'
                         'could-not-open'.format(FLAGS.customized_model))
    logging.info(
        'You set --customized_model. Instead of using the default '
        'model for %s, `call_variants` step will load %s* '
        'instead.', FLAGS.model_type, FLAGS.customized_model)

  if FLAGS.use_hp_information and FLAGS.model_type != 'PACBIO':
    raise ValueError('--use_hp_information can only be used with '
                     '--model_type="PACBIO"')


</source>
<source file="systems/deepvariant-1.3.0/scripts/run_deeptrio.py" startline="449" endline="470" pcid="415">
def check_flags():
  """Additional logic to make sure flags are set appropriately."""
  if FLAGS.customized_model is not None:
    if (not tf.compat.v1.gfile.Exists(FLAGS.customized_model +
                                      '.data-00000-of-00001') or
        not tf.compat.v1.gfile.Exists(FLAGS.customized_model + '.index') or
        not tf.compat.v1.gfile.Exists(FLAGS.customized_model + '.meta')):
      raise RuntimeError('The model files {}* do not exist. Potentially '
                         'relevant issue: '
                         'https://github.com/google/deepvariant/blob/r1.3/docs/'
                         'FAQ.md#why-cant-it-find-one-of-the-input-files-eg-'
                         'could-not-open'.format(FLAGS.customized_model))
    logging.info(
        'You set --customized_model. Instead of using the default '
        'model for %s, `call_variants` step will load %s* '
        'instead.', FLAGS.model_type, FLAGS.customized_model)

  if FLAGS.use_hp_information and FLAGS.model_type != 'PACBIO':
    raise ValueError('--use_hp_information can only be used with '
                     '--model_type="PACBIO"')


</source>
</class>

</clones>
