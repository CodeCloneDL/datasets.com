<clones>
<systeminfo processor="nicad6" system="sentry-22.2.0" granularity="functions-blind" threshold="30%" minlines="10" maxlines="2500"/>
<cloneinfo npcs="12453" npairs="2181"/>
<runinfo ncompares="4857873" cputime="2114103"/>
<classinfo nclasses="535"/>

<class classid="1" nclones="2" nlines="26" similarity="77">
<source file="systems/sentry-22.2.0/src/sentry/discover/endpoints/discover_saved_queries.py" startline="105" endline="139" pcid="38">
    def post(self, request: Request, organization) -> Response:
        """
        Create a saved query
        """
        if not self.has_feature(organization, request):
            return self.respond(status=404)

        try:
            params = self.get_filter_params(
                request, organization, project_ids=request.data.get("projects")
            )
        except NoProjects:
            raise ParseError(detail="No Projects found, join a Team")

        serializer = DiscoverSavedQuerySerializer(
            data=request.data,
            context={"params": params},
        )

        if not serializer.is_valid():
            return Response(serializer.errors, status=400)

        data = serializer.validated_data

        model = DiscoverSavedQuery.objects.create(
            organization=organization,
            name=data["name"],
            query=data["query"],
            version=data["version"],
            created_by=request.user if request.user.is_authenticated else None,
        )

        model.set_projects(data["project_ids"])

        return Response(serialize(model), status=201)
</source>
<source file="systems/sentry-22.2.0/src/sentry/discover/endpoints/discover_saved_query_detail.py" startline="38" endline="75" pcid="41">
    def put(self, request: Request, organization, query_id) -> Response:
        """
        Modify a saved query
        """
        if not self.has_feature(organization, request):
            return self.respond(status=404)

        try:
            model = DiscoverSavedQuery.objects.get(id=query_id, organization=organization)
        except DiscoverSavedQuery.DoesNotExist:
            raise ResourceDoesNotExist

        try:
            params = self.get_filter_params(
                request, organization, project_ids=request.data.get("projects")
            )
        except NoProjects:
            raise ParseError(detail="No Projects found, join a Team")

        serializer = DiscoverSavedQuerySerializer(
            data=request.data,
            context={"params": params},
        )
        if not serializer.is_valid():
            return Response(serializer.errors, status=400)

        data = serializer.validated_data
        model.update(
            organization=organization,
            name=data["name"],
            query=data["query"],
            version=data["version"],
        )

        model.set_projects(data["project_ids"])

        return Response(serialize(model), status=200)

</source>
</class>

<class classid="2" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/auth/password_validation.py" startline="85" endline="96" pcid="182">
    def validate(self, password):
        if len(password) < self.min_length:
            raise ValidationError(
                ungettext(
                    "This password is too short. It must contain at least %(min_length)d character.",
                    "This password is too short. It must contain at least %(min_length)d characters.",
                    self.min_length,
                ),
                code="password_too_short",
                params={"min_length": self.min_length},
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/auth/password_validation.py" startline="116" endline="127" pcid="185">
    def validate(self, password):
        if len(password) > self.max_length:
            raise ValidationError(
                ungettext(
                    "This password is too long. It must contain no more than %(max_length)d character.",
                    "This password is too long. It must contain no more than %(max_length)d characters.",
                    self.max_length,
                ),
                code="password_too_long",
                params={"max_length": self.max_length},
            )

</source>
</class>

<class classid="3" nclones="2" nlines="28" similarity="73">
<source file="systems/sentry-22.2.0/src/sentry/mediators/external_requests/issue_link_requester.py" startline="59" endline="92" pcid="357">
    def _make_request(self):
        action_to_past_tense = {"create": "created", "link": "linked"}

        try:
            req = send_and_save_sentry_app_request(
                self._build_url(),
                self.sentry_app,
                self.install.organization_id,
                f"external_issue.{action_to_past_tense[self.action]}",
                headers=self._build_headers(),
                method="POST",
                data=self.body,
            )
            body = safe_urlread(req)
            response = json.loads(body)
        except Exception as e:
            logger.info(
                "issue-link-requester.error",
                extra={
                    "sentry_app": self.sentry_app.slug,
                    "install": self.install.uuid,
                    "project": self.group.project.slug,
                    "group": self.group.id,
                    "uri": self.uri,
                    "error_message": str(e),
                },
            )
            response = {}

        if not self._validate_response(response):
            raise APIError()

        return response

</source>
<source file="systems/sentry-22.2.0/src/sentry/mediators/external_requests/select_requester.py" startline="52" endline="82" pcid="372">
    def _make_request(self):
        try:
            body = safe_urlread(
                send_and_save_sentry_app_request(
                    self._build_url(),
                    self.sentry_app,
                    self.install.organization_id,
                    "select_options.requested",
                    headers=self._build_headers(),
                )
            )

            response = json.loads(body)
        except Exception as e:
            logger.info(
                "select-requester.error",
                extra={
                    "sentry_app_slug": self.sentry_app.slug,
                    "install_uuid": self.install.uuid,
                    "project_slug": self.project and self.project.slug,
                    "uri": self.uri,
                    "error_message": str(e),
                },
            )
            response = {}

        if not self._validate_response(response):
            raise APIError()

        return self._format_response(response)

</source>
</class>

<class classid="4" nclones="2" nlines="35" similarity="70">
<source file="systems/sentry-22.2.0/src/sentry/mediators/external_requests/util.py" startline="47" endline="89" pcid="369">
def send_and_save_sentry_app_request(url, sentry_app, org_id, event, **kwargs):
    """
    Send a webhook request, and save the request into the Redis buffer for the app dashboard request log
    Returns the response of the request

    kwargs ends up being the arguments passed into safe_urlopen
    """

    buffer = SentryAppWebhookRequestsBuffer(sentry_app)

    slug = sentry_app.slug_for_metrics

    try:
        resp = safe_urlopen(url=url, **kwargs)

    except (Timeout, ConnectionError) as e:
        error_type = e.__class__.__name__.lower()
        logger.info(
            "send_and_save_sentry_app_request.timeout",
            extra={
                "error_type": error_type,
                "organization_id": org_id,
                "integration_slug": sentry_app.slug,
            },
        )
        track_response_code(error_type, slug, event)
        # Response code of 0 represents timeout
        buffer.add_request(response_code=0, org_id=org_id, event=event, url=url)
        # Re-raise the exception because some of these tasks might retry on the exception
        raise

    else:
        track_response_code(resp.status_code, slug, event)
        buffer.add_request(
            response_code=resp.status_code,
            org_id=org_id,
            event=event,
            url=url,
            error_id=resp.headers.get("Sentry-Hook-Error"),
            project_id=resp.headers.get("Sentry-Hook-Project"),
        )
        resp.raise_for_status()
        return resp
</source>
<source file="systems/sentry-22.2.0/src/sentry/tasks/sentry_apps.py" startline="379" endline="435" pcid="1240">
def send_and_save_webhook_request(sentry_app, app_platform_event, url=None):
    """
    Notify a SentryApp's webhook about an incident and log response on redis.

    :param sentry_app: The SentryApp to notify via a webhook.
    :param app_platform_event: Incident data. See AppPlatformEvent.
    :param url: The URL to hit for this webhook if it is different from `sentry_app.webhook_url`.
    :return: Webhook response
    """
    buffer = SentryAppWebhookRequestsBuffer(sentry_app)

    org_id = app_platform_event.install.organization_id
    event = f"{app_platform_event.resource}.{app_platform_event.action}"
    slug = sentry_app.slug_for_metrics
    url = url or sentry_app.webhook_url
    try:
        resp = safe_urlopen(
            url=url, data=app_platform_event.body, headers=app_platform_event.headers, timeout=5
        )
    except (Timeout, ConnectionError) as e:
        error_type = e.__class__.__name__.lower()
        logger.info(
            "send_and_save_webhook_request.timeout",
            extra={
                "error_type": error_type,
                "organization_id": org_id,
                "integration_slug": sentry_app.slug,
            },
        )
        track_response_code(error_type, slug, event)
        # Response code of 0 represents timeout
        buffer.add_request(response_code=0, org_id=org_id, event=event, url=url)
        # Re-raise the exception because some of these tasks might retry on the exception
        raise

    else:
        track_response_code(resp.status_code, slug, event)
        buffer.add_request(
            response_code=resp.status_code,
            org_id=org_id,
            event=event,
            url=url,
            error_id=resp.headers.get("Sentry-Hook-Error"),
            project_id=resp.headers.get("Sentry-Hook-Project"),
        )

        if resp.status_code == 503:
            raise ApiHostError.from_request(resp.request)

        elif resp.status_code == 504:
            raise ApiTimeoutError.from_request(resp.request)

        if 400 <= resp.status_code < 500:
            raise ClientError(resp.status_code, url, response=resp)

        resp.raise_for_status()
        return resp
</source>
</class>

<class classid="5" nclones="5" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/src/sentry/mediators/sentry_app_installations/creator.py" startline="56" endline="67" pcid="398">
    def audit(self):
        from sentry.utils.audit import create_audit_entry

        if self.request:
            create_audit_entry(
                request=self.request,
                organization=self.install.organization,
                target_object=self.install.organization.id,
                event=AuditLogEntryEvent.SENTRY_APP_INSTALL,
                data={"sentry_app": self.sentry_app.name},
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/mediators/sentry_apps/creator.py" startline="123" endline="134" pcid="513">
    def audit(self):
        from sentry.utils.audit import create_audit_entry

        if self.request:
            create_audit_entry(
                request=self.request,
                organization=self.organization,
                target_object=self.organization.id,
                event=AuditLogEntryEvent.SENTRY_APP_ADD,
                data={"sentry_app": self.sentry_app.name},
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/mediators/sentry_apps/internal_creator.py" startline="55" endline="66" pcid="477">
    def audit(self):
        from sentry.utils.audit import create_audit_entry

        if self.request:
            create_audit_entry(
                request=self.request,
                organization=self.organization,
                target_object=self.organization.id,
                event=AuditLogEntryEvent.INTERNAL_INTEGRATION_ADD,
                data={"name": self.sentry_app.name},
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/mediators/sentry_app_installation_tokens/creator.py" startline="47" endline="58" pcid="429">
    def audit(self):
        from sentry.utils.audit import create_audit_entry

        if self.request and self.generate_audit:
            create_audit_entry(
                request=self.request,
                organization=self.organization,
                target_object=self.api_token.id,
                event=AuditLogEntryEvent.INTERNAL_INTEGRATION_ADD_TOKEN,
                data={"sentry_app": self.sentry_app.name},
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/mediators/sentry_app_installation_tokens/destroyer.py" startline="25" endline="36" pcid="421">
    def audit(self):
        from sentry.utils.audit import create_audit_entry

        if self.request and self.generate_audit:
            create_audit_entry(
                request=self.request,
                organization=self.organization,
                target_object=self.api_token.id,
                event=AuditLogEntryEvent.INTERNAL_INTEGRATION_REMOVE_TOKEN,
                data={"sentry_app": self.sentry_app.name},
            )

</source>
</class>

<class classid="6" nclones="2" nlines="31" similarity="74">
<source file="systems/sentry-22.2.0/src/sentry/eventstream/kafka/state.py" startline="92" endline="136" pcid="565">
    def set_local_offset(self, topic, partition, local_offset):
        """
        Update the local offset for a topic and partition.

        If this update operation results in a state change, the callback
        function will be invoked.
        """
        with self.__lock:
            previous_state, previous_offsets = self.partitions[(topic, partition)]
            if previous_offsets.local is not None and (
                local_offset is None or local_offset < previous_offsets.local
            ):
                logger.info(
                    "Local offset for %s/%s has moved backwards (current: %s, previous: %s)",
                    topic,
                    partition,
                    local_offset,
                    previous_offsets.local,
                )
            updated_offsets = Offsets(local_offset, previous_offsets.remote)
            updated_state = self.get_state_from_offsets(updated_offsets)
            if (
                previous_state is not updated_state
                and updated_state not in self.transitions[previous_state]
            ):
                raise InvalidStateTransition(
                    f"Unexpected state transition for {topic}/{partition} from {previous_state} to {updated_state}"
                )
            self.partitions[(topic, partition)] = (updated_state, updated_offsets)
            if previous_state is not updated_state:
                if updated_state == SynchronizedPartitionState.REMOTE_BEHIND:
                    logger.warning(
                        "Current local offset for %s/%s (%s) exceeds remote offset (%s)!",
                        topic,
                        partition,
                        updated_offsets.local,
                        updated_offsets.remote,
                    )
                self.callback(
                    topic,
                    partition,
                    (previous_state, previous_offsets),
                    (updated_state, updated_offsets),
                )

</source>
<source file="systems/sentry-22.2.0/src/sentry/eventstream/kafka/state.py" startline="137" endline="173" pcid="566">
    def set_remote_offset(self, topic, partition, remote_offset):
        """
        Update the remote offset for a topic and partition.

        If this update operation results in a state change, the callback
        function will be invoked.
        """
        with self.__lock:
            previous_state, previous_offsets = self.partitions[(topic, partition)]
            if previous_offsets.remote is not None and (
                remote_offset is None or remote_offset < previous_offsets.remote
            ):
                logger.info(
                    "Remote offset for %s/%s has moved backwards (current: %s, previous: %s)",
                    topic,
                    partition,
                    remote_offset,
                    previous_offsets.remote,
                )
            updated_offsets = Offsets(previous_offsets.local, remote_offset)
            updated_state = self.get_state_from_offsets(updated_offsets)
            if (
                previous_state is not updated_state
                and updated_state not in self.transitions[previous_state]
            ):
                raise InvalidStateTransition(
                    f"Unexpected state transition for {topic}/{partition} from {previous_state} to {updated_state}"
                )
            self.partitions[(topic, partition)] = (updated_state, updated_offsets)
            if previous_state is not updated_state:
                self.callback(
                    topic,
                    partition,
                    (previous_state, previous_offsets),
                    (updated_state, updated_offsets),
                )

</source>
</class>

<class classid="7" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/src/sentry/models/groupsnooze.py" startline="85" endline="100" pcid="657">
    def test_frequency_rates(self):
        from sentry import tsdb

        metrics.incr("groupsnooze.test_frequency_rates")

        end = timezone.now()
        start = end - timedelta(minutes=self.window)

        rate = tsdb.get_sums(model=tsdb.models.group, keys=[self.group_id], start=start, end=end)[
            self.group_id
        ]
        if rate >= self.count:
            return False

        return True

</source>
<source file="systems/sentry-22.2.0/src/sentry/models/groupsnooze.py" startline="101" endline="118" pcid="658">
    def test_user_rates(self):
        from sentry import tsdb

        metrics.incr("groupsnooze.test_user_rates")

        end = timezone.now()
        start = end - timedelta(minutes=self.user_window)

        rate = tsdb.get_distinct_counts_totals(
            model=tsdb.models.users_affected_by_group, keys=[self.group_id], start=start, end=end
        )[self.group_id]

        if rate >= self.user_count:
            return False

        return True


</source>
</class>

<class classid="8" nclones="2" nlines="25" similarity="76">
<source file="systems/sentry-22.2.0/src/sentry/models/releaseprojectenvironment.py" startline="55" endline="86" pcid="781">
    def _get_or_create_impl(cls, release, project, environment, datetime, metrics_tags, **kwargs):
        cache_key = cls.get_cache_key(project.id, release.id, environment.id)

        instance = cache.get(cache_key)
        if instance is None:
            metrics_tags["cache_hit"] = "false"
            instance, created = cls.objects.get_or_create(
                release=release,
                project=project,
                environment=environment,
                defaults={"first_seen": datetime, "last_seen": datetime},
            )
            cache.set(cache_key, instance, 3600)
            metrics_tags["cache_hit"] = "true"
        else:
            created = False

        metrics_tags["created"] = "true" if created else "false"

        # Same as releaseenvironment model. Minimizes last_seen updates to once a minute
        if not created and instance.last_seen < datetime - timedelta(seconds=60):
            cls.objects.filter(
                id=instance.id, last_seen__lt=datetime - timedelta(seconds=60)
            ).update(last_seen=datetime)
            instance.last_seen = datetime
            cache.set(cache_key, instance, 3600)
            metrics_tags["bumped"] = "true"
        else:
            metrics_tags["bumped"] = "false"

        return instance

</source>
<source file="systems/sentry-22.2.0/src/sentry/models/releaseenvironment.py" startline="39" endline="71" pcid="815">
    def _get_or_create_impl(cls, project, release, environment, datetime, metric_tags):
        cache_key = cls.get_cache_key(project.id, release.id, environment.id)

        instance = cache.get(cache_key)
        if instance is None:
            metric_tags["cache_hit"] = "false"
            instance, created = cls.objects.get_or_create(
                release_id=release.id,
                organization_id=project.organization_id,
                environment_id=environment.id,
                defaults={"first_seen": datetime, "last_seen": datetime},
            )
            cache.set(cache_key, instance, 3600)
        else:
            metric_tags["cache_hit"] = "true"
            created = False

        metric_tags["created"] = "true" if created else "false"

        # TODO(dcramer): this would be good to buffer, but until then we minimize
        # updates to once a minute, and allow Postgres to optimistically skip
        # it even if we can't
        if not created and instance.last_seen < datetime - timedelta(seconds=60):
            metric_tags["bumped"] = "true"
            cls.objects.filter(
                id=instance.id, last_seen__lt=datetime - timedelta(seconds=60)
            ).update(last_seen=datetime)
            instance.last_seen = datetime
            cache.set(cache_key, instance, 3600)
        else:
            metric_tags["bumped"] = "false"

        return instance
</source>
</class>

<class classid="9" nclones="2" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/src/sentry/receivers/onboarding.py" startline="227" endline="241" pcid="919">
def record_member_joined(member, organization, **kwargs):
    rows_affected, created = OrganizationOnboardingTask.objects.create_or_update(
        organization_id=member.organization_id,
        task=OnboardingTask.INVITE_MEMBER,
        status=OnboardingTaskStatus.PENDING,
        values={
            "status": OnboardingTaskStatus.COMPLETE,
            "date_completed": timezone.now(),
            "data": {"invited_member_id": member.id},
        },
    )
    if created or rows_affected:
        try_mark_onboarding_complete(member.organization_id)


</source>
<source file="systems/sentry-22.2.0/src/sentry/receivers/onboarding.py" startline="373" endline="388" pcid="924">
def record_alert_rule_created(user, project, rule, **kwargs):
    rows_affected, created = OrganizationOnboardingTask.objects.create_or_update(
        organization_id=project.organization_id,
        task=OnboardingTask.ALERT_RULE,
        values={
            "status": OnboardingTaskStatus.COMPLETE,
            "user": user,
            "project_id": project.id,
            "date_completed": timezone.now(),
        },
    )

    if rows_affected or created:
        try_mark_onboarding_complete(project.organization_id)


</source>
</class>

<class classid="10" nclones="3" nlines="25" similarity="88">
<source file="systems/sentry-22.2.0/src/sentry/receivers/onboarding.py" startline="242" endline="270" pcid="920">
def record_release_received(project, event, **kwargs):
    if not event.get_tag("sentry:release"):
        return

    success = OrganizationOnboardingTask.objects.record(
        organization_id=project.organization_id,
        task=OnboardingTask.RELEASE_TRACKING,
        status=OnboardingTaskStatus.COMPLETE,
        project_id=project.id,
    )
    if success:
        try:
            user = Organization.objects.get(id=project.organization_id).get_default_owner()
        except IndexError:
            logging.getLogger("sentry").warning(
                "Cannot record release received for organization (%s) due to missing owners",
                project.organization_id,
            )
            return

        analytics.record(
            "first_release_tag.sent",
            user_id=user.id,
            project_id=project.id,
            organization_id=project.organization_id,
        )
        try_mark_onboarding_complete(project.organization_id)


</source>
<source file="systems/sentry-22.2.0/src/sentry/receivers/onboarding.py" startline="313" endline="340" pcid="922">
def record_sourcemaps_received(project, event, **kwargs):
    if not has_sourcemap(event):
        return

    success = OrganizationOnboardingTask.objects.record(
        organization_id=project.organization_id,
        task=OnboardingTask.SOURCEMAPS,
        status=OnboardingTaskStatus.COMPLETE,
        project_id=project.id,
    )
    if success:
        try:
            user = Organization.objects.get(id=project.organization_id).get_default_owner()
        except IndexError:
            logging.getLogger("sentry").warning(
                "Cannot record sourcemaps received for organization (%s) due to missing owners",
                project.organization_id,
            )
            return
        analytics.record(
            "first_sourcemaps.sent",
            user_id=user.id,
            organization_id=project.organization_id,
            project_id=project.id,
        )
        try_mark_onboarding_complete(project.organization_id)


</source>
<source file="systems/sentry-22.2.0/src/sentry/receivers/onboarding.py" startline="275" endline="307" pcid="921">
def record_user_context_received(project, event, **kwargs):
    user_context = event.data.get("user")
    if not user_context:
        return
    # checking to see if only ip address is being sent (our js library does this automatically)
    # testing for this in test_no_user_tracking_for_ip_address_only
    # list(d.keys()) pattern is to make this python3 safe
    elif list(user_context.keys()) != ["ip_address"]:
        success = OrganizationOnboardingTask.objects.record(
            organization_id=project.organization_id,
            task=OnboardingTask.USER_CONTEXT,
            status=OnboardingTaskStatus.COMPLETE,
            project_id=project.id,
        )
        if success:
            try:
                user = Organization.objects.get(id=project.organization_id).get_default_owner()
            except IndexError:
                logging.getLogger("sentry").warning(
                    "Cannot record user context received for organization (%s) due to missing owners",
                    project.organization_id,
                )
                return

            analytics.record(
                "first_user_context.sent",
                user_id=user.id,
                organization_id=project.organization_id,
                project_id=project.id,
            )
            try_mark_onboarding_complete(project.organization_id)


</source>
</class>

<class classid="11" nclones="3" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/src/sentry/identity/oauth2.py" startline="90" endline="103" pcid="979">
    def get_pipeline_views(self):
        return [
            OAuth2LoginView(
                authorize_url=self.get_oauth_authorize_url(),
                client_id=self.get_oauth_client_id(),
                scope=" ".join(self.get_oauth_scopes()),
            ),
            OAuth2CallbackView(
                access_token_url=self.get_oauth_access_token_url(),
                client_id=self.get_oauth_client_id(),
                client_secret=self.get_oauth_client_secret(),
            ),
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry/identity/slack/provider.py" startline="37" endline="51" pcid="1030">
    def get_pipeline_views(self):
        return [
            SlackOAuth2LoginView(
                authorize_url=self.get_oauth_authorize_url(),
                client_id=self.get_oauth_client_id(),
                scope=" ".join(self.get_oauth_scopes()),
                user_scope=" ".join(self.get_user_scopes()),
            ),
            OAuth2CallbackView(
                access_token_url=self.get_oauth_access_token_url(),
                client_id=self.get_oauth_client_id(),
                client_secret=self.get_oauth_client_secret(),
            ),
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry/identity/vsts/provider.py" startline="54" endline="67" pcid="997">
    def get_pipeline_views(self):
        return [
            OAuth2LoginView(
                authorize_url=self.oauth_authorize_url,
                client_id=self.get_oauth_client_id(),
                scope=" ".join(self.get_oauth_scopes()),
            ),
            VSTSOAuth2CallbackView(
                access_token_url=self.oauth_access_token_url,
                client_id=self.get_oauth_client_id(),
                client_secret=self.get_oauth_client_secret(),
            ),
        ]

</source>
</class>

<class classid="12" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/src/sentry/identity/vsts/provider.py" startline="96" endline="110" pcid="1000">
    def build_identity(self, data):
        data = data["data"]
        user = get_user_info(data["access_token"])

        return {
            "type": "vsts",
            "id": user["id"],
            "email": user["emailAddress"],
            "email_verified": True,
            "name": user["displayName"],
            "scopes": sorted(self.oauth_scopes),
            "data": self.get_oauth_data(data),
        }


</source>
<source file="systems/sentry-22.2.0/src/sentry/identity/github_enterprise/provider.py" startline="25" endline="36" pcid="1016">
    def build_identity(self, data):
        data = data["data"]
        # todo(meredith): this doesn't work yet, need to pass in the base url
        user = get_user_info(data["access_token"])

        return {
            "type": "github_enterprise",
            "id": user["id"],
            "email": user["email"],
            "scopes": [],  # GitHub apps do not have user scopes
            "data": self.get_oauth_data(data),
        }
</source>
</class>

<class classid="13" nclones="2" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/src/sentry/identity/github/provider.py" startline="7" endline="25" pcid="1007">
def get_user_info(access_token):
    with http.build_session() as session:
        resp = session.get(
            "https://api.github.com/user",
            headers={
                "Accept": "application/vnd.github.machine-man-preview+json",
                "Authorization": f"token {access_token}",
            },
        )
        resp.raise_for_status()
    return resp.json()


# GitHub has 2 types of apps -- GitHub apps and OAuth apps. SSO is implemented
# using OAuth App, but signup and integrations use the github app. When github
# apps have API parity with OAuth apps, we should move SSO to it as well.
# https://developer.github.com/apps/differences-between-apps/


</source>
<source file="systems/sentry-22.2.0/src/sentry/identity/github_enterprise/provider.py" startline="5" endline="18" pcid="1015">
def get_user_info(url, access_token):
    with http.build_session() as session:
        resp = session.get(
            f"https://{url}/api/v3/user",
            headers={
                "Accept": "application/vnd.github.machine-man-preview+json",
                "Authorization": f"token {access_token}",
            },
            verify=False,
        )
        resp.raise_for_status()
    return resp.json()


</source>
</class>

<class classid="14" nclones="2" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/src/sentry/tasks/auth.py" startline="29" endline="44" pcid="1182">
def email_missing_links(org_id, actor_id, provider_key, **kwargs):
    try:
        org = Organization.objects.get(id=org_id)
        actor = User.objects.get(id=actor_id)
        provider = manager.get(provider_key)
    except (Organization.DoesNotExist, User.DoesNotExist, ProviderNotRegistered) as e:
        logger.warning("Could not send SSO link emails: %s", e)
        return

    member_list = OrganizationMember.objects.filter(
        organization=org, flags=F("flags").bitand(~OrganizationMember.flags["sso:linked"])
    )
    for member in member_list:
        member.send_sso_link_email(actor, provider)


</source>
<source file="systems/sentry-22.2.0/src/sentry/tasks/auth.py" startline="46" endline="63" pcid="1183">
def email_unlink_notifications(org_id, actor_id, provider_key):
    try:
        org = Organization.objects.get(id=org_id)
        actor = User.objects.get(id=actor_id)
        provider = manager.get(provider_key)
    except (Organization.DoesNotExist, User.DoesNotExist, ProviderNotRegistered) as e:
        logger.warning("Could not send SSO unlink emails: %s", e)
        return

    # Email all organization users, even if they never linked their accounts.
    # This provides a better experience in the case where SSO is enabled and
    # disabled in the timespan of users checking their email.
    member_list = OrganizationMember.objects.filter(organization=org).select_related("user")

    for member in member_list:
        member.send_sso_unlink_email(actor, provider)


</source>
</class>

<class classid="15" nclones="2" nlines="20" similarity="72">
<source file="systems/sentry-22.2.0/src/sentry/tasks/integrations/update_comment.py" startline="16" endline="36" pcid="1249">
def update_comment(external_issue_id: int, user_id: int, group_note_id: int) -> None:
    external_issue = ExternalIssue.objects.get(id=external_issue_id)
    installation = external_issue.get_installation()

    if not should_comment_sync(installation, external_issue):
        return

    try:
        note = Activity.objects.get(type=ActivityType.NOTE.value, id=group_note_id)
    except Activity.DoesNotExist:
        return

    installation.update_comment(external_issue.key, user_id, note)
    analytics.record(
        # TODO(lb): this should be changed and/or specified?
        "integration.issue.comments.synced",
        provider=installation.model.provider,
        id=installation.model.id,
        organization_id=external_issue.organization_id,
        user_id=user_id,
    )
</source>
<source file="systems/sentry-22.2.0/src/sentry/tasks/integrations/create_comment.py" startline="16" endline="42" pcid="1254">
def create_comment(external_issue_id: int, user_id: int, group_note_id: int) -> None:
    try:
        external_issue = ExternalIssue.objects.get(id=external_issue_id)
    except ExternalIssue.DoesNotExist:
        return

    installation = external_issue.get_installation()

    if not should_comment_sync(installation, external_issue):
        return

    try:
        note = Activity.objects.get(type=ActivityType.NOTE.value, id=group_note_id)
    except Activity.DoesNotExist:
        return

    comment = installation.create_comment(external_issue.key, user_id, note)
    note.data["external_id"] = installation.get_comment_id(comment)
    note.save()
    analytics.record(
        # TODO(lb): this should be changed and/or specified?
        "integration.issue.comments.synced",
        provider=installation.model.provider,
        id=installation.model.id,
        organization_id=external_issue.organization_id,
        user_id=user_id,
    )
</source>
</class>

<class classid="16" nclones="2" nlines="11" similarity="81">
<source file="systems/sentry-22.2.0/src/sentry/testutils/skips.py" startline="11" endline="23" pcid="1348">
def snuba_is_available():
    if "snuba" in _service_status:
        return _service_status["snuba"]
    try:
        parsed = urlparse(settings.SENTRY_SNUBA)
        socket.create_connection((parsed.hostname, parsed.port), 1.0)
    except OSError:
        _service_status["snuba"] = False
    else:
        _service_status["snuba"] = True
    return _service_status["snuba"]


</source>
<source file="systems/sentry-22.2.0/src/sentry/testutils/skips.py" startline="63" endline="74" pcid="1354">
def relay_is_available():
    if "relay" in _service_status:
        return _service_status["relay"]
    try:
        socket.create_connection(("127.0.0.1", settings.SENTRY_RELAY_PORT), 1.0)
    except OSError:
        _service_status["relay"] = False
    else:
        _service_status["relay"] = True
    return _service_status["relay"]


</source>
</class>

<class classid="17" nclones="2" nlines="33" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/migrations/0237_recreate_subscriptions_in_snuba.py" startline="12" endline="56" pcid="1371">
def migrate_subscriptions(apps, schema_editor):
    QuerySubscription = apps.get_model("sentry", "QuerySubscription")
    AppSnubaQueryEventType = apps.get_model("sentry", "SnubaQueryEventType")

    for subscription in RangeQuerySetWrapperWithProgressBar(
        QuerySubscription.objects.select_related("snuba_query").all()
    ):
        if subscription.subscription_id is not None:
            # The migration apps don't build this property, so manually set it.
            raw_event_types = AppSnubaQueryEventType.objects.filter(
                snuba_query=subscription.snuba_query
            ).all()
            event_types = [SnubaQueryEventType.EventType(ev.type) for ev in raw_event_types]
            setattr(subscription.snuba_query, "event_types", event_types)

            subscription_id = None
            try:
                subscription_id = _create_in_snuba(subscription)
            except Exception as e:
                logging.exception(f"failed to recreate {subscription.subscription_id}: {e}")
                continue

            try:
                _delete_from_snuba(
                    QueryDatasets(subscription.snuba_query.dataset),
                    subscription.subscription_id,
                )
            except Exception as e:
                try:
                    # Delete the subscription we just created to avoid orphans
                    _delete_from_snuba(
                        QueryDatasets(subscription.snuba_query.dataset),
                        subscription_id,
                    )
                except Exception as oe:
                    logging.exception(f"failed to delete orphan {subscription_id}: {oe}")

                logging.exception(f"failed to delete {subscription.subscription_id}: {e}")
                continue

            QuerySubscription.objects.filter(id=subscription.id).update(
                subscription_id=subscription_id
            )


</source>
<source file="systems/sentry-22.2.0/src/sentry/migrations/0233_recreate_subscriptions_in_snuba.py" startline="12" endline="56" pcid="1374">
def migrate_subscriptions(apps, schema_editor):
    QuerySubscription = apps.get_model("sentry", "QuerySubscription")
    AppSnubaQueryEventType = apps.get_model("sentry", "SnubaQueryEventType")

    for subscription in RangeQuerySetWrapperWithProgressBar(
        QuerySubscription.objects.select_related("snuba_query").all()
    ):
        if subscription.subscription_id is not None:
            # The migration apps don't build this property, so manually set it.
            raw_event_types = AppSnubaQueryEventType.objects.filter(
                snuba_query=subscription.snuba_query
            ).all()
            event_types = [SnubaQueryEventType.EventType(ev.type) for ev in raw_event_types]
            setattr(subscription.snuba_query, "event_types", event_types)

            subscription_id = None
            try:
                subscription_id = _create_in_snuba(subscription)
            except Exception as e:
                logging.exception(f"failed to recreate {subscription.subscription_id}: {e}")
                continue

            try:
                _delete_from_snuba(
                    QueryDatasets(subscription.snuba_query.dataset),
                    subscription.subscription_id,
                )
            except Exception as e:
                try:
                    # Delete the subscription we just created to avoid orphans
                    _delete_from_snuba(
                        QueryDatasets(subscription.snuba_query.dataset),
                        subscription_id,
                    )
                except Exception as oe:
                    logging.exception(f"failed to delete orphan {subscription_id}: {oe}")

                logging.exception(f"failed to delete {subscription.subscription_id}: {e}")
                continue

            QuerySubscription.objects.filter(id=subscription.id).update(
                subscription_id=subscription_id
            )


</source>
</class>

<class classid="18" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/utils/distutils/commands/build_js_sdk_registry.py" startline="21" endline="32" pcid="1629">
def dump_registry(path, data):
    fn = os.path.join(LOADER_FOLDER, path + ".json")
    directory = os.path.dirname(fn)
    try:
        os.makedirs(directory)
    except OSError:
        pass
    with open(fn, "wt", encoding="utf-8") as f:
        f.write(json.dumps(data, indent=2))
        f.write("\n")


</source>
<source file="systems/sentry-22.2.0/src/sentry/utils/integrationdocs.py" startline="48" endline="59" pcid="1840">
def dump_doc(path, data):
    fn = os.path.join(DOC_FOLDER, path + ".json")
    directory = os.path.dirname(fn)
    try:
        os.makedirs(directory)
    except OSError:
        pass
    with open(fn, "wt", encoding="utf-8") as f:
        f.write(json.dumps(data, indent=2))
        f.write("\n")


</source>
</class>

<class classid="19" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/src/sentry/utils/cursors.py" startline="35" endline="46" pcid="1673">
    def from_string(cls, value):
        bits = value.split(":")
        if len(bits) != 3:
            raise ValueError
        try:
            value = float(bits[0]) if "." in bits[0] else int(bits[0])
            bits = value, int(bits[1]), int(bits[2])
        except (TypeError, ValueError):
            raise ValueError
        return cls(*bits)


</source>
<source file="systems/sentry-22.2.0/src/sentry/utils/cursors.py" startline="56" endline="67" pcid="1675">
    def from_string(cls, value):
        bits = value.rsplit(":", 2)
        if len(bits) != 3:
            raise ValueError
        try:
            value = bits[0]
            bits = value, int(bits[1]), int(bits[2])
        except (TypeError, ValueError):
            raise ValueError
        return cls(*bits)


</source>
</class>

<class classid="20" nclones="2" nlines="30" similarity="70">
<source file="systems/sentry-22.2.0/src/sentry/utils/cursors.py" startline="89" endline="147" pcid="1681">
def _build_next_values(cursor, results, key, limit, is_desc):
    value = cursor.value
    offset = cursor.offset
    is_prev = cursor.is_prev

    num_results = len(results)

    if not value and num_results:
        value = key(results[0])

    # Next cursor for a prev-cursor simply starts from that prev cursors value
    # without an offset.
    if is_prev:
        return (value, 0, True)

    # No results means no more next
    if not num_results:
        return (value, offset, False)

    # Are there more results than whats on the current page?
    has_next = num_results > limit

    # Determine what our next cursor is by ensuring we have a unique offset
    next_value = key(results[-1])

    # value has not changed, page forward by adjusting the offset
    if next_value == value:
        next_offset = offset + limit
        return (next_value, next_offset, has_next)

    # We have an absolute value to page from. If any of the items in
    # the current result set come *after* or *before* (depending on the
    # is_desc flag) we will want to increment the offset to account for
    # moving past them.
    #
    # This is required to account for loss of precision in the key value.
    next_offset = 0
    result_iter = reversed(results)

    # If we have more results the last item in the results should be
    # skipped, as we know we want to start from that item and do not
    # need to offset from it.
    if has_next:
        next(result_iter)

    for result in result_iter:
        result_value = key(result)

        is_larger = result_value >= next_value
        is_smaller = result_value <= next_value

        if (is_desc and is_smaller) or (not is_desc and is_larger):
            next_offset += 1
        else:
            break

    return (next_value, next_offset, has_next)


</source>
<source file="systems/sentry-22.2.0/src/sentry/utils/cursors.py" startline="148" endline="216" pcid="1682">
def _build_prev_values(cursor, results, key, limit, is_desc):
    value = cursor.value
    offset = cursor.offset
    is_prev = cursor.is_prev

    num_results = len(results)

    if is_prev:
        has_prev = num_results > limit
    else:
        # It's likely that there's a previous page if they passed us either
        # offset values
        has_prev = value or offset

    # If the cursor contains previous results, the first item is the item that
    # indicates if we have more items later, and is *not* the first item in the
    # list, that should be used for the value.
    first_prev_index = 1 if is_prev and has_prev else 0

    # If we're paging back we need to calculate the key from the first result
    # with for_prev=True to ensure rounding of the key is correct.See
    # sentry.api.paginator.BasePaginator.get_item_key
    prev_value = key(results[first_prev_index], for_prev=True) if results else 0

    # Prev only has an offset if the cursor we were dealing with was a
    # previous cursor. Otherwise we'd be taking the offset while moving forward.
    prev_offset = offset if is_prev else 0

    if not (is_prev and num_results):
        return (prev_value, prev_offset, has_prev)

    # Value has not changed, page back by adjusting the offset
    if prev_value == value:
        prev_offset = offset + limit
        return (prev_value, prev_offset, has_prev)

    # Just as in the next cursor builder, we may need to add an offset
    # if any of the results at the beginning are *before* or *after*
    # (depending on the is_desc flag).
    #
    # This is required to account for loss of precision in the key value.
    prev_offset = 0
    result_iter = iter(results)

    # If we know there are more previous results, we need to move past
    # the item indicating that more items exist.
    if has_prev:
        next(result_iter)

    # Always move past the first item, this is the prev_value item and will
    # already be offset in the next query.
    next(result_iter)

    for result in result_iter:
        result_value = key(result, for_prev=True)

        is_larger = result_value >= prev_value
        is_smaller = result_value <= prev_value

        # Note that the checks are reversed here as a prev query has
        # it's ordering reversed.
        if (is_desc and is_larger) or (not is_desc and is_smaller):
            prev_offset += 1
        else:
            break

    return (prev_value, prev_offset, has_prev)


</source>
</class>

<class classid="21" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/utils/audit.py" startline="77" endline="92" pcid="1901">
def create_project_delete_log(entry):
    delete_log = DeletedProject()

    project = Project.objects.get(id=entry.target_object)
    delete_log.name = project.name
    delete_log.slug = project.slug
    delete_log.date_created = project.date_added
    delete_log.platform = project.platform

    delete_log.organization_id = entry.organization.id
    delete_log.organization_name = entry.organization.name
    delete_log.organization_slug = entry.organization.slug

    complete_delete_log(delete_log, entry)


</source>
<source file="systems/sentry-22.2.0/src/sentry/utils/audit.py" startline="93" endline="107" pcid="1902">
def create_team_delete_log(entry):
    delete_log = DeletedTeam()

    team = Team.objects.get(id=entry.target_object)
    delete_log.name = team.name
    delete_log.slug = team.slug
    delete_log.date_created = team.date_added

    delete_log.organization_id = entry.organization.id
    delete_log.organization_name = entry.organization.name
    delete_log.organization_slug = entry.organization.slug

    complete_delete_log(delete_log, entry)


</source>
</class>

<class classid="22" nclones="2" nlines="19" similarity="80">
<source file="systems/sentry-22.2.0/src/sentry/incidents/endpoints/project_alert_rule_task_details.py" startline="14" endline="42" pcid="1969">
    def get(self, request: Request, project, task_uuid) -> Response:
        """
        Retrieve the status of the async task

        Return details of the alert rule if the task is successful

        """
        client = tasks.RedisRuleStatus(task_uuid)
        result = client.get_value()

        status = result["status"]
        rule_id = result.get("rule_id")
        error = result.get("error")

        # if the status is "pending" we don't have a rule yet or error
        context = {"status": status, "alertRule": None, "error": None}

        if rule_id and status == "success":
            try:
                alert_rule = AlertRule.objects.get(
                    snuba_query__subscriptions__project=project, id=rule_id
                )
                context["alertRule"] = serialize(alert_rule, request.user)
            except AlertRule.DoesNotExist:
                raise Http404
        if status == "failed":
            context["error"] = error

        return Response(context, status=200)
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/project_rule_task_details.py" startline="14" endline="45" pcid="2719">
    def get(self, request: Request, project, task_uuid) -> Response:
        """
        Retrieve the status of the async task

        Return details of the rule if the task is successful

        """
        client = tasks.RedisRuleStatus(task_uuid)
        result = client.get_value()

        status = result["status"]
        rule_id = result.get("rule_id")
        error = result.get("error")

        # if the status is "pending" we don't have a rule yet or error
        context = {"status": status, "rule": None, "error": None}

        if rule_id and status == "success":
            try:
                rule = Rule.objects.get(
                    project=project,
                    id=int(rule_id),
                    status__in=[RuleStatus.ACTIVE, RuleStatus.INACTIVE],
                )
                context["rule"] = serialize(rule, request.user)
            except Rule.DoesNotExist:
                raise Http404

        if status == "failed":
            context["error"] = error

        return Response(context, status=200)
</source>
</class>

<class classid="23" nclones="5" nlines="12" similarity="76">
<source file="systems/sentry-22.2.0/src/sentry/incidents/endpoints/bases.py" startline="14" endline="33" pcid="1981">
    def convert_args(self, request: Request, alert_rule_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, *args, **kwargs)
        project = kwargs["project"]

        if not features.has("organizations:incidents", project.organization, actor=request.user):
            raise ResourceDoesNotExist

        if not request.access.has_project_access(project):
            raise PermissionDenied

        try:
            kwargs["alert_rule"] = AlertRule.objects.get(
                snuba_query__subscriptions__project=project, id=alert_rule_id
            )
        except AlertRule.DoesNotExist:
            raise ResourceDoesNotExist

        return args, kwargs


</source>
<source file="systems/sentry-22.2.0/src/sentry/incidents/endpoints/bases.py" startline="37" endline="53" pcid="1982">
    def convert_args(self, request: Request, alert_rule_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, *args, **kwargs)
        organization = kwargs["organization"]

        if not features.has("organizations:incidents", organization, actor=request.user):
            raise ResourceDoesNotExist

        try:
            kwargs["alert_rule"] = AlertRule.objects.get(
                organization=organization, id=alert_rule_id
            )
        except AlertRule.DoesNotExist:
            raise ResourceDoesNotExist

        return args, kwargs


</source>
<source file="systems/sentry-22.2.0/src/sentry/incidents/endpoints/bases.py" startline="74" endline="89" pcid="1984">
    def convert_args(self, request: Request, alert_rule_trigger_action_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, *args, **kwargs)
        organization = kwargs["organization"]
        trigger = kwargs["alert_rule_trigger"]

        if not features.has("organizations:incidents", organization, actor=request.user):
            raise ResourceDoesNotExist

        try:
            kwargs["alert_rule_trigger_action"] = AlertRuleTriggerAction.objects.get(
                alert_rule_trigger=trigger, id=alert_rule_trigger_action_id
            )
        except AlertRuleTriggerAction.DoesNotExist:
            raise ResourceDoesNotExist

        return args, kwargs
</source>
<source file="systems/sentry-22.2.0/src/sentry/incidents/endpoints/bases.py" startline="55" endline="72" pcid="1983">
    def convert_args(self, request: Request, alert_rule_trigger_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, *args, **kwargs)
        organization = kwargs["organization"]
        alert_rule = kwargs["alert_rule"]

        if not features.has("organizations:incidents", organization, actor=request.user):
            raise ResourceDoesNotExist

        try:
            kwargs["alert_rule_trigger"] = AlertRuleTrigger.objects.get(
                alert_rule=alert_rule, id=alert_rule_trigger_id
            )
        except AlertRuleTrigger.DoesNotExist:
            raise ResourceDoesNotExist

        return args, kwargs


</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/project_rule_details.py" startline="27" endline="42" pcid="2960">
    def convert_args(self, request: Request, rule_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, *args, **kwargs)
        project = kwargs["project"]

        if not rule_id.isdigit():
            raise ResourceDoesNotExist

        try:
            kwargs["rule"] = Rule.objects.get(
                project=project, id=rule_id, status__in=[RuleStatus.ACTIVE, RuleStatus.INACTIVE]
            )
        except Rule.DoesNotExist:
            raise ResourceDoesNotExist

        return args, kwargs

</source>
</class>

<class classid="24" nclones="8" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/src/sentry/plugins/providers/dummy/repository.py" startline="8" endline="19" pcid="2097">
    def get_config(self):
        return [
            {
                "name": "name",
                "label": "Repository Name",
                "type": "text",
                "placeholder": "e.g. getsentry/sentry",
                "help": "Enter your repository name.",
                "required": True,
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="25" endline="39" pcid="11615">
    def test_compare_commits(self):
        repo = Repository.objects.create(provider="github", name="example", organization_id=1)

        res = self.provider._format_commits(repo, json.loads(COMPARE_COMMITS_EXAMPLE)["commits"])

        assert res == [
            {
                "author_email": "support@github.com",
                "author_name": "Monalisa Octocat",
                "message": "Fix all the bugs",
                "id": "6dcb09b5b57875f334f61aebed695e2e4193db5e",
                "repository": "example",
            }
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/repository_provider.py" startline="17" endline="28" pcid="4705">
    def get_config(self):
        return [
            {
                "name": "name",
                "label": "Repository Name",
                "type": "text",
                "placeholder": "e.g. getsentry/sentry",
                "help": "Enter your repository name, including the owner.",
                "required": True,
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="40" endline="54" pcid="11616">
    def test_get_last_commits(self):
        repo = Repository.objects.create(provider="github", name="example", organization_id=1)

        res = self.provider._format_commits(repo, json.loads(GET_LAST_COMMITS_EXAMPLE)[:10])

        assert res == [
            {
                "author_email": "support@github.com",
                "author_name": "Monalisa Octocat",
                "message": "Fix all the bugs",
                "id": "6dcb09b5b57875f334f61aebed695e2e4193db5e",
                "repository": "example",
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_contexts.py" startline="56" endline="69" pcid="9739">
def test_device(make_ctx_snapshot):
    make_ctx_snapshot(
        {
            "device": {
                "name": "My iPad",
                "model": "iPad",
                "model_id": "1234AB",
                "version": "1.2.3",
                "arch": "arm64",
            }
        }
    )


</source>
<source file="systems/sentry-22.2.0/src/sentry/plugins/sentry_webhooks/plugin.py" startline="87" endline="99" pcid="2141">
    def get_config(self, project, **kwargs):
        return [
            {
                "name": "urls",
                "label": "Callback URLs",
                "type": "textarea",
                "help": "Enter callback URLs to POST new events to (one per line).",
                "placeholder": "https://sentry.io/callback/url",
                "validators": [validate_urls],
                "required": False,
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_frame.py" startline="41" endline="51" pcid="9713">
def test_address_normalization(make_frames_snapshot):
    make_frames_snapshot(
        {
            "lineno": 1,
            "filename": "blah.c",
            "function": "main",
            "instruction_addr": 123456,
            "symbol_addr": "123450",
            "image_addr": "0x0",
        }
    )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_contexts.py" startline="70" endline="85" pcid="9740">
def test_device_with_alias(make_ctx_snapshot):
    make_ctx_snapshot(
        {
            "my_device": {
                "type": "device",
                "title": "My Title",
                "name": "My iPad",
                "model": "iPad",
                "model_id": "1234AB",
                "version": "1.2.3",
                "arch": "arm64",
            }
        }
    )


</source>
</class>

<class classid="25" nclones="2" nlines="17" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/plugins/base/project_api_urls.py" startline="17" endline="40" pcid="2123">
def load_plugin_urls(plugins):
    urlpatterns = []
    for plugin in plugins:
        urls = plugin.get_project_urls()
        if not urls:
            continue
        try:
            # a plugin's get_project_urls should return an iterable of url()'s,
            # which can either be URLResolver or URLPattern
            for u in urls:
                if not isinstance(u, (URLResolver, URLPattern)):
                    raise TypeError(
                        "url must be URLResolver or URLPattern, not {!r}: {!r}".format(
                            type(u).__name__, u
                        )
                    )
        except Exception:
            logger.exception("routes.failed", extra={"plugin": type(plugin).__name__})
        else:
            urlpatterns.append(url(r"^%s/" % re.escape(plugin.slug), include(urls)))

    return urlpatterns


</source>
<source file="systems/sentry-22.2.0/src/sentry/plugins/base/group_api_urls.py" startline="17" endline="40" pcid="2129">
def load_plugin_urls(plugins):
    urlpatterns = []
    for plugin in plugins:
        urls = plugin.get_group_urls()
        if not urls:
            continue
        try:
            # a plugin's get_group_urls should return an iterable of url()'s,
            # which can either be RegexURLResolver or RegexURLPattern
            for u in urls:
                if not isinstance(u, (URLResolver, URLPattern)):
                    raise TypeError(
                        "url must be URLResolver or URLPattern, not {!r}: {!r}".format(
                            type(u).__name__, u
                        )
                    )
        except Exception:
            logger.exception("routes.failed", extra={"plugin": type(plugin).__name__})
        else:
            urlpatterns.append(url(r"^%s/" % re.escape(plugin.slug), include(urls)))

    return urlpatterns


</source>
</class>

<class classid="26" nclones="2" nlines="18" similarity="94">
<source file="systems/sentry-22.2.0/src/sentry/templatetags/sentry_avatars.py" startline="47" endline="66" pcid="2179">
def avatar(user, size=36):
    # user can be User or OrganizationMember
    if isinstance(user, User):
        user_id = user.id
        email = user.email
    else:
        user_id = user.user_id
        email = user.email
        if user_id:
            email = user.user.email
    return {
        "email": email,
        "user_id": user_id,
        "size": size,
        "avatar_type": user.get_avatar_type(),
        "display_name": user.get_display_name(),
        "label": user.get_label(),
    }


</source>
<source file="systems/sentry-22.2.0/src/sentry/templatetags/sentry_avatars.py" startline="68" endline="86" pcid="2180">
def avatar_for_email(user, size=36):
    # user can be User or OrganizationMember
    if isinstance(user, User):
        user_id = user.id
        email = user.email
    else:
        user_id = user.user_id
        email = user.email
        if user_id:
            email = user.user.email
    return {
        "for_email": True,
        "email": email,
        "user_id": user_id,
        "size": size,
        "avatar_type": user.get_avatar_type(),
        "display_name": user.get_display_name(),
        "label": user.get_label(),
    }
</source>
</class>

<class classid="27" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/api/serializers/models/project_transaction_threshold.py" startline="11" endline="22" pcid="2400">
    def serialize(self, obj, attrs, user):
        return {
            "id": str(obj.id),
            "threshold": str(obj.threshold),
            "metric": TRANSACTION_METRICS[obj.metric],
            "projectId": str(obj.project_id),
            "editedBy": str(obj.edited_by_id),
            "dateUpdated": obj.date_updated,
            "dateAdded": obj.date_added,
        }


</source>
<source file="systems/sentry-22.2.0/src/sentry/api/serializers/models/project_transaction_threshold.py" startline="25" endline="35" pcid="2401">
    def serialize(self, obj, attrs, user):
        return {
            "id": str(obj.id),
            "threshold": str(obj.threshold),
            "metric": TRANSACTION_METRICS[obj.metric],
            "transaction": obj.transaction,
            "projectId": str(obj.project_id),
            "editedBy": str(obj.edited_by_id),
            "dateUpdated": obj.date_updated,
            "dateAdded": obj.date_added,
        }
</source>
</class>

<class classid="28" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/api/serializers/rest_framework/sentry_app.py" startline="47" endline="61" pcid="2463">
    def to_internal_value(self, data):
        if data is None:
            return

        if data == "" or data == {}:
            return {}

        try:
            validate_ui_element_schema(data, self.context["features"])
        except SchemaValidationError as e:
            raise ValidationError(e.message)  # noqa: B306

        return data


</source>
<source file="systems/sentry-22.2.0/src/sentry/api/serializers/rest_framework/doc_integration.py" startline="17" endline="31" pcid="2480">
    def to_internal_value(self, data):
        if data is None:
            return

        if data == "" or data == {}:
            return {}

        try:
            validated_data = validate_metadata_schema(data)
        except SchemaValidationError as e:
            raise ValidationError(e.message)  # noqa: B306

        return validated_data


</source>
</class>

<class classid="29" nclones="2" nlines="21" similarity="73">
<source file="systems/sentry-22.2.0/src/sentry/api/bases/monitor.py" startline="14" endline="42" pcid="2590">
    def convert_args(self, request: Request, monitor_id, *args, **kwargs):
        try:
            monitor = Monitor.objects.get(guid=monitor_id)
        except Monitor.DoesNotExist:
            raise ResourceDoesNotExist

        project = Project.objects.get_from_cache(id=monitor.project_id)
        if project.status != ProjectStatus.VISIBLE:
            raise ResourceDoesNotExist

        # HACK: This doesn't work since we can't return a 400 from here,
        # and actually just results in a 500.
        if hasattr(request.auth, "project_id") and project.id != request.auth.project_id:
            return self.respond(status=400)

        if not features.has("organizations:monitors", project.organization, actor=request.user):
            raise ResourceDoesNotExist

        self.check_object_permissions(request, project)

        with configure_scope() as scope:
            scope.set_tag("project", project.id)

        bind_organization_context(project.organization)

        request._request.organization = project.organization

        kwargs.update({"monitor": monitor, "project": project})
        return (args, kwargs)
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/monitor_checkin_details.py" startline="45" endline="77" pcid="3155">
    def convert_args(self, request: Request, monitor_id, checkin_id, *args, **kwargs):
        try:
            monitor = Monitor.objects.get(guid=monitor_id)
        except Monitor.DoesNotExist:
            raise ResourceDoesNotExist

        project = Project.objects.get_from_cache(id=monitor.project_id)
        if project.status != ProjectStatus.VISIBLE:
            raise ResourceDoesNotExist

        if hasattr(request.auth, "project_id") and project.id != request.auth.project_id:
            return self.respond(status=400)

        if not features.has("organizations:monitors", project.organization, actor=request.user):
            raise ResourceDoesNotExist

        self.check_object_permissions(request, project)

        with configure_scope() as scope:
            scope.set_tag("project", project.id)

        bind_organization_context(project.organization)

        try:
            checkin = MonitorCheckIn.objects.get(monitor=monitor, guid=checkin_id)
        except MonitorCheckIn.DoesNotExist:
            raise ResourceDoesNotExist

        request._request.organization = project.organization

        kwargs.update({"checkin": checkin, "monitor": monitor, "project": project})
        return (args, kwargs)

</source>
</class>

<class classid="30" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/api/bases/sentryapps.py" startline="209" endline="223" pcid="2606">
    def convert_args(self, request: Request, sentry_app_slug, *args, **kwargs):
        try:
            sentry_app = SentryApp.objects.get(slug=sentry_app_slug)
        except SentryApp.DoesNotExist:
            raise Http404

        self.check_object_permissions(request, sentry_app)

        with configure_scope() as scope:
            scope.set_tag("sentry_app", sentry_app.slug)

        kwargs["sentry_app"] = sentry_app
        return (args, kwargs)


</source>
<source file="systems/sentry-22.2.0/src/sentry/api/bases/sentryapps.py" startline="311" endline="325" pcid="2611">
    def convert_args(self, request: Request, uuid, *args, **kwargs):
        try:
            installation = SentryAppInstallation.objects.get(uuid=uuid)
        except SentryAppInstallation.DoesNotExist:
            raise Http404

        self.check_object_permissions(request, installation)

        with configure_scope() as scope:
            scope.set_tag("sentry_app_installation", installation.uuid)

        kwargs["installation"] = installation
        return (args, kwargs)


</source>
</class>

<class classid="31" nclones="2" nlines="12" similarity="76">
<source file="systems/sentry-22.2.0/src/sentry/api/bases/organizationmember.py" startline="48" endline="59" pcid="2623">
    def _get_member(self, request: Request, organization, member_id):
        if member_id == "me":
            queryset = OrganizationMember.objects.filter(
                organization=organization, user__id=request.user.id, user__is_active=True
            )
        else:
            queryset = OrganizationMember.objects.filter(
                Q(user__is_active=True) | Q(user__isnull=True),
                organization=organization,
                id=member_id,
            )
        return queryset.select_related("user").get()
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_member_team_details.py" startline="94" endline="108" pcid="2998">
    def _get_member(
        self, request: Request, organization: Organization, member_id: Union[int, str]
    ) -> OrganizationMember:
        if member_id == "me":
            queryset = OrganizationMember.objects.filter(
                organization=organization, user__id=request.user.id, user__is_active=True
            )
        else:
            queryset = OrganizationMember.objects.filter(
                Q(user__is_active=True) | Q(user__isnull=True),
                organization=organization,
                id=member_id,
            )
        return queryset.select_related("user").get()

</source>
</class>

<class classid="32" nclones="2" nlines="18" similarity="88">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_subscriptions.py" startline="55" endline="85" pcid="2638">
    def put(self, request: Request, user) -> Response:
        """
        Update Account Subscriptions
        ````````````````````````````

        Update account subscriptions to newsletter

        :param int listId: id of newsletter list
        :param boolean subscribed: should be subscribed to newsletter
        :auth: required
        """
        validator = NewsletterValidator(data=request.data)
        if not validator.is_valid():
            return self.respond(validator.errors, status=400)

        result = validator.validated_data
        email = UserEmail.objects.get_primary_email(user)

        kwargs = {
            "list_id": result["listId"],
            "subscribed": result["subscribed"],
            "verified": email.is_verified,
        }
        if not result["subscribed"]:
            kwargs["unsubscribed_date"] = timezone.now()
        else:
            kwargs["subscribed_date"] = timezone.now()

        newsletter.create_or_update_subscription(user, **kwargs)
        return self.respond(status=204)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_subscriptions.py" startline="86" endline="117" pcid="2639">
    def post(self, request: Request, user) -> Response:
        """
        Configure Newsletter Subscription
        `````````````````````````````````

        Update the default newsletter subscription.

        :param boolean subscribed: should be subscribed to newsletter
        :auth: required
        """
        validator = DefaultNewsletterValidator(data=request.data)
        if not validator.is_valid():
            return self.respond(validator.errors, status=400)

        result = validator.validated_data
        email = UserEmail.objects.get_primary_email(user)

        kwargs = {
            "subscribed": result["subscribed"],
            "verified": email.is_verified,
            "list_ids": newsletter.get_default_list_ids(),
        }
        if not result["subscribed"]:
            kwargs["unsubscribed_date"] = timezone.now()
        else:
            kwargs["subscribed_date"] = timezone.now()

        newsletter.create_or_update_subscriptions(user, **kwargs)

        user.update(flags=F("flags").bitand(~User.flags.newsletter_consent_prompt))

        return self.respond(status=204)
</source>
</class>

<class classid="33" nclones="4" nlines="20" similarity="73">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/userroles_details.py" startline="71" endline="89" pcid="2670">
    def delete(self, request: Request, role_name) -> Response:
        if not request.access.has_permission("users.admin"):
            return self.respond(status=403)

        try:
            role = UserRole.objects.get(name=role_name)
        except UserRole.DoesNotExist:
            return self.respond({"detail": f"'{role_name}' is not a known role."}, status=404)

        with transaction.atomic():
            role.delete()
            audit_logger.info(
                "user-roles.delete",
                extra={
                    "actor_id": request.user.id,
                    "role_id": role.id,
                },
            )
        return self.respond(status=204)
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_role_details.py" startline="60" endline="79" pcid="2793">
    def delete(self, request: Request, user, role_name) -> Response:
        if not request.access.has_permission("users.admin"):
            return self.respond(status=403)

        try:
            role = UserRole.objects.get(users=user, name=role_name)
        except UserRole.DoesNotExist:
            return self.respond({"detail": f"'{role_name}' is not a known role."}, status=404)

        with transaction.atomic():
            role.users.remove(user)
            audit_logger.info(
                "user.remove-role",
                extra={
                    "actor_id": request.user.id,
                    "user_id": user.id,
                    "role_id": role.id,
                },
            )
        return self.respond(status=204)
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_role_details.py" startline="32" endline="58" pcid="2792">
    def post(self, request: Request, user, role_name) -> Response:
        if not request.access.has_permission("users.admin"):
            return self.respond(status=403)

        try:
            role = UserRole.objects.get(name=role_name)
        except UserRole.DoesNotExist:
            return self.respond({"detail": f"'{role_name}' is not a known role."}, status=404)

        try:
            with transaction.atomic():
                role.users.add(user)
                audit_logger.info(
                    "user.add-role",
                    extra={
                        "actor_id": request.user.id,
                        "user_id": user.id,
                        "role_id": role.id,
                    },
                )
        except IntegrityError as e:
            # TODO(dcramer): this path never gets hit because Django's M2M doesnt expose a failure scenario on `add``
            if "already exists" in str(e):
                return self.respond(status=410)
            raise
        return self.respond(status=201)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_permission_details.py" startline="29" endline="54" pcid="3132">
    def post(self, request: Request, user, permission_name) -> Response:
        if not request.access.has_permission("users.admin"):
            return self.respond(status=403)

        if permission_name not in settings.SENTRY_USER_PERMISSIONS:
            return self.respond(
                {"detail": f"'{permission_name}' is not a known permission."}, status=404
            )

        try:
            with transaction.atomic():
                UserPermission.objects.create(user=user, permission=permission_name)
                audit_logger.info(
                    "user.add-permission",
                    extra={
                        "actor_id": request.user.id,
                        "user_id": user.id,
                        "permission_name": permission_name,
                    },
                )
        except IntegrityError as e:
            if "already exists" in str(e):
                return self.respond(status=410)
            raise
        return self.respond(status=201)

</source>
</class>

<class classid="34" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_code_mapping_codeowners.py" startline="13" endline="27" pcid="2681">
    def convert_args(self, request: Request, organization_slug, config_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, organization_slug, config_id, *args, **kwargs)

        try:
            kwargs["config"] = RepositoryProjectPathConfig.objects.get(
                id=config_id,
                organization_integration__in=OrganizationIntegration.objects.filter(
                    organization=kwargs["organization"]
                ).values_list("id", flat=True),
            )
        except RepositoryProjectPathConfig.DoesNotExist:
            raise Http404

        return (args, kwargs)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_code_mapping_details.py" startline="20" endline="34" pcid="2981">
    def convert_args(self, request: Request, organization_slug, config_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, organization_slug, config_id, *args, **kwargs)

        try:
            kwargs["config"] = RepositoryProjectPathConfig.objects.get(
                id=config_id,
                organization_integration__in=OrganizationIntegration.objects.filter(
                    organization=kwargs["organization"]
                ).values_list("id", flat=True),
            )
        except RepositoryProjectPathConfig.DoesNotExist:
            raise Http404

        return (args, kwargs)

</source>
</class>

<class classid="35" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/project_team_details.py" startline="25" endline="44" pcid="2702">
    def post(self, request: Request, project, team_slug) -> Response:
        """
        Give a team access to a project
        ```````````````````````````````
        :pparam string organization_slug: the slug of the organization.
        :pparam string project_slug: the slug of the project.
        :pparam string team_slug: the slug of the team.
        :auth: required
        """
        try:
            team = Team.objects.get(organization_id=project.organization_id, slug=team_slug)
        except Team.DoesNotExist:
            raise Http404
        if not request.access.has_team_scope(team, "project:write"):
            return Response(
                {"detail": ["You do not have permission to perform this action."]}, status=403
            )
        project.add_team(team)
        return Response(serialize(project, request.user, ProjectWithTeamSerializer()), status=201)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/project_team_details.py" startline="45" endline="65" pcid="2703">
    def delete(self, request: Request, project, team_slug) -> Response:
        """
        Revoke a team's access to a project
        ```````````````````````````````````
        :pparam string organization_slug: the slug of the organization.
        :pparam string project_slug: the slug of the project.
        :pparam string team_slug: the slug of the team.
        :auth: required
        """
        try:
            team = Team.objects.get(organization_id=project.organization_id, slug=team_slug)
        except Team.DoesNotExist:
            raise Http404

        if not request.access.has_team_scope(team, "project:write"):
            return Response(
                {"detail": ["You do not have permission to perform this action."]}, status=403
            )
        project.remove_team(team)

        return Response(serialize(project, request.user, ProjectWithTeamSerializer()), status=200)
</source>
</class>

<class classid="36" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/event_attachment_details.py" startline="51" endline="63" pcid="2712">
    def download(self, attachment):
        file = File.objects.get(id=attachment.file_id)
        fp = file.getfile()
        response = StreamingHttpResponse(
            iter(lambda: fp.read(4096), b""),
            content_type=file.headers.get("content-type", "application/octet-stream"),
        )
        response["Content-Length"] = file.size
        response["Content-Disposition"] = 'attachment; filename="%s"' % posixpath.basename(
            " ".join(attachment.name.split())
        )
        return response

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/project_release_file_details.py" startline="51" endline="63" pcid="3117">
    def download(releasefile):
        file = releasefile.file
        fp = file.getfile()
        response = FileResponse(
            fp,
            content_type=file.headers.get("content-type", "application/octet-stream"),
        )
        response["Content-Length"] = file.size
        response["Content-Disposition"] = 'attachment; filename="%s"' % posixpath.basename(
            " ".join(releasefile.name.split())
        )
        return response

</source>
</class>

<class classid="37" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/api_applications.py" startline="15" endline="27" pcid="2728">
    def get(self, request: Request) -> Response:
        queryset = ApiApplication.objects.filter(
            owner=request.user, status=ApiApplicationStatus.active
        )

        return self.paginate(
            request=request,
            queryset=queryset,
            order_by="name",
            paginator_cls=OffsetPaginator,
            on_results=lambda x: serialize(x, request.user),
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/api_authorizations.py" startline="16" endline="28" pcid="2798">
    def get(self, request: Request) -> Response:
        queryset = ApiAuthorization.objects.filter(
            user=request.user, application__status=ApiApplicationStatus.active
        ).select_related("application")

        return self.paginate(
            request=request,
            queryset=queryset,
            order_by="application__name",
            paginator_cls=OffsetPaginator,
            on_results=lambda x: serialize(x, request.user),
        )

</source>
</class>

<class classid="38" nclones="2" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_identity.py" startline="11" endline="30" pcid="2784">
    def get(self, request: Request, user) -> Response:
        """
        Retrieve all of a users' identities (NOT AuthIdentities)
        `````````````````````````````````

        :pparam string user ID: user ID, or 'me'
        :auth: required
        """
        queryset = Identity.objects.filter(user=user)

        provider = request.GET.get("provider")
        if provider:
            queryset = queryset.filter(idp__type=provider.lower())

        return self.paginate(
            request=request,
            queryset=queryset,
            on_results=lambda x: serialize(x, request.user),
            paginator_cls=OffsetPaginator,
        )
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_organizations.py" startline="11" endline="24" pcid="2816">
    def get(self, request: Request, user) -> Response:
        queryset = user.get_orgs()

        query = request.GET.get("query")
        if query:
            queryset = queryset.filter(Q(name__icontains=query) | Q(slug__icontains=query))

        return self.paginate(
            request=request,
            queryset=queryset,
            order_by="name",
            on_results=lambda x: serialize(x, request.user),
            paginator_cls=OffsetPaginator,
        )
</source>
</class>

<class classid="39" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/user_notification_settings_details.py" startline="21" endline="41" pcid="2891">
    def get(self, request: Request, user: User) -> Response:
        """
        Get the Notification Settings for a given User.
        ````````````````````````````````
        :pparam string user_id: A User's `user_id` or "me" for current user.
        :qparam string type: If set, filter the NotificationSettings to this type.

        :auth required:
        """

        type_option = validate_type_option(request.GET.get("type"))

        return Response(
            serialize(
                user,
                request.user,
                NotificationSettingsSerializer(),
                type=type_option,
            ),
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/team_notification_settings_details.py" startline="18" endline="37" pcid="2969">
    def get(self, request: Request, team: Team) -> Response:
        """
        Get the Notification Settings for a given User.
        ````````````````````````````````
        :pparam string team_slug: The slug of the team to get.
        :qparam string type: If set, filter the NotificationSettings to this type.
        :auth required:
        """

        type_option = validate_type_option(request.GET.get("type"))

        return Response(
            serialize(
                team,
                request.user,
                NotificationSettingsSerializer(),
                type=type_option,
            ),
        )

</source>
</class>

<class classid="40" nclones="2" nlines="34" similarity="77">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_member_team_details.py" startline="123" endline="174" pcid="3000">
    def post(
        self,
        request: Request,
        organization: Organization,
        member_id: Union[int, str],
        team_slug: str,
    ) -> Response:
        """
        Join, request access to or add a member to a team.

        If the user needs permission to join the team, an access request will
        be generated and the returned status code will be 202.

        If the user is already a member of the team, this will simply return
        a 204.
        """
        try:
            member = self._get_member(request, organization, member_id)
        except OrganizationMember.DoesNotExist:
            raise ResourceDoesNotExist

        if not request.user.is_authenticated:
            return Response(status=status.HTTP_401_UNAUTHORIZED)

        try:
            team = Team.objects.get(organization=organization, slug=team_slug)
        except Team.DoesNotExist:
            raise ResourceDoesNotExist

        try:
            omt = OrganizationMemberTeam.objects.get(team=team, organizationmember=member)
        except OrganizationMemberTeam.DoesNotExist:
            if self._can_create_team_member(request, team):
                omt = OrganizationMemberTeam.objects.create(team=team, organizationmember=member)
            else:
                self._create_access_request(request, team, member)
                return Response(status=202)

        else:
            return Response(status=204)

        self.create_audit_entry(
            request=request,
            organization=organization,
            target_object=omt.id,
            target_user=member.user,
            event=AuditLogEntryEvent.MEMBER_JOIN_TEAM,
            data=omt.get_audit_log_data(),
        )

        return Response(serialize(team, request.user, TeamWithProjectsSerializer()), status=201)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_member_team_details.py" startline="175" endline="213" pcid="3001">
    def delete(
        self,
        request: Request,
        organization: Organization,
        member_id: Union[int, str],
        team_slug: str,
    ) -> Response:
        """
        Leave or remove a member from a team
        """
        try:
            member = self._get_member(request, organization, member_id)
        except OrganizationMember.DoesNotExist:
            raise ResourceDoesNotExist

        try:
            team = Team.objects.get(organization=organization, slug=team_slug)
        except Team.DoesNotExist:
            raise ResourceDoesNotExist

        if not self._can_delete(request, member, team):
            return Response({"detail": ERR_INSUFFICIENT_ROLE}, status=400)

        try:
            omt = OrganizationMemberTeam.objects.get(team=team, organizationmember=member)
        except OrganizationMemberTeam.DoesNotExist:
            pass
        else:
            self.create_audit_entry(
                request=request,
                organization=organization,
                target_object=omt.id,
                target_user=member.user,
                event=AuditLogEntryEvent.MEMBER_LEAVE_TEAM,
                data=omt.get_audit_log_data(),
            )
            omt.delete()

        return Response(serialize(team, request.user, TeamWithProjectsSerializer()), status=200)
</source>
</class>

<class classid="41" nclones="2" nlines="15" similarity="81">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/group_events_oldest.py" startline="10" endline="34" pcid="3044">
    def get(self, request: Request, group) -> Response:
        """
        Retrieve the Oldest Event for an Issue
        ``````````````````````````````````````

        Retrieves the details of the oldest event for an issue.

        :pparam string group_id: the ID of the issue
        """

        environments = [e.name for e in get_environments(request, group.project.organization)]

        event = group.get_oldest_event_for_environments(environments)

        if not event:
            return Response({"detail": "No events found for group"}, status=404)

        try:
            return client.get(
                f"/projects/{event.organization.slug}/{event.project.slug}/events/{event.event_id}/",
                request=request,
                data={"environment": environments, "group_id": event.group_id},
            )
        except client.ApiError as e:
            return Response(e.body, status=e.status_code)
</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/group_events_latest.py" startline="21" endline="48" pcid="3095">
    def get(self, request: Request, group) -> Response:
        """
        Retrieve the Latest Event for an Issue
        ``````````````````````````````````````

        Retrieves the details of the latest event for an issue.

        :pparam string group_id: the ID of the issue
        """
        environments = [e.name for e in get_environments(request, group.project.organization)]

        event = group.get_latest_event_for_environments(environments)

        if not event:
            return Response({"detail": "No events found for group"}, status=404)

        collapse = request.GET.getlist("collapse", [])
        if "stacktraceOnly" in collapse:
            return Response(serialize(event, request.user, EventSerializer()))

        try:
            return client.get(
                f"/projects/{event.organization.slug}/{event.project.slug}/events/{event.event_id}/",
                request=request,
                data={"environment": environments, "group_id": event.group_id},
            )
        except client.ApiError as e:
            return Response(e.body, status=e.status_code)
</source>
</class>

<class classid="42" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/rules/actions/notify_event_service.py" startline="209" endline="223" pcid="3249">
    def get_plugins(self):
        from sentry.plugins.bases.notify import NotificationPlugin

        results = []
        for plugin in plugins.for_project(self.project, version=1):
            if not isinstance(plugin, NotificationPlugin):
                continue
            results.append(PluginService(plugin))

        for plugin in plugins.for_project(self.project, version=2):
            for notifier in safe_execute(plugin.get_notifiers, _with_transaction=False) or ():
                results.append(PluginService(notifier))

        return results

</source>
<source file="systems/sentry-22.2.0/src/sentry/rules/actions/notify_event.py" startline="16" endline="30" pcid="3252">
    def get_plugins(self):
        from sentry.plugins.bases.notify import NotificationPlugin

        results = []
        for plugin in plugins.for_project(self.project, version=1):
            if not isinstance(plugin, NotificationPlugin):
                continue
            results.append(LegacyPluginService(plugin))

        for plugin in plugins.for_project(self.project, version=2):
            for notifier in safe_execute(plugin.get_notifiers, _with_transaction=False) or ():
                results.append(LegacyPluginService(notifier))

        return results

</source>
</class>

<class classid="43" nclones="2" nlines="61" similarity="72">
<source file="systems/sentry-22.2.0/src/sentry/rules/conditions/event_attribute.py" startline="155" endline="225" pcid="3259">
    def passes(self, event, state, **kwargs):
        attr = self.get_option("attribute")
        match = self.get_option("match")
        value = self.get_option("value")

        if not (attr and match and value):
            return False

        value = value.lower()
        attr = attr.lower()

        try:
            attribute_values = self._get_attribute_values(event, attr)
        except KeyError:
            attribute_values = []

        attribute_values = [str(v).lower() for v in attribute_values if v is not None]

        if match == MatchType.EQUAL:
            for a_value in attribute_values:
                if a_value == value:
                    return True
            return False

        elif match == MatchType.NOT_EQUAL:
            for a_value in attribute_values:
                if a_value == value:
                    return False
            return True

        elif match == MatchType.STARTS_WITH:
            for a_value in attribute_values:
                if a_value.startswith(value):
                    return True
            return False

        elif match == MatchType.NOT_STARTS_WITH:
            for a_value in attribute_values:
                if a_value.startswith(value):
                    return False
            return True

        elif match == MatchType.ENDS_WITH:
            for a_value in attribute_values:
                if a_value.endswith(value):
                    return True
            return False

        elif match == MatchType.NOT_ENDS_WITH:
            for a_value in attribute_values:
                if a_value.endswith(value):
                    return False
            return True

        elif match == MatchType.CONTAINS:
            for a_value in attribute_values:
                if value in a_value:
                    return True
            return False

        elif match == MatchType.NOT_CONTAINS:
            for a_value in attribute_values:
                if value in a_value:
                    return False
            return True

        elif match == MatchType.IS_SET:
            return bool(attribute_values)

        elif match == MatchType.NOT_SET:
            return not attribute_values
</source>
<source file="systems/sentry-22.2.0/src/sentry/rules/conditions/tagged_event.py" startline="33" endline="116" pcid="3276">
    def passes(self, event, state, **kwargs):
        key = self.get_option("key")
        match = self.get_option("match")
        value = self.get_option("value")

        if not (key and match):
            return False

        key = key.lower()

        tags = (
            k
            for gen in (
                (k.lower() for k, v in event.tags),
                (tagstore.get_standardized_key(k) for k, v in event.tags),
            )
            for k in gen
        )

        if match == MatchType.IS_SET:
            return key in tags

        elif match == MatchType.NOT_SET:
            return key not in tags

        if not value:
            return False

        value = value.lower()

        values = (
            v.lower()
            for k, v in event.tags
            if k.lower() == key or tagstore.get_standardized_key(k) == key
        )

        if match == MatchType.EQUAL:
            for t_value in values:
                if t_value == value:
                    return True
            return False

        elif match == MatchType.NOT_EQUAL:
            for t_value in values:
                if t_value == value:
                    return False
            return True

        elif match == MatchType.STARTS_WITH:
            for t_value in values:
                if t_value.startswith(value):
                    return True
            return False

        elif match == MatchType.NOT_STARTS_WITH:
            for t_value in values:
                if t_value.startswith(value):
                    return False
            return True

        elif match == MatchType.ENDS_WITH:
            for t_value in values:
                if t_value.endswith(value):
                    return True
            return False

        elif match == MatchType.NOT_ENDS_WITH:
            for t_value in values:
                if t_value.endswith(value):
                    return False
            return True

        elif match == MatchType.CONTAINS:
            for t_value in values:
                if value in t_value:
                    return True
            return False

        elif match == MatchType.NOT_CONTAINS:
            for t_value in values:
                if value in t_value:
                    return False
            return True

</source>
</class>

<class classid="44" nclones="2" nlines="13" similarity="92">
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_auth_views.py" startline="10" endline="24" pcid="3418">
    def get(self, request: Request) -> Response:
        auth_identity = {"id": "bar@example.com", "email": "bar@example.com"}
        return render_to_response(
            "sentry/auth-confirm-identity.html",
            context={
                "existing_user": User(email="foo@example.com"),
                "identity": auth_identity,
                "login_form": None,
                "identity_display_name": auth_identity["email"],
                "identity_identifier": auth_identity["id"],
            },
            request=request,
        )


</source>
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_auth_views.py" startline="26" endline="37" pcid="3419">
    def get(self, request: Request) -> Response:
        auth_identity = {"id": "bar@example.com", "email": "bar@example.com"}
        return render_to_response(
            "sentry/auth-confirm-link.html",
            context={
                "existing_user": User(email="foo@example.com"),
                "identity": auth_identity,
                "identity_display_name": auth_identity["email"],
                "identity_identifier": auth_identity["id"],
            },
            request=request,
        )
</source>
</class>

<class classid="45" nclones="4" nlines="11" similarity="83">
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_recovery_codes_regenerated_email.py" startline="14" endline="28" pcid="3422">
    def get(self, request: Request) -> Response:
        authenticator = Authenticator(id=0, type=3, user=request.user)  # u2f

        email = generate_security_email(
            account=request.user,
            actor=request.user,
            type="recovery-codes-regenerated",
            ip_address=request.META["REMOTE_ADDR"],
            context={"authenticator": authenticator},
            # make this consistent for acceptance tests
            current_datetime=datetime.datetime(2017, 1, 20, 21, 39, 23, 30723),
        )
        return MailPreview(
            html_template=email.html_template, text_template=email.template, context=email.context
        ).render(request)
</source>
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_mfa_added_email.py" startline="14" endline="28" pcid="3427">
    def get(self, request: Request) -> Response:
        authenticator = Authenticator(id=0, type=3, user=request.user)  # u2f

        email = generate_security_email(
            account=request.user,
            actor=request.user,
            type="mfa-added",
            ip_address=request.META["REMOTE_ADDR"],
            context={"authenticator": authenticator, "device_name": "Home computer"},
            # make this consistent for acceptance tests
            current_datetime=datetime.datetime(2017, 1, 20, 21, 39, 23, 30723),
        )
        return MailPreview(
            html_template=email.html_template, text_template=email.template, context=email.context
        ).render(request)
</source>
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_password_changed_email.py" startline="13" endline="24" pcid="3432">
    def get(self, request: Request) -> Response:
        email = generate_security_email(
            account=request.user,
            actor=request.user,
            type="password-changed",
            ip_address=request.META["REMOTE_ADDR"],
            # make this consistent for acceptance tests
            current_datetime=datetime.datetime(2017, 1, 20, 21, 39, 23, 30723),
        )
        return MailPreview(
            html_template=email.html_template, text_template=email.template, context=email.context
        ).render(request)
</source>
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_mfa_removed_email.py" startline="14" endline="28" pcid="3436">
    def get(self, request: Request) -> Response:
        authenticator = Authenticator(id=0, type=3, user=request.user)  # u2f

        email = generate_security_email(
            account=request.user,
            actor=request.user,
            type="mfa-removed",
            ip_address=request.META["REMOTE_ADDR"],
            context={"authenticator": authenticator, "device_name": "Home computer"},
            # make this consistent for acceptance tests
            current_datetime=datetime.datetime(2017, 1, 20, 21, 39, 23, 30723),
        )
        return MailPreview(
            html_template=email.html_template, text_template=email.template, context=email.context
        ).render(request)
</source>
</class>

<class classid="46" nclones="2" nlines="10" similarity="77">
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_assigned_email.py" startline="9" endline="20" pcid="3451">
    def get_activity(self, request: Request, event):
        return {
            "type": Activity.ASSIGNED,
            "user": request.user,
            "data": {
                "assignee": "10000000",
                "assigneeEmail": "foo@example.com",
                "assigneeType": "user",
            },
        }


</source>
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/debug/debug_assigned_email.py" startline="22" endline="33" pcid="3452">
    def get_activity(self, request: Request, event):
        return {
            "type": Activity.ASSIGNED,
            "user": request.user,
            "data": {
                "assignee": str(request.user.id),
                "assigneeEmail": request.user.email,
                "assigneeType": "user",
            },
        }


</source>
</class>

<class classid="47" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/web/frontend/msteams_extension_configuration.py" startline="13" endline="24" pcid="3482">
    def map_params_to_state(self, params):
        # decode the signed params and add them to whatever params we have
        params = params.copy()
        signed_params = params["signed_params"]
        del params["signed_params"]
        params.update(
            unsign(
                signed_params,
                max_age=INSTALL_EXPIRATION_TIME,
            )
        )
        return params
</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira/extension_configuration.py" startline="15" endline="27" pcid="3832">
    def map_params_to_state(self, params):
        # decode the signed params and add them to whatever params we have
        params = params.copy()
        signed_params = params["signed_params"]
        del params["signed_params"]
        params.update(
            unsign(
                signed_params,
                max_age=INSTALL_EXPIRATION_TIME,
            )
        )
        params["metadata"] = json.loads(params["metadata"])
        return params
</source>
</class>

<class classid="48" nclones="2" nlines="39" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/webhook.py" startline="59" endline="108" pcid="3641">
    def __call__(self, organization, event):
        authors = {}

        try:
            repo = Repository.objects.get(
                organization_id=organization.id,
                provider=PROVIDER_NAME,
                external_id=str(event["repository"]["uuid"]),
            )
        except Repository.DoesNotExist:
            raise Http404()

        # while we're here, make sure repo data is up to date
        self.update_repo_data(repo, event)

        for change in event["push"]["changes"]:
            for commit in change.get("commits", []):
                if IntegrationRepositoryProvider.should_ignore_commit(commit["message"]):
                    continue

                author_email = parse_email(commit["author"]["raw"])

                # TODO(dcramer): we need to deal with bad values here, but since
                # its optional, lets just throw it out for now
                if author_email is None or len(author_email) > 75:
                    author = None
                elif author_email not in authors:
                    authors[author_email] = author = CommitAuthor.objects.get_or_create(
                        organization_id=organization.id,
                        email=author_email,
                        defaults={"name": commit["author"]["raw"].split("<")[0].strip()},
                    )[0]
                else:
                    author = authors[author_email]
                try:
                    with transaction.atomic():

                        Commit.objects.create(
                            repository_id=repo.id,
                            organization_id=organization.id,
                            key=commit["hash"],
                            message=commit["message"],
                            author=author,
                            date_added=parse_date(commit["date"]).astimezone(timezone.utc),
                        )

                except IntegrityError:
                    pass


</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/endpoints/webhook.py" startline="30" endline="80" pcid="4714">
    def __call__(self, organization, event):
        authors = {}

        try:
            repo = Repository.objects.get(
                organization_id=organization.id,
                provider="bitbucket",
                external_id=str(event["repository"]["uuid"]),
            )
        except Repository.DoesNotExist:
            raise Http404()

        if repo.config.get("name") != event["repository"]["full_name"]:
            repo.config["name"] = event["repository"]["full_name"]
            repo.save()

        for change in event["push"]["changes"]:
            for commit in change.get("commits", []):
                if RepositoryProvider.should_ignore_commit(commit["message"]):
                    continue

                author_email = parse_email(commit["author"]["raw"])

                # TODO(dcramer): we need to deal with bad values here, but since
                # its optional, lets just throw it out for now
                if author_email is None or len(author_email) > 75:
                    author = None
                elif author_email not in authors:
                    authors[author_email] = author = CommitAuthor.objects.get_or_create(
                        organization_id=organization.id,
                        email=author_email,
                        defaults={"name": commit["author"]["raw"].split("<")[0].strip()},
                    )[0]
                else:
                    author = authors[author_email]
                try:
                    with transaction.atomic():

                        Commit.objects.create(
                            repository_id=repo.id,
                            organization_id=organization.id,
                            key=commit["hash"],
                            message=commit["message"],
                            author=author,
                            date_added=parse_date(commit["date"]).astimezone(timezone.utc),
                        )

                except IntegrityError:
                    pass


</source>
</class>

<class classid="49" nclones="2" nlines="44" similarity="84">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/webhook.py" startline="122" endline="176" pcid="3644">
    def post(self, request: Request, organization_id) -> Response:
        try:
            organization = Organization.objects.get_from_cache(id=organization_id)
        except Organization.DoesNotExist:
            logger.error(
                f"{PROVIDER_NAME}.webhook.invalid-organization",
                extra={"organization_id": organization_id},
            )
            return HttpResponse(status=400)

        body = bytes(request.body)
        if not body:
            logger.error(
                f"{PROVIDER_NAME}.webhook.missing-body", extra={"organization_id": organization.id}
            )
            return HttpResponse(status=400)

        try:
            handler = self.get_handler(request.META["HTTP_X_EVENT_KEY"])
        except KeyError:
            logger.error(
                f"{PROVIDER_NAME}.webhook.missing-event", extra={"organization_id": organization.id}
            )
            return HttpResponse(status=400)

        if not handler:
            return HttpResponse(status=204)

        address_string = str(request.META["REMOTE_ADDR"])
        ip = ipaddress.ip_address(address_string)
        valid_ip = False
        for ip_range in BITBUCKET_IP_RANGES:
            if ip in ip_range:
                valid_ip = True
                break

        if not valid_ip and address_string not in BITBUCKET_IPS:
            logger.error(
                f"{PROVIDER_NAME}.webhook.invalid-ip-range",
                extra={"organization_id": organization.id},
            )
            return HttpResponse(status=401)

        try:
            event = json.loads(body.decode("utf-8"))
        except json.JSONDecodeError:
            logger.error(
                f"{PROVIDER_NAME}.webhook.invalid-json",
                extra={"organization_id": organization.id},
                exc_info=True,
            )
            return HttpResponse(status=400)

        handler()(organization, event)
        return HttpResponse(status=204)
</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/endpoints/webhook.py" startline="94" endline="145" pcid="4717">
    def post(self, request: Request, organization_id):
        try:
            organization = Organization.objects.get_from_cache(id=organization_id)
        except Organization.DoesNotExist:
            logger.error(
                "bitbucket.webhook.invalid-organization", extra={"organization_id": organization_id}
            )
            return HttpResponse(status=400)

        body = bytes(request.body)
        if not body:
            logger.error(
                "bitbucket.webhook.missing-body", extra={"organization_id": organization.id}
            )
            return HttpResponse(status=400)

        try:
            handler = self.get_handler(request.META["HTTP_X_EVENT_KEY"])
        except KeyError:
            logger.error(
                "bitbucket.webhook.missing-event", extra={"organization_id": organization.id}
            )
            return HttpResponse(status=400)

        if not handler:
            return HttpResponse(status=204)

        address_string = str(request.META["REMOTE_ADDR"])
        ip = ipaddress.ip_address(address_string)
        valid_ip = False
        for ip_range in BITBUCKET_IP_RANGES:
            if ip in ip_range:
                valid_ip = True
                break
        if not valid_ip and address_string not in BITBUCKET_IPS:
            logger.error(
                "bitbucket.webhook.invalid-ip-range", extra={"organization_id": organization.id}
            )
            return HttpResponse(status=401)

        try:
            event = json.loads(body.decode("utf-8"))
        except json.JSONDecodeError:
            logger.error(
                "bitbucket.webhook.invalid-json",
                extra={"organization_id": organization.id},
                exc_info=True,
            )
            return HttpResponse(status=400)

        handler()(organization, event)
        return HttpResponse(status=204)
</source>
</class>

<class classid="50" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/repository.py" startline="14" endline="25" pcid="3646">
    def get_repository_data(self, organization, config):
        installation = self.get_installation(config.get("installation"), organization.id)
        client = installation.get_client()
        try:
            repo = client.get_repo(config["identifier"])
        except Exception as e:
            installation.raise_error(e)
        else:
            config["external_id"] = str(repo["uuid"])
            config["name"] = repo["full_name"]
        return config

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/repository.py" startline="17" endline="31" pcid="3694">
    def get_repository_data(self, organization, config):
        installation = self.get_installation(config.get("installation"), organization.id)
        client = installation.get_client()
        try:
            project, repo = config["identifier"].split("/", 1)
            repo = client.get_repo(project, repo)
        except Exception as e:
            installation.raise_error(e)
        else:
            config["external_id"] = str(repo["id"])
            config["name"] = repo["project"]["key"] + "/" + repo["name"]
            config["project"] = repo["project"]["key"]
            config["repo"] = repo["name"]
        return config

</source>
</class>

<class classid="51" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/repository.py" startline="26" endline="39" pcid="3647">
    def get_webhook_secret(self, organization):
        # TODO(LB): Revisit whether Integrations V3 should be using OrganizationOption for storage
        lock = locks.get(f"bitbucket:webhook-secret:{organization.id}", duration=60)
        with lock.acquire():
            secret = OrganizationOption.objects.get_value(
                organization=organization, key="bitbucket:webhook_secret"
            )
            if secret is None:
                secret = generate_token()
                OrganizationOption.objects.set_value(
                    organization=organization, key="bitbucket:webhook_secret", value=secret
                )
        return secret

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/repository_provider.py" startline="47" endline="59" pcid="4707">
    def get_webhook_secret(self, organization):
        lock = locks.get(f"bitbucket:webhook-secret:{organization.id}", duration=60)
        with lock.acquire():
            secret = OrganizationOption.objects.get_value(
                organization=organization, key="bitbucket:webhook_secret"
            )
            if secret is None:
                secret = uuid4().hex + uuid4().hex
                OrganizationOption.objects.set_value(
                    organization=organization, key="bitbucket:webhook_secret", value=secret
                )
        return secret

</source>
</class>

<class classid="52" nclones="2" nlines="24" similarity="73">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/repository.py" startline="40" endline="65" pcid="3648">
    def build_repository_config(self, organization, data):
        installation = self.get_installation(data.get("installation"), organization.id)
        client = installation.get_client()
        try:
            resp = client.create_hook(
                data["identifier"],
                {
                    "description": "sentry-bitbucket-repo-hook",
                    "url": absolute_uri(
                        f"/extensions/bitbucket/organizations/{organization.id}/webhook/"
                    ),
                    "active": True,
                    "events": ["repo:push", "pullrequest:fulfilled"],
                },
            )
        except Exception as e:
            installation.raise_error(e)
        else:
            return {
                "name": data["identifier"],
                "external_id": data["external_id"],
                "url": "https://bitbucket.org/{}".format(data["name"]),
                "config": {"name": data["name"], "webhook_id": resp["uuid"]},
                "integration_id": data["installation"],
            }

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/repository_provider.py" startline="60" endline="86" pcid="4708">
    def create_repository(self, organization, data, actor=None):
        if actor is None:
            raise NotImplementedError("Cannot create a repository anonymously")

        client = self.get_client(actor)
        try:
            resp = client.create_hook(
                data["name"],
                {
                    "description": "sentry-bitbucket-repo-hook",
                    "url": absolute_uri(
                        f"/plugins/bitbucket/organizations/{organization.id}/webhook/"
                    ),
                    "active": True,
                    "events": ["repo:push"],
                },
            )
        except Exception as e:
            raise self.raise_error(e, identity=client.auth)
        else:
            return {
                "name": data["name"],
                "external_id": data["external_id"],
                "url": "https://bitbucket.org/{}".format(data["name"]),
                "config": {"name": data["name"], "webhook_id": resp["uuid"]},
            }

</source>
</class>

<class classid="53" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/repository.py" startline="77" endline="90" pcid="3650">
    def _format_commits(self, repo, commit_list):
        return [
            {
                "id": c["hash"],
                "repository": repo.name,
                "author_email": parse_email(c["author"]["raw"]),
                "author_name": parse_user_name(c["author"]["raw"]),
                "message": c["message"],
                "timestamp": self.format_date(c["date"]),
                "patch_set": c.get("patch_set"),
            }
            for c in commit_list
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/repository_provider.py" startline="99" endline="111" pcid="4710">
    def _format_commits(self, repo, commit_list):
        return [
            {
                "id": c["hash"],
                "repository": repo.name,
                "author_email": parse_email(c["author"]["raw"]),
                "author_name": parse_user_name(c["author"]["raw"]),
                "message": c["message"],
                "patch_set": c.get("patch_set"),
            }
            for c in commit_list
        ]

</source>
</class>

<class classid="54" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/integration.py" startline="152" endline="167" pcid="3666">
    def post_install(self, integration, organization, extra=None):
        repo_ids = Repository.objects.filter(
            organization_id=organization.id,
            provider__in=["bitbucket", "integrations:bitbucket"],
            integration_id__isnull=True,
        ).values_list("id", flat=True)

        for repo_id in repo_ids:
            migrate_repo.apply_async(
                kwargs={
                    "repo_id": repo_id,
                    "integration_id": integration.id,
                    "organization_id": organization.id,
                }
            )

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="302" endline="317" pcid="3716">
    def post_install(self, integration, organization, extra=None):
        repo_ids = Repository.objects.filter(
            organization_id=organization.id,
            provider__in=["bitbucket_server", "integrations:bitbucket_server"],
            integration_id__isnull=True,
        ).values_list("id", flat=True)

        for repo_id in repo_ids:
            migrate_repo.apply_async(
                kwargs={
                    "repo_id": repo_id,
                    "integration_id": integration.id,
                    "organization_id": organization.id,
                }
            )

</source>
</class>

<class classid="55" nclones="2" nlines="16" similarity="87">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket/client.py" startline="139" endline="163" pcid="3687">
    def compare_commits(self, repo, start_sha, end_sha):
        # where start_sha is oldest and end_sha is most recent
        # see
        # https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/commits/%7Brevision%7D
        commits = []
        done = False

        url = BitbucketAPIPath.repository_commits.format(repo=repo, revision=end_sha)

        while not done and len(commits) < 90:
            data = self.get(url)

            for commit in data["values"]:
                if commit["hash"] == start_sha:
                    done = True
                    break
                commits.append(commit)

            # move page forward
            try:
                url = data["next"]
            except KeyError:
                break

        return self.zip_commit_data(repo, commits)
</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/bitbucket/client.py" startline="93" endline="117" pcid="4731">
    def compare_commits(self, repo, start_sha, end_sha):
        # where start_sha is oldest and end_sha is most recent
        # see
        # https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/commits/%7Brevision%7D
        commits = []
        done = False

        url = f"/2.0/repositories/{repo}/commits/{end_sha}"

        while not done and len(commits) < 90:
            data = self.get(url)

            for commit in data["values"]:
                if commit["hash"].startswith(start_sha):
                    done = True
                    break
                commits.append(commit)

            # move page forward
            try:
                url = data["next"]
            except KeyError:
                break

        return self.zip_commit_data(repo, commits)
</source>
</class>

<class classid="56" nclones="3" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="133" endline="150" pcid="3705">
    def dispatch(self, request: Request, pipeline) -> Response:
        if request.method == "POST":
            form = InstallationForm(request.POST)
            if form.is_valid():
                form_data = form.cleaned_data

                pipeline.bind_state("installation_data", form_data)
                return pipeline.next_step()
        else:
            form = InstallationForm()

        return render_to_response(
            template="sentry/integrations/bitbucket-server-config.html",
            context={"form": form},
            request=request,
        )


</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/integration.py" startline="140" endline="157" pcid="3741">
    def dispatch(self, request: Request, pipeline) -> Response:
        if request.method == "POST":
            form = InstallationForm(request.POST)
            if form.is_valid():
                form_data = form.cleaned_data

                pipeline.bind_state("installation_data", form_data)
                return pipeline.next_step()
        else:
            form = InstallationForm()

        return render_to_response(
            template="sentry/integrations/jira-server-config.html",
            context={"form": form},
            request=request,
        )


</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/custom_scm/integration.py" startline="109" endline="127" pcid="4020">
    def dispatch(self, request: Request, pipeline) -> Response:
        if request.method == "POST":
            form = InstallationForm(request.POST)
            if form.is_valid():
                form_data = form.cleaned_data

                pipeline.bind_state("installation_data", form_data)

                return pipeline.next_step()
        else:
            form = InstallationForm()

        return render_to_response(
            template="sentry/integrations/custom-scm-config.html",
            context={"form": form},
            request=request,
        )


</source>
</class>

<class classid="57" nclones="2" nlines="21" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="158" endline="183" pcid="3706">
    def dispatch(self, request: Request, pipeline) -> Response:
        if "oauth_token" in request.GET:
            return pipeline.next_step()

        config = pipeline.fetch_state("installation_data")
        client = BitbucketServerSetupClient(
            config.get("url"),
            config.get("consumer_key"),
            config.get("private_key"),
            config.get("verify_ssl"),
        )

        try:
            request_token = client.get_request_token()
            pipeline.bind_state("request_token", request_token)
            authorize_url = client.get_authorize_url(request_token)

            return self.redirect(authorize_url)
        except ApiError as error:
            logger.info(
                "identity.bitbucket-server.request-token",
                extra={"url": config.get("url"), "error": error},
            )
            return pipeline.error(f"Could not fetch a request token from Bitbucket. {error}")


</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/integration.py" startline="165" endline="189" pcid="3742">
    def dispatch(self, request: Request, pipeline) -> Response:
        if "oauth_token" in request.GET:
            return pipeline.next_step()

        config = pipeline.fetch_state("installation_data")
        client = JiraServerSetupClient(
            config.get("url"),
            config.get("consumer_key"),
            config.get("private_key"),
            config.get("verify_ssl"),
        )
        try:
            request_token = client.get_request_token()
            pipeline.bind_state("request_token", request_token)
            authorize_url = client.get_authorize_url(request_token)

            return self.redirect(authorize_url)
        except ApiError as error:
            logger.info(
                "identity.jira-server.request-token",
                extra={"url": config.get("url"), "error": error},
            )
            return pipeline.error(f"Could not fetch a request token from Jira. {error}")


</source>
</class>

<class classid="58" nclones="2" nlines="16" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="191" endline="212" pcid="3707">
    def dispatch(self, request: Request, pipeline) -> Response:
        config = pipeline.fetch_state("installation_data")
        client = BitbucketServerSetupClient(
            config.get("url"),
            config.get("consumer_key"),
            config.get("private_key"),
            config.get("verify_ssl"),
        )

        try:
            access_token = client.get_access_token(
                pipeline.fetch_state("request_token"), request.GET["oauth_token"]
            )

            pipeline.bind_state("access_token", access_token)

            return pipeline.next_step()
        except ApiError as error:
            logger.info("identity.bitbucket-server.access-token", extra={"error": error})
            return pipeline.error(f"Could not fetch an access token from Bitbucket. {str(error)}")


</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/integration.py" startline="197" endline="217" pcid="3743">
    def dispatch(self, request: Request, pipeline) -> Response:
        config = pipeline.fetch_state("installation_data")
        client = JiraServerSetupClient(
            config.get("url"),
            config.get("consumer_key"),
            config.get("private_key"),
            config.get("verify_ssl"),
        )

        try:
            access_token = client.get_access_token(
                pipeline.fetch_state("request_token"), request.GET["oauth_token"]
            )
            pipeline.bind_state("access_token", access_token)

            return pipeline.next_step()
        except ApiError as error:
            logger.info("identity.jira-server.access-token", extra={"error": error})
            return pipeline.error("Could not fetch an access token from Jira")


</source>
</class>

<class classid="59" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="222" endline="234" pcid="3708">
    def get_client(self):
        if self.default_identity is None:
            try:
                self.default_identity = self.get_default_identity()
            except Identity.DoesNotExist:
                raise IntegrationError("Identity not found.")

        return BitbucketServer(
            self.model.metadata["base_url"],
            self.default_identity.data,
            self.model.metadata["verify_ssl"],
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/integration.py" startline="230" endline="242" pcid="3745">
    def get_client(self):
        if self.default_identity is None:
            try:
                self.default_identity = self.get_default_identity()
            except Identity.DoesNotExist:
                raise IntegrationError("Identity not found.")

        return JiraServerClient(
            self.model.metadata["base_url"],
            JiraServer(self.default_identity.data),
            self.model.metadata["verify_ssl"],
        )

</source>
</class>

<class classid="60" nclones="2" nlines="29" similarity="78">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/integration.py" startline="318" endline="348" pcid="3717">
    def build_integration(self, state):
        install = state["installation_data"]
        access_token = state["access_token"]

        hostname = urlparse(install["url"]).netloc
        external_id = "{}:{}".format(hostname, install["consumer_key"])[:64]

        credentials = {
            "consumer_key": install["consumer_key"],
            "private_key": install["private_key"],
            "access_token": access_token["oauth_token"],
            "access_token_secret": access_token["oauth_token_secret"],
        }

        return {
            "name": install["consumer_key"],
            "provider": self.key,
            "external_id": external_id,
            "metadata": {
                "base_url": install["url"],
                "domain_name": hostname,
                "verify_ssl": install["verify_ssl"],
            },
            "user_identity": {
                "type": self.key,
                "external_id": external_id,
                "data": credentials,
                "scopes": [],
            },
        }

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/integration.py" startline="301" endline="337" pcid="3750">
    def build_integration(self, state):
        install = state["installation_data"]
        access_token = state["access_token"]

        webhook_secret = sha1_text(install["private_key"]).hexdigest()

        hostname = urlparse(install["url"]).netloc
        external_id = "{}:{}".format(hostname, install["consumer_key"])[:64]

        credentials = {
            "consumer_key": install["consumer_key"],
            "private_key": install["private_key"],
            "access_token": access_token["oauth_token"],
            "access_token_secret": access_token["oauth_token_secret"],
        }
        # Create the webhook before the integration record exists
        # so that if it fails we don't persist a broken integration.
        self.create_webhook(external_id, webhook_secret, install, credentials)

        return {
            "name": install["consumer_key"],
            "provider": "jira_server",
            "external_id": external_id,
            "metadata": {
                "base_url": install["url"],
                "domain_name": hostname,
                "verify_ssl": install["verify_ssl"],
                "webhook_secret": webhook_secret,
            },
            "user_identity": {
                "type": "jira_server",
                "external_id": external_id,
                "scopes": [],
                "data": credentials,
            },
        }

</source>
</class>

<class classid="61" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/client.py" startline="59" endline="78" pcid="3722">
    def get_access_token(self, request_token, verifier):
        """
        Step 3 of the oauth flow.
        Use the verifier and request token from step 1 to get an access token.
        """
        if not verifier:
            raise ApiError("Missing OAuth token verifier")
        auth = OAuth1(
            client_key=self.consumer_key,
            resource_owner_key=request_token["oauth_token"],
            resource_owner_secret=request_token["oauth_token_secret"],
            verifier=verifier,
            rsa_key=self.private_key,
            signature_method=SIGNATURE_RSA,
            signature_type="auth_header",
        )
        url = self.access_token_url.format(self.base_url)
        resp = self.post(url, auth=auth, allow_text=True)
        return dict(parse_qsl(resp.text))

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/client.py" startline="52" endline="71" pcid="3755">
    def get_access_token(self, request_token, verifier):
        """
        Step 3 of the oauth flow.
        Use the verifier and request token from step 1 to get an access token.
        """
        if not verifier:
            raise ApiError("Missing OAuth token verifier")
        auth = OAuth1(
            client_key=self.consumer_key,
            resource_owner_key=request_token["oauth_token"],
            resource_owner_secret=request_token["oauth_token_secret"],
            verifier=verifier,
            rsa_key=self.private_key,
            signature_method=SIGNATURE_RSA,
            signature_type="auth_header",
        )
        url = self.access_token_url.format(self.base_url)
        resp = self.post(url, auth=auth, allow_text=True)
        return dict(parse_qsl(resp.text))

</source>
</class>

<class classid="62" nclones="2" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/client.py" startline="145" endline="160" pcid="3730">
    def get_commits(self, project, repo, from_hash, to_hash, limit=1000):
        logger.info(
            "load.commits",
            extra={
                "bitbucket_repo": repo,
                "bitbucket_project": project,
                "bitbucket_from_hash": from_hash,
                "bitbucket_to_hash": to_hash,
            },
        )

        return self._get_values(
            BitbucketServerAPIPath.repository_commits.format(project=project, repo=repo),
            {"limit": limit, "since": from_hash, "until": to_hash, "merges": "exclude"},
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/client.py" startline="168" endline="182" pcid="3732">
    def get_commit_filechanges(self, project, repo, commit, limit=1000):
        logger.info(
            "load.filechanges",
            extra={
                "bitbucket_repo": repo,
                "bitbucket_project": project,
                "bitbucket_commit": commit,
            },
        )

        return self._get_values(
            BitbucketServerAPIPath.commit_changes.format(project=project, repo=repo, commit=commit),
            {"limit": limit},
        )

</source>
</class>

<class classid="63" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/src/sentry/integrations/slack/views/unlink_identity.py" startline="22" endline="33" pcid="4046">
def build_unlinking_url(
    integration_id: str, slack_id: str, channel_id: str, response_url: str
) -> str:
    return base_build_linking_url(
        "sentry-integration-slack-unlink-identity",
        integration_id=integration_id,
        slack_id=slack_id,
        channel_id=channel_id,
        response_url=response_url,
    )


</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/slack/views/link_identity.py" startline="23" endline="34" pcid="4048">
def build_linking_url(
    integration: Integration, slack_id: str, channel_id: str, response_url: str
) -> str:
    return base_build_linking_url(
        "sentry-integration-slack-link-identity",
        integration_id=integration.id,
        slack_id=slack_id,
        channel_id=channel_id,
        response_url=response_url,
    )


</source>
</class>

<class classid="64" nclones="2" nlines="30" similarity="83">
<source file="systems/sentry-22.2.0/src/sentry/integrations/slack/views/unlink_identity.py" startline="37" endline="71" pcid="4047">
    def handle(self, request: Request, signed_params: str) -> Response:
        try:
            params = unsign(signed_params)
        except (SignatureExpired, BadSignature):
            return render_to_response(
                "sentry/integrations/slack/expired-link.html",
                request=request,
            )

        organization, integration, idp = get_identity_or_404(
            ExternalProviders.SLACK,
            request.user,
            integration_id=params["integration_id"],
        )

        if request.method != "POST":
            return render_to_response(
                "sentry/auth-unlink-identity.html",
                request=request,
                context={"organization": organization, "provider": integration.get_provider()},
            )

        try:
            Identity.objects.filter(idp=idp, external_id=params["slack_id"]).delete()
        except IntegrityError as e:
            logger.error("slack.unlink.integrity-error", extra=e)
            raise Http404

        send_slack_response(integration, SUCCESS_UNLINKED_MESSAGE, params, command="unlink")

        return render_to_response(
            "sentry/integrations/slack/unlinked.html",
            request=request,
            context={"channel_id": params["channel_id"], "team_id": integration.external_id},
        )
</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/slack/views/link_identity.py" startline="38" endline="74" pcid="4049">
    def handle(self, request: Request, signed_params: str) -> Response:
        try:
            params = unsign(signed_params)
        except (SignatureExpired, BadSignature):
            return render_to_response(
                "sentry/integrations/slack/expired-link.html",
                request=request,
            )

        organization, integration, idp = get_identity_or_404(
            ExternalProviders.SLACK,
            request.user,
            integration_id=params["integration_id"],
        )

        if request.method != "POST":
            return render_to_response(
                "sentry/auth-link-identity.html",
                request=request,
                context={"organization": organization, "provider": integration.get_provider()},
            )

        Identity.objects.link_identity(user=request.user, idp=idp, external_id=params["slack_id"])

        send_slack_response(integration, SUCCESS_LINKED_MESSAGE, params, command="link")
        if not NotificationSetting.objects.has_any_provider_settings(
            request.user, ExternalProviders.SLACK
        ):
            IntegrationNudgeNotification(organization, request.user, ExternalProviders.SLACK).send()

        # TODO(epurkhiser): We could do some fancy slack querying here to
        #  render a nice linking page with info about the user their linking.
        return render_to_response(
            "sentry/integrations/slack/linked.html",
            request=request,
            context={"channel_id": params["channel_id"], "team_id": integration.external_id},
        )
</source>
</class>

<class classid="65" nclones="3" nlines="18" similarity="73">
<source file="systems/sentry-22.2.0/src/sentry/integrations/slack/views/unlink_team.py" startline="18" endline="36" pcid="4050">
def build_team_unlinking_url(
    integration: Integration,
    organization_id: str,
    slack_id: str,
    channel_id: str,
    channel_name: str,
    response_url: str,
) -> str:
    return base_build_linking_url(
        "sentry-integration-slack-unlink-team",
        integration_id=integration.id,
        organization_id=organization_id,
        slack_id=slack_id,
        channel_name=channel_name,
        channel_id=channel_id,
        response_url=response_url,
    )


</source>
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="49" endline="67" pcid="4591">
    def get_current_and_previous_crash_free_rates(
        self,
        project_ids: Sequence[ProjectId],
        current_start: datetime,
        current_end: datetime,
        previous_start: datetime,
        previous_end: datetime,
        rollup: int,
        org_id: Optional[OrganizationId] = None,
    ) -> CurrentAndPreviousCrashFreeRates:
        return get_current_and_previous_crash_free_rates(  # type: ignore
            project_ids=project_ids,
            current_start=current_start,
            current_end=current_end,
            previous_start=previous_start,
            previous_end=previous_end,
            rollup=rollup,
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="179" endline="198" pcid="4602">
    def get_project_release_stats(
        self,
        project_id: ProjectId,
        release: ReleaseName,
        stat: OverviewStat,
        rollup: int,
        start: datetime,
        end: datetime,
        environments: Optional[Sequence[EnvironmentName]] = None,
    ) -> Union[ProjectReleaseUserStats, ProjectReleaseSessionStats]:
        return _get_project_release_stats(  # type: ignore
            project_id=project_id,
            release=release,
            stat=stat,
            rollup=rollup,
            start=start,
            end=end,
            environments=environments,
        )

</source>
</class>

<class classid="66" nclones="2" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/src/sentry/db/postgres/decorators.py" startline="8" endline="30" pcid="4174">
def auto_reconnect_cursor(func):
    """
    Attempt to safely reconnect when an error is hit that resembles the
    bouncer disconnecting the client due to a timeout/etc during a cursor
    execution.
    """

    @wraps(func)
    def inner(self, *args, **kwargs):
        try:
            return func(self, *args, **kwargs)
        except Exception as e:
            if not can_reconnect(e):
                raise

            self.db.close(reconnect=True)
            self.cursor = self.db._cursor()

            return func(self, *args, **kwargs)

    return inner


</source>
<source file="systems/sentry-22.2.0/src/sentry/db/postgres/decorators.py" startline="31" endline="51" pcid="4176">
def auto_reconnect_connection(func):
    """
    Attempt to safely reconnect when an error is hit that resembles the
    bouncer disconnecting the client due to a timeout/etc.
    """

    @wraps(func)
    def inner(self, *args, **kwargs):
        try:
            return func(self, *args, **kwargs)
        except Exception as e:
            if not can_reconnect(e):
                raise

            self.close(reconnect=True)

            return func(self, *args, **kwargs)

    return inner


</source>
</class>

<class classid="67" nclones="6" nlines="10" similarity="72">
<source file="systems/sentry-22.2.0/src/sentry/metrics/dogstatsd.py" startline="15" endline="25" pcid="4341">
    def incr(self, key, instance=None, tags=None, amount=1, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        statsd.increment(self._get_key(key), amount, sample_rate=sample_rate, tags=tags)

</source>
<source file="systems/sentry-22.2.0/src/sentry/metrics/datadog.py" startline="48" endline="60" pcid="4348">
    def timing(self, key, value, instance=None, tags=None, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        self.stats.timing(
            self._get_key(key), value, sample_rate=sample_rate, tags=tags, host=self.host
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/metrics/dogstatsd.py" startline="26" endline="36" pcid="4342">
    def timing(self, key, value, instance=None, tags=None, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        statsd.timing(self._get_key(key), value, sample_rate=sample_rate, tags=tags)

</source>
<source file="systems/sentry-22.2.0/src/sentry/metrics/datadog.py" startline="61" endline="72" pcid="4349">
    def gauge(self, key, value, instance=None, tags=None, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        self.stats.gauge(
            self._get_key(key), value, sample_rate=sample_rate, tags=tags, host=self.host
        )
</source>
<source file="systems/sentry-22.2.0/src/sentry/metrics/datadog.py" startline="35" endline="47" pcid="4347">
    def incr(self, key, instance=None, tags=None, amount=1, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        self.stats.increment(
            self._get_key(key), amount, sample_rate=sample_rate, tags=tags, host=self.host
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/metrics/dogstatsd.py" startline="37" endline="46" pcid="4343">
    def gauge(self, key, value, instance=None, tags=None, sample_rate=1):
        if tags is None:
            tags = {}
        if self.tags:
            tags.update(self.tags)
        if instance:
            tags["instance"] = instance
        if tags:
            tags = [f"{k}:{v}" for k, v in tags.items()]
        statsd.gauge(self._get_key(key), value, sample_rate=sample_rate, tags=tags)
</source>
</class>

<class classid="68" nclones="2" nlines="28" similarity="75">
<source file="systems/sentry-22.2.0/src/sentry/interfaces/stacktrace.py" startline="132" endline="161" pcid="4504">
    def to_python(cls, data, **kwargs):
        for key in (
            "abs_path",
            "colno",
            "context_line",
            "data",
            "errors",
            "filename",
            "function",
            "raw_function",
            "image_addr",
            "in_app",
            "instruction_addr",
            "addr_mode",
            "lineno",
            "module",
            "package",
            "platform",
            "post_context",
            "pre_context",
            "symbol",
            "symbol_addr",
            "trust",
            "vars",
            "snapshot",
        ):
            data.setdefault(key, None)

        return super().to_python(data, **kwargs)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins_configs.py" startline="22" endline="51" pcid="8763">
    def test_no_configs(self):
        response = self.client.get(self.url)
        assert response.status_code == 200, (response.status_code, response.content)
        # test needs to be updated if plugins are removed
        expected_plugins = [
            "amazon-sqs",
            "asana",
            "bitbucket",
            "github",
            "gitlab",
            "heroku",
            "jira",
            "opsgenie",
            "pagerduty",
            "phabricator",
            "pivotal",
            "pushover",
            "redmine",
            "segment",
            "sessionstack",
            "slack",
            "splunk",
            "trello",
            "twilio",
            "victorops",
            "webhooks",
        ]
        for plugin in expected_plugins:
            assert filter(lambda x: x["slug"] == plugin, response.data)

</source>
</class>

<class classid="69" nclones="2" nlines="15" similarity="80">
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="112" endline="127" pcid="4596">
    def check_releases_have_health_data(
        self,
        organization_id: OrganizationId,
        project_ids: Sequence[ProjectId],
        release_versions: Sequence[ReleaseName],
        start: datetime,
        end: datetime,
    ) -> Set[ReleaseName]:
        return _check_releases_have_health_data(  # type: ignore
            organization_id,
            project_ids,
            release_versions,
            start,
            end,
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="199" endline="218" pcid="4603">
    def get_project_sessions_count(
        self,
        project_id: ProjectId,
        rollup: int,  # rollup in seconds
        start: datetime,
        end: datetime,
        environment_id: Optional[int] = None,
    ) -> int:
        """
        Returns the number of sessions in the specified period (optionally
        filtered by environment)
        """
        return _get_project_sessions_count(  # type: ignore
            project_id,
            rollup,
            start,
            end,
            environment_id,
        )

</source>
</class>

<class classid="70" nclones="2" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="167" endline="178" pcid="4601">
    def get_project_releases_count(
        self,
        organization_id: OrganizationId,
        project_ids: Sequence[ProjectId],
        scope: str,
        stats_period: Optional[str] = None,
        environments: Optional[Sequence[EnvironmentName]] = None,
    ) -> int:
        return _get_project_releases_count(  # type: ignore
            organization_id, project_ids, scope, stats_period, environments
        )

</source>
<source file="systems/sentry-22.2.0/src/sentry/release_health/sessions.py" startline="219" endline="234" pcid="4604">
    def get_num_sessions_per_project(
        self,
        project_ids: Sequence[ProjectId],
        start: datetime,
        end: datetime,
        environment_ids: Optional[Sequence[int]] = None,
        rollup: Optional[int] = None,  # rollup in seconds
    ) -> Sequence[ProjectWithCount]:
        """
        Returns the number of sessions for each project specified.
        Additionally
        """
        return _get_num_sessions_per_project(  # type: ignore
            project_ids, start, end, environment_ids, rollup
        )

</source>
</class>

<class classid="71" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry_plugins/anonymizeip.py" startline="87" endline="105" pcid="4703">
def __validate_ipv4_mask(mask_packed):
    # Test that mask only contains valid numbers
    for byte in iter(mask_packed):
        if byte != 0 and byte != 255:
            raise ValueError("ipv4_mask must only contain numbers 0 or 255")

    # Test that IP address does not get anonymized completely
    if mask_packed == b"\x00\x00\x00\x00":
        raise ValueError(
            'ipv4_mask cannot be set to "0.0.0.0" (all ' "anonymized addresses will be 0.0.0.0)"
        )

    # Test that IP address is changed by anonymization
    if mask_packed == b"\xff\xff\xff\xff":
        raise ValueError(
            'ipv4_mask cannot be set to "255.255.255.255" ' "(addresses will not be anonymized)"
        )


</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/anonymizeip.py" startline="106" endline="126" pcid="4704">
def __validate_ipv6_mask(mask_packed):
    # Test that mask only contains valid numbers
    for byte in iter(mask_packed):
        if byte != 0 and byte != 255:
            raise ValueError("ipv6_mask must only contain numbers 0 or ffff")

    # Test that IP address does not get anonymized completely
    if mask_packed == b"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00":
        raise ValueError(
            "ipv6_mask cannot be set to "
            '"0000:0000:0000:0000:0000:0000:0000:0000" (all '
            "anonymized addresses will be 0.0.0.0)"
        )

    # Test that IP address is changed by anonymization
    if mask_packed == b"\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff":
        raise ValueError(
            "ipv6_mask cannot be set to "
            '"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff" '
            "(addresses will not be anonymized)"
        )
</source>
</class>

<class classid="72" nclones="3" nlines="20" similarity="77">
<source file="systems/sentry-22.2.0/src/sentry_plugins/pivotal/plugin.py" startline="62" endline="81" pcid="4734">
    def get_link_existing_issue_fields(self, request: Request, group, event, **kwargs):
        return [
            {
                "name": "issue_id",
                "label": "Story",
                "default": "",
                "type": "select",
                "has_autocomplete": True,
                "help": "Search Pivotal Stories by name or description.",
            },
            {
                "name": "comment",
                "label": "Comment",
                "default": group.get_absolute_url(params={"referrer": "pivotal_plugin"}),
                "type": "textarea",
                "help": ("Leave blank if you don't want to " "add a comment to the Pivotal story."),
                "required": False,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/phabricator/plugin.py" startline="122" endline="145" pcid="4831">
    def get_link_existing_issue_fields(self, request: Request, group, event, **kwargs):
        return [
            {
                "name": "issue_id",
                "label": "Task",
                "default": "",
                "type": "select",
                "has_autocomplete": True,
            },
            {
                "name": "comment",
                "label": "Comment",
                "default": "Sentry issue: [{issue_id}]({url})".format(
                    url=absolute_uri(
                        group.get_absolute_url(params={"referrer": "phabricator_plugin"})
                    ),
                    issue_id=group.qualified_short_id,
                ),
                "type": "textarea",
                "help": ("Leave blank if you don't want to " "add a comment to the task."),
                "required": False,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/trello/plugin.py" startline="172" endline="195" pcid="4848">
    def get_link_existing_issue_fields(self, request: Request, group, event, **kwargs):
        """
        Return the fields needed for linking to an existing issue
        """
        return [
            {
                "name": "issue_id",
                "label": "Card",
                "type": "select",
                "has_autocomplete": True,
                "required": True,
            },
            {
                "name": "comment",
                "label": "Comment",
                "default": absolute_uri(
                    group.get_absolute_url(params={"referrer": "trello_plugin"})
                ),
                "type": "textarea",
                "help": ("Leave blank if you don't want to " "add a comment to the Trello card."),
                "required": False,
            },
        ]

</source>
</class>

<class classid="73" nclones="2" nlines="23" similarity="79">
<source file="systems/sentry-22.2.0/src/sentry_plugins/phabricator/plugin.py" startline="99" endline="121" pcid="4830">
    def get_new_issue_fields(self, request: Request, group, event, **kwargs):
        fields = super().get_new_issue_fields(request, group, event, **kwargs)
        return fields + [
            {
                "name": "tags",
                "label": "Tags",
                "type": "select",
                "placeholder": "Start typing to search for a project",
                "multi": True,
                "required": False,
                "has_autocomplete": True,
            },
            {
                "name": "assignee",
                "label": "Assignee",
                "default": "",
                "type": "select",
                "placeholder": "Start typing to search for an assignee",
                "required": False,
                "has_autocomplete": True,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/src/sentry_plugins/trello/plugin.py" startline="142" endline="171" pcid="4847">
    def get_new_issue_fields(self, request: Request, group, event, **kwargs):
        """
        Return the fields needed for creating a new issue
        """
        fields = super().get_new_issue_fields(request, group, event, **kwargs)
        client = self.get_client(group.project)
        organization = self.get_option("organization", group.project)

        boards = client.get_boards(organization)
        board_choices = self.map_to_options(boards)

        return fields + [
            {
                "name": "board",
                "label": "Board",
                "type": "select",
                "choices": board_choices,
                "readonly": False,
                "required": True,
            },
            {
                "name": "list",
                "depends": ["board"],
                "label": "List",
                "type": "select",
                "has_autocomplete": False,
                "required": True,
            },
        ]

</source>
</class>

<class classid="74" nclones="3" nlines="10" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_utils.py" startline="24" endline="34" pcid="5073">
    def test_field_aliasing_in_selected_columns(self):
        result = transform_aliases_and_query(
            selected_columns=["project.id", "user.email", "release"],
            filter_keys={"project_id": [self.project.id]},
        )
        data = result["data"]
        assert len(data) == 1
        assert data[0]["project.id"] == self.project.id
        assert data[0]["user.email"] == "bruce@example.com"
        assert data[0]["release"] == "first-release"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_utils.py" startline="47" endline="57" pcid="5075">
    def test_field_aliasing_in_conditions(self):
        result = transform_aliases_and_query(
            selected_columns=["project.id", "user.email"],
            conditions=[["user.email", "=", "bruce@example.com"]],
            filter_keys={"project_id": [self.project.id]},
        )
        data = result["data"]
        assert len(data) == 1
        assert data[0]["project.id"] == self.project.id
        assert data[0]["user.email"] == "bruce@example.com"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_utils.py" startline="35" endline="46" pcid="5074">
    def test_field_aliasing_in_aggregate_functions_and_groupby(self):
        result = transform_aliases_and_query(
            selected_columns=["project.id"],
            aggregations=[["uniq", "user.email", "uniq_email"]],
            filter_keys={"project_id": [self.project.id]},
            groupby=["project.id"],
        )
        data = result["data"]
        assert len(data) == 1
        assert data[0]["project.id"] == self.project.id
        assert data[0]["uniq_email"] == 1

</source>
</class>

<class classid="75" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_utils.py" startline="76" endline="91" pcid="5077">
    def test_conversion_of_release_filter_key(self):
        result = transform_aliases_and_query(
            selected_columns=["id", "message"],
            filter_keys={
                "release": [self.create_release(self.project).id],
                "project_id": [self.project.id],
            },
        )
        assert len(result["data"]) == 0

        result = transform_aliases_and_query(
            selected_columns=["id", "message"],
            filter_keys={"release": [self.release.id], "project_id": [self.project.id]},
        )
        assert len(result["data"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_utils.py" startline="92" endline="106" pcid="5078">
    def test_conversion_of_environment_filter_key(self):
        result = transform_aliases_and_query(
            selected_columns=["id", "message"],
            filter_keys={
                "environment": [self.create_environment(self.project).id],
                "project_id": [self.project.id],
            },
        )
        assert len(result["data"]) == 0

        result = transform_aliases_and_query(
            selected_columns=["id", "message"],
            filter_keys={"environment": [self.environment.id], "project_id": [self.project.id]},
        )
        assert len(result["data"]) == 1
</source>
</class>

<class classid="76" nclones="2" nlines="13" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="82" endline="99" pcid="5081">
def test_mixed_arithmetic():
    result, _, _ = parse_arithmetic("12 + 34 * 56")
    assert result.operator == "plus"
    assert result.lhs == 12.0
    assert isinstance(result.rhs, Operation)
    assert result.rhs.operator == "multiply"
    assert result.rhs.lhs == 34.0
    assert result.rhs.rhs == 56.0

    result, _, _ = parse_arithmetic("12 / 34 - 56")
    assert result.operator == "minus"
    assert isinstance(result.lhs, Operation)
    assert result.lhs.operator == "divide"
    assert result.lhs.lhs == 12.0
    assert result.lhs.rhs == 34.0
    assert result.rhs == 56.0


</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="113" endline="125" pcid="5083">
def test_brackets_with_two_inner_terms():
    result, _, _ = parse_arithmetic("(1 + 2) / (3 - 4)")
    assert result.operator == "divide"
    assert isinstance(result.lhs, Operation)
    assert result.lhs.operator == "plus"
    assert result.lhs.lhs == 1.0
    assert result.lhs.rhs == 2.0
    assert isinstance(result.rhs, Operation)
    assert result.rhs.operator == "minus"
    assert result.rhs.lhs == 3.0
    assert result.rhs.rhs == 4.0


</source>
</class>

<class classid="77" nclones="3" nlines="11" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="100" endline="112" pcid="5082">
def test_four_terms():
    result, _, _ = parse_arithmetic("1 + 2 / 3 * 4")
    assert result.operator == "plus"
    assert result.lhs == 1.0
    assert isinstance(result.rhs, Operation)
    assert result.rhs.operator == "multiply"
    assert isinstance(result.rhs.lhs, Operation)
    assert result.rhs.lhs.operator == "divide"
    assert result.rhs.lhs.lhs == 2.0
    assert result.rhs.lhs.rhs == 3.0
    assert result.rhs.rhs == 4.0


</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="126" endline="137" pcid="5084">
def test_brackets_with_three_inner_terms():
    result, _, _ = parse_arithmetic("(1 + 2 + 3) / 4")
    assert result.operator == "divide"
    assert isinstance(result.lhs, Operation)
    assert result.lhs.operator == "plus"
    assert isinstance(result.lhs.lhs, Operation)
    assert result.lhs.lhs.lhs == 1.0
    assert result.lhs.lhs.rhs == 2.0
    assert result.lhs.rhs == 3.0
    assert result.rhs == 4.0


</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="138" endline="150" pcid="5085">
def test_brackets_with_four_inner_terms():
    result, _, _ = parse_arithmetic("(1 + 2 / 3 * 4)")
    assert result.operator == "plus"
    assert result.lhs == 1.0
    assert isinstance(result.rhs, Operation)
    assert result.rhs.operator == "multiply"
    assert isinstance(result.rhs.lhs, Operation)
    assert result.rhs.lhs.operator == "divide"
    assert result.rhs.lhs.lhs == 2.0
    assert result.rhs.lhs.rhs == 3.0
    assert result.rhs.rhs == 4.0


</source>
</class>

<class classid="78" nclones="2" nlines="20" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="201" endline="221" pcid="5088">
def test_field_values(a, op, b):
    for with_brackets in [False, True]:
        equation = f"{a}{op}{b}"
        if with_brackets:
            equation = f"({equation}) + 5"
        result, fields, functions = parse_arithmetic(equation)
        if with_brackets:
            assert result.operator == "plus"
            assert isinstance(result.lhs, Operation)
            assert result.rhs == 5.0
            result = result.lhs
        assert result.operator == op_map[op.strip()], equation
        assert result.lhs == a, equation
        assert result.rhs == b, equation
        assert len(functions) == 0
        if isinstance(a, str):
            assert a in fields, equation
        if isinstance(b, str):
            assert b in fields, equation


</source>
<source file="systems/sentry-22.2.0/tests/sentry/discover/test_arithmetic.py" startline="234" endline="256" pcid="5089">
def test_function_values(a, op, b):
    for with_brackets in [False, True]:
        equation = f"{a}{op}{b}"
        if with_brackets:
            equation = f"({equation}) + 5"
        result, fields, functions = parse_arithmetic(equation)
        if with_brackets:
            assert result.operator == "plus"
            assert isinstance(result.lhs, Operation)
            assert result.rhs == 5.0
            result = result.lhs
        assert result.operator == op_map[op.strip()], equation
        lhs = a if isinstance(a, int) else get_function_alias(a)
        rhs = b if isinstance(b, int) else get_function_alias(b)
        assert result.lhs == lhs, equation
        assert result.rhs == rhs, equation
        assert len(fields) == 0
        if isinstance(a, str):
            assert a in functions, equation
        if isinstance(b, str):
            assert b in functions, equation


</source>
</class>

<class classid="79" nclones="2" nlines="11" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_idpmigration.py" startline="22" endline="36" pcid="5152">
    def test_send_one_time_account_confirm_link(self):
        om = OrganizationMember.objects.create(organization=self.org, user=self.user)
        link = idpmigration.send_one_time_account_confirm_link(
            self.user, self.org, self.provider, self.email, self.IDENTITY_ID
        )
        assert re.match(r"auth:one-time-key:\w{32}", link.verification_key)

        value = json.loads(idpmigration.get_redis_cluster().get(link.verification_key))
        assert value["user_id"] == self.user.id
        assert value["email"] == self.email
        assert value["member_id"] == om.id
        assert value["organization_id"] == self.org.id
        assert value["identity_id"] == self.IDENTITY_ID
        assert value["provider"] == "dummy"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_idpmigration.py" startline="37" endline="49" pcid="5153">
    def test_send_without_org_membership(self):
        link = idpmigration.send_one_time_account_confirm_link(
            self.user, self.org, self.provider, self.email, self.IDENTITY_ID
        )

        value = json.loads(idpmigration.get_redis_cluster().get(link.verification_key))
        assert value["user_id"] == self.user.id
        assert value["email"] == self.email
        assert value["member_id"] is None
        assert value["organization_id"] == self.org.id
        assert value["identity_id"] == self.IDENTITY_ID
        assert value["provider"] == "dummy"

</source>
</class>

<class classid="80" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_idpmigration.py" startline="50" endline="63" pcid="5154">
    def test_verify_account(self):
        link = idpmigration.send_one_time_account_confirm_link(
            self.user, self.org, self.provider, self.email, self.IDENTITY_ID
        )
        path = reverse(
            "sentry-idp-email-verification",
            args=[link.verification_code],
        )
        response = self.client.get(path)

        assert self.client.session[idpmigration.SSO_VERIFICATION_KEY] == link.verification_code
        assert response.status_code == 200
        assert response.templates[0].name == "sentry/idp_account_verified.html"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_idpmigration.py" startline="64" endline="74" pcid="5155">
    def test_verify_account_wrong_key(self):
        idpmigration.send_one_time_account_confirm_link(
            self.user, self.org, self.provider, self.email, self.IDENTITY_ID
        )
        path = reverse(
            "sentry-idp-email-verification",
            args=["d14Ja9N2eQfPfVzcydS6vzcxWecZJG2z2"],
        )
        response = self.client.get(path)
        assert response.status_code == 200
        assert response.templates[0].name == "sentry/idp_account_not_verified.html"
</source>
</class>

<class classid="81" nclones="2" nlines="15" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_helper.py" startline="160" endline="180" pcid="5166">
    def test_simple(self, mock_auth):
        mock_auth.get_login_redirect.return_value = "test_login_url"
        user, auth_identity = self.set_up_user_identity()

        redirect = self.handler.handle_existing_identity(self.state, auth_identity)

        assert redirect.url == mock_auth.get_login_redirect.return_value
        assert mock_auth.get_login_redirect.called_with(self.request)

        persisted_identity = AuthIdentity.objects.get(ident=auth_identity.ident)
        assert persisted_identity.data == self.identity["data"]

        persisted_om = OrganizationMember.objects.get(user=user, organization=self.organization)
        assert getattr(persisted_om.flags, "sso:linked")
        assert not getattr(persisted_om.flags, "member-limit:restricted")
        assert not getattr(persisted_om.flags, "sso:invalid")

        login_request, login_user = mock_auth.login.call_args.args
        assert login_request == self.request
        assert login_user == user

</source>
<source file="systems/sentry-22.2.0/tests/sentry/auth/test_helper.py" startline="182" endline="201" pcid="5167">
    def test_no_invite_members_flag(self, mock_auth):
        with mock.patch("sentry.features.has", return_value=False) as features_has:
            mock_auth.get_login_redirect.return_value = "test_login_url"
            user, auth_identity = self.set_up_user_identity()

            redirect = self.handler.handle_existing_identity(self.state, auth_identity)

            assert redirect.url == mock_auth.get_login_redirect.return_value
            assert mock_auth.get_login_redirect.called_with(self.request)

            persisted_identity = AuthIdentity.objects.get(ident=auth_identity.ident)
            assert persisted_identity.data == self.identity["data"]

            persisted_om = OrganizationMember.objects.get(user=user, organization=self.organization)
            assert getattr(persisted_om.flags, "sso:linked")
            assert getattr(persisted_om.flags, "member-limit:restricted")
            assert not getattr(persisted_om.flags, "sso:invalid")
            features_has.assert_called_once_with("organizations:invite-members", self.organization)


</source>
</class>

<class classid="82" nclones="2" nlines="13" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry/auth/providers/test_saml2.py" startline="56" endline="71" pcid="5204">
    def test_build_identity(self):
        self.provider.config = dummy_provider_config
        attrs = {
            "id": ["123"],
            "email": ["valid@example.com"],
            "first": ["Morty"],
            "last": ["Smith"],
        }

        state = {"auth_attributes": attrs}
        identity = self.provider.build_identity(state)

        assert identity["id"] == "123"
        assert identity["email"] == "valid@example.com"
        assert identity["name"] == "Morty Smith"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/auth/providers/test_saml2.py" startline="72" endline="86" pcid="5205">
    def test_build_identity_empty_lastname(self):
        self.provider.config = dummy_provider_config
        attrs = {
            "id": ["123"],
            "email": ["valid@example.com"],
            "first": ["Morty"],
            "last": [],
        }

        state = {"auth_attributes": attrs}
        identity = self.provider.build_identity(state)

        assert identity["id"] == "123"
        assert identity["email"] == "valid@example.com"
        assert identity["name"] == "Morty"
</source>
</class>

<class classid="83" nclones="3" nlines="35" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_alert_rule_action_requester.py" startline="38" endline="80" pcid="5219">
    def test_makes_successful_request(self):

        responses.add(
            method=responses.POST,
            url="https://example.com/sentry/alert-rule",
            status=200,
            json="Saved information",
        )

        result = AlertRuleActionRequester.run(
            install=self.install,
            uri="/sentry/alert-rule",
            fields=self.fields,
        )
        assert result["success"]
        assert result["message"] == 'foo: "Saved information"'
        request = responses.calls[0].request

        data = {
            "fields": [
                {"name": "title", "value": "An Alert"},
                {"name": "description", "value": "threshold reached"},
                {
                    "name": "assignee_id",
                    "value": "user-1",
                },
            ],
            "installationId": self.install.uuid,
        }
        payload = json.loads(request.body)
        assert payload == data

        assert request.headers["Sentry-App-Signature"] == self.sentry_app.build_signature(
            json.dumps(payload)
        )

        buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)
        requests = buffer.get_requests()

        assert len(requests) == 1
        assert requests[0]["response_code"] == 200
        assert requests[0]["event_type"] == "alert_rule_action.requested"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_alert_rule_action_requester.py" startline="126" endline="166" pcid="5221">
    def test_makes_failed_request_returning_only_status(self):

        responses.add(
            method=responses.POST,
            url="https://example.com/sentry/alert-rule",
            status=401,
        )

        result = AlertRuleActionRequester.run(
            install=self.install,
            uri="/sentry/alert-rule",
            fields=self.fields,
        )
        assert not result["success"]
        assert result["message"] == "foo: Something went wrong!"
        request = responses.calls[0].request

        data = {
            "fields": [
                {"name": "title", "value": "An Alert"},
                {"name": "description", "value": "threshold reached"},
                {
                    "name": "assignee_id",
                    "value": "user-1",
                },
            ],
            "installationId": self.install.uuid,
        }
        payload = json.loads(request.body)
        assert payload == data

        assert request.headers["Sentry-App-Signature"] == self.sentry_app.build_signature(
            json.dumps(payload)
        )

        buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)
        requests = buffer.get_requests()

        assert len(requests) == 1
        assert requests[0]["response_code"] == 401
        assert requests[0]["event_type"] == "alert_rule_action.requested"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_alert_rule_action_requester.py" startline="82" endline="124" pcid="5220">
    def test_makes_failed_request(self):

        responses.add(
            method=responses.POST,
            url="https://example.com/sentry/alert-rule",
            status=401,
            json="Channel not found!",
        )

        result = AlertRuleActionRequester.run(
            install=self.install,
            uri="/sentry/alert-rule",
            fields=self.fields,
        )
        assert not result["success"]
        assert result["message"] == 'foo: "Channel not found!"'
        request = responses.calls[0].request

        data = {
            "fields": [
                {"name": "title", "value": "An Alert"},
                {"name": "description", "value": "threshold reached"},
                {
                    "name": "assignee_id",
                    "value": "user-1",
                },
            ],
            "installationId": self.install.uuid,
        }
        payload = json.loads(request.body)
        assert payload == data

        assert request.headers["Sentry-App-Signature"] == self.sentry_app.build_signature(
            json.dumps(payload)
        )

        buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)
        requests = buffer.get_requests()

        assert len(requests) == 1
        assert requests[0]["response_code"] == 401
        assert requests[0]["event_type"] == "alert_rule_action.requested"

</source>
</class>

<class classid="84" nclones="3" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_issue_link_requester.py" startline="11" endline="26" pcid="5222">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_issues/test_issue_link_creator.py" startline="10" endline="25" pcid="5264">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_issues/test_creator.py" startline="7" endline="22" pcid="5262">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
</class>

<class classid="85" nclones="4" nlines="20" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_issue_link_requester.py" startline="80" endline="103" pcid="5224">
    def test_invalid_response_format(self):
        # missing 'identifier'
        invalid_format = {
            "project": "ProjectName",
            "webUrl": "https://example.com/project/issue-id",
        }
        responses.add(
            method=responses.POST,
            url="https://example.com/link-issue",
            json=invalid_format,
            status=200,
            content_type="application/json",
        )
        with self.assertRaises(APIError):
            IssueLinkRequester.run(
                install=self.install,
                project=self.project,
                group=self.group,
                uri="/link-issue",
                fields={},
                user=self.user,
                action="create",
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_select_requester.py" startline="56" endline="75" pcid="5228">
    def test_invalid_response_format(self):
        # missing 'label'
        invalid_format = {"value": "12345"}
        responses.add(
            method=responses.GET,
            url=f"https://example.com/get-issues?installationId={self.install.uuid}&projectSlug={self.project.slug}",
            json=invalid_format,
            status=200,
            content_type="application/json",
        )

        with self.assertRaises(APIError):
            SelectRequester.run(
                install=self.install,
                project=self.project,
                group=self.group,
                uri="/get-issues",
                fields={},
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_issue_link_requester.py" startline="105" endline="128" pcid="5225">
    def test_500_response(self):
        responses.add(
            method=responses.POST,
            url="https://example.com/link-issue",
            body="Something failed",
            status=500,
        )

        with self.assertRaises(APIError):
            IssueLinkRequester.run(
                install=self.install,
                project=self.project,
                group=self.group,
                uri="/link-issue",
                fields={},
                user=self.user,
                action="create",
            )

        buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)
        requests = buffer.get_requests()
        assert len(requests) == 1
        assert requests[0]["response_code"] == 500
        assert requests[0]["event_type"] == "external_issue.created"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_select_requester.py" startline="77" endline="99" pcid="5229">
    def test_500_response(self):
        responses.add(
            method=responses.GET,
            url=f"https://example.com/get-issues?installationId={self.install.uuid}&projectSlug={self.project.slug}",
            body="Something failed",
            status=500,
        )

        with self.assertRaises(APIError):
            SelectRequester.run(
                install=self.install,
                project=self.project,
                group=self.group,
                uri="/get-issues",
                fields={},
            )

        buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)
        requests = buffer.get_requests()

        assert len(requests) == 1
        assert requests[0]["response_code"] == 500
        assert requests[0]["event_type"] == "select_options.requested"
</source>
</class>

<class classid="86" nclones="2" nlines="26" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py" startline="46" endline="76" pcid="5234">
    def test_task_enqueued(self, safe_urlopen):
        InstallationNotifier.run(install=self.install, user=self.user, action="created")

        data = faux(safe_urlopen).kwargs["data"]

        assert json.loads(data) == {
            "action": "created",
            "installation": {"uuid": self.install.uuid},
            "data": {
                "installation": {
                    "app": {"uuid": self.sentry_app.uuid, "slug": self.sentry_app.slug},
                    "organization": {"slug": self.org.slug},
                    "uuid": self.install.uuid,
                    "code": self.install.api_grant.code,
                    "status": "installed",
                }
            },
            "actor": {"id": self.user.id, "name": self.user.name, "type": "user"},
        }

        assert faux(safe_urlopen).kwarg_equals(
            "headers",
            DictContaining(
                "Content-Type",
                "Request-ID",
                "Sentry-Hook-Resource",
                "Sentry-Hook-Timestamp",
                "Sentry-Hook-Signature",
            ),
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py" startline="78" endline="108" pcid="5235">
    def test_uninstallation_enqueued(self, safe_urlopen):
        InstallationNotifier.run(install=self.install, user=self.user, action="deleted")

        data = faux(safe_urlopen).kwargs["data"]

        assert json.loads(data) == {
            "action": "deleted",
            "installation": {"uuid": self.install.uuid},
            "data": {
                "installation": {
                    "app": {"uuid": self.sentry_app.uuid, "slug": self.sentry_app.slug},
                    "organization": {"slug": self.org.slug},
                    "uuid": self.install.uuid,
                    "code": self.install.api_grant.code,
                    "status": "installed",
                }
            },
            "actor": {"id": self.user.id, "name": self.user.name, "type": "user"},
        }

        assert faux(safe_urlopen).kwarg_equals(
            "headers",
            DictContaining(
                "Content-Type",
                "Request-ID",
                "Sentry-Hook-Resource",
                "Sentry-Hook-Timestamp",
                "Sentry-Hook-Signature",
            ),
        )

</source>
</class>

<class classid="87" nclones="2" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_creator.py" startline="18" endline="33" pcid="5238">
    def setUp(self):
        self.user = self.create_user()
        self.org = self.create_organization()

        self.project1 = self.create_project(organization=self.org)
        self.project2 = self.create_project(organization=self.org)

        responses.add(responses.POST, "https://example.com/webhook")

        self.sentry_app = self.create_sentry_app(
            name="nulldb",
            organization=self.org,
            scopes=("project:read",),
            events=("issue.created",),
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_destroyer.py" startline="23" endline="40" pcid="5249">
    def setUp(self):
        self.user = self.create_user()
        self.org = self.create_organization()
        self.project = self.create_project(organization=self.org)

        responses.add(responses.POST, "https://example.com/webhook")

        self.sentry_app = self.create_sentry_app(
            name="nulldb",
            organization=self.org,
            scopes=("project:read", "event:read"),
            events=("issue",),
        )

        self.install = Creator.run(organization=self.org, slug="nulldb", user=self.user)

        self.destroyer = Destroyer(install=self.install, user=self.user)

</source>
</class>

<class classid="88" nclones="4" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_creator.py" startline="102" endline="115" pcid="5248">
    def test_records_analytics(self, record):
        Creator.run(
            organization=self.org,
            slug="nulldb",
            user=self.user,
            request=self.make_request(user=self.user, method="GET"),
        )

        record.assert_called_with(
            "sentry_app.installed",
            user_id=self.user.id,
            organization_id=self.org.id,
            sentry_app="nulldb",
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/token_exchange/test_refresher.py" startline="73" endline="85" pcid="5308">
    def test_records_analytics(self, record):
        Refresher.run(
            install=self.install,
            client_id=self.client_id,
            refresh_token=self.token.refresh_token,
            user=self.user,
        )

        record.assert_called_with(
            "sentry_app.token_exchanged",
            sentry_app_installation_id=self.install.id,
            exchange_type="refresh",
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_destroyer.py" startline="173" endline="187" pcid="5261">
    def test_records_analytics(self, record):
        responses.add(responses.POST, "https://example.com/webhook")

        Destroyer.run(
            install=self.install,
            user=self.user,
            request=self.make_request(user=self.user, method="GET"),
        )

        record.assert_called_with(
            "sentry_app.uninstalled",
            user_id=self.user.id,
            organization_id=self.org.id,
            sentry_app=self.install.sentry_app.slug,
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_apps/test_destroyer.py" startline="85" endline="97" pcid="5373">
    def test_records_analytics(self, record):
        Destroyer.run(
            user=self.user,
            sentry_app=self.sentry_app,
            request=self.make_request(user=self.user, method="GET"),
        )

        record.assert_called_with(
            "sentry_app.deleted",
            user_id=self.user.id,
            organization_id=self.org.id,
            sentry_app=self.sentry_app.slug,
        )
</source>
</class>

<class classid="89" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_app_installations/test_destroyer.py" startline="121" endline="139" pcid="5258">
    def test_soft_deletes_installation(self):
        responses.add(responses.POST, "https://example.com/webhook")
        self.destroyer.call()

        with self.assertRaises(SentryAppInstallation.DoesNotExist):
            SentryAppInstallation.objects.get(pk=self.install.id)

        # The QuerySet will automatically NOT include deleted installs, so we
        # use a raw sql query to ensure it still exists.
        c = connection.cursor()
        c.execute(
            "SELECT COUNT(1) "
            "FROM sentry_sentryappinstallation "
            "WHERE id = %s AND date_deleted IS NOT NULL",
            [self.install.id],
        )

        assert c.fetchone()[0] == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_apps/test_destroyer.py" startline="66" endline="83" pcid="5372">
    def test_soft_deletes_sentry_app(self):
        self.destroyer.call()

        with self.assertRaises(SentryApp.DoesNotExist):
            SentryApp.objects.get(pk=self.sentry_app.id)

        # The QuerySet will automatically NOT include deleted installs, so we
        # use a raw sql query to ensure it still exists.
        c = connection.cursor()
        c.execute(
            "SELECT count(1) "
            "FROM sentry_sentryapp "
            "WHERE id = %s AND date_deleted IS NOT NULL",
            [self.sentry_app.id],
        )

        assert c.fetchone()[0] == 1

</source>
</class>

<class classid="90" nclones="2" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_issues/test_issue_link_creator.py" startline="58" endline="67" pcid="5266">
    def test_invalid_action(self):
        with self.assertRaises(APIUnauthorized):
            IssueLinkCreator.run(
                install=self.install,
                group=self.group,
                action="doop",
                uri="/link-issue",
                fields={},
                user=self.user,
            )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/commands/test_link_team.py" startline="20" endline="31" pcid="10603">
    def setUp(self):
        super().setUp()
        self.link_user()
        responses.add(
            method=responses.POST,
            url="https://slack.com/api/chat.postMessage",
            body='{"ok": true}',
            status=status.HTTP_200_OK,
            content_type="application/json",
        )


</source>
</class>

<class classid="91" nclones="2" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_apps/test_creator.py" startline="20" endline="33" pcid="5348">
    def setUp(self):
        self.user = self.create_user(email="foo@bar.com", username="scuba_steve")
        self.org = self.create_organization(owner=self.user)
        self.creator = Creator(
            name="nulldb",
            user=self.user,
            author="Sentry",
            organization=self.org,
            scopes=("project:read",),
            webhook_url="http://example.com",
            schema={"elements": [self.create_issue_link_schema()]},
            is_internal=False,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/sentry_apps/test_creator.py" startline="117" endline="131" pcid="5360">
    def test_creates_audit_log_entry(self):
        request = self.make_request(user=self.user, method="GET")
        Creator.run(
            name="nulldb",
            user=self.user,
            author="Sentry",
            organization=self.org,
            scopes=("project:read",),
            webhook_url="http://example.com",
            schema={"elements": [self.create_issue_link_schema()]},
            request=request,
            is_internal=False,
        )
        assert AuditLogEntry.objects.filter(event=AuditLogEntryEvent.SENTRY_APP_ADD).exists()

</source>
</class>

<class classid="92" nclones="2" nlines="14" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/project_rules/test_updater.py" startline="52" endline="66" pcid="5398">
    def test_update_actions(self):
        self.updater.actions = [
            {
                "id": "sentry.rules.actions.notify_event.NotifyEventAction",
                "name": "Send a notification (for all legacy integrations)",
            }
        ]
        self.updater.call()
        assert self.rule.data["actions"] == [
            {
                "id": "sentry.rules.actions.notify_event.NotifyEventAction",
                "name": "Send a notification (for all legacy integrations)",
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/project_rules/test_updater.py" startline="77" endline="95" pcid="5401">
    def test_update_conditions(self):
        self.updater.conditions = [
            {
                "id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition",
                "key": "foo",
                "match": "eq",
                "value": "bar",
            }
        ]
        self.updater.call()
        assert self.rule.data["conditions"] == [
            {
                "id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition",
                "key": "foo",
                "match": "eq",
                "value": "bar",
            }
        ]

</source>
</class>

<class classid="93" nclones="5" nlines="17" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/eventstream/kafka/test_postprocessworker.py" startline="69" endline="92" pcid="5424">
def test_post_process_forwarder(
    dispatch_post_process_group_task, kafka_message_without_transaction_header
):
    """
    Tests that the post process forwarder calls dispatch_post_process_group_task with the correct arguments
    """
    forwarder = PostProcessForwarderWorker(concurrency=1)
    future = forwarder.process_message(kafka_message_without_transaction_header)

    forwarder.flush_batch([future])

    dispatch_post_process_group_task.assert_called_once_with(
        event_id="fe0ee9a2bc3b415497bad68aaf70dc7f",
        project_id=1,
        group_id=43,
        primary_hash="311ee66a5b8e697929804ceb1c456ffe",
        is_new=False,
        is_regression=None,
        is_new_group_environment=False,
    )

    forwarder.shutdown()


</source>
<source file="systems/sentry-22.2.0/tests/sentry/eventstream/kafka/test_postprocessworker.py" startline="165" endline="190" pcid="5428">
def test_errors_post_process_forwarder_missing_headers(
    dispatch_post_process_group_task, kafka_message_without_transaction_header
):
    """
    Tests that the errors post process forwarder calls dispatch_post_process_group_task
    when the header "transaction_forwarder" is missing.
    """
    forwarder = ErrorsPostProcessForwarderWorker(concurrency=1)
    future = forwarder.process_message(kafka_message_without_transaction_header)
    assert future is not None

    forwarder.flush_batch([future])

    dispatch_post_process_group_task.assert_called_once_with(
        event_id="fe0ee9a2bc3b415497bad68aaf70dc7f",
        project_id=1,
        group_id=43,
        primary_hash="311ee66a5b8e697929804ceb1c456ffe",
        is_new=False,
        is_regression=None,
        is_new_group_environment=False,
    )

    forwarder.shutdown()


</source>
<source file="systems/sentry-22.2.0/tests/sentry/eventstream/kafka/test_postprocessworker.py" startline="95" endline="125" pcid="5425">
def test_post_process_forwarder_bad_message_headers(
    dispatch_post_process_group_task, kafka_message_payload
):
    """
    Tests that when bad message headers are received, post process forwarder still works if the payload is valid.
    """
    forwarder = PostProcessForwarderWorker(concurrency=1)

    mock_message = Mock()
    mock_message.headers = MagicMock(return_value="this does not work")
    mock_message.value = MagicMock(return_value=json.dumps(kafka_message_payload))
    mock_message.partition = MagicMock("1")

    options.set("post-process-forwarder:kafka-headers", True)
    future = forwarder.process_message(mock_message)

    forwarder.flush_batch([future])

    dispatch_post_process_group_task.assert_called_once_with(
        event_id="fe0ee9a2bc3b415497bad68aaf70dc7f",
        project_id=1,
        group_id=43,
        primary_hash="311ee66a5b8e697929804ceb1c456ffe",
        is_new=False,
        is_regression=None,
        is_new_group_environment=False,
    )

    forwarder.shutdown()


</source>
<source file="systems/sentry-22.2.0/tests/sentry/eventstream/kafka/test_postprocessworker.py" startline="265" endline="288" pcid="5433">
def test_transactions_post_process_forwarder_true_headers(
    dispatch_post_process_group_task, kafka_message_with_transaction_header_true
):
    """
    Tests that the transactions post process forwarder calls dispatch_post_process_group_task
    when the header "transaction_forwarder" is set to True.
    """
    forwarder = TransactionsPostProcessForwarderWorker(concurrency=1)
    future = forwarder.process_message(kafka_message_with_transaction_header_true)

    assert future is not None
    forwarder.flush_batch([future])

    dispatch_post_process_group_task.assert_called_with(
        event_id="fe0ee9a2bc3b415497bad68aaf70dc7f",
        project_id=1,
        group_id=43,
        primary_hash="311ee66a5b8e697929804ceb1c456ffe",
        is_new=False,
        is_regression=None,
        is_new_group_environment=False,
    )

    forwarder.shutdown()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/eventstream/kafka/test_postprocessworker.py" startline="193" endline="218" pcid="5429">
def test_errors_post_process_forwarder_false_headers(
    dispatch_post_process_group_task, kafka_message_with_transaction_header_false
):
    """
    Test that the errors post process forwarder calls dispatch_post_process_group_task
    when the header "transaction_forwarder" is set to False.
    """
    forwarder = ErrorsPostProcessForwarderWorker(concurrency=1)
    future = forwarder.process_message(kafka_message_with_transaction_header_false)
    assert future is not None

    forwarder.flush_batch([future])

    dispatch_post_process_group_task.assert_called_once_with(
        event_id="fe0ee9a2bc3b415497bad68aaf70dc7f",
        project_id=1,
        group_id=43,
        primary_hash="311ee66a5b8e697929804ceb1c456ffe",
        is_new=False,
        is_regression=None,
        is_new_group_environment=False,
    )

    forwarder.shutdown()


</source>
</class>

<class classid="94" nclones="2" nlines="21" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/ownership/test_grammar.py" startline="571" endline="591" pcid="5460">
def test_convert_codeowners_syntax():
    code_mapping = type("", (), {})()
    code_mapping.stack_root = "webpack://docs"
    code_mapping.source_root = "docs"
    assert (
        convert_codeowners_syntax(
            codeowners_fixture_data,
            {
                "@getsentry/frontend": "front-sentry",
                "@getsentry/docs": "docs-sentry",
                "@getsentry/ecosystem": "ecosystem",
                "@NisanthanNanthakumar": "nisanthan.nanthakumar@sentry.io",
                "@AnotherUser": "anotheruser@sentry.io",
                "nisanthan.nanthakumar@sentry.io": "nisanthan.nanthakumar@sentry.io",
            },
            code_mapping,
        )
        == "\n# cool stuff comment\ncodeowners:*.js front-sentry nisanthan.nanthakumar@sentry.io\n# good comment\n\n\ncodeowners:webpack://docs/* docs-sentry ecosystem\ncodeowners:src/sentry/* anotheruser@sentry.io\ncodeowners:api/* nisanthan.nanthakumar@sentry.io\n"
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/ownership/test_grammar.py" startline="592" endline="653" pcid="5461">
def test_convert_codeowners_syntax_excludes_invalid():
    code_mapping = type("", (), {})()
    code_mapping.stack_root = "webpack://static/"
    code_mapping.source_root = ""
    codeowners = (
        codeowners_fixture_data
        + r"""
# some invalid rules
debug[0-9].log                @NisanthanNanthakumar
!important/*.log                 @NisanthanNanthakumar
file 1.txt @NisanthanNanthakumar  @getsentry/ecosystem
\#somefile.txt  @NisanthanNanthakumar

# some anchored paths
/scripts/test.js              @getsentry/ops
config/hooks                  @getsentry/ops
config/relay/                 @getsentry/relay

# not anchored path
docs-ui/                  @getsentry/docs @getsentry/ecosystem
"""
    )

    assert (
        convert_codeowners_syntax(
            codeowners,
            {
                "@getsentry/frontend": "front-sentry",
                "@getsentry/docs": "docs-sentry",
                "@getsentry/ecosystem": "ecosystem",
                "@getsentry/ops": "ops",
                "@getsentry/relay": "relay",
                "@NisanthanNanthakumar": "nisanthan.nanthakumar@sentry.io",
                "@AnotherUser": "anotheruser@sentry.io",
                "nisanthan.nanthakumar@sentry.io": "nisanthan.nanthakumar@sentry.io",
            },
            code_mapping,
        )
        == """
# cool stuff comment
codeowners:*.js front-sentry nisanthan.nanthakumar@sentry.io
# good comment


codeowners:webpack://static/docs/* docs-sentry ecosystem
codeowners:webpack://static/src/sentry/* anotheruser@sentry.io
codeowners:webpack://static/api/* nisanthan.nanthakumar@sentry.io

# some invalid rules
codeowners:file nisanthan.nanthakumar@sentry.io ecosystem

# some anchored paths
codeowners:webpack://static/scripts/test.js ops
codeowners:webpack://static/config/hooks ops
codeowners:webpack://static/config/relay/ relay

# not anchored path
codeowners:docs-ui/ docs-sentry ecosystem
"""
    )


</source>
</class>

<class classid="95" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_monitor.py" startline="11" endline="24" pcid="5463">
    def test_next_run_crontab_implicit(self):
        monitor = Monitor(
            last_checkin=datetime(2019, 1, 1, 1, 10, 20, tzinfo=timezone.utc),
            config={"schedule": "* * * * *"},
        )
        assert monitor.get_next_scheduled_checkin() == datetime(
            2019, 1, 1, 1, 11, tzinfo=timezone.utc
        )

        monitor.config["schedule"] = "*/5 * * * *"
        assert monitor.get_next_scheduled_checkin() == datetime(
            2019, 1, 1, 1, 15, tzinfo=timezone.utc
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_monitor.py" startline="25" endline="38" pcid="5464">
    def test_next_run_crontab_explicit(self):
        monitor = Monitor(
            last_checkin=datetime(2019, 1, 1, 1, 10, 20, tzinfo=timezone.utc),
            config={"schedule": "* * * * *", "schedule_type": ScheduleType.CRONTAB},
        )
        assert monitor.get_next_scheduled_checkin() == datetime(
            2019, 1, 1, 1, 11, tzinfo=timezone.utc
        )

        monitor.config["schedule"] = "*/5 * * * *"
        assert monitor.get_next_scheduled_checkin() == datetime(
            2019, 1, 1, 1, 15, tzinfo=timezone.utc
        )

</source>
</class>

<class classid="96" nclones="2" nlines="33" similarity="96">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_monitor.py" startline="49" endline="87" pcid="5466">
    def test_mark_failed_default_params(self, mock_insert_data_to_database_legacy):
        monitor = Monitor.objects.create(
            name="test monitor",
            organization_id=self.organization.id,
            project_id=self.project.id,
            type=MonitorType.CRON_JOB,
            config={"schedule": [1, "month"], "schedule_type": ScheduleType.INTERVAL},
        )
        assert monitor.mark_failed()

        assert len(mock_insert_data_to_database_legacy.mock_calls) == 1

        event = mock_insert_data_to_database_legacy.mock_calls[0].args[0]

        assert (
            dict(
                event,
                **{
                    "level": "error",
                    "project": self.project.id,
                    "platform": "other",
                    "contexts": {
                        "monitor": {
                            "status": "active",
                            "type": "cron_job",
                            "config": {"schedule_type": 2, "schedule": [1, "month"]},
                            "id": str(monitor.guid),
                            "name": monitor.name,
                        }
                    },
                    "logentry": {"formatted": "Monitor failure: test monitor (unknown)"},
                    "fingerprint": ["monitor", str(monitor.guid), "unknown"],
                    "logger": "",
                    "type": "default",
                },
            )
            == dict(event)
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_monitor.py" startline="89" endline="126" pcid="5467">
    def test_mark_failed_with_reason(self, mock_insert_data_to_database_legacy):
        monitor = Monitor.objects.create(
            name="test monitor",
            organization_id=self.organization.id,
            project_id=self.project.id,
            type=MonitorType.CRON_JOB,
            config={"schedule": [1, "month"], "schedule_type": ScheduleType.INTERVAL},
        )
        assert monitor.mark_failed(reason=MonitorFailure.DURATION)

        assert len(mock_insert_data_to_database_legacy.mock_calls) == 1

        event = mock_insert_data_to_database_legacy.mock_calls[0].args[0]

        assert (
            dict(
                event,
                **{
                    "level": "error",
                    "project": self.project.id,
                    "platform": "other",
                    "contexts": {
                        "monitor": {
                            "status": "active",
                            "type": "cron_job",
                            "config": {"schedule_type": 2, "schedule": [1, "month"]},
                            "id": str(monitor.guid),
                            "name": monitor.name,
                        }
                    },
                    "logentry": {"formatted": "Monitor failure: test monitor (duration)"},
                    "fingerprint": ["monitor", str(monitor.guid), "duration"],
                    "logger": "",
                    "type": "default",
                },
            )
            == dict(event)
        )
</source>
</class>

<class classid="97" nclones="2" nlines="15" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_sentryappinstallation.py" startline="6" endline="22" pcid="5471">
    def setUp(self):
        self.user = self.create_user()
        self.proxy = self.create_user()
        self.org = self.create_organization()
        self.application = ApiApplication.objects.create(owner=self.proxy)

        self.sentry_app = SentryApp.objects.create(
            application=self.application,
            name="NullDB",
            proxy_user=self.proxy,
            owner=self.org,
            scope_list=("project:read",),
            webhook_url="http://example.com",
        )

        self.install = SentryAppInstallation(sentry_app=self.sentry_app, organization=self.org)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_sentryapp.py" startline="7" endline="23" pcid="5485">
    def setUp(self):
        self.user = self.create_user()
        self.org = self.create_organization(owner=self.user)
        self.proxy = self.create_user()
        self.application = ApiApplication.objects.create(owner=self.proxy)

        self.sentry_app = SentryApp(
            application=self.application,
            name="NullDB",
            proxy_user=self.proxy,
            owner=self.org,
            scope_list=("project:read",),
            webhook_url="http://example.com",
            slug="nulldb",
        )
        self.sentry_app.save()

</source>
</class>

<class classid="98" nclones="3" nlines="32" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupassignee.py" startline="119" endline="167" pcid="5481">
    def test_assignee_sync_outbound_assign(self, mock_sync_assignee_outbound):
        group = self.group
        integration = Integration.objects.create(provider="example", external_id="123456")
        integration.add_organization(group.organization, self.user)

        OrganizationIntegration.objects.filter(
            integration_id=integration.id, organization_id=group.organization.id
        ).update(
            config={
                "sync_comments": True,
                "sync_status_outbound": True,
                "sync_status_inbound": True,
                "sync_assignee_outbound": True,
                "sync_assignee_inbound": True,
            }
        )

        external_issue = ExternalIssue.objects.create(
            organization_id=group.organization.id, integration_id=integration.id, key="APP-123"
        )

        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )

        with self.feature({"organizations:integrations-issue-sync": True}):
            with self.tasks():
                GroupAssignee.objects.assign(self.group, self.user)

                mock_sync_assignee_outbound.assert_called_with(
                    external_issue, self.user, assign=True
                )

                assert GroupAssignee.objects.filter(
                    project=self.group.project, group=self.group, user=self.user, team__isnull=True
                ).exists()

                activity = Activity.objects.get(
                    project=self.group.project, group=self.group, type=Activity.ASSIGNED
                )

                assert activity.data["assignee"] == str(self.user.id)
                assert activity.data["assigneeEmail"] == self.user.email
                assert activity.data["assigneeType"] == "user"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupassignee.py" startline="169" endline="212" pcid="5482">
    def test_assignee_sync_outbound_unassign(self, mock_sync_assignee_outbound):
        group = self.group
        integration = Integration.objects.create(provider="example", external_id="123456")
        integration.add_organization(group.organization, self.user)

        OrganizationIntegration.objects.filter(
            integration_id=integration.id, organization_id=group.organization.id
        ).update(
            config={
                "sync_comments": True,
                "sync_status_outbound": True,
                "sync_status_inbound": True,
                "sync_assignee_outbound": True,
                "sync_assignee_inbound": True,
            }
        )

        external_issue = ExternalIssue.objects.create(
            organization_id=group.organization.id, integration_id=integration.id, key="APP-123"
        )

        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )

        GroupAssignee.objects.assign(self.group, self.user)

        with self.feature({"organizations:integrations-issue-sync": True}):
            with self.tasks():
                GroupAssignee.objects.deassign(self.group)
                mock_sync_assignee_outbound.assert_called_with(external_issue, None, assign=False)

                assert not GroupAssignee.objects.filter(
                    project=self.group.project, group=self.group, user=self.user, team__isnull=True
                ).exists()

                assert Activity.objects.filter(
                    project=self.group.project, group=self.group, type=Activity.UNASSIGNED
                ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupassignee.py" startline="272" endline="311" pcid="5484">
    def test_assignee_sync_inbound_deassign(self):
        group = self.group
        integration = Integration.objects.create(provider="example", external_id="123456")
        integration.add_organization(group.organization, self.user)

        OrganizationIntegration.objects.filter(
            integration_id=integration.id, organization_id=group.organization.id
        ).update(
            config={
                "sync_comments": True,
                "sync_status_outbound": True,
                "sync_status_inbound": True,
                "sync_assignee_outbound": True,
                "sync_assignee_inbound": True,
            }
        )

        external_issue = ExternalIssue.objects.create(
            organization_id=group.organization.id, integration_id=integration.id, key="APP-123"
        )

        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )

        GroupAssignee.objects.assign(group, self.user)

        with self.feature("organizations:integrations-issue-sync"):
            groups_updated = sync_group_assignee_inbound(
                integration, self.user.email, "APP-123", assign=False
            )

            assert groups_updated[0] == group
            assert not GroupAssignee.objects.filter(
                project=group.project, group=group, user=self.user, team__isnull=True
            ).exists()
</source>
</class>

<class classid="99" nclones="3" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_debugfile.py" startline="153" endline="167" pcid="5527">
    def test_keep_disjoint_difs(self):
        file = self.create_file(
            name="crash.dsym", checksum="dc1e3f3e411979d336c3057cce64294f3420f93a"
        )
        dif1, created1 = self.create_dif(file=file, data={"features": ["unwind"]})

        file = self.create_file(
            name="crash.dsym", checksum="2b92c5472f4442a27da02509951ea2e0f529511c"
        )
        dif2, created2 = self.create_dif(file=file, data={"features": ["debug"]})

        assert created1 and created2
        assert ProjectDebugFile.objects.filter(id=dif1.id).exists()
        assert ProjectDebugFile.objects.filter(id=dif2.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_debugfile.py" startline="219" endline="234" pcid="5531">
    def test_remove_redundant_dif(self):
        file = self.create_file(
            name="crash.dsym", checksum="dc1e3f3e411979d336c3057cce64294f3420f93a"
        )
        dif1, created1 = self.create_dif(file=file, data={"features": ["debug"]})

        file = self.create_file(
            name="crash.dsym", checksum="2b92c5472f4442a27da02509951ea2e0f529511c"
        )
        dif2, created2 = self.create_dif(file=file, data={"features": ["debug"]})

        assert created1 and created2
        assert not ProjectDebugFile.objects.filter(id=dif1.id).exists()
        assert ProjectDebugFile.objects.filter(id=dif2.id).exists()


</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_debugfile.py" startline="168" endline="182" pcid="5528">
    def test_keep_overlapping_difs(self):
        file = self.create_file(
            name="crash.dsym", checksum="dc1e3f3e411979d336c3057cce64294f3420f93a"
        )
        dif1, created1 = self.create_dif(file=file, data={"features": ["symtab", "unwind"]})

        file = self.create_file(
            name="crash.dsym", checksum="2b92c5472f4442a27da02509951ea2e0f529511c"
        )
        dif2, created2 = self.create_dif(file=file, data={"features": ["symtab", "debug"]})

        assert created1 and created2
        assert ProjectDebugFile.objects.filter(id=dif1.id).exists()
        assert ProjectDebugFile.objects.filter(id=dif2.id).exists()

</source>
</class>

<class classid="100" nclones="2" nlines="19" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_releaseprojectenvironment.py" startline="37" endline="58" pcid="5564">
    def test_updates_last_seen(self):
        release_project_env = ReleaseProjectEnvironment.get_or_create(
            project=self.project,
            release=self.release,
            environment=self.environment,
            datetime=self.datetime_now,
        )
        assert release_project_env.project_id == self.project.id
        assert release_project_env.release_id == self.release.id
        assert release_project_env.environment_id == self.environment.id

        datetime_next = self.datetime_now + timedelta(days=1)

        release_project_env = ReleaseProjectEnvironment.get_or_create(
            project=self.project,
            release=self.release,
            environment=self.environment,
            datetime=datetime_next,
        )
        assert release_project_env.first_seen == self.datetime_now
        assert release_project_env.last_seen == datetime_next

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_releaseprojectenvironment.py" startline="59" endline="83" pcid="5565">
    def test_no_update_too_close(self):
        """
        Test ensures that ReleaseProjectEnvironment's last_seen is not updated if the next time
        it is seen is too close to the last time it was seen.
        """
        release_project_env = ReleaseProjectEnvironment.get_or_create(
            project=self.project,
            release=self.release,
            environment=self.environment,
            datetime=self.datetime_now,
        )
        assert release_project_env.project_id == self.project.id
        assert release_project_env.release_id == self.release.id
        assert release_project_env.environment_id == self.environment.id

        datetime_next = self.datetime_now + timedelta(seconds=1)

        release_project_env = ReleaseProjectEnvironment.get_or_create(
            project=self.project,
            release=self.release,
            environment=self.environment,
            datetime=datetime_next,
        )
        assert release_project_env.first_seen == self.datetime_now
        assert release_project_env.last_seen == self.datetime_now
</source>
</class>

<class classid="101" nclones="3" nlines="20" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="576" endline="600" pcid="5591">
    def test_simple(self, mock_fetch_commit):
        refs = [
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id",
                "commit": "current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-2",
                "commit": "current-commit-id-2",
            },
        ]

        self.release.set_refs(refs, self.user, True)

        commits = Commit.objects.all().order_by("id")
        self.assert_commit(commits[0], refs[0]["commit"])
        self.assert_commit(commits[1], refs[1]["commit"])

        head_commits = ReleaseHeadCommit.objects.all()
        self.assert_head_commit(head_commits[0], refs[1]["commit"])

        self.assert_fetch_commits(mock_fetch_commit, None, self.release.id, refs)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="651" endline="675" pcid="5594">
    def test_fetch_false(self, mock_fetch_commit):
        refs = [
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id",
                "commit": "current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-2",
                "commit": "current-commit-id-2",
            },
        ]

        self.release.set_refs(refs, self.user, False)

        commits = Commit.objects.all().order_by("id")
        self.assert_commit(commits[0], refs[0]["commit"])
        self.assert_commit(commits[1], refs[1]["commit"])

        head_commits = ReleaseHeadCommit.objects.all()
        self.assert_head_commit(head_commits[0], refs[1]["commit"])

        assert len(mock_fetch_commit.method_calls) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="623" endline="649" pcid="5593">
    def test_handle_commit_ranges(self, mock_fetch_commit):
        refs = [
            {
                "repository": "test/repo",
                "previousCommit": None,
                "commit": "previous-commit-id..current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-will-be-ignored",
                "commit": "previous-commit-id-2..current-commit-id-2",
            },
            {"repository": "test/repo", "commit": "previous-commit-id-3..current-commit-id-3"},
        ]

        self.release.set_refs(refs, self.user, True)

        commits = Commit.objects.all().order_by("id")
        self.assert_commit(commits[0], "current-commit-id")
        self.assert_commit(commits[1], "current-commit-id-2")
        self.assert_commit(commits[2], "current-commit-id-3")

        head_commits = ReleaseHeadCommit.objects.all()
        self.assert_head_commit(head_commits[0], "current-commit-id-3")

        self.assert_fetch_commits(mock_fetch_commit, None, self.release.id, refs)

</source>
</class>

<class classid="102" nclones="9" nlines="11" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="711" endline="726" pcid="5598">
    def test_parse_release_into_semver_cols(self):
        """
        Test that ensures that release version is parsed into the semver cols on Release model
        and that if build code can be parsed as a 64 bit integer then it is stored in build_number
        """
        version = "org.example.FooApp@1.0rc1+20200101100"
        release = Release.objects.create(organization=self.org, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "20200101100"
        assert release.build_number == 20200101100
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="727" endline="743" pcid="5599">
    def test_parse_release_into_semver_cols_using_custom_get_or_create(self):
        """
        Test that ensures that release version is parsed into the semver cols on Release model
        when using the custom `Release.get_or_create` method
        """
        version = "org.example.FooApp@1.0rc1+20200101100"
        project = self.create_project(organization=self.org, name="foo")
        release = Release.get_or_create(project=project, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "20200101100"
        assert release.build_number == 20200101100
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="760" endline="775" pcid="5601">
    def test_parse_release_into_semver_cols_with_int_build_code_gt_64_int(self):
        """
        Test that ensures that if the build_code passed as part of the semver version cannot be
        parsed as a 64 bit integer due to bigger than 64 bit integer then build number is left empty
        """
        version = "org.example.FooApp@1.0rc1+202001011005464576758979789794566455464746"
        release = Release.objects.create(organization=self.org, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "202001011005464576758979789794566455464746"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="776" endline="792" pcid="5602">
    def test_parse_release_into_semver_cols_with_negative_build_code(self):
        """
        Test that ensures that if the build_code passed as part of the semver version can be
        parsed as a 64 bit integer but has a negative sign then build number is left
        empty
        """
        version = "org.example.FooApp@1.0rc1+-2020"
        release = Release.objects.create(organization=self.org, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "-2020"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="793" endline="808" pcid="5603">
    def test_parse_release_into_semver_cols_with_no_prerelease(self):
        """
        Test that ensures that prerelease is stores as an empty string if not included
        in the version.
        """
        version = "org.example.FooApp@1.0+whatever"
        release = Release.objects.create(organization=self.org, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == ""
        assert release.build_code == "whatever"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="744" endline="759" pcid="5600">
    def test_parse_release_into_semver_cols_with_non_int_build_code(self):
        """
        Test that ensures that if the build_code passed as part of the semver version cannot be
        parsed as a 64 bit integer due to non int release then build number is left empty
        """
        version = "org.example.FooApp@1.0rc1+whatever"
        release = Release.objects.create(organization=self.org, version=version)
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "whatever"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="851" endline="867" pcid="5607">
    def test_parse_release_into_semver_cols_on_pre_save(self):
        """
        Test that ensures that calling save on a new Release instance parses version into semver
        columns
        """
        version = "org.example.FooApp@1.0rc1+-2020"
        release = Release(organization=self.org, version=version)
        release.save()
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "-2020"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="834" endline="850" pcid="5606">
    def test_parse_release_into_semver_cols_with_get_or_create(self):
        """
        Test that ensures get_or_create populates semver fields
        """
        version = "org.example.FooApp@1.0rc1+-2020"
        release, _ = Release.objects.get_or_create(
            organization=self.org, version=version, defaults={"status": ReleaseStatus.OPEN}
        )
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "-2020"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="868" endline="888" pcid="5608">
    def test_does_not_parse_release_into_semver_cols_on_pre_save_for_existing_release(self):
        """
        Test that ensures that calling save on an existing Release instance does not re-parse
        version into semver columns
        """
        version = "org.example.FooApp@1.0rc1+-2020"
        release = Release(organization=self.org, version=version)
        release.save()
        assert release.major == 1
        assert release.minor == 0
        assert release.patch == 0
        assert release.revision == 0
        assert release.prerelease == "rc1"
        assert release.build_code == "-2020"
        assert release.build_number is None
        assert release.package == "org.example.FooApp"
        release.version = "org.example.FooApp@1.0rc1+-1999"
        release.save()
        assert release.build_code == "-2020"


</source>
</class>

<class classid="103" nclones="3" nlines="14" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="915" endline="930" pcid="5612">
    def test_prerelease(self):
        # Prerelease has weird sorting rules, where an empty string is higher priority
        # than a non-empty string. Make sure this sorting works
        release = self.create_release(version="test@1.2.3-alpha")
        release_1 = self.create_release(version="test@1.2.3-beta")
        release_2 = self.create_release(version="test@1.2.3")
        release_3 = self.create_release(version="test@1.2.4-alpha")
        release_4 = self.create_release(version="test@1.2.4")
        self.run_test(">=", "1.2.3", [release_2, release_3, release_4])
        self.run_test(
            ">=",
            "1.2.3-beta",
            [release_1, release_2, release_3, release_4],
        )
        self.run_test("<", "1.2.3", [release_1, release])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="947" endline="963" pcid="5614">
    def test_wildcard(self):
        release_1 = self.create_release(version="test@1.0.0.0")
        release_2 = self.create_release(version="test@1.2.0.0")
        release_3 = self.create_release(version="test@1.2.3.0")
        release_4 = self.create_release(version="test@1.2.3.4")
        release_5 = self.create_release(version="test@2.0.0.0")

        self.run_test(
            "=",
            "1.X",
            [release_1, release_2, release_3, release_4],
        )
        self.run_test("=", "1.2.*", [release_2, release_3, release_4])
        self.run_test("=", "1.2.3.*", [release_3, release_4])
        self.run_test("=", "1.2.3.4", [release_4])
        self.run_test("=", "2.*", [release_5])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="931" endline="946" pcid="5613">
    def test_granularity(self):
        self.create_release(version="test@1.0.0.0")
        release_2 = self.create_release(version="test@1.2.0.0")
        release_3 = self.create_release(version="test@1.2.3.0")
        release_4 = self.create_release(version="test@1.2.3.4")
        release_5 = self.create_release(version="test@2.0.0.0")
        self.run_test(
            ">",
            "1",
            [release_2, release_3, release_4, release_5],
        )
        self.run_test(">", "1.2", [release_3, release_4, release_5])
        self.run_test(">", "1.2.3", [release_4, release_5])
        self.run_test(">", "1.2.3.4", [release_5])
        self.run_test(">", "2", [])

</source>
</class>

<class classid="104" nclones="5" nlines="12" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="1089" endline="1111" pcid="5627">
    def test_follows_semver_user_accidentally_stopped_using_semver_a_few_times(self):
        """
        Test that ensures that when a user accidentally stops using semver versioning for a few
        times but there exists at least one semver compliant release in the last 3 releases and
        at least 3 releases that are semver compliant in the last 10 then we still consider
        project to be following semantic versioning
        """
        proj = self.create_project(organization=self.org)

        for i in range(2):
            self.create_release(version=f"{self.fake_package}{proj.id}@1.{i}", project=proj)
        for i in range(7):
            self.create_release(version=f"foo release {i}", project=proj)
        self.create_release(version=f"{self.fake_package}{proj.id}@1.9", project=proj)

        assert (
            follows_semver_versioning_scheme(
                org_id=self.org.id,
                project_id=proj.id,
            )
            is True
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="1134" endline="1153" pcid="5629">
    def test_follows_semver_user_accidentally_uses_semver_a_few_times(self):
        """
        Test that ensures that if user accidentally uses semver compliant versions for a few
        times then the project will not be considered to be using semver
        """
        proj = self.create_project(organization=self.org)

        for i in range(8):
            self.create_release(version=f"foo release {i}", project=proj)
        for i in range(2):
            self.create_release(version=f"{self.fake_package}{proj.id}@1.{i}", project=proj)

        assert (
            follows_semver_versioning_scheme(
                org_id=self.org.id,
                project_id=proj.id,
            )
            is False
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="1112" endline="1133" pcid="5628">
    def test_follows_semver_user_stops_using_semver(self):
        """
        Test that ensures that if a user stops using semver and so the last 3 releases in the last
        10 releases are all non-semver releases, then the project does not follow semver anymore
        since 1st condition of at least one semver release in the last 3 has to be a semver
        release is not satisfied
        """
        proj = self.create_project(organization=self.org)

        for i in range(7):
            self.create_release(version=f"{self.fake_package}{proj.id}@1.{i}", project=proj)
        for i in range(3):
            self.create_release(version=f"helloworld {i}", project=proj)

        assert (
            follows_semver_versioning_scheme(
                org_id=self.org.id,
                project_id=proj.id,
            )
            is False
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="1154" endline="1173" pcid="5630">
    def test_follows_semver_user_starts_using_semver(self):
        """
        Test that ensures if a user starts using semver by having at least the last 3 releases
        using semver then we consider the project to be using semver
        """
        proj = self.create_project(organization=self.org)

        for i in range(7):
            self.create_release(version=f"foo release {i}", project=proj)
        for i in range(3):
            self.create_release(version=f"{self.fake_package}{proj.id}@1.{i}", project=proj)

        assert (
            follows_semver_versioning_scheme(
                org_id=self.org.id,
                project_id=proj.id,
            )
            is True
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_release.py" startline="1174" endline="1192" pcid="5631">
    def test_follows_semver_user_starts_using_semver_with_less_than_10_recent_releases(self):
        """
        Test that ensures that a project with only 5 (<10) releases and at least one semver
        release in the most recent releases is considered to be following semver
        """
        proj = self.create_project(organization=self.org)

        for i in range(4):
            self.create_release(version=f"helloworld {i}", project=proj)
        self.create_release(version=f"{self.fake_package}{proj.id}@1.0", project=proj)

        assert (
            follows_semver_versioning_scheme(
                org_id=self.org.id,
                project_id=proj.id,
            )
            is True
        )

</source>
</class>

<class classid="105" nclones="6" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="38" endline="52" pcid="5638">
    def test_for_semver_when_current_release_version_is_set_with_new_semver_release(self):
        # Behaviour should be the same in both `in_release` and `in_next_release` because if
        # `current_release_version` is set then comparison will be > current_release_version
        # should not have a resolution
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.old_semver_release,
                current_release_version=self.old_semver_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert not GroupResolution.has_resolution(self.group, self.new_semver_release)

            grp_resolution.delete()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="76" endline="87" pcid="5641">
    def test_when_current_release_version_is_set_with_new_release(self):
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.old_release,
                current_release_version=self.old_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert not GroupResolution.has_resolution(self.group, self.new_release)

            grp_resolution.delete()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="53" endline="64" pcid="5639">
    def test_for_semver_when_current_release_version_is_set_with_same_release(self):
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.old_semver_release,
                current_release_version=self.old_semver_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert GroupResolution.has_resolution(self.group, self.old_semver_release)

            grp_resolution.delete()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="65" endline="75" pcid="5640">
    def test_for_semver_when_current_release_version_is_set_with_old_semver_release(self):
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.new_semver_release,
                current_release_version=self.new_semver_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert GroupResolution.has_resolution(self.group, self.old_semver_release)
            grp_resolution.delete()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="88" endline="99" pcid="5642">
    def test_when_current_release_version_is_set_with_same_release(self):
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.old_release,
                current_release_version=self.old_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert GroupResolution.has_resolution(self.group, self.old_release)

            grp_resolution.delete()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_groupresolution.py" startline="100" endline="111" pcid="5643">
    def test_when_current_release_version_is_set_with_old_release(self):
        for grp_res_type in [GroupResolution.Type.in_release, GroupResolution.Type.in_next_release]:
            grp_resolution = GroupResolution.objects.create(
                release=self.new_release,
                current_release_version=self.new_release.version,
                group=self.group,
                type=grp_res_type,
            )
            assert GroupResolution.has_resolution(self.group, self.old_release)

            grp_resolution.delete()

</source>
</class>

<class classid="106" nclones="2" nlines="21" similarity="95">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_eventuser.py" startline="8" endline="29" pcid="5680">
    def test_build_hash(self):
        cases = [
            (
                {
                    "ident": "ident",
                    "username": "username",
                    "email": "email",
                    "ip_address": "127.0.0.1",
                },
                "67217d8b401cf5e72bbf5103d60f3e97",
            ),
            (
                {"username": "username", "email": "email", "ip_address": "127.0.0.1"},
                "14c4b06b824ec593239362517f538b29",
            ),
            ({"email": "email", "ip_address": "127.0.0.1"}, "0c83f57c786a0b4a39efab23731c7ebc"),
            ({"ip_address": "127.0.0.1"}, "f528764d624db129b32c21fbca0cb8d6"),
            ({}, None),
        ]
        for kw, value in cases:
            assert EventUser(**kw).build_hash() == value

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_eventuser.py" startline="30" endline="51" pcid="5681">
    def test_tag_value(self):
        cases = [
            (
                {
                    "ident": "ident",
                    "username": "username",
                    "email": "email",
                    "ip_address": "127.0.0.1",
                },
                "id:ident",
            ),
            (
                {"username": "username", "email": "email", "ip_address": "127.0.0.1"},
                "username:username",
            ),
            ({"email": "email", "ip_address": "127.0.0.1"}, "email:email"),
            ({"ip_address": "127.0.0.1"}, "ip:127.0.0.1"),
            ({}, None),
        ]
        for kw, value in cases:
            assert EventUser(**kw).tag_value == value

</source>
</class>

<class classid="107" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_deploy.py" startline="6" endline="20" pcid="5708">
    def test_notify_if_ready_long_release(self):
        org = self.create_organization()
        project = self.create_project(organization=org)
        release = Release.objects.create(version="a" * 200, organization=org)
        release.add_project(project)
        env = Environment.objects.create(name="production", organization_id=org.id)
        deploy = Deploy.objects.create(
            release=release, organization_id=org.id, environment_id=env.id
        )
        Deploy.notify_if_ready(deploy.id)

        # make sure activity has been created
        record = Activity.objects.get(type=Activity.DEPLOY, project=project)
        assert release.version.startswith(record.ident)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_deploy.py" startline="21" endline="38" pcid="5709">
    def test_already_notified(self):
        org = self.create_organization()
        project = self.create_project(organization=org)
        release = Release.objects.create(version="a" * 40, organization=org)
        release.add_project(project)
        env = Environment.objects.create(name="production", organization_id=org.id)

        deploy = Deploy.objects.create(
            release=release, organization_id=org.id, environment_id=env.id, notified=True
        )

        Deploy.notify_if_ready(deploy.id)

        # make sure no activity has been created
        assert not Activity.objects.filter(
            type=Activity.DEPLOY, project=project, ident=release.version
        ).exists()

</source>
</class>

<class classid="108" nclones="2" nlines="16" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/models/test_deploy.py" startline="39" endline="65" pcid="5710">
    def test_no_commits_no_head_commits(self):
        # case where there are not commits, but also no head commit,
        # so we shouldn't bother waiting to notify
        org = self.create_organization()
        project = self.create_project(organization=org)
        release = Release.objects.create(version="a" * 40, organization=org)
        release.add_project(project)
        env = Environment.objects.create(name="production", organization_id=org.id)

        deploy = Deploy.objects.create(
            release=release, organization_id=org.id, environment_id=env.id
        )

        Deploy.notify_if_ready(deploy.id)

        # make sure activity has been created
        assert Activity.objects.filter(
            type=Activity.DEPLOY, project=project, ident=release.version
        ).exists()
        assert (
            Activity.objects.get(type=Activity.DEPLOY, project=project, ident=release.version).data[
                "deploy_id"
            ]
            == deploy.id
        )
        assert Deploy.objects.get(id=deploy.id).notified is True

</source>
<source file="systems/sentry-22.2.0/tests/sentry/models/test_deploy.py" startline="93" endline="119" pcid="5712">
    def test_no_commits_fetch_complete(self):
        # case where they've created a deploy and
        # we've tried to fetch commits, but there
        # weren't any
        org = self.create_organization()
        project = self.create_project(organization=org)
        release = Release.objects.create(version="a" * 40, organization=org)
        release.add_project(project)
        env = Environment.objects.create(name="production", organization_id=org.id)

        deploy = Deploy.objects.create(
            release=release, organization_id=org.id, environment_id=env.id
        )

        Deploy.notify_if_ready(deploy.id, fetch_complete=True)

        # make sure activity has been created
        assert Activity.objects.filter(
            type=Activity.DEPLOY, project=project, ident=release.version
        ).exists()
        assert (
            Activity.objects.get(type=Activity.DEPLOY, project=project, ident=release.version).data[
                "deploy_id"
            ]
            == deploy.id
        )
        assert Deploy.objects.get(id=deploy.id).notified is True
</source>
</class>

<class classid="109" nclones="3" nlines="17" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_core.py" startline="10" endline="31" pcid="5755">
    def test_simple(self):
        user, _ = User.objects.get_or_create(is_superuser=True, defaults={"username": "test"})
        Organization.objects.all().delete()
        Team.objects.filter(slug="sentry").delete()
        Project.objects.filter(id=settings.SENTRY_PROJECT).delete()
        config = apps.get_app_config("sentry")

        create_default_projects(config)
        project = Project.objects.get(id=settings.SENTRY_PROJECT)
        assert project.public is False
        assert project.name == "Internal"
        assert project.slug == "internal"
        team = project.teams.first()
        assert team.slug == "sentry"

        pk = ProjectKey.objects.get(project=project)
        assert not pk.roles.api
        assert pk.roles.store

        # ensure that we don't hit an error here
        create_default_projects(config)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_core.py" startline="54" endline="75" pcid="5757">
    def test_no_sentry_project(self):
        with self.settings(SENTRY_PROJECT=None):
            User.objects.filter(is_superuser=True).delete()
            Team.objects.filter(slug="sentry").delete()
            Project.objects.filter(id=DEFAULT_SENTRY_PROJECT_ID).delete()
            config = apps.get_app_config("sentry")

            create_default_projects(config)

            project = Project.objects.get(id=DEFAULT_SENTRY_PROJECT_ID)
            assert project.public is False
            assert project.name == "Internal"
            assert project.slug == "internal"
            team = project.teams.first()
            assert team.slug == "sentry"

            pk = ProjectKey.objects.get(project=project)
            assert not pk.roles.api
            assert pk.roles.store

            # ensure that we don't hit an error here
            create_default_projects(config)
</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_core.py" startline="32" endline="53" pcid="5756">
    def test_without_user(self):
        User.objects.filter(is_superuser=True).delete()
        Team.objects.filter(slug="sentry").delete()
        Project.objects.filter(id=settings.SENTRY_PROJECT).delete()
        config = apps.get_app_config("sentry")

        create_default_projects(config)

        project = Project.objects.get(id=settings.SENTRY_PROJECT)
        assert project.public is False
        assert project.name == "Internal"
        assert project.slug == "internal"
        team = project.teams.first()
        assert team.slug == "sentry"

        pk = ProjectKey.objects.get(project=project)
        assert not pk.roles.api
        assert pk.roles.store

        # ensure that we don't hit an error here
        create_default_projects(config)

</source>
</class>

<class classid="110" nclones="3" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_onboarding.py" startline="139" endline="150" pcid="5762">
    def test_project_created(self):
        now = timezone.now()
        project = self.create_project(first_event=now)
        project_created.send(project=project, user=self.user, sender=type(project))

        task = OrganizationOnboardingTask.objects.get(
            organization=project.organization,
            task=OnboardingTask.FIRST_PROJECT,
            status=OnboardingTaskStatus.COMPLETE,
        )
        assert task is not None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_onboarding.py" startline="230" endline="241" pcid="5766">
    def test_member_invited(self):
        user = self.create_user(email="test@example.org")
        member = self.create_member(organization=self.organization, teams=[self.team], user=user)
        member_invited.send(member=member, user=user, sender=type(member))

        task = OrganizationOnboardingTask.objects.get(
            organization=self.organization,
            task=OnboardingTask.INVITE_MEMBER,
            status=OnboardingTaskStatus.PENDING,
        )
        assert task is not None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_onboarding.py" startline="151" endline="162" pcid="5763">
    def test_first_event_pending(self):
        now = timezone.now()
        project = self.create_project(first_event=now)
        first_event_pending.send(project=project, user=self.user, sender=type(project))

        task = OrganizationOnboardingTask.objects.get(
            organization=project.organization,
            task=OnboardingTask.FIRST_EVENT,
            status=OnboardingTaskStatus.PENDING,
        )
        assert task is not None

</source>
</class>

<class classid="111" nclones="4" nlines="10" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_sentry_apps.py" startline="42" endline="57" pcid="5774">
    def test_notify_after_resolve_in_commit(self, delay):
        repo = self.create_repo(project=self.project)
        commit = self.create_commit(repo=repo)

        self.update_issue(
            {"statusDetails": {"inCommit": {"repository": repo.name, "commit": commit.key}}}
        )

        assert faux(delay).called_with(
            installation_id=self.install.id,
            issue_id=self.issue.id,
            type="resolved",
            user_id=self.user.id,
            data={"resolution_type": "in_commit"},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_sentry_apps.py" startline="58" endline="70" pcid="5775">
    def test_notify_after_resolve_in_specific_release(self, delay):
        release = self.create_release(project=self.project)

        self.update_issue({"statusDetails": {"inRelease": release.version}})

        assert faux(delay).called_with(
            installation_id=self.install.id,
            issue_id=self.issue.id,
            type="resolved",
            user_id=self.user.id,
            data={"resolution_type": "in_release"},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_sentry_apps.py" startline="84" endline="96" pcid="5777">
    def test_notify_after_resolve_in_next_release(self, delay):
        self.create_release(project=self.project)

        self.update_issue({"statusDetails": {"inNextRelease": True}})

        assert faux(delay).called_with(
            installation_id=self.install.id,
            issue_id=self.issue.id,
            type="resolved",
            user_id=self.user.id,
            data={"resolution_type": "in_next_release"},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_sentry_apps.py" startline="71" endline="83" pcid="5776">
    def test_notify_after_resolve_in_latest_release(self, delay):
        self.create_release(project=self.project)

        self.update_issue({"statusDetails": {"inRelease": "latest"}})

        assert faux(delay).called_with(
            installation_id=self.install.id,
            issue_id=self.issue.id,
            type="resolved",
            user_id=self.user.id,
            data={"resolution_type": "in_release"},
        )

</source>
</class>

<class classid="112" nclones="3" nlines="15" similarity="87">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_transactions.py" startline="16" endline="31" pcid="5785">
    def test_transaction_processed(self):
        assert not self.project.flags.has_transactions
        event = self.store_event(
            data={
                "type": "transaction",
                "timestamp": self.min_ago,
                "start_timestamp": self.min_ago,
                "contexts": {"trace": {"trace_id": "b" * 32, "span_id": "c" * 16, "op": ""}},
            },
            project_id=self.project.id,
        )

        transaction_processed.send(project=self.project, event=event, sender=type(self.project))
        project = Project.objects.get(id=self.project.id)
        assert project.flags.has_transactions

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_transactions.py" startline="86" endline="102" pcid="5789">
    def test_analytics_event_no_owner(self):
        OrganizationMember.objects.filter(organization=self.organization, role="owner").delete()
        assert not self.project.flags.has_transactions
        event = self.store_event(
            data={
                "type": "transaction",
                "timestamp": self.min_ago,
                "start_timestamp": self.min_ago,
                "contexts": {"trace": {"trace_id": "b" * 32, "span_id": "c" * 16, "op": ""}},
            },
            project_id=self.project.id,
        )

        transaction_processed.send(project=self.project, event=event, sender=type(self.project))
        project = Project.objects.get(id=self.project.id)

        assert project.flags.has_transactions
</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_transactions.py" startline="32" endline="50" pcid="5786">
    def test_transaction_processed_no_platform(self):
        self.project.update(platform=None)
        assert not self.project.platform
        assert not self.project.flags.has_transactions

        event = self.store_event(
            data={
                "type": "transaction",
                "timestamp": self.min_ago,
                "start_timestamp": self.min_ago,
                "contexts": {"trace": {"trace_id": "b" * 32, "span_id": "c" * 16, "op": ""}},
            },
            project_id=self.project.id,
        )

        transaction_processed.send(project=self.project, event=event, sender=type(self.project))
        project = Project.objects.get(id=self.project.id)
        assert project.flags.has_transactions

</source>
</class>

<class classid="113" nclones="4" nlines="12" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="59" endline="73" pcid="5793">
    def test_simple_no_author(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)

        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            repository_id=repo.id,
            organization_id=group.organization.id,
            message=f"Foo Biz\n\nFixes {group.qualified_short_id}",
        )

        self.assertResolvedFromCommit(group, commit)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="113" endline="133" pcid="5796">
    def test_removes_group_link_when_message_changes(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)

        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            repository_id=repo.id,
            organization_id=group.organization.id,
            message=f"Foo Biz\n\nFixes {group.qualified_short_id}",
        )

        self.assertResolvedFromCommit(group, commit)

        commit.message = "no groups here"
        commit.save()

        add_group_to_inbox(group, GroupInboxReason.MANUAL)
        self.assertNotResolvedFromCommit(group, commit)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="93" endline="112" pcid="5795">
    def test_updating_commit_with_existing_grouplink(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)

        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            repository_id=repo.id,
            organization_id=group.organization.id,
            message=f"Foo Biz\n\nFixes {group.qualified_short_id}",
        )

        self.assertResolvedFromCommit(group, commit)

        commit.message = f"Foo Bar Biz\n\nFixes {group.qualified_short_id}"
        commit.save()

        self.assertResolvedFromCommit(group, commit)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="74" endline="92" pcid="5794">
    def test_updating_commit(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)

        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            repository_id=repo.id,
            organization_id=group.organization.id,
        )

        self.assertNotResolvedFromCommit(group, commit)

        commit.message = f"Foo Biz\n\nFixes {group.qualified_short_id}"
        commit.save()

        self.assertResolvedFromCommit(group, commit)

</source>
</class>

<class classid="114" nclones="2" nlines="25" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="148" endline="182" pcid="5798">
    def test_matching_author_with_assignment(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)
        user = self.create_user(name="Foo Bar", email="foo@example.com", is_active=True)
        email = UserEmail.objects.get_primary_email(user=user)
        email.is_verified = True
        email.save()
        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)
        OrganizationMember.objects.create(organization=group.project.organization, user=user)
        UserOption.objects.set_value(user=user, key="self_assign_issue", value="1")

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            organization_id=group.organization.id,
            repository_id=repo.id,
            message=f"Foo Biz\n\nFixes {group.qualified_short_id}",
            author=CommitAuthor.objects.create(
                organization_id=group.organization.id, name=user.name, email=user.email
            ),
        )

        self.assertResolvedFromCommit(group, commit)

        assert GroupAssignee.objects.filter(group=group, user=user).exists()

        assert Activity.objects.filter(
            project=group.project, group=group, type=Activity.ASSIGNED, user=user
        )[0].data == {
            "assignee": str(user.id),
            "assigneeEmail": user.email,
            "assigneeType": "user",
        }

        assert GroupSubscription.objects.filter(group=group, user=user).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_releases.py" startline="183" endline="210" pcid="5799">
    def test_matching_author_without_assignment(self):
        group = self.create_group()
        add_group_to_inbox(group, GroupInboxReason.MANUAL)
        user = self.create_user(name="Foo Bar", email="foo@example.com", is_active=True)
        email = UserEmail.objects.get_primary_email(user=user)
        email.is_verified = True
        email.save()
        repo = Repository.objects.create(name="example", organization_id=self.group.organization.id)
        OrganizationMember.objects.create(organization=group.project.organization, user=user)
        UserOption.objects.set_value(user=user, key="self_assign_issue", value="0")

        commit = Commit.objects.create(
            key=sha1(uuid4().hex.encode("utf-8")).hexdigest(),
            organization_id=group.organization.id,
            repository_id=repo.id,
            message=f"Foo Biz\n\nFixes {group.qualified_short_id}",
            author=CommitAuthor.objects.create(
                organization_id=group.organization.id, name=user.name, email=user.email
            ),
        )

        self.assertResolvedFromCommit(group, commit)

        assert not Activity.objects.filter(
            project=group.project, group=group, type=Activity.ASSIGNED, user=user
        ).exists()

        assert GroupSubscription.objects.filter(group=group, user=user).exists()
</source>
</class>

<class classid="115" nclones="2" nlines="21" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="290" endline="319" pcid="5831">
    def test_source_maps(self):
        event = self.store_event(
            data={
                "platform": "javascript",
                "exception": {
                    "values": [
                        {
                            "stacktrace": {
                                "frames": [
                                    {
                                        "data": {
                                            "sourcemap": "https://media.sentry.io/_static/29e365f8b0d923bc123e8afa38d890c3/sentry/dist/vendor.js.map"
                                        }
                                    }
                                ]
                            },
                            "type": "TypeError",
                        }
                    ]
                },
            },
            project_id=self.project.id,
        )
        event_processed.send(project=self.project, event=event, sender=type(self.project))

        source_maps = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="source_maps"
        )
        assert source_maps

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="320" endline="346" pcid="5832">
    def test_breadcrumbs(self):
        event = self.store_event(
            data={
                "breadcrumbs": {
                    "values": [
                        {
                            "category": "xhr",
                            "timestamp": 1496395011.63,
                            "type": "http",
                            "data": {
                                "url": "/api/path/here",
                                "status_code": "500",
                                "method": "POST",
                            },
                        }
                    ]
                }
            },
            project_id=self.project.id,
        )
        event_processed.send(project=self.project, event=event, sender=type(self.project))

        breadcrumbs = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="breadcrumbs"
        )
        assert breadcrumbs

</source>
</class>

<class classid="116" nclones="6" nlines="11" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="472" endline="485" pcid="5838">
    def test_resolved_in_release(self):
        issue_resolved.send(
            organization_id=self.organization.id,
            project=self.project,
            group=self.group,
            user=self.user,
            resolution_type="in_next_release",
            sender=type(self.project),
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="resolved_in_release"
        )
        assert feature_complete

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="551" endline="562" pcid="5845">
    def test_notification_plugin(self):
        plugin_enabled.send(
            plugin=NotificationPlugin(),
            project=self.project,
            user=self.owner,
            sender=type(self.project),
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="notification_integration"
        )
        assert feature_complete

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="563" endline="574" pcid="5846">
    def test_sso(self):
        sso_enabled.send(
            organization=self.organization,
            user=self.user,
            provider="google",
            sender=type(self.organization),
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="sso"
        )
        assert feature_complete

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="486" endline="499" pcid="5839">
    def test_resolved_manually(self):
        issue_resolved.send(
            organization_id=self.organization.id,
            project=self.project,
            group=self.group,
            user=self.user,
            resolution_type="now",
            sender=type(self.project),
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="resolved_in_release"
        )
        assert not feature_complete

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="521" endline="538" pcid="5843">
    def test_alert_rules(self):
        rule = Rule.objects.create(
            project=self.project, label="Trivially modified rule", data=DEFAULT_RULE_DATA
        )

        alert_rule_created.send(
            user=self.owner,
            project=self.project,
            rule=rule,
            rule_type="issue",
            sender=type(self.project),
            is_api_token=False,
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="alert_rules"
        )
        assert feature_complete

</source>
<source file="systems/sentry-22.2.0/tests/sentry/receivers/test_featureadoption.py" startline="539" endline="550" pcid="5844">
    def test_issue_tracker_plugin(self):
        plugin_enabled.send(
            plugin=IssueTrackingPlugin2(),
            project=self.project,
            user=self.owner,
            sender=type(self.project),
        )
        feature_complete = FeatureAdoption.objects.get_by_slug(
            organization=self.organization, slug="issue_tracker_integration"
        )
        assert feature_complete

</source>
</class>

<class classid="117" nclones="5" nlines="19" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/test_culprit.py" startline="11" endline="33" pcid="5862">
def test_cocoa_culprit():
    culprit = get_culprit(
        {
            "platform": "cocoa",
            "exception": {
                "type": "Crash",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "foo/baz.c",
                            "package": "/foo/bar/baz.dylib",
                            "lineno": 1,
                            "in_app": True,
                            "function": "-[CRLCrashAsyncSafeThread crash]",
                        }
                    ]
                },
            },
        }
    )
    assert culprit == "-[CRLCrashAsyncSafeThread crash]"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_culprit.py" startline="114" endline="137" pcid="5866">
def test_culprit_for_javascript_event():
    culprit = get_culprit(
        {
            "platform": "javascript",
            "exception": {
                "type": "Error",
                "value": "I fail hard",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "foo/baz.js",
                            "package": "node_modules/blah/foo/bar.js",
                            "lineno": 42,
                            "in_app": True,
                            "function": "fooBar",
                        }
                    ]
                },
            },
        }
    )
    assert culprit == "fooBar(foo/baz.js)"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_culprit.py" startline="34" endline="57" pcid="5863">
def test_emoji_culprit():
    culprit = get_culprit(
        {
            "platform": "native",
            "exception": {
                "type": "Crash",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "foo/baz.c",
                            "package": "/foo/bar/baz.dylib",
                            "module": "\U0001f62d",
                            "lineno": 1,
                            "in_app": True,
                            "function": "\U0001f60d",
                        }
                    ]
                },
            },
        }
    )
    assert culprit == "\U0001f60d"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_culprit.py" startline="88" endline="113" pcid="5865">
def test_culprit_for_synthetic_event():
    # Synthetic events do not generate a culprit
    culprit = get_culprit(
        {
            "platform": "javascript",
            "exception": {
                "type": "Error",
                "value": "I threw up stringly",
                "mechanism": {"type": "string-error", "synthetic": True},
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "foo/baz.js",
                            "package": "node_modules/blah/foo/bar.js",
                            "lineno": 42,
                            "in_app": True,
                            "function": "fooBar",
                        }
                    ]
                },
            },
        }
    )
    assert culprit == ""


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_culprit.py" startline="138" endline="160" pcid="5867">
def test_culprit_for_python_event():
    culprit = get_culprit(
        {
            "platform": "python",
            "exception": {
                "type": "ZeroDivisionError",
                "value": "integer division or modulo by zero",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "foo/baz.py",
                            "module": "foo.baz",
                            "package": "foo/baz.py",
                            "lineno": 23,
                            "in_app": True,
                            "function": "it_failed",
                        }
                    ]
                },
            },
        }
    )
    assert culprit == "foo.baz in it_failed"
</source>
</class>

<class classid="118" nclones="3" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/runner/commands/test_createuser.py" startline="11" endline="22" pcid="5868">
    def test_superuser(self):
        rv = self.invoke("--email=you@somewhereawesome.com", "--password=awesome", "--superuser")
        assert rv.exit_code == 0, rv.output
        assert "you@somewhereawesome.com" in rv.output
        assert User.objects.count() == 1
        user = User.objects.all()[0]
        assert user.email == "you@somewhereawesome.com"
        assert user.check_password("awesome")
        assert user.is_superuser
        assert user.is_staff
        assert user.is_active

</source>
<source file="systems/sentry-22.2.0/tests/sentry/runner/commands/test_createuser.py" startline="23" endline="34" pcid="5869">
    def test_no_superuser(self):
        rv = self.invoke("--email=you@somewhereawesome.com", "--password=awesome")
        assert rv.exit_code == 0, rv.output
        assert "you@somewhereawesome.com" in rv.output
        assert User.objects.count() == 1
        user = User.objects.all()[0]
        assert user.email == "you@somewhereawesome.com"
        assert user.check_password("awesome")
        assert not user.is_superuser
        assert not user.is_staff
        assert user.is_active

</source>
<source file="systems/sentry-22.2.0/tests/sentry/runner/commands/test_createuser.py" startline="35" endline="46" pcid="5870">
    def test_no_password(self):
        rv = self.invoke("--email=you@somewhereawesome.com", "--no-password")
        assert rv.exit_code == 0, rv.output
        assert "you@somewhereawesome.com" in rv.output
        assert User.objects.count() == 1
        user = User.objects.all()[0]
        assert user.email == "you@somewhereawesome.com"
        assert not user.password
        assert not user.is_superuser
        assert not user.is_staff
        assert user.is_active

</source>
</class>

<class classid="119" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/runner/commands/test_createuser.py" startline="47" endline="57" pcid="5871">
    def test_single_org(self):
        with self.settings(SENTRY_SINGLE_ORGANIZATION=True):
            rv = self.invoke("--email=you@somewhereawesome.com", "--no-password")
            assert rv.exit_code == 0, rv.output
            assert "you@somewhereawesome.com" in rv.output
            assert OrganizationMember.objects.count() == 1
            member = OrganizationMember.objects.all()[0]
            assert member.user.email == "you@somewhereawesome.com"
            assert member.organization.slug in rv.output
            assert member.role == member.organization.default_role

</source>
<source file="systems/sentry-22.2.0/tests/sentry/runner/commands/test_createuser.py" startline="58" endline="68" pcid="5872">
    def test_single_org_superuser(self):
        with self.settings(SENTRY_SINGLE_ORGANIZATION=True):
            rv = self.invoke("--email=you@somewhereawesome.com", "--no-password", "--superuser")
            assert rv.exit_code == 0, rv.output
            assert "you@somewhereawesome.com" in rv.output
            assert OrganizationMember.objects.count() == 1
            member = OrganizationMember.objects.all()[0]
            assert member.user.email == "you@somewhereawesome.com"
            assert member.organization.slug in rv.output
            assert member.role == roles.get_top_dog().id

</source>
</class>

<class classid="120" nclones="2" nlines="16" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_assemble.py" startline="58" endline="78" pcid="5905">
    def test_dif(self):
        sym_file = self.load_fixture("crash.sym")
        blob1 = FileBlob.from_file(ContentFile(sym_file))
        total_checksum = sha1(sym_file).hexdigest()

        assemble_dif(
            project_id=self.project.id,
            name="crash.sym",
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        status, _ = get_assemble_status(AssembleTask.DIF, self.project.id, total_checksum)
        assert status == ChunkFileState.OK

        dif = ProjectDebugFile.objects.filter(
            project_id=self.project.id, checksum=total_checksum
        ).get()

        assert dif.file.headers == {"Content-Type": "text/x-breakpad"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_assemble.py" startline="161" endline="184" pcid="5908">
    def test_assemble_debug_id_override(self):
        sym_file = self.load_fixture("crash.sym")
        blob1 = FileBlob.from_file(ContentFile(sym_file))
        total_checksum = sha1(sym_file).hexdigest()

        assemble_dif(
            project_id=self.project.id,
            name="crash.sym",
            checksum=total_checksum,
            chunks=[blob1.checksum],
            debug_id="67e9247c-814e-392b-a027-dbde6748fcbf-beef",
        )

        status, _ = get_assemble_status(AssembleTask.DIF, self.project.id, total_checksum)
        assert status == ChunkFileState.OK

        dif = ProjectDebugFile.objects.filter(
            project_id=self.project.id, checksum=total_checksum
        ).get()

        assert dif.file.headers == {"Content-Type": "text/x-breakpad"}
        assert dif.debug_id == "67e9247c-814e-392b-a027-dbde6748fcbf-beef"


</source>
</class>

<class classid="121" nclones="3" nlines="13" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_assemble.py" startline="239" endline="255" pcid="5911">
    def test_artifacts_invalid_org(self):
        bundle_file = self.create_artifact_bundle(org="invalid")
        blob1 = FileBlob.from_file(ContentFile(bundle_file))
        total_checksum = sha1(bundle_file).hexdigest()

        assemble_artifacts(
            org_id=self.organization.id,
            version=self.release.version,
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        status, details = get_assemble_status(
            AssembleTask.ARTIFACTS, self.organization.id, total_checksum
        )
        assert status == ChunkFileState.ERROR

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_assemble.py" startline="256" endline="272" pcid="5912">
    def test_artifacts_invalid_release(self):
        bundle_file = self.create_artifact_bundle(release="invalid")
        blob1 = FileBlob.from_file(ContentFile(bundle_file))
        total_checksum = sha1(bundle_file).hexdigest()

        assemble_artifacts(
            org_id=self.organization.id,
            version=self.release.version,
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        status, details = get_assemble_status(
            AssembleTask.ARTIFACTS, self.organization.id, total_checksum
        )
        assert status == ChunkFileState.ERROR

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_assemble.py" startline="273" endline="289" pcid="5913">
    def test_artifacts_invalid_zip(self):
        bundle_file = b""
        blob1 = FileBlob.from_file(ContentFile(bundle_file))
        total_checksum = sha1(bundle_file).hexdigest()

        assemble_artifacts(
            org_id=self.organization.id,
            version=self.release.version,
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        status, details = get_assemble_status(
            AssembleTask.ARTIFACTS, self.organization.id, total_checksum
        )
        assert status == ChunkFileState.ERROR

</source>
</class>

<class classid="122" nclones="2" nlines="30" similarity="96">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_beacon.py" startline="20" endline="54" pcid="5915">
    def test_simple(self, safe_urlread, safe_urlopen, mock_get_all_package_versions):
        mock_get_all_package_versions.return_value = {"foo": "1.0"}
        safe_urlread.return_value = json.dumps({"notices": [], "version": {"stable": "1.0.0"}})

        assert options.set("system.admin-email", "foo@example.com")
        assert options.set("beacon.anonymous", False)
        send_beacon()

        install_id = options.get("sentry:install-id")
        assert install_id and len(install_id) == 40

        safe_urlopen.assert_called_once_with(
            BEACON_URL,
            json={
                "install_id": install_id,
                "version": sentry.get_version(),
                "docker": sentry.is_docker(),
                "python_version": platform.python_version(),
                "data": {
                    "organizations": 1,
                    "users": 0,
                    "projects": 1,
                    "teams": 1,
                    "events.24h": 0,
                },
                "anonymous": False,
                "admin_email": "foo@example.com",
                "packages": mock_get_all_package_versions.return_value,
            },
            timeout=5,
        )
        safe_urlread.assert_called_once_with(safe_urlopen.return_value)

        assert options.get("sentry:latest_version") == "1.0.0"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_beacon.py" startline="59" endline="92" pcid="5916">
    def test_anonymous(self, safe_urlread, safe_urlopen, mock_get_all_package_versions):
        mock_get_all_package_versions.return_value = {"foo": "1.0"}
        safe_urlread.return_value = json.dumps({"notices": [], "version": {"stable": "1.0.0"}})

        assert options.set("system.admin-email", "foo@example.com")
        assert options.set("beacon.anonymous", True)
        send_beacon()

        install_id = options.get("sentry:install-id")
        assert install_id and len(install_id) == 40

        safe_urlopen.assert_called_once_with(
            BEACON_URL,
            json={
                "install_id": install_id,
                "version": sentry.get_version(),
                "docker": sentry.is_docker(),
                "python_version": platform.python_version(),
                "data": {
                    "organizations": 1,
                    "users": 0,
                    "projects": 1,
                    "teams": 1,
                    "events.24h": 0,
                },
                "anonymous": True,
                "packages": mock_get_all_package_versions.return_value,
            },
            timeout=5,
        )
        safe_urlread.assert_called_once_with(safe_urlopen.return_value)

        assert options.get("sentry:latest_version") == "1.0.0"

</source>
</class>

<class classid="123" nclones="2" nlines="30" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_merge.py" startline="49" endline="86" pcid="5925">
    def test_merge_with_event_integrity(self):
        project = self.create_project()
        event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(seconds=1)),
                "fingerprint": ["group-1"],
                "extra": {"foo": "bar"},
            },
            project_id=project.id,
        )
        group1 = event1.group
        event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(seconds=1)),
                "fingerprint": ["group-2"],
                "extra": {"foo": "baz"},
            },
            project_id=project.id,
        )
        group2 = event2.group

        with self.tasks():
            eventstream_state = eventstream.start_merge(project.id, [group1.id], group2.id)
            merge_groups([group1.id], group2.id)
            eventstream.end_merge(eventstream_state)

        assert not Group.objects.filter(id=group1.id).exists()

        event1 = eventstore.get_event_by_id(project.id, event1.event_id)
        assert event1.group_id == group2.id
        assert event1.data["extra"]["foo"] == "bar"

        event2 = eventstore.get_event_by_id(project.id, event2.event_id)
        assert event2.group_id == group2.id
        assert event2.data["extra"]["foo"] == "baz"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_merge.py" startline="107" endline="136" pcid="5927">
    def test_merge_updates_tag_values_seen(self):
        project = self.create_project()
        event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(seconds=1)),
                "fingerprint": ["group-1"],
                "tags": {"foo": "bar"},
                "environment": self.environment.name,
            },
            project_id=project.id,
        )
        event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(seconds=1)),
                "fingerprint": ["group-2"],
                "tags": {"foo": "bar"},
                "environment": self.environment.name,
            },
            project_id=project.id,
        )
        target = event1.group
        other = event2.group

        with self.tasks():
            merge_groups([other.id], target.id)

        assert not Group.objects.filter(id=other.id).exists()

</source>
</class>

<class classid="124" nclones="2" nlines="25" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="323" endline="354" pcid="5952">
    def test_integration_org_error_created_doesnt_send_webhook(self, safe_urlopen):
        sentry_app = self.create_sentry_app(
            organization=self.project.organization, events=["error.created"]
        )
        self.create_sentry_app_installation(
            organization=self.project.organization, slug=sentry_app.slug
        )

        one_min_ago = iso_format(before_now(minutes=1))
        event = self.store_event(
            data={
                "message": "Foo bar",
                "exception": {"type": "Foo", "value": "shits on fiah yo"},
                "level": "error",
                "timestamp": one_min_ago,
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        with self.tasks():
            post_process_group(
                is_new=False,
                is_regression=False,
                is_new_group_environment=False,
                cache_key=write_event_to_cache(event),
                group_id=event.group_id,
            )

        assert not safe_urlopen.called


</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="378" endline="405" pcid="5954">
    def test_sends_webhooks_to_all_installs(self, safe_urlopen):
        one_min_ago = iso_format(before_now(minutes=1))
        event = self.store_event(
            data={
                "message": "Foo bar",
                "exception": {"type": "Foo", "value": "shits on fiah yo"},
                "level": "error",
                "timestamp": one_min_ago,
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        with self.tasks():
            post_process_group(
                is_new=True,
                is_regression=False,
                is_new_group_environment=False,
                cache_key=write_event_to_cache(event),
                group_id=event.group_id,
            )

        assert len(safe_urlopen.mock_calls) == 2
        call_urls = [call.kwargs["url"] for call in safe_urlopen.mock_calls]
        assert self.sentry_app_1.webhook_url in call_urls
        assert self.sentry_app_2.webhook_url in call_urls


</source>
</class>

<class classid="125" nclones="2" nlines="12" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="434" endline="448" pcid="5959">
    def setUp(self):
        self.project = self.create_project()
        self.user = self.create_user()

        self.sentry_app = self.create_sentry_app(
            organization=self.project.organization,
            events=["issue.resolved", "issue.ignored", "issue.assigned"],
        )

        self.install = self.create_sentry_app_installation(
            organization=self.project.organization, slug=self.sentry_app.slug
        )

        self.issue = self.create_group(project=self.project)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="490" endline="507" pcid="5964">
    def setUp(self):
        self.project = self.create_project()
        self.user = self.create_user()

        self.sentry_app = self.create_sentry_app(
            name="Test App",
            organization=self.project.organization,
            events=["issue.resolved", "issue.ignored", "issue.assigned"],
        )
        self.sentry_app.update(status=SentryAppStatus.PUBLISHED)

        self.install = self.create_sentry_app_installation(
            organization=self.project.organization, slug=self.sentry_app.slug
        )

        self.issue = self.create_group(project=self.project)
        self.buffer = SentryAppWebhookRequestsBuffer(self.sentry_app)

</source>
</class>

<class classid="126" nclones="4" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="509" endline="526" pcid="5965">
    def test_saves_error_if_webhook_request_fails(self, safe_urlopen):
        data = {"issue": serialize(self.issue)}

        with self.assertRaises(ClientError):
            send_webhooks(
                installation=self.install, event="issue.assigned", data=data, actor=self.user
            )

        requests = self.buffer.get_requests()
        requests_count = len(requests)
        first_request = requests[0]

        assert safe_urlopen.called
        assert requests_count == 1
        assert first_request["response_code"] == 400
        assert first_request["event_type"] == "issue.assigned"
        assert first_request["organization_id"] == self.install.organization.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="562" endline="579" pcid="5968">
    def test_saves_error_event_id_if_in_header(self, safe_urlopen):
        data = {"issue": serialize(self.issue)}
        with self.assertRaises(ClientError):
            send_webhooks(
                installation=self.install, event="issue.assigned", data=data, actor=self.user
            )

        requests = self.buffer.get_requests()
        requests_count = len(requests)
        first_request = requests[0]

        assert safe_urlopen.called
        assert requests_count == 1
        assert first_request["response_code"] == 400
        assert first_request["event_type"] == "issue.assigned"
        assert first_request["organization_id"] == self.install.organization.id
        assert first_request["error_id"] == "d5111da2c28645c5889d072017e3445d"
        assert first_request["project_id"] == "1"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="528" endline="541" pcid="5966">
    def test_saves_request_if_webhook_request_succeeds(self, safe_urlopen):
        data = {"issue": serialize(self.issue)}
        send_webhooks(installation=self.install, event="issue.assigned", data=data, actor=self.user)

        requests = self.buffer.get_requests()
        requests_count = len(requests)
        first_request = requests[0]

        assert safe_urlopen.called
        assert requests_count == 1
        assert first_request["response_code"] == 200
        assert first_request["event_type"] == "issue.assigned"
        assert first_request["organization_id"] == self.install.organization.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_sentry_apps.py" startline="543" endline="560" pcid="5967">
    def test_saves_error_for_request_timeout(self, safe_urlopen):
        data = {"issue": serialize(self.issue)}
        # we don't log errors for unpublished and internal apps
        with self.assertRaises(Timeout):
            send_webhooks(
                installation=self.install, event="issue.assigned", data=data, actor=self.user
            )

        requests = self.buffer.get_requests()
        requests_count = len(requests)
        first_request = requests[0]

        assert safe_urlopen.called
        assert requests_count == 1
        assert first_request["response_code"] == 0
        assert first_request["event_type"] == "issue.assigned"
        assert first_request["organization_id"] == self.install.organization.id

</source>
</class>

<class classid="127" nclones="5" nlines="13" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="11" endline="27" pcid="5989">
    def test_missing_checkin(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            status=MonitorStatus.OK,
        )

        check_monitors()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.ERROR).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="62" endline="80" pcid="5992">
    def test_missing_checkin_but_deletion_in_progress(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            status=MonitorStatus.DELETION_IN_PROGRESS,
        )

        check_monitors()

        assert Monitor.objects.filter(
            id=monitor.id, status=MonitorStatus.DELETION_IN_PROGRESS
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="45" endline="61" pcid="5991">
    def test_missing_checkin_but_pending_deletion(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            status=MonitorStatus.PENDING_DELETION,
        )

        check_monitors()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.PENDING_DELETION).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="81" endline="100" pcid="5993">
    def test_not_missing_checkin(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() + timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            status=MonitorStatus.OK,
        )
        MonitorCheckIn.objects.create(
            monitor=monitor, project_id=project.id, status=CheckInStatus.OK
        )

        check_monitors()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.OK).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="28" endline="44" pcid="5990">
    def test_missing_checkin_but_disabled(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            status=MonitorStatus.DISABLED,
        )

        check_monitors()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.DISABLED).exists()

</source>
</class>

<class classid="128" nclones="3" nlines="31" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="101" endline="143" pcid="5994">
    def test_timeout_with_no_future_complete_checkin(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        current_datetime = timezone.now() - timedelta(hours=24)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=current_datetime + timedelta(hours=12, minutes=1),
            last_checkin=current_datetime + timedelta(hours=12),
            type=MonitorType.CRON_JOB,
            config={"schedule": "0 0 * * *"},
            status=MonitorStatus.OK,
            date_added=current_datetime,
        )
        checkin = MonitorCheckIn.objects.create(
            monitor=monitor,
            project_id=project.id,
            status=CheckInStatus.IN_PROGRESS,
            date_added=current_datetime,
            date_updated=current_datetime,
        )
        checkin2 = MonitorCheckIn.objects.create(
            monitor=monitor,
            project_id=project.id,
            status=CheckInStatus.IN_PROGRESS,
            date_added=monitor.last_checkin,
            date_updated=monitor.last_checkin,
        )

        assert checkin.date_added == checkin.date_updated == current_datetime

        check_monitors(current_datetime=current_datetime + timedelta(hours=12, minutes=1))

        assert MonitorCheckIn.objects.filter(id=checkin.id, status=CheckInStatus.ERROR).exists()

        assert MonitorCheckIn.objects.filter(
            id=checkin2.id, status=CheckInStatus.IN_PROGRESS
        ).exists()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.ERROR).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="185" endline="215" pcid="5996">
    def test_timeout_with_via_configuration(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        current_datetime = timezone.now() - timedelta(hours=24)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=current_datetime + timedelta(hours=1, minutes=1),
            last_checkin=current_datetime + timedelta(hours=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "0 0 * * *", "max_runtime": 60},
            status=MonitorStatus.OK,
            date_added=current_datetime,
        )
        checkin = MonitorCheckIn.objects.create(
            monitor=monitor,
            project_id=project.id,
            status=CheckInStatus.IN_PROGRESS,
            date_added=current_datetime,
            date_updated=current_datetime,
        )

        assert checkin.date_added == checkin.date_updated == current_datetime

        check_monitors(current_datetime=current_datetime + timedelta(hours=1, minutes=1))

        assert MonitorCheckIn.objects.filter(id=checkin.id, status=CheckInStatus.ERROR).exists()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.ERROR).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_check_monitors.py" startline="144" endline="184" pcid="5995">
    def test_timeout_with_future_complete_checkin(self):
        org = self.create_organization()
        project = self.create_project(organization=org)

        current_datetime = timezone.now() - timedelta(hours=24)

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=current_datetime + timedelta(hours=12, minutes=1),
            last_checkin=current_datetime + timedelta(hours=12),
            type=MonitorType.CRON_JOB,
            config={"schedule": "0 0 * * *"},
            status=MonitorStatus.OK,
            date_added=current_datetime,
        )
        checkin = MonitorCheckIn.objects.create(
            monitor=monitor,
            project_id=project.id,
            status=CheckInStatus.IN_PROGRESS,
            date_added=current_datetime,
            date_updated=current_datetime,
        )
        checkin2 = MonitorCheckIn.objects.create(
            monitor=monitor,
            project_id=project.id,
            status=CheckInStatus.OK,
            date_added=monitor.last_checkin,
            date_updated=monitor.last_checkin,
        )

        assert checkin.date_added == checkin.date_updated == current_datetime

        check_monitors(current_datetime=current_datetime + timedelta(hours=12, minutes=1))

        assert MonitorCheckIn.objects.filter(id=checkin.id, status=CheckInStatus.ERROR).exists()

        assert MonitorCheckIn.objects.filter(id=checkin2.id, status=CheckInStatus.OK).exists()

        assert Monitor.objects.filter(id=monitor.id, status=MonitorStatus.OK).exists()

</source>
</class>

<class classid="129" nclones="3" nlines="59" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_releasemonitor.py" startline="91" endline="154" pcid="6001">
    def test_simple(self):
        self.bulk_store_sessions([self.build_session(project_id=self.project1) for _ in range(11)])
        self.bulk_store_sessions(
            [
                self.build_session(project_id=self.project2, environment=self.environment2.name)
                for _ in range(1)
            ]
        )
        assert self.project1.flags.has_sessions.is_set is False
        now = timezone.now()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted=None,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

        test_data = [
            {
                "org_id": [self.organization.id],
                "project_id": [self.project2.id, self.project1.id],
            },
        ]
        process_projects_with_sessions(test_data[0]["org_id"][0], test_data[0]["project_id"])
        self.project1.refresh_from_db()
        assert self.project1.flags.has_sessions.is_set is True

        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_releasemonitor.py" startline="155" endline="214" pcid="6002">
    def test_simple_no_sessions(self):
        now = timezone.now()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted=None,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

        test_data = [
            {
                "org_id": [self.organization.id],
                "project_id": [self.project2.id, self.project1.id],
            },
        ]
        process_projects_with_sessions(test_data[0]["org_id"][0], test_data[0]["project_id"])

        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted=None,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_releasemonitor.py" startline="313" endline="386" pcid="6005">
    def test_multi_proj_env_release_counter(self):
        self.bulk_store_sessions(
            [
                self.build_session(
                    project_id=self.project1,
                )
                for _ in range(11)
            ]
        )
        self.bulk_store_sessions(
            [
                self.build_session(project_id=self.project2, environment=self.environment2)
                for _ in range(1)
            ]
        )
        self.bulk_store_sessions(
            [self.build_session(project_id=self.project1, release=self.release2) for _ in range(1)]
        )
        self.bulk_store_sessions(
            [self.build_session(project_id=self.project1, release=self.release3) for _ in range(1)]
        )
        now = timezone.now()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted=None,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

        test_data = [
            {
                "org_id": [self.organization.id],
                "project_id": [self.project2.id, self.project1.id],
            },
        ]
        process_projects_with_sessions(test_data[0]["org_id"][0], test_data[0]["project_id"])

        assert not ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted=None,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project1.id,
            release_id=self.release.id,
            environment_id=self.environment.id,
            adopted__gte=now,
        ).exists()
        assert ReleaseProjectEnvironment.objects.filter(
            project_id=self.project2.id,
            release_id=self.release.id,
            environment_id=self.environment2.id,
            adopted__gte=now,
        ).exists()

</source>
</class>

<class classid="130" nclones="3" nlines="23" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_commits.py" startline="133" endline="166" pcid="6041">
    def test_fetch_error_plugin_error(self, mock_compare_commits):
        self.login_as(user=self.user)
        org = self.create_organization(owner=self.user, name="baz")

        repo = Repository.objects.create(name="example", provider="dummy", organization_id=org.id)
        release = Release.objects.create(organization_id=org.id, version="abcabcabc")

        commit = Commit.objects.create(organization_id=org.id, repository_id=repo.id, key="a" * 40)

        ReleaseHeadCommit.objects.create(
            organization_id=org.id, repository_id=repo.id, release=release, commit=commit
        )

        refs = [{"repository": repo.name, "commit": "b" * 40}]

        release2 = Release.objects.create(organization_id=org.id, version="12345678")

        UserSocialAuth.objects.create(user=self.user, provider="dummy")

        mock_compare_commits.side_effect = Exception("secrets")

        with self.tasks():
            fetch_commits(
                release_id=release2.id,
                user_id=self.user.id,
                refs=refs,
                previous_release_id=release.id,
            )

        msg = mail.outbox[-1]
        assert msg.subject == "Unable to Fetch Commits"
        assert msg.to == [self.user.email]
        assert "secrets" not in msg.body

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_commits.py" startline="168" endline="201" pcid="6042">
    def test_fetch_error_plugin_error_for_sentry_app(self, mock_compare_commits):
        org = self.create_organization(owner=self.user, name="baz")
        sentry_app = self.create_sentry_app(
            organization=org, published=True, verify_install=False, name="Super Awesome App"
        )

        repo = Repository.objects.create(name="example", provider="dummy", organization_id=org.id)
        release = Release.objects.create(organization_id=org.id, version="abcabcabc")

        commit = Commit.objects.create(organization_id=org.id, repository_id=repo.id, key="a" * 40)

        ReleaseHeadCommit.objects.create(
            organization_id=org.id, repository_id=repo.id, release=release, commit=commit
        )

        refs = [{"repository": repo.name, "commit": "b" * 40}]

        release2 = Release.objects.create(organization_id=org.id, version="12345678")

        mock_compare_commits.side_effect = Exception("secrets")

        with self.tasks():
            fetch_commits(
                release_id=release2.id,
                user_id=sentry_app.proxy_user_id,
                refs=refs,
                previous_release_id=release.id,
            )

        msg = mail.outbox[-1]
        assert msg.subject == "Unable to Fetch Commits"
        assert msg.to == [self.user.email]
        assert "secrets" not in msg.body

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_commits.py" startline="203" endline="236" pcid="6043">
    def test_fetch_error_random_exception(self, mock_compare_commits):
        self.login_as(user=self.user)
        org = self.create_organization(owner=self.user, name="baz")

        repo = Repository.objects.create(name="example", provider="dummy", organization_id=org.id)
        release = Release.objects.create(organization_id=org.id, version="abcabcabc")

        commit = Commit.objects.create(organization_id=org.id, repository_id=repo.id, key="a" * 40)

        ReleaseHeadCommit.objects.create(
            organization_id=org.id, repository_id=repo.id, release=release, commit=commit
        )

        refs = [{"repository": repo.name, "commit": "b" * 40}]

        release2 = Release.objects.create(organization_id=org.id, version="12345678")

        UserSocialAuth.objects.create(user=self.user, provider="dummy")

        mock_compare_commits.side_effect = PluginError("You can read me")

        with self.tasks():
            fetch_commits(
                release_id=release2.id,
                user_id=self.user.id,
                refs=refs,
                previous_release_id=release.id,
            )

        msg = mail.outbox[-1]
        assert msg.subject == "Unable to Fetch Commits"
        assert msg.to == [self.user.email]
        assert "You can read me" in msg.body

</source>
</class>

<class classid="131" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_symbolication.py" startline="19" endline="38" pcid="6055">
    def get_event_preprocessors(self, data):
        def remove_extra(data):
            del data["extra"]
            return data

        def put_on_hold(data):
            data["unprocessed"] = True
            return data

        if data.get("platform") == "mattlang":
            return [remove_extra, lambda x: None]

        if data.get("platform") == "noop":
            return [lambda data: None]

        if data.get("platform") == "holdmeclose":
            return [put_on_hold]

        return []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="21" endline="40" pcid="6085">
    def get_event_preprocessors(self, data):
        def remove_extra(data):
            del data["extra"]
            return data

        def put_on_hold(data):
            data["unprocessed"] = True
            return data

        if data.get("platform") == "mattlang":
            return [remove_extra, lambda x: None]

        if data.get("platform") == "noop":
            return [lambda data: None]

        if data.get("platform") == "holdmeclose":
            return [put_on_hold]

        return []

</source>
</class>

<class classid="132" nclones="3" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_symbolication.py" startline="95" endline="113" pcid="6067">
def test_move_to_symbolicate_event(
    default_project, mock_process_event, mock_save_event, mock_symbolicate_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)
    data = {
        "project": default_project.id,
        "platform": "native",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    preprocess_event(cache_key="", data=data)

    assert mock_symbolicate_event.delay.call_count == 1
    assert mock_process_event.delay.call_count == 0
    assert mock_save_event.delay.call_count == 0


</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="94" endline="112" pcid="6097">
def test_move_to_process_event(
    default_project, mock_process_event, mock_save_event, mock_symbolicate_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)
    data = {
        "project": default_project.id,
        "platform": "mattlang",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    preprocess_event(cache_key="", data=data)

    assert mock_symbolicate_event.delay.call_count == 0
    assert mock_process_event.delay.call_count == 1
    assert mock_save_event.delay.call_count == 0


</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="114" endline="132" pcid="6098">
def test_move_to_save_event(
    default_project, mock_process_event, mock_save_event, mock_symbolicate_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)
    data = {
        "project": default_project.id,
        "platform": "NOTMATTLANG",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    preprocess_event(cache_key="", data=data)

    assert mock_symbolicate_event.delay.call_count == 0
    assert mock_process_event.delay.call_count == 0
    assert mock_save_event.delay.call_count == 1


</source>
</class>

<class classid="133" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_app_store_connect.py" startline="15" endline="27" pcid="6076">
    def config(self):
        return appconnect.AppStoreConnectConfig(
            type="appStoreConnect",
            id=uuid.uuid4().hex,
            name="Apple App Store Connect",
            appconnectIssuer="abc123" * 6,
            appconnectKey="abc123key",
            appconnectPrivateKey="----BEGIN PRIVATE KEY---- blabla",
            appName="My App",
            appId="123",
            bundleId="com.example.app",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_appconnect.py" startline="72" endline="84" pcid="7056">
    def config(self) -> appconnect.AppStoreConnectConfig:
        return appconnect.AppStoreConnectConfig(
            type="appStoreConnect",
            id=uuid.uuid4().hex,
            name="Apple App Store Connect",
            appconnectIssuer="abc123" * 6,
            appconnectKey="abc123key",
            appconnectPrivateKey="----BEGIN PRIVATE KEY---- blabla",
            appName="My App",
            appId="123",
            bundleId="com.example.app",
        )

</source>
</class>

<class classid="134" nclones="2" nlines="22" similarity="95">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_app_store_connect.py" startline="172" endline="197" pcid="6083">
    def test_get_persisted_build(self, default_project, config, build):
        seen = datetime(2020, 2, 20)

        AppConnectBuild.objects.create(
            project=default_project,
            app_id=build.app_id,
            bundle_id=config.bundleId,
            platform=build.platform,
            bundle_short_version=build.version,
            bundle_version=build.build_number,
            uploaded_to_appstore=build.uploaded_date,
            first_seen=seen,
            fetched=True,
        )

        existing_build = get_or_create_persisted_build(default_project, config, build)

        assert existing_build.fetched
        assert existing_build.project == default_project
        assert str(existing_build.app_id) == build.app_id
        assert existing_build.bundle_id == config.bundleId
        assert existing_build.platform == build.platform
        assert existing_build.bundle_short_version == build.version
        assert existing_build.bundle_version == build.build_number
        assert existing_build.uploaded_to_appstore == build.uploaded_date

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_app_store_connect.py" startline="199" endline="223" pcid="6084">
    def test_get_persisted_build_preserves_existing_fetched(self, default_project, config, build):
        seen = datetime(2020, 2, 20)

        AppConnectBuild.objects.create(
            project=default_project,
            app_id=build.app_id,
            bundle_id=config.bundleId,
            platform=build.platform,
            bundle_short_version=build.version,
            bundle_version=build.build_number,
            uploaded_to_appstore=build.uploaded_date,
            first_seen=seen,
            fetched=False,
        )

        existing_build = get_or_create_persisted_build(default_project, config, build)

        assert not existing_build.fetched
        assert existing_build.project == default_project
        assert str(existing_build.app_id) == build.app_id
        assert existing_build.bundle_id == config.bundleId
        assert existing_build.platform == build.platform
        assert existing_build.bundle_short_version == build.version
        assert existing_build.bundle_version == build.build_number
        assert existing_build.uploaded_to_appstore == build.uploaded_date
</source>
</class>

<class classid="135" nclones="3" nlines="17" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="134" endline="161" pcid="6099">
def test_process_event_mutate_and_save(
    default_project, mock_event_processing_store, mock_save_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)

    data = {
        "project": default_project.id,
        "platform": "mattlang",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    mock_event_processing_store.get.return_value = data
    mock_event_processing_store.store.return_value = "e:1"

    process_event(cache_key="e:1", start_time=1)

    # The event mutated, so make sure we save it back
    ((_, (event,), _),) = mock_event_processing_store.store.mock_calls

    assert "extra" not in event

    mock_save_event.delay.assert_called_once_with(
        cache_key="e:1", data=None, start_time=1, event_id=EVENT_ID, project_id=default_project.id
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="189" endline="214" pcid="6101">
def test_process_event_unprocessed(
    default_project, mock_event_processing_store, mock_save_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)

    data = {
        "project": default_project.id,
        "platform": "holdmeclose",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    mock_event_processing_store.get.return_value = data
    mock_event_processing_store.store.return_value = "e:1"

    process_event(cache_key="e:1", start_time=1)

    ((_, (event,), _),) = mock_event_processing_store.store.mock_calls
    assert event["unprocessed"] is True

    mock_save_event.delay.assert_called_once_with(
        cache_key="e:1", data=None, start_time=1, event_id=EVENT_ID, project_id=default_project.id
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="163" endline="187" pcid="6100">
def test_process_event_no_mutate_and_save(
    default_project, mock_event_processing_store, mock_save_event, register_plugin
):
    register_plugin(globals(), BasicPreprocessorPlugin)

    data = {
        "project": default_project.id,
        "platform": "noop",
        "logentry": {"formatted": "test"},
        "event_id": EVENT_ID,
        "extra": {"foo": "bar"},
    }

    mock_event_processing_store.get.return_value = data

    process_event(cache_key="e:1", start_time=1)

    # The event did not mutate, so we shouldn't reset it in cache
    assert mock_event_processing_store.store.call_count == 0

    mock_save_event.delay.assert_called_once_with(
        cache_key="e:1", data=None, start_time=1, event_id=EVENT_ID, project_id=default_project.id
    )


</source>
</class>

<class classid="136" nclones="2" nlines="27" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/ingest/ingest_consumer/test_ingest_consumer_processing.py" startline="262" endline="304" pcid="6120">
def test_userreport(default_project, monkeypatch):
    """
    Test that user_report-type kafka messages end up in a user report being
    persisted. We additionally test some logic around upserting data in
    eventuser which is also present in the legacy endpoint.
    """
    event_id = uuid.uuid4().hex
    start_time = time.time() - 3600

    mgr = EventManager(data={"event_id": event_id, "user": {"email": "markus+dontatme@sentry.io"}})

    mgr.normalize()
    mgr.save(default_project.id)

    (evtuser,) = EventUser.objects.all()
    assert not evtuser.name

    assert not UserReport.objects.all()

    assert process_userreport(
        {
            "type": "user_report",
            "start_time": start_time,
            "payload": json.dumps(
                {
                    "name": "Hans Gans",
                    "event_id": event_id,
                    "comments": "hello world",
                    "email": "markus+dontatme@sentry.io",
                }
            ),
            "project_id": default_project.id,
        },
        projects={default_project.id: default_project},
    )

    (report,) = UserReport.objects.all()
    assert report.comments == "hello world"

    (evtuser,) = EventUser.objects.all()
    assert evtuser.name == "Hans Gans"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/ingest/ingest_consumer/test_ingest_consumer_processing.py" startline="306" endline="345" pcid="6121">
def test_userreport_reverse_order(default_project, monkeypatch):
    """
    Test that ingesting a userreport before the event works. This is relevant
    for unreal crashes where the userreport is processed immediately in the
    ingest consumer while the rest of the event goes to processing tasks.
    """
    event_id = uuid.uuid4().hex
    start_time = time.time() - 3600

    assert process_userreport(
        {
            "type": "user_report",
            "start_time": start_time,
            "payload": json.dumps(
                {
                    "name": "Hans Gans",
                    "event_id": event_id,
                    "comments": "hello world",
                    "email": "markus+dontatme@sentry.io",
                }
            ),
            "project_id": default_project.id,
        },
        projects={default_project.id: default_project},
    )

    mgr = EventManager(data={"event_id": event_id, "user": {"email": "markus+dontatme@sentry.io"}})

    mgr.normalize()
    mgr.save(default_project.id)

    (report,) = UserReport.objects.all()
    assert report.comments == "hello world"

    (evtuser,) = EventUser.objects.all()
    # Event got saved after user report, and the sync only works in the
    # opposite direction. That's fine, we just accept it.
    assert evtuser.name is None


</source>
</class>

<class classid="137" nclones="8" nlines="24" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="69" endline="96" pcid="6150">
    def test_issue_by_tag_batched(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [self.project.id], "group": self.event.group_id, "key": "foo"},
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header, raw1, raw2 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"value,times_seen,last_seen,first_seen"

        raw1, raw2 = sorted([raw1, raw2])
        assert raw1.startswith(b"bar,1,")
        assert raw2.startswith(b"bar2,2,")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="98" endline="128" pcid="6151">
    def test_no_error_on_retry(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [self.project.id], "group": self.event.group_id, "key": "foo"},
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
            # rerunning the export should not be problematic and produce the same results
            # this can happen when a batch is interrupted and has to be retried
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header, raw1, raw2 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"value,times_seen,last_seen,first_seen"

        raw1, raw2 = sorted([raw1, raw2])
        assert raw1.startswith(b"bar,1,")
        assert raw2.startswith(b"bar2,2,")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="200" endline="227" pcid="6156">
    def test_discover_batched(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header, raw1, raw2, raw3 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"title"

        assert raw1.startswith(b"<unlabeled event>")
        assert raw2.startswith(b"<unlabeled event>")
        assert raw3.startswith(b"<unlabeled event>")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="358" endline="385" pcid="6162">
    def test_discover_export_too_many_rows(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )
        with self.tasks():
            assemble_download(de.id, export_limit=2)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        # capping MAX_FILE_SIZE forces the last batch to be dropped, leaving 2 rows
        header, raw1, raw2 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"title"

        assert raw1.startswith(b"<unlabeled event>")
        assert raw2.startswith(b"<unlabeled event>")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="329" endline="356" pcid="6161">
    def test_discover_export_file_too_large(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        # capping MAX_FILE_SIZE forces the last batch to be dropped, leaving 2 rows
        header, raw1, raw2 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"title"

        assert raw1.startswith(b"<unlabeled event>")
        assert raw2.startswith(b"<unlabeled event>")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="171" endline="198" pcid="6155">
    def test_issue_by_tag_outside_retention(self, emailer, mock_query, mock_get_tag_key):
        """
        When an issues by tag query goes outside the retention range, it returns 0 results.
        This gives us an empty CSV with just the headers.
        """
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [self.project.id], "group": self.event.group_id, "key": "foo"},
        )

        mock_query.side_effect = QueryOutsideRetentionError("test")
        with self.tasks():
            assemble_download(de.id)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header = file.getfile().read().strip()
        assert header == b"value,times_seen,last_seen,first_seen"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="229" endline="260" pcid="6157">
    def test_discover_respects_selected_environment(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={
                "project": [self.project.id],
                "environment": "prod",
                "field": ["title"],
                "query": "",
            },
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header, raw1, raw2 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"title"

        assert raw1.startswith(b"<unlabeled event>")
        assert raw2.startswith(b"<unlabeled event>")

        assert emailer.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="262" endline="294" pcid="6158">
    def test_discover_respects_selected_environment_multiple(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={
                "project": [self.project.id],
                "environment": ["prod", "dev"],
                "field": ["title"],
                "query": "",
            },
        )
        with self.tasks():
            assemble_download(de.id, batch_size=1)
        de = ExportedData.objects.get(id=de.id)
        assert de.date_finished is not None
        assert de.date_expired is not None
        assert de.file_id is not None
        assert isinstance(de._get_file(), File)
        file = de._get_file()
        assert file.headers == {"Content-Type": "text/csv"}
        assert file.size is not None
        assert file.checksum is not None
        # Convert raw csv to list of line-strings
        header, raw1, raw2, raw3 = file.getfile().read().strip().split(b"\r\n")
        assert header == b"title"

        assert raw1.startswith(b"<unlabeled event>")
        assert raw2.startswith(b"<unlabeled event>")
        assert raw3.startswith(b"<unlabeled event>")

        assert emailer.called

</source>
</class>

<class classid="138" nclones="7" nlines="12" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="130" endline="141" pcid="6152">
    def test_issue_by_tag_missing_key(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [self.project.id], "group": self.event.group_id, "key": "bar"},
        )
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Requested key does not exist"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="562" endline="574" pcid="6167">
    def test_discover_integrity_error(self, emailer, finalize_upload):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )
        finalize_upload.side_effect = IntegrityError("test")
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Failed to save the assembled file."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="156" endline="167" pcid="6154">
    def test_issue_by_tag_missing_issue(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [self.project.id], "group": -1, "key": "user"},
        )
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Requested issue does not exist"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="314" endline="325" pcid="6160">
    def test_discover_missing_project(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [-1], "group": self.event.group_id, "key": "user"},
        )
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Requested project does not exist"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="143" endline="154" pcid="6153">
    def test_issue_by_tag_missing_project(self, emailer):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.ISSUES_BY_TAG,
            query_info={"project": [-1], "group": self.event.group_id, "key": "user"},
        )
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Requested project does not exist"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="415" endline="435" pcid="6164">
    def test_discover_invalid_search_query(self, emailer, mock_query):
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )

        mock_query.side_effect = InvalidSearchQuery("test")
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Invalid query. Please fix the query and try again."

        # unicode
        mock_query.side_effect = InvalidSearchQuery("\xfc")
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Invalid query. Please fix the query and try again."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/test_tasks.py" startline="388" endline="412" pcid="6163">
    def test_discover_outside_retention(self, emailer, mock_query):
        """
        When a discover query goes outside the retention range, email the user they should
        use a more recent date range.
        """
        de = ExportedData.objects.create(
            user=self.user,
            organization=self.org,
            query_type=ExportQueryType.DISCOVER,
            query_info={"project": [self.project.id], "field": ["title"], "query": ""},
        )

        mock_query.side_effect = QueryOutsideRetentionError("test")
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Invalid date range. Please try a more recent date range."

        # unicode
        mock_query.side_effect = QueryOutsideRetentionError("\xfc")
        with self.tasks():
            assemble_download(de.id)
        error = emailer.call_args[1]["message"]
        assert error == "Invalid date range. Please try a more recent date range."

</source>
</class>

<class classid="139" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export_details.py" startline="47" endline="59" pcid="6175">
    def test_valid(self):
        self.data_export.update(
            date_finished=timezone.now() - timedelta(weeks=2),
            date_expired=timezone.now() + timedelta(weeks=1),
        )
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.organization.slug, self.data_export.id)
        assert response.data["dateFinished"] is not None
        assert response.data["dateFinished"] == self.data_export.date_finished
        assert response.data["dateExpired"] is not None
        assert response.data["dateExpired"] == self.data_export.date_expired
        assert response.data["status"] == ExportStatus.Valid

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export_details.py" startline="60" endline="72" pcid="6176">
    def test_expired(self):
        self.data_export.update(
            date_finished=timezone.now() - timedelta(weeks=2),
            date_expired=timezone.now() - timedelta(weeks=1),
        )
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.organization.slug, self.data_export.id)
        assert response.data["dateFinished"] is not None
        assert response.data["dateFinished"] == self.data_export.date_finished
        assert response.data["dateExpired"] is not None
        assert response.data["dateExpired"] == self.data_export.date_expired
        assert response.data["status"] == ExportStatus.Expired

</source>
</class>

<class classid="140" nclones="2" nlines="24" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export.py" startline="62" endline="89" pcid="6183">
    def test_new_export(self):
        """
        Ensures that a request to this endpoint returns a 201 status code
        and an appropriate response object
        """
        payload = self.make_payload("issue")
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.org.slug, status_code=201, **payload)
        data_export = ExportedData.objects.get(id=response.data["id"])
        assert response.data == {
            "id": data_export.id,
            "user": {
                "id": str(self.user.id),
                "email": self.user.email,
                "username": self.user.username,
            },
            "dateCreated": data_export.date_added,
            "dateFinished": None,
            "dateExpired": None,
            "query": {
                "type": payload["query_type"],
                "info": payload["query_info"],
            },
            "status": ExportStatus.Early,
            "checksum": None,
            "fileName": None,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export.py" startline="90" endline="119" pcid="6184">
    def test_progress_export(self):
        """
        Checks to make sure that identical requests (same payload, organization, user)
        are routed to the same ExportedData object, with a 200 status code
        """
        payload = self.make_payload("issue")
        with self.feature("organizations:discover-query"):
            response1 = self.get_response(self.org.slug, **payload)
        data_export = ExportedData.objects.get(id=response1.data["id"])
        with self.feature("organizations:discover-query"):
            response2 = self.get_valid_response(self.org.slug, **payload)
        assert response2.data == {
            "id": data_export.id,
            "user": {
                "id": str(self.user.id),
                "email": self.user.email,
                "username": self.user.username,
            },
            "dateCreated": data_export.date_added,
            "dateFinished": data_export.date_finished,
            "dateExpired": data_export.date_expired,
            "query": {
                "type": ExportQueryType.as_str(data_export.query_type),
                "info": data_export.query_info,
            },
            "status": data_export.status,
            "checksum": None,
            "fileName": None,
        }

</source>
</class>

<class classid="141" nclones="3" nlines="13" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export.py" startline="215" endline="233" pcid="6191">
    def test_converts_stats_period(self):
        """
        Ensures that statsPeriod is converted to start/end.
        """
        payload = self.make_payload("discover", {"statsPeriod": "24h"})
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.org.slug, status_code=201, **payload)
        data_export = ExportedData.objects.get(id=response.data["id"])
        query_info = data_export.query_info
        assert parse_datetime_string(query_info["start"]) == parse_datetime_string(
            "2020-05-18T14:00:00"
        )
        assert parse_datetime_string(query_info["end"]) == parse_datetime_string(
            "2020-05-19T14:00:00"
        )
        assert "statsPeriod" not in query_info
        assert "statsPeriodStart" not in query_info
        assert "statsPeriodSEnd" not in query_info

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export.py" startline="235" endline="253" pcid="6192">
    def test_converts_stats_period_start_end(self):
        """
        Ensures that statsPeriodStart and statsPeriodEnd is converted to start/end.
        """
        payload = self.make_payload("discover", {"statsPeriodStart": "1w", "statsPeriodEnd": "5d"})
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.org.slug, status_code=201, **payload)
        data_export = ExportedData.objects.get(id=response.data["id"])
        query_info = data_export.query_info
        assert parse_datetime_string(query_info["start"]) == parse_datetime_string(
            "2020-05-12T14:00:00"
        )
        assert parse_datetime_string(query_info["end"]) == parse_datetime_string(
            "2020-05-14T14:00:00"
        )
        assert "statsPeriod" not in query_info
        assert "statsPeriodStart" not in query_info
        assert "statsPeriodSEnd" not in query_info

</source>
<source file="systems/sentry-22.2.0/tests/sentry/data_export/endpoints/test_data_export.py" startline="254" endline="274" pcid="6193">
    def test_preserves_start_end(self):
        """
        Ensures that start/end is preserved
        """
        payload = self.make_payload(
            "discover", {"start": "2020-05-18T14:00:00", "end": "2020-05-19T14:00:00"}
        )
        with self.feature("organizations:discover-query"):
            response = self.get_valid_response(self.org.slug, status_code=201, **payload)
        data_export = ExportedData.objects.get(id=response.data["id"])
        query_info = data_export.query_info
        assert parse_datetime_string(query_info["start"]) == parse_datetime_string(
            "2020-05-18T14:00:00"
        )
        assert parse_datetime_string(query_info["end"]) == parse_datetime_string(
            "2020-05-19T14:00:00"
        )
        assert "statsPeriod" not in query_info
        assert "statsPeriodStart" not in query_info
        assert "statsPeriodSEnd" not in query_info

</source>
</class>

<class classid="142" nclones="2" nlines="12" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_jwt.py" startline="98" endline="112" pcid="6229">
def token() -> str:
    """A JWT token, signed with symmetric key."""
    headers = {
        "alg": "HS256",
        "typ": "JWT",
    }
    claims = {
        "iss": "me",
    }
    key = "secret"
    token = pyjwt.encode(claims, key, algorithm="HS256", headers=headers)
    assert isinstance(token, str)
    return token


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_jwt.py" startline="114" endline="127" pcid="6230">
def rsa_token() -> str:
    """A JWT token, signed with RSA key."""
    headers = {
        "alg": "RS256",
        "typ": "JWT",
    }
    claims = {
        "iss": "me",
    }
    token = pyjwt.encode(claims, RS256_KEY, algorithm="RS256", headers=headers)
    assert isinstance(token, str)
    return token


</source>
</class>

<class classid="143" nclones="2" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_validators.py" startline="4" endline="18" pcid="6300">
def test_is_event_id():
    assert is_event_id("b802415f7531431caa27f5c0bf923302")
    assert is_event_id("B802415F7531431CAA27F5C0BF923302")
    assert is_event_id("b802415f-7531-431c-aa27-f5c0bf923302")
    assert is_event_id("B802415F-7531-431C-AA27-F5C0BF923302")
    assert is_event_id(b"b802415f7531431caa27f5c0bf923302")

    assert not is_event_id("")
    assert not is_event_id("b802415f7531431caa")
    assert not is_event_id("XXXX415f7531431caa27f5c0bf92XXXX")
    assert not is_event_id(4711)
    assert not is_event_id(False)
    assert not is_event_id(None)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_validators.py" startline="47" endline="60" pcid="6302">
def test_is_span_id():
    assert is_span_id("202ab439bb9c4f31")
    assert is_span_id("202AB439BB9C4F31")
    assert is_span_id("202AB439bb9c4f31")
    assert is_span_id(b"202AB439bb9c4f31")

    assert not is_span_id("")
    assert not is_span_id("202a-b439-bb9c-4f31")
    assert not is_span_id("ZZZZZZZZZZZZZZZZ")
    assert not is_span_id("202ab439bb9c4f31AAAAAAAAAA")
    assert not is_span_id("202ab439")
    assert not is_span_id(4711)
    assert not is_span_id(False)
    assert not is_span_id(None)
</source>
</class>

<class classid="144" nclones="3" nlines="15" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_outcomes.py" startline="105" endline="127" pcid="6336">
def test_track_outcome_billing(settings):
    """
    Checks that outcomes are routed to the SHARED topic within the same cluster
    in default configuration.
    """

    track_outcome(
        org_id=1,
        project_id=1,
        key_id=1,
        outcome=Outcome.ACCEPTED,
    )

    cluster_args, _ = kafka_config.get_kafka_producer_cluster_options.call_args
    assert cluster_args == (settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES]["cluster"],)

    assert outcomes.outcomes_publisher
    (topic_name, _), _ = outcomes.outcomes_publisher.publish.call_args
    assert topic_name == settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES]["topic"]

    assert outcomes.billing_publisher is None


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_outcomes.py" startline="128" endline="155" pcid="6337">
def test_track_outcome_billing_topic(settings):
    """
    Checks that outcomes are routed to the DEDICATED billing topic within the
    same cluster in default configuration.
    """

    settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES_BILLING] = {
        "cluster": settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES]["cluster"],
        "topic": "new-topic",
    }

    track_outcome(
        org_id=1,
        project_id=1,
        key_id=1,
        outcome=Outcome.ACCEPTED,
    )

    cluster_args, _ = kafka_config.get_kafka_producer_cluster_options.call_args
    assert cluster_args == (settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES]["cluster"],)

    assert outcomes.outcomes_publisher
    (topic_name, _), _ = outcomes.outcomes_publisher.publish.call_args
    assert topic_name == "new-topic"

    assert outcomes.billing_publisher is None


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_outcomes.py" startline="156" endline="180" pcid="6338">
def test_track_outcome_billing_cluster(settings):
    """
    Checks that outcomes are routed to the dedicated cluster and topic.
    """

    settings.KAFKA_TOPICS[settings.KAFKA_OUTCOMES_BILLING] = {
        "cluster": "different",
        "topic": "new-topic",
    }

    track_outcome(
        org_id=1,
        project_id=1,
        key_id=1,
        outcome=Outcome.ACCEPTED,
    )

    cluster_args, _ = kafka_config.get_kafka_producer_cluster_options.call_args
    assert cluster_args == ("different",)

    assert outcomes.billing_publisher
    (topic_name, _), _ = outcomes.billing_publisher.publish.call_args
    assert topic_name == "new-topic"

    assert outcomes.outcomes_publisher is None
</source>
</class>

<class classid="145" nclones="2" nlines="18" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="153" endline="179" pcid="6344">
    def test_dsyms_needed(
        self,
        mocked_list_builds_api: Optional[responses_mod.RequestsMock],
        api_credentials: appstore_connect.AppConnectCredentials,
        app_id: str,
    ) -> None:
        session = requests.Session()

        # Be sure to consume the entire ``builds`` iterator, otherwise the
        # responses.RequestsMock will be unhappy that not all calls were made.
        builds = list(
            appstore_connect.get_build_info(session, api_credentials, app_id, include_expired=True)
        )

        found_build = None

        for build in builds:
            if build.build_number == "332":
                found_build = build
                break

        assert found_build is not None
        assert found_build.build_number == "332"
        assert isinstance(found_build.dsym_url, str)
        assert found_build.dsym_url.startswith("http://iosapps.itunes.apple.com/itunes-assets/")
        assert "accessKey=" in found_build.dsym_url

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="180" endline="204" pcid="6345">
    def test_no_dsyms_needed(
        self,
        mocked_list_builds_api: Optional[responses_mod.RequestsMock],
        api_credentials: appstore_connect.AppConnectCredentials,
        app_id: str,
    ) -> None:
        session = requests.Session()

        # Be sure to consume the entire ``builds`` iterator, otherwise the
        # responses.RequestsMock will be unhappy that not all calls were made.
        builds = list(
            appstore_connect.get_build_info(session, api_credentials, app_id, include_expired=True)
        )

        found_build = None
        for build in builds:
            if build.build_number == "333":
                found_build = build
                break

        assert found_build is not None
        assert found_build.build_number == "333"
        assert found_build.dsym_url is appstore_connect.NoDsymUrl.NOT_NEEDED


</source>
</class>

<class classid="146" nclones="3" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="212" endline="226" pcid="6348">
    def test_one_bundle_strange_url(self) -> None:
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": 1,
                },
            }
        ]

        with pytest.raises(ValueError):
            appstore_connect._get_dsym_url(bundles)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="241" endline="255" pcid="6350">
    def test_one_bundle_has_url(self) -> None:
        url = "http://iosapps.itunes.apple.com/itunes-assets/very-real-url"
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": url,
                },
            }
        ]

        assert appstore_connect._get_dsym_url(bundles) == url

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="227" endline="240" pcid="6349">
    def test_one_bundle_no_url(self) -> None:
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            }
        ]

        assert appstore_connect._get_dsym_url(bundles) is NoDsymUrl.NOT_NEEDED

</source>
</class>

<class classid="147" nclones="6" nlines="21" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="256" endline="277" pcid="6351">
    def test_multi_bundle_no_url(self) -> None:
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            },
            {
                "type": "buildBundles",
                "id": "5e231f58-31c6-47cc-b4f8-56952d44a158",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            },
        ]

        assert appstore_connect._get_dsym_url(bundles) is NoDsymUrl.NOT_NEEDED

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="278" endline="303" pcid="6352">
    def test_multi_bundle_has_url(self) -> None:
        first_url = "http://iosapps.itunes.apple.com/itunes-assets/very-real-url"
        second_url = "http://iosapps.itunes.apple.com/itunes-assets/very-fake-url"
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": first_url,
                },
            },
            {
                "type": "buildBundles",
                "id": "5e231f58-31c6-47cc-b4f8-56952d44a158",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": second_url,
                },
            },
        ]
        assert appstore_connect._get_dsym_url(bundles) == first_url

        bundles.reverse()
        assert appstore_connect._get_dsym_url(bundles) == second_url

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="354" endline="378" pcid="6355">
    def test_multi_bundle_appclip_has_urls(self) -> None:
        url = "http://iosapps.itunes.apple.com/itunes-assets/very-real-url"
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": url,
                },
            },
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-1227886b7fbc",
                "attributes": {
                    "bundleType": "APP_CLIP",
                    "dSYMUrl": url,
                },
            },
        ]

        with mock.patch("sentry_sdk.capture_message") as capture_message:
            assert appstore_connect._get_dsym_url(bundles) == url
            assert capture_message.call_count == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="330" endline="353" pcid="6354">
    def test_multi_bundle_appclip_no_urls(self) -> None:
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            },
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-1227886b7fbc",
                "attributes": {
                    "bundleType": "APP_CLIP",
                    "dSYMUrl": None,
                },
            },
        ]

        with mock.patch("sentry_sdk.capture_message") as capture_message:
            assert appstore_connect._get_dsym_url(bundles) is NoDsymUrl.NOT_NEEDED
            assert capture_message.call_count == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="304" endline="329" pcid="6353">
    def test_multi_bundle_mixed_urls(self) -> None:
        url = "http://iosapps.itunes.apple.com/itunes-assets/very-real-url"
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": url,
                },
            },
            {
                "type": "buildBundles",
                "id": "5e231f58-31c6-47cc-b4f8-56952d44a158",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            },
        ]

        assert appstore_connect._get_dsym_url(bundles) == url

        bundles.reverse()
        assert appstore_connect._get_dsym_url(bundles) is NoDsymUrl.NOT_NEEDED

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/appleconnect/test_appstore_connect.py" startline="379" endline="402" pcid="6356">
    def test_multi_bundle_appclip_mixed_clip_no_url(self) -> None:
        url = "http://iosapps.itunes.apple.com/itunes-assets/very-real-url"
        bundles = [
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-0116775a6eab",
                "attributes": {
                    "bundleType": "APP",
                    "dSYMUrl": None,
                },
            },
            {
                "type": "buildBundles",
                "id": "59467f37-371e-4755-afcd-1227886b7fbc",
                "attributes": {
                    "bundleType": "APP_CLIP",
                    "dSYMUrl": url,
                },
            },
        ]

        with mock.patch("sentry_sdk.capture_message") as capture_message:
            assert appstore_connect._get_dsym_url(bundles) is NoDsymUrl.NOT_NEEDED
            assert capture_message.call_count == 1
</source>
</class>

<class classid="148" nclones="2" nlines="132" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_numbers.py" startline="11" endline="145" pcid="6366">
def test_base36():
    assert [base36_encode(x) for x in range(128)] == [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "1A",
        "1B",
        "1C",
        "1D",
        "1E",
        "1F",
        "1G",
        "1H",
        "1I",
        "1J",
        "1K",
        "1L",
        "1M",
        "1N",
        "1O",
        "1P",
        "1Q",
        "1R",
        "1S",
        "1T",
        "1U",
        "1V",
        "1W",
        "1X",
        "1Y",
        "1Z",
        "20",
        "21",
        "22",
        "23",
        "24",
        "25",
        "26",
        "27",
        "28",
        "29",
        "2A",
        "2B",
        "2C",
        "2D",
        "2E",
        "2F",
        "2G",
        "2H",
        "2I",
        "2J",
        "2K",
        "2L",
        "2M",
        "2N",
        "2O",
        "2P",
        "2Q",
        "2R",
        "2S",
        "2T",
        "2U",
        "2V",
        "2W",
        "2X",
        "2Y",
        "2Z",
        "30",
        "31",
        "32",
        "33",
        "34",
        "35",
        "36",
        "37",
        "38",
        "39",
        "3A",
        "3B",
        "3C",
        "3D",
        "3E",
        "3F",
        "3G",
        "3H",
        "3I",
        "3J",
    ]

    assert [base36_decode(base36_encode(x)) for x in range(128)] == list(range(128))


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_numbers.py" startline="146" endline="280" pcid="6367">
def test_base32():
    assert [base32_encode(x) for x in range(128)] == [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "J",
        "K",
        "M",
        "N",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "1A",
        "1B",
        "1C",
        "1D",
        "1E",
        "1F",
        "1G",
        "1H",
        "1J",
        "1K",
        "1M",
        "1N",
        "1P",
        "1Q",
        "1R",
        "1S",
        "1T",
        "1V",
        "1W",
        "1X",
        "1Y",
        "1Z",
        "20",
        "21",
        "22",
        "23",
        "24",
        "25",
        "26",
        "27",
        "28",
        "29",
        "2A",
        "2B",
        "2C",
        "2D",
        "2E",
        "2F",
        "2G",
        "2H",
        "2J",
        "2K",
        "2M",
        "2N",
        "2P",
        "2Q",
        "2R",
        "2S",
        "2T",
        "2V",
        "2W",
        "2X",
        "2Y",
        "2Z",
        "30",
        "31",
        "32",
        "33",
        "34",
        "35",
        "36",
        "37",
        "38",
        "39",
        "3A",
        "3B",
        "3C",
        "3D",
        "3E",
        "3F",
        "3G",
        "3H",
        "3J",
        "3K",
        "3M",
        "3N",
        "3P",
        "3Q",
        "3R",
        "3S",
        "3T",
        "3V",
        "3W",
        "3X",
        "3Y",
        "3Z",
    ]

    assert [base32_decode(base32_encode(x)) for x in range(128)] == list(range(128))


</source>
</class>

<class classid="149" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_concurrent.py" startline="26" endline="45" pcid="6371">
def test_future_set_callback_success():
    future_set = FutureSet([Future() for i in range(3)])

    callback = mock.Mock()
    future_set.add_done_callback(callback)

    for i, future in enumerate(list(future_set)):
        assert callback.call_count == 0
        future.set_result(True)

    assert callback.call_count == 1
    assert callback.call_args == mock.call(future_set)

    other_callback = mock.Mock()
    future_set.add_done_callback(other_callback)

    assert other_callback.call_count == 1
    assert other_callback.call_args == mock.call(future_set)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_concurrent.py" startline="46" endline="65" pcid="6372">
def test_future_set_callback_error():
    future_set = FutureSet([Future() for i in range(3)])

    callback = mock.Mock()
    future_set.add_done_callback(callback)

    for i, future in enumerate(list(future_set)):
        assert callback.call_count == 0
        future.set_exception(Exception)

    assert callback.call_count == 1
    assert callback.call_args == mock.call(future_set)

    other_callback = mock.Mock()
    future_set.add_done_callback(other_callback)

    assert other_callback.call_count == 1
    assert other_callback.call_args == mock.call(future_set)


</source>
</class>

<class classid="150" nclones="2" nlines="17" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_concurrent.py" startline="97" endline="122" pcid="6376">
def test_timed_future_success():
    future = TimedFuture()
    assert future.get_timing() == (None, None)

    expected_result = mock.sentinel.RESULT_VALUE
    start_time, finish_time = expected_timing = (1.0, 2.0)

    callback_results = []
    callback = lambda future: callback_results.append((future.result(), future.get_timing()))

    future.add_done_callback(callback)

    with timestamp(start_time):
        future.set_running_or_notify_cancel()
        assert future.get_timing() == (start_time, None)

    assert len(callback_results) == 0

    with timestamp(finish_time):
        future.set_result(expected_result)
        assert future.get_timing() == expected_timing

    assert len(callback_results) == 1
    assert callback_results[0] == (expected_result, expected_timing)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_concurrent.py" startline="142" endline="166" pcid="6378">
def test_timed_future_error():
    future = TimedFuture()
    assert future.get_timing() == (None, None)

    start_time, finish_time = expected_timing = (1.0, 2.0)

    callback_timings = []
    callback = lambda future: callback_timings.append(future.get_timing())

    future.add_done_callback(callback)

    with timestamp(start_time):
        future.set_running_or_notify_cancel()
        assert future.get_timing() == (start_time, None)

    assert len(callback_timings) == 0

    with timestamp(finish_time):
        future.set_exception(None)
        assert future.get_timing() == expected_timing

    assert len(callback_timings) == 1
    assert callback_timings[0] == expected_timing


</source>
</class>

<class classid="151" nclones="5" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/utils/audit/tests.py" startline="61" endline="77" pcid="6402">
    def test_audit_entry_org_delete_log(self):
        entry = create_audit_entry(
            request=self.req,
            organization=self.org,
            target_object=self.org.id,
            event=AuditLogEntryEvent.ORG_REMOVE,
            data=self.org.get_audit_log_data(),
        )

        assert entry.actor == self.user
        assert entry.actor_label == username[:64]  # needs trimming
        assert entry.target_object == self.org.id
        assert entry.event == AuditLogEntryEvent.ORG_REMOVE

        deleted_org = DeletedOrganization.objects.get(slug=self.org.slug)
        self.assert_valid_deleted_log(deleted_org, self.org)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/audit/tests.py" startline="132" endline="147" pcid="6404">
    def test_audit_entry_team_delete_log(self):
        entry = create_audit_entry(
            request=self.req,
            organization=self.org,
            target_object=self.team.id,
            event=AuditLogEntryEvent.TEAM_REMOVE,
            data=self.team.get_audit_log_data(),
        )

        assert entry.actor == self.user
        assert entry.target_object == self.team.id
        assert entry.event == AuditLogEntryEvent.TEAM_REMOVE

        deleted_team = DeletedTeam.objects.get(slug=self.team.slug)
        self.assert_valid_deleted_log(deleted_team, self.team)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/audit/tests.py" startline="148" endline="164" pcid="6405">
    def test_audit_entry_project_delete_log(self):
        entry = create_audit_entry(
            request=self.req,
            organization=self.org,
            target_object=self.project.id,
            event=AuditLogEntryEvent.PROJECT_REMOVE,
            data=self.project.get_audit_log_data(),
        )

        assert entry.actor == self.user
        assert entry.target_object == self.project.id
        assert entry.event == AuditLogEntryEvent.PROJECT_REMOVE

        deleted_project = DeletedProject.objects.get(slug=self.project.slug)
        self.assert_valid_deleted_log(deleted_project, self.project)
        assert deleted_project.platform == self.project.platform

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/audit/tests.py" startline="179" endline="192" pcid="6407">
    def test_audit_entry_project_edit_log_regression(self):
        entry = create_audit_entry(
            request=self.req,
            organization=self.org,
            target_object=self.project.id,
            event=AuditLogEntryEvent.PROJECT_EDIT,
            data={"new_slug": "new"},
        )

        assert entry.actor == self.user
        assert entry.target_object == self.project.id
        assert entry.event == AuditLogEntryEvent.PROJECT_EDIT
        assert entry.get_note() == "edited project settings in new_slug to new"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/audit/tests.py" startline="165" endline="178" pcid="6406">
    def test_audit_entry_project_edit_log(self):
        entry = create_audit_entry(
            request=self.req,
            organization=self.org,
            target_object=self.project.id,
            event=AuditLogEntryEvent.PROJECT_EDIT,
            data={"old_slug": "old", "new_slug": "new"},
        )

        assert entry.actor == self.user
        assert entry.target_object == self.project.id
        assert entry.event == AuditLogEntryEvent.PROJECT_EDIT
        assert entry.get_note() == "renamed project slug from old to new"

</source>
</class>

<class classid="152" nclones="2" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_sentryappwebhookrequests.py" startline="32" endline="45" pcid="6430">
    def test_error_added(self):
        self.buffer.add_request(
            200,
            1,
            "issue.assigned",
            "https://example.com/hook",
            error_id="d5111da2c28645c5889d072017e3445d",
            project_id=1,
        )
        requests = self.buffer.get_requests()
        assert len(requests) == 1
        assert requests[0]["error_id"] == "d5111da2c28645c5889d072017e3445d"
        assert requests[0]["project_id"] == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_sentryappwebhookrequests.py" startline="46" endline="58" pcid="6431">
    def test_error_not_added_if_project_id_missing(self):
        self.buffer.add_request(
            200,
            1,
            "issue.assigned",
            "https://example.com/hook",
            error_id="d5111da2c28645c5889d072017e3445d",
        )
        requests = self.buffer.get_requests()
        assert len(requests) == 1
        assert "error_id" not in requests[0]
        assert "project_id" not in requests[0]

</source>
</class>

<class classid="153" nclones="4" nlines="19" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/utils/email/test_message_builder.py" startline="14" endline="35" pcid="6450">
    def test_raw_content(self):
        msg = MessageBuilder(
            subject="Test",
            body="hello world",
            html_body="<b>hello world</b>",
            headers={"X-Test": "foo"},
        )
        msg.send(["foo@example.com"])

        assert len(mail.outbox) == 1

        out = mail.outbox[0]
        assert out.to == ["foo@example.com"]
        assert out.subject == "Test"
        assert out.extra_headers["X-Test"] == "foo"
        assert out.body == "hello world"
        assert len(out.alternatives) == 1
        assert out.alternatives[0] == (
            "<!DOCTYPE html>\n<html><body><b>hello world</b></body></html>",
            "text/html",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/email/test_message_builder.py" startline="130" endline="153" pcid="6455">
    def test_message_id(self, make_msgid):
        make_msgid.return_value = "abc123"

        msg = MessageBuilder(
            subject="Test",
            body="hello world",
            html_body="<b>hello world</b>",
            reference=self.activity,
        )
        msg.send(["foo@example.com"])

        assert len(mail.outbox) == 1

        out = mail.outbox[0]
        assert out.to == ["foo@example.com"]
        assert out.subject == "Test"
        assert out.extra_headers["Message-Id"] == "abc123"
        assert out.body == "hello world"
        assert len(out.alternatives) == 1
        assert out.alternatives[0] == (
            "<!DOCTYPE html>\n<html><body><b>hello world</b></body></html>",
            "text/html",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/email/test_message_builder.py" startline="36" endline="57" pcid="6451">
    def test_inline_css(self):
        msg = MessageBuilder(
            subject="Test",
            body="hello world",
            html_body="<head><style type='text/css'>h1 { color: red; }</style></head><h1>foobar</h1><h2><b>hello world</b></h2>",
            headers={"X-Test": "foo"},
        )
        msg.send(["foo@example.com"])

        assert len(mail.outbox) == 1

        out = mail.outbox[0]
        assert out.to == ["foo@example.com"]
        assert out.subject == "Test"
        assert out.extra_headers["X-Test"] == "foo"
        assert out.body == "hello world"
        assert len(out.alternatives) == 1
        assert out.alternatives[0] == (
            '<!DOCTYPE html>\n<html><head></head><body><h1 style="color: red">foobar</h1><h2><b>hello world</b></h2></body></html>',
            "text/html",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/email/test_message_builder.py" startline="58" endline="79" pcid="6452">
    def test_explicit_reply_to(self):
        msg = MessageBuilder(
            subject="Test",
            body="hello world",
            html_body="<b>hello world</b>",
            headers={"X-Sentry-Reply-To": "bar@example.com"},
        )
        msg.send(["foo@example.com"])

        assert len(mail.outbox) == 1

        out = mail.outbox[0]
        assert out.to == ["foo@example.com"]
        assert out.subject == "Test"
        assert out.extra_headers["Reply-To"] == "bar@example.com"
        assert out.body == "hello world"
        assert len(out.alternatives) == 1
        assert out.alternatives[0] == (
            "<!DOCTYPE html>\n<html><body><b>hello world</b></body></html>",
            "text/html",
        )

</source>
</class>

<class classid="154" nclones="2" nlines="12" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/utils/http/tests.py" startline="209" endline="222" pcid="6518">
    def test_punycode(self):
        result = self.isValidOrigin("http://xn--lcalhost-54a", ["*.l\xf8calhost"])
        assert result is True
        result = self.isValidOrigin("http://xn--lcalhost-54a", ["*.xn--lcalhost-54a"])
        assert result is True
        result = self.isValidOrigin("http://l\xf8calhost", ["*.xn--lcalhost-54a"])
        assert result is True
        result = self.isValidOrigin(b"http://l\xc3\xb8calhost", ["*.xn--lcalhost-54a"])
        assert result is True
        result = self.isValidOrigin("http://xn--lcalhost-54a", ["l\xf8calhost"])
        assert result is True
        result = self.isValidOrigin("http://xn--lcalhost-54a:80", ["l\xf8calhost:80"])
        assert result is True

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/http/tests.py" startline="231" endline="243" pcid="6521">
    def test_without_hostname(self):
        result = self.isValidOrigin("foo://", ["foo://*"])
        assert result is True
        result = self.isValidOrigin("foo://", ["foo://"])
        assert result is True
        result = self.isValidOrigin("foo://", ["example.com"])
        assert result is False
        result = self.isValidOrigin("foo://a", ["foo://"])
        assert result is False
        result = self.isValidOrigin("foo://a", ["foo://*"])
        assert result is True


</source>
</class>

<class classid="155" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_ratelimits.py" startline="37" endline="50" pcid="6547">
    def test_by_api_token(self):
        token = ApiToken(id=1)
        for n in range(5):
            assert not ratelimits.for_organization_member_invite(
                Organization(id=randint(0, 100000)),
                f"{randint(0, 1000000)}@example.com",
                auth=token,
                config=RELAXED_CONFIG,
            )

        assert ratelimits.for_organization_member_invite(
            Organization(id=1), "anything@example.com", auth=token, config=RELAXED_CONFIG
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_ratelimits.py" startline="51" endline="63" pcid="6548">
    def test_by_user(self):
        user = User(email="biz@example.com")
        for n in range(5):
            assert not ratelimits.for_organization_member_invite(
                Organization(id=randint(0, 100000)),
                f"{randint(0, 1000000)}@example.com",
                user=user,
                config=RELAXED_CONFIG,
            )

        assert ratelimits.for_organization_member_invite(
            Organization(id=1), "anything@example.com", user=user, config=RELAXED_CONFIG
        )
</source>
</class>

<class classid="156" nclones="2" nlines="19" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_kafka_config.py" startline="18" endline="44" pcid="6549">
def test_get_kafka_producer_cluster_options():
    cluster_options = get_kafka_producer_cluster_options("default")
    assert (
        cluster_options["bootstrap.servers"]
        == settings.KAFKA_CLUSTERS["default"]["common"]["bootstrap.servers"]
    )

    with override_settings(
        KAFKA_CLUSTERS={"default": {"producers": {"bootstrap.servers": "my.server:9092"}}}
    ):
        cluster_options = get_kafka_producer_cluster_options("default")
        assert cluster_options["bootstrap.servers"] == "my.server:9092"

    with override_settings(
        KAFKA_CLUSTERS={
            "default": {
                "producers": {"bootstrap.servers": "my.server:9092"},
                "bootstrap.servers": "my.legacy.server:9092",
                "security.protocol": "plain",  # legacy config
            }
        }
    ):
        cluster_options = get_kafka_producer_cluster_options("default")
        assert cluster_options["bootstrap.servers"] == "my.legacy.server:9092"
        assert cluster_options["security.protocol"] == "plain"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/utils/test_kafka_config.py" startline="45" endline="72" pcid="6550">
def test_get_kafka_consumer_cluster_options():
    cluster_options = get_kafka_consumer_cluster_options("default")
    assert (
        cluster_options["bootstrap.servers"]
        == settings.KAFKA_CLUSTERS["default"]["common"]["bootstrap.servers"]
    )

    with override_settings(
        KAFKA_CLUSTERS={"default": {"consumers": {"bootstrap.servers": "my.other.server:9092"}}}
    ):
        cluster_options = get_kafka_consumer_cluster_options("default")
        assert cluster_options["bootstrap.servers"] == "my.other.server:9092"

    with override_settings(
        KAFKA_CLUSTERS={
            "default": {
                "consumers": {"bootstrap.servers": "my.other.server:9092"},
                # legacy config:
                "security.protocol": "plain",
                "bootstrap.servers": "my.legacy.server:9092",
            }
        }
    ):
        cluster_options = get_kafka_consumer_cluster_options("default")
        assert cluster_options["bootstrap.servers"] == "my.legacy.server:9092"
        assert "security.protocol" not in cluster_options


</source>
</class>

<class classid="157" nclones="2" nlines="11" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_index.py" startline="39" endline="53" pcid="6578">
    def test_filter_status(self):
        self.create_team(organization=self.organization, members=[self.user])
        incident = self.create_incident()
        closed_incident = self.create_incident(status=IncidentStatus.CLOSED.value)
        self.login_as(self.user)

        with self.feature(["organizations:incidents", "organizations:performance-view"]):
            resp_closed = self.get_valid_response(self.organization.slug, status="closed")
            resp_open = self.get_valid_response(self.organization.slug, status="open")

        assert len(resp_closed.data) == 1
        assert len(resp_open.data) == 1
        assert resp_closed.data == serialize([closed_incident])
        assert resp_open.data == serialize([incident])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_index.py" startline="130" endline="142" pcid="6583">
    def test_filter_name(self):
        self.create_team(organization=self.organization, members=[self.user])
        incident = self.create_incident(title="yet another alert rule")
        self.login_as(self.user)

        with self.feature(["organizations:incidents", "organizations:performance-view"]):
            results = self.get_valid_response(self.organization.slug, title="yet")
            no_results = self.get_valid_response(self.organization.slug, title="no results")

        assert len(results.data) == 1
        assert len(no_results.data) == 0
        assert results.data == serialize([incident])

</source>
</class>

<class classid="158" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_index.py" startline="69" endline="80" pcid="6624">
    def test_access(self):
        other_user = self.create_user()
        self.login_as(other_user)
        other_team = self.create_team()
        self.create_member(
            user=self.user, organization=self.organization, role="member", teams=[self.team]
        )
        other_project = self.create_project(teams=[other_team])
        incident = self.create_incident(projects=[other_project])
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, incident.identifier, comment="hi")
            assert resp.status_code == 403
</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_subscription_index.py" startline="23" endline="36" pcid="6664">
    def test_access(self):
        other_user = self.create_user()
        self.login_as(other_user)
        other_team = self.create_team()
        self.create_member(
            user=self.user, organization=self.organization, role="member", teams=[self.team]
        )
        other_project = self.create_project(teams=[other_team])
        incident = self.create_incident(projects=[other_project])
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, incident.identifier, comment="hi")
            assert resp.status_code == 403


</source>
</class>

<class classid="159" nclones="3" nlines="21" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_index.py" startline="172" endline="196" pcid="6636">
    def test_no_label(self):
        rule_one_trigger_no_label = {
            "aggregate": "count()",
            "query": "",
            "timeWindow": "300",
            "projects": [self.project.slug],
            "name": "OneTriggerOnlyCritical",
            "owner": self.user.id,
            "resolveThreshold": 100,
            "thresholdType": 1,
            "triggers": [
                {
                    "alertThreshold": 200,
                    "actions": [
                        {"type": "email", "targetType": "team", "targetIdentifier": self.team.id}
                    ],
                }
            ],
        }

        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug, status_code=400, **rule_one_trigger_no_label
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_index.py" startline="197" endline="224" pcid="6637">
    def test_only_critical_trigger(self):
        rule_one_trigger_only_critical = {
            "aggregate": "count()",
            "query": "",
            "timeWindow": "300",
            "projects": [self.project.slug],
            "name": "OneTriggerOnlyCritical",
            "owner": self.user.id,
            "resolveThreshold": 200,
            "thresholdType": 1,
            "triggers": [
                {
                    "label": "critical",
                    "alertThreshold": 100,
                    "actions": [
                        {"type": "email", "targetType": "team", "targetIdentifier": self.team.id}
                    ],
                }
            ],
        }
        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, status_code=201, **rule_one_trigger_only_critical
            )
        assert "id" in resp.data
        alert_rule = AlertRule.objects.get(id=resp.data["id"])
        assert resp.data == serialize(alert_rule, self.user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_index.py" startline="242" endline="268" pcid="6639">
    def test_no_critical_trigger(self):
        rule_one_trigger_only_warning = {
            "aggregate": "count()",
            "query": "",
            "timeWindow": "300",
            "projects": [self.project.slug],
            "name": "JustATestRule",
            "owner": self.user.id,
            "resolveThreshold": 100,
            "thresholdType": 1,
            "triggers": [
                {
                    "label": "warning",
                    "alertThreshold": 200,
                    "actions": [
                        {"type": "email", "targetType": "team", "targetIdentifier": self.team.id}
                    ],
                }
            ],
        }

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, status_code=400, **rule_one_trigger_only_warning
            )
            assert resp.data == {"nonFieldErrors": ['Trigger 1 must be labeled "critical"']}

</source>
</class>

<class classid="160" nclones="2" nlines="18" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_index.py" startline="269" endline="289" pcid="6640">
    def test_critical_trigger_no_action(self):
        rule_one_trigger_only_critical_no_action = {
            "aggregate": "count()",
            "query": "",
            "timeWindow": "300",
            "projects": [self.project.slug],
            "name": "JustATestRule",
            "owner": self.user.id,
            "resolveThreshold": 100,
            "thresholdType": 1,
            "triggers": [{"label": "critical", "alertThreshold": 75}],
        }

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, status_code=201, **rule_one_trigger_only_critical_no_action
            )
        assert "id" in resp.data
        alert_rule = AlertRule.objects.get(id=resp.data["id"])
        assert resp.data == serialize(alert_rule, self.user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_index.py" startline="334" endline="353" pcid="6644">
    def test_no_owner(self):
        self.login_as(self.user)
        rule_data = {
            "aggregate": "count()",
            "query": "",
            "timeWindow": "300",
            "projects": [self.project.slug],
            "name": "JustATestRule",
            "resolveThreshold": 100,
            "thresholdType": 1,
            "triggers": [{"label": "critical", "alertThreshold": 75}],
        }

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(self.organization.slug, status_code=201, **rule_data)
        assert "id" in resp.data
        alert_rule = AlertRule.objects.get(id=resp.data["id"])
        assert resp.data == serialize(alert_rule, self.user)


</source>
</class>

<class classid="161" nclones="5" nlines="11" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_details.py" startline="41" endline="51" pcid="6672">
    def test_not_found(self):
        comment = "hello"
        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug,
                self.incident.identifier,
                123,
                comment=comment,
                status_code=404,
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_details.py" startline="52" endline="63" pcid="6673">
    def test_non_comment_type(self):
        comment = "hello"
        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug,
                self.incident.identifier,
                self.detected_activity.id,
                comment=comment,
                status_code=404,
            )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_details.py" startline="67" endline="81" pcid="6674">
    def test_simple(self):
        comment = "hello"
        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug,
                self.incident.identifier,
                self.activity.id,
                comment=comment,
                status_code=200,
            )
        activity = IncidentActivity.objects.get(id=self.activity.id)
        assert activity.type == IncidentActivityType.COMMENT.value
        assert activity.user == self.user
        assert activity.comment == comment

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_details.py" startline="130" endline="141" pcid="6679">
    def test_superuser_can_delete(self):
        self.user.is_superuser = True
        self.user.save()

        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug,
                self.incident.identifier,
                self.user2_activity.id,
                status_code=204,
            )
        assert not IncidentActivity.objects.filter(id=self.user2_activity.id).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_details.py" startline="92" endline="110" pcid="6676">
    def test_superuser_can_edit(self):
        self.user.is_superuser = True
        self.user.save()

        edited_comment = "this comment has been edited"

        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug,
                self.incident.identifier,
                self.user2_activity.id,
                comment=edited_comment,
                status_code=200,
            )
        activity = IncidentActivity.objects.get(id=self.user2_activity.id)
        assert activity.user != self.user
        assert activity.comment == edited_comment


</source>
</class>

<class classid="162" nclones="6" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="97" endline="118" pcid="6692">
    def test_simple(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()
        serialized_alert_rule["name"] = "what"

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        alert_rule.name = "what"
        alert_rule.date_modified = resp.data["dateModified"]
        assert resp.data == serialize(alert_rule)
        assert resp.data["name"] == "what"
        assert resp.data["dateModified"] > serialized_alert_rule["dateModified"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="244" endline="265" pcid="6698">
    def test_update_resolve_alert_threshold(self):
        # This is a test to make sure we can remove a resolveThreshold after it has been set.
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        alert_rule.update(resolve_threshold=75)
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        serialized_alert_rule["resolveThreshold"] = 75
        serialized_alert_rule["name"] = "AUniqueName"

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )
        assert resp.data["name"] == "AUniqueName"
        assert resp.data["resolveThreshold"] == 75

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="200" endline="220" pcid="6696">
    def test_update_trigger_alert_threshold(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        serialized_alert_rule["triggers"][1]["alertThreshold"] = 125
        serialized_alert_rule["name"] = "AUniqueName"

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        assert resp.data["name"] == "AUniqueName"
        assert resp.data["triggers"][1]["alertThreshold"] == 125

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="221" endline="243" pcid="6697">
    def test_delete_resolve_alert_threshold(self):
        # This is a test to make sure we can remove a resolveThreshold after it has been set.
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        alert_rule.update(resolve_threshold=75)
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        serialized_alert_rule["resolveThreshold"] = None
        serialized_alert_rule["name"] = "AUniqueName"

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        assert resp.data["name"] == "AUniqueName"
        assert resp.data["resolveThreshold"] is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="378" endline="397" pcid="6704">
    def test_no_owner(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()
        serialized_alert_rule["owner"] = None

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        alert_rule.refresh_from_db()
        assert resp.data == serialize(alert_rule, self.user)
        assert resp.data["owner"] is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="151" endline="175" pcid="6694">
    def test_not_updated_fields(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )

        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        existing_sub = self.alert_rule.snuba_query.subscriptions.first()

        alert_rule.refresh_from_db()
        # Alert rule should be exactly the same
        assert resp.data == serialize(self.alert_rule)
        # If the aggregate changed we'd have a new subscription, validate that
        # it hasn't changed explicitly
        updated_sub = AlertRule.objects.get(id=self.alert_rule.id).snuba_query.subscriptions.first()
        assert updated_sub.subscription_id == existing_sub.subscription_id

</source>
</class>

<class classid="163" nclones="2" nlines="11" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="344" endline="359" pcid="6702">
    def test_invalid_thresholds(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )
        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        serialized_alert_rule["triggers"][0]["alertThreshold"] = 50  # Invalid
        serialized_alert_rule.pop("resolveThreshold")
        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug, alert_rule.id, status_code=400, **serialized_alert_rule
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="360" endline="377" pcid="6703">
    def test_update_snapshot(self):
        self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )
        self.login_as(self.user)
        alert_rule = self.alert_rule
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()

        # Archive the rule so that the endpoint 404's, without this, it should 200 and the test would fail:
        alert_rule.status = AlertRuleStatus.SNAPSHOT.value
        alert_rule.save()

        with self.feature("organizations:incidents"):
            self.get_valid_response(
                self.organization.slug, alert_rule.id, status_code=404, **serialized_alert_rule
            )

</source>
</class>

<class classid="164" nclones="2" nlines="19" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="398" endline="426" pcid="6705">
    def test_team_permission(self):
        # Test ensures you can only edit alerts owned by your team or no one.

        om = self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )
        self.login_as(self.user)
        alert_rule = self.alert_rule
        alert_rule.owner = self.team.actor
        alert_rule.save()
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        serialized_alert_rule = self.get_serialized_alert_rule()
        OrganizationMemberTeam.objects.filter(
            organizationmember__user=self.user,
            team=self.team,
        ).delete()
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, alert_rule.id, **serialized_alert_rule)
        assert resp.status_code == 403
        self.create_team_membership(team=self.team, member=om)
        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(
                self.organization.slug, alert_rule.id, **serialized_alert_rule
            )

        alert_rule.refresh_from_db()
        assert resp.data == serialize(alert_rule, self.user)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_alert_rule_details.py" startline="465" endline="484" pcid="6708">
    def test_team_permission(self):
        # Test ensures you can only delete alerts owned by your team or no one.
        om = self.create_member(
            user=self.user, organization=self.organization, role="owner", teams=[self.team]
        )
        self.login_as(self.user)
        alert_rule = self.alert_rule
        alert_rule.owner = self.team.actor
        alert_rule.save()
        # We need the IDs to force update instead of create, so we just get the rule using our own API. Like frontend would.
        OrganizationMemberTeam.objects.filter(
            organizationmember__user=self.user,
            team=self.team,
        ).delete()
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, alert_rule.id)
        assert resp.status_code == 403
        self.create_team_membership(team=self.team, member=om)
        with self.feature("organizations:incidents"):
            resp = self.get_valid_response(self.organization.slug, alert_rule.id, status_code=204)
</source>
</class>

<class classid="165" nclones="3" nlines="21" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/eventstore/test_models.py" startline="54" endline="80" pcid="6723">
    def test_email_subject(self):
        event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "Foo bar",
                "level": "info",
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )
        event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "Foo bar",
                "level": "error",
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )

        group = event1.group

        group.level = 30

        assert event1.get_email_subject() == "BAR-1 - Foo bar"
        assert event2.get_email_subject() == "BAR-1 - Foo bar"

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_group_index.py" startline="32" endline="53" pcid="11094">
    def create_issues(self):
        event_a = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "oh no",
                "timestamp": iso_format(event_time),
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )
        add_group_to_inbox(event_a.group, GroupInboxReason.NEW)
        event_b = self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "oh snap",
                "timestamp": iso_format(event_time),
                "fingerprint": ["group-2"],
            },
            project_id=self.project.id,
        )
        add_group_to_inbox(event_b.group, GroupInboxReason.NEW)

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_global_selection_header.py" startline="46" endline="66" pcid="11220">
    def create_issues(self):
        self.issue_1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "oh no",
                "timestamp": iso_format(event_time),
                "fingerprint": ["group-1"],
            },
            project_id=self.project_1.id,
        )
        self.issue_2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "oh snap",
                "timestamp": iso_format(event_time),
                "fingerprint": ["group-2"],
                "environment": "prod",
            },
            project_id=self.project_2.id,
        )

</source>
</class>

<class classid="166" nclones="3" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/middleware/test_stats.py" startline="16" endline="29" pcid="6874">
    def test_records_default_api_metrics(self, incr):
        request = self.factory.get("/")
        request._view_path = "/"
        response = Mock(status_code=200)

        self.middleware.process_response(request, response)

        incr.assert_called_with(
            "view.response",
            instance=request._view_path,
            tags={"method": "GET", "status_code": 200},
            skip_internal=False,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/middleware/test_stats.py" startline="48" endline="63" pcid="6876">
    def test_add_request_metric_tags(self, incr):
        request = self.factory.get("/")
        request._view_path = "/"

        add_request_metric_tags(request, foo="bar")

        response = Mock(status_code=200)

        self.middleware.process_response(request, response)

        incr.assert_called_with(
            "view.response",
            instance=request._view_path,
            tags={"method": "GET", "status_code": 200, "foo": "bar"},
            skip_internal=False,
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/middleware/test_stats.py" startline="31" endline="46" pcid="6875">
    def test_records_endpoint_specific_metrics(self, incr):
        request = self.factory.get("/")
        request._view_path = "/"
        request._metric_tags = {"a": "b"}

        response = Mock(status_code=200)

        self.middleware.process_response(request, response)

        incr.assert_called_with(
            "view.response",
            instance=request._view_path,
            tags={"method": "GET", "status_code": 200, "a": "b"},
            skip_internal=False,
        )

</source>
</class>

<class classid="167" nclones="5" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="98" endline="111" pcid="6891">
    def test_mixed(self):
        assert (
            CanonicalKeyDict(
                {
                    "release": "asdf",
                    "exception": {"type": "DemoException"},
                    "user": {"id": "DemoUser"},
                    "sentry.interfaces.Exception": {"type": "INVALID"},
                    "sentry.interfaces.User": {"id": "INVALID"},
                }
            )
            == self.canonical_data
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="187" endline="201" pcid="6898">
    def test_mixed(self):
        assert (
            CanonicalKeyDict(
                {
                    "release": "asdf",
                    "sentry.interfaces.Exception": {"type": "DemoException"},
                    "sentry.interfaces.User": {"id": "DemoUser"},
                    "exception": {"type": "INVALID"},
                    "user": {"id": "INVALID"},
                },
                legacy=True,
            )
            == self.canonical_data
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="174" endline="186" pcid="6897">
    def test_legacy(self):
        assert (
            CanonicalKeyDict(
                {
                    "release": "asdf",
                    "sentry.interfaces.Exception": {"type": "DemoException"},
                    "sentry.interfaces.User": {"id": "DemoUser"},
                },
                legacy=True,
            )
            == self.canonical_data
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="161" endline="173" pcid="6896">
    def test_canonical(self):
        assert (
            CanonicalKeyDict(
                {
                    "release": "asdf",
                    "exception": {"type": "DemoException"},
                    "user": {"id": "DemoUser"},
                },
                legacy=True,
            )
            == self.canonical_data
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="137" endline="153" pcid="6895">
    def test_len(self):
        assert (
            len(
                CanonicalKeyDict(
                    {
                        "release": "asdf",
                        "exception": {"type": "DemoException"},
                        "user": {"id": "DemoUser"},
                        "sentry.interfaces.Exception": {"type": "INVALID"},
                        "sentry.interfaces.User": {"id": "INVALID"},
                    }
                )
            )
            == 3
        )


</source>
</class>

<class classid="168" nclones="5" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="215" endline="227" pcid="6900">
    def test_canonical(self):
        view = CanonicalKeyView({"logentry": "foo"})
        assert len(view) == 1
        assert list(view.keys()) == ["logentry"]

        assert "logentry" in view
        assert "sentry.interfaces.Message" in view
        assert "message" in view

        assert view["logentry"] == "foo"
        assert view["sentry.interfaces.Message"] == "foo"
        assert view["message"] == "foo"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="241" endline="253" pcid="6902">
    def test_legacy_second(self):
        view = CanonicalKeyView({"message": "foo"})
        assert len(view) == 1
        assert list(view.keys()) == ["logentry"]

        assert "logentry" in view
        assert "sentry.interfaces.Message" in view
        assert "message" in view

        assert view["logentry"] == "foo"
        assert view["sentry.interfaces.Message"] == "foo"
        assert view["message"] == "foo"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="267" endline="278" pcid="6904">
    def test_two_legacy(self):
        view = CanonicalKeyView({"message": "bar", "sentry.interfaces.Message": "foo"})
        assert len(view) == 1
        assert list(view.keys()) == ["logentry"]

        assert "logentry" in view
        assert "sentry.interfaces.Message" in view
        assert "message" in view

        assert view["logentry"] == "foo"
        assert view["sentry.interfaces.Message"] == "foo"
        assert view["message"] == "foo"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="254" endline="266" pcid="6903">
    def test_override(self):
        view = CanonicalKeyView({"logentry": "foo", "sentry.interfaces.Message": "bar"})
        assert len(view) == 1
        assert list(view.keys()) == ["logentry"]

        assert "logentry" in view
        assert "sentry.interfaces.Message" in view
        assert "message" in view

        assert view["logentry"] == "foo"
        assert view["sentry.interfaces.Message"] == "foo"
        assert view["message"] == "foo"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_canonical.py" startline="228" endline="240" pcid="6901">
    def test_legacy_first(self):
        view = CanonicalKeyView({"sentry.interfaces.Message": "foo"})
        assert len(view) == 1
        assert list(view.keys()) == ["logentry"]

        assert "logentry" in view
        assert "sentry.interfaces.Message" in view
        assert "message" in view

        assert view["logentry"] == "foo"
        assert view["sentry.interfaces.Message"] == "foo"
        assert view["message"] == "foo"

</source>
</class>

<class classid="169" nclones="2" nlines="20" similarity="95">
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="133" endline="154" pcid="6924">
    def test_not_limited_with_unlimited_quota(self, mock_is_rate_limited, mock_get_quotas):
        mock_get_quotas.return_value = (
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=None,
                window=1,
                reason_code="project_quota",
            ),
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=2,
                limit=1,
                window=1,
                reason_code="project_quota",
            ),
        )

        assert not self.quota.is_rate_limited(self.project).is_limited

</source>
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="157" endline="178" pcid="6925">
    def test_limited_with_unlimited_quota(self, mock_is_rate_limited, mock_get_quotas):
        mock_get_quotas.return_value = (
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=None,
                window=1,
                reason_code="project_quota",
            ),
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=2,
                limit=1,
                window=1,
                reason_code="project_quota",
            ),
        )

        assert self.quota.is_rate_limited(self.project).is_limited

</source>
</class>

<class classid="170" nclones="2" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="179" endline="200" pcid="6926">
    def test_get_usage(self):
        timestamp = time.time()

        self.get_project_quota.return_value = (200, 60)
        self.get_organization_quota.return_value = (300, 60)

        n = 10
        for _ in range(n):
            self.quota.is_rate_limited(self.project, timestamp=timestamp)

        quotas = self.quota.get_quotas(self.project)
        all_quotas = quotas + [
            QuotaConfig(id="unlimited", limit=None, window=60, reason_code="unlimited"),
            QuotaConfig(id="dummy", limit=10, window=60, reason_code="dummy"),
        ]

        usage = self.quota.get_usage(self.project.organization_id, all_quotas, timestamp=timestamp)

        # Only quotas with an ID are counted in Redis (via this ID). Assume the
        # count for these quotas and None for the others.
        assert usage == [n if q.id else None for q in quotas] + [0, 0]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="297" endline="320" pcid="6929">
    def test_get_usage_uses_refund(self):
        timestamp = time.time()

        self.get_project_quota.return_value = (200, 60)
        self.get_organization_quota.return_value = (300, 60)

        n = 10
        for _ in range(n):
            self.quota.is_rate_limited(self.project, timestamp=timestamp)

        self.quota.refund(self.project, timestamp=timestamp)

        quotas = self.quota.get_quotas(self.project)
        all_quotas = quotas + [
            QuotaConfig(id="unlimited", limit=None, window=60, reason_code="unlimited"),
            QuotaConfig(id="dummy", limit=10, window=60, reason_code="dummy"),
        ]

        usage = self.quota.get_usage(self.project.organization_id, all_quotas, timestamp=timestamp)

        # Only quotas with an ID are counted in Redis (via this ID). Assume the
        # count for these quotas and None for the others.
        # The ``- 1`` is because we refunded once.
        assert usage == [n - 1 if q.id else None for q in quotas] + [0, 0]
</source>
</class>

<class classid="171" nclones="2" nlines="40" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="202" endline="247" pcid="6927">
    def test_refund_defaults(self, mock_get_quotas):
        timestamp = time.time()

        mock_get_quotas.return_value = (
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=None,
                window=1,
                reason_code="project_quota",
                categories=[DataCategory.ERROR],
            ),
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=2,
                limit=1,
                window=1,
                reason_code="project_quota",
                categories=[DataCategory.ERROR],
            ),
            # Should be ignored
            QuotaConfig(
                id="a",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=1 ** 6,
                window=1,
                reason_code="attachment_quota",
                categories=[DataCategory.ATTACHMENT],
            ),
        )

        self.quota.refund(self.project, timestamp=timestamp)
        client = self.quota.cluster.get_local_client_for_key(str(self.project.organization.pk))

        error_keys = client.keys("r:quota:p:?:*")
        assert len(error_keys) == 2

        for key in error_keys:
            assert client.get(key) == b"1"

        attachment_keys = client.keys("r:quota:a:*")
        assert len(attachment_keys) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/quotas/redis/tests.py" startline="249" endline="296" pcid="6928">
    def test_refund_categories(self, mock_get_quotas):
        timestamp = time.time()

        mock_get_quotas.return_value = (
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=None,
                window=1,
                reason_code="project_quota",
                categories=[DataCategory.ERROR],
            ),
            QuotaConfig(
                id="p",
                scope=QuotaScope.PROJECT,
                scope_id=2,
                limit=1,
                window=1,
                reason_code="project_quota",
                categories=[DataCategory.ERROR],
            ),
            # Should be ignored
            QuotaConfig(
                id="a",
                scope=QuotaScope.PROJECT,
                scope_id=1,
                limit=1 ** 6,
                window=1,
                reason_code="attachment_quota",
                categories=[DataCategory.ATTACHMENT],
            ),
        )

        self.quota.refund(
            self.project, timestamp=timestamp, category=DataCategory.ATTACHMENT, quantity=100
        )
        client = self.quota.cluster.get_local_client_for_key(str(self.project.organization.pk))

        error_keys = client.keys("r:quota:p:?:*")
        assert len(error_keys) == 0

        attachment_keys = client.keys("r:quota:a:*")
        assert len(attachment_keys) == 1

        for key in attachment_keys:
            assert client.get(key) == b"100"

</source>
</class>

<class classid="172" nclones="2" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_outcomes.py" startline="90" endline="104" pcid="6969">
    def test_correct_times_seen_aggregate(self):
        query = _make_query(
            "statsPeriod=6h&interval=10m&groupBy=category&field=sum(times_seen)",
            {"organization_id": 1},
            True,
        )
        assert Function("count()", [Column("times_seen")], "times_seen") in query.select_params

        query = _make_query(
            "statsPeriod=6h&interval=1d&groupBy=category&field=sum(times_seen)",
            {"organization_id": 1},
            True,
        )
        assert Function("sum", [Column("times_seen")], "times_seen") in query.select_params

</source>
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_outcomes.py" startline="105" endline="119" pcid="6970">
    def test_filter_keys(self):
        query = _make_query(
            "statsPeriod=6h&interval=10m&groupBy=category&field=sum(times_seen)",
            {"organization_id": 1},
            True,
        )
        assert Condition(Column("org_id"), Op.EQ, 1) in query.conditions

        query = _make_query(
            "statsPeriod=6h&interval=1d&groupBy=category&field=sum(times_seen)",
            {"organization_id": 1, "project_id": [1, 2, 3, 4, 5]},
            True,
        )
        assert Condition(Column("org_id"), Op.EQ, 1) in query.conditions
        assert Condition(Column("project_id"), Op.IN, [1, 2, 3, 4, 5]) in query.conditions
</source>
</class>

<class classid="173" nclones="2" nlines="30" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_entity_subscriptions.py" startline="92" endline="122" pcid="6977">
    def test_get_entity_subscription_for_metrics_dataset_for_users(self) -> None:
        aggregate = "percentage(users_crashed, users) AS _crash_rate_alert_aggregate"
        entity_subscription = get_entity_subscription_for_dataset(
            dataset=QueryDatasets.METRICS,
            aggregate=aggregate,
            time_window=3600,
            extra_fields={"org_id": self.organization.id},
        )
        assert isinstance(entity_subscription, MetricsSetsEntitySubscription)
        assert entity_subscription.aggregate == aggregate
        groupby = [resolve_tag_key("session.status")]
        assert entity_subscription.get_entity_extra_params() == {
            "organization": self.organization.id,
            "groupby": groupby,
            "granularity": 10,
        }
        assert entity_subscription.entity_key == EntityKey.MetricsSets
        assert entity_subscription.time_col == ENTITY_TIME_COLUMNS[EntityKey.MetricsSets]
        assert entity_subscription.dataset == QueryDatasets.METRICS
        session_status = resolve_tag_key("session.status")
        session_status_tag_values = resolve_many_weak(["crashed", "init"])
        snuba_filter = entity_subscription.build_snuba_filter("", None, None)
        assert snuba_filter
        assert snuba_filter.aggregations == [["uniq(value)", None, "value"]]
        assert snuba_filter.conditions == [
            ["metric_id", "=", resolve(SessionMetricKey.USER.value)],
            [session_status, "IN", session_status_tag_values],
        ]
        assert snuba_filter.groupby == groupby
        assert snuba_filter.rollup == entity_subscription.get_granularity()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_entity_subscriptions.py" startline="123" endline="153" pcid="6978">
    def test_get_entity_subscription_for_metrics_dataset_for_sessions(self) -> None:
        aggregate = "percentage(sessions_crashed, sessions) AS _crash_rate_alert_aggregate"
        entity_subscription = get_entity_subscription_for_dataset(
            dataset=QueryDatasets.METRICS,
            aggregate=aggregate,
            time_window=3600,
            extra_fields={"org_id": self.organization.id},
        )
        assert isinstance(entity_subscription, MetricsCountersEntitySubscription)
        assert entity_subscription.aggregate == aggregate
        groupby = [resolve_tag_key("session.status")]
        assert entity_subscription.get_entity_extra_params() == {
            "organization": self.organization.id,
            "groupby": groupby,
            "granularity": 10,
        }
        assert entity_subscription.entity_key == EntityKey.MetricsCounters
        assert entity_subscription.time_col == ENTITY_TIME_COLUMNS[EntityKey.MetricsCounters]
        assert entity_subscription.dataset == QueryDatasets.METRICS
        session_status = resolve_tag_key("session.status")
        session_status_tag_values = resolve_many_weak(["crashed", "init"])
        snuba_filter = entity_subscription.build_snuba_filter("", None, None)
        assert snuba_filter
        assert snuba_filter.aggregations == [["sum(value)", None, "value"]]
        assert snuba_filter.conditions == [
            ["metric_id", "=", resolve(SessionMetricKey.SESSION.value)],
            [session_status, "IN", session_status_tag_values],
        ]
        assert snuba_filter.groupby == groupby
        assert snuba_filter.rollup == entity_subscription.get_granularity()

</source>
</class>

<class classid="174" nclones="2" nlines="16" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_entity_subscriptions.py" startline="154" endline="170" pcid="6979">
    def test_get_entity_subscription_for_transactions_dataset(self) -> None:
        aggregate = "percentile(transaction.duration,.95)"
        entity_subscription = get_entity_subscription_for_dataset(
            dataset=QueryDatasets.TRANSACTIONS, aggregate=aggregate, time_window=3600
        )
        assert isinstance(entity_subscription, TransactionsEntitySubscription)
        assert entity_subscription.aggregate == aggregate
        assert entity_subscription.get_entity_extra_params() == {}
        assert entity_subscription.entity_key == EntityKey.Transactions
        assert entity_subscription.time_col == ENTITY_TIME_COLUMNS[EntityKey.Transactions]
        assert entity_subscription.dataset == QueryDatasets.TRANSACTIONS
        snuba_filter = entity_subscription.build_snuba_filter("", None, None)
        assert snuba_filter
        assert snuba_filter.aggregations == [
            ["quantile(0.95)", "duration", "percentile_transaction_duration__95"]
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/snuba/test_entity_subscriptions.py" startline="171" endline="188" pcid="6980">
    def test_get_entity_subscription_for_events_dataset(self) -> None:
        aggregate = "count_unique(user)"
        entity_subscription = get_entity_subscription_for_dataset(
            dataset=QueryDatasets.EVENTS, aggregate=aggregate, time_window=3600
        )
        assert isinstance(entity_subscription, EventsEntitySubscription)
        assert entity_subscription.aggregate == aggregate
        assert entity_subscription.get_entity_extra_params() == {}
        assert entity_subscription.entity_key == EntityKey.Events
        assert entity_subscription.time_col == ENTITY_TIME_COLUMNS[EntityKey.Events]
        assert entity_subscription.dataset == QueryDatasets.EVENTS
        snuba_filter = entity_subscription.build_snuba_filter("release:latest", None, None)
        assert snuba_filter
        assert snuba_filter.conditions == [
            ["type", "=", "error"],
            ["tags[sentry:release]", "=", "latest"],
        ]
        assert snuba_filter.aggregations == [["uniq", "tags[sentry:user]", "count_unique_user"]]
</source>
</class>

<class classid="175" nclones="6" nlines="15" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="108" endline="120" pcid="7013">
    def test_custom_untouched(self):
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "custom",
                "location": "http://example.net/prefix/path",
                "download": {"status": "ok"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        assert response["modules"][0]["candidates"] == candidates

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="225" endline="240" pcid="7019">
    def test_sentry_project_notfound_no_location(self):
        # For sentry:project status=notfound the location needs to be removed
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "sentry:project",
                "location": "Not the locacation you are looking for",
                "download": {"status": "notfound"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        expected = [{"source": "sentry:project", "download": {"status": "notfound"}}]
        assert response["modules"][0]["candidates"] == expected


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="121" endline="134" pcid="7014">
    def test_location_debug_id(self):
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "sentry:microsoft",
                "location": "http://microsoft.com/prefix/path0",
                "download": {"status": "ok"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        expected = [{"source": "sentry:microsoft", "download": {"status": "ok"}}]
        assert response["modules"][0]["candidates"] == expected

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="154" endline="172" pcid="7016">
    def test_notfound_omitted(self):
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "sentry:microsoft",
                "location": "http://microsoft.com/prefix/path0",
                "download": {"status": "notfound"},
            },
            {
                "source": "sentry:microsoft",
                "location": "http://microsoft.com/prefix/path1",
                "download": {"status": "ok"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        expected = [{"source": "sentry:microsoft", "download": {"status": "ok"}}]
        assert response["modules"][0]["candidates"] == expected

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="135" endline="153" pcid="7015">
    def test_notfound_deduplicated(self):
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "sentry:microsoft",
                "location": "http://microsoft.com/prefix/path0",
                "download": {"status": "notfound"},
            },
            {
                "source": "sentry:microsoft",
                "location": "http://microsoft.com/prefix/path1",
                "download": {"status": "notfound"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        expected = [{"source": "sentry:microsoft", "download": {"status": "notfound"}}]
        assert response["modules"][0]["candidates"] == expected

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_symbolicator.py" startline="205" endline="224" pcid="7018">
    def test_sentry_project(self):
        debug_id = "451a38b5-0679-79d2-0738-22a5ceb24c4b"
        candidates = [
            {
                "source": "sentry:project",
                "location": "sentry://project_debug_file/123",
                "download": {"status": "ok"},
            },
        ]
        response = {"modules": [{"debug_id": debug_id, "candidates": copy.copy(candidates)}]}
        redact_internal_sources(response)
        expected = [
            {
                "source": "sentry:project",
                "location": "sentry://project_debug_file/123",
                "download": {"status": "ok"},
            },
        ]
        assert response["modules"][0]["candidates"] == expected

</source>
</class>

<class classid="176" nclones="6" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="54" endline="65" pcid="7027">
    def test_sources_ignored_unset(self, sources):
        sources = filter_ignored_sources(sources)

        source_ids = list(map(lambda s: s["id"], sources))
        assert source_ids == [
            "sentry:microsoft",
            "sentry:electron",
            "sentry:ios-source",
            "sentry:tvos-source",
            "custom",
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="128" endline="139" pcid="7033">
    def test_sources_ignored_unrecognized(self, sources):
        with override_options({"symbolicator.ignored_sources": ["honk"]}):
            sources = filter_ignored_sources(sources)

            source_ids = list(map(lambda s: s["id"], sources))
            assert source_ids == [
                "sentry:microsoft",
                "sentry:electron",
                "sentry:ios-source",
                "sentry:tvos-source",
                "custom",
            ]
</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="81" endline="92" pcid="7029">
    def test_sources_ignored_builtin(self, sources):
        with override_options({"symbolicator.ignored_sources": ["sentry:microsoft"]}):
            sources = filter_ignored_sources(sources)

            source_ids = list(map(lambda s: s["id"], sources))
            assert source_ids == [
                "sentry:electron",
                "sentry:ios-source",
                "sentry:tvos-source",
                "custom",
            ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="115" endline="126" pcid="7032">
    def test_sources_ignored_custom(self, sources):
        with override_options({"symbolicator.ignored_sources": ["custom"]}):
            sources = filter_ignored_sources(sources)

            source_ids = list(map(lambda s: s["id"], sources))
            assert source_ids == [
                "sentry:microsoft",
                "sentry:electron",
                "sentry:ios-source",
                "sentry:tvos-source",
            ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="67" endline="79" pcid="7028">
    def test_sources_ignored_empty(self, sources):
        with override_options({"symbolicator.ignored_sources": []}):
            sources = filter_ignored_sources(sources)

            source_ids = list(map(lambda s: s["id"], sources))
            assert source_ids == [
                "sentry:microsoft",
                "sentry:electron",
                "sentry:ios-source",
                "sentry:tvos-source",
                "custom",
            ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_ignoredsourcesfiltering.py" startline="102" endline="113" pcid="7031">
    def test_sources_ignored_bypass_alias(self, sources, reversed_alias_map):
        with override_options({"symbolicator.ignored_sources": ["sentry:ios-source"]}):
            sources = filter_ignored_sources(sources, reversed_alias_map)

            source_ids = list(map(lambda s: s["id"], sources))
            assert source_ids == [
                "sentry:microsoft",
                "sentry:electron",
                "sentry:tvos-source",
                "custom",
            ]

</source>
</class>

<class classid="177" nclones="3" nlines="20" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_processing.py" startline="22" endline="45" pcid="7035">
def test_merge_symbolicator_image_basic():
    raw_image = {"instruction_addr": 0xFEEBEE, "other": "foo"}
    sdk_info = {"sdk_name": "linux"}
    complete_image = {
        "debug_status": "found",
        "unwind_status": "found",
        "other2": "bar",
        "arch": "unknown",
    }

    data = {}

    _merge_image(raw_image, complete_image, sdk_info, data)

    assert not data.get("errors")
    assert raw_image == {
        "debug_status": "found",
        "unwind_status": "found",
        "instruction_addr": 0xFEEBEE,
        "other": "foo",
        "other2": "bar",
    }


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_processing.py" startline="46" endline="69" pcid="7036">
def test_merge_symbolicator_image_basic_success():
    raw_image = {"instruction_addr": 0xFEEBEE, "other": "foo"}
    sdk_info = {"sdk_name": "linux"}
    complete_image = {
        "debug_status": "found",
        "unwind_status": "found",
        "other2": "bar",
        "arch": "foo",
    }
    data = {}

    _merge_image(raw_image, complete_image, sdk_info, data)

    assert not data.get("errors")
    assert raw_image == {
        "debug_status": "found",
        "unwind_status": "found",
        "instruction_addr": 0xFEEBEE,
        "other": "foo",
        "other2": "bar",
        "arch": "foo",
    }


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_processing.py" startline="96" endline="123" pcid="7038">
def test_merge_symbolicator_image_errors(code_file, error):
    raw_image = {"instruction_addr": 0xFEEBEE, "other": "foo", "code_file": code_file}
    sdk_info = {"sdk_name": "macos"}
    complete_image = {
        "debug_status": "found",
        "unwind_status": "missing",
        "other2": "bar",
        "arch": "unknown",
    }
    data = {}

    _merge_image(raw_image, complete_image, sdk_info, data)

    (e,) = data["errors"]

    assert e["image_path"].endswith("/foo")
    assert e["type"] == error

    assert raw_image == {
        "debug_status": "found",
        "unwind_status": "missing",
        "instruction_addr": 0xFEEBEE,
        "other": "foo",
        "other2": "bar",
        "code_file": code_file,
    }


</source>
</class>

<class classid="178" nclones="2" nlines="81" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="5" endline="97" pcid="7040">
def test_get_threads_apple_string():
    acr = AppleCrashReport(
        threads=[
            {
                "crashed": True,
                "current": True,
                "id": 1,
                "name": None,
                "stacktrace": {
                    "frames": [
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Sources/ios/SentrySwizzle.swift",
                            "colno": 0,
                            "filename": "SentrySwizzle.swift",
                            "function": "@objc UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool",
                            "image_addr": "0x2c8000",
                            "in_app": False,
                            "instruction_addr": "0x31caa4",
                            "lineno": 0,
                            "object_addr": "0x2c8000",
                            "package": "/private/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/Frameworks/SentrySwift.framework/SentrySwift",
                            "symbol": "_TToFE11SentrySwiftCSo13UIApplication23sentryClient_sendActionfTV10ObjectiveC8Selector2toGSqPs9AnyObject__4fromGSqPS3___3forGSqCSo7UIEvent__Sb",
                            "symbol_addr": "0x31ca38",
                        },
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Sources/ios/SentrySwizzle.swift",
                            "colno": 84,
                            "filename": "SentrySwizzle.swift",
                            "function": "UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool",
                            "image_addr": "0x2c8000",
                            "in_app": False,
                            "instruction_addr": "0x31c3e8",
                            "lineno": 92,
                            "object_addr": "0x2c8000",
                            "package": "/private/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/Frameworks/SentrySwift.framework/SentrySwift",
                            "symbol": "_TFE11SentrySwiftCSo13UIApplication23sentryClient_sendActionfTV10ObjectiveC8Selector2toGSqPs9AnyObject__4fromGSqPS3___3forGSqCSo7UIEvent__Sb",
                            "symbol_addr": "0x31b9f8",
                        },
                    ]
                },
            },
            {
                "crashed": False,
                "current": False,
                "id": 2,
                "name": "com.apple.test",
                "stacktrace": {
                    "frames": [
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Examples/SwiftExample/SwiftExample/ViewController.swift",
                            "colno": 0,
                            "filename": "ViewController.swift",
                            "function": "@objc ViewController.onClickFatalError(AnyObject) -> ()",
                            "image_addr": "0xf0000",
                            "in_app": True,
                            "instruction_addr": "0xf6cd4",
                            "lineno": 0,
                            "object_addr": "0xf0000",
                            "package": "/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/SwiftExample",
                            "symbol": "_TToFC12SwiftExample14ViewController17onClickFatalErrorfPs9AnyObject_T_",
                            "symbol_addr": "0xf6c98",
                        },
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Examples/SwiftExample/SwiftExample/ViewController.swift",
                            "colno": 36,
                            "filename": "ViewController.swift",
                            "function": "ViewController.onClickFatalError(AnyObject) -> ()",
                            "image_addr": "0xf0000",
                            "in_app": True,
                            "instruction_addr": "0xf6c78",
                            "lineno": 110,
                            "object_addr": "0xf0000",
                            "package": "/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/SwiftExample",
                            "symbol": "_TFC12SwiftExample14ViewController17onClickFatalErrorfPs9AnyObject_T_",
                            "symbol_addr": "0xf6c04",
                        },
                    ]
                },
            },
        ]
    )
    threads = acr.get_threads_apple_string()
    assert (
        threads
        == "Thread 1 Crashed:\n\
0   SentrySwift                     0x31c3e8            0x2c8000 + 2544\n\
1   SentrySwift                     0x31caa4            0x2c8000 + 108\n\n\
Thread 2 name: com.apple.test\n\
0   SwiftExample                    0xf6c78             0xf0000 + 116\n\
1   SwiftExample                    0xf6cd4             0xf0000 + 60"
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="98" endline="188" pcid="7041">
def test_get_threads_apple_string_symbolicated():
    acr = AppleCrashReport(
        symbolicated=True,
        threads=[
            {
                "crashed": True,
                "current": True,
                "id": 1,
                "name": None,
                "stacktrace": {
                    "frames": [
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Sources/ios/SentrySwizzle.swift",
                            "colno": 0,
                            "filename": "SentrySwizzle.swift",
                            "function": "@objc UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool",
                            "image_addr": "0x2c8000",
                            "in_app": False,
                            "instruction_addr": "0x31caa4",
                            "lineno": 0,
                            "object_addr": "0x2c8000",
                            "package": "/private/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/Frameworks/SentrySwift.framework/SentrySwift",
                            "symbol": "_TToFE11SentrySwiftCSo13UIApplication23sentryClient_sendActionfTV10ObjectiveC8Selector2toGSqPs9AnyObject__4fromGSqPS3___3forGSqCSo7UIEvent__Sb",
                            "symbol_addr": "0x31ca38",
                        },
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Sources/ios/SentrySwizzle.swift",
                            "colno": 84,
                            "filename": "SentrySwizzle.swift",
                            "function": "UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool",
                            "image_addr": "0x2c8000",
                            "in_app": False,
                            "instruction_addr": "0x31c3e8",
                            "lineno": 92,
                            "object_addr": "0x2c8000",
                            "package": "/private/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/Frameworks/SentrySwift.framework/SentrySwift",
                            "symbol": "_TFE11SentrySwiftCSo13UIApplication23sentryClient_sendActionfTV10ObjectiveC8Selector2toGSqPs9AnyObject__4fromGSqPS3___3forGSqCSo7UIEvent__Sb",
                            "symbol_addr": "0x31b9f8",
                        },
                    ]
                },
            },
            {
                "crashed": False,
                "current": False,
                "id": 2,
                "name": "com.apple.test",
                "stacktrace": {
                    "frames": [
                        {
                            "abs_path": "/Users/haza/Projects/sentry-swift/Examples/SwiftExample/SwiftExample/ViewController.swift",
                            "colno": 0,
                            "filename": "ViewController.swift",
                            "function": "@objc ViewController.onClickFatalError(AnyObject) -> ()",
                            "image_addr": "0xf0000",
                            "in_app": True,
                            "instruction_addr": "0xf6cd4",
                            "lineno": 0,
                            "object_addr": "0xf0000",
                            "package": "/var/containers/Bundle/Application/06EA18D0-49C5-452C-B431-92B1098FB4AD/SwiftExample.app/SwiftExample",
                            "symbol": "_TToFC12SwiftExample14ViewController17onClickFatalErrorfPs9AnyObject_T_",
                            "symbol_addr": "0xf6c98",
                        },
                        {
                            "colno": 36,
                            "image_addr": "0xf0000",
                            "in_app": True,
                            "instruction_addr": "0xf6c78",
                            "lineno": 110,
                            "object_addr": "0xf0000",
                            "symbol_addr": "0xf6c04",
                        },
                    ]
                },
            },
        ],
    )
    threads = acr.get_threads_apple_string()
    assert (
        threads.rstrip()
        == """\
Thread 1 Crashed:\n\
0   SentrySwift                     0x31c3e8            UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool (SentrySwizzle.swift:92)
1   SentrySwift                     0x31caa4            @objc UIApplication.sentryClient_sendAction(Selector, to : AnyObject?, from : AnyObject?, for : UIEvent?) -> Bool

Thread 2 name: com.apple.test
0   <unknown>                       0xf6c78             <unknown> + 116
1   SwiftExample                    0xf6cd4             @objc ViewController.onClickFatalError(AnyObject) -> ()"""
    )


</source>
</class>

<class classid="179" nclones="2" nlines="53" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="372" endline="432" pcid="7044">
def test_get_binary_images_apple_string():
    acr = AppleCrashReport(
        debug_images=[
            {
                "image_addr": "0x141c5000",
                "image_size": 20480,
                "image_vmaddr": "0x0",
                "code_file": "/Users/haza/Library/Developer/CoreSimulator/Devices/DDB32F4C-97CF-4E2B-BD10-EB940553F223/data/Containers/Bundle/Application/8C286977-D498-44FF-B7BE-42BFE3DE38BD/SwiftExample.app/Frameworks/libswiftContacts.dylib",
                "type": "native",
                "debug_id": "4B5A054F-B7A1-3AD0-81E1-513B4DBE2A33",
            },
            {
                "image_addr": "0x1400c000",
                "image_size": 266240,
                "image_vmaddr": "0x0",
                "code_file": "/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/PrivateFrameworks/ContentIndex.framework/ContentIndex",
                "type": "native",
                "debug_id": "766DFB14-72EE-32D2-8961-687D32548F2B",
            },
            {
                "image_addr": "0x1406f000",
                "image_size": 913408,
                # image_vmaddr defaults to 0x0
                "code_file": "/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/PrivateFrameworks/CorePDF.framework/CorePDF",
                "type": "native",
                "debug_id": "BE602DC1-D3A0-3389-B8F4-922C37DEA3DC",
            },
        ],
        context={
            "device": {
                "arch": "x86",
                "family": "iPhone",
                "freeMemory": 169684992,
                "memorySize": 17179869184,
                "model": "iPhone9,1",
                "simulator": True,
                "storageSize": 249695305728,
                "type": "device",
                "usableMemory": 14919622656,
            },
            "os": {
                "build": "16C67",
                "bundleID": "com.rokkincat.SentryExample",
                "bundleVersion": "2",
                "kernel_version": "Darwin Kernel Version 16.3.0: Thu Nov 17 20:23:58 PST 2016; root:xnu-3789.31.2~1/RELEASE_X86_64",
                "name": "iOS",
                "type": "os",
                "version": "10.2",
            },
        },
    )
    binary_images = acr.get_binary_images_apple_string()
    assert (
        binary_images
        == "Binary Images:\n\
0x1400c000 - 0x1404cfff ContentIndex x86  <766dfb1472ee32d28961687d32548f2b> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/PrivateFrameworks/ContentIndex.framework/ContentIndex\n\
0x1406f000 - 0x1414dfff CorePDF x86  <be602dc1d3a03389b8f4922c37dea3dc> /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/PrivateFrameworks/CorePDF.framework/CorePDF\n\
0x141c5000 - 0x141c9fff libswiftContacts.dylib x86  <4b5a054fb7a13ad081e1513b4dbe2a33> /Users/haza/Library/Developer/CoreSimulator/Devices/DDB32F4C-97CF-4E2B-BD10-EB940553F223/data/Containers/Bundle/Application/8C286977-D498-44FF-B7BE-42BFE3DE38BD/SwiftExample.app/Frameworks/libswiftContacts.dylib"
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="433" endline="492" pcid="7045">
def test_binary_images_without_code_file():
    acr = AppleCrashReport(
        debug_images=[
            {
                "image_addr": "0x141c5000",
                "image_size": 20480,
                "image_vmaddr": "0x0",
                "type": "native",
                "debug_id": "4B5A054F-B7A1-3AD0-81E1-513B4DBE2A33",
            },
            {
                "image_addr": "0x1400c000",
                "image_size": 266240,
                "image_vmaddr": "0x0",
                "type": "native",
                "debug_id": "766DFB14-72EE-32D2-8961-687D32548F2B",
            },
            {
                "image_addr": "0x1406f000",
                "image_size": 913408,
                # image_vmaddr defaults to 0x0
                "type": "native",
                "debug_id": "BE602DC1-D3A0-3389-B8F4-922C37DEA3DC",
            },
        ],
        context={
            "device": {
                "arch": "x86",
                "family": "iPhone",
                "freeMemory": 169684992,
                "memorySize": 17179869184,
                "model": "iPhone9,1",
                "simulator": True,
                "storageSize": 249695305728,
                "type": "device",
                "usableMemory": 14919622656,
            },
            "os": {
                "build": "16C67",
                "bundleID": "com.rokkincat.SentryExample",
                "bundleVersion": "2",
                "kernel_version": "Darwin Kernel Version 16.3.0: Thu Nov 17 20:23:58 PST 2016; root:xnu-3789.31.2~1/RELEASE_X86_64",
                "name": "iOS",
                "type": "os",
                "version": "10.2",
            },
        },
    )
    binary_images = acr.get_binary_images_apple_string()
    assert (
        binary_images
        == "Binary Images:\n\
0x1400c000 - 0x1404cfff {0} x86  <766dfb1472ee32d28961687d32548f2b> {0}\n\
0x1406f000 - 0x1414dfff {0} x86  <be602dc1d3a03389b8f4922c37dea3dc> {0}\n\
0x141c5000 - 0x141c9fff {0} x86  <4b5a054fb7a13ad081e1513b4dbe2a33> {0}".format(
            NATIVE_UNKNOWN_STRING
        )
    )


</source>
</class>

<class classid="180" nclones="2" nlines="29" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="536" endline="574" pcid="7047">
def test__get_exception_info():
    acr = AppleCrashReport(
        exceptions=[
            {
                "value": "Attempted to dereference garbage pointer 0x10.",
                "mechanism": {
                    "type": "mach",
                    "data": {"relevant_address": "0x10"},
                    "meta": {
                        "signal": {
                            "number": 10,
                            "code": 0,
                            "name": "SIGBUS",
                            "code_name": "BUS_NOOP",
                        },
                        "mach_exception": {
                            "exception": 1,
                            "name": "EXC_BAD_ACCESS",
                            "subcode": 8,
                            "code": 16,
                        },
                    },
                },
                "type": "EXC_BAD_ACCESS",
                "thread_id": 0,
            }
        ]
    )
    exception_info = acr._get_exception_info()
    assert (
        exception_info
        == "Exception Type: EXC_BAD_ACCESS (SIGBUS)\n\
Exception Codes: BUS_NOOP at 0x10\n\
Crashed Thread: 0\n\n\
Application Specific Information:\n\
Attempted to dereference garbage pointer 0x10."
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_applecrashreport.py" startline="575" endline="610" pcid="7048">
def test__get_exception_info_legacy_mechanism():
    acr = AppleCrashReport(
        exceptions=[
            {
                "value": "Attempted to dereference garbage pointer 0x10.",
                "mechanism": {
                    "posix_signal": {
                        "name": "SIGBUS",
                        "code_name": "BUS_NOOP",
                        "signal": 10,
                        "code": 0,
                    },
                    "relevant_address": "0x10",
                    "mach_exception": {
                        "exception": 1,
                        "exception_name": "EXC_BAD_ACCESS",
                        "subcode": 8,
                        "code": 16,
                    },
                },
                "type": "EXC_BAD_ACCESS",
                "thread_id": 0,
            }
        ]
    )
    exception_info = acr._get_exception_info()
    assert (
        exception_info
        == "Exception Type: EXC_BAD_ACCESS (SIGBUS)\n\
Exception Codes: BUS_NOOP at 0x10\n\
Crashed Thread: 0\n\n\
Application Specific Information:\n\
Attempted to dereference garbage pointer 0x10."
    )


</source>
</class>

<class classid="181" nclones="2" nlines="18" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_appconnect.py" startline="121" endline="142" pcid="7059">
    def test_update(
        self, default_project: "Project", config: appconnect.AppStoreConnectConfig
    ) -> None:
        config.update_project_symbol_source(default_project, allow_multiple=False)

        updated = appconnect.AppStoreConnectConfig(
            type=config.type,
            id=config.id,
            name=config.name,
            appconnectIssuer=config.appconnectIssuer,
            appconnectKey=config.appconnectKey,
            appconnectPrivateKey="A NEW KEY",
            appName=config.appName,
            appId=config.appId,
            bundleId=config.bundleId,
        )

        updated.update_project_symbol_source(default_project, allow_multiple=False)

        current = appconnect.AppStoreConnectConfig.from_project_config(default_project, config.id)
        assert current.appconnectPrivateKey == "A NEW KEY"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/lang/native/test_appconnect.py" startline="144" endline="164" pcid="7060">
    def test_update_no_matching_id(
        self, default_project: "Project", config: appconnect.AppStoreConnectConfig
    ) -> None:
        config.update_project_symbol_source(default_project, allow_multiple=False)

        updated = appconnect.AppStoreConnectConfig(
            type=config.type,
            id=uuid.uuid4().hex,
            name=config.name,
            appconnectIssuer=config.appconnectIssuer,
            appconnectKey=config.appconnectKey,
            appconnectPrivateKey="A NEW KEY",
            appName=config.appName,
            appId=config.appId,
            bundleId=config.bundleId,
        )

        with pytest.raises(ValueError):
            updated.update_project_symbol_source(default_project, allow_multiple=False)


</source>
</class>

<class classid="182" nclones="10" nlines="28" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_commit_filechange.py" startline="9" endline="44" pcid="7073">
    def test_simple(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id, name="test/test"
        )
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )
        cfc = CommitFileChange.objects.create(
            organization_id=project.organization_id, commit=commit, filename=".gitignore", type="M"
        )
        result = serialize(cfc, user)

        assert result["filename"] == ".gitignore"
        assert result["commitMessage"] == "waddap"
        assert result["author"] == {"name": "stebe", "email": "stebe@sentry.io"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_pull_request.py" startline="11" endline="39" pcid="7104">
    def test_simple(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id, name="test/test"
        )
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        pull_request = PullRequest.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="9",
            author=commit_author,
            message="waddap",
            title="cool pr",
        )

        result = serialize(pull_request, user)

        assert result["message"] == "waddap"
        assert result["title"] == "cool pr"
        assert result["repository"]["name"] == "test/test"
        assert result["author"] == {"name": "stebe", "email": "stebe@sentry.io"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_commit_filechange.py" startline="45" endline="74" pcid="7074">
    def test_no_author(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id, name="test/test"
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="abc",
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )
        cfc = CommitFileChange.objects.create(
            organization_id=project.organization_id, commit=commit, filename=".gitignore", type="M"
        )

        result = serialize(cfc, user)

        assert result["author"] == {}
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_commit.py" startline="9" endline="41" pcid="7174">
    def test_simple(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id, name="test/test"
        )
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )
        result = serialize(commit, user)

        assert result["message"] == "waddap"
        assert result["repository"]["name"] == "test/test"
        assert result["author"] == {"name": "stebe", "email": "stebe@sentry.io"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_release.py" startline="166" endline="195" pcid="7151">
    def test_no_tag_data(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=1,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )

        result = serialize(release, user)
        assert result["version"] == release.version
        assert not result["firstEvent"]
        assert not result["lastEvent"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_commit.py" startline="42" endline="68" pcid="7175">
    def test_no_author(self):
        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id, name="test/test"
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="abc",
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )

        result = serialize(commit, user)

        assert result["author"] == {}
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_pull_request.py" startline="61" endline="98" pcid="7106">
    def test_integration_repository(self):
        # Add binding in case they aren't set.
        bindings.add(
            "integration-repository.provider", GitHubRepositoryProvider, id="integrations:github"
        )

        user = self.create_user()
        project = self.create_project()
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex
        )
        release.add_project(project)
        repository = Repository.objects.create(
            organization_id=project.organization_id,
            name="test/test",
            provider="integrations:github",
            url="https://github.com/test/test",
        )
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        pull_request = PullRequest.objects.create(
            organization_id=project.organization_id,
            repository_id=repository.id,
            key="9",
            author=commit_author,
            message="waddap",
            title="cool pr",
        )

        result = serialize(pull_request, user)

        assert result["externalUrl"] == "https://github.com/test/test/pull/9"
        assert result["message"] == "waddap"
        assert result["title"] == "cool pr"
        assert result["repository"]["name"] == "test/test"
        assert result["author"] == {"name": "stebe", "email": "stebe@sentry.io"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_release.py" startline="196" endline="231" pcid="7152">
    def test_get_user_from_email(self):
        user = User.objects.create(
            email="Stebe@sentry.io"
        )  # upper case so we can test case sensitivity
        UserEmail.objects.get_primary_email(user=user)
        project = self.create_project()
        self.create_member(user=user, organization=project.organization)
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex, new_groups=1
        )
        release.add_project(project)
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=1,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )
        release.update(authors=[str(commit_author.id)], commit_count=1, last_commit_id=commit.id)

        result = serialize(release, user)
        result_author = result["authors"][0]
        assert int(result_author["id"]) == user.id
        assert result_author["email"] == user.email
        assert result_author["username"] == user.username

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_release.py" startline="274" endline="316" pcid="7154">
    def test_select_user_from_appropriate_org(self):
        """
        Tests that a user not belonging to the organization
        is not returned as the author
        """
        user = User.objects.create(email="stebe@sentry.io")
        email = UserEmail.objects.get(user=user, email="stebe@sentry.io")
        otheruser = User.objects.create(email="adifferentstebe@sentry.io")
        otheremail = UserEmail.objects.create(email="stebe@sentry.io", user=otheruser)
        project = self.create_project()
        self.create_member(user=otheruser, organization=project.organization)
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex, new_groups=1
        )
        release.add_project(project)
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=1,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )

        release.update(authors=[str(commit_author.id)], commit_count=1, last_commit_id=commit.id)

        assert email.id < otheremail.id
        result = serialize(release, user)
        assert len(result["authors"]) == 1
        result_author = result["authors"][0]
        assert int(result_author["id"]) == otheruser.id
        assert result_author["email"] == otheruser.email
        assert result_author["username"] == otheruser.username

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_release.py" startline="232" endline="273" pcid="7153">
    def test_get_single_user_from_email(self):
        """
        Tests that the first useremail will be used to
        associate a user with a commit author email
        """
        user = User.objects.create(email="stebe@sentry.io")
        otheruser = User.objects.create(email="adifferentstebe@sentry.io")
        UserEmail.objects.create(email="stebe@sentry.io", user=otheruser)
        project = self.create_project()
        self.create_member(user=user, organization=project.organization)
        self.create_member(user=otheruser, organization=project.organization)
        release = Release.objects.create(
            organization_id=project.organization_id, version=uuid4().hex, new_groups=1
        )
        release.add_project(project)
        commit_author = CommitAuthor.objects.create(
            name="stebe", email="stebe@sentry.io", organization_id=project.organization_id
        )
        commit = Commit.objects.create(
            organization_id=project.organization_id,
            repository_id=1,
            key="abc",
            author=commit_author,
            message="waddap",
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release=release,
            commit=commit,
            order=1,
        )

        release.update(authors=[str(commit_author.id)], commit_count=1, last_commit_id=commit.id)

        result = serialize(release, user)
        assert len(result["authors"]) == 1
        result_author = result["authors"][0]
        assert int(result_author["id"]) == user.id
        assert result_author["email"] == user.email
        assert result_author["username"] == user.username

</source>
</class>

<class classid="183" nclones="4" nlines="15" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_saved_search.py" startline="7" endline="24" pcid="7089">
    def test_simple(self):
        search = SavedSearch.objects.create(
            project=self.project, name="Something", query="some query"
        )
        result = serialize(search)

        assert result["id"] == str(search.id)
        assert result["projectId"] == str(search.project_id)
        assert result["type"] == search.type
        assert result["name"] == search.name
        assert result["query"] == search.query
        assert result["isDefault"] == search.is_default
        assert result["isUserDefault"] == search.is_default
        assert result["dateCreated"] == search.date_added
        assert not result["isPrivate"]
        assert not result["isGlobal"]
        assert not result["isPinned"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_saved_search.py" startline="41" endline="58" pcid="7091">
    def test_organization(self):
        search = SavedSearch.objects.create(
            organization=self.organization, name="Something", query="some query"
        )
        result = serialize(search)

        assert result["id"] == str(search.id)
        assert result["projectId"] is None
        assert result["type"] == search.type
        assert result["name"] == search.name
        assert result["query"] == search.query
        assert not result["isDefault"]
        assert not result["isUserDefault"]
        assert result["dateCreated"] == search.date_added
        assert not result["isPrivate"]
        assert not result["isGlobal"]
        assert not result["isPinned"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_saved_search.py" startline="59" endline="75" pcid="7092">
    def test_pinned(self):
        search = SavedSearch.objects.create(
            organization=self.organization, owner=self.user, name="Something", query="some query"
        )
        result = serialize(search)

        assert result["id"] == str(search.id)
        assert result["projectId"] is None
        assert result["type"] == search.type
        assert result["name"] == search.name
        assert result["query"] == search.query
        assert not result["isDefault"]
        assert not result["isUserDefault"]
        assert result["dateCreated"] == search.date_added
        assert result["isPrivate"]
        assert not result["isGlobal"]
        assert result["isPinned"]
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_saved_search.py" startline="25" endline="40" pcid="7090">
    def test_global(self):
        search = SavedSearch(name="Unresolved Issues", query="is:unresolved", is_global=True)
        result = serialize(search)

        assert result["id"] == str(search.id)
        assert result["projectId"] is None
        assert result["type"] == search.type
        assert result["name"] == search.name
        assert result["query"] == search.query
        assert not result["isDefault"]
        assert not result["isUserDefault"]
        assert result["dateCreated"] == search.date_added
        assert not result["isPrivate"]
        assert result["isGlobal"]
        assert not result["isPinned"]

</source>
</class>

<class classid="184" nclones="2" nlines="30" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_debugfile.py" startline="6" endline="39" pcid="7110">
    def test_simple(self):
        file = self.create_file(
            name="baz.dSYM",
            size=42,
            headers={"Content-Type": "application/x-mach-binary"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )

        dif = self.create_dif_file(
            debug_id="dfb8e43a-f242-3d73-a453-aeb6a777ef75",
            code_id="DFB8E43AF2423D73A453AEB6A777EF75",
            object_name="baz.dSYM",
            cpu_name="x86_64",
            file=file,
            data={"features": ["debug"]},
        )

        result = serialize(dif)
        result.pop("id")
        result.pop("dateCreated")

        assert result == {
            "uuid": "dfb8e43a-f242-3d73-a453-aeb6a777ef75",
            "debugId": "dfb8e43a-f242-3d73-a453-aeb6a777ef75",
            "codeId": "DFB8E43AF2423D73A453AEB6A777EF75",
            "cpuName": "x86_64",
            "objectName": "baz.dSYM",
            "symbolType": "macho",
            "size": 42,
            "sha1": "dc1e3f3e411979d336c3057cce64294f3420f93a",
            "headers": {"Content-Type": "application/x-mach-binary"},
            "data": {"features": ["debug"]},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_debugfile.py" startline="40" endline="72" pcid="7111">
    def test_long_debug_id(self):
        file = self.create_file(
            name="baz.dSYM",
            size=42,
            headers={"Content-Type": "application/x-mach-binary"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )

        dif = self.create_dif_file(
            debug_id="dfb8e43a-f242-3d73-a453-aeb6a777ef75-feedface",
            code_id="DFB8E43AF2423D73A453AEB6A777EF75feedface",
            object_name="baz.dSYM",
            cpu_name="x86_64",
            file=file,
            data={"features": ["debug"]},
        )

        result = serialize(dif)
        result.pop("id")
        result.pop("dateCreated")

        assert result == {
            "uuid": "dfb8e43a-f242-3d73-a453-aeb6a777ef75",
            "debugId": "dfb8e43a-f242-3d73-a453-aeb6a777ef75-feedface",
            "codeId": "DFB8E43AF2423D73A453AEB6A777EF75feedface",
            "cpuName": "x86_64",
            "objectName": "baz.dSYM",
            "symbolType": "macho",
            "size": 42,
            "sha1": "dc1e3f3e411979d336c3057cce64294f3420f93a",
            "headers": {"Content-Type": "application/x-mach-binary"},
            "data": {"features": ["debug"]},
        }
</source>
</class>

<class classid="185" nclones="3" nlines="17" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_user_identity_config.py" startline="17" endline="34" pcid="7118">
    def test_user_social_auth(self):
        identity = UserSocialAuth.objects.create(user=self.user, provider="github", uid="uf4romdj")
        view = UserIdentityConfig.wrap(identity, Status.CAN_DISCONNECT)
        result = serialize(view)

        assert result == {
            "category": "social-identity",
            "id": str(identity.id),
            "provider": {"key": "github", "name": "GitHub"},
            "name": "uf4romdj",
            "status": "can_disconnect",
            "isLogin": False,
            "organization": None,
            "dateAdded": None,
            "dateVerified": None,
            "dateSynced": None,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_user_identity_config.py" startline="35" endline="55" pcid="7119">
    def test_global_identity(self):
        identity = Identity.objects.create(idp=self.idp, user=self.user, external_id="bk1zbu82")
        identity.date_verified += timedelta(hours=1)
        identity.save()

        view = UserIdentityConfig.wrap(identity, Status.CAN_DISCONNECT)
        result = serialize(view)

        assert result == {
            "category": "global-identity",
            "id": str(identity.id),
            "provider": {"key": "github", "name": "GitHub"},
            "name": "bk1zbu82",
            "status": "can_disconnect",
            "isLogin": False,
            "organization": None,
            "dateAdded": identity.date_added,
            "dateVerified": identity.date_verified,
            "dateSynced": None,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_user_identity_config.py" startline="57" endline="79" pcid="7120">
    def test_global_login_identity(self, mock_is_login_provider):
        mock_is_login_provider.return_value = True

        identity = Identity.objects.create(idp=self.idp, user=self.user, external_id="m9p8bzua")
        identity.date_verified += timedelta(hours=1)
        identity.save()

        view = UserIdentityConfig.wrap(identity, Status.NEEDED_FOR_GLOBAL_AUTH)
        result = serialize(view)

        assert result == {
            "category": "global-identity",
            "id": str(identity.id),
            "provider": {"key": "github", "name": "GitHub"},
            "name": "m9p8bzua",
            "status": "needed_for_global_auth",
            "isLogin": True,
            "organization": None,
            "dateAdded": identity.date_added,
            "dateVerified": identity.date_verified,
            "dateSynced": None,
        }

</source>
</class>

<class classid="186" nclones="2" nlines="16" similarity="87">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_incident_activity.py" startline="15" endline="32" pcid="7130">
    def test_simple(self):
        activity = create_incident_activity(
            incident=self.create_incident(),
            activity_type=IncidentActivityType.COMMENT,
            user=self.user,
            comment="hello",
        )
        result = serialize(activity)

        assert result["id"] == str(activity.id)
        assert result["incidentIdentifier"] == str(activity.incident.identifier)
        assert result["user"] == serialize(activity.user)
        assert result["type"] == activity.type
        assert result["value"] is None
        assert result["previousValue"] is None
        assert result["comment"] == activity.comment
        assert result["dateCreated"] == activity.date_added

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_incident_activity.py" startline="33" endline="50" pcid="7131">
    def test_no_user(self):
        activity = create_incident_activity(
            incident=self.create_incident(),
            activity_type=IncidentActivityType.COMMENT,
            user=None,
            comment="hello",
        )
        result = serialize(activity)

        assert result["id"] == str(activity.id)
        assert result["incidentIdentifier"] == str(activity.incident.identifier)
        assert result["user"] is None
        assert result["type"] == activity.type
        assert result["value"] is None
        assert result["previousValue"] is None
        assert result["comment"] == activity.comment
        assert result["dateCreated"] == activity.date_added

</source>
</class>

<class classid="187" nclones="2" nlines="22" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_activity.py" startline="7" endline="33" pcid="7133">
    def test_pr_activity(self):
        self.org = self.create_organization(name="Rowdy Tiger")
        user = self.create_user()
        group = self.create_group(status=GroupStatus.UNRESOLVED)
        repo = self.create_repo(self.project, name="organization-bar")
        pr = PullRequest.objects.create(
            organization_id=self.org.id,
            repository_id=repo.id,
            key=5,
            title="aaaa",
            message="kartoffel",
        )

        activity = Activity.objects.create(
            project_id=group.project_id,
            group=group,
            type=Activity.SET_RESOLVED_IN_PULL_REQUEST,
            ident=pr.id,
            user=user,
            data={"pull_request": pr.id},
        )

        result = serialize([activity], user)[0]["data"]
        pull_request = result["pullRequest"]
        assert pull_request["repository"]["name"] == "organization-bar"
        assert pull_request["message"] == "kartoffel"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_activity.py" startline="34" endline="56" pcid="7134">
    def test_commit_activity(self):
        self.org = self.create_organization(name="Rowdy Tiger")
        user = self.create_user()
        group = self.create_group(status=GroupStatus.UNRESOLVED)
        repo = self.create_repo(self.project, name="organization-bar")

        commit = Commit.objects.create(
            organization_id=self.org.id, repository_id=repo.id, key="11111111", message="gemuse"
        )

        activity = Activity.objects.create(
            project_id=group.project_id,
            group=group,
            type=Activity.SET_RESOLVED_IN_COMMIT,
            ident=commit.id,
            user=user,
            data={"commit": commit.id},
        )

        result = serialize([activity], user)[0]["data"]
        commit = result["commit"]
        assert commit["repository"]["name"] == "organization-bar"
        assert commit["message"] == "gemuse"
</source>
</class>

<class classid="188" nclones="4" nlines="18" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_team.py" startline="64" endline="88" pcid="7138">
    def test_member_access(self):
        user = self.create_user(username="foo")
        organization = self.create_organization()
        self.create_member(user=user, organization=organization)
        team = self.create_team(organization=organization)

        result = serialize(team, user)
        result.pop("dateCreated")

        assert result["hasAccess"] is True
        assert result["isMember"] is False

        organization.flags.allow_joinleave = False
        organization.save()
        result = serialize(team, user)
        # after changing to allow_joinleave=False
        assert result["hasAccess"] is False
        assert result["isMember"] is False

        self.create_team_membership(user=user, team=team)
        result = serialize(team, user)
        # after giving them access to team
        assert result["hasAccess"] is True
        assert result["isMember"] is True

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_team.py" startline="139" endline="164" pcid="7141">
    def test_owner_access(self):
        user = self.create_user(username="foo")
        organization = self.create_organization()
        self.create_member(user=user, organization=organization, role="owner")
        team = self.create_team(organization=organization)

        result = serialize(team, user)
        result.pop("dateCreated")

        assert result["hasAccess"] is True
        assert result["isMember"] is False

        organization.flags.allow_joinleave = False
        organization.save()
        result = serialize(team, user)
        # after changing to allow_joinleave=False
        assert result["hasAccess"] is True
        assert result["isMember"] is False

        self.create_team_membership(user=user, team=team)
        result = serialize(team, user)
        # after giving them access to team
        assert result["hasAccess"] is True
        assert result["isMember"] is True


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_team.py" startline="114" endline="138" pcid="7140">
    def test_manager_access(self):
        user = self.create_user(username="foo")
        organization = self.create_organization()
        self.create_member(user=user, organization=organization, role="manager")
        team = self.create_team(organization=organization)

        result = serialize(team, user)
        result.pop("dateCreated")

        assert result["hasAccess"] is True
        assert result["isMember"] is False

        organization.flags.allow_joinleave = False
        organization.save()
        result = serialize(team, user)
        # after changing to allow_joinleave=False
        assert result["hasAccess"] is True
        assert result["isMember"] is False

        self.create_team_membership(user=user, team=team)
        result = serialize(team, user)
        # after giving them access to team
        assert result["hasAccess"] is True
        assert result["isMember"] is True

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_team.py" startline="89" endline="113" pcid="7139">
    def test_admin_access(self):
        user = self.create_user(username="foo")
        organization = self.create_organization()
        self.create_member(user=user, organization=organization, role="admin")
        team = self.create_team(organization=organization)

        result = serialize(team, user)
        result.pop("dateCreated")

        assert result["hasAccess"] is True
        assert result["isMember"] is False

        organization.flags.allow_joinleave = False
        organization.save()
        result = serialize(team, user)
        # after changing to allow_joinleave=False
        assert result["hasAccess"] is False
        assert result["isMember"] is False

        self.create_team_membership(user=user, team=team)
        result = serialize(team, user)
        # after giving them access to team
        assert result["hasAccess"] is True
        assert result["isMember"] is True

</source>
</class>

<class classid="189" nclones="4" nlines="13" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_grouptagvalue.py" startline="9" endline="23" pcid="7173">
    def test_with_user(self):
        user = self.create_user()
        grouptagvalue = GroupTagValue(
            group_id=0,
            key="sentry:user",
            value="username:ted",
            times_seen=1,
            first_seen=datetime(2018, 1, 1),
            last_seen=datetime(2018, 1, 1),
        )

        result = serialize(grouptagvalue, user)
        assert result["key"] == "user"
        assert result["value"] == "username:ted"
        assert result["name"] == "ted"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_tagvalue.py" startline="43" endline="55" pcid="7204">
    def test_query(self):
        user = self.create_user()
        tagvalue = TagValue(
            key="sentry:user",
            value="username:ted",
            times_seen=1,
            first_seen=datetime(2018, 1, 1),
            last_seen=datetime(2018, 1, 1),
        )

        result = serialize(tagvalue, user, serializer=UserTagValueSerializer(project_id=1))
        assert result["value"] == "username:ted"
        assert result["query"] == 'user.username:"ted"'
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_tagvalue.py" startline="9" endline="24" pcid="7202">
    def test_with_user(self):
        user = self.create_user()
        tagvalue = TagValue(
            key="sentry:user",
            value="username:ted",
            times_seen=1,
            first_seen=datetime(2018, 1, 1),
            last_seen=datetime(2018, 1, 1),
        )

        result = serialize(tagvalue, user)
        assert result["key"] == "user"
        assert result["value"] == "username:ted"
        assert result["name"] == "ted"
        assert result["query"] == 'user.username:"ted"'

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_tagvalue.py" startline="25" endline="41" pcid="7203">
    def test_release(self):
        user = self.create_user()
        tagvalue = TagValue(
            key="sentry:release",
            value="df84bccbb23ca15f2868be1f2a5f7c7a6464fadd",
            times_seen=1,
            first_seen=datetime(2018, 1, 1),
            last_seen=datetime(2018, 1, 1),
        )

        result = serialize(tagvalue, user)
        assert result["key"] == "release"
        assert result["value"] == "df84bccbb23ca15f2868be1f2a5f7c7a6464fadd"
        assert result["name"] == "df84bccbb23ca15f2868be1f2a5f7c7a6464fadd"
        assert "query" not in result


</source>
</class>

<class classid="190" nclones="2" nlines="15" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_group.py" startline="276" endline="294" pcid="7188">
    def test_global_no_conversations_overrides_group_subscription(self):
        user = self.create_user()
        group = self.create_group()

        GroupSubscription.objects.create(
            user=user, group=group, project=group.project, is_active=True
        )

        NotificationSetting.objects.update_settings(
            ExternalProviders.EMAIL,
            NotificationSettingTypes.WORKFLOW,
            NotificationSettingOptionValues.NEVER,
            user=user,
        )

        result = serialize(group, user)
        assert not result["isSubscribed"]
        assert result["subscriptionDetails"] == {"disabled": True}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_group.py" startline="295" endline="314" pcid="7189">
    def test_project_no_conversations_overrides_group_subscription(self):
        user = self.create_user()
        group = self.create_group()

        GroupSubscription.objects.create(
            user=user, group=group, project=group.project, is_active=True
        )

        NotificationSetting.objects.update_settings(
            ExternalProviders.EMAIL,
            NotificationSettingTypes.WORKFLOW,
            NotificationSettingOptionValues.NEVER,
            user=user,
            project=group.project,
        )

        result = serialize(group, user)
        assert not result["isSubscribed"]
        assert result["subscriptionDetails"] == {"disabled": True}

</source>
</class>

<class classid="191" nclones="2" nlines="17" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_app_platform_event.py" startline="35" endline="55" pcid="7198">
    def test_sentry_app_actor(self):
        result = AppPlatformEvent(
            resource="issue",
            action="assigned",
            install=self.install,
            data={},
            actor=self.sentry_app.proxy_user,
        )

        assert json.loads(result.body)["actor"] == {
            "type": "application",
            "id": self.sentry_app.uuid,
            "name": self.sentry_app.name,
        }

        signature = self.sentry_app.build_signature(result.body)

        assert result.headers["Content-Type"] == "application/json"
        assert result.headers["Sentry-Hook-Resource"] == "issue"
        assert result.headers["Sentry-Hook-Signature"] == signature

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_app_platform_event.py" startline="56" endline="75" pcid="7199">
    def test_user_actor(self):
        result = AppPlatformEvent(
            resource="installation",
            action="created",
            install=self.install,
            data={},
            actor=self.user,
        )

        assert json.loads(result.body)["actor"] == {
            "type": "user",
            "id": self.user.id,
            "name": self.user.name,
        }

        signature = self.sentry_app.build_signature(result.body)

        assert result.headers["Content-Type"] == "application/json"
        assert result.headers["Sentry-Hook-Resource"] == "installation"
        assert result.headers["Sentry-Hook-Signature"] == signature
</source>
</class>

<class classid="192" nclones="4" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_external_actor.py" startline="13" endline="26" pcid="7205">
    def setUp(self):
        self.user = self.create_user()
        self.organization = self.create_organization(owner=self.user)
        self.integration = Integration.objects.create(
            provider="slack",
            name="Team A",
            external_id="TXXXXXXX1",
            metadata={
                "access_token": "xoxp-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx",
                "installation_type": "born_as_bot",
            },
        )
        self.org_integration = self.integration.add_organization(self.organization, self.user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="18" endline="33" pcid="10292">
    def setUp(self):
        self.user = self.create_user()
        self.organization = self.create_organization(owner=self.user)
        self.model = Integration.objects.create(
            provider="github_enterprise",
            external_id="github_external_id",
            name="getsentry",
            metadata={
                "domain_name": "35.232.149.196/getsentry",
                "installation_id": "installation_id",
                "installation": {"id": 2, "private_key": "private_key", "verify_ssl": True},
            },
        )
        self.model.add_organization(self.organization, self.user)
        self.integration = GitHubEnterpriseIntegration(self.model, self.organization.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_utils.py" startline="77" endline="91" pcid="10504">
    def setUp(self):
        self.resp = responses.mock
        self.resp.__enter__()

        self.integration = Integration.objects.create(
            provider="slack",
            name="Awesome Team",
            external_id="TXXXXXXX1",
            metadata={
                "access_token": "xoxb-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx",
                "installation_type": "born_as_bot",
            },
        )
        self.integration.add_organization(self.event.project.organization, self.user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_notify_action.py" startline="15" endline="29" pcid="10650">
    def setUp(self):
        event = self.get_event()

        self.integration = Integration.objects.create(
            provider="msteams",
            name="Galactic Empire",
            external_id="D4r7h_Pl4gu315_th3_w153",
            metadata={
                "service_url": "https://smba.trafficmanager.net/amer",
                "access_token": "d4rk51d3",
                "expires_at": int(time.time()) + 86400,
            },
        )
        self.integration.add_organization(event.project.organization, self.user)

</source>
</class>

<class classid="193" nclones="2" nlines="16" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_external_actor.py" startline="27" endline="44" pcid="7206">
    def test_user(self):
        external_actor, _ = ExternalActor.objects.get_or_create(
            actor_id=self.user.actor_id,
            organization=self.organization,
            integration=self.integration,
            provider=ExternalProviders.SLACK.value,
            external_name="Marcos",
            external_id="Gaeta",
        )

        result = serialize(external_actor, self.user, key="user")

        assert "actorId" not in result
        assert result["id"] == str(external_actor.id)
        assert result["externalName"] == "Marcos"
        assert result["externalId"] == "Gaeta"
        assert result["userId"] == str(self.user.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_external_actor.py" startline="45" endline="64" pcid="7207">
    def test_team(self):
        team = self.create_team(organization=self.organization, members=[self.user])

        external_actor, _ = ExternalActor.objects.get_or_create(
            actor_id=team.actor_id,
            organization=self.organization,
            integration=self.integration,
            provider=ExternalProviders.SLACK.value,
            external_name="Marcos",
            external_id="Gaeta",
        )

        result = serialize(external_actor, self.user, key="team")

        assert "actorId" not in result
        assert result["id"] == str(external_actor.id)
        assert result["externalName"] == "Marcos"
        assert result["externalId"] == "Gaeta"
        assert result["teamId"] == str(team.id)

</source>
</class>

<class classid="194" nclones="2" nlines="27" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_external_actor.py" startline="65" endline="96" pcid="7208">
    def test_strict_external_user_name(self):
        # Ensure user names must start with @
        external_actor_user_data = {
            "provider": get_provider_name(ExternalProviders.GITHUB.value),
            "externalName": "raz",
            "integrationId": self.integration.id,
            "userId": self.user.id,
        }
        serializer = ExternalUserSerializer(
            data=external_actor_user_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is False
        assert "externalName" in serializer.errors

        # Ensure longer user names are limited in length
        external_actor_user_data["externalName"] = "@" + ("razputin_aquato" * 20)
        serializer = ExternalUserSerializer(
            data=external_actor_user_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is False
        assert "externalName" in serializer.errors

        # Ensure proper user names are valid
        external_actor_user_data["externalName"] = "@raz"
        serializer = ExternalUserSerializer(
            data=external_actor_user_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is True

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_external_actor.py" startline="97" endline="130" pcid="7209">
    def test_strict_external_team_name(self):
        team = self.create_team(organization=self.organization, members=[self.user])

        # Ensure team names must start with @
        external_actor_team_data = {
            "provider": get_provider_name(ExternalProviders.GITHUB.value),
            "externalName": "the-psychic-six",
            "integrationId": self.integration.id,
            "team_id": team.id,
        }
        serializer = ExternalTeamSerializer(
            data=external_actor_team_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is False
        assert "externalName" in serializer.errors

        # Ensure longer team names are limited in length
        external_actor_team_data["externalName"] = "@" + ("the-psychic-six" * 20)
        serializer = ExternalTeamSerializer(
            data=external_actor_team_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is False
        assert "externalName" in serializer.errors

        # Ensure proper team names are valid
        external_actor_team_data["externalName"] = "@the-psychic-six"
        serializer = ExternalTeamSerializer(
            data=external_actor_team_data,
            context={"organization": self.organization},
        )
        assert serializer.is_valid() is True

</source>
</class>

<class classid="195" nclones="3" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_event.py" startline="43" endline="56" pcid="7213">
    def test_hidden_eventerror(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "breadcrumbs": [""],
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        result = serialize(event)
        assert result["errors"] == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_event.py" startline="80" endline="95" pcid="7215">
    def test_message_interface(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "logentry": {"formatted": "bar"},
                "_meta": {"logentry": {"formatted": {"": {"err": ["some error"]}}}},
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        result = serialize(event)
        assert result["message"] == "bar"
        assert result["_meta"]["message"] == {"": {"err": ["some error"]}}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_event.py" startline="96" endline="111" pcid="7216">
    def test_message_formatted(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "logentry": {"formatted": "baz"},
                "_meta": {"logentry": {"formatted": {"": {"err": ["some error"]}}}},
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        result = serialize(event)
        assert result["message"] == "baz"
        assert result["_meta"]["message"] == {"": {"err": ["some error"]}}

</source>
</class>

<class classid="196" nclones="2" nlines="23" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_event.py" startline="112" endline="141" pcid="7217">
    def test_tags_tuples(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "level": "error",  # creates a derived tag.
                "timestamp": iso_format(before_now(minutes=1)),
                "tags": [["foo", "foo"], ["bar", "bar"], ["last", "tag"], None],
                "_meta": {
                    "tags": {
                        "0": {"1": {"": {"err": ["foo error"]}}},
                        "1": {"0": {"": {"err": ["bar error"]}}},
                        "3": {"": {"err": ["full error"]}},
                    }
                },
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        result = serialize(event)
        # Expect 3 custom tags + derived "level". The ``None``` entry is removed
        # by the serializer as it cannot be rendered. Such entries are generated
        # by Relay normalization.
        assert len(result["tags"]) == 4
        assert result["tags"][0]["value"] == "bar"
        assert result["tags"][1]["value"] == "foo"
        assert result["_meta"]["tags"]["0"]["key"] == {"": {"err": ["bar error"]}}
        assert result["_meta"]["tags"]["1"]["value"] == {"": {"err": ["foo error"]}}
        assert result["_meta"]["tags"].get("2") is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/serializers/test_event.py" startline="142" endline="165" pcid="7218">
    def test_tags_dict(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "tags": {"foo": "foo", "bar": "bar", "last": "tag"},
                "_meta": {
                    "tags": {
                        "foo": {"": {"err": ["foo error"]}},
                        "bar": {"": {"err": ["bar error"]}},
                    }
                },
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        result = serialize(event)
        assert result["tags"][0]["value"] == "bar"
        assert result["tags"][1]["value"] == "foo"
        assert result["_meta"]["tags"]["0"]["value"] == {"": {"err": ["bar error"]}}
        assert result["_meta"]["tags"]["1"]["value"] == {"": {"err": ["foo error"]}}
        assert result["_meta"]["tags"].get("2") is None

</source>
</class>

<class classid="197" nclones="2" nlines="19" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/validators/sentry_apps/test_schema.py" startline="127" endline="149" pcid="7266">
    def test_invalid_textarea_default_value(self):
        schema = {
            "elements": [
                {
                    "type": "alert-rule-action",
                    "title": "Mudpuppy",
                    "settings": {
                        "type": "alert-rule-settings",
                        "uri": "/alert-rule-action",
                        "required_fields": [
                            {
                                "label": "Team",
                                "type": "textarea",
                                "name": "teamId",
                                "default": "issue.something",
                            }
                        ],
                    },
                }
            ]
        }
        validate_ui_element_schema(schema, features={"organizations:alert-rule-ui-component": True})

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/validators/sentry_apps/test_schema.py" startline="153" endline="174" pcid="7267">
    def test_invalid_text_default_value(self):
        schema = {
            "elements": [
                {
                    "type": "alert-rule-action",
                    "title": "Tater Tots",
                    "settings": {
                        "type": "alert-rule-settings",
                        "uri": "/alert-rule-action",
                        "optional_fields": [
                            {
                                "label": "Team",
                                "type": "text",
                                "name": "teamId",
                                "default": "issue.someone",
                            }
                        ],
                    },
                }
            ]
        }
        validate_ui_element_schema(schema, features={"organizations:alert-rule-ui-component": True})
</source>
</class>

<class classid="198" nclones="2" nlines="17" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/test_event_search.py" startline="224" endline="244" pcid="7342">
    def test_rel_time_filter(self):
        now = timezone.now()
        with freeze_time(now):
            assert parse_search_query("time:+7d") == [
                SearchFilter(
                    key=SearchKey(name="time"),
                    operator="<=",
                    value=SearchValue(raw_value=now - timedelta(days=7)),
                )
            ]
            assert parse_search_query("time:-2w") == [
                SearchFilter(
                    key=SearchKey(name="time"),
                    operator=">=",
                    value=SearchValue(raw_value=now - timedelta(days=14)),
                )
            ]
            assert parse_search_query("random:-2w") == [
                SearchFilter(key=SearchKey(name="random"), operator="=", value=SearchValue("-2w"))
            ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_event_search.py" startline="245" endline="265" pcid="7343">
    def test_aggregate_rel_time_filter(self):
        now = timezone.now()
        with freeze_time(now):
            assert parse_search_query("last_seen():+7d") == [
                AggregateFilter(
                    key=AggregateKey(name="last_seen()"),
                    operator="<=",
                    value=SearchValue(raw_value=now - timedelta(days=7)),
                )
            ]
            assert parse_search_query("last_seen():-2w") == [
                AggregateFilter(
                    key=AggregateKey(name="last_seen()"),
                    operator=">=",
                    value=SearchValue(raw_value=now - timedelta(days=14)),
                )
            ]
            assert parse_search_query("random:-2w") == [
                SearchFilter(key=SearchKey(name="random"), operator="=", value=SearchValue("-2w"))
            ]

</source>
</class>

<class classid="199" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/test_invite_helper.py" startline="11" endline="26" pcid="7369">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.user = self.create_user("foo@example.com")
        self.member = self.create_member(
            user=None,
            email="bar@example.com",
            organization=self.org,
            teams=[self.team],
        )
        self.auth_provider = AuthProvider(provider="Friendly IdP", organization=self.organization)

        self.request = HttpRequest()
        self.request.user = self.user

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_accept_organization_invite.py" startline="8" endline="20" pcid="11433">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.member = self.create_member(
            user=None,
            email="bar@example.com",
            organization=self.org,
            role="owner",
            teams=[self.team],
        )

</source>
</class>

<class classid="200" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/api/test_invite_helper.py" startline="43" endline="56" pcid="7371">
    def test_accept_invite_with_SSO(self, mock_provider, get_audit, create_audit):
        self.auth_provider.flags.allow_unlinked = True
        mock_provider.get.return_value = self.auth_provider

        om = OrganizationMember.objects.get(id=self.member.id)
        assert om.email == self.member.email

        helper = ApiInviteHelper(self.request, self.member.id, None)
        helper.accept_invite()

        om = OrganizationMember.objects.get(id=self.member.id)
        assert om.email is None
        assert om.user.id == self.user.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_invite_helper.py" startline="60" endline="74" pcid="7372">
    def test_accept_invite_with_required_SSO(self, mock_provider, get_audit, create_audit):
        self.auth_provider.flags.allow_unlinked = False
        mock_provider.get.return_value = self.auth_provider

        om = OrganizationMember.objects.get(id=self.member.id)
        assert om.email == self.member.email

        helper = ApiInviteHelper(self.request, self.member.id, None)
        helper.accept_invite()

        # Invite cannot be accepted without AuthIdentity if SSO is required
        om = OrganizationMember.objects.get(id=self.member.id)
        assert om.email is not None
        assert om.user is None

</source>
</class>

<class classid="201" nclones="2" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/api/bases/test_project.py" startline="111" endline="126" pcid="7403">
    def test_project_no_team_sentry_app_installed(self):
        project = self.create_project(teams=[self.team])
        self.team.delete()
        other_org = self.create_organization()
        sentry_app = self.create_sentry_app(
            name="my_app",
            organization=other_org,
            scopes=("project:write",),
            webhook_url="http://example.com",
        )
        self.create_sentry_app_installation(
            slug=sentry_app.slug, organization=self.org, user=self.user
        )

        assert self.has_object_perm("POST", project, user=sentry_app.proxy_user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/bases/test_project.py" startline="127" endline="144" pcid="7404">
    def test_project_no_team_sentry_app_not_installed(self):
        project = self.create_project(teams=[self.team])
        self.team.delete()
        other_org = self.create_organization()
        sentry_app = self.create_sentry_app(
            name="my_app",
            organization=other_org,
            scopes=("project:write",),
            webhook_url="http://example.com",
        )
        # install on other org
        self.create_sentry_app_installation(
            slug=sentry_app.slug, organization=other_org, user=self.user
        )

        assert not self.has_object_perm("POST", project, user=sentry_app.proxy_user)


</source>
</class>

<class classid="202" nclones="2" nlines="23" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_tagkey_values.py" startline="28" endline="55" pcid="7471">
    def test_user_tag(self):
        project = self.create_project()
        event = self.store_event(
            data={
                "user": {
                    "id": 1,
                    "email": "foo@example.com",
                    "username": "foo",
                    "ip_address": "127.0.0.1",
                },
                "timestamp": iso_format(before_now(seconds=1)),
            },
            project_id=project.id,
        )
        group = event.group

        self.login_as(user=self.user)

        url = f"/api/0/issues/{group.id}/tags/user/values/"

        response = self.client.get(url)

        assert response.status_code == 200
        assert len(response.data) == 1

        assert response.data[0]["email"] == "foo@example.com"
        assert response.data[0]["value"] == "id:1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_tagkey_values.py" startline="56" endline="86" pcid="7472">
    def test_tag_value_with_backslash(self):
        project = self.create_project()
        event = self.store_event(
            data={
                "message": "minidumpC:\\Users\\test",
                "user": {
                    "id": 1,
                    "email": "foo@example.com",
                    "username": "foo",
                    "ip_address": "127.0.0.1",
                },
                "timestamp": iso_format(before_now(seconds=5)),
                "tags": {"message": "minidumpC:\\Users\\test"},
            },
            project_id=project.id,
        )
        group = event.group

        self.login_as(user=self.user)

        url = (
            f"/api/0/issues/{group.id}/tags/message/values/?query=minidumpC%3A%5C%5CUsers%5C%5Ctest"
        )

        response = self.client.get(url)

        assert response.status_code == 200
        assert len(response.data) == 1

        assert response.data[0]["value"] == "minidumpC:\\Users\\test"

</source>
</class>

<class classid="203" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="27" endline="41" pcid="7481">
    def test_show_all_with_superuser(self):
        Project.objects.all().delete()

        user = self.create_user(is_superuser=True)

        org = self.create_organization(owner=user)
        self.create_project(organization=org)

        org2 = self.create_organization()
        self.create_project(organization=org2)

        self.login_as(user=user, superuser=True)
        response = self.get_valid_response(qs_params={"show": "all"})
        assert len(response.data) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="42" endline="56" pcid="7482">
    def test_show_all_without_superuser(self):
        Project.objects.all().delete()

        user = self.create_user(is_superuser=False)

        org = self.create_organization(owner=user)
        self.create_project(organization=org)

        org2 = self.create_organization()
        self.create_project(organization=org2)

        self.login_as(user=user)
        response = self.get_valid_response()
        assert len(response.data) == 0

</source>
</class>

<class classid="204" nclones="4" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="57" endline="75" pcid="7483">
    def test_status_filter(self):
        Project.objects.all().delete()

        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org, members=[user])
        project1 = self.create_project(teams=[team])
        project2 = self.create_project(teams=[team], status=ProjectStatus.PENDING_DELETION)

        self.login_as(user=user)

        response = self.get_valid_response(qs_params={"status": "active"})
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(project1.id)

        response = self.get_valid_response(qs_params={"status": "deleted"})
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(project2.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="76" endline="93" pcid="7484">
    def test_query_filter(self):
        Project.objects.all().delete()

        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org, members=[user])
        project1 = self.create_project(name="foo", teams=[team])
        self.create_project(name="bar", teams=[team])

        self.login_as(user=user)

        response = self.get_valid_response(qs_params={"query": "foo"})
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(project1.id)

        response = self.get_valid_response(qs_params={"query": "baz"})
        assert len(response.data) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="112" endline="129" pcid="7486">
    def test_id_query(self):
        Project.objects.all().delete()

        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org, members=[user])
        project1 = self.create_project(teams=[team])
        self.create_project(teams=[team])

        self.login_as(user=user)

        response = self.get_valid_response(qs_params={"query": f"id:{project1.id}"})
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(project1.id)

        response = self.get_valid_response(qs_params={"query": "id:-1"})
        assert len(response.data) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="94" endline="111" pcid="7485">
    def test_slug_query(self):
        Project.objects.all().delete()

        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org, members=[user])
        project1 = self.create_project(slug="foo", name="foo", teams=[team])
        self.create_project(name="bar", slug="bar", teams=[team])

        self.login_as(user=user)

        response = self.get_valid_response(qs_params={"query": "slug:foo"})
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(project1.id)

        response = self.get_valid_response(qs_params={"query": "slug:baz"})
        assert len(response.data) == 0

</source>
</class>

<class classid="205" nclones="2" nlines="13" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="130" endline="143" pcid="7487">
    def test_valid_with_internal_integration(self):
        project = self.create_project(organization=self.organization, teams=[self.team])
        self.create_internal_integration(
            name="my_app",
            organization=self.organization,
            scopes=("project:read",),
            webhook_url="http://example.com",
        )
        # there should only be one record created so just grab the first one
        token = SentryAppInstallationToken.objects.first()
        path = reverse(self.endpoint)
        response = self.client.get(path, HTTP_AUTHORIZATION=f"Bearer {token.api_token.token}")
        assert project.name.encode("utf-8") in response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_index.py" startline="144" endline="160" pcid="7488">
    def test_deleted_token_with_internal_integration(self):
        self.create_internal_integration(
            name="my_app",
            organization=self.organization,
            scopes=("project:read",),
            webhook_url="http://example.com",
        )
        # there should only be one record created so just grab the first one
        token = SentryAppInstallationToken.objects.first()
        token = token.api_token.token

        # Delete the token
        SentryAppInstallationToken.objects.all().delete()

        path = reverse(self.endpoint)
        response = self.client.get(path, HTTP_AUTHORIZATION=f"Bearer {token}")
        assert response.status_code == 401
</source>
</class>

<class classid="206" nclones="4" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_repo_path_parsing.py" startline="92" endline="106" pcid="7497">
    def test_basic(self):
        source_url = "https://github.com/getsentry/sentry/blob/master/src/sentry/api/endpoints/project_stacktrace_link.py"
        stack_path = "sentry/api/endpoints/project_stacktrace_link.py"
        resp = self.make_post(source_url, stack_path)
        assert resp.status_code == 200, resp.content

        assert resp.data == {
            "integrationId": self.integration.id,
            "repositoryId": self.repo.id,
            "provider": "github",
            "stackRoot": "",
            "sourceRoot": "src/",
            "defaultBranch": "master",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_repo_path_parsing.py" startline="121" endline="135" pcid="7499">
    def test_long_root(self):
        source_url = "https://github.com/getsentry/sentry/blob/master/src/sentry/api/endpoints/project_stacktrace_link.py"
        stack_path = "stuff/hey/here/sentry/api/endpoints/project_stacktrace_link.py"
        resp = self.make_post(source_url, stack_path)
        assert resp.status_code == 200, resp.content
        assert resp.data == {
            "integrationId": self.integration.id,
            "repositoryId": self.repo.id,
            "provider": "github",
            "stackRoot": "stuff/hey/here",
            "sourceRoot": "src",
            "defaultBranch": "master",
        }


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_repo_path_parsing.py" startline="157" endline="170" pcid="7501">
    def test_basic(self):
        source_url = "https://gitlab.com/getsentry/sentry/-/blob/master/src/sentry/api/endpoints/project_stacktrace_link.py"
        stack_path = "sentry/api/endpoints/project_stacktrace_link.py"
        resp = self.make_post(source_url, stack_path)
        assert resp.status_code == 200, resp.content

        assert resp.data == {
            "integrationId": self.integration.id,
            "repositoryId": self.repo.id,
            "provider": "gitlab",
            "stackRoot": "",
            "sourceRoot": "src/",
            "defaultBranch": "master",
        }
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_repo_path_parsing.py" startline="107" endline="120" pcid="7498">
    def test_short_path(self):
        source_url = "https://github.com/getsentry/sentry/blob/main/project_stacktrace_link.py"
        stack_path = "sentry/project_stacktrace_link.py"
        resp = self.make_post(source_url, stack_path)
        assert resp.status_code == 200, resp.content
        assert resp.data == {
            "integrationId": self.integration.id,
            "repositoryId": self.repo.id,
            "provider": "github",
            "stackRoot": "sentry/",
            "sourceRoot": "",
            "defaultBranch": "main",
        }

</source>
</class>

<class classid="207" nclones="3" nlines="30" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="55" endline="98" pcid="7507">
    def test_simple(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org2 = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team1 = self.create_team(organization=org)
        team2 = self.create_team(organization=org)

        project1 = self.create_project(teams=[team1], organization=org)
        project2 = self.create_project(teams=[team2], organization=org2)
        project3 = self.create_project(teams=[team1], organization=org)

        self.create_member(teams=[team1], user=user, organization=org)

        self.login_as(user=user)

        release1 = Release.objects.create(
            organization_id=org.id, version="1", date_added=datetime(2013, 8, 13, 3, 8, 24, 880386)
        )
        release1.add_project(project1)

        release2 = Release.objects.create(
            organization_id=org2.id, version="2", date_added=datetime(2013, 8, 14, 3, 8, 24, 880386)
        )
        release2.add_project(project2)

        release3 = Release.objects.create(
            organization_id=org.id,
            version="3",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 15, 3, 8, 24, 880386),
        )
        release3.add_project(project3)

        release4 = Release.objects.create(
            organization_id=org.id, version="4", date_added=datetime(2013, 8, 14, 3, 8, 24, 880386)
        )
        release4.add_project(project3)

        response = self.get_valid_response(org.slug)
        self.assert_expected_versions(response, [release4, release1, release3])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1482" endline="1526" pcid="7541">
    def test_project_permissions(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team1 = self.create_team(organization=org)
        team2 = self.create_team(organization=org)

        project1 = self.create_project(teams=[team1], organization=org)
        project2 = self.create_project(teams=[team2], organization=org)

        self.create_member(teams=[team1], user=user, organization=org)
        self.login_as(user=user)

        release1 = Release.objects.create(
            organization_id=org.id, version="1", date_added=datetime(2013, 8, 13, 3, 8, 24, 880386)
        )
        release1.add_project(project1)

        release2 = Release.objects.create(
            organization_id=org.id, version="2", date_added=datetime(2013, 8, 14, 3, 8, 24, 880386)
        )
        release2.add_project(project2)

        release3 = Release.objects.create(
            organization_id=org.id,
            version="3",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 15, 3, 8, 24, 880386),
        )
        release3.add_project(project1)

        url = reverse("sentry-api-0-organization-releases", kwargs={"organization_slug": org.slug})
        response = self.client.post(
            url, data={"version": "1.2.1", "projects": [project1.slug, project2.slug]}
        )

        assert response.status_code == 400
        assert b"Invalid project slugs" in response.content

        response = self.client.post(url, data={"version": "1.2.1", "projects": [project1.slug]})

        assert response.status_code == 201, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="590" endline="625" pcid="7518">
    def test_project_permissions(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team1 = self.create_team(organization=org)
        team2 = self.create_team(organization=org)

        project1 = self.create_project(teams=[team1], organization=org)
        project2 = self.create_project(teams=[team2], organization=org)

        self.create_member(teams=[team1], user=user, organization=org)
        self.login_as(user=user)

        release1 = Release.objects.create(
            organization_id=org.id, version="1", date_added=datetime(2013, 8, 13, 3, 8, 24, 880386)
        )
        release1.add_project(project1)

        release2 = Release.objects.create(
            organization_id=org.id, version="2", date_added=datetime(2013, 8, 14, 3, 8, 24, 880386)
        )
        release2.add_project(project2)

        release3 = Release.objects.create(
            organization_id=org.id,
            version="3",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 15, 3, 8, 24, 880386),
        )
        release3.add_project(project1)

        response = self.get_valid_response(org.slug)
        self.assert_expected_versions(response, [release1, release3])

</source>
</class>

<class classid="208" nclones="3" nlines="37" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="99" endline="144" pcid="7508">
    def test_release_list_order_by_date_added(self):
        """
        Test that ensures that by relying on the default date sorting, releases
        will only be sorted according to `Release.date_added`, and
        `Release.date_released` should have no effect whatsoever on that order
        """
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)

        project = self.create_project(teams=[team], organization=org)

        self.create_member(teams=[team], user=user, organization=org)

        self.login_as(user=user)

        release6 = Release.objects.create(
            organization_id=org.id,
            version="6",
            date_added=datetime(2013, 8, 10, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 20, 3, 8, 24, 880386),
        )
        release6.add_project(project)

        release7 = Release.objects.create(
            organization_id=org.id,
            version="7",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 18, 3, 8, 24, 880386),
        )
        release7.add_project(project)

        release8 = Release.objects.create(
            organization_id=org.id,
            version="8",
            date_added=datetime(2013, 8, 14, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 16, 3, 8, 24, 880386),
        )
        release8.add_project(project)

        response = self.get_valid_response(org.slug)
        self.assert_expected_versions(response, [release8, release7, release6])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="752" endline="806" pcid="7524">
    def test_release_list_order_by_date_added(self):
        """
        Test that ensures that by relying on the default date sorting, releases
        will only be sorted according to `Release.date_added`, and
        `Release.date_released` should have no effect whatsoever on that order
        """
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)

        project = self.create_project(teams=[team], organization=org)

        self.create_member(teams=[team], user=user, organization=org)

        self.login_as(user=user)

        release6 = Release.objects.create(
            organization_id=org.id,
            version="6",
            date_added=datetime(2013, 8, 10, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 20, 3, 8, 24, 880386),
        )
        release6.add_project(project)

        release7 = Release.objects.create(
            organization_id=org.id,
            version="7",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 18, 3, 8, 24, 880386),
        )
        release7.add_project(project)

        release8 = Release.objects.create(
            organization_id=org.id,
            version="8",
            date_added=datetime(2013, 8, 14, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 16, 3, 8, 24, 880386),
        )
        release8.add_project(project)

        url = reverse(
            "sentry-api-0-organization-releases-stats",
            kwargs={"organization_slug": self.organization.slug},
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 3
        assert response.data[0]["version"] == release8.version
        assert response.data[1]["version"] == release7.version
        assert response.data[2]["version"] == release6.version

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="25" endline="71" pcid="8819">
    def test_simple(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo")
        project2 = self.create_project(teams=[team], name="bar")

        release1 = Release.objects.create(
            organization_id=project1.organization_id,
            version="1",
            date_added=datetime(2013, 8, 13, 3, 8, 24, 880386),
        )
        release1.add_project(project1)

        ReleaseProject.objects.filter(project=project1, release=release1).update(new_groups=5)

        release2 = Release.objects.create(
            organization_id=project1.organization_id,
            version="2",
            date_added=datetime(2013, 8, 14, 3, 8, 24, 880386),
        )
        release2.add_project(project1)

        release3 = Release.objects.create(
            organization_id=project1.organization_id,
            version="3",
            date_added=datetime(2013, 8, 12, 3, 8, 24, 880386),
            date_released=datetime(2013, 8, 15, 3, 8, 24, 880386),
        )
        release3.add_project(project1)

        release4 = Release.objects.create(organization_id=project2.organization_id, version="4")
        release4.add_project(project2)

        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={"organization_slug": project1.organization.slug, "project_slug": project1.slug},
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 3
        assert response.data[0]["version"] == release3.version
        assert response.data[1]["version"] == release2.version
        assert response.data[2]["version"] == release1.version
        assert response.data[2]["newGroups"] == 5

</source>
</class>

<class classid="209" nclones="2" nlines="27" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="265" endline="298" pcid="7513">
    def test_query_filter(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)

        project = self.create_project(teams=[team], organization=org)

        self.create_member(teams=[team], user=user, organization=org)

        self.login_as(user=user)

        release = Release.objects.create(
            organization_id=org.id,
            version="foobar",
            date_added=datetime(2013, 8, 13, 3, 8, 24, 880386),
        )
        release.add_project(project)

        release2 = Release.objects.create(
            organization_id=org.id,
            version="sdfsdfsdf",
            date_added=datetime(2013, 8, 13, 3, 8, 24, 880386),
        )
        release2.add_project(project)

        response = self.get_valid_response(org.slug, query="oob")
        self.assert_expected_versions(response, [release])

        response = self.get_valid_response(org.slug, query="baz")
        self.assert_expected_versions(response, [])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="299" endline="339" pcid="7514">
    def test_release_filter(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)

        project = self.create_project(teams=[team], organization=org)

        self.create_member(teams=[team], user=user, organization=org)

        self.login_as(user=user)

        release = Release.objects.create(
            organization_id=org.id,
            version="foobar",
            date_added=datetime(2013, 8, 13, 3, 8, 24, 880386),
        )
        release.add_project(project)

        release2 = Release.objects.create(
            organization_id=org.id,
            version="sdfsdfsdf",
            date_added=datetime(2013, 8, 13, 3, 8, 24, 880386),
        )
        release2.add_project(project)

        response = self.get_valid_response(self.organization.slug, query=f"{RELEASE_ALIAS}:foobar")
        self.assert_expected_versions(response, [release])

        response = self.get_valid_response(self.organization.slug, query=f"{RELEASE_ALIAS}:foo*")
        self.assert_expected_versions(response, [release])

        response = self.get_valid_response(self.organization.slug, query=f"{RELEASE_ALIAS}:baz")
        self.assert_expected_versions(response, [])

        # NOT release
        response = self.get_valid_response(self.organization.slug, query=f"!{RELEASE_ALIAS}:foobar")
        self.assert_expected_versions(response, [release2])

</source>
</class>

<class classid="210" nclones="2" nlines="23" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1150" endline="1185" pcid="7532">
    def test_activity(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)
        project = self.create_project(name="foo", organization=org, teams=[team])
        project2 = self.create_project(name="bar", organization=org, teams=[team])

        self.create_member(teams=[team], user=user, organization=org)
        self.login_as(user=user)

        release = Release.objects.create(
            version="1.2.1", date_released=datetime.utcnow(), organization=org
        )
        release.add_project(project)

        url = reverse("sentry-api-0-organization-releases", kwargs={"organization_slug": org.slug})

        response = self.client.post(url, data={"version": "1.2.1", "projects": [project.slug]})
        assert response.status_code == 208, response.content

        response = self.client.post(
            url, data={"version": "1.2.1", "projects": [project.slug, project2.slug]}
        )

        # should be 201 because 1 project was added
        assert response.status_code == 201, response.content
        assert not Activity.objects.filter(
            type=Activity.RELEASE, project=project, ident=release.version
        ).exists()
        assert Activity.objects.filter(
            type=Activity.RELEASE, project=project2, ident=release.version
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1186" endline="1221" pcid="7533">
    def test_activity_with_long_release(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team = self.create_team(organization=org)
        project = self.create_project(name="foo", organization=org, teams=[team])
        project2 = self.create_project(name="bar", organization=org, teams=[team])

        self.create_member(teams=[team], user=user, organization=org)
        self.login_as(user=user)

        release = Release.objects.create(
            version="x" * 65, date_released=datetime.utcnow(), organization=org
        )
        release.add_project(project)

        url = reverse("sentry-api-0-organization-releases", kwargs={"organization_slug": org.slug})

        response = self.client.post(url, data={"version": "x" * 65, "projects": [project.slug]})
        assert response.status_code == 208, response.content

        response = self.client.post(
            url, data={"version": "x" * 65, "projects": [project.slug, project2.slug]}
        )

        # should be 201 because 1 project was added
        assert response.status_code == 201, response.content
        assert not Activity.objects.filter(
            type=Activity.RELEASE, project=project, ident=release.version[:64]
        ).exists()
        assert Activity.objects.filter(
            type=Activity.RELEASE, project=project2, ident=release.version[:64]
        ).exists()

</source>
</class>

<class classid="211" nclones="2" nlines="48" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1319" endline="1374" pcid="7537">
    def test_commits_from_provider(self, mock_fetch_commits):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        repo = Repository.objects.create(
            organization_id=org.id, name="example/example", provider="dummy"
        )
        repo2 = Repository.objects.create(
            organization_id=org.id, name="example/example2", provider="dummy"
        )

        team = self.create_team(organization=org)
        project = self.create_project(name="foo", organization=org, teams=[team])

        self.create_member(teams=[team], user=user, organization=org)
        self.login_as(user=user)

        url = reverse("sentry-api-0-organization-releases", kwargs={"organization_slug": org.slug})
        self.client.post(
            url,
            data={
                "version": "1",
                "refs": [
                    {"commit": "0" * 40, "repository": repo.name},
                    {"commit": "0" * 40, "repository": repo2.name},
                ],
                "projects": [project.slug],
            },
        )
        response = self.client.post(
            url,
            data={
                "version": "1.2.1",
                "refs": [
                    {"commit": "a" * 40, "repository": repo.name},
                    {"commit": "b" * 40, "repository": repo2.name},
                ],
                "projects": [project.slug],
            },
        )
        assert response.status_code == 201

        mock_fetch_commits.apply_async.assert_called_with(
            kwargs={
                "release_id": Release.objects.get(version="1.2.1", organization=org).id,
                "user_id": user.id,
                "refs": [
                    {"commit": "a" * 40, "repository": repo.name},
                    {"commit": "b" * 40, "repository": repo2.name},
                ],
                "prev_release_id": Release.objects.get(version="1", organization=org).id,
            }
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1376" endline="1432" pcid="7538">
    def test_commits_from_provider_deprecated_head_commits(self, mock_fetch_commits):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        repo = Repository.objects.create(
            organization_id=org.id, name="example/example", provider="dummy"
        )
        repo2 = Repository.objects.create(
            organization_id=org.id, name="example/example2", provider="dummy"
        )

        team = self.create_team(organization=org)
        project = self.create_project(name="foo", organization=org, teams=[team])

        self.create_member(teams=[team], user=user, organization=org)
        self.login_as(user=user)

        url = reverse("sentry-api-0-organization-releases", kwargs={"organization_slug": org.slug})
        self.client.post(
            url,
            data={
                "version": "1",
                "headCommits": [
                    {"currentId": "0" * 40, "repository": repo.name},
                    {"currentId": "0" * 40, "repository": repo2.name},
                ],
                "projects": [project.slug],
            },
        )
        response = self.client.post(
            url,
            data={
                "version": "1.2.1",
                "headCommits": [
                    {"currentId": "a" * 40, "repository": repo.name},
                    {"currentId": "b" * 40, "repository": repo2.name},
                ],
                "projects": [project.slug],
            },
            format="json",
        )

        mock_fetch_commits.apply_async.assert_called_with(
            kwargs={
                "release_id": Release.objects.get(version="1.2.1", organization=org).id,
                "user_id": user.id,
                "refs": [
                    {"commit": "a" * 40, "repository": repo.name, "previousCommit": None},
                    {"commit": "b" * 40, "repository": repo2.name, "previousCommit": None},
                ],
                "prev_release_id": Release.objects.get(version="1", organization=org).id,
            }
        )
        assert response.status_code == 201

</source>
</class>

<class classid="212" nclones="2" nlines="45" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1656" endline="1705" pcid="7546">
    def test_simple(self, mock_fetch_commits):
        refs = [
            {
                "repository": "test/repo",
                "previousCommit": None,
                "commit": "previous-commit-id..current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-will-be-ignored",
                "commit": "previous-commit-id-2..current-commit-id-2",
            },
            {"repository": "test/repo", "commit": "previous-commit-id-3..current-commit-id-3"},
        ]

        response = self.client.post(
            self.url, data={"version": "1", "refs": refs, "projects": [self.project.slug]}
        )

        assert response.status_code == 201

        release = Release.objects.get(version="1", organization=self.org)

        commits = Commit.objects.all().order_by("id")
        self.assert_commit(commits[0], "current-commit-id")
        self.assert_commit(commits[1], "current-commit-id-2")
        self.assert_commit(commits[2], "current-commit-id-3")

        head_commits = ReleaseHeadCommit.objects.all()
        self.assert_head_commit(head_commits[0], "current-commit-id-3", release_id=release.id)

        refs_expected = [
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id",
                "commit": "current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-2",
                "commit": "current-commit-id-2",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-3",
                "commit": "current-commit-id-3",
            },
        ]
        self.assert_fetch_commits(mock_fetch_commits, None, release.id, refs_expected)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1707" endline="1762" pcid="7547">
    def test_head_commit(self, mock_fetch_commits):
        headCommits = [
            {
                "currentId": "current-commit-id",
                "previousId": "previous-commit-id",
                "repository": self.repo.name,
            },
            {
                "currentId": "current-commit-id-2",
                "previousId": "previous-commit-id-2",
                "repository": self.repo.name,
            },
            {
                "currentId": "current-commit-id-3",
                "previousId": "previous-commit-id-3",
                "repository": self.repo.name,
            },
        ]

        response = self.client.post(
            self.url,
            data={"version": "1", "headCommits": headCommits, "projects": [self.project.slug]},
        )

        assert response.status_code == 201

        release = Release.objects.get(version="1", organization=self.org)

        commits = Commit.objects.all().order_by("id")
        self.assert_commit(commits[0], "current-commit-id")
        self.assert_commit(commits[1], "current-commit-id-2")
        self.assert_commit(commits[2], "current-commit-id-3")

        head_commits = ReleaseHeadCommit.objects.all()
        self.assert_head_commit(head_commits[0], "current-commit-id-3", release_id=release.id)

        refs_expected = [
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id",
                "commit": "current-commit-id",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-2",
                "commit": "current-commit-id-2",
            },
            {
                "repository": "test/repo",
                "previousCommit": "previous-commit-id-3",
                "commit": "current-commit-id-3",
            },
        ]
        self.assert_fetch_commits(mock_fetch_commits, None, release.id, refs_expected)


</source>
</class>

<class classid="213" nclones="2" nlines="70" similarity="95">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="1923" endline="2008" pcid="7559">
    def test_commits_with_patch_set(self):
        response = self.client.post(
            self.url,
            data={
                "version": "2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
                "projects": [self.project.slug],
                "commits": [
                    {
                        "patch_set": [
                            {"path": "hello.py", "type": "M"},
                            {"path": "templates/hola.html", "type": "D"},
                        ],
                        "repository": "laurynsentry/helloworld",
                        "author_email": "lauryndbrown@gmail.com",
                        "timestamp": "2018-11-29T18:50:28+03:00",
                        "author_name": "Lauryn Brown",
                        "message": "made changes to hello.",
                        "id": "2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
                    },
                    {
                        "patch_set": [
                            {"path": "templates/hello.html", "type": "M"},
                            {"path": "templates/goodbye.html", "type": "A"},
                        ],
                        "repository": "laurynsentry/helloworld",
                        "author_email": "lauryndbrown@gmail.com",
                        "timestamp": "2018-11-30T22:51:14+03:00",
                        "author_name": "Lauryn Brown",
                        "message": "Changed release",
                        "id": "be2fe070f6d1b8a572b67defc87af2582f9b0d78",
                    },
                ],
            },
        )

        assert response.status_code == 201, (response.status_code, response.content)
        assert response.data["version"]

        release = Release.objects.get(organization_id=self.org.id, version=response.data["version"])

        repo = Repository.objects.get(organization_id=self.org.id, name="laurynsentry/helloworld")
        assert repo.provider is None

        rc_list = list(
            ReleaseCommit.objects.filter(release=release)
            .select_related("commit", "commit__author")
            .order_by("order")
        )
        assert len(rc_list) == 2
        for rc in rc_list:
            assert rc.organization_id

        author = CommitAuthor.objects.get(
            organization_id=self.org.id, email="lauryndbrown@gmail.com"
        )
        assert author.name == "Lauryn Brown"

        commits = [rc.commit for rc in rc_list]
        commits.sort(key=lambda c: c.date_added)

        self.assert_commit(
            commit=commits[0],
            repo_id=repo.id,
            key="2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
            author_id=author.id,
            message="made changes to hello.",
        )

        self.assert_commit(
            commit=commits[1],
            repo_id=repo.id,
            key="be2fe070f6d1b8a572b67defc87af2582f9b0d78",
            author_id=author.id,
            message="Changed release",
        )

        file_changes = CommitFileChange.objects.filter(organization_id=self.org.id).order_by(
            "filename"
        )

        self.assert_file_change(file_changes[0], "M", "hello.py", commits[0].id)
        self.assert_file_change(file_changes[1], "A", "templates/goodbye.html", commits[1].id)
        self.assert_file_change(file_changes[2], "M", "templates/hello.html", commits[1].id)
        self.assert_file_change(file_changes[3], "D", "templates/hola.html", commits[0].id)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="490" endline="572" pcid="8838">
    def test_commits_with_patch_set(self):
        response = self.client.post(
            self.url,
            data={
                "version": "2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
                "projects": [self.project.slug],
                "commits": [
                    {
                        "patch_set": [
                            {"path": "hello.py", "type": "M"},
                            {"path": "templates/hola.html", "type": "D"},
                        ],
                        "repository": "laurynsentry/helloworld",
                        "author_email": "lauryndbrown@gmail.com",
                        "timestamp": "2018-11-29T18:50:28+03:00",
                        "author_name": "Lauryn Brown",
                        "message": "made changes to hello.",
                        "id": "2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
                    },
                    {
                        "patch_set": [
                            {"path": "templates/hello.html", "type": "M"},
                            {"path": "templates/goodbye.html", "type": "A"},
                        ],
                        "repository": "laurynsentry/helloworld",
                        "author_email": "lauryndbrown@gmail.com",
                        "timestamp": "2018-11-30T22:51:14+03:00",
                        "author_name": "Lauryn Brown",
                        "message": "Changed release",
                        "id": "be2fe070f6d1b8a572b67defc87af2582f9b0d78",
                    },
                ],
            },
        )

        assert response.status_code == 201, (response.status_code, response.content)
        assert response.data["version"]

        release = Release.objects.get(organization_id=self.org.id, version=response.data["version"])

        repo = Repository.objects.get(organization_id=self.org.id, name="laurynsentry/helloworld")
        assert repo.provider is None

        rc_list = list(
            ReleaseCommit.objects.filter(release=release).select_related("commit", "commit__author")
        )
        assert len(rc_list) == 2
        for rc in rc_list:
            assert rc.organization_id

        author = CommitAuthor.objects.get(
            organization_id=self.org.id, email="lauryndbrown@gmail.com"
        )
        assert author.name == "Lauryn Brown"

        commits = [rc.commit for rc in rc_list]
        commits.sort(key=lambda c: c.date_added)

        self.assert_commit(
            commit=commits[0],
            repo_id=repo.id,
            key="2d1ab93fe4bb42db80890f01f8358fc9f8fbff3b",
            author_id=author.id,
            message="made changes to hello.",
        )

        self.assert_commit(
            commit=commits[1],
            repo_id=repo.id,
            key="be2fe070f6d1b8a572b67defc87af2582f9b0d78",
            author_id=author.id,
            message="Changed release",
        )

        file_changes = CommitFileChange.objects.filter(organization_id=self.org.id).order_by(
            "filename"
        )

        self.assert_file_change(file_changes[0], "M", "hello.py", commits[0].id)
        self.assert_file_change(file_changes[1], "A", "templates/goodbye.html", commits[1].id)
        self.assert_file_change(file_changes[2], "M", "templates/hello.html", commits[1].id)
        self.assert_file_change(file_changes[3], "D", "templates/hola.html", commits[0].id)

</source>
</class>

<class classid="214" nclones="5" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_releases.py" startline="2150" endline="2161" pcid="7570">
    def test_version_does_not_allow_null_or_empty_value(self):
        serializer = ReleaseSerializerWithProjects(
            data={"version": None, "projects": self.projects},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()
        serializer = ReleaseSerializerWithProjects(
            data={"version": "", "projects": self.projects},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="703" endline="714" pcid="8848">
    def test_version_does_not_allow_null_or_empty_value(self):
        serializer = ReleaseWithVersionSerializer(
            data={"version": None},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()
        serializer = ReleaseWithVersionSerializer(
            data={"version": ""},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="691" endline="702" pcid="8847">
    def test_version_does_not_allow_current_dir_path(self):
        serializer = ReleaseWithVersionSerializer(
            data={"version": "."},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()
        serializer = ReleaseWithVersionSerializer(
            data={"version": ".."},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="659" endline="670" pcid="8844">
    def test_ref_limited_by_max_version_length(self):
        serializer = ReleaseWithVersionSerializer(
            data={"version": self.version, "ref": "a" * MAX_VERSION_LENGTH},
            context={"organization": self.organization},
        )
        assert serializer.is_valid()
        serializer = ReleaseWithVersionSerializer(
            data={"version": self.version, "ref": "a" * (MAX_VERSION_LENGTH + 1)},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="671" endline="682" pcid="8845">
    def test_version_limited_by_max_version_length(self):
        serializer = ReleaseWithVersionSerializer(
            data={"version": "a" * MAX_VERSION_LENGTH},
            context={"organization": self.organization},
        )
        assert serializer.is_valid()
        serializer = ReleaseWithVersionSerializer(
            data={"version": "a" * (MAX_VERSION_LENGTH + 1)},
            context={"organization": self.organization},
        )
        assert not serializer.is_valid()

</source>
</class>

<class classid="215" nclones="2" nlines="29" similarity="74">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_commit_filechange.py" startline="8" endline="46" pcid="7592">
    def test_simple(self):
        project = self.create_project(name="foo")
        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)
        repo = Repository.objects.create(organization_id=project.organization_id, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        CommitFileChange.objects.create(
            organization_id=project.organization_id, commit=commit, filename=".gitignore", type="M"
        )
        CommitFileChange.objects.create(
            organization_id=project.organization_id,
            commit=commit2,
            filename="/static/js/widget.js",
            type="A",
        )
        url = reverse(
            "sentry-api-0-release-commitfilechange",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert len(response.data) == 2
        assert response.data[0]["filename"] == ".gitignore"
        assert response.data[1]["filename"] == "/static/js/widget.js"
</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_commit_files.py" startline="9" endline="41" pcid="12270">
    def setUp(self):
        project = self.create_project(name="foo")
        release = self.create_release(project=project, version="1")
        release.add_project(project)
        repo = self.create_repo(project=project, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        CommitFileChange.objects.create(
            organization_id=project.organization_id, commit=commit, filename=".gitignore", type="M"
        )
        CommitFileChange.objects.create(
            organization_id=project.organization_id,
            commit=commit2,
            filename="/static/js/widget.js",
            type="A",
        )
        self.url = reverse(
            "sentry-api-0-release-commitfilechange",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

</source>
</class>

<class classid="216" nclones="2" nlines="35" similarity="97">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_debug_files.py" startline="60" endline="102" pcid="7602">
    def test_associate_proguard_dsym(self):
        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-dsym-files",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        self.login_as(user=self.user)

        response = self._upload_proguard(url, PROGUARD_UUID)

        assert response.status_code == 201, response.content
        assert len(response.data) == 1
        assert response.data[0]["headers"] == {"Content-Type": "text/x-proguard+plain"}
        assert response.data[0]["sha1"] == "e6d3c5185dac63eddfdc1a5edfffa32d46103b44"
        assert response.data[0]["uuid"] == PROGUARD_UUID
        assert response.data[0]["objectName"] == "proguard-mapping"
        assert response.data[0]["cpuName"] == "any"
        assert response.data[0]["symbolType"] == "proguard"

        url = reverse(
            "sentry-api-0-associate-dsym-files",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        response = self.client.post(
            url,
            {
                "checksums": ["e6d3c5185dac63eddfdc1a5edfffa32d46103b44"],
                "platform": "android",
                "name": "MyApp",
                "appId": "com.example.myapp",
                "version": "1.0",
                "build": "1",
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert "associatedDsymFiles" in response.data
        assert response.data["associatedDsymFiles"] == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_debug_files.py" startline="103" endline="144" pcid="7603">
    def test_associate_proguard_dsym_no_build(self):
        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-dsym-files",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        self.login_as(user=self.user)

        response = self._upload_proguard(url, PROGUARD_UUID)

        assert response.status_code == 201, response.content
        assert len(response.data) == 1
        assert response.data[0]["headers"] == {"Content-Type": "text/x-proguard+plain"}
        assert response.data[0]["sha1"] == "e6d3c5185dac63eddfdc1a5edfffa32d46103b44"
        assert response.data[0]["uuid"] == PROGUARD_UUID
        assert response.data[0]["objectName"] == "proguard-mapping"
        assert response.data[0]["cpuName"] == "any"
        assert response.data[0]["symbolType"] == "proguard"

        url = reverse(
            "sentry-api-0-associate-dsym-files",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        response = self.client.post(
            url,
            {
                "checksums": ["e6d3c5185dac63eddfdc1a5edfffa32d46103b44"],
                "platform": "android",
                "name": "MyApp",
                "appId": "com.example.myapp",
                "version": "1.0",
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert "associatedDsymFiles" in response.data
        assert response.data["associatedDsymFiles"] == []

</source>
</class>

<class classid="217" nclones="3" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="49" endline="71" pcid="7636">
    def test_status_unmigratable(self):
        self.url = self.url + "?status=unmigratable"

        integration = Integration.objects.create(provider="github")

        OrganizationIntegration.objects.create(
            organization_id=self.org.id, integration_id=integration.id
        )

        unmigratable_repo = Repository.objects.create(
            name="NotConnected/foo", organization_id=self.org.id
        )

        with patch(
            "sentry.integrations.github.GitHubIntegration.get_unmigratable_repositories"
        ) as f:
            f.return_value = [unmigratable_repo]

            response = self.client.get(self.url, format="json")

            assert response.status_code == 200, response.content
            assert response.data[0]["name"] == unmigratable_repo.name

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="122" endline="151" pcid="7639">
    def test_status_unmigratable_disabled_org_integration(self):
        self.url = self.url + "?status=unmigratable"

        integration = Integration.objects.create(provider="github")

        OrganizationIntegration.objects.create(
            integration_id=integration.id, organization_id=self.org.id, status=ObjectStatus.DISABLED
        )

        unmigratable_repo = Repository.objects.create(
            name="NotConnected/foo", organization_id=self.org.id
        )

        with patch(
            "sentry.integrations.github.GitHubIntegration.get_unmigratable_repositories"
        ) as f:
            f.return_value = [unmigratable_repo]

            response = self.client.get(self.url, format="json")

            assert response.status_code == 200

            # Shouldn't return the above "unmigratable repo" since the
            # Integration is disabled.
            assert len(response.data) == 0

            # Shouldn't even make the request to get repos
            assert not f.called


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="93" endline="121" pcid="7638">
    def test_status_unmigratable_disabled_integration(self):
        self.url = self.url + "?status=unmigratable"

        integration = Integration.objects.create(provider="github", status=ObjectStatus.DISABLED)

        OrganizationIntegration.objects.create(
            integration_id=integration.id, organization_id=self.org.id
        )

        unmigratable_repo = Repository.objects.create(
            name="NotConnected/foo", organization_id=self.org.id
        )

        with patch(
            "sentry.integrations.github.GitHubIntegration.get_unmigratable_repositories"
        ) as f:
            f.return_value = [unmigratable_repo]

            response = self.client.get(self.url, format="json")

            assert response.status_code == 200

            # Shouldn't return the above "unmigratable repo" since the
            # Integration is disabled.
            assert len(response.data) == 0

            # Shouldn't even make the request to get repos
            assert not f.called

</source>
</class>

<class classid="218" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="169" endline="183" pcid="7641">
    def test_admin_ok(self):
        org = self.create_organization(owner=self.user, name="baz")
        team = self.create_team(name="people", organization=org)

        user = self.create_user(email="admin@example.org")
        self.create_member(organization=org, user=user, teams=[team], role="admin")

        self.login_as(user=user)

        with patch.object(DummyRepositoryProvider, "needs_auth", return_value=False):
            url = reverse("sentry-api-0-organization-repositories", args=[org.slug])
            response = self.client.post(url, data={"provider": "dummy", "name": "getsentry/sentry"})

        assert response.status_code == 201, (response.status_code, response.content)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="184" endline="199" pcid="7642">
    def test_no_access(self):
        org = self.create_organization(owner=self.user, name="baz")
        team = self.create_team(name="people", organization=org)

        user = self.create_user(email="member@example.org")
        self.create_member(organization=org, user=user, teams=[team], role="member")

        self.login_as(user=user)

        with patch.object(DummyRepositoryProvider, "needs_auth", return_value=False):
            url = reverse("sentry-api-0-organization-repositories", args=[org.slug])
            response = self.client.post(url, data={"provider": "dummy", "name": "getsentry/sentry"})

        assert response.status_code == 403, (response.status_code, response.content)


</source>
</class>

<class classid="219" nclones="2" nlines="16" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="219" endline="239" pcid="7644">
    def test_simple(self, mock_build_repository_config):

        with patch.object(
            ExampleRepositoryProvider, "build_repository_config", return_value=self.repo_config_data
        ) as mock_get_repository_data:
            response = self.client.post(
                self.url, data={"provider": "integrations:example", "name": "getsentry/sentry"}
            )
            mock_get_repository_data.assert_called_once_with(
                organization=self.org, data={"my_config_key": "some_var"}
            )

        assert response.status_code == 201, (response.status_code, response.content)
        assert response.data["id"]

        repo = Repository.objects.get(id=response.data["id"])
        assert repo.provider == "integrations:example"
        assert repo.name == "getsentry/sentry"
        assert repo.url == "https://github.com/getsentry/sentry"
        assert repo.config == {"name": "getsentry/sentry"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repositories.py" startline="243" endline="266" pcid="7645">
    def test_floating_repo(self, mock_build_repository_config):
        repo = Repository.objects.create(
            organization_id=self.org.id, name="getsentry/sentry", status=2
        )
        with patch.object(
            ExampleRepositoryProvider, "build_repository_config", return_value=self.repo_config_data
        ) as mock_get_repository_data:
            response = self.client.post(
                self.url, data={"provider": "integrations:example", "name": "getsentry/sentry"}
            )
            mock_get_repository_data.assert_called_once_with(
                organization=self.org, data={"my_config_key": "some_var"}
            )

        assert response.status_code == 201, (response.status_code, response.content)
        assert response.data["id"]
        assert response.data["id"] == str(repo.id)

        repo = Repository.objects.get(id=response.data["id"])
        assert repo.provider == "integrations:example"
        assert repo.name == "getsentry/sentry"
        assert repo.url == "https://github.com/getsentry/sentry"
        assert repo.config == {"name": "getsentry/sentry"}
        assert repo.status == 0
</source>
</class>

<class classid="220" nclones="2" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_teams.py" startline="113" endline="127" pcid="7663">
    def test_query_by_slug(self):
        self.create_team(organization=self.organization, name="foo")
        self.create_team(organization=self.organization, name="bar")
        self.login_as(user=self.user)

        path = f"/api/0/organizations/{self.organization.slug}/teams/?query=slug:foo"
        response = self.client.get(path)
        assert response.status_code == 200, response.content
        assert len(response.data) == 1

        path = f"/api/0/organizations/{self.organization.slug}/teams/?query=slug:foo+slug:bar"
        response = self.client.get(path)
        assert response.status_code == 200, response.content
        assert len(response.data) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_teams.py" startline="128" endline="143" pcid="7664">
    def test_query_by_id(self):
        team1 = self.create_team(organization=self.organization, name="foo")
        team2 = self.create_team(organization=self.organization, name="bar")
        self.login_as(user=self.user)

        path = f"/api/0/organizations/{self.organization.slug}/teams/?query=id:{team1.id}"
        response = self.client.get(path)
        assert response.status_code == 200, response.content
        assert len(response.data) == 1

        path = f"/api/0/organizations/{self.organization.slug}/teams/?query=id:{team1.id}+id:{team2.id}"
        response = self.client.get(path)
        assert response.status_code == 200, response.content
        assert len(response.data) == 2


</source>
</class>

<class classid="221" nclones="2" nlines="13" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_index.py" startline="18" endline="32" pcid="7685">
    def test_get_users_index_empty(self):
        url = reverse("sentry-api-0-organization-scim-member-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=userName%20eq%20%22test.user%40okta.local%22"
        )
        correct_get_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 0,
            "startIndex": 1,
            "itemsPerPage": 0,
            "Resources": [],
        }
        assert response.status_code == 200, response.content
        assert response.data == correct_get_data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="14" endline="26" pcid="8673">
    def test_group_index_empty(self):
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        response = self.client.get(f"{url}?startIndex=1&count=100")
        correct_get_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 0,
            "startIndex": 1,
            "itemsPerPage": 0,
            "Resources": [],
        }
        assert response.status_code == 200, response.content
        assert response.data == correct_get_data

</source>
</class>

<class classid="222" nclones="8" nlines="20" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_index.py" startline="69" endline="94" pcid="7688">
    def test_users_get_populated(self):
        member = self.create_member(organization=self.organization, email="test.user@okta.local")
        url = reverse("sentry-api-0-organization-scim-member-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=userName%20eq%20%22test.user%40okta.local%22"
        )
        correct_get_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
                    "id": str(member.id),
                    "userName": "test.user@okta.local",
                    "emails": [{"primary": True, "value": "test.user@okta.local", "type": "work"}],
                    "name": {"familyName": "N/A", "givenName": "N/A"},
                    "active": True,
                    "meta": {"resourceType": "User"},
                }
            ],
        }
        assert response.status_code == 200, response.content
        assert response.data == correct_get_data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_index.py" startline="153" endline="177" pcid="7691">
    def test_user_index_get_no_active(self):
        member = self.create_member(organization=self.organization, email="test.user@okta.local")
        url = reverse("sentry-api-0-organization-scim-member-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=userName%20eq%20%22test.user%40okta.local%22"
        )
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
                    "id": str(member.id),
                    "userName": "test.user@okta.local",
                    "emails": [{"primary": True, "value": "test.user@okta.local", "type": "work"}],
                    "name": {"familyName": "N/A", "givenName": "N/A"},
                    "meta": {"resourceType": "User"},
                }
            ],
        }


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_index.py" startline="95" endline="120" pcid="7689">
    def test_users_get_filter_case_insensitive(self):
        member = self.create_member(organization=self.organization, email="test.user@okta.local")
        url = reverse("sentry-api-0-organization-scim-member-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=userName%20eq%20%22TEST.USER%40okta.local%22"
        )
        correct_get_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
                    "id": str(member.id),
                    "userName": "test.user@okta.local",
                    "emails": [{"primary": True, "value": "test.user@okta.local", "type": "work"}],
                    "name": {"familyName": "N/A", "givenName": "N/A"},
                    "active": True,
                    "meta": {"resourceType": "User"},
                }
            ],
        }
        assert response.status_code == 200, response.content
        assert response.data == correct_get_data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="111" endline="133" pcid="8677">
    def test_team_filter(self):
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=displayName eq %22{self.team.name}%22"
        )
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
                    "id": str(self.team.id),
                    "displayName": self.team.name,
                    "members": [
                        {"value": str(self.team.member_set[0].id), "display": "admin@localhost"}
                    ],
                    "meta": {"resourceType": "Group"},
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="156" endline="177" pcid="8679">
    def test_team_filter_case_insensitive(self):
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        team = self.create_team(organization=self.organization, name="Name WithASpace")
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=displayName eq %22{team.name.upper()}%22"
        )
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
                    "id": str(team.id),
                    "displayName": team.name,
                    "members": [],
                    "meta": {"resourceType": "Group"},
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="48" endline="71" pcid="8675">
    def test_scim_team_index_populated(self):
        team = self.create_team(organization=self.organization)

        # test team index GET
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        response = self.client.get(f"{url}?startIndex=1&count=100")
        response = self.client.get(url)
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
                    "id": str(team.id),
                    "displayName": team.name,
                    "members": [],
                    "meta": {"resourceType": "Group"},
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="178" endline="197" pcid="8680">
    def test_team_exclude_members_param(self):
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=displayName eq %22{self.team.name}%22&excludedAttributes=members"
        )
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
                    "id": str(self.team.id),
                    "displayName": self.team.name,
                    "meta": {"resourceType": "Group"},
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_index.py" startline="134" endline="155" pcid="8678">
    def test_team_filter_with_space(self):
        url = reverse("sentry-api-0-organization-scim-team-index", args=[self.organization.slug])
        team = self.create_team(organization=self.organization, name="Name WithASpace")
        response = self.client.get(
            f"{url}?startIndex=1&count=100&filter=displayName eq %22{team.name}%22"
        )
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:ListResponse"],
            "totalResults": 1,
            "startIndex": 1,
            "itemsPerPage": 1,
            "Resources": [
                {
                    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
                    "id": str(team.id),
                    "displayName": team.name,
                    "members": [],
                    "meta": {"resourceType": "Group"},
                }
            ],
        }

</source>
</class>

<class classid="223" nclones="4" nlines="23" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_commits.py" startline="8" endline="37" pcid="7737">
    def test_simple(self):
        project = self.create_project(name="foo")
        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)
        repo = Repository.objects.create(organization_id=project.organization_id, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        url = reverse(
            "sentry-api-0-organization-release-commits",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert len(response.data) == 2
        assert response.data[0]["id"] == commit2.key
        assert response.data[1]["id"] == commit.key
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_commits.py" startline="8" endline="41" pcid="8370">
    def test_simple(self):
        project = self.create_project(name="foo")
        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)
        repo = Repository.objects.create(organization_id=project.organization_id, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        url = reverse(
            "sentry-api-0-project-release-commits",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert len(response.data) == 2
        assert response.data[0]["id"] == commit2.key
        assert response.data[1]["id"] == commit.key
</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_project_release_commits.py" startline="9" endline="36" pcid="12275">
    def setUp(self):
        project = self.create_project(name="foo")
        release = self.create_release(project=project, version="1")
        release.add_project(project)
        repo = self.create_repo(project=project, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        self.url = reverse(
            "sentry-api-0-project-release-commits",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_commits.py" startline="9" endline="32" pcid="12264">
    def setUp(self):
        project = self.create_project(name="foo")
        release = self.create_release(project=project, version="1")
        release.add_project(project)
        repo = self.create_repo(project=project, name=project.name)
        commit = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="a" * 40
        )
        commit2 = Commit.objects.create(
            organization_id=project.organization_id, repository_id=repo.id, key="b" * 40
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit, order=1
        )
        ReleaseCommit.objects.create(
            organization_id=project.organization_id, release=release, commit=commit2, order=0
        )
        self.url = reverse(
            "sentry-api-0-organization-release-commits",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

</source>
</class>

<class classid="224" nclones="2" nlines="11" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_installation_external_requests.py" startline="10" endline="26" pcid="7749">
    def setUp(self):
        self.user = self.create_user(email="boop@example.com")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(organization=self.org)

        self.sentry_app = self.create_sentry_app(
            name="Testin", organization=self.org, webhook_url="https://example.com"
        )

        self.install = self.create_sentry_app_installation(
            organization=self.org, slug=self.sentry_app.slug, user=self.user
        )

        self.url = reverse(
            "sentry-api-0-sentry-app-installation-external-requests", args=[self.install.uuid]
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_installation_external_issue_actions.py" startline="9" endline="27" pcid="7971">
    def setUp(self):
        self.superuser = self.create_user(email="a@example.com", is_superuser=True)
        self.user = self.create_user(email="boop@example.com")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="Testin", organization=self.org, webhook_url="https://example.com"
        )

        self.install = self.create_sentry_app_installation(
            organization=self.org, slug=self.sentry_app.slug, user=self.user
        )

        self.url = reverse(
            "sentry-api-0-sentry-app-installation-external-issue-actions", args=[self.install.uuid]
        )

</source>
</class>

<class classid="225" nclones="2" nlines="13" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_installation_external_requests.py" startline="28" endline="43" pcid="7750">
    def test_makes_external_request(self):
        self.login_as(user=self.user)
        options = [{"label": "Project Name", "value": "1234"}]
        responses.add(
            method=responses.GET,
            url=f"https://example.com/get-projects?projectSlug={self.project.slug}&installationId={self.install.uuid}&query=proj",
            json=options,
            status=200,
            content_type="application/json",
            match_querystring=True,
        )
        url = self.url + f"?projectId={self.project.id}&uri=/get-projects&query=proj"
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert response.data == {"choices": [["1234", "Project Name"]]}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_installation_external_requests.py" startline="74" endline="84" pcid="7752">
    def test_external_request_fails(self):
        self.login_as(user=self.user)
        responses.add(
            method=responses.GET,
            url=f"https://example.com/get-projects?installationId={self.project.slug}",
            status=500,
            content_type="application/json",
        )
        url = self.url + f"?uri={self.project.id}"
        response = self.client.get(url, format="json")
        assert response.status_code == 400
</source>
</class>

<class classid="226" nclones="3" nlines="17" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_authenticator_enroll.py" startline="189" endline="207" pcid="7769">
    def test_rate_limited(self, try_enroll, is_limited):
        new_options = settings.SENTRY_OPTIONS.copy()
        new_options["system.url-prefix"] = "https://testserver"
        with self.settings(SENTRY_OPTIONS=new_options):
            self.get_success_response("me", "u2f")
            self.get_error_response(
                "me",
                "u2f",
                method="post",
                status_code=429,
                **{
                    "deviceName": "device name",
                    "challenge": "challenge",
                    "response": "response",
                },
            )

            assert try_enroll.call_count == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_authenticator_enroll.py" startline="438" endline="454" pcid="7785">
    def test_enroll_without_pending_invite__no_error(self, try_enroll, log):
        new_options = settings.SENTRY_OPTIONS.copy()
        new_options["system.url-prefix"] = "https://testserver"
        with self.settings(SENTRY_OPTIONS=new_options):
            self.session["webauthn_register_state"] = "state"
            self.save_session()
            self.get_success_response(
                "me",
                "u2f",
                method="post",
                **{
                    "deviceName": "device name",
                    "challenge": "challenge",
                    "response": "response",
                },
            )
        assert log.error.called is False
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_authenticator_enroll.py" startline="300" endline="316" pcid="7777">
    def setup_u2f(self):
        new_options = settings.SENTRY_OPTIONS.copy()
        new_options["system.url-prefix"] = "https://testserver"
        with self.settings(SENTRY_OPTIONS=new_options):
            self.session["webauthn_register_state"] = "state"
            self.save_session()
            return self.get_success_response(
                "me",
                "u2f",
                method="post",
                **{
                    "deviceName": "device name",
                    "challenge": "challenge",
                    "response": "response",
                },
            )

</source>
</class>

<class classid="227" nclones="2" nlines="15" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_broadcast_details.py" startline="24" endline="43" pcid="7806">
    def test_regular_user(self):
        broadcast1 = Broadcast.objects.create(message="bar", is_active=True)
        broadcast2 = Broadcast.objects.create(message="foo", is_active=False)

        self.add_user_permission(user=self.user, permission="broadcasts.admin")
        self.login_as(user=self.user)

        response = self.client.put(
            f"/api/0/broadcasts/{broadcast1.id}/", {"hasSeen": "1", "message": "foobar"}
        )
        assert response.status_code == 200
        assert response.data["hasSeen"]

        assert BroadcastSeen.objects.filter(user=self.user, broadcast=broadcast1).exists()
        assert not BroadcastSeen.objects.filter(user=self.user, broadcast=broadcast2).exists()
        broadcast1 = Broadcast.objects.get(id=broadcast1.id)
        assert broadcast1.message == "bar"
        broadcast2 = Broadcast.objects.get(id=broadcast2.id)
        assert broadcast2.message == "foo"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_broadcast_details.py" startline="44" endline="62" pcid="7807">
    def test_superuser(self):
        broadcast1 = Broadcast.objects.create(message="bar", is_active=True)
        broadcast2 = Broadcast.objects.create(message="foo", is_active=False)

        self.add_user_permission(user=self.user, permission="broadcasts.admin")
        self.login_as(user=self.user, superuser=True)

        response = self.client.put(
            f"/api/0/broadcasts/{broadcast1.id}/", {"hasSeen": "1", "message": "foobar"}
        )
        assert response.status_code == 200
        assert response.data["hasSeen"]

        assert BroadcastSeen.objects.filter(user=self.user, broadcast=broadcast1).exists()
        assert not BroadcastSeen.objects.filter(user=self.user, broadcast=broadcast2).exists()
        broadcast1 = Broadcast.objects.get(id=broadcast1.id)
        assert broadcast1.message == "foobar"
        broadcast2 = Broadcast.objects.get(id=broadcast2.id)
        assert broadcast2.message == "foo"
</source>
</class>

<class classid="228" nclones="2" nlines="12" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_avatar.py" startline="10" endline="22" pcid="7808">
    def test_get(self):
        team = self.team  # force creation
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-team-avatar",
            kwargs={"organization_slug": team.organization.slug, "team_slug": team.slug},
        )
        response = self.client.get(url)
        assert response.status_code == 200
        assert response.data["id"] == str(team.id)
        assert response.data["avatar"]["avatarType"] == "letter_avatar"
        assert response.data["avatar"]["avatarUuid"] is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_avatar.py" startline="10" endline="22" pcid="8009">
    def test_get(self):
        project = self.project  # force creation
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-avatar",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.get(url)
        assert response.status_code == 200
        assert response.data["id"] == str(project.id)
        assert response.data["avatar"]["avatarType"] == "letter_avatar"
        assert response.data["avatar"]["avatarUuid"] is None

</source>
</class>

<class classid="229" nclones="2" nlines="19" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_avatar.py" startline="23" endline="43" pcid="7809">
    def test_upload(self):
        team = self.team  # force creation
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-team-avatar",
            kwargs={"organization_slug": team.organization.slug, "team_slug": team.slug},
        )
        response = self.client.put(
            url,
            data={
                "avatar_type": "upload",
                "avatar_photo": b64encode(self.load_fixture("avatar.jpg")),
            },
            format="json",
        )

        avatar = TeamAvatar.objects.get(team=team)
        assert response.status_code == 200, response.content
        assert avatar.get_avatar_type_display() == "upload"
        assert avatar.file_id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_avatar.py" startline="23" endline="43" pcid="8010">
    def test_upload(self):
        project = self.project  # force creation
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-avatar",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.put(
            url,
            data={
                "avatar_type": "upload",
                "avatar_photo": b64encode(self.load_fixture("avatar.jpg")),
            },
            format="json",
        )

        avatar = ProjectAvatar.objects.get(project=project)
        assert response.status_code == 200, response.content
        assert avatar.get_avatar_type_display() == "upload"
        assert avatar.file_id

</source>
</class>

<class classid="230" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_avatar.py" startline="44" endline="61" pcid="7810">
    def test_put_bad(self):
        team = self.team  # force creation
        TeamAvatar.objects.create(team=team)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-team-avatar",
            kwargs={"organization_slug": team.organization.slug, "team_slug": team.slug},
        )
        response = self.client.put(url, data={"avatar_type": "upload"}, format="json")

        avatar = TeamAvatar.objects.get(team=team)
        assert response.status_code == 400
        assert avatar.get_avatar_type_display() == "letter_avatar"

        response = self.client.put(url, data={"avatar_type": "foo"}, format="json")
        assert response.status_code == 400
        assert avatar.get_avatar_type_display() == "letter_avatar"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_avatar.py" startline="44" endline="61" pcid="8011">
    def test_put_bad(self):
        project = self.project  # force creation
        ProjectAvatar.objects.create(project=project)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-avatar",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.put(url, data={"avatar_type": "upload"}, format="json")

        avatar = ProjectAvatar.objects.get(project=project)
        assert response.status_code == 400
        assert avatar.get_avatar_type_display() == "letter_avatar"

        response = self.client.put(url, data={"avatar_type": "foo"}, format="json")
        assert response.status_code == 400
        assert avatar.get_avatar_type_display() == "letter_avatar"

</source>
</class>

<class classid="231" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_avatar.py" startline="62" endline="74" pcid="7811">
    def test_put_forbidden(self):
        team = self.team  # force creation
        user = self.create_user(email="a@example.com")

        self.login_as(user=user)

        url = reverse(
            "sentry-api-0-team-avatar",
            kwargs={"organization_slug": team.organization.slug, "team_slug": team.slug},
        )
        response = self.client.put(url, data={"avatar_type": "gravatar"}, format="json")

        assert response.status_code == 403
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_avatar.py" startline="62" endline="74" pcid="8012">
    def test_put_forbidden(self):
        project = self.project  # force creation
        user = self.create_user(email="a@example.com")

        self.login_as(user=user)

        url = reverse(
            "sentry-api-0-project-avatar",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.put(url, data={"avatar_type": "gravatar"}, format="json")

        assert response.status_code == 403
</source>
</class>

<class classid="232" nclones="2" nlines="35" similarity="74">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_hashes_split.py" startline="135" endline="184" pcid="7819">
def test_split_everything(client, default_project, store_stacktrace, reset_snuba):
    """
    We have two events in one group, one has a stacktrace that is a suffix of
    the other. This presents an edgecase where it is legitimate to split up the
    *last hash* of an event as that just happens to not be the last hash of
    some other event. In that case we need to ignore the split for events that
    don't have a next hash to group by.
    """

    event = store_stacktrace(["foo"])
    event2 = store_stacktrace(["bar", "foo"])
    assert event2.group_id == event.group_id

    assert event.data["hierarchical_hashes"] == ["bab925683e73afdb4dc4047397a7b36b"]

    url = f"/api/0/issues/{event.group_id}/hashes/split/"
    response = client.get(url, format="json")
    assert response.status_code == 200
    assert response.data == [
        {
            "childId": None,
            "parentId": None,
            "eventCount": 1,
            "id": "bab925683e73afdb4dc4047397a7b36b",
            "label": "<entire stacktrace>",
            "latestEvent": response.data[0]["latestEvent"],
        },
        {
            "childId": "aa1c4037371150958f9ea22adb110bbc",
            "parentId": None,
            "eventCount": 1,
            "id": "bab925683e73afdb4dc4047397a7b36b",
            "label": "foo",
            "childLabel": "<entire stacktrace>",
            "latestEvent": response.data[1]["latestEvent"],
        },
    ]

    response = client.put(
        f"/api/0/issues/{event.group_id}/hashes/split/?id=bab925683e73afdb4dc4047397a7b36b",
    )
    assert response.status_code == 200

    event3 = store_stacktrace(["foo"])
    assert event3.group_id == event.group_id

    event4 = store_stacktrace(["bar", "foo"])
    assert event4.group_id not in (event.group_id, event2.group_id, event3.group_id)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_hashes_split.py" startline="216" endline="265" pcid="7821">
def test_materialized_hashes_missing(client, default_project, store_stacktrace, reset_snuba):
    """
    Test that we are able to show grouping breakdown if hashes are materialized
    improperly. This can happen if there's a fallback grouping strategy, or due
    to yet-to-be-discovered bugs in merge/unmerge. In those cases we pretend we
    are at the outer level.

    Also test if splitting up the group to the next level works.
    """
    event1 = store_stacktrace(["foo", "bar", "baz"])
    event2 = store_stacktrace(["boo", "bam", "baz"])
    assert event2.group_id == event1.group_id

    GroupHash.objects.filter(group_id=event1.group_id).delete()

    url = f"/api/0/issues/{event1.group_id}/hashes/split/"

    response = client.get(url, format="json")
    assert response.status_code == 200
    assert response.data == [
        {
            "childId": "3d433234e3f52665a03e87b46e423534",
            "parentId": None,
            "childLabel": "bam | ...",
            "eventCount": 1,
            "id": "dc6e6375dcdf74132537129e6a182de7",
            "label": "baz",
            "latestEvent": response.data[0]["latestEvent"],
        },
        {
            "childId": "ce6d941a9829057608a96725c201e636",
            "parentId": None,
            "childLabel": "bar | ...",
            "eventCount": 1,
            "id": "dc6e6375dcdf74132537129e6a182de7",
            "label": "baz",
            "latestEvent": response.data[1]["latestEvent"],
        },
    ]

    response = client.put(
        f"/api/0/issues/{event1.group_id}/hashes/split/?id=dc6e6375dcdf74132537129e6a182de7",
    )
    assert response.status_code == 200

    # There should only be one grouphash associated with this group now, the
    # split one.
    gh = GroupHash.objects.get(group_id=event1.group_id)
    assert gh.hash == "dc6e6375dcdf74132537129e6a182de7"
    assert gh.state == GroupHash.State.SPLIT
</source>
</class>

<class classid="233" nclones="2" nlines="19" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="224" endline="243" pcid="7838">
    def test_simple_member_restriction(self):
        project = self.create_project()
        user = self.create_user("bar@example.com")
        self.create_member(
            user=user,
            organization=project.organization,
            teams=[project.teams.first()],
            role="member",
        )
        self.login_as(user)

        self.get_valid_response(
            self.org_slug,
            self.proj_slug,
            slug="zzz",
            isBookmarked="true",
            status_code=403,
        )
        assert not ProjectBookmark.objects.filter(user=user, project_id=self.project.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="244" endline="266" pcid="7839">
    def test_member_changes_permission_denied(self):
        project = self.create_project()
        user = self.create_user("bar@example.com")
        self.create_member(
            user=user,
            organization=project.organization,
            teams=[project.teams.first()],
            role="member",
        )
        self.login_as(user=user)

        self.get_valid_response(
            self.org_slug,
            self.proj_slug,
            slug="zzz",
            isBookmarked="true",
            status_code=403,
        )

        assert Project.objects.get(id=project.id).slug != "zzz"

        assert not ProjectBookmark.objects.filter(user=user, project_id=project.id).exists()

</source>
</class>

<class classid="234" nclones="2" nlines="26" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="785" endline="820" pcid="7873">
    def test_redacted_symbol_source_secrets(self, create_audit_entry):
        with Feature(
            {"organizations:symbol-sources": True, "organizations:custom-symbol-sources": True}
        ):
            config = {
                "id": "honk",
                "name": "honk source",
                "layout": {
                    "type": "native",
                },
                "filetypes": ["pe"],
                "type": "http",
                "url": "http://honk.beep",
                "username": "honkhonk",
                "password": "beepbeep",
            }
            self.get_valid_response(
                self.org_slug, self.proj_slug, symbolSources=json.dumps([config])
            )
            assert self.project.get_option("sentry:symbol_sources") == json.dumps([config])

            # redact password
            redacted_source = config.copy()
            redacted_source["password"] = {"hidden-secret": True}

            # check that audit entry was created with redacted password
            assert create_audit_entry.called
            call = faux.faux(create_audit_entry)
            assert call.kwarg_equals("data", {"sentry:symbol_sources": [redacted_source]})

            self.get_valid_response(
                self.org_slug, self.proj_slug, symbolSources=json.dumps([redacted_source])
            )
            # on save the magic object should be replaced with the previously set password
            assert self.project.get_option("sentry:symbol_sources") == json.dumps([config])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="822" endline="854" pcid="7874">
    def test_redacted_symbol_source_secrets_unknown_secret(self, create_audit_entry):
        with Feature(
            {"organizations:symbol-sources": True, "organizations:custom-symbol-sources": True}
        ):
            config = {
                "id": "honk",
                "name": "honk source",
                "layout": {
                    "type": "native",
                },
                "filetypes": ["pe"],
                "type": "http",
                "url": "http://honk.beep",
                "username": "honkhonk",
                "password": "beepbeep",
            }
            self.get_valid_response(
                self.org_slug, self.proj_slug, symbolSources=json.dumps([config])
            )
            assert self.project.get_option("sentry:symbol_sources") == json.dumps([config])

            # prepare new call, this secret is not known
            new_source = config.copy()
            new_source["password"] = {"hidden-secret": True}
            new_source["id"] = "oops"
            response = self.get_response(
                self.org_slug, self.proj_slug, symbolSources=json.dumps([new_source])
            )
            assert response.status_code == 400
            assert json.loads(response.content) == {
                "symbolSources": ["Hidden symbol source secret is missing a value"]
            }

</source>
</class>

<class classid="235" nclones="2" nlines="21" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="1031" endline="1055" pcid="7886">
    def test_user_does_not_have_access_to_copy_from_project(self):
        user = self.create_user()
        self.login_as(user=user)
        team = self.create_team(members=[user])
        project = self.create_project(teams=[team], fire_project_created=True)
        OrganizationMember.objects.filter(user=user, organization=self.organization).update(
            role="admin"
        )

        self.organization.flags.allow_joinleave = False
        self.organization.save()
        resp = self.get_valid_response(
            project.organization.slug,
            project.slug,
            copy_from_project=self.other_project.id,
            status_code=400,
        )
        assert resp.data == {
            "copy_from_project": [
                "Project settings cannot be copied from a project you do not have access to."
            ]
        }
        self.assert_other_project_settings_not_changed()
        self.assert_settings_not_copied(project, teams=[team])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_details.py" startline="1056" endline="1087" pcid="7887">
    def test_project_coping_from_has_team_user_lacks_write_access(self):
        user = self.create_user()
        self.login_as(user=user)
        team = self.create_team(members=[user])
        project = self.create_project(teams=[team], fire_project_created=True)
        OrganizationMember.objects.filter(user=user, organization=self.organization).update(
            role="admin"
        )

        self.other_project.add_team(team)

        # adding team user lacks write access to
        self.other_project.add_team(self.create_team())

        self.organization.flags.allow_joinleave = False
        self.organization.save()

        resp = self.get_valid_response(
            project.organization.slug,
            project.slug,
            copy_from_project=self.other_project.id,
            status_code=400,
        )

        assert resp.data == {
            "copy_from_project": [
                "Project settings cannot be copied from a project with a team you do not have write access to."
            ]
        }
        self.assert_other_project_settings_not_changed()
        self.assert_settings_not_copied(project, teams=[team])

</source>
</class>

<class classid="236" nclones="4" nlines="18" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="28" endline="47" pcid="7895">
    def test_no_rules(self):
        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 0
        assert resp.data["rule"] is None
        assert len(resp.data["rules"]) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="100" endline="126" pcid="7898">
    def test_one_owner(self):
        rule_a = Rule(Matcher("path", "*.py"), [Owner("user", self.user.email)])

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema([rule_a]), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 1
        assert resp.data["owners"][0]["id"] == str(self.user.id)
        assert resp.data["rule"] == Matcher("path", "*.py")
        assert len(resp.data["rules"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="74" endline="99" pcid="7897">
    def test_matching_non_existing_owner(self):
        rule_a = Rule(Matcher("path", "*"), [Owner("user", "doesnotexist@fake.com")])

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema([rule_a]), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 0
        assert resp.data["rule"] == Matcher(type="path", pattern="*")
        assert len(resp.data["rules"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="48" endline="73" pcid="7896">
    def test_no_matching_owners(self):
        rule_a = Rule(Matcher("path", "bar.py"), [Owner("user", self.user.email)])

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema([rule_a]), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 0
        assert resp.data["rule"] is None
        assert len(resp.data["rules"]) == 0

</source>
</class>

<class classid="237" nclones="3" nlines="26" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="127" endline="158" pcid="7899">
    def test_multiple_owners(self):
        users = [self.user, self.user2, self.user3]
        rules = [
            Rule(Matcher("path", "*.py"), [Owner("user", users[0].email)]),
            Rule(Matcher("path", "*foo*"), [Owner("user", users[1].email)]),
            Rule(Matcher("path", "*"), [Owner("user", users[2].email)]),
        ]

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema(rules), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 3
        assert [o["id"] for o in resp.data["owners"]] == [str(u.id) for u in users]
        assert resp.data["rule"] == Matcher("path", "*.py")
        assert len(resp.data["rules"]) == 3

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="159" endline="191" pcid="7900">
    def test_multiple_owners_order_matters(self):
        users = [self.user, self.user2, self.user3]
        rules = [
            Rule(Matcher("path", "*.py"), [Owner("user", users[0].email)]),
            Rule(Matcher("path", "*foo*"), [Owner("user", users[1].email)]),
            Rule(Matcher("path", "*"), [Owner("user", users[2].email)]),
        ]
        rules.reverse()

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema(rules), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 3
        assert [o["id"] for o in resp.data["owners"]] == [str(u.id) for u in reversed(users)]
        assert resp.data["rule"] == Matcher("path", "*")
        assert len(resp.data["rules"]) == 3

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_owners.py" startline="192" endline="226" pcid="7901">
    def test_owners_of_different_types_ordered_correctly(self):
        owners = [self.user, self.team3, self.user2, self.team2, self.user3, self.team]
        rules = [
            Rule(Matcher("path", "*.py"), [Owner("user", owners[0].email)]),
            Rule(Matcher("path", "*py"), [Owner("team", owners[1].slug)]),
            Rule(Matcher("path", "*foo*"), [Owner("user", owners[2].email)]),
            Rule(Matcher("path", "*y"), [Owner("team", owners[3].slug)]),
            Rule(Matcher("path", "*"), [Owner("user", owners[4].email)]),
            Rule(Matcher("path", "*o.py"), [Owner("team", owners[5].slug)]),
        ]

        ProjectOwnership.objects.create(
            project_id=self.project.id, schema=dump_schema(rules), fallthrough=True
        )

        event1 = self.store_event(
            data={"stacktrace": {"frames": [{"filename": "foo.py"}]}}, project_id=self.project.id
        )

        self.path = reverse(
            "sentry-api-0-event-owners",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event1.event_id,
            },
        )

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert len(resp.data["owners"]) == 6
        assert [o["id"] for o in resp.data["owners"]] == [str(o.id) for o in owners]
        assert [o["type"] for o in resp.data["owners"]] == ["user", "team"] * 3
        assert resp.data["rule"] == Matcher("path", "*.py")
        assert len(resp.data["rules"]) == 6
</source>
</class>

<class classid="238" nclones="2" nlines="31" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_events_latest.py" startline="6" endline="39" pcid="7915">
    def setUp(self):
        super().setUp()

        self.login_as(user=self.user)
        project = self.create_project()

        self.event_a = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "development",
                "timestamp": iso_format(before_now(days=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_b = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "timestamp": iso_format(before_now(minutes=5)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_c = self.store_event(
            data={
                "event_id": "c" * 32,
                "environment": "staging",
                "timestamp": iso_format(before_now(minutes=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_events_oldest.py" startline="6" endline="39" pcid="8051">
    def setUp(self):
        super().setUp()

        self.login_as(user=self.user)
        project = self.create_project()

        self.event_a = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "development",
                "timestamp": iso_format(before_now(days=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_b = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "timestamp": iso_format(before_now(minutes=5)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_c = self.store_event(
            data={
                "event_id": "c" * 32,
                "environment": "staging",
                "timestamp": iso_format(before_now(minutes=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )

</source>
</class>

<class classid="239" nclones="6" nlines="10" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="123" endline="135" pcid="7928">
    def test_superuser_can_change_is_active(self):
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isActive="false",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert not user.is_active

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="191" endline="205" pcid="7933">
    def test_superuser_with_permission_can_add_staff(self):
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        UserPermission.objects.create(user=superuser, permission="users.admin")
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isStaff="true",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert user.is_staff


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="150" endline="162" pcid="7930">
    def test_superuser_cannot_add_superuser(self):
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isSuperuser="true",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert not user.is_superuser

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="136" endline="149" pcid="7929">
    def test_superuser_with_permission_can_change_is_active(self):
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        UserPermission.objects.create(user=superuser, permission="users.admin")
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isActive="false",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert not user.is_active

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="163" endline="176" pcid="7931">
    def test_superuser_cannot_add_staff(self):
        self.user.update(is_staff=False)
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isStaff="true",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert not user.is_staff

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_details.py" startline="177" endline="190" pcid="7932">
    def test_superuser_with_permission_can_add_superuser(self):
        superuser = self.create_user(email="b@example.com", is_superuser=True)
        UserPermission.objects.create(user=superuser, permission="users.admin")
        self.login_as(user=superuser, superuser=True)

        resp = self.get_valid_response(
            self.user.id,
            isSuperuser="true",
        )
        assert resp.data["id"] == str(self.user.id)

        user = User.objects.get(id=self.user.id)
        assert user.is_superuser

</source>
</class>

<class classid="240" nclones="2" nlines="14" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transfer.py" startline="23" endline="43" pcid="7966">
    def test_transfer_project(self):
        project = self.create_project()
        new_user = self.create_user("b@example.com")
        self.create_organization(name="New Org", owner=new_user)

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-transfer",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        with self.settings(SENTRY_PROJECT=0):
            with self.tasks():
                response = self.client.post(url, {"email": new_user.email})

                assert response.status_code == 204
                # stdout seems to print log messages that mail should be sent but this
                # assertion does not pass
                assert mail.outbox

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transfer.py" startline="44" endline="61" pcid="7967">
    def test_transfer_project_to_invalid_user(self):
        project = self.create_project()
        # new user is not an owner of anything
        new_user = self.create_user("b@example.com")

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-transfer",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        with self.settings(SENTRY_PROJECT=0):
            with self.tasks():
                response = self.client.post(url, {"email": new_user.email})

                assert response.status_code == 404
                assert not mail.outbox
</source>
</class>

<class classid="241" nclones="3" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="151" endline="168" pcid="8017">
    def test_get_feature_disabled(self):
        self.login_as(user=self.user)
        org = self.organization
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        path = f"/api/0/issues/{self.group.id}/integrations/{integration.id}/?action=create"

        with self.feature(
            {
                "organizations:integrations-issue-basic": False,
                "organizations:integrations-issue-sync": False,
            }
        ):
            response = self.client.get(path)
        assert response.status_code == 400
        assert response.data["detail"] == "Your organization does not have access to this feature."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="264" endline="282" pcid="8021">
    def test_post_feature_disabled(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/"

        with self.feature(
            {
                "organizations:integrations-issue-basic": False,
                "organizations:integrations-issue-sync": False,
            }
        ):
            response = self.client.post(path, data={})
        assert response.status_code == 400
        assert response.data["detail"] == "Your organization does not have access to this feature."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="204" endline="222" pcid="8019">
    def test_put_feature_disabled(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/"

        with self.feature(
            {
                "organizations:integrations-issue-basic": False,
                "organizations:integrations-issue-sync": False,
            }
        ):
            response = self.client.put(path, data={"externalIssue": "APP-123"})
        assert response.status_code == 400
        assert response.data["detail"] == "Your organization does not have access to this feature."

</source>
</class>

<class classid="242" nclones="2" nlines="32" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="169" endline="203" pcid="8018">
    def test_simple_put(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/"
        with self.feature("organizations:integrations-issue-basic"):
            response = self.client.put(path, data={"externalIssue": "APP-123"})

            assert response.status_code == 201
            external_issue = ExternalIssue.objects.get(
                key="APP-123", integration_id=integration.id, organization_id=org.id
            )
            assert external_issue.title == "This is a test external issue title"
            assert external_issue.description == "This is a test external issue description"
            assert GroupLink.objects.filter(
                linked_type=GroupLink.LinkedType.issue,
                group_id=group.id,
                linked_id=external_issue.id,
            ).exists()

            activity = Activity.objects.filter(type=Activity.CREATE_ISSUE)[0]
            assert activity.project_id == group.project_id
            assert activity.group_id == group.id
            assert activity.ident is None
            assert activity.user_id == self.user.id
            assert activity.data == {
                "title": "This is a test external issue title",
                "provider": "Example",
                "location": "https://example/issues/APP-123",
                "label": "display name: APP-123",
            }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="223" endline="263" pcid="8020">
    def test_simple_post(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/"

        with self.feature("organizations:integrations-issue-basic"):
            response = self.client.post(path, data={})
            assert response.status_code == 400
            assert response.data["non_field_errors"] == ["Assignee is required"]

            response = self.client.post(path, data={"assignee": "foo@sentry.io"})
            assert response.status_code == 201

            external_issue = ExternalIssue.objects.get(
                key="APP-123", integration_id=integration.id, organization_id=org.id
            )
            assert external_issue.description == "This is a test external issue description"
            assert external_issue.title == "This is a test external issue title"

            assert GroupLink.objects.filter(
                linked_type=GroupLink.LinkedType.issue,
                group_id=group.id,
                linked_id=external_issue.id,
            ).exists()

            activity = Activity.objects.filter(type=Activity.CREATE_ISSUE)[0]
            assert activity.project_id == group.project_id
            assert activity.group_id == group.id
            assert activity.ident is None
            assert activity.user_id == self.user.id
            assert activity.data == {
                "title": "This is a test external issue title",
                "provider": "Example",
                "location": "https://example/issues/APP-123",
                "label": "display name: APP-123",
            }

</source>
</class>

<class classid="243" nclones="3" nlines="24" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="283" endline="310" pcid="8022">
    def test_simple_delete(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        external_issue = ExternalIssue.objects.get_or_create(
            organization_id=org.id, integration_id=integration.id, key="APP-123"
        )[0]

        group_link = GroupLink.objects.get_or_create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )[0]

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/?externalIssue={external_issue.id}"

        with self.feature("organizations:integrations-issue-basic"):
            response = self.client.delete(path)

            assert response.status_code == 204
            assert not ExternalIssue.objects.filter(id=external_issue.id).exists()
            assert not GroupLink.objects.filter(id=group_link.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integration_details.py" startline="311" endline="341" pcid="8023">
    def test_delete_feature_disabled(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)

        external_issue = ExternalIssue.objects.get_or_create(
            organization_id=org.id, integration_id=integration.id, key="APP-123"
        )[0]

        GroupLink.objects.get_or_create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )[0]

        path = f"/api/0/issues/{group.id}/integrations/{integration.id}/?externalIssue={external_issue.id}"

        with self.feature(
            {
                "organizations:integrations-issue-basic": False,
                "organizations:integrations-issue-sync": False,
            }
        ):
            response = self.client.delete(path)
        assert response.status_code == 400
        assert response.data["detail"] == "Your organization does not have access to this feature."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_integrations.py" startline="62" endline="92" pcid="8973">
    def test_feature_disabled(self):
        self.login_as(user=self.user)
        org = self.organization
        group = self.create_group()
        integration = Integration.objects.create(provider="example", name="Example")
        integration.add_organization(org, self.user)
        external_issue = ExternalIssue.objects.create(
            organization_id=org.id,
            integration_id=integration.id,
            key="APP-123",
            title="this is an example title",
            description="this is an example description",
        )
        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_type=GroupLink.LinkedType.issue,
            linked_id=external_issue.id,
            relationship=GroupLink.Relationship.references,
        )

        path = f"/api/0/issues/{group.id}/integrations/"

        with self.feature(
            {
                "organizations:integrations-issue-basic": False,
                "organizations:integrations-issue-sync": False,
            }
        ):
            response = self.client.get(path)
        assert response.data == []
</source>
</class>

<class classid="244" nclones="2" nlines="16" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="9" endline="32" pcid="8030">
    def setUp(self):
        self.superuser = self.create_user(email="superuser@example.com", is_superuser=True)
        self.user = self.create_user(email="user@example.com")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(organization=self.org)
        self.event_id = "d5111da2c28645c5889d072017e3445d"

        self.published_app = self.create_sentry_app(
            name="Published App", organization=self.org, published=True
        )
        self.unowned_published_app = self.create_sentry_app(
            name="Unowned Published App", organization=self.create_organization(), published=True
        )

        self.unpublished_app = self.create_sentry_app(name="Unpublished App", organization=self.org)
        self.unowned_unpublished_app = self.create_sentry_app(
            name="Unowned Unpublished App", organization=self.create_organization()
        )

        self.internal_app = self.create_internal_integration(
            name="Internal app", organization=self.org
        )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_stats.py" startline="8" endline="35" pcid="8694">
    def setUp(self):
        self.superuser = self.create_user(email="superuser@example.com", is_superuser=True)
        self.user = self.create_user(email="user@example.com")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(organization=self.org)

        self.published_app = self.create_sentry_app(
            name="Published App", organization=self.org, published=True
        )
        self.unowned_published_app = self.create_sentry_app(
            name="Unowned Published App", organization=self.create_organization(), published=True
        )

        self.unpublished_app = self.create_sentry_app(name="Unpublished App", organization=self.org)
        self.unowned_unpublished_app = self.create_sentry_app(
            name="Unowned Unpublished App", organization=self.create_organization()
        )

        self.internal_app = self.create_internal_integration(organization=self.org)

        self.published_app_install = self.create_sentry_app_installation(
            slug=self.published_app.slug, organization=self.create_organization()
        )
        self.unowned_published_app_install = self.create_sentry_app_installation(
            slug=self.unowned_published_app.slug, organization=self.create_organization()
        )


</source>
</class>

<class classid="245" nclones="12" nlines="19" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="34" endline="58" pcid="8031">
    def test_superuser_sees_unowned_published_requests(self):
        self.login_as(user=self.superuser, superuser=True)

        buffer = SentryAppWebhookRequestsBuffer(self.unowned_published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unowned_published_app.webhook_url,
        )
        buffer.add_request(
            response_code=500,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unowned_published_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.unowned_published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 2
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.unowned_published_app.slug
        assert response.data[0]["responseCode"] == 500

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="172" endline="196" pcid="8039">
    def test_errors_only_filter(self):
        self.login_as(user=self.user)
        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.published_app.webhook_url,
        )
        buffer.add_request(
            response_code=500,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.published_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        errors_only_response = self.client.get(f"{url}?errorsOnly=true", format="json")
        assert errors_only_response.status_code == 200
        assert len(errors_only_response.data) == 1

        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="225" endline="250" pcid="8041">
    def test_linked_error_not_returned_if_project_does_not_exist(self):
        self.login_as(user=self.user)

        self.store_event(
            data={"event_id": self.event_id, "timestamp": iso_format(before_now(minutes=1))},
            project_id=self.project.id,
        )

        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unpublished_app.webhook_url,
            error_id=self.event_id,
            project_id="1000",
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.published_app.slug
        assert "errorUrl" not in response.data[0]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="274" endline="294" pcid="8043">
    def test_linked_error_not_returned_if_project_doesnt_belong_to_org(self):
        self.login_as(user=self.user)
        unowned_project = self.create_project(organization=self.create_organization())

        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unpublished_app.webhook_url,
            error_id=self.event_id,
            project_id=unowned_project.id,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.published_app.slug
        assert "errorUrl" not in response.data[0]
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="251" endline="273" pcid="8042">
    def test_linked_error_not_returned_if_event_does_not_exist(self):
        self.login_as(user=self.user)

        # event_id doesn't correspond to an existing event because we didn't call store_event

        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unpublished_app.webhook_url,
            error_id=self.event_id,
            project_id=self.project.id,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.published_app.slug
        assert "errorUrl" not in response.data[0]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="197" endline="224" pcid="8040">
    def test_linked_error_id_converts_to_url(self):
        self.login_as(user=self.user)

        event = self.store_event(
            data={"event_id": self.event_id, "timestamp": iso_format(before_now(minutes=1))},
            project_id=self.project.id,
        )

        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unpublished_app.webhook_url,
            error_id=self.event_id,
            project_id=self.project.id,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.published_app.slug
        assert response.data[0]["errorUrl"] == reverse(
            "sentry-organization-event-detail", args=[self.org.slug, event.group_id, event.event_id]
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="127" endline="144" pcid="8036">
    def test_internal_app_requests_does_not_have_organization_field(self):
        self.login_as(user=self.user)
        buffer = SentryAppWebhookRequestsBuffer(self.internal_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.internal_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.internal_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert "organization" not in response.data[0]
        assert response.data[0]["sentryAppSlug"] == self.internal_app.slug
        assert response.data[0]["responseCode"] == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="76" endline="94" pcid="8033">
    def test_user_sees_owned_published_requests(self):
        self.login_as(user=self.user)

        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.published_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["organization"]["slug"] == self.org.slug
        assert response.data[0]["sentryAppSlug"] == self.published_app.slug
        assert response.data[0]["responseCode"] == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="59" endline="75" pcid="8032">
    def test_superuser_sees_unpublished_stats(self):
        self.login_as(user=self.superuser, superuser=True)

        buffer = SentryAppWebhookRequestsBuffer(self.unowned_unpublished_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unowned_unpublished_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.unowned_unpublished_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["sentryAppSlug"] == self.unowned_unpublished_app.slug

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="111" endline="126" pcid="8035">
    def test_user_sees_owned_unpublished_requests(self):
        self.login_as(user=self.user)

        buffer = SentryAppWebhookRequestsBuffer(self.unpublished_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unpublished_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.unpublished_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert len(response.data) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="95" endline="110" pcid="8034">
    def test_user_does_not_see_unowned_published_requests(self):
        self.login_as(user=self.user)

        buffer = SentryAppWebhookRequestsBuffer(self.unowned_published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.unowned_published_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.unowned_published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 403
        assert response.data["detail"] == "You do not have permission to perform this action."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_requests.py" startline="145" endline="163" pcid="8037">
    def test_event_type_filter(self):
        self.login_as(user=self.user)
        buffer = SentryAppWebhookRequestsBuffer(self.published_app)
        buffer.add_request(
            response_code=200,
            org_id=self.org.id,
            event="issue.assigned",
            url=self.published_app.webhook_url,
        )

        url = reverse("sentry-api-0-sentry-app-requests", args=[self.published_app.slug])
        response1 = self.client.get(f"{url}?eventType=issue.created", format="json")
        assert response1.status_code == 200
        assert len(response1.data) == 0

        response2 = self.client.get(f"{url}?eventType=issue.assigned", format="json")
        assert response2.status_code == 200
        assert len(response2.data) == 1

</source>
</class>

<class classid="246" nclones="2" nlines="18" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_committers.py" startline="55" endline="79" pcid="8048">
    def test_no_group(self):
        self.login_as(user=self.user)

        project = self.create_project()

        min_ago = iso_format(before_now(minutes=1))
        event_data = load_data("transaction")
        event_data["start_timestamp"] = min_ago
        event_data["timestamp"] = min_ago

        event = self.store_event(data=event_data, project_id=project.id)

        url = reverse(
            "sentry-api-0-event-file-committers",
            kwargs={
                "event_id": event.event_id,
                "project_slug": event.project.slug,
                "organization_slug": event.project.organization.slug,
            },
        )

        response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content
        assert response.data["detail"] == "Issue not found"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_event_committers.py" startline="80" endline="102" pcid="8049">
    def test_no_release(self):
        self.login_as(user=self.user)

        project = self.create_project()

        min_ago = iso_format(before_now(minutes=1))
        event = self.store_event(
            data={"fingerprint": ["group1"], "timestamp": min_ago}, project_id=project.id
        )

        url = reverse(
            "sentry-api-0-event-file-committers",
            kwargs={
                "event_id": event.event_id,
                "project_slug": event.project.slug,
                "organization_slug": event.project.organization.slug,
            },
        )

        response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content
        assert response.data["detail"] == "Release not found"

</source>
</class>

<class classid="247" nclones="5" nlines="21" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_tagkey_details.py" startline="77" endline="104" pcid="8072">
    def test_protected(self):
        project = self.create_project()
        self.store_event(
            data={"environment": "prod", "timestamp": iso_format(before_now(seconds=1))},
            project_id=project.id,
        )

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-tagkey-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key": "environment",
            },
        )

        response = self.client.delete(url)

        assert response.status_code == 403

        assert (
            tagstore.get_tag_key(
                project.id, None, "environment", status=TagKeyStatus.VISIBLE  # environment_id
            ).status
            == TagKeyStatus.VISIBLE
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_tagkey_values.py" startline="8" endline="32" pcid="8755">
    def test_simple(self):
        project = self.create_project()
        self.store_event(
            data={"tags": {"foo": "bar"}, "timestamp": iso_format(before_now(seconds=1))},
            project_id=project.id,
        )

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key": "foo",
            },
        )

        response = self.client.get(url)

        assert response.status_code == 200
        assert len(response.data) == 1

        assert response.data[0]["value"] == "bar"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_tagkey_values.py" startline="33" endline="61" pcid="8756">
    def test_query(self):
        project = self.create_project()
        self.store_event(
            data={"tags": {"foo": "bar"}, "timestamp": iso_format(before_now(seconds=1))},
            project_id=project.id,
        )

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key": "foo",
            },
        )
        response = self.client.get(url + "?query=bar")

        assert response.status_code == 200
        assert len(response.data) == 1

        assert response.data[0]["value"] == "bar"

        response = self.client.get(url + "?query=foo")

        assert response.status_code == 200
        assert len(response.data) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_tagkey_values.py" startline="62" endline="89" pcid="8757">
    def test_statperiod_query(self):
        project = self.create_project()
        self.store_event(
            data={"tags": {"foo": "bar"}, "timestamp": iso_format(before_now(days=15))},
            project_id=project.id,
        )

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key": "foo",
            },
        )
        response = self.client.get(url + "?query=bar&statsPeriod=14d")

        assert response.status_code == 200
        assert len(response.data) == 0

        response = self.client.get(url + "?query=bar&statsPeriod=30d")

        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["value"] == "bar"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_tagkey_values.py" startline="90" endline="127" pcid="8758">
    def test_start_end_query(self):
        project = self.create_project()
        self.store_event(
            data={"tags": {"foo": "bar"}, "timestamp": iso_format(before_now(days=15))},
            project_id=project.id,
        )

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key": "foo",
            },
        )

        response = self.client.get(
            url
            + "?query=bar&start={}&end={}".format(
                iso_format(before_now(days=14)), iso_format(before_now(seconds=1))
            )
        )

        assert response.status_code == 200
        assert len(response.data) == 0

        response = self.client.get(
            url
            + "?query=bar&start={}&end={}".format(
                iso_format(before_now(days=16)), iso_format(before_now(days=14))
            )
        )

        assert response.status_code == 200
        assert len(response.data) == 1
        assert response.data[0]["value"] == "bar"
</source>
</class>

<class classid="248" nclones="3" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repository_details.py" startline="32" endline="50" pcid="8084">
    def test_delete_no_commits(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user, name="baz")
        repo = Repository.objects.create(name="example", organization_id=org.id)

        url = reverse("sentry-api-0-organization-repository-details", args=[org.slug, repo.id])
        with patch("sentry.db.mixin.uuid4", new=self.get_mock_uuid()):
            response = self.client.delete(url)
        assert response.status_code == 202, (response.status_code, response.content)

        repo = Repository.objects.get(id=repo.id)
        assert repo.status == ObjectStatus.PENDING_DELETION

        assert ScheduledDeletion.objects.filter(
            object_id=repo.id, model_name="Repository", date_scheduled__lte=timezone.now()
        ).exists()
        self.assert_rename_pending_delete(response, repo)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repository_details.py" startline="51" endline="73" pcid="8085">
    def test_delete_with_commits(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user, name="baz")
        repo = Repository.objects.create(
            name="example", organization_id=org.id, external_id="abc123"
        )
        Commit.objects.create(repository_id=repo.id, key="a" * 40, organization_id=org.id)

        url = reverse("sentry-api-0-organization-repository-details", args=[org.slug, repo.id])

        with patch("sentry.db.mixin.uuid4", new=self.get_mock_uuid()):
            response = self.client.delete(url)

        assert response.status_code == 202, (response.status_code, response.content)

        repo = Repository.objects.get(id=repo.id)
        assert repo.status == ObjectStatus.PENDING_DELETION
        assert ScheduledDeletion.objects.filter(
            object_id=repo.id, model_name="Repository", date_scheduled__gt=timezone.now()
        ).exists()
        self.assert_rename_pending_delete(response, repo, "abc123")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repository_details.py" startline="97" endline="118" pcid="8087">
    def test_delete_disabled_with_commits(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user, name="baz")
        repo = Repository.objects.create(
            name="example", organization_id=org.id, status=ObjectStatus.DISABLED
        )
        Commit.objects.create(repository_id=repo.id, key="a" * 40, organization_id=org.id)

        url = reverse("sentry-api-0-organization-repository-details", args=[org.slug, repo.id])

        with patch("sentry.db.mixin.uuid4", new=self.get_mock_uuid()):
            response = self.client.delete(url)

        assert response.status_code == 202, (response.status_code, response.content)

        repo = Repository.objects.get(id=repo.id)
        assert repo.status == ObjectStatus.PENDING_DELETION

        assert ScheduledDeletion.objects.filter(object_id=repo.id, model_name="Repository").exists()
        self.assert_rename_pending_delete(response, repo)

</source>
</class>

<class classid="249" nclones="2" nlines="36" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repository_details.py" startline="205" endline="247" pcid="8091">
    def test_put_cancel_deletion(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user, name="baz")
        integration = Integration.objects.create(provider="example", name="example")
        integration.add_organization(org)

        repo = Repository.objects.create(
            name="uuid-name",
            external_id="uuid-external-id",
            organization_id=org.id,
            status=ObjectStatus.PENDING_DELETION,
            config={"pending_deletion_name": "example-name"},
        )

        OrganizationOption.objects.create(
            organization_id=org.id,
            key=repo.build_pending_deletion_key(),
            value={
                "name": "example-name",
                "external_id": "example-external-id",
                "id": repo.id,
                "model": Repository.__name__,
            },
        )

        url = reverse("sentry-api-0-organization-repository-details", args=[org.slug, repo.id])
        response = self.client.put(url, data={"status": "visible", "integrationId": integration.id})

        assert response.status_code == 200

        repo = Repository.objects.get(id=repo.id)
        assert repo.status == ObjectStatus.VISIBLE
        assert repo.integration_id == integration.id
        assert repo.provider == "integrations:example"
        assert repo.name == "example-name"
        assert repo.external_id == "example-external-id"
        assert repo.config == {}

        assert not OrganizationOption.objects.filter(
            organization_id=org.id, key=repo.build_pending_deletion_key()
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_repository_details.py" startline="248" endline="292" pcid="8092">
    def test_put_cancel_deletion_duplicate_exists(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user, name="baz")
        integration = Integration.objects.create(provider="example", name="example")
        integration.add_organization(org)

        repo = Repository.objects.create(
            name="uuid-name",
            external_id="uuid-external-id",
            organization_id=org.id,
            status=ObjectStatus.PENDING_DELETION,
            config={"pending_deletion_name": "example-name"},
        )

        repo2 = Repository.objects.create(
            name="example_name",
            external_id="uuid-external-id",
            organization_id=org.id,
            status=ObjectStatus.VISIBLE,
        )

        OrganizationOption.objects.create(
            organization_id=org.id,
            key=repo.build_pending_deletion_key(),
            value={
                "name": "example_name",
                "external_id": "example-external-id",
                "id": repo.id,
                "model": Repository.__name__,
            },
        )

        url = reverse("sentry-api-0-organization-repository-details", args=[org.slug, repo.id])
        response = self.client.put(url, data={"status": "visible", "integrationId": integration.id})
        assert response.status_code == 500

        repo = Repository.objects.get(id=repo.id)
        assert repo.status == ObjectStatus.PENDING_DELETION
        assert repo.name == "uuid-name"

        repo2 = Repository.objects.get(id=repo2.id)
        assert repo2.status == ObjectStatus.VISIBLE
        assert repo2.name == "example_name"

</source>
</class>

<class classid="250" nclones="3" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins.py" startline="37" endline="55" pcid="8097">
    def test_exposes_plugins_across_all_org_projects(self):
        url = reverse(
            "sentry-api-0-organization-plugins",
            kwargs={"organization_slug": self.projectA.organization.slug},
        )

        url = f"{url}?plugins=slack&plugins=webhooks"

        response = self.client.get(url)

        assert response.status_code == 200, (response.status_code, response.content)

        enabled_plugins = [
            (p["project"]["id"], p["slug"]) for p in [p for p in response.data if p["enabled"]]
        ]

        assert (self.projectA.id, "webhooks") in enabled_plugins
        assert (self.projectB.id, "slack") in enabled_plugins

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins.py" startline="56" endline="73" pcid="8098">
    def test_exposes_specific_plugins_across_all_org_projects(self):
        url = reverse(
            "sentry-api-0-organization-plugins",
            kwargs={"organization_slug": self.projectA.organization.slug},
        )

        url = f"{url}?plugins=slack"
        response = self.client.get(url)

        assert response.status_code == 200, (response.status_code, response.content)

        enabled_plugins = [
            (p["project"]["id"], p["slug"]) for p in [p for p in response.data if p["enabled"]]
        ]

        assert (self.projectA.id, "webhooks") not in enabled_plugins
        assert (self.projectB.id, "slack") in enabled_plugins

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins.py" startline="74" endline="89" pcid="8099">
    def test_ignore_plugins_that_dont_exist(self):
        url = reverse(
            "sentry-api-0-organization-plugins",
            kwargs={"organization_slug": self.projectA.organization.slug},
        )

        url = f"{url}?plugins=nope&plugins=beep&plugins=slack"
        response = self.client.get(url)

        assert response.status_code == 200, (response.status_code, response.content)

        enabled_plugins = [
            (p["project"]["id"], p["slug"]) for p in [p for p in response.data if p["enabled"]]
        ]

        assert enabled_plugins == [(self.projectB.id, "slack")]
</source>
</class>

<class classid="251" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_release_deploys.py" startline="91" endline="108" pcid="8102">
    def test_environment_validation_failure(self):
        project = self.create_project(name="example")
        release = Release.objects.create(
            organization_id=project.organization_id, version="123", total_deploys=0
        )
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-deploys",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)
        response = self.client.post(
            url, data={"name": "foo", "environment": "bad/name", "url": "https://www.example.com"}
        )
        assert response.status_code == 400, response.content
        assert 0 == Deploy.objects.count()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="77" endline="95" pcid="8571">
    def test_no_file(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url, {"header": "X-SourceMap: http://example.com"}, format="multipart"
        )

        assert response.status_code == 400, response.content

</source>
</class>

<class classid="252" nclones="2" nlines="13" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_requests.py" startline="8" endline="25" pcid="8103">
    def test_owner_can_list_access_requests(self):
        self.login_as(user=self.user)

        organization = self.create_organization(name="foo", owner=self.user)
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        OrganizationAccessRequest.objects.create(member=member, team=team)

        path = reverse("sentry-api-0-organization-access-requests", args=[organization.slug])

        resp = self.client.get(path)

        assert resp.status_code == 200
        assert len(resp.data) == 1
        assert resp.data[0]["member"]["email"] == "bar@example.com"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_requests.py" startline="60" endline="79" pcid="8105">
    def test_member_empty_results(self):
        self.login_as(user=self.user)

        organization = self.create_organization(name="foo", owner=self.user)
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        OrganizationAccessRequest.objects.create(member=member, team=team)

        user = self.create_user("foo@example.com")
        member = self.create_member(organization=organization, user=user, role="member")

        path = reverse("sentry-api-0-organization-access-requests", args=[organization.slug])

        self.login_as(user=user)
        resp = self.client.get(path)

        assert resp.status_code == 200
        assert len(resp.data) == 0
</source>
</class>

<class classid="253" nclones="2" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_publickeys.py" startline="59" endline="79" pcid="8108">
    def test_get_project_config_internal(self):
        result = self._call_endpoint(self.internal_relay)
        legacy_keys = result["public_keys"]
        keys = result["relays"]

        # check legacy
        assert legacy_keys[self.relay_a.relay_id] == self.relay_a.public_key
        assert legacy_keys[self.relay_b.relay_id] == self.relay_b.public_key
        assert legacy_keys[self.non_existing_key] is None

        # check new results
        relay_a_info = keys[self.relay_a.relay_id]
        assert relay_a_info["publicKey"] == self.relay_a.public_key
        assert not relay_a_info["internal"]

        relay_b_info = keys[self.relay_b.relay_id]
        assert relay_b_info["publicKey"] == self.relay_b.public_key
        assert relay_b_info["internal"]

        assert keys[self.non_existing_key] is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_publickeys.py" startline="80" endline="103" pcid="8109">
    def test_get_project_config_external(self):

        with disable_internal_networks():
            result = self._call_endpoint(self.external_relay)

        legacy_keys = result["public_keys"]
        keys = result["relays"]

        # check legacy
        assert legacy_keys[self.relay_a.relay_id] == self.relay_a.public_key
        assert legacy_keys[self.relay_b.relay_id] == self.relay_b.public_key
        assert legacy_keys[self.non_existing_key] is None

        # check new results
        relay_a_info = keys[self.relay_a.relay_id]
        assert relay_a_info["publicKey"] == self.relay_a.public_key
        assert not relay_a_info["internal"]

        relay_b_info = keys[self.relay_b.relay_id]
        assert relay_b_info["publicKey"] == self.relay_b.public_key
        assert not relay_b_info["internal"]

        assert keys[self.non_existing_key] is None

</source>
</class>

<class classid="254" nclones="2" nlines="56" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="46" endline="93" pcid="8132">
    def test_basic(self, mock_gen_aws_client, mock_get_supported_functions):
        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaA",
                "Runtime": "nodejs12.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaA",
                "Layers": [
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-layer:3"},
                ],
            },
            {
                "FunctionName": "lambdaD",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaD",
                "Layers": [{"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"}],
            },
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
                "Layers": [{"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-layer:2"}],
            },
        ]
        assert self.get_response().data == [
            {
                "name": "lambdaA",
                "runtime": "nodejs12.x",
                "version": 3,
                "outOfDate": False,
                "enabled": True,
            },
            {
                "name": "lambdaB",
                "runtime": "nodejs10.x",
                "version": 2,
                "outOfDate": True,
                "enabled": True,
            },
            {
                "name": "lambdaD",
                "runtime": "nodejs10.x",
                "version": -1,
                "outOfDate": False,
                "enabled": False,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="96" endline="162" pcid="8133">
    def test_basic_python_functions(self, mock_gen_aws_client, mock_get_supported_functions):
        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaA",
                "Runtime": "python3.6",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaA",
                "Layers": [
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34"},
                ],
                "Environment": {"Variables": {"SENTRY_INITIAL_HANDLER": "handler_string"}},
            },
            {
                "FunctionName": "lambdaD",
                "Runtime": "python3.8",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaD",
                "Layers": [{"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"}],
            },
            {
                "FunctionName": "lambdaB",
                "Runtime": "python3.8",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
                "Layers": [{"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34"}],
            },
            {
                "FunctionName": "lambdaC",
                "Runtime": "python3.6",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaC",
                "Layers": [
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                    {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:22"},
                ],
                "Environment": {"Variables": {"SENTRY_INITIAL_HANDLER": "handler_string"}},
            },
        ]
        assert self.get_response().data == [
            {
                "name": "lambdaA",
                "runtime": "python3.6",
                "version": 34,
                "outOfDate": False,
                "enabled": True,
            },
            {
                "name": "lambdaB",
                "runtime": "python3.8",
                "version": -1,
                "outOfDate": False,
                "enabled": False,
            },
            {
                "name": "lambdaC",
                "runtime": "python3.6",
                "version": 22,
                "outOfDate": True,
                "enabled": True,
            },
            {
                "name": "lambdaD",
                "runtime": "python3.8",
                "version": -1,
                "outOfDate": False,
                "enabled": False,
            },
        ]


</source>
</class>

<class classid="255" nclones="7" nlines="39" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="168" endline="210" pcid="8134">
    def test_enable_node_layer(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaD",
                    "Runtime": "nodejs10.x",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaD",
                    "Layers": ["arn:aws:lambda:us-east-2:1234:layer:something-else:2"],
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaD",
            "runtime": "nodejs10.x",
            "version": 3,
            "outOfDate": False,
            "enabled": True,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="enable", target="lambdaD").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaD")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaD",
            Layers=[
                "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                "arn:aws:lambda:us-east-2:1234:layer:my-layer:3",
            ],
            Environment={
                "Variables": {
                    "NODE_OPTIONS": "-r @sentry/serverless/dist/awslambda-auto",
                    "SENTRY_DSN": self.sentry_dsn,
                    "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                }
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="405" endline="452" pcid="8139">
    def test_update_python_version(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaG",
                    "Runtime": "python3.6",
                    "Handler": "sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaG",
                    "Layers": [
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:2"},
                    ],
                    "Environment": {
                        "Variables": {
                            "SENTRY_INITIAL_HANDLER": "lambda_test.lambda_handler",
                            "SENTRY_DSN": self.sentry_dsn,
                            "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                            "OTHER": "hi",
                        }
                    },
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaG",
            "runtime": "python3.8",
            "version": 3,
            "outOfDate": False,
            "enabled": True,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="updateVersion", target="lambdaG").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaG")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaG",
            Layers=[
                "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34",
            ],
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="213" endline="257" pcid="8135">
    def test_enable_python_layer(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaE",
                    "Runtime": "python3.8",
                    "Handler": "lambda_handler.test_handler",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaE",
                    "Layers": ["arn:aws:lambda:us-east-2:1234:layer:something-else:2"],
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaE",
            "runtime": "python3.8",
            "version": 3,
            "outOfDate": False,
            "enabled": True,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="enable", target="lambdaE").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaE")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaE",
            Layers=[
                "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34",
            ],
            Environment={
                "Variables": {
                    "SENTRY_INITIAL_HANDLER": "lambda_handler.test_handler",
                    "SENTRY_DSN": self.sentry_dsn,
                    "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                }
            },
            Handler="sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="356" endline="402" pcid="8138">
    def test_update_node_version(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaD",
                    "Runtime": "nodejs10.x",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaD",
                    "Layers": [
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-layer:2"},
                    ],
                    "Environment": {
                        "Variables": {
                            "NODE_OPTIONS": "-r @sentry/serverless/dist/awslambda-auto",
                            "SENTRY_DSN": self.sentry_dsn,
                            "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                            "OTHER": "hi",
                        }
                    },
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaD",
            "runtime": "nodejs10.x",
            "version": 3,
            "outOfDate": False,
            "enabled": True,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="updateVersion", target="lambdaD").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaD")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaD",
            Layers=[
                "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                "arn:aws:lambda:us-east-2:1234:layer:my-layer:3",
            ],
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="307" endline="353" pcid="8137">
    def test_disable_python(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaF",
                    "Runtime": "python3.6",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaF",
                    "Handler": "sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
                    "Layers": [
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34"},
                    ],
                    "Environment": {
                        "Variables": {
                            "SENTRY_INITIAL_HANDLER": "lambda_handler.test_handler",
                            "SENTRY_DSN": self.sentry_dsn,
                            "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                            "OTHER": "hi",
                        }
                    },
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaF",
            "runtime": "python3.6",
            "version": -1,
            "outOfDate": False,
            "enabled": False,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="disable", target="lambdaF").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaF")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaF",
            Layers=["arn:aws:lambda:us-east-2:1234:layer:something-else:2"],
            Environment={"Variables": {"OTHER": "hi"}},
            Handler="lambda_handler.test_handler",
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="455" endline="519" pcid="8140">
    def test_enable_python_layer_on_already_enabled(
        self, mock_gen_aws_client, mock_get_serialized_lambda_function
    ):
        """
        Test that ensures that if sentry-sdk is already enabled, then
        re-enabling it should not override the env variables since it could be
        problematic since the SENTRY_INITIAL_HANDLER env variable could be overriden
        the second time with "sentry_sdk.integrations.init_serverless_sdk.
        sentry_lambda_handler" and then disabling the sentry-sdk, would break
        the function because the Handler will be updated with an incorrect
        SENTRY_INITIAL_HANDLER value
        """
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaZ",
                    "Runtime": "python3.8",
                    "Handler": "sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaZ",
                    "Layers": [
                        "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                        "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34",
                    ],
                    "Environment": {
                        "Variables": {
                            "SENTRY_INITIAL_HANDLER": "lambda_handler.test_handler",
                            "SENTRY_DSN": self.sentry_dsn,
                            "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                        }
                    },
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaZ",
            "runtime": "python3.8",
            "version": 3,
            "outOfDate": False,
            "enabled": True,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="enable", target="lambdaZ").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaZ")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaZ",
            Layers=[
                "arn:aws:lambda:us-east-2:1234:layer:something-else:2",
                "arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34",
            ],
            Environment={
                "Variables": {
                    "SENTRY_INITIAL_HANDLER": "lambda_handler.test_handler",
                    "SENTRY_DSN": self.sentry_dsn,
                    "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                }
            },
            Handler="sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_integration_serverless_functions.py" startline="260" endline="304" pcid="8136">
    def test_disable_node(self, mock_gen_aws_client, mock_get_serialized_lambda_function):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client

        mock_client.get_function = MagicMock(
            return_value={
                "Configuration": {
                    "FunctionName": "lambdaD",
                    "Runtime": "nodejs10.x",
                    "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaD",
                    "Layers": [
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:something-else:2"},
                        {"Arn": "arn:aws:lambda:us-east-2:1234:layer:my-layer:3"},
                    ],
                    "Environment": {
                        "Variables": {
                            "NODE_OPTIONS": "-r @sentry/serverless/dist/awslambda-auto",
                            "SENTRY_DSN": self.sentry_dsn,
                            "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                            "OTHER": "hi",
                        }
                    },
                },
            }
        )
        mock_client.update_function_configuration = MagicMock()
        return_value = {
            "name": "lambdaD",
            "runtime": "nodejs10.x",
            "version": -1,
            "outOfDate": False,
            "enabled": False,
        }
        mock_get_serialized_lambda_function.return_value = return_value

        assert self.get_response(action="disable", target="lambdaD").data == return_value

        mock_client.get_function.assert_called_with(FunctionName="lambdaD")

        mock_client.update_function_configuration.assert_called_with(
            FunctionName="lambdaD",
            Layers=["arn:aws:lambda:us-east-2:1234:layer:something-else:2"],
            Environment={"Variables": {"OTHER": "hi"}},
        )

</source>
</class>

<class classid="256" nclones="2" nlines="19" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transaction_threshold_override.py" startline="39" endline="61" pcid="8142">
    def test_get_for_project_with_custom_threshold(self):
        ProjectTransactionThresholdOverride.objects.create(
            transaction="earth",
            project=self.project,
            organization=self.project.organization,
            threshold=400,
            metric=TransactionMetric.LCP.value,
        )

        with self.feature(self.feature_name):
            response = self.client.get(
                self.url,
                data={
                    "project": [self.project.id],
                    "transaction": self.data["transaction"],
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        assert response.data["threshold"] == "400"
        assert response.data["metric"] == "lcp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transaction_threshold_override.py" startline="75" endline="94" pcid="8144">
    def test_get_returns_error_without_feature_enabled(self):
        with self.feature({self.feature_name: False, "organizations:discover-basic": False}):
            ProjectTransactionThresholdOverride.objects.create(
                project=self.project,
                organization=self.project.organization,
                threshold=300,
                metric=TransactionMetric.DURATION.value,
                transaction=self.data["transaction"],
            )

            response = self.client.get(
                self.url,
                data={
                    "project": [self.project.id],
                    "transaction": self.data["transaction"],
                },
                format="json",
            )
            assert response.status_code == 404

</source>
</class>

<class classid="257" nclones="2" nlines="25" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transaction_threshold_override.py" startline="154" endline="184" pcid="8147">
    def test_update_project_threshold(self):
        with self.feature(self.feature_name):
            response = self.client.post(
                self.url,
                data={
                    "transaction": self.data["transaction"],
                    "project": [self.project.id],
                    "metric": "duration",
                    "threshold": "300",
                },
            )

        assert response.status_code == 201, response.content
        assert response.data["threshold"] == "300"
        assert response.data["metric"] == "duration"

        with self.feature(self.feature_name):
            response = self.client.post(
                self.url,
                data={
                    "transaction": self.data["transaction"],
                    "project": [self.project.id],
                    "metric": "lcp",
                    "threshold": "600",
                },
            )

        assert response.status_code == 200, response.content
        assert response.data["threshold"] == "600"
        assert response.data["metric"] == "lcp"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_transaction_threshold.py" startline="120" endline="146" pcid="8901">
    def test_update_project_threshold(self):
        with self.feature(self.feature_name):
            response = self.client.post(
                self.url,
                data={
                    "metric": "duration",
                    "threshold": "300",
                },
            )

        assert response.status_code == 201, response.content
        assert response.data["threshold"] == "300"
        assert response.data["metric"] == "duration"

        with self.feature(self.feature_name):
            response = self.client.post(
                self.url,
                data={
                    "metric": "lcp",
                    "threshold": "400",
                },
            )

        assert response.status_code == 200, response.content
        assert response.data["threshold"] == "400"
        assert response.data["metric"] == "lcp"

</source>
</class>

<class classid="258" nclones="9" nlines="20" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="14" endline="43" pcid="8150">
    def test_passing(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/", data={"status": "ok"}
            )

        assert resp.status_code == 201, resp.content

        checkin = MonitorCheckIn.objects.get(guid=resp.data["id"])
        assert checkin.status == CheckInStatus.OK

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.status == MonitorStatus.OK
        assert monitor.last_checkin == checkin.date_added
        assert monitor.next_checkin == monitor.get_next_scheduled_checkin(checkin.date_added)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="105" endline="127" pcid="8153">
    def test_pending_deletion(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            status=MonitorStatus.PENDING_DELETION,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/", data={"status": "error"}
            )

        assert resp.status_code == 404, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="128" endline="150" pcid="8154">
    def test_deletion_in_progress(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            status=MonitorStatus.DELETION_IN_PROGRESS,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/", data={"status": "error"}
            )

        assert resp.status_code == 404, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="74" endline="104" pcid="8152">
    def test_disabled(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            status=MonitorStatus.DISABLED,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/", data={"status": "error"}
            )

        assert resp.status_code == 201, resp.content

        checkin = MonitorCheckIn.objects.get(guid=resp.data["id"])
        assert checkin.status == CheckInStatus.ERROR

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.status == MonitorStatus.DISABLED
        assert monitor.last_checkin == checkin.date_added
        assert monitor.next_checkin == monitor.get_next_scheduled_checkin(checkin.date_added)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="44" endline="73" pcid="8151">
    def test_failing(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/", data={"status": "error"}
            )

        assert resp.status_code == 201, resp.content

        checkin = MonitorCheckIn.objects.get(guid=resp.data["id"])
        assert checkin.status == CheckInStatus.ERROR

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.status == MonitorStatus.ERROR
        assert monitor.last_checkin == checkin.date_added
        assert monitor.next_checkin == monitor.get_next_scheduled_checkin(checkin.date_added)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_details.py" startline="201" endline="223" pcid="8639">
    def test_simple(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.delete(f"/api/0/monitors/{monitor.guid}/")

        assert resp.status_code == 202, resp.content

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.status == MonitorStatus.PENDING_DELETION
        assert ScheduledDeletion.objects.filter(object_id=monitor.id, model_name="Monitor").exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_details.py" startline="10" endline="31" pcid="8625">
    def test_simple(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.get(f"/api/0/monitors/{monitor.guid}/")

        assert resp.status_code == 200, resp.content
        assert resp.data["id"] == str(monitor.guid)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="178" endline="198" pcid="8156">
    def test_with_dsn_auth_invalid_project(self):
        project = self.create_project()
        project2 = self.create_project()
        project_key = self.create_project_key(project=project)

        monitor = Monitor.objects.create(
            organization_id=project2.organization_id,
            project_id=project2.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/",
                HTTP_AUTHORIZATION=f"DSN {project_key.dsn_public}",
                data={"status": "ok"},
            )

        assert resp.status_code == 400, resp.content
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkins.py" startline="151" endline="174" pcid="8155">
    def test_with_dsn_auth(self):
        project = self.create_project()
        project_key = self.create_project_key(project=project)

        monitor = Monitor.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
        )

        with self.feature({"organizations:monitors": True}):
            resp = self.client.post(
                f"/api/0/monitors/{monitor.guid}/checkins/",
                HTTP_AUTHORIZATION=f"DSN {project_key.dsn_public}",
                data={"status": "ok"},
            )

        assert resp.status_code == 201, resp.content
        # DSN auth should only return id
        assert list(resp.data.keys()) == ["id"]
        assert UUID(resp.data["id"])

</source>
</class>

<class classid="259" nclones="2" nlines="28" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkin_details.py" startline="10" endline="44" pcid="8182">
    def test_passing(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            date_added=timezone.now() - timedelta(minutes=1),
        )
        checkin = MonitorCheckIn.objects.create(
            monitor=monitor, project_id=project.id, date_added=monitor.date_added
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.put(
                f"/api/0/monitors/{monitor.guid}/checkins/{checkin.guid}/",
                data={"status": "ok"},
            )

        assert resp.status_code == 200, resp.content

        checkin = MonitorCheckIn.objects.get(id=checkin.id)
        assert checkin.status == CheckInStatus.OK

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.next_checkin > checkin.date_added
        assert monitor.status == MonitorStatus.OK
        assert monitor.last_checkin > checkin.date_added

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_monitor_checkin_details.py" startline="45" endline="78" pcid="8183">
    def test_failing(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team = self.create_team(organization=org, members=[user])
        project = self.create_project(teams=[team])

        monitor = Monitor.objects.create(
            organization_id=org.id,
            project_id=project.id,
            next_checkin=timezone.now() - timedelta(minutes=1),
            type=MonitorType.CRON_JOB,
            config={"schedule": "* * * * *"},
            date_added=timezone.now() - timedelta(minutes=1),
        )
        checkin = MonitorCheckIn.objects.create(
            monitor=monitor, project_id=project.id, date_added=monitor.date_added
        )

        self.login_as(user=user)
        with self.feature({"organizations:monitors": True}):
            resp = self.client.put(
                f"/api/0/monitors/{monitor.guid}/checkins/{checkin.guid}/",
                data={"status": "error"},
            )

        assert resp.status_code == 200, resp.content

        checkin = MonitorCheckIn.objects.get(id=checkin.id)
        assert checkin.status == CheckInStatus.ERROR

        monitor = Monitor.objects.get(id=monitor.id)
        assert monitor.next_checkin > checkin.date_added
        assert monitor.status == MonitorStatus.ERROR
        assert monitor.last_checkin > checkin.date_added
</source>
</class>

<class classid="260" nclones="2" nlines="23" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_users.py" startline="8" endline="35" pcid="8192">
    def setUp(self):
        super().setUp()

        self.project = self.create_project()
        self.euser1 = EventUser.objects.create(
            project_id=self.project.id,
            ident="1",
            email="foo@example.com",
            username="foobar",
            ip_address="127.0.0.1",
        )

        self.euser2 = EventUser.objects.create(
            project_id=self.project.id,
            ident="2",
            email="bar@example.com",
            username="baz",
            ip_address="192.168.0.1",
        )

        self.path = reverse(
            "sentry-api-0-project-users",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/projects/test_users.py" startline="9" endline="32" pcid="12321">
    def setUp(self):
        self.project = self.create_project()
        self.euser1 = EventUser.objects.create(
            project_id=self.project.id,
            ident="1",
            email="foo@example.com",
            username="foobar",
            ip_address="127.0.0.1",
        )

        self.euser2 = EventUser.objects.create(
            project_id=self.project.id,
            ident="2",
            email="bar@example.com",
            username="baz",
            ip_address="192.168.0.1",
        )
        self.url = reverse(
            "sentry-api-0-project-users",
            kwargs={"organization_slug": self.organization.slug, "project_slug": self.project.slug},
        )

        self.login_as(user=self.user)

</source>
</class>

<class classid="261" nclones="8" nlines="23" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="13" endline="42" pcid="8199">
    def test_simple(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(releasefile.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_file_details.py" startline="119" endline="152" pcid="8528">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.put(url, {"name": "foobar"})

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(releasefile.id)

        releasefile = ReleaseFile.objects.get(id=releasefile.id)
        assert releasefile.name == "foobar"
        assert releasefile.ident == ReleaseFile.get_ident("foobar")


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="10" endline="36" pcid="8569">
    def test_simple(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(releasefile.id)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_file_details.py" startline="13" endline="42" pcid="8927">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(releasefile.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_file_details.py" startline="154" endline="190" pcid="8529">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(
            project_id=project.id, organization_id=project.organization_id, version="1"
        )
        release.add_project(project)

        assert release.count_artifacts() == 0

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        assert release.count_artifacts() == 1

        url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.delete(url)

        assert response.status_code == 204, response.content

        assert not ReleaseFile.objects.filter(id=releasefile.id).exists()
        assert not File.objects.filter(id=releasefile.file.id).exists()
        assert release.count_artifacts() == 0
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_file_details.py" startline="175" endline="208" pcid="8934">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.put(url, {"name": "foobar"})

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(releasefile.id)

        releasefile = ReleaseFile.objects.get(id=releasefile.id)
        assert releasefile.name == "foobar"
        assert releasefile.ident == ReleaseFile.get_ident("foobar")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_file_details.py" startline="10" endline="38" pcid="8522">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(releasefile.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_file_details.py" startline="231" endline="269" pcid="8936">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(
            project_id=project.id, organization_id=project.organization_id, version="1"
        )
        release.add_project(project)

        assert release.count_artifacts() == 0

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            release_id=release.id,
            file=File.objects.create(name="application.js", type="release.file"),
            name="http://example.com/application.js",
        )

        assert release.count_artifacts() == 1

        url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.delete(url)

        assert response.status_code == 204, response.content

        assert not ReleaseFile.objects.filter(id=releasefile.id).exists()
        assert not File.objects.filter(id=releasefile.file.id).exists()
        assert release.count_artifacts() == 0

</source>
</class>

<class classid="262" nclones="3" nlines="17" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="127" endline="143" pcid="8202">
    def test_sort_order(self):
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "version": self.release.version,
            },
        )
        self.create_release_archive()
        response = self.client.get(url)
        assert response.status_code == 200, response.content
        assert len(response.data) == 2
        assert response.data[0]["name"] == "~/index.js"
        assert response.data[1]["name"] == "~/index.js.map"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="160" endline="181" pcid="8204">
    def test_archive_paging(self):
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "version": self.release.version,
            },
        )
        self.create_release_archive()
        response = self.client.get(url + "?cursor=0:1:0&per_page=1")
        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["name"] == "~/index.js"

        response = self.client.get(url + "?cursor=1:1:0&per_page=1")
        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["name"] == "~/index.js.map"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="144" endline="159" pcid="8203">
    def test_archive_search(self):
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "version": self.release.version,
            },
        )
        self.create_release_archive()
        response = self.client.get(url + "?query=map")
        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["name"] == "~/index.js.map"

</source>
</class>

<class classid="263" nclones="15" nlines="27" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="183" endline="225" pcid="8205">
    def test_simple(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        assert release.count_artifacts() == 0

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "X-SourceMap: http://example.com",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert release.count_artifacts() == 1

        assert response.status_code == 201, response.content

        releasefile = ReleaseFile.objects.get(release_id=release.id)
        assert releasefile.name == "http://example.com/application.js"
        assert releasefile.ident == ReleaseFile.get_ident("http://example.com/application.js")
        assert releasefile.file.headers == {
            "Content-Type": "application/javascript",
            "X-SourceMap": "http://example.com",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="313" endline="357" pcid="8209">
    def test_bad_headers(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "lol",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "X-SourceMap: http://example.com/\r\n\ntest.map.js\n",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="282" endline="312" pcid="8208">
    def test_invalid_name(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://exa\tmple.com/applic\nati\ron.js\n",
                "header": "X-SourceMap: http://example.com/test.map.js",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="38" endline="76" pcid="8570">
    def test_simple(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        assert release.count_artifacts() == 0

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "X-SourceMap: http://example.com",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert release.count_artifacts() == 1

        assert response.status_code == 201, response.content

        releasefile = ReleaseFile.objects.get(release_id=release.id)
        assert releasefile.name == "http://example.com/application.js"
        assert releasefile.ident == ReleaseFile.get_ident("http://example.com/application.js")
        assert releasefile.file.headers == {
            "Content-Type": "application/javascript",
            "X-SourceMap": "http://example.com",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="152" endline="192" pcid="8574">
    def test_bad_headers(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "lol",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

        response = self.client.post(
            url,
            {
                "name": "http://example.com/application.js",
                "header": "X-SourceMap: http://example.com/\r\n\ntest.map.js\n",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="605" endline="633" pcid="8870">
    def test_invalid_rule_node_type(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "conditions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "actions": [],
            },
            format="json",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="634" endline="662" pcid="8871">
    def test_invalid_rule_node(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "conditions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "actions": [{"id": "foo"}],
            },
            format="json",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="724" endline="752" pcid="8874">
    def test_rule_form_missing_action(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "action": [],
                "conditions": [{"id": "sentry.rules.conditions.tagged_event.TaggedEventCondition"}],
            },
            format="json",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="96" endline="124" pcid="8572">
    def test_missing_name(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "header": "X-SourceMap: http://example.com",
                # We can't use SimpleUploadedFile here, because it validates file names
                # and doesn't allow for empty strings.
                "file": ContentFile(
                    content=b"function() { }",
                    name="",
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="125" endline="151" pcid="8573">
    def test_invalid_name(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "name": "http://exa\tmple.com/applic\nati\ron.js\n",
                "header": "X-SourceMap: http://example.com/test.map.js",
                "file": SimpleUploadedFile(
                    "application.js", b"function() { }", content_type="application/javascript"
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="663" endline="691" pcid="8872">
    def test_rule_form_not_valid(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "conditions": [{"id": "sentry.rules.conditions.tagged_event.TaggedEventCondition"}],
                "actions": [],
            },
            format="json",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="249" endline="281" pcid="8207">
    def test_missing_name(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        response = self.client.post(
            url,
            {
                "header": "X-SourceMap: http://example.com",
                # We can't use SimpleUploadedFile here, because it validates file names
                # and doesn't allow for empty strings.
                "file": ContentFile(
                    content=b"function() { }",
                    name="",
                ),
            },
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="299" endline="338" pcid="8865">
    def test_with_environment(self):
        self.login_as(user=self.user)

        project = self.create_project()

        Environment.get_or_create(project, "production")

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "environment": "production",
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "conditions": [
                    {"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}
                ],
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)
        assert response.data["environment"] == "production"

        rule = Rule.objects.get(id=rule.id)
        assert rule.label == "hello world"
        assert rule.environment_id == Environment.get_or_create(rule.project, "production").id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="692" endline="723" pcid="8873">
    def test_rule_form_owner_perms(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        other_user = self.create_user()
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "conditions": [{"id": "sentry.rules.conditions.tagged_event.TaggedEventCondition"}],
                "actions": [],
                "owner": other_user.actor.get_actor_identifier(),
            },
            format="json",
        )

        assert response.status_code == 400, response.content
        assert str(response.data["owner"][0]) == "User is not a member of this organization"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="339" endline="380" pcid="8866">
    def test_with_null_environment(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(
            project=project,
            environment_id=Environment.get_or_create(project, "production").id,
            label="foo",
        )

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "environment": None,
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "conditions": [
                    {"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}
                ],
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)
        assert response.data["environment"] is None

        rule = Rule.objects.get(id=rule.id)
        assert rule.label == "hello world"
        assert rule.environment_id is None

</source>
</class>

<class classid="264" nclones="2" nlines="28" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_files.py" startline="358" endline="399" pcid="8210">
    def test_duplicate_file(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(
            project_id=project.id, organization_id=project.organization_id, version="1"
        )
        release.add_project(project)

        url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }

        response = self.client.post(url, data, format="multipart")

        assert response.status_code == 201, response.content

        releasefile = ReleaseFile.objects.get(release_id=release.id)
        assert releasefile.name == "http://example.com/application.js"
        assert releasefile.file.headers == {
            "Content-Type": "application/javascript",
            "X-SourceMap": "http://example.com",
        }

        # Now upload it again!
        response = self.client.post(url, data, format="multipart")

        assert response.status_code == 409, response.content
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_files.py" startline="193" endline="230" pcid="8575">
    def test_duplicate_file(self):
        project = self.create_project(name="foo")

        release = Release.objects.create(
            project_id=project.id, organization_id=project.organization_id, version="1"
        )
        release.add_project(project)

        url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }

        response = self.client.post(url, data, format="multipart")

        assert response.status_code == 201, response.content

        releasefile = ReleaseFile.objects.get(release_id=release.id)
        assert releasefile.name == "http://example.com/application.js"
        assert releasefile.file.headers == {
            "Content-Type": "application/javascript",
            "X-SourceMap": "http://example.com",
        }

        # Now upload it again!
        response = self.client.post(url, data, format="multipart")

        assert response.status_code == 409, response.content
</source>
</class>

<class classid="265" nclones="3" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_token.py" startline="8" endline="25" pcid="8214">
    def test_simple(self):
        project = self.create_project(name="foo")
        token = "abcdefghijklmnop"

        ProjectOption.objects.set_value(project, "sentry:release-token", token)

        url = reverse(
            "sentry-api-0-project-releases-token",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["token"] == "abcdefghijklmnop"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_token.py" startline="42" endline="59" pcid="8216">
    def test_regenerates_token(self):
        project = self.create_project(name="foo")
        token = "abcdefghijklmnop"

        ProjectOption.objects.set_value(project, "sentry:release-token", token)

        url = reverse(
            "sentry-api-0-project-releases-token",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        self.login_as(user=self.user)

        response = self.client.post(url, {"project": project.slug})

        assert response.status_code == 200, response.content
        assert response.data["token"] is not None
        assert response.data["token"] != "abcdefghijklmnop"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_token.py" startline="26" endline="41" pcid="8215">
    def test_generates_token(self):
        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-project-releases-token",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        self.login_as(user=self.user)

        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["token"] is not None
        assert ProjectOption.objects.get_value(project, "sentry:release-token") is not None

</source>
</class>

<class classid="266" nclones="3" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_projects.py" startline="71" endline="85" pcid="8223">
    def test_search_by_ids(self):
        project_bar = self.create_project(teams=[self.team], name="bar", slug="bar")
        project_foo = self.create_project(teams=[self.team], name="foo", slug="foo")
        self.create_project(teams=[self.team], name="baz", slug="baz")

        response = self.get_valid_response(
            self.organization.slug, qs_params={"query": f"id:{project_foo.id}"}
        )
        self.check_valid_response(response, [project_foo])

        response = self.get_valid_response(
            self.organization.slug, qs_params={"query": f"id:{project_bar.id} id:{project_foo.id}"}
        )
        self.check_valid_response(response, [project_bar, project_foo])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_projects.py" startline="86" endline="101" pcid="8224">
    def test_search_by_slugs(self):
        project_bar = self.create_project(teams=[self.team], name="bar", slug="bar")
        project_foo = self.create_project(teams=[self.team], name="foo", slug="foo")
        self.create_project(teams=[self.team], name="baz", slug="baz")

        response = self.get_valid_response(
            self.organization.slug, qs_params={"query": f"slug:{project_foo.slug}"}
        )
        self.check_valid_response(response, [project_foo])

        response = self.get_valid_response(
            self.organization.slug,
            qs_params={"query": f"slug:{project_bar.slug} slug:{project_foo.slug}"},
        )
        self.check_valid_response(response, [project_bar, project_foo])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_projects.py" startline="130" endline="146" pcid="8226">
    def test_team_filter(self):
        other_team = self.create_team(organization=self.organization)

        project_bar = self.create_project(teams=[self.team], name="bar", slug="bar")
        project_foo = self.create_project(teams=[other_team], name="foo", slug="foo")
        project_baz = self.create_project(teams=[other_team], name="baz", slug="baz")

        response = self.get_valid_response(
            self.organization.slug, qs_params={"query": f"team:{self.team.slug}"}
        )
        self.check_valid_response(response, [project_bar])

        response = self.get_valid_response(
            self.organization.slug, qs_params={"query": f"!team:{self.team.slug}"}
        )
        self.check_valid_response(response, [project_baz, project_foo])

</source>
</class>

<class classid="267" nclones="2" nlines="11" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_stats.py" startline="13" endline="26" pcid="8242">
    def test_simple(self):
        tsdb.incr(tsdb.models.key_total_received, self.key.id, count=3)
        tsdb.incr(tsdb.models.key_total_blacklisted, self.key.id, count=1)

        response = self.client.get(self.path)
        assert response.status_code == 200

        assert response.status_code == 200, response.content
        assert response.data[-1]["total"] == 3, response.data
        assert response.data[-1]["filtered"] == 1, response.data
        for point in response.data[:-1]:
            assert point["total"] == 0
        assert len(response.data) == 24

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_stats.py" startline="34" endline="45" pcid="8244">
    def test_str_key_id(self):
        tsdb.incr(tsdb.models.key_total_received, self.key.id, count=1)
        tsdb.incr(tsdb.models.key_total_received, str(self.key.id), count=1)

        response = self.client.get(self.path)
        assert response.status_code == 200

        assert response.status_code == 200, response.content
        assert response.data[-1]["total"] == 2, response.data
        for point in response.data[:-1]:
            assert point["total"] == 0
        assert len(response.data) == 24
</source>
</class>

<class classid="268" nclones="4" nlines="16" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_details.py" startline="41" endline="58" pcid="8289">
    def test_user_details_get(self):
        member = self.create_member(organization=self.organization, email="test.user@okta.local")
        url = reverse(
            "sentry-api-0-organization-scim-member-details",
            args=[self.organization.slug, member.id],
        )
        response = self.client.get(url)
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
            "id": str(member.id),
            "userName": "test.user@okta.local",
            "emails": [{"primary": True, "value": "test.user@okta.local", "type": "work"}],
            "name": {"familyName": "N/A", "givenName": "N/A"},
            "active": True,
            "meta": {"resourceType": "User"},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="21" endline="36" pcid="9031">
    def test_scim_team_details_basic(self):
        team = self.create_team(organization=self.organization, name="test-scimv2")
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, team.id],
        )
        response = self.client.get(url)
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
            "id": str(team.id),
            "displayName": "test-scimv2",
            "members": [],
            "meta": {"resourceType": "Group"},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="37" endline="51" pcid="9032">
    def test_scim_team_details_excluded_attributes(self):
        team = self.create_team(organization=self.organization, name="test-scimv2")
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, team.id],
        )
        response = self.client.get(f"{url}?excludedAttributes=members")
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
            "id": str(team.id),
            "displayName": "test-scimv2",
            "meta": {"resourceType": "Group"},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_details.py" startline="245" endline="262" pcid="8300">
    def test_user_details_get_no_active(self):
        member = self.create_member(organization=self.organization, email="test.user@okta.local")
        url = reverse(
            "sentry-api-0-organization-scim-member-details",
            args=[self.organization.slug, member.id],
        )
        response = self.client.get(url)
        assert response.status_code == 200, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
            "id": str(member.id),
            "userName": "test.user@okta.local",
            "emails": [{"primary": True, "value": "test.user@okta.local", "type": "work"}],
            "name": {"familyName": "N/A", "givenName": "N/A"},
            "meta": {"resourceType": "User"},
        }


</source>
</class>

<class classid="269" nclones="2" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_details.py" startline="120" endline="132" pcid="8294">
    def test_patch_inactive_alternate_schema(self):
        member = self.create_member(user=self.create_user(), organization=self.organization)
        url = reverse(
            "sentry-api-0-organization-scim-member-details",
            args=[self.organization.slug, member.id],
        )
        response = self.client.patch(
            url, {"Operations": [{"op": "replace", "path": "active", "value": False}]}
        )
        assert response.status_code == 204, response.content
        with pytest.raises(OrganizationMember.DoesNotExist):
            OrganizationMember.objects.get(organization=self.organization, id=member.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_details.py" startline="133" endline="147" pcid="8295">
    def test_patch_bad_schema(self):
        member = self.create_member(user=self.create_user(), organization=self.organization)
        url = reverse(
            "sentry-api-0-organization-scim-member-details",
            args=[self.organization.slug, member.id],
        )
        response = self.client.patch(
            url, {"Operations": [{"op": "replace", "path": "blahblahbbalh", "value": False}]}
        )
        assert response.status_code == 400, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
            "detail": "Invalid Patch Operation.",
        }

</source>
</class>

<class classid="270" nclones="9" nlines="19" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_user_details.py" startline="148" endline="168" pcid="8296">
    def test_member_detail_patch_too_many_ops(self):
        member = self.create_member(user=self.create_user(), organization=self.organization)
        url = reverse(
            "sentry-api-0-organization-scim-member-details",
            args=[self.organization.slug, member.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [{"op": "replace", "path": "active", "value": False}] * 101,
            },
        )

        assert response.status_code == 400, response.data
        assert response.data == {
            "schemas": "urn:ietf:params:scim:api:messages:2.0:Error",
            "detail": '{"Operations":["Ensure this field has no more than 100 elements."]}',
        }

    # Disabling below test for now.
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="225" endline="243" pcid="9040">
    def test_team_details_patch_too_many_ops(self):
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [{}] * 101,
            },
        )

        assert response.status_code == 400, response.data
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
            "detail": "Too many patch ops sent, limit is 100.",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="244" endline="267" pcid="9041">
    def test_team_details_invalid_filter_patch_route(self):
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "remove",
                        "path": 'members[value badop "1"]',
                    }
                ],
            },
        )

        assert response.status_code == 400, response.data
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
            "scimType": "invalidFilter",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="268" endline="282" pcid="9042">
    def test_rename_team_azure_request(self):
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [{"op": "replace", "path": "displayName", "value": "theNewName"}],
            },
        )
        assert response.status_code == 204, response.content
        assert Team.objects.get(id=self.team.id).slug == "thenewname"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="105" endline="130" pcid="9035">
    def test_scim_team_details_patch_remove(self):
        team = self.create_team(organization=self.organization)
        member1 = self.create_member(
            user=self.create_user(), organization=self.organization, teams=[team]
        )

        url = reverse(
            "sentry-api-0-organization-scim-team-details", args=[self.organization.slug, team.id]
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "remove",
                        "path": f'members[value eq "{member1.id}"]',
                    }
                ],
            },
        )
        assert response.status_code == 204, response.content
        assert not OrganizationMemberTeam.objects.filter(
            team_id=team.id, organizationmember_id=member1.id
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="188" endline="216" pcid="9038">
    def test_team_member_doesnt_exist_add_to_team(self):
        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "add",
                        "path": "members",
                        "value": [
                            {
                                "value": "100232",
                                "display": "nope@doesnotexist.io",
                            }
                        ],
                    },
                ],
            },
        )
        assert response.status_code == 404, response.content
        assert response.data == {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
            "detail": "User not found.",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="316" endline="341" pcid="9045">
    def test_remove_member_not_on_team(self):
        member1_no_team = self.create_member(
            user=self.create_user(), organization=self.organization, teams=[]
        )

        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "Remove",
                        "path": "members",
                        "value": [{"value": str(member1_no_team.id)}],
                    }
                ],
            },
        )
        assert response.status_code == 204, response.content
        assert not OrganizationMemberTeam.objects.filter(
            team_id=self.team.id, organizationmember_id=member1_no_team.id
        ).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="52" endline="75" pcid="9033">
    def test_scim_team_details_patch_replace_rename_team(self):
        team = self.create_team(organization=self.organization)
        url = reverse(
            "sentry-api-0-organization-scim-team-details", args=[self.organization.slug, team.id]
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {
                        "op": "replace",
                        "value": {
                            "id": str(team.id),
                            "displayName": "newName",
                        },
                    }
                ],
            },
        )
        assert response.status_code == 204, response.content
        assert Team.objects.get(id=team.id).slug == "newname"
        assert Team.objects.get(id=team.id).name == "newName"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_scim_team_details.py" startline="293" endline="315" pcid="9044">
    def test_remove_member_azure(self):
        member1 = self.create_member(
            user=self.create_user(), organization=self.organization, teams=[self.team]
        )

        url = reverse(
            "sentry-api-0-organization-scim-team-details",
            args=[self.organization.slug, self.team.id],
        )
        response = self.client.patch(
            url,
            {
                "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
                "Operations": [
                    {"op": "Remove", "path": "members", "value": [{"value": str(member1.id)}]}
                ],
            },
        )
        assert response.status_code == 204, response.content
        assert not OrganizationMemberTeam.objects.filter(
            team_id=self.team.id, organizationmember_id=member1.id
        ).exists()

</source>
</class>

<class classid="271" nclones="8" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_prompts_activity.py" startline="23" endline="36" pcid="8348">
    def test_invalid_feature(self):
        # Invalid feature prompt name
        resp = self.client.put(
            self.path,
            {
                "organization_id": self.org.id,
                "project_id": self.project.id,
                "feature": "gibberish",
                "status": "dismissed",
            },
        )

        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="169" endline="183" pcid="9217">
    def test_invalid_client_id(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "refresh_token",
                "client_id": "abc",
                "refresh_token": self.token.refresh_token,
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_client"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="194" endline="208" pcid="9219">
    def test_invalid_refresh_token(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "refresh_token",
                "client_id": self.application.client_id,
                "refresh_token": "foo",
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_grant"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_prompts_activity.py" startline="37" endline="50" pcid="8349">
    def test_batched_invalid_feature(self):
        # Invalid feature prompt name
        resp = self.client.put(
            self.path,
            {
                "organization_id": self.org.id,
                "project_id": self.project.id,
                "feature": ["releases", "gibberish"],
                "status": "dismissed",
            },
        )

        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="83" endline="97" pcid="9211">
    def test_missing_code(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "authorization_code",
                "redirect_uri": self.application.get_default_redirect_uri(),
                "client_id": self.application.client_id,
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_grant"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="67" endline="82" pcid="9210">
    def test_invalid_client_id(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "authorization_code",
                "redirect_uri": self.application.get_default_redirect_uri(),
                "code": self.grant.code,
                "client_id": "def",
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_client"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="98" endline="113" pcid="9212">
    def test_invalid_code(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "authorization_code",
                "redirect_uri": self.application.get_default_redirect_uri(),
                "code": "abc",
                "client_id": self.application.client_id,
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_grant"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_token.py" startline="52" endline="66" pcid="9209">
    def test_missing_client_id(self):
        self.login_as(self.user)

        resp = self.client.post(
            self.path,
            {
                "grant_type": "authorization_code",
                "redirect_uri": self.application.get_default_redirect_uri(),
                "code": self.grant.code,
            },
        )

        assert resp.status_code == 400
        assert json.loads(resp.content) == {"error": "invalid_client"}

</source>
</class>

<class classid="272" nclones="3" nlines="21" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_prompts_activity.py" startline="51" endline="72" pcid="8350">
    def test_invalid_project(self):
        # Invalid project id
        data = {
            "organization_id": self.org.id,
            "project_id": self.project.id,
            "feature": "releases",
        }
        resp = self.client.get(self.path, data)
        assert resp.status_code == 200
        self.project.delete()
        # project doesn't exist
        resp = self.client.put(
            self.path,
            {
                "organization_id": self.org.id,
                "project_id": self.project.id,
                "feature": "releases",
                "status": "dismissed",
            },
        )
        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_prompts_activity.py" startline="98" endline="123" pcid="8352">
    def test_snooze(self):
        data = {
            "organization_id": self.org.id,
            "project_id": self.project.id,
            "feature": "releases",
        }
        resp = self.client.get(self.path, data)
        assert resp.status_code == 200
        assert resp.data.get("data", None) is None

        self.client.put(
            self.path,
            {
                "organization_id": self.org.id,
                "project_id": self.project.id,
                "feature": "releases",
                "status": "snoozed",
            },
        )

        resp = self.client.get(self.path, data)

        assert resp.status_code == 200
        assert "data" in resp.data
        assert "snoozed_ts" in resp.data["data"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_prompts_activity.py" startline="73" endline="97" pcid="8351">
    def test_dismiss(self):
        data = {
            "organization_id": self.org.id,
            "project_id": self.project.id,
            "feature": "releases",
        }
        resp = self.client.get(self.path, data)
        assert resp.status_code == 200
        assert resp.data.get("data", None) is None

        self.client.put(
            self.path,
            {
                "organization_id": self.org.id,
                "project_id": self.project.id,
                "feature": "releases",
                "status": "dismissed",
            },
        )

        resp = self.client.get(self.path, data)
        assert resp.status_code == 200
        assert "data" in resp.data
        assert "dismissed_ts" in resp.data["data"]

</source>
</class>

<class classid="273" nclones="2" nlines="46" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_release_count.py" startline="9" endline="73" pcid="8360">
    def test_simple(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org2 = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team1 = self.create_team(organization=org)
        team2 = self.create_team(organization=org)

        project1 = self.create_project(teams=[team1], organization=org)
        project2 = self.create_project(teams=[team2], organization=org2)
        project3 = self.create_project(teams=[team1], organization=org)

        self.create_member(teams=[team1], user=user, organization=org)
        self.login_as(user=user)
        release1 = Release.objects.create(
            organization_id=org.id, version="1", date_added=before_now(days=15)
        )
        release1.add_project(project1)

        release2 = Release.objects.create(
            organization_id=org2.id, version="2", date_added=before_now(days=12)
        )  # This release isn't returned, its in another org
        release2.add_project(project2)

        release3 = Release.objects.create(
            organization_id=org.id,
            version="3",
            date_added=before_now(days=10),
            date_released=before_now(days=10),
        )
        release3.add_project(project1)

        release4 = Release.objects.create(
            organization_id=org.id, version="4", date_added=before_now(days=5)
        )
        release4.add_project(project3)
        release5 = Release.objects.create(
            organization_id=org.id, version="5", date_added=before_now(days=5)
        )
        release5.add_project(project3)
        response = self.get_valid_response(org.slug, team1.slug)

        assert len(response.data) == 3
        assert len(response.data["release_counts"]) == 90
        assert len(response.data["project_avgs"]) == 2
        assert len(response.data["last_week_totals"]) == 1
        assert response.data["last_week_totals"][project3.id] == 2

        assert response.data["release_counts"][str(before_now(days=0).date())] == 0
        assert response.data["release_counts"][str(before_now(days=5).date())] == 2
        assert response.data["release_counts"][str(before_now(days=10).date())] == 1
        assert response.data["release_counts"][str(before_now(days=15).date())] == 1

        release4.add_project(project1)  # up the last week total for project1 by 1

        response = self.get_valid_response(org.slug, team1.slug)
        assert len(response.data) == 3
        assert len(response.data["release_counts"]) == 90
        assert len(response.data["project_avgs"]) == 2
        assert len(response.data["last_week_totals"]) == 2
        assert response.data["last_week_totals"][project1.id] == 1
        assert response.data["last_week_totals"][project3.id] == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_release_count.py" startline="99" endline="152" pcid="8362">
    def test_multi_project_release(self):
        user = self.create_user(is_staff=False, is_superuser=False)
        org = self.organization
        org2 = self.create_organization()
        org.flags.allow_joinleave = False
        org.save()

        team1 = self.create_team(organization=org)
        team2 = self.create_team(organization=org)

        project1 = self.create_project(teams=[team1], organization=org)
        project2 = self.create_project(teams=[team2], organization=org2)
        project3 = self.create_project(teams=[team1], organization=org)

        self.create_member(teams=[team1], user=user, organization=org)
        self.login_as(user=user)
        release1 = Release.objects.create(
            organization_id=org.id, version="1", date_added=before_now(days=15)
        )
        release1.add_project(project1)
        release1.add_project(project3)

        release2 = Release.objects.create(
            organization_id=org2.id, version="2", date_added=before_now(days=12)
        )  # This release isn't returned, its in another org
        release2.add_project(project2)

        release3 = Release.objects.create(
            organization_id=org.id,
            version="3",
            date_added=before_now(days=10),
            date_released=before_now(days=10),
        )
        release3.add_project(project1)

        release4 = Release.objects.create(
            organization_id=org.id, version="4", date_added=before_now(days=5)
        )
        release4.add_project(project3)
        release5 = Release.objects.create(
            organization_id=org.id, version="5", date_added=before_now(days=5)
        )
        release5.add_project(project3)
        response = self.get_valid_response(org.slug, team1.slug)

        assert len(response.data) == 3
        assert len(response.data["release_counts"]) == 90
        assert len(response.data["project_avgs"]) == 2
        assert len(response.data["last_week_totals"]) == 1

        assert response.data["release_counts"][str(before_now(days=0).date())] == 0
        assert response.data["release_counts"][str(before_now(days=5).date())] == 2
        assert response.data["release_counts"][str(before_now(days=10).date())] == 1
        assert response.data["release_counts"][str(before_now(days=15).date())] == 1
</source>
</class>

<class classid="274" nclones="2" nlines="20" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_auditlogs.py" startline="17" endline="42" pcid="8364">
    def test_simple(self):
        now = timezone.now()

        org2 = self.create_organization(owner=self.user)

        entry1 = AuditLogEntry.objects.create(
            organization=self.organization,
            event=AuditLogEntryEvent.ORG_EDIT,
            actor=self.user,
            datetime=now,
        )
        entry2 = AuditLogEntry.objects.create(
            organization=self.organization,
            event=AuditLogEntryEvent.ORG_EDIT,
            actor=self.user,
            datetime=now + timedelta(seconds=1),
        )
        AuditLogEntry.objects.create(
            organization=org2, event=AuditLogEntryEvent.ORG_EDIT, actor=self.user, datetime=now
        )

        response = self.get_success_response(self.organization.slug)
        assert len(response.data) == 2
        assert response.data[0]["id"] == str(entry2.id)
        assert response.data[1]["id"] == str(entry1.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_auditlogs.py" startline="43" endline="64" pcid="8365">
    def test_filter_by_event(self):
        now = timezone.now()

        entry1 = AuditLogEntry.objects.create(
            organization=self.organization,
            event=AuditLogEntryEvent.ORG_EDIT,
            actor=self.user,
            datetime=now,
        )
        AuditLogEntry.objects.create(
            organization=self.organization,
            event=AuditLogEntryEvent.ORG_ADD,
            actor=self.user,
            datetime=now + timedelta(seconds=1),
        )

        response = self.get_success_response(
            self.organization.slug, qs_params={"event": "org.edit"}
        )
        assert len(response.data) == 1
        assert response.data[0]["id"] == str(entry1.id)

</source>
</class>

<class classid="275" nclones="2" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_keys.py" startline="39" endline="50" pcid="8383">
    def test_minimal_args(self):
        project = self.create_project()
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-keys",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        resp = self.client.post(url)
        assert resp.status_code == 201, resp.content
        key = ProjectKey.objects.get(public_key=resp.data["public"])
        assert key.label

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_keys.py" startline="51" endline="62" pcid="8384">
    def test_keys(self):
        project = self.create_project()
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-keys",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        resp = self.client.post(url, data={"public": "a" * 32, "secret": "b" * 32})
        assert resp.status_code == 201, resp.content
        key = ProjectKey.objects.get(public_key=resp.data["public"])
        assert key.public_key == resp.data["public"] == "a" * 32
        assert key.secret_key == resp.data["secret"] == "b" * 32
</source>
</class>

<class classid="276" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_details.py" startline="50" endline="65" pcid="8395">
    def test_cannot_get_unapproved_invite(self):
        join_request = self.create_member(
            organization=self.organization,
            email="test@gmail.com",
            invite_status=InviteStatus.REQUESTED_TO_JOIN.value,
        )

        invite_request = self.create_member(
            organization=self.organization,
            email="test2@gmail.com",
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )

        self.get_error_response(self.organization.slug, join_request.id, status_code=404)
        self.get_error_response(self.organization.slug, invite_request.id, status_code=404)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_details.py" startline="428" endline="444" pcid="8424">
    def test_cannot_delete_unapproved_invite(self):
        join_request = self.create_member(
            organization=self.organization,
            email="test@gmail.com",
            invite_status=InviteStatus.REQUESTED_TO_JOIN.value,
        )

        invite_request = self.create_member(
            organization=self.organization,
            email="test2@gmail.com",
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )

        self.get_error_response(self.organization.slug, join_request.id, status_code=404)
        self.get_error_response(self.organization.slug, invite_request.id, status_code=404)


</source>
</class>

<class classid="277" nclones="2" nlines="11" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_details.py" startline="168" endline="181" pcid="8404">
    def test_reinvite_invite_expired_member(self, mock_send_invite_email):
        member = self.create_member(
            organization=self.organization,
            email="foo@example.com",
            role="member",
            token_expires_at="2018-10-20 00:00:00",
        )

        self.get_error_response(self.organization.slug, member.id, reinvite=1, status_code=400)
        assert mock_send_invite_email.called is False

        member = OrganizationMember.objects.get(pk=member.id)
        assert member.token_expired

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_details.py" startline="183" endline="197" pcid="8405">
    def test_regenerate_invite_expired_member(self, mock_send_invite_email):
        member = self.create_member(
            organization=self.organization,
            email="foo@example.com",
            role="member",
            token_expires_at="2018-10-20 00:00:00",
        )

        self.get_success_response(self.organization.slug, member.id, reinvite=1, regenerate=1)

        mock_send_invite_email.assert_called_once_with()

        member = OrganizationMember.objects.get(pk=member.id)
        assert member.token_expired is False

</source>
</class>

<class classid="278" nclones="2" nlines="10" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py" startline="84" endline="95" pcid="8441">
    def test_install_unpublished_app(self):
        self.login_as(user=self.user)
        app = self.create_sentry_app(name="Sample", organization=self.org)
        response = self.client.post(self.url, data={"slug": app.slug}, format="json")
        expected = {
            "app": {"slug": app.slug, "uuid": app.uuid},
            "organization": {"slug": self.org.slug},
        }

        assert response.status_code == 200, response.content
        assert expected.items() <= response.data.items()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py" startline="96" endline="107" pcid="8442">
    def test_install_published_app(self):
        self.login_as(user=self.user)
        app = self.create_sentry_app(name="Sample", organization=self.org, published=True)
        response = self.client.post(self.url, data={"slug": app.slug}, format="json")
        expected = {
            "app": {"slug": app.slug, "uuid": app.uuid},
            "organization": {"slug": self.org.slug},
        }

        assert response.status_code == 200, response.content
        assert expected.items() <= response.data.items()

</source>
</class>

<class classid="279" nclones="6" nlines="11" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="19" endline="33" pcid="8450">
    def test_change_password(self):
        old_password = self.user.password
        self.get_valid_response(
            "me",
            status_code=204,
            **{
                "password": "helloworld!",
                "passwordNew": "testpassword",
                "passwordVerify": "testpassword",
            },
        )
        user = User.objects.get(id=self.user.id)
        assert old_password != user.password

    # Not sure why but sentry.auth.password_validation._default_password_validators is [] instead of None and not
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="54" endline="64" pcid="8453">
    def test_require_current_password(self):
        self.get_valid_response(
            "me",
            status_code=400,
            **{
                "password": "wrongpassword",
                "passwordNew": "testpassword",
                "passwordVerify": "passworddoesntmatch",
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="39" endline="49" pcid="8451">
    def test_password_too_short(self):
        self.get_valid_response(
            "me",
            status_code=400,
            **{
                "password": "helloworld!",
                "passwordNew": "hi",
                "passwordVerify": "hi",
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="65" endline="75" pcid="8454">
    def test_verifies_mismatch_password(self):
        self.get_valid_response(
            "me",
            status_code=400,
            **{
                "password": "helloworld!",
                "passwordNew": "testpassword",
                "passwordVerify": "passworddoesntmatch",
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="98" endline="111" pcid="8457">
    def test_cannot_change_other_user_password(self):
        user = self.create_user(email="new@example.com", is_superuser=False)
        self.login_as(user)

        self.get_valid_response(
            self.user.id,
            status_code=403,
            **{
                "password": "helloworld!",
                "passwordNew": "newpassword",
                "passwordVerify": "newpassword",
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_user_password.py" startline="112" endline="124" pcid="8458">
    def test_superuser_can_change_other_user_password(self):
        user = self.create_user(email="new@example.com", is_superuser=True)
        self.login_as(user, superuser=True)

        self.get_valid_response(
            self.user.id,
            status_code=204,
            **{
                "password": "helloworld!",
                "passwordNew": "newpassword",
                "passwordVerify": "newpassword",
            },
        )
</source>
</class>

<class classid="280" nclones="4" nlines="17" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_request_details.py" startline="8" endline="34" pcid="8462">
    def test_approve_request(self):
        self.login_as(user=self.user)

        organization = self.create_organization(name="foo", owner=self.user)
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        access_request = OrganizationAccessRequest.objects.create(member=member, team=team)

        path = reverse(
            "sentry-api-0-organization-access-request-details",
            args=[organization.slug, access_request.id],
        )

        self.login_as(self.user)

        resp = self.client.put(path, data={"isApproved": 1})

        assert resp.status_code == 204

        assert OrganizationMemberTeam.objects.filter(
            organizationmember=member, team=team, is_active=True
        ).exists()

        assert not OrganizationAccessRequest.objects.filter(id=access_request.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_request_details.py" startline="35" endline="61" pcid="8463">
    def test_deny_request(self):
        self.login_as(user=self.user)

        organization = self.create_organization(name="foo", owner=self.user)
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        access_request = OrganizationAccessRequest.objects.create(member=member, team=team)

        path = reverse(
            "sentry-api-0-organization-access-request-details",
            args=[organization.slug, access_request.id],
        )

        self.login_as(self.user)

        resp = self.client.put(path, data={"isApproved": 0})

        assert resp.status_code == 204

        assert not OrganizationMemberTeam.objects.filter(
            organizationmember=member, team=team, is_active=True
        ).exists()

        assert not OrganizationAccessRequest.objects.filter(id=access_request.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_request_details.py" startline="86" endline="110" pcid="8465">
    def test_teamless_admin_cannot_approve_with_closed_membership(self):
        self.login_as(user=self.user)

        organization = self.create_organization(
            name="foo", owner=self.user, flags=0  # kill allow_joinleave
        )
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        access_request = OrganizationAccessRequest.objects.create(member=member, team=team)

        admin_user = self.create_user("admin@example.com")
        self.create_member(organization=organization, user=admin_user, role="admin", teams=[])

        path = reverse(
            "sentry-api-0-organization-access-request-details",
            args=[organization.slug, access_request.id],
        )

        self.login_as(admin_user)

        resp = self.client.put(path, data={"isApproved": 1})

        assert resp.status_code == 403
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_access_request_details.py" startline="62" endline="85" pcid="8464">
    def test_team_admin_can_approve(self):
        self.login_as(user=self.user)

        organization = self.create_organization(name="foo", owner=self.user)
        user = self.create_user("bar@example.com")
        member = self.create_member(organization=organization, user=user, role="member")
        team = self.create_team(name="foo", organization=organization)

        access_request = OrganizationAccessRequest.objects.create(member=member, team=team)

        admin_user = self.create_user("admin@example.com")
        self.create_member(organization=organization, user=admin_user, role="admin", teams=[team])

        path = reverse(
            "sentry-api-0-organization-access-request-details",
            args=[organization.slug, access_request.id],
        )

        self.login_as(admin_user)

        resp = self.client.put(path, data={"isApproved": 1})

        assert resp.status_code == 204

</source>
</class>

<class classid="281" nclones="2" nlines="32" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_hashes.py" startline="12" endline="49" pcid="8466">
    def test_only_return_latest_event(self):
        self.login_as(user=self.user)

        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))
        new_event_id = "b" * 32

        old_event = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "message",
                "timestamp": two_min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )

        new_event = self.store_event(
            data={
                "event_id": new_event_id,
                "message": "message",
                "timestamp": min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )

        assert new_event.group_id == old_event.group_id

        url = f"/api/0/issues/{new_event.group_id}/hashes/"
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["latestEvent"]["eventID"] == new_event_id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_hashes.py" startline="50" endline="91" pcid="8467">
    def test_return_multiple_hashes(self):
        self.login_as(user=self.user)

        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))

        event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "message",
                "timestamp": two_min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
        )

        event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "message2",
                "timestamp": min_ago,
                "fingerprint": ["group-2"],
            },
            project_id=self.project.id,
        )

        # Merge the events
        eventstream = SnubaEventStream()
        state = eventstream.start_merge(self.project.id, [event2.group_id], event1.group_id)

        eventstream.end_merge(state)

        url = f"/api/0/issues/{event1.group_id}/hashes/"
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 2

        primary_hashes = [hash["id"] for hash in response.data]
        assert primary_hashes == [event2.get_primary_hash(), event1.get_primary_hash()]

</source>
</class>

<class classid="282" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_details.py" startline="31" endline="47" pcid="8475">
    def test_with_numerical_id(self):
        self.login_as(user=self.user)

        group = self.create_group()

        url = f"/api/0/issues/{group.id}/"
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(group.id)

        url = f"/api/0/organizations/{group.organization.slug}/issues/{group.id}/"
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(group.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_details.py" startline="48" endline="64" pcid="8476">
    def test_with_qualified_short_id(self):
        self.login_as(user=self.user)

        group = self.create_group()
        assert group.qualified_short_id

        url = f"/api/0/organizations/{group.organization.slug}/issues/{group.qualified_short_id}/"
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(group.id)

        url = f"/api/0/issues/{group.qualified_short_id}/"
        response = self.client.get(url, format="json")

        assert response.status_code == 404, response.content

</source>
</class>

<class classid="283" nclones="2" nlines="16" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_details.py" startline="115" endline="136" pcid="8480">
    def test_environment(self):
        group = self.create_group()
        self.login_as(user=self.user)

        environment = Environment.get_or_create(group.project, "production")

        url = f"/api/0/issues/{group.id}/"

        from sentry.api.endpoints.group_details import tsdb

        with mock.patch(
            "sentry.api.endpoints.group_details.tsdb.get_range", side_effect=tsdb.get_range
        ) as get_range:
            response = self.client.get(url, {"environment": "production"}, format="json")
            assert response.status_code == 200
            assert get_range.call_count == 2
            for args, kwargs in get_range.call_args_list:
                assert kwargs["environment_ids"] == [environment.id]

        response = self.client.get(url, {"environment": "invalid"}, format="json")
        assert response.status_code == 404

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_group_details.py" startline="12" endline="36" pcid="12119">
    def test_multiple_environments(self):
        group = self.create_group()
        self.login_as(user=self.user)

        environment = Environment.get_or_create(group.project, "production")
        environment2 = Environment.get_or_create(group.project, "staging")

        url = f"/api/0/issues/{group.id}/"

        from sentry.api.endpoints.group_details import tsdb

        with mock.patch(
            "sentry.api.endpoints.group_details.tsdb.get_range", side_effect=tsdb.get_range
        ) as get_range:
            response = self.client.get(
                f"{url}?environment=production&environment=staging", format="json"
            )
            assert response.status_code == 200
            assert get_range.call_count == 2
            for args, kwargs in get_range.call_args_list:
                assert kwargs["environment_ids"] == [environment.id, environment2.id]

        response = self.client.get(f"{url}?environment=invalid", format="json")
        assert response.status_code == 404

</source>
</class>

<class classid="284" nclones="2" nlines="18" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_details.py" startline="310" endline="343" pcid="8491">
    def test_assign_username(self):
        self.login_as(user=self.user)

        group = self.create_group()

        url = f"/api/0/issues/{group.id}/"

        response = self.client.put(url, data={"assignedTo": self.user.username}, format="json")

        assert response.status_code == 200, response.content

        assert GroupAssignee.objects.filter(group=group, user=self.user).exists()

        assert (
            Activity.objects.filter(group=group, user=self.user, type=Activity.ASSIGNED).count()
            == 1
        )

        response = self.client.put(url, format="json")

        assert response.status_code == 200, response.content

        assert GroupAssignee.objects.filter(group=group, user=self.user).exists()

        assert GroupSubscription.objects.filter(
            user=self.user, group=group, is_active=True
        ).exists()

        response = self.client.put(url, data={"assignedTo": ""}, format="json")

        assert response.status_code == 200, response.content

        assert not GroupAssignee.objects.filter(group=group, user=self.user).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_details.py" startline="344" endline="377" pcid="8492">
    def test_assign_id(self):
        self.login_as(user=self.user)

        group = self.create_group()

        url = f"/api/0/issues/{group.id}/"

        response = self.client.put(url, data={"assignedTo": self.user.id}, format="json")

        assert response.status_code == 200, response.content

        assert GroupAssignee.objects.filter(group=group, user=self.user).exists()

        assert (
            Activity.objects.filter(group=group, user=self.user, type=Activity.ASSIGNED).count()
            == 1
        )

        response = self.client.put(url, format="json")

        assert response.status_code == 200, response.content

        assert GroupAssignee.objects.filter(group=group, user=self.user).exists()

        assert GroupSubscription.objects.filter(
            user=self.user, group=group, is_active=True
        ).exists()

        response = self.client.put(url, data={"assignedTo": ""}, format="json")

        assert response.status_code == 200, response.content

        assert not GroupAssignee.objects.filter(group=group, user=self.user).exists()

</source>
</class>

<class classid="285" nclones="6" nlines="16" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_task_details.py" startline="10" endline="25" pcid="8511">
    def setUp(self):
        self.login_as(user=self.user)
        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)
        self.rule = project1.rule_set.all()[0]
        self.uuid = uuid4().hex
        self.url = reverse(
            "sentry-api-0-project-rule-task-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "task_uuid": self.uuid,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="35" endline="53" pcid="8858">
    def test_non_existing_rule(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "rule_id": 12345,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 404

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_alert_rule_task_details.py" startline="10" endline="27" pcid="8878">
    def setUp(self):
        self.login_as(user=self.user)
        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)
        self.rule = self.create_alert_rule(
            name="My Alert Rule", user=self.user, projects=[project1]
        )
        self.uuid = uuid4().hex
        self.url = reverse(
            "sentry-api-0-project-alert-rule-task-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "task_uuid": self.uuid,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="12" endline="34" pcid="8857">
    def test_simple(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)

        rule = project1.rule_set.all()[0]

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)
        assert response.data["environment"] is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="54" endline="77" pcid="8859">
    def test_with_environment(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)

        rule = project1.rule_set.all()[0]
        rule.update(environment_id=Environment.get_or_create(rule.project, "production").id)

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)
        assert response.data["environment"] == "production"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="78" endline="101" pcid="8860">
    def test_with_null_environment(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project1 = self.create_project(teams=[team], name="foo", fire_project_created=True)
        self.create_project(teams=[team], name="bar", fire_project_created=True)

        rule = project1.rule_set.all()[0]
        rule.update(environment_id=None)

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project1.organization.slug,
                "project_slug": project1.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)
        assert response.data["environment"] is None

</source>
</class>

<class classid="286" nclones="2" nlines="40" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_file_details.py" startline="39" endline="80" pcid="8523">
    def test_file_download(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        from io import BytesIO

        f = File.objects.create(name="applicatiosn.js", type="release.file")
        f.putfile(BytesIO(b"File contents here"))

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release_id=release.id,
            file=f,
            name="  http://example.com/appli\n\rcatios n.js\n\n\r  ",
        )

        url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        response = self.client.get(url + "?download=1")
        assert response.status_code == 200, response.content
        assert response.get("Content-Disposition") == 'attachment; filename="appli catios n.js"'
        assert response.get("Content-Length") == str(f.size)
        assert response.get("Content-Type") == "application/octet-stream"
        assert b"File contents here" == BytesIO(b"".join(response.streaming_content)).getvalue()

        user_no_permission = self.create_user("baz@localhost", username="baz")
        self.login_as(user=user_no_permission)
        response = self.client.get(url + "?download=1")
        assert response.status_code == 403, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_file_details.py" startline="43" endline="105" pcid="8928">
    def test_file_download(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        release = Release.objects.create(organization_id=project.organization_id, version="1")
        release.add_project(project)

        from io import BytesIO

        f = File.objects.create(name="applicatiosn.js", type="release.file")
        f.putfile(BytesIO(b"File contents here"))

        releasefile = ReleaseFile.objects.create(
            organization_id=project.organization_id,
            project_id=project.id,
            release_id=release.id,
            file=f,
            name="  http://example.com/appli\n\rcatios n.js\n\n\r  ",
        )

        url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

        # Download as a user with sufficient role
        self.organization.update_option("sentry:debug_files_role", "admin")
        user = self.create_user("baz@localhost")
        self.create_member(user=user, organization=project.organization, role="owner")
        self.login_as(user=user)

        response = self.client.get(url + "?download=1")
        assert response.status_code == 200, response.content
        assert response.get("Content-Disposition") == 'attachment; filename="appli catios n.js"'
        assert response.get("Content-Length") == str(f.size)
        assert response.get("Content-Type") == "application/octet-stream"
        assert b"File contents here" == BytesIO(b"".join(response.streaming_content)).getvalue()

        # Download as a superuser
        self.login_as(user=self.user)
        response = self.client.get(url + "?download=1")
        assert response.get("Content-Type") == "application/octet-stream"

        # # Download as a user without sufficient role
        self.organization.update_option("sentry:debug_files_role", "owner")
        user_no_role = self.create_user("bar@localhost")
        self.create_member(user=user_no_role, organization=project.organization, role="member")
        self.login_as(user=user_no_role)
        response = self.client.get(url + "?download=1")
        assert response.status_code == 403, response.content

        # Download as a user with no permissions
        user_no_permission = self.create_user("baz@localhost", username="baz")
        self.login_as(user=user_no_permission)
        response = self.client.get(url + "?download=1")
        assert response.status_code == 403, response.content

</source>
</class>

<class classid="287" nclones="17" nlines="11" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_file_details.py" startline="81" endline="92" pcid="8524">
    def _get(self, file_id):
        url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "version": self.release.version,
                "file_id": file_id,
            },
        )

        return self.client.get(url)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="226" endline="236" pcid="8826">
    def test_all_environments(self):
        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={
                "organization_slug": self.project1.organization.slug,
                "project_slug": self.project1.slug,
            },
        )
        response = self.client.get(url, format="json")
        self.assert_releases(response, [self.release1, self.release3])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="237" endline="247" pcid="8827">
    def test_invalid_environment(self):
        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={
                "organization_slug": self.project1.organization.slug,
                "project_slug": self.project1.slug,
            },
        )
        response = self.client.get(url + "?environment=" + "invalid_environment", format="json")
        self.assert_releases(response, [])

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_release_file_details.py" startline="106" endline="118" pcid="8929">
    def _get(self, file_id, postfix=""):
        url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "version": self.release.version,
                "file_id": file_id,
            },
        )

        return self.client.get(url + postfix)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="117" endline="130" pcid="11896">
    def test_no_access_missing_feature(self):
        with self.feature({"organizations:discover-basic": False}):
            url = reverse(
                "sentry-api-0-organization-event-details",
                kwargs={
                    "organization_slug": self.project.organization.slug,
                    "project_slug": self.project.slug,
                    "event_id": "a" * 32,
                },
            )

            response = self.client.get(url, format="json")
            assert response.status_code == 404, response.content

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/projects/test_key_details.py" startline="8" endline="20" pcid="12325">
    def setUp(self):

        self.url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "key_id": self.projectkey.public_key,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="163" endline="177" pcid="11898">
    def test_no_event(self):
        url = reverse(
            "sentry-api-0-organization-event-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "event_id": "d" * 32,
            },
        )

        with self.feature("organizations:discover-basic"):
            response = self.client.get(url, format="json")

        assert response.status_code == 404, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="178" endline="188" pcid="11899">
    def test_invalid_event_id(self):
        with self.assertRaises(NoReverseMatch):
            reverse(
                "sentry-api-0-organization-event-details",
                kwargs={
                    "organization_slug": self.project.organization.slug,
                    "project_slug": self.project.slug,
                    "event_id": "not-an-event",
                },
            )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="72" endline="88" pcid="11894">
    def test_simple(self):
        url = reverse(
            "sentry-api-0-organization-event-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "event_id": "a" * 32,
            },
        )

        with self.feature("organizations:discover-basic"):
            response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == "a" * 32
        assert response.data["projectSlug"] == self.project.slug

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="55" endline="71" pcid="11893">
    def test_performance_flag(self):
        url = reverse(
            "sentry-api-0-organization-event-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "event_id": "a" * 32,
            },
        )
        with self.feature(
            {"organizations:discover-basic": False, "organizations:performance-view": True}
        ):
            response = self.client.get(url, format="json")
        assert response.status_code == 200, response.content
        assert response.data["id"] == "a" * 32
        assert response.data["projectSlug"] == self.project.slug

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/projects/test_tag_values.py" startline="8" endline="22" pcid="12336">
    def setUp(self):
        key, value = "foo", "bar"
        self.create_event("a", tags={key: value})

        self.url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "key": key,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/events/test_project_events.py" startline="10" endline="23" pcid="12368">
    def setUp(self):
        self.create_event("a")
        self.create_event("b")

        self.url = reverse(
            self.endpoint,
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/projects/test_service_hook_details.py" startline="8" endline="21" pcid="12333">
    def setUp(self):
        hook = self.create_service_hook(project=self.project, events=("event.created",))

        self.url = reverse(
            "sentry-api-0-project-service-hook-details",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "hook_id": hook.guid,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/organizations/test_shortid.py" startline="8" endline="20" pcid="12293">
    def setUp(self):
        group = self.create_group(project=self.project)

        self.url = reverse(
            "sentry-api-0-short-id-lookup",
            kwargs={
                "organization_slug": self.organization.slug,
                "short_id": group.qualified_short_id,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_event_details.py" startline="216" endline="236" pcid="11901">
    def test_blank_fields(self):
        url = reverse(
            "sentry-api-0-organization-event-details",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "event_id": "a" * 32,
            },
        )

        with self.feature("organizations:discover-basic"):
            response = self.client.get(
                url,
                data={"field": ["", " "], "statsPeriod": "24h"},
                format="json",
            )

        assert response.status_code == 200, response.content
        assert response.data["id"] == "a" * 32
        assert response.data["projectSlug"] == self.project.slug

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/events/test_project_tagkey_values.py" startline="8" endline="22" pcid="12370">
    def setUp(self):
        key = "foo"
        self.create_event("a", tags={key: "bar"})

        self.login_as(user=self.user)

        self.url = reverse(
            "sentry-api-0-project-tagkey-values",
            kwargs={
                "organization_slug": self.organization.slug,
                "project_slug": self.project.slug,
                "key": key,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/events/test_project_event_details.py" startline="10" endline="27" pcid="12349">
    def setUp(self):
        self.create_event("a")
        event = self.create_event("b")
        self.create_event("c")

        self.create_event("d", fingerprint=["group-2"])

        self.url = reverse(
            self.endpoint,
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
                "event_id": event.event_id,
            },
        )

        self.login_as(user=self.user)

</source>
</class>

<class classid="288" nclones="12" nlines="17" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_search_details.py" startline="8" endline="27" pcid="8536">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")
        search = SavedSearch.objects.create(project=project, name="foo", query="")

        url = reverse(
            "sentry-api-0-project-search-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "search_id": search.id,
            },
        )
        response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(search.id)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="876" endline="898" pcid="8877">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.delete(url)

        assert response.status_code == 202, response.content

        rule = Rule.objects.get(id=rule.id)
        assert rule.status == RuleStatus.PENDING_DELETION

        assert RuleActivity.objects.filter(rule=rule, type=RuleActivityType.DELETED.value).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_search_details.py" startline="29" endline="50" pcid="8537">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")
        search = SavedSearch.objects.create(project=project, name="foo", query="")

        url = reverse(
            "sentry-api-0-project-search-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "search_id": search.id,
            },
        )
        response = self.client.put(url, {"name": "bar"})

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(search.id)

        search = SavedSearch.objects.get(id=search.id)
        assert search.name == "bar"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="119" endline="133" pcid="9025">
    def test_simple(self):
        project = self.create_project()
        self.login_as(user=self.user)
        key = ProjectKey.objects.get_or_create(project=project)[0]
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        resp = self.client.delete(url)
        assert resp.status_code == 204, resp.content
        assert not ProjectKey.objects.filter(id=key.id).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="99" endline="117" pcid="9024">
    def test_deactivate(self):
        project = self.create_project()
        key = ProjectKey.objects.get_or_create(project=project)[0]
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url, {"isActive": False, "name": "hello world"})
        assert response.status_code == 200
        key = ProjectKey.objects.get(id=key.id)
        assert key.label == "hello world"
        assert key.status == ProjectKeyStatus.INACTIVE


</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="25" endline="42" pcid="9020">
    def test_no_rate_limit(self):
        project = self.create_project()
        key = ProjectKey.objects.create(project=project, rate_limit_window=60, rate_limit_count=1)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url, {"rateLimit": None})
        assert response.status_code == 200, response.content
        key = ProjectKey.objects.get(id=key.id)
        assert key.rate_limit_count is None
        assert key.rate_limit_window is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="43" endline="60" pcid="9021">
    def test_unset_rate_limit(self):
        project = self.create_project()
        key = ProjectKey.objects.create(project=project, rate_limit_window=60, rate_limit_count=1)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url)
        assert response.status_code == 200
        key = ProjectKey.objects.get(id=key.id)
        assert key.rate_limit_count == 1
        assert key.rate_limit_window == 60

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="8" endline="24" pcid="9019">
    def test_simple(self):
        project = self.create_project()
        key = ProjectKey.objects.get_or_create(project=project)[0]
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url, {"name": "hello world"})
        assert response.status_code == 200
        key = ProjectKey.objects.get(id=key.id)
        assert key.label == "hello world"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_search_details.py" startline="51" endline="76" pcid="8538">
    def test_changing_default(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")
        search = SavedSearch.objects.create(project=project, name="foo", query="", is_default=False)
        search2 = SavedSearch.objects.create(project=project, name="bar", query="", is_default=True)

        url = reverse(
            "sentry-api-0-project-search-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "search_id": search.id,
            },
        )
        response = self.client.put(url, {"isDefault": True})

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(search.id)

        search = SavedSearch.objects.get(id=search.id)
        assert search.is_default

        search2 = SavedSearch.objects.get(id=search2.id)
        assert not search2.is_default

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="61" endline="78" pcid="9022">
    def test_remove_rate_limit(self):
        project = self.create_project()
        key = ProjectKey.objects.create(project=project, rate_limit_window=60, rate_limit_count=1)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url, {"rateLimit": {"count": "", "window": 300}})
        assert response.status_code == 200
        key = ProjectKey.objects.get(id=key.id)
        assert key.rate_limit_count is None
        assert key.rate_limit_window is None

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_key_details.py" startline="79" endline="98" pcid="9023">
    def test_simple_rate_limit(self):
        project = self.create_project()
        key = ProjectKey.objects.create(
            project=project, rate_limit_window=None, rate_limit_count=None
        )
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-project-key-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "key_id": key.public_key,
            },
        )
        response = self.client.put(url, {"rateLimit": {"count": 1, "window": 60}})
        assert response.status_code == 200
        key = ProjectKey.objects.get(id=key.id)
        assert key.rate_limit_count == 1
        assert key.rate_limit_window == 60

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_search_details.py" startline="77" endline="108" pcid="8539">
    def test_changing_user_default(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")
        search = SavedSearch.objects.create(project=project, name="foo", query="", is_default=True)
        search2 = SavedSearch.objects.create(
            project=project, name="bar", query="", is_default=False
        )
        userdefault = SavedSearchUserDefault.objects.create(
            savedsearch=search2, project=project, user=self.user
        )

        url = reverse(
            "sentry-api-0-project-search-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "search_id": search2.id,
            },
        )
        response = self.client.put(url, {"isUserDefault": True})

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(search2.id)

        search = SavedSearch.objects.get(id=search.id)
        assert search.is_default
        search2 = SavedSearch.objects.get(id=search2.id)
        assert not search2.is_default
        userdefault = SavedSearchUserDefault.objects.get(id=userdefault.id)
        assert userdefault.savedsearch == search2

</source>
</class>

<class classid="289" nclones="2" nlines="31" similarity="87">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_tombstone_details.py" startline="8" endline="40" pcid="8553">
    def test_delete(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(user=self.user)

        group = self.create_group()
        tombstone = GroupTombstone.objects.create(
            project_id=group.project_id,
            level=group.level,
            message=group.message,
            culprit=group.culprit,
            data=group.data,
            previous_group_id=group.id,
        )
        GroupHash.objects.create(
            project=group.project, hash="x" * 32, group=group, group_tombstone_id=tombstone.id
        )
        assert GroupHash.objects.filter(group_tombstone_id=tombstone.id).exists()
        path = reverse(
            "sentry-api-0-group-tombstone-details",
            kwargs={
                "organization_slug": self.org.slug,
                "project_slug": self.project.slug,
                "tombstone_id": tombstone.id,
            },
        )
        response = self.client.delete(path)

        assert response.status_code == 204, response
        assert not GroupHash.objects.filter(group_tombstone_id=tombstone.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_tombstone_details.py" startline="41" endline="78" pcid="8554">
    def test_dont_delete_from_other_proj(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")

        self.other_project = self.create_project(
            organization=self.org, teams=[self.team], name="Snake"
        )

        self.login_as(user=self.user)

        group = self.create_group()
        tombstone = GroupTombstone.objects.create(
            project_id=group.project_id,
            level=group.level,
            message=group.message,
            culprit=group.culprit,
            data=group.data,
            previous_group_id=group.id,
        )
        GroupHash.objects.create(
            project=group.project, hash="x" * 32, group=group, group_tombstone_id=tombstone.id
        )
        assert GroupHash.objects.filter(group_tombstone_id=tombstone.id).exists()
        path = reverse(
            "sentry-api-0-group-tombstone-details",
            kwargs={
                "organization_slug": self.org.slug,
                "project_slug": self.other_project.slug,
                "tombstone_id": tombstone.id,
            },
        )
        response = self.client.delete(path)

        assert response.status_code == 404, response
        assert GroupHash.objects.filter(group_tombstone_id=tombstone.id).exists()
        assert GroupTombstone.objects.filter(project_id=self.project.id, id=tombstone.id).exists()
</source>
</class>

<class classid="290" nclones="2" nlines="13" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_interaction.py" startline="94" endline="109" pcid="8565">
    def test_missing_component_type(self):
        self.login_as(self.user)
        body = {"tsdbField": "sentry_app_component_interacted"}
        response = self.client.post(
            self.owned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 400
        component_types = [
            "stacktrace-link",
            "issue-link",
        ]
        assert (
            response.data["detail"]
            == f"The field componentType is required and must be one of {component_types}"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_interaction.py" startline="110" endline="125" pcid="8566">
    def test_incorrect_component_type(self):
        self.login_as(self.user)
        body = {"tsdbField": "sentry_app_component_interacted", "componentType": "wrong"}
        response = self.client.post(
            self.owned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 400
        component_types = [
            "stacktrace-link",
            "issue-link",
        ]
        assert (
            response.data["detail"]
            == f"The field componentType is required and must be one of {component_types}"
        )

</source>
</class>

<class classid="291" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_interaction.py" startline="126" endline="139" pcid="8567">
    def test_allows_logged_in_user_who_doesnt_own_app(self):
        self.login_as(self.user)
        body = {"tsdbField": "sentry_app_component_interacted", "componentType": "issue-link"}
        response = self.client.post(
            self.unowned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 201

        body = {"tsdbField": "sentry_app_viewed"}
        response = self.client.post(
            self.unowned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 201

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_interaction.py" startline="140" endline="152" pcid="8568">
    def test_allows_logged_in_user_who_does_own_app(self):
        self.login_as(self.user)
        body = {"tsdbField": "sentry_app_component_interacted", "componentType": "issue-link"}
        response = self.client.post(
            self.owned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 201

        body = {"tsdbField": "sentry_app_viewed"}
        response = self.client.post(
            self.owned_url, body, headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 201
</source>
</class>

<class classid="292" nclones="10" nlines="11" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="69" endline="83" pcid="8598">
    def test_valid_register(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="84" endline="98" pcid="8599">
    def test_register_missing_relay_id(self):
        data = {"public_key": str(self.public_key)}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="138" endline="151" pcid="8603">
    def test_register_missing_header2(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="152" endline="166" pcid="8604">
    def test_register_wrong_sig(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature + "a",
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="99" endline="113" pcid="8600">
    def test_register_missing_public_key(self):
        data = {"relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="124" endline="137" pcid="8602">
    def test_register_missing_header(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="202" endline="212" pcid="10373">
    def test_merge_event_missing_repo(self):
        response = self.client.post(
            self.url,
            data=MERGE_REQUEST_OPENED_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Merge Request Hook",
        )
        assert response.status_code == 204
        assert 0 == PullRequest.objects.count()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="175" endline="186" pcid="10371">
    def test_push_event_ignore_commit(self):
        self.create_repo("getsentry/sentry")
        response = self.client.post(
            self.url,
            data=PUSH_EVENT_IGNORED_COMMIT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )
        assert response.status_code == 204
        assert 0 == Commit.objects.count()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="213" endline="229" pcid="10374">
    def test_merge_event_no_last_commit(self):
        payload = json.loads(MERGE_REQUEST_OPENED_EVENT)

        # Remove required keys. There have been events in prod that are missing
        # these important attributes. GitLab docs don't explain why though.
        del payload["object_attributes"]["last_commit"]

        response = self.client.post(
            self.url,
            data=json.dumps(payload),
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Merge Request Hook",
        )
        assert response.status_code == 204
        assert 0 == PullRequest.objects.count()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="187" endline="201" pcid="10372">
    def test_push_event_known_author(self):
        CommitAuthor.objects.create(
            organization_id=self.organization.id, email="jordi@example.org", name="Jordi"
        )
        self.create_repo("getsentry/sentry")
        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )
        assert response.status_code == 204
        assert 2 == CommitAuthor.objects.count(), "No dupes made"

</source>
</class>

<class classid="293" nclones="5" nlines="22" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="167" endline="197" pcid="8605">
    def test_valid_register_response(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        relay = Relay.objects.get(relay_id=self.relay_id)
        assert relay
        assert relay.relay_id == self.relay_id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="410" endline="437" pcid="8612">
    def test_relay_id_mismatch_response(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=str(uuid4()),
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="383" endline="409" pcid="8611">
    def test_missing_sig_response(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="325" endline="352" pcid="8609">
    def test_invalid_json_response(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        _, signature = self.private_key.pack(result)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data="a",
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="353" endline="382" pcid="8610">
    def test_missing_token_response(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        del result["token"]

        raw_json, signature = self.private_key.pack(result)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
</class>

<class classid="294" nclones="4" nlines="31" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="198" endline="241" pcid="8606">
    def test_forge_public_key(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        keys = generate_key_pair()

        settings.SENTRY_RELAY_WHITELIST_PK.append(str(keys[1]))

        data = {"public_key": str(keys[1]), "relay_id": self.relay_id}

        raw_json, signature = keys[0].pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="284" endline="324" pcid="8608">
    def test_forge_public_key_on_register(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        result = json.loads(resp.content)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content

        keys = generate_key_pair()

        data = {"token": str(result.get("token")), "relay_id": self.relay_id}

        raw_json, signature = keys[0].pack(data)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="442" endline="489" pcid="8614">
    def test_old_relays_can_register(self):
        """
        Test that an old Relay that does not send version information
        in the challenge response is still able to register.
        """
        data = {
            "public_key": str(self.public_key),
            "relay_id": self.relay_id,
            "version": "1.0.0",
        }

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        data = {"token": str(result.get("token")), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="242" endline="283" pcid="8607">
    def test_public_key_mismatch(self):
        data = {"public_key": str(self.public_key), "relay_id": self.relay_id}

        raw_json, signature = self.private_key.pack(data)

        resp = self.client.post(
            self.path,
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 200, resp.content
        result = json.loads(resp.content)

        raw_json, signature = self.private_key.pack(result)

        self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        keys = generate_key_pair()

        data = {"token": str(result.get("token")), "relay_id": self.relay_id}

        raw_json, signature = keys[0].pack(data)

        resp = self.client.post(
            reverse("sentry-api-0-relay-register-response"),
            data=raw_json,
            content_type="application/json",
            HTTP_X_SENTRY_RELAY_ID=self.relay_id,
            HTTP_X_SENTRY_RELAY_SIGNATURE=signature,
        )

        assert resp.status_code == 400, resp.content

</source>
</class>

<class classid="295" nclones="2" nlines="22" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="490" endline="521" pcid="8615">
    def test_multiple_relay_versions_tracked(self):
        """
        Test that updating the relay version would properly be
        reflected in the relay analytics. Also that tests that
        multiple relays
        """
        key_pair = generate_key_pair()
        relay_id = str(uuid4())
        before_registration = timezone.now()
        self.register_relay(key_pair, "1.1.1", relay_id)
        after_first_relay = timezone.now()
        self.register_relay(key_pair, "2.2.2", relay_id)
        after_second_relay = timezone.now()

        v1 = Relay.objects.get(relay_id=relay_id)
        assert v1 is not None

        rv1 = RelayUsage.objects.get(relay_id=relay_id, version="1.1.1")
        assert rv1 is not None
        rv2 = RelayUsage.objects.get(relay_id=relay_id, version="2.2.2")
        assert rv2 is not None

        assert rv1.first_seen > before_registration
        assert rv1.last_seen > before_registration
        assert rv1.first_seen < after_first_relay
        assert rv1.last_seen < after_first_relay

        assert rv2.first_seen > after_first_relay
        assert rv2.last_seen > after_first_relay
        assert rv2.first_seen < after_second_relay
        assert rv2.last_seen < after_second_relay

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_relay_register.py" startline="522" endline="558" pcid="8616">
    def test_relay_usage_is_updated_at_registration(self):
        """
        Tests that during registration the proper relay usage information
        is updated
        """

        key_pair = generate_key_pair()
        relay_id = str(uuid4())
        before_registration = timezone.now()
        # register one relay
        self.register_relay(key_pair, "1.1.1", relay_id)
        after_first_relay = timezone.now()
        # register another one that should not be updated after this
        self.register_relay(key_pair, "2.2.2", relay_id)
        after_second_relay = timezone.now()
        # re register the first one in order to update the last used time
        self.register_relay(key_pair, "1.1.1", relay_id)
        after_re_register = timezone.now()

        rv1 = RelayUsage.objects.get(relay_id=relay_id, version="1.1.1")
        assert rv1 is not None
        rv2 = RelayUsage.objects.get(relay_id=relay_id, version="2.2.2")
        assert rv2 is not None

        # check first seen is not modified by re register
        assert rv1.first_seen > before_registration
        assert rv1.first_seen < after_first_relay
        # check last seen shows the time at re-registration
        assert rv1.last_seen > after_second_relay
        assert rv1.last_seen < after_re_register

        # check version 2.2.2 is not affected by version 1.1.1
        assert rv2.first_seen > after_first_relay
        assert rv2.last_seen > after_first_relay
        assert rv2.first_seen < after_second_relay
        assert rv2.last_seen < after_second_relay

</source>
</class>

<class classid="296" nclones="2" nlines="34" similarity="82">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_environment_details.py" startline="8" endline="50" pcid="8640">
    def test_get(self):
        project = self.create_project()

        environment = Environment.objects.create(
            project_id=project.id, organization_id=project.organization_id, name="production"
        )
        environment.add_project(project)

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-environment-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "environment": "production",
            },
        )
        response = self.client.get(url, format="json")
        assert response.status_code == 200, response.content
        assert response.data == {
            "id": "{}".format(
                EnvironmentProject.objects.get(environment__name="production", project=project).id
            ),
            "name": "production",
            "isHidden": False,
        }

        assert (
            self.client.get(
                reverse(
                    "sentry-api-0-project-environment-details",
                    kwargs={
                        "organization_slug": project.organization.slug,
                        "project_slug": project.slug,
                        "environment": "invalid",
                    },
                ),
                format="json",
            ).status_code
            == 404
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_environment_details.py" startline="51" endline="91" pcid="8641">
    def test_put(self):
        project = self.create_project()

        environment = Environment.objects.create(
            project_id=project.id, organization_id=project.organization_id, name="production"
        )
        environment.add_project(project)

        self.login_as(user=self.user)

        url = reverse(
            "sentry-api-0-project-environment-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "environment": "production",
            },
        )
        response = self.client.put(url, {"isHidden": True}, format="json")
        assert response.status_code == 200, response.content

        assert (
            EnvironmentProject.objects.get(project=project, environment=environment).is_hidden
            is True
        )

        assert (
            self.client.put(
                reverse(
                    "sentry-api-0-project-environment-details",
                    kwargs={
                        "organization_slug": project.organization.slug,
                        "project_slug": project.slug,
                        "environment": "invalid",
                    },
                ),
                {"isHidden": True},
                format="json",
            ).status_code
            == 404
        )
</source>
</class>

<class classid="297" nclones="3" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_chunk_upload.py" startline="145" endline="161" pcid="8650">
    def test_too_many_chunks(self):
        files = []

        # Exactly the limit
        for x in range(0, MAX_CHUNKS_PER_REQUEST + 1):
            content = b"x"
            files.append(SimpleUploadedFile(sha1(content).hexdigest(), content))

        response = self.client.post(
            self.url,
            data={"file": files},
            HTTP_AUTHORIZATION=f"Bearer {self.token.token}",
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_chunk_upload.py" startline="189" endline="202" pcid="8652">
    def test_too_large_chunk(self):
        files = []
        content = b"x" * (settings.SENTRY_CHUNK_UPLOAD_BLOB_SIZE + 1)
        files.append(SimpleUploadedFile(sha1(content).hexdigest(), content))

        response = self.client.post(
            self.url,
            data={"file": files},
            HTTP_AUTHORIZATION=f"Bearer {self.token.token}",
            format="multipart",
        )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_chunk_upload.py" startline="203" endline="215" pcid="8653">
    def test_checksum_missmatch(self):
        files = []
        content = b"x" * (settings.SENTRY_CHUNK_UPLOAD_BLOB_SIZE + 1)
        files.append(SimpleUploadedFile(b"wrong checksum", content))

        response = self.client.post(
            self.url,
            data={"file": files},
            HTTP_AUTHORIZATION=f"Bearer {self.token.token}",
            format="multipart",
        )

        assert response.status_code == 400, response.content
</source>
</class>

<class classid="298" nclones="3" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rules_configuration.py" startline="30" endline="43" pcid="8661">
    def rules(self):
        rules = RuleRegistry()
        rule = Mock()
        rule.id = EMAIL_ACTION
        rule.rule_type = "action/lol"
        node = rule.return_value
        node.id = EMAIL_ACTION
        node.label = "hello"
        node.prompt = "hello"
        node.is_enabled.return_value = True
        node.form_fields = {}
        rules.add(rule)
        return rules

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rules_configuration.py" startline="73" endline="87" pcid="8665">
    def test_hide_empty_notify_event_service_action(self):
        rules = RuleRegistry()
        rule = Mock()
        rule.id = APP_ACTION
        rule.rule_type = "action/lol"
        node = rule.return_value
        node.id = rule.id
        node.label = "hello"
        node.prompt = "hello"
        node.is_enabled.return_value = True
        node.form_fields = {}
        node.get_services.return_value = []
        rules.add(rule)
        self.run_mock_rules_test(0, {}, rules=rules)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rules_configuration.py" startline="58" endline="72" pcid="8664">
    def test_show_notify_event_service_action(self):
        rules = RuleRegistry()
        rule = Mock()
        rule.id = APP_ACTION
        rule.rule_type = "action/lol"
        node = rule.return_value
        node.id = rule.id
        node.label = "hello"
        node.prompt = "hello"
        node.is_enabled.return_value = True
        node.form_fields = {}
        node.get_services.return_value = [Mock()]
        rules.add(rule)
        self.run_mock_rules_test(1, {}, rules=rules)

</source>
</class>

<class classid="299" nclones="2" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_stats.py" startline="37" endline="53" pcid="8695">
    def test_superuser_sees_unowned_published_stats(self):
        self.login_as(user=self.superuser, superuser=True)

        url = reverse("sentry-api-0-sentry-app-stats", args=[self.unowned_published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert response.data["totalInstalls"] == 1
        assert response.data["totalUninstalls"] == 0
        install_epoch = int(
            to_timestamp(
                self.unowned_published_app_install.date_added.replace(
                    microsecond=0, second=0, minute=0
                )
            )
        )
        assert (install_epoch, 1) in response.data["installStats"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_sentry_app_stats.py" startline="63" endline="77" pcid="8697">
    def test_user_sees_owned_published_stats(self):
        self.login_as(self.user)

        url = reverse("sentry-api-0-sentry-app-stats", args=[self.published_app.slug])
        response = self.client.get(url, format="json")
        assert response.status_code == 200
        assert response.data["totalInstalls"] == 1
        assert response.data["totalUninstalls"] == 0
        install_epoch = int(
            to_timestamp(
                self.published_app_install.date_added.replace(microsecond=0, second=0, minute=0)
            )
        )
        assert (install_epoch, 1) in response.data["installStats"]

</source>
</class>

<class classid="300" nclones="2" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_issues_assigned.py" startline="44" endline="63" pcid="8727">
    def test_via_team(self):
        now = timezone.now()
        user = self.create_user("foo@example.com")
        org = self.create_organization(name="foo")
        team = self.create_team(name="foo", organization=org)
        self.create_member(organization=org, user=user, role="admin", teams=[team])
        project1 = self.create_project(name="foo", organization=org, teams=[team])
        group1 = self.create_group(project=project1)
        GroupAssignee.objects.create(group=group1, project=project1, team=team, date_added=now)

        path = reverse("sentry-api-0-organization-member-issues-assigned", args=[org.slug, "me"])

        self.login_as(user)

        resp = self.client.get(path)

        assert resp.status_code == 200
        assert len(resp.data) == 1
        assert resp.data[0]["id"] == str(group1.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_issues_assigned.py" startline="64" endline="81" pcid="8728">
    def test_team_does_not_return_all_org_teams_for_owners(self):
        now = timezone.now()
        user = self.create_user("foo@example.com")
        org = self.create_organization(name="foo")
        team = self.create_team(name="foo", organization=org)
        self.create_member(organization=org, user=user, role="owner", teams=[])
        project1 = self.create_project(name="foo", organization=org, teams=[team])
        group1 = self.create_group(project=project1)
        GroupAssignee.objects.create(group=group1, project=project1, team=team, date_added=now)

        path = reverse("sentry-api-0-organization-member-issues-assigned", args=[org.slug, "me"])

        self.login_as(user)

        resp = self.client.get(path)

        assert resp.status_code == 200
        assert len(resp.data) == 0
</source>
</class>

<class classid="301" nclones="2" nlines="17" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_assemble.py" startline="79" endline="99" pcid="8732">
    def test_assemble_response(self):
        bundle_file = self.create_artifact_bundle()
        total_checksum = sha1(bundle_file).hexdigest()
        blob1 = FileBlob.from_file(ContentFile(bundle_file))

        assemble_artifacts(
            org_id=self.organization.id,
            version=self.release.version,
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        response = self.client.post(
            self.url,
            data={"checksum": total_checksum, "chunks": [blob1.checksum]},
            HTTP_AUTHORIZATION=f"Bearer {self.token.token}",
        )

        assert response.status_code == 200, response.content
        assert response.data["state"] == ChunkFileState.OK

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_release_assemble.py" startline="100" endline="119" pcid="8733">
    def test_dif_error_response(self):
        bundle_file = b"invalid"
        total_checksum = sha1(bundle_file).hexdigest()
        blob1 = FileBlob.from_file(ContentFile(bundle_file))

        assemble_artifacts(
            org_id=self.organization.id,
            version=self.release.version,
            checksum=total_checksum,
            chunks=[blob1.checksum],
        )

        response = self.client.post(
            self.url,
            data={"checksum": total_checksum, "chunks": [blob1.checksum]},
            HTTP_AUTHORIZATION=f"Bearer {self.token.token}",
        )

        assert response.status_code == 200, response.content
        assert response.data["state"] == ChunkFileState.ERROR
</source>
</class>

<class classid="302" nclones="2" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="65" endline="76" pcid="8742">
    def test_invite_unapproved(self):
        om = OrganizationMember.objects.create(
            email="newuser@example.com",
            token="abc",
            organization=self.organization,
            invite_status=InviteStatus.REQUESTED_TO_JOIN.value,
        )
        resp = self.client.get(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/custom_scm/test_repository.py" startline="67" endline="78" pcid="10443">
    def test_non_null_integration_id(self):
        # has both integration_id and provider
        repo = Repository.objects.create(
            name="new-repo",
            organization_id=self.organization.id,
            provider="integrations:custom_scm",
            integration_id=self.integration.id,
        )
        response = self.create_repository(
            self._get_repo_data(repo), self.integration.id, add_responses=False
        )
        assert response.status_code == 404
</source>
</class>

<class classid="303" nclones="3" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="99" endline="115" pcid="8745">
    def test_user_needs_2fa(self):
        self._require_2fa_for_organization()
        assert not Authenticator.objects.user_has_2fa(self.user)

        self.login_as(self.user)

        om = OrganizationMember.objects.create(
            email="newuser@example.com", token="abc", organization=self.organization
        )
        resp = self.client.get(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 200
        assert resp.data["needs2fa"]

        self._assert_pending_invite_cookie_set(resp, om)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="116" endline="132" pcid="8746">
    def test_user_has_2fa(self):
        self._require_2fa_for_organization()
        self._enroll_user_in_2fa()

        self.login_as(self.user)

        om = OrganizationMember.objects.create(
            email="newuser@example.com", token="abc", organization=self.organization
        )
        resp = self.client.get(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 200
        assert not resp.data["needs2fa"]

        self._assert_pending_invite_cookie_not_set(resp)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="133" endline="147" pcid="8747">
    def test_user_can_use_sso(self):
        AuthProvider.objects.create(organization=self.organization, provider="google")
        self.login_as(self.user)

        om = OrganizationMember.objects.create(
            email="newuser@example.com", token="abc", organization=self.organization
        )
        resp = self.client.get(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 200
        assert resp.data["needsSso"]
        assert resp.data["hasAuthProvider"]
        assert resp.data["ssoProvider"] == "Google"

</source>
</class>

<class classid="304" nclones="2" nlines="18" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="148" endline="171" pcid="8748">
    def test_can_accept_while_authenticated(self):
        self.login_as(self.user)

        om = OrganizationMember.objects.create(
            email="newuser@example.com", role="member", token="abc", organization=self.organization
        )
        resp = self.client.post(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 204

        om = OrganizationMember.objects.get(id=om.id)
        assert om.email is None
        assert om.user == self.user

        ale = AuditLogEntry.objects.get(
            organization=self.organization, event=AuditLogEntryEvent.MEMBER_ACCEPT
        )

        assert ale.actor == self.user
        assert ale.target_object == om.id
        assert ale.target_user == self.user
        assert ale.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_accept_organization_invite.py" startline="237" endline="266" pcid="8752">
    def test_can_accept_when_user_has_2fa(self):
        self._require_2fa_for_organization()
        self._enroll_user_in_2fa()

        self.login_as(self.user)

        om = OrganizationMember.objects.create(
            email="newuser@example.com", role="member", token="abc", organization=self.organization
        )

        resp = self.client.post(
            reverse("sentry-api-0-accept-organization-invite", args=[om.id, om.token])
        )
        assert resp.status_code == 204

        self._assert_pending_invite_cookie_not_set(resp)

        om = OrganizationMember.objects.get(id=om.id)
        assert om.email is None
        assert om.user == self.user

        ale = AuditLogEntry.objects.get(
            organization=self.organization, event=AuditLogEntryEvent.MEMBER_ACCEPT
        )

        assert ale.actor == self.user
        assert ale.target_object == om.id
        assert ale.target_user == self.user
        assert ale.data

</source>
</class>

<class classid="305" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins_configs.py" startline="63" endline="77" pcid="8766">
    def test_configured_not_enabled(self):
        plugins.get("trello").disable(self.projectA)
        plugins.get("trello").set_option("key", "some_value", self.projectA)
        response = self.client.get(self.url)
        assert list(filter(lambda x: x["slug"] == "trello", response.data))[0]["projectList"] == [
            {
                "projectId": self.projectA.id,
                "projectSlug": self.projectA.slug,
                "projectName": self.projectA.name,
                "enabled": False,
                "configured": True,
                "projectPlatform": None,
            }
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_plugins_configs.py" startline="78" endline="92" pcid="8767">
    def test_configured_and_enabled(self):
        plugins.get("trello").enable(self.projectA)
        plugins.get("trello").set_option("key", "some_value", self.projectA)
        response = self.client.get(self.url)
        assert list(filter(lambda x: x["slug"] == "trello", response.data))[0]["projectList"] == [
            {
                "projectId": self.projectA.id,
                "projectSlug": self.projectA.slug,
                "projectName": self.projectA.name,
                "enabled": True,
                "configured": True,
                "projectPlatform": None,
            }
        ]

</source>
</class>

<class classid="306" nclones="6" nlines="10" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="86" endline="104" pcid="8798">
    def test_team_admin_can_add_members_to_team(self):
        self.login_as(self.team_admin.user)

        # member
        resp = self.get_response(self.org.slug, self.member.id, self.team.slug)
        assert resp.status_code == 201

        assert OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.member
        ).exists()

        # manager
        resp = self.get_response(self.org.slug, self.manager.id, self.team.slug)
        assert resp.status_code == 201

        assert OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.manager
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="105" endline="123" pcid="8799">
    def test_manager_can_add_members_to_team(self):
        self.login_as(self.manager.user)

        # member
        resp = self.get_response(self.org.slug, self.member.id, self.team.slug)
        assert resp.status_code == 201

        assert OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.member
        ).exists()

        # owner
        resp = self.get_response(self.org.slug, self.owner.id, self.team.slug)
        assert resp.status_code == 201

        assert OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.owner.id
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="352" endline="370" pcid="8817">
    def test_manager_can_remove_members(self):
        self.login_as(self.team_manager.user)

        # member
        resp = self.get_response(self.org.slug, self.team_member.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_member
        ).exists()

        # owner
        resp = self.get_response(self.org.slug, self.team_owner.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_owner
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="333" endline="351" pcid="8816">
    def test_team_admin_can_remove_members(self):
        self.login_as(self.team_admin.user)

        # member
        resp = self.get_response(self.org.slug, self.team_member.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_member
        ).exists()

        # manager
        resp = self.get_response(self.org.slug, self.team_manager.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_manager
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="371" endline="396" pcid="8818">
    def test_owner_can_remove_members(self):
        self.login_as(self.owner.user)

        # member
        resp = self.get_response(self.org.slug, self.team_member.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_member
        ).exists()

        # manager
        resp = self.get_response(self.org.slug, self.team_manager.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_manager
        ).exists()

        # owner
        resp = self.get_response(self.org.slug, self.team_owner.id, self.team.slug)
        assert resp.status_code == 200

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.team_owner
        ).exists()
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_member_team_details.py" startline="259" endline="275" pcid="8810">
    def test_multiple_of_the_same_access_request(self):
        self.login_as(self.member.user)
        resp = self.get_response(self.org.slug, self.admin.id, self.team.slug)
        assert resp.status_code == 202

        self.login_as(self.team_member.user)
        resp = self.get_response(self.org.slug, self.admin.id, self.team.slug)
        assert resp.status_code == 202

        assert not OrganizationMemberTeam.objects.filter(
            team=self.team, organizationmember=self.admin
        ).exists()

        oar = OrganizationAccessRequest.objects.get(team=self.team, member=self.admin)
        assert oar.requester == self.member.user


</source>
</class>

<class classid="307" nclones="3" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="315" endline="333" pcid="8830">
    def test_minimal(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(url, data={"version": "1.2.1"})

        assert response.status_code == 201, response.content
        assert response.data["version"]

        release = Release.objects.get(version=response.data["version"])
        assert not release.owner
        assert release.organization == project.organization
        assert release.projects.first() == project

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="430" endline="448" pcid="8835">
    def test_features(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(url, data={"version": "1.2.1", "owner": self.user.email})

        assert response.status_code == 201, response.content
        assert response.data["version"]

        release = Release.objects.get(
            organization_id=project.organization_id, version=response.data["version"]
        )
        assert release.owner == self.user

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_releases.py" startline="334" endline="352" pcid="8831">
    def test_ios_release(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")

        url = reverse(
            "sentry-api-0-project-releases",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(url, data={"version": "1.2.1 (123)"})

        assert response.status_code == 201, response.content
        assert response.data["version"]

        release = Release.objects.get(version=response.data["version"])
        assert not release.owner
        assert release.organization == project.organization
        assert release.projects.first() == project

</source>
</class>

<class classid="308" nclones="4" nlines="13" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_searches.py" startline="77" endline="94" pcid="8853">
    def test_simple(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project = self.create_project(teams=[team], name="foo")

        url = reverse(
            "sentry-api-0-project-searches",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(url, data={"name": "ignored", "query": "is:ignored"})

        assert response.status_code == 201, response.content
        assert response.data["id"]

        search = SavedSearch.objects.get(project=project, id=response.data["id"])
        assert not search.is_default

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_searches.py" startline="95" endline="111" pcid="8854">
    def test_duplicate(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project = self.create_project(teams=[team], name="foo")

        SavedSearch.objects.create(name="ignored", project=project, query="")

        url = reverse(
            "sentry-api-0-project-searches",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )

        response = self.client.post(url, data={"name": "ignored", "query": "is:ignored"})

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_searches.py" startline="136" endline="157" pcid="8856">
    def test_user_default(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project = self.create_project(teams=[team], name="foo")

        url = reverse(
            "sentry-api-0-project-searches",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(
            url, data={"name": "ignored", "query": "is:ignored", "isUserDefault": True}
        )

        assert response.status_code == 201, response.content
        assert response.data["id"]

        search = SavedSearch.objects.get(project=project, id=response.data["id"])
        assert not search.is_default

        userdefault = SavedSearchUserDefault.objects.get(project=project, user=self.user)
        assert userdefault.savedsearch == search
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_searches.py" startline="112" endline="135" pcid="8855">
    def test_default(self):
        self.login_as(user=self.user)

        team = self.create_team()
        project = self.create_project(teams=[team], name="foo")

        url = reverse(
            "sentry-api-0-project-searches",
            kwargs={"organization_slug": project.organization.slug, "project_slug": project.slug},
        )
        response = self.client.post(
            url, data={"name": "ignored", "query": "is:ignored", "isDefault": True}
        )

        assert response.status_code == 201, response.content
        assert response.data["id"]

        search = SavedSearch.objects.get(project=project, id=response.data["id"])
        assert search.is_default

        assert not SavedSearchUserDefault.objects.filter(
            project=project, user=self.user, savedsearch=search
        ).exists()

</source>
</class>

<class classid="309" nclones="3" nlines="41" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="143" endline="195" pcid="8862">
    def test_simple(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        conditions = [
            {
                "id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition",
                "key": "foo",
                "match": "eq",
                "value": "bar",
            }
        ]

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "owner": self.user.id,
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "conditions": conditions,
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)

        rule = Rule.objects.get(id=rule.id)
        assert rule.label == "hello world"
        assert rule.owner == self.user.actor
        assert rule.environment_id is None
        assert rule.data["action_match"] == "any"
        assert rule.data["filter_match"] == "any"
        assert rule.data["actions"] == [
            {"id": "sentry.rules.actions.notify_event.NotifyEventAction"}
        ]
        assert rule.data["conditions"] == conditions

        assert RuleActivity.objects.filter(rule=rule, type=RuleActivityType.UPDATED.value).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="753" endline="800" pcid="8875">
    def test_update_filters(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        conditions = [{"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}]
        filters = [
            {"id": "sentry.rules.filters.issue_occurrences.IssueOccurrencesFilter", "value": 10}
        ]

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "conditions": conditions,
                "filters": filters,
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)

        rule = Rule.objects.get(id=rule.id)
        assert rule.label == "hello world"
        assert rule.environment_id is None
        assert rule.data["action_match"] == "any"
        assert rule.data["filter_match"] == "any"
        assert rule.data["actions"] == [
            {"id": "sentry.rules.actions.notify_event.NotifyEventAction"}
        ]
        assert rule.data["conditions"] == conditions + filters

        assert RuleActivity.objects.filter(rule=rule, type=RuleActivityType.UPDATED.value).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="196" endline="247" pcid="8863">
    def test_no_owner(self):
        self.login_as(user=self.user)

        project = self.create_project()

        rule = Rule.objects.create(project=project, label="foo")

        conditions = [
            {
                "id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition",
                "key": "foo",
                "match": "eq",
                "value": "bar",
            }
        ]

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )
        response = self.client.put(
            url,
            data={
                "name": "hello world",
                "owner": None,
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": [{"id": "sentry.rules.actions.notify_event.NotifyEventAction"}],
                "conditions": conditions,
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(rule.id)

        rule = Rule.objects.get(id=rule.id)
        assert rule.label == "hello world"
        assert rule.owner is None
        assert rule.environment_id is None
        assert rule.data["action_match"] == "any"
        assert rule.data["filter_match"] == "any"
        assert rule.data["actions"] == [
            {"id": "sentry.rules.actions.notify_event.NotifyEventAction"}
        ]
        assert rule.data["conditions"] == conditions
        assert RuleActivity.objects.filter(rule=rule, type=RuleActivityType.UPDATED.value).exists()

</source>
</class>

<class classid="310" nclones="2" nlines="69" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="382" endline="465" pcid="8867">
    def test_update_channel_slack(self):
        self.login_as(user=self.user)

        project = self.create_project()
        integration = Integration.objects.create(
            provider="slack",
            name="Awesome Team",
            external_id="TXXXXXXX1",
            metadata={
                "access_token": "xoxp-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx",
                "installation_type": "born_as_bot",
            },
        )
        integration.add_organization(project.organization, self.user)

        conditions = [{"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}]

        actions = [
            {
                "channel_id": "old_channel_id",
                "workspace": integration.id,
                "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                "channel": "#old_channel_name",
            }
        ]

        rule = Rule.objects.create(
            project=project,
            data={"conditions": [conditions], "actions": [actions]},
        )

        actions[0]["channel"] = "#new_channel_name"
        actions[0]["channel_id"] = "new_channel_id"

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )

        channels = {
            "ok": "true",
            "channels": [
                {"name": "old_channel_name", "id": "old_channel_id"},
                {"name": "new_channel_name", "id": "new_channel_id"},
            ],
        }

        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.list",
            status=200,
            content_type="application/json",
            body=json.dumps(channels),
        )
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.info",
            status=200,
            content_type="application/json",
            body=json.dumps({"ok": channels["ok"], "channel": channels["channels"][1]}),
        )

        response = self.client.put(
            url,
            data={
                "name": "#new_channel_name",
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": actions,
                "conditions": conditions,
                "frequency": 30,
            },
            format="json",
        )

        assert response.status_code == 200, response.content
        rule = Rule.objects.get(id=response.data["id"])
        assert rule.label == "#new_channel_name"
        assert rule.data["actions"][0]["channel_id"] == "new_channel_id"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_project_rule_details.py" startline="467" endline="542" pcid="8868">
    def test_update_channel_slack_workspace_fail(self):
        self.login_as(user=self.user)

        project = self.create_project()
        integration = Integration.objects.create(
            provider="slack",
            name="Awesome Team",
            external_id="TXXXXXXX1",
            metadata={"access_token": "xoxp-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx"},
        )
        integration.add_organization(project.organization, self.user)

        conditions = [{"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}]

        actions = [
            {
                "channel_id": "old_channel_id",
                "workspace": integration.id,
                "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                "channel": "#old_channel_name",
            }
        ]

        rule = Rule.objects.create(
            project=project,
            data={"conditions": [conditions], "actions": [actions]},
        )

        actions[0]["channel"] = "#new_channel_name"

        url = reverse(
            "sentry-api-0-project-rule-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
                "rule_id": rule.id,
            },
        )

        channels = {
            "ok": "true",
            "channels": [
                {"name": "old_channel_name", "id": "old_channel_id"},
                {"name": "new_channel_name", "id": "new_channel_id"},
            ],
        }
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.list",
            status=200,
            content_type="application/json",
            body=json.dumps(channels),
        )
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.info",
            status=200,
            content_type="application/json",
            body=json.dumps({"ok": channels["ok"], "channel": channels["channels"][0]}),
        )

        response = self.client.put(
            url,
            data={
                "name": "#new_channel_name",
                "actionMatch": "any",
                "filterMatch": "any",
                "actions": actions,
                "conditions": conditions,
                "frequency": 30,
            },
            format="json",
        )

        assert response.status_code == 400, response.content

</source>
</class>

<class classid="311" nclones="2" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_projects.py" startline="64" endline="81" pcid="8906">
    def test_with_default_rules(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team1 = self.create_team(organization=org, name="foo")

        path = f"/api/0/teams/{org.slug}/{team1.slug}/projects/"

        self.login_as(user=user)

        response = self.client.post(path, data={"name": "Test Project"})

        assert response.status_code == 201, response.content
        project = Project.objects.get(id=response.data["id"])
        assert project.name == "Test Project"
        assert project.slug

        assert Rule.objects.filter(project=project).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_team_projects.py" startline="82" endline="99" pcid="8907">
    def test_without_default_rules(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        team1 = self.create_team(organization=org, name="foo")

        path = f"/api/0/teams/{org.slug}/{team1.slug}/projects/"

        self.login_as(user=user)

        response = self.client.post(path, data={"name": "Test Project", "default_rules": False})

        assert response.status_code == 201, response.content
        project = Project.objects.get(id=response.data["id"])
        assert project.name == "Test Project"
        assert project.slug

        assert not Rule.objects.filter(project=project).exists()

</source>
</class>

<class classid="312" nclones="11" nlines="14" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="14" endline="28" pcid="8975">
    def test_valid_widget(self):
        data = {
            "title": "Errors over time",
            "displayType": "line",
            "queries": [
                {"name": "errors", "conditions": "event.type:error", "fields": ["count()"]}
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 200, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="54" endline="70" pcid="8979">
    def test_invalid_query_fields(self):
        data = {
            "title": "Invalid query",
            "displayType": "line",
            "queries": [
                {"name": "errors", "conditions": "event.type:error", "fields": ["p95(user)"]}
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data
        assert response.data["queries"][0]["fields"], response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="146" endline="158" pcid="8984">
    def test_valid_epm_widget(self):
        data = {
            "title": "EPM Big Number",
            "displayType": "big_number",
            "queries": [{"name": "", "fields": ["epm()"], "conditions": "", "orderby": ""}],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 200, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="33" endline="49" pcid="8977">
    def test_invalid_query_conditions(self):
        data = {
            "title": "Invalid query",
            "displayType": "line",
            "queries": [
                {"name": "errors", "conditions": "event.type: tag:foo", "fields": ["count()"]}
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data
        assert response.data["queries"][0]["conditions"], response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="238" endline="253" pcid="8988">
    def test_invalid_issue_query_conditions(self):
        data = {
            "title": "Unresolved Issues",
            "displayType": "table",
            "widgetType": "issue",
            "queries": [{"name": "unresolved", "conditions": "is:())", "fields": []}],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data
        assert response.data["queries"][0]["conditions"], response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="224" endline="237" pcid="8987">
    def test_valid_issue_query_conditions(self):
        data = {
            "title": "Unresolved Issues",
            "displayType": "table",
            "widgetType": "issue",
            "queries": [{"name": "unresolved", "conditions": "is:unresolved", "fields": []}],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 200, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="254" endline="268" pcid="8989">
    def test_invalid_issue_query_conditions_in_discover_widget(self):
        data = {
            "title": "Unresolved Issues",
            "displayType": "table",
            "widgetType": "discover",
            "queries": [{"name": "unresolved", "conditions": "is:unresolved", "fields": []}],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data
        assert response.data["queries"][0]["conditions"], response.data
</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="71" endline="86" pcid="8980">
    def test_invalid_display_type(self):
        data = {
            "title": "Invalid query",
            "displayType": "cats",
            "queries": [
                {"name": "errors", "conditions": "event.type:error", "fields": ["count()"]}
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "displayType" in response.data, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="87" endline="106" pcid="8981">
    def test_invalid_equation(self):
        data = {
            "title": "Invalid query",
            "displayType": "line",
            "queries": [
                {
                    "name": "errors",
                    "conditions": "event.type:error",
                    "fields": ["equation|count()"],
                }
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="126" endline="145" pcid="8983">
    def test_invalid_equation_table_widget(self):
        data = {
            "title": "Invalid query",
            "displayType": "table",
            "queries": [
                {
                    "name": "errors",
                    "conditions": "event.type:error",
                    "fields": ["equation|count() * 2"],
                }
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 400, response.data
        assert "queries" in response.data, response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_dashboard_widget_details.py" startline="107" endline="125" pcid="8982">
    def test_valid_equation_line_widget(self):
        data = {
            "title": "Invalid query",
            "displayType": "line",
            "queries": [
                {
                    "name": "errors",
                    "conditions": "event.type:error",
                    "fields": ["equation|count() * 2"],
                }
            ],
        }
        response = self.do_request(
            "post",
            self.url(),
            data=data,
        )
        assert response.status_code == 200, response.data

</source>
</class>

<class classid="313" nclones="2" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_has_mobile_app_events.py" startline="23" endline="34" pcid="8992">
    def test_hit_cache_on_success(self, mock_query):
        mock_query.return_value = {"data": [{"browser.name": "okhttp", "client_os.name": ""}]}
        response = self.get_response(self.organization.slug, userAgents=["okhttp"])
        assert response.status_code == 200
        assert response.data == {"browserName": "okhttp", "clientOsName": ""}
        assert mock_query.call_count == 1

        response = self.get_response(self.organization.slug, userAgents=["okhttp"])
        assert response.status_code == 200
        assert response.data == {"browserName": "okhttp", "clientOsName": ""}
        assert mock_query.call_count == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_has_mobile_app_events.py" startline="42" endline="53" pcid="8994">
    def test_hit_cache_on_no_match(self, mock_query):
        mock_query.return_value = {"data": []}
        response = self.get_response(self.organization.slug, userAgents=["okhttp"])
        assert response.status_code == 200
        assert response.data is None
        assert mock_query.call_count == 1

        response = self.get_response(self.organization.slug, userAgents=["okhttp"])
        assert response.status_code == 200
        assert response.data is None
        assert mock_query.call_count == 1

</source>
</class>

<class classid="314" nclones="2" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_stats.py" startline="48" endline="68" pcid="9017">
    def test_id_filtering(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user)
        project = self.create_project(
            teams=[self.create_team(organization=org, members=[self.user])]
        )

        make_request = functools.partial(
            self.client.get, reverse("sentry-api-0-organization-stats", args=[org.slug])
        )

        response = make_request({"id": [project.id], "group": "project"})

        assert response.status_code == 200, response.content
        assert project.id in response.data

        response = make_request({"id": [sys.maxsize], "group": "project"})

        assert project.id not in response.data

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_organization_stats.py" startline="69" endline="88" pcid="9018">
    def test_project_id_only(self):
        self.login_as(user=self.user)

        org = self.create_organization(owner=self.user)
        project = self.create_project(
            teams=[self.create_team(organization=org, members=[self.user])]
        )
        project2 = self.create_project(
            teams=[self.create_team(organization=org, members=[self.user])]
        )

        make_request = functools.partial(
            self.client.get, reverse("sentry-api-0-organization-stats", args=[org.slug])
        )

        response = make_request({"projectID": [project.id], "group": "project"})

        assert response.status_code == 200, response.content
        assert project.id in response.data
        assert project2.id not in response.data
</source>
</class>

<class classid="315" nclones="3" nlines="27" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="179" endline="219" pcid="9079">
    def test_ascending(self):
        joined = timezone.now()

        # The DateTime pager only has accuracy up to 1000th of a second.
        # Everything can't be added within less than 10 microseconds of each
        # other. This is handled by the pager (see test_rounding_offset), but
        # this case shouldn't rely on it.
        res1 = self.create_user("foo@example.com", date_joined=joined)
        res2 = self.create_user("bar@example.com", date_joined=joined + timedelta(seconds=1))
        res3 = self.create_user("baz@example.com", date_joined=joined + timedelta(seconds=2))
        res4 = self.create_user("qux@example.com", date_joined=joined + timedelta(seconds=3))

        queryset = User.objects.all()

        paginator = DateTimePaginator(queryset, "date_joined")
        result1 = paginator.get_result(limit=2, cursor=None)
        assert len(result1) == 2, result1
        assert result1[0] == res1
        assert result1[1] == res2
        assert result1.next
        assert not result1.prev

        result2 = paginator.get_result(limit=2, cursor=result1.next)
        assert len(result2) == 2, result2
        assert result2[0] == res3
        assert result2[1] == res4
        assert not result2.next
        assert result2.prev

        result3 = paginator.get_result(limit=1, cursor=result2.prev)
        assert len(result3) == 1, result3
        assert result3[0] == res2
        assert result3.next
        assert result3.prev

        result4 = paginator.get_result(limit=1, cursor=result3.prev)
        assert len(result4) == 1, result4
        assert result4[0] == res1
        assert result4.next
        assert not result4.prev

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="277" endline="309" pcid="9082">
    def test_rounding_offset(self):
        joined = timezone.now()

        res1 = self.create_user("foo@example.com", date_joined=joined)
        res2 = self.create_user("bar@example.com", date_joined=joined + timedelta(microseconds=1))
        res3 = self.create_user("baz@example.com", date_joined=joined + timedelta(microseconds=2))
        res4 = self.create_user("qux@example.com", date_joined=joined + timedelta(microseconds=3))

        queryset = User.objects.all()

        paginator = DateTimePaginator(queryset, "date_joined")
        result1 = paginator.get_result(limit=3, cursor=None)
        assert len(result1) == 3, result1
        assert result1[0] == res1
        assert result1[1] == res2
        assert result1[2] == res3

        result2 = paginator.get_result(limit=10, cursor=result1.next)
        assert len(result2) == 1, result2
        assert result2[0] == res4

        result3 = paginator.get_result(limit=2, cursor=result2.prev)
        assert len(result3) == 2, result3
        assert result3[0] == res2
        assert result3[1] == res3

        result4 = paginator.get_result(limit=1, cursor=result3.prev)
        assert len(result4) == 1, result4
        assert result4[0] == res1

        result5 = paginator.get_result(limit=10, cursor=result4.prev)
        assert len(result5) == 0, list(result5)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="220" endline="248" pcid="9080">
    def test_descending(self):
        joined = timezone.now()

        res1 = self.create_user("foo@example.com", date_joined=joined)
        res2 = self.create_user("bar@example.com", date_joined=joined + timedelta(seconds=1))
        res3 = self.create_user("baz@example.com", date_joined=joined + timedelta(seconds=2))

        queryset = User.objects.all()

        paginator = DateTimePaginator(queryset, "-date_joined")
        result1 = paginator.get_result(limit=1, cursor=None)
        assert len(result1) == 1, result1
        assert result1[0] == res3
        assert result1.next
        assert not result1.prev

        result2 = paginator.get_result(limit=2, cursor=result1.next)
        assert len(result2) == 2, result2
        assert result2[0] == res2
        assert result2[1] == res1
        assert not result2.next
        assert result2.prev

        result3 = paginator.get_result(limit=2, cursor=result2.prev)
        assert len(result3) == 1, result3
        assert result3[0] == res3
        assert result3.next
        assert not result3.prev

</source>
</class>

<class classid="316" nclones="4" nlines="18" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="420" endline="442" pcid="9086">
    def test_ascending_simple(self):
        paginator = SequencePaginator([(i, i) for i in range(10)], reverse=False)

        result = paginator.get_result(5)
        assert list(result) == [0, 1, 2, 3, 4]
        assert result.prev == Cursor(0, 0, True, False)
        assert result.next == Cursor(5, 0, False, True)

        result = paginator.get_result(5, result.next)
        assert list(result) == [5, 6, 7, 8, 9]
        assert result.prev == Cursor(5, 0, True, True)
        assert result.next == Cursor(9, 1, False, False)

        result = paginator.get_result(5, result.prev)
        assert list(result) == [0, 1, 2, 3, 4]
        assert result.prev == Cursor(0, 0, True, False)
        assert result.next == Cursor(5, 0, False, True)

        result = paginator.get_result(5, Cursor(100, 0, False))
        assert list(result) == []
        assert result.prev == Cursor(9, 1, True, True)
        assert result.next == Cursor(9, 1, False, False)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="489" endline="511" pcid="9089">
    def test_descending_repeated_scores(self):
        paginator = SequencePaginator([(1, i) for i in range(10)], reverse=True)

        result = paginator.get_result(5)
        assert list(result) == [9, 8, 7, 6, 5]
        assert result.prev == Cursor(1, 0, True, False)
        assert result.next == Cursor(1, 5, False, True)

        result = paginator.get_result(5, result.next)
        assert list(result) == [4, 3, 2, 1, 0]
        assert result.prev == Cursor(1, 5, True, True)
        assert result.next == Cursor(1, 10, False, False)

        result = paginator.get_result(5, result.prev)
        assert list(result) == [9, 8, 7, 6, 5]
        assert result.prev == Cursor(1, 0, True, False)
        assert result.next == Cursor(1, 5, False, True)

        result = paginator.get_result(5, Cursor(-10, 0, False))
        assert list(result) == []
        assert result.prev == Cursor(1, 10, True, True)
        assert result.next == Cursor(1, 10, False, False)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="443" endline="465" pcid="9087">
    def test_descending_simple(self):
        paginator = SequencePaginator([(i, i) for i in range(10)], reverse=True)

        result = paginator.get_result(5)
        assert list(result) == [9, 8, 7, 6, 5]
        assert result.prev == Cursor(9, 0, True, False)
        assert result.next == Cursor(4, 0, False, True)

        result = paginator.get_result(5, result.next)
        assert list(result) == [4, 3, 2, 1, 0]
        assert result.prev == Cursor(4, 0, True, True)
        assert result.next == Cursor(0, 1, False, False)

        result = paginator.get_result(5, result.prev)
        assert list(result) == [9, 8, 7, 6, 5]
        assert result.prev == Cursor(9, 0, True, False)
        assert result.next == Cursor(4, 0, False, True)

        result = paginator.get_result(5, Cursor(-10, 0, False))
        assert list(result) == []
        assert result.prev == Cursor(0, 1, True, True)
        assert result.next == Cursor(0, 1, False, False)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/test_paginator.py" startline="466" endline="488" pcid="9088">
    def test_ascending_repeated_scores(self):
        paginator = SequencePaginator([(1, i) for i in range(10)], reverse=False)

        result = paginator.get_result(5)
        assert list(result) == [0, 1, 2, 3, 4]
        assert result.prev == Cursor(1, 0, True, False)
        assert result.next == Cursor(1, 5, False, True)

        result = paginator.get_result(5, result.next)
        assert list(result) == [5, 6, 7, 8, 9]
        assert result.prev == Cursor(1, 5, True, True)
        assert result.next == Cursor(1, 10, False, False)

        result = paginator.get_result(5, result.prev)
        assert list(result) == [0, 1, 2, 3, 4]
        assert result.prev == Cursor(1, 0, True, False)
        assert result.next == Cursor(1, 5, False, True)

        result = paginator.get_result(5, Cursor(100, 0, False))
        assert list(result) == []
        assert result.prev == Cursor(1, 10, True, True)
        assert result.next == Cursor(1, 10, False, False)

</source>
</class>

<class classid="317" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_age_comparison.py" startline="15" endline="29" pcid="9101">
    def test_older_applies_correctly(self, now):
        now.return_value = datetime(2020, 8, 1, 0, 0, 0, 0, tzinfo=pytz.utc)

        event = self.get_event()
        value = 10
        data = {"comparison_type": "older", "value": str(value), "time": "hour"}

        rule = self.get_rule(data=data)

        event.group.first_seen = timezone.now() - timedelta(hours=3)
        self.assertDoesNotPass(rule, event)

        event.group.first_seen = timezone.now() - timedelta(hours=11)
        self.assertPasses(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_age_comparison.py" startline="31" endline="45" pcid="9102">
    def test_newer_applies_correctly(self, now):
        now.return_value = datetime(2020, 8, 1, 0, 0, 0, 0, tzinfo=pytz.utc)

        event = self.get_event()
        value = 10
        data = {"comparison_type": "newer", "value": str(value), "time": "hour"}

        rule = self.get_rule(data=data)

        event.group.first_seen = timezone.now() - timedelta(hours=3)
        self.assertPasses(rule, event)

        event.group.first_seen = timezone.now() - timedelta(hours=11)
        self.assertDoesNotPass(rule, event)

</source>
</class>

<class classid="318" nclones="2" nlines="10" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_assigned_to.py" startline="20" endline="31" pcid="9105">
    def test_assigned_to_member_fails(self):
        event = self.get_event()
        user = self.create_user()
        GroupAssignee.objects.create(user=user, group=event.group, project=self.project)

        data = {
            "targetType": "Member",
            "targetIdentifier": self.user.id,
        }
        rule = self.get_rule(data=data)
        self.assertDoesNotPass(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_assigned_to.py" startline="43" endline="54" pcid="9107">
    def test_assigned_to_team_fails(self):
        event = self.get_event()
        team = self.create_team(self.organization)
        GroupAssignee.objects.create(team=team, group=event.group, project=self.project)

        data = {
            "targetType": "Team",
            "targetIdentifier": (self.team.id),
        }
        rule = self.get_rule(data=data)
        self.assertDoesNotPass(rule, event)

</source>
</class>

<class classid="319" nclones="2" nlines="17" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_latest_release.py" startline="12" endline="31" pcid="9114">
    def test_latest_release(self):
        event = self.get_event()
        oldRelease = Release.objects.create(
            organization_id=self.organization.id,
            version="1",
            date_added=datetime(2020, 9, 1, 3, 8, 24, 880386),
        )
        oldRelease.add_project(self.project)

        newRelease = Release.objects.create(
            organization_id=self.organization.id,
            version="2",
            date_added=datetime(2020, 9, 2, 3, 8, 24, 880386),
        )
        newRelease.add_project(self.project)

        event.data["tags"] = (("release", newRelease.version),)
        rule = self.get_rule()
        self.assertPasses(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/filters/test_latest_release.py" startline="32" endline="51" pcid="9115">
    def test_latest_release_no_match(self):
        event = self.get_event()
        oldRelease = Release.objects.create(
            organization_id=self.organization.id,
            version="1",
            date_added=datetime(2020, 9, 1, 3, 8, 24, 880386),
        )
        oldRelease.add_project(self.project)

        newRelease = Release.objects.create(
            organization_id=self.organization.id,
            version="2",
            date_added=datetime(2020, 9, 2, 3, 8, 24, 880386),
        )
        newRelease.add_project(self.project)

        event.data["tags"] = (("release", oldRelease.version),)
        rule = self.get_rule()
        self.assertDoesNotPass(rule, event)

</source>
</class>

<class classid="320" nclones="2" nlines="13" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/rules/actions/test_notify_event_service.py" startline="13" endline="30" pcid="9118">
    def test_applies_correctly_for_plugins(self):
        event = self.get_event()

        plugin = MagicMock()
        plugin.is_enabled.return_value = True
        plugin.should_notify.return_value = True

        rule = self.get_rule(data={"service": "mail"})

        with patch("sentry.plugins.base.plugins.get") as get_plugin:
            get_plugin.return_value = plugin

            results = list(rule.after(event=event, state=self.get_state()))

        assert len(results) == 1
        assert plugin.should_notify.call_count == 1
        assert results[0].callback is plugin.rule_notify

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/actions/test_notify_event_service.py" startline="45" endline="65" pcid="9120">
    def test_notify_sentry_app_and_plugin_with_same_slug(self):
        event = self.get_event()

        self.create_sentry_app(organization=event.organization, name="Notify", is_alertable=True)

        plugin = MagicMock()
        plugin.is_enabled.return_value = True
        plugin.should_notify.return_value = True

        rule = self.get_rule(data={"service": "notify"})

        with patch("sentry.plugins.base.plugins.get") as get_plugin:
            get_plugin.return_value = plugin

            results = list(rule.after(event=event, state=self.get_state()))

        assert len(results) == 2
        assert plugin.should_notify.call_count == 1
        assert results[0].callback is notify_sentry_app
        assert results[1].callback is plugin.rule_notify

</source>
</class>

<class classid="321" nclones="2" nlines="21" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/rules/conditions/test_event_attribute.py" startline="318" endline="351" pcid="9158">
    def test_stacktrace_filename(self):
        """Stacktrace.filename should match frames anywhere in the stack."""

        event = self.get_event(
            exception={
                "values": [
                    {
                        "type": "SyntaxError",
                        "value": "hello world",
                        "stacktrace": {
                            "frames": [
                                {"filename": "example.php", "module": "example"},
                                {"filename": "somecode.php", "module": "somecode"},
                                {"filename": "othercode.php", "module": "othercode"},
                            ]
                        },
                    }
                ]
            }
        )

        # correctly matching filenames, at various locations in the stacktrace
        for value in ["example.php", "somecode.php", "othercode.php"]:
            rule = self.get_rule(
                data={"match": MatchType.EQUAL, "attribute": "stacktrace.filename", "value": value}
            )
            self.assertPasses(rule, event)

        # non-matching filename
        rule = self.get_rule(
            data={"match": MatchType.EQUAL, "attribute": "stacktrace.filename", "value": "foo.php"}
        )
        self.assertDoesNotPass(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/conditions/test_event_attribute.py" startline="352" endline="385" pcid="9159">
    def test_stacktrace_module(self):
        """Stacktrace.module should match frames anywhere in the stack."""

        event = self.get_event(
            exception={
                "values": [
                    {
                        "type": "SyntaxError",
                        "value": "hello world",
                        "stacktrace": {
                            "frames": [
                                {"filename": "example.php", "module": "example"},
                                {"filename": "somecode.php", "module": "somecode"},
                                {"filename": "othercode.php", "module": "othercode"},
                            ]
                        },
                    }
                ]
            }
        )

        # correctly matching modules, at various locations in the stacktrace
        for value in ["example", "somecode", "othercode"]:
            rule = self.get_rule(
                data={"match": MatchType.EQUAL, "attribute": "stacktrace.module", "value": value}
            )
            self.assertPasses(rule, event)

        # non-matching module
        rule = self.get_rule(
            data={"match": MatchType.EQUAL, "attribute": "stacktrace.module", "value": "foo"}
        )
        self.assertDoesNotPass(rule, event)

</source>
</class>

<class classid="322" nclones="3" nlines="36" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/rules/conditions/test_event_attribute.py" startline="386" endline="434" pcid="9160">
    def test_stacktrace_code(self):
        """Stacktrace.code should match frames anywhere in the stack."""

        event = self.get_event(
            exception={
                "values": [
                    {
                        "type": "NameError",
                        "value": "name 'hi' is not defined",
                        "stacktrace": {
                            "frames": [
                                {
                                    "filename": "example.py",
                                    "module": "example",
                                    "function": "foo",
                                    "context_line": "somecode.bar()",
                                },
                                {
                                    "filename": "somecode.py",
                                    "module": "somecode",
                                    "function": "bar",
                                    "context_line": "othercode.baz()",
                                },
                                {
                                    "filename": "othercode.py",
                                    "module": "othercode",
                                    "function": "baz",
                                    "context_line": "hi()",
                                },
                            ]
                        },
                    }
                ]
            }
        )

        # correctly matching code, at various locations in the stacktrace
        for value in ["somecode.bar()", "othercode.baz()", "hi()"]:
            rule = self.get_rule(
                data={"match": MatchType.EQUAL, "attribute": "stacktrace.code", "value": value}
            )
            self.assertPasses(rule, event)

        # non-matching code
        rule = self.get_rule(
            data={"match": MatchType.EQUAL, "attribute": "stacktrace.code", "value": "foo"}
        )
        self.assertDoesNotPass(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/conditions/test_event_attribute.py" startline="480" endline="529" pcid="9165">
    def test_stacktrace_abs_path(self):
        """Stacktrace.abs_path should match frames anywhere in the stack."""

        event = self.get_event(
            exception={
                "values": [
                    {
                        "type": "SyntaxError",
                        "value": "hello world",
                        "stacktrace": {
                            "frames": [
                                {
                                    "filename": "example.php",
                                    "module": "example",
                                    "abs_path": "path/to/example.php",
                                },
                                {
                                    "filename": "somecode.php",
                                    "module": "somecode",
                                    "abs_path": "path/to/somecode.php",
                                },
                                {
                                    "filename": "othercode.php",
                                    "module": "othercode",
                                    "abs_path": "path/to/othercode.php",
                                },
                            ]
                        },
                    }
                ]
            }
        )

        # correctly matching filenames, at various locations in the stacktrace
        for value in ["path/to/example.php", "path/to/somecode.php", "path/to/othercode.php"]:
            rule = self.get_rule(
                data={"match": MatchType.EQUAL, "attribute": "stacktrace.abs_path", "value": value}
            )
            self.assertPasses(rule, event)

        # non-matching filename
        rule = self.get_rule(
            data={
                "match": MatchType.EQUAL,
                "attribute": "stacktrace.abs_path",
                "value": "path/to/foo.php",
            }
        )
        self.assertDoesNotPass(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/rules/conditions/test_event_attribute.py" startline="530" endline="572" pcid="9166">
    def test_stacktrace_package(self):
        """Stacktrace.package should match frames anywhere in the stack."""

        event = self.get_event(
            exception={
                "values": [
                    {
                        "type": "SyntaxError",
                        "value": "hello world",
                        "stacktrace": {
                            "frames": [
                                {"filename": "example.php", "package": "package/example.lib"},
                                {
                                    "filename": "somecode.php",
                                    "package": "package/otherpackage.lib",
                                },
                                {
                                    "filename": "othercode.php",
                                    "package": "package/somepackage.lib",
                                },
                            ]
                        },
                    }
                ]
            }
        )

        # correctly matching filenames, at various locations in the stacktrace
        for value in ["package/example.lib", "package/otherpackage.lib", "package/somepackage.lib"]:
            rule = self.get_rule(
                data={"match": MatchType.EQUAL, "attribute": "stacktrace.package", "value": value}
            )
            self.assertPasses(rule, event)

        # non-matching filename
        rule = self.get_rule(
            data={
                "match": MatchType.EQUAL,
                "attribute": "stacktrace.package",
                "value": "package/otherotherpackage.lib",
            }
        )
        self.assertDoesNotPass(rule, event)
</source>
</class>

<class classid="323" nclones="2" nlines="14" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_mailgun_inbound_webhook.py" startline="18" endline="32" pcid="9200">
    def test_invalid_signature(self, process_inbound_email):
        with self.options({"mail.mailgun-api-key": "a" * 32}):
            resp = self.client.post(
                reverse("sentry-mailgun-inbound-hook"),
                {
                    "recipient": self.mailto,
                    "sender": self.user.email,
                    "body-plain": body_plain,
                    "signature": "",
                    "token": "",
                    "timestamp": "",
                },
            )
            assert resp.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_mailgun_inbound_webhook.py" startline="34" endline="47" pcid="9201">
    def test_missing_api_key(self, process_inbound_email):
        resp = self.client.post(
            reverse("sentry-mailgun-inbound-hook"),
            {
                "recipient": self.mailto,
                "sender": self.user.email,
                "body-plain": body_plain,
                "signature": "",
                "token": "",
                "timestamp": "",
            },
        )
        assert resp.status_code == 500

</source>
</class>

<class classid="324" nclones="3" nlines="22" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_organization_auth_settings.py" startline="273" endline="302" pcid="9242">
    def test_edit_sso_settings(self):
        organization, auth_provider = self.create_org_and_auth_provider()
        self.create_om_and_link_sso(organization)
        path = reverse("sentry-organization-auth-provider-settings", args=[organization.slug])

        assert not getattr(auth_provider.flags, "allow_unlinked")
        assert organization.default_role == "member"
        self.login_as(self.user, organization_id=organization.id)

        with self.feature("organizations:sso-basic"):
            resp = self.client.post(
                path, {"op": "settings", "require_link": False, "default_role": "owner"}
            )

        assert resp.status_code == 200

        auth_provider = AuthProvider.objects.get(organization=organization)
        assert getattr(auth_provider.flags, "allow_unlinked")
        organization = Organization.objects.get(id=organization.id)
        assert organization.default_role == "owner"

        result = AuditLogEntry.objects.filter(
            organization=organization,
            target_object=auth_provider.id,
            event=AuditLogEntryEvent.SSO_EDIT,
            actor=self.user,
        )[0]

        assert result.data == {"require_link": "to False", "default_role": "to owner"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_organization_auth_settings.py" startline="333" endline="362" pcid="9244">
    def test_edit_sso_settings__default_role(self):
        organization, auth_provider = self.create_org_and_auth_provider()
        self.create_om_and_link_sso(organization)
        path = reverse("sentry-organization-auth-provider-settings", args=[organization.slug])

        assert not getattr(auth_provider.flags, "allow_unlinked")
        assert organization.default_role == "member"
        self.login_as(self.user, organization_id=organization.id)

        with self.feature("organizations:sso-basic"):
            resp = self.client.post(
                path, {"op": "settings", "require_link": True, "default_role": "owner"}
            )

        assert resp.status_code == 200

        auth_provider = AuthProvider.objects.get(organization=organization)
        assert not getattr(auth_provider.flags, "allow_unlinked")
        organization = Organization.objects.get(id=organization.id)
        assert organization.default_role == "owner"

        result = AuditLogEntry.objects.filter(
            organization=organization,
            target_object=auth_provider.id,
            event=AuditLogEntryEvent.SSO_EDIT,
            actor=self.user,
        )[0]

        assert result.data == {"default_role": "to owner"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_organization_auth_settings.py" startline="303" endline="332" pcid="9243">
    def test_edit_sso_settings__sso_required(self):
        organization, auth_provider = self.create_org_and_auth_provider()
        self.create_om_and_link_sso(organization)
        path = reverse("sentry-organization-auth-provider-settings", args=[organization.slug])

        assert not getattr(auth_provider.flags, "allow_unlinked")
        assert organization.default_role == "member"
        self.login_as(self.user, organization_id=organization.id)

        with self.feature("organizations:sso-basic"):
            resp = self.client.post(
                path, {"op": "settings", "require_link": False, "default_role": "member"}
            )

        assert resp.status_code == 200

        auth_provider = AuthProvider.objects.get(organization=organization)
        assert getattr(auth_provider.flags, "allow_unlinked")
        organization = Organization.objects.get(id=organization.id)
        assert organization.default_role == "member"

        result = AuditLogEntry.objects.filter(
            organization=organization,
            target_object=auth_provider.id,
            event=AuditLogEntryEvent.SSO_EDIT,
            actor=self.user,
        )[0]

        assert result.data == {"require_link": "to False"}

</source>
</class>

<class classid="325" nclones="4" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_user_avatar.py" startline="11" endline="21" pcid="9258">
    def test_headers(self):
        user = self.create_user(email="a@example.com")
        photo = File.objects.create(name="test.png", type="avatar.file")
        photo.putfile(BytesIO(b"test"))
        avatar = UserAvatar.objects.create(user=user, file_id=photo.id)
        url = reverse("sentry-user-avatar-url", kwargs={"avatar_id": avatar.ident})
        response = self.client.get(url)
        assert response.status_code == 200
        assert response["Cache-Control"] == FOREVER_CACHE
        assert response.get("Vary") is None
        assert response.get("Set-Cookie") is None
</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_team_avatar.py" startline="11" endline="21" pcid="9310">
    def test_headers(self):
        team = self.create_team()
        photo = File.objects.create(name="test.png", type="avatar.file")
        photo.putfile(BytesIO(b"test"))
        avatar = TeamAvatar.objects.create(team=team, file_id=photo.id)
        url = reverse("sentry-team-avatar-url", kwargs={"avatar_id": avatar.ident})
        response = self.client.get(url)
        assert response.status_code == 200
        assert response["Cache-Control"] == FOREVER_CACHE
        assert response.get("Vary") is None
        assert response.get("Set-Cookie") is None
</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_organization_avatar.py" startline="11" endline="21" pcid="9333">
    def test_headers(self):
        org = self.create_organization()
        photo = File.objects.create(name="test.png", type="avatar.file")
        photo.putfile(BytesIO(b"test"))
        avatar = OrganizationAvatar.objects.create(organization=org, file_id=photo.id)
        url = reverse("sentry-organization-avatar-url", kwargs={"avatar_id": avatar.ident})
        response = self.client.get(url)
        assert response.status_code == 200
        assert response["Cache-Control"] == FOREVER_CACHE
        assert response.get("Vary") is None
        assert response.get("Set-Cookie") is None
</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_project_avatar.py" startline="11" endline="21" pcid="9332">
    def test_headers(self):
        project = self.create_project()
        photo = File.objects.create(name="test.png", type="avatar.file")
        photo.putfile(BytesIO(b"test"))
        avatar = ProjectAvatar.objects.create(project=project, file_id=photo.id)
        url = reverse("sentry-project-avatar-url", kwargs={"avatar_id": avatar.ident})
        response = self.client.get(url)
        assert response.status_code == 200
        assert response["Cache-Control"] == FOREVER_CACHE
        assert response.get("Vary") is None
        assert response.get("Set-Cookie") is None
</source>
</class>

<class classid="326" nclones="2" nlines="18" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_auth_login.py" startline="147" endline="176" pcid="9270">
    def test_registration_single_org_with_invite(self, from_cookie):
        self.session["can_register"] = True
        self.save_session()

        self.client.get(self.path)

        invite_helper = mock.Mock(valid_request=True)
        from_cookie.return_value = invite_helper

        resp = self.client.post(
            self.path,
            {
                "username": "test@example.com",
                "password": "foobar",
                "name": "Foo Bar",
                "op": "register",
            },
        )

        user = User.objects.get(username="test@example.com")

        # An organization member should NOT have been created, even though
        # we're in single org mode, accepting the invite will handle that
        # (which we assert next)
        assert not OrganizationMember.objects.filter(user=user).exists()

        # Invitation was accepted
        assert len(invite_helper.accept_invite.mock_calls) == 1
        assert resp.status_code == 302

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_auth_login.py" startline="200" endline="220" pcid="9273">
    def test_register_accepts_invite(self, from_cookie):
        self.session["can_register"] = True
        self.save_session()

        self.client.get(self.path)

        invite_helper = mock.Mock(valid_request=True)
        from_cookie.return_value = invite_helper

        resp = self.client.post(
            self.path,
            {
                "username": "test@example.com",
                "password": "foobar",
                "name": "Foo Bar",
                "op": "register",
            },
        )
        assert resp.status_code == 302
        assert len(invite_helper.accept_invite.mock_calls) == 1

</source>
</class>

<class classid="327" nclones="2" nlines="16" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_authorize.py" startline="72" endline="95" pcid="9294">
    def test_minimal_params_approve_flow(self):
        self.login_as(self.user)

        resp = self.client.get(
            f"{self.path}?response_type=code&client_id={self.application.client_id}"
        )

        assert resp.status_code == 200
        self.assertTemplateUsed("sentry/oauth-authorize.html")
        assert resp.context["application"] == self.application

        resp = self.client.post(self.path, {"op": "approve"})

        grant = ApiGrant.objects.get(user=self.user)
        assert grant.redirect_uri == self.application.get_default_redirect_uri()
        assert grant.application == self.application
        assert not grant.get_scopes()

        assert resp.status_code == 302
        assert resp["Location"] == f"https://example.com?code={grant.code}"

        authorization = ApiAuthorization.objects.get(user=self.user, application=self.application)
        assert authorization.get_scopes() == grant.get_scopes()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_authorize.py" startline="115" endline="142" pcid="9296">
    def test_rich_params(self):
        self.login_as(self.user)

        resp = self.client.get(
            f"{self.path}?response_type=code&client_id={self.application.client_id}&scope=org%3Aread&state=foo"
        )

        assert resp.status_code == 200
        self.assertTemplateUsed("sentry/oauth-authorize.html")
        assert resp.context["application"] == self.application

        resp = self.client.post(self.path, {"op": "approve"})

        grant = ApiGrant.objects.get(user=self.user)
        assert grant.redirect_uri == self.application.get_default_redirect_uri()
        assert grant.application == self.application
        assert grant.get_scopes() == ["org:read"]

        assert resp.status_code == 302

        # XXX: Compare parsed query strings to avoid ordering differences
        # between py2/3
        assert parse_qs(urlparse(resp["Location"]).query) == parse_qs(
            f"state=foo&code={grant.code}"
        )

        assert not ApiToken.objects.filter(user=self.user).exists()

</source>
</class>

<class classid="328" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_authorize.py" startline="96" endline="114" pcid="9295">
    def test_minimal_params_deny_flow(self):
        self.login_as(self.user)

        resp = self.client.get(
            f"{self.path}?response_type=code&client_id={self.application.client_id}"
        )

        assert resp.status_code == 200
        self.assertTemplateUsed("sentry/oauth-authorize.html")
        assert resp.context["application"] == self.application

        resp = self.client.post(self.path, {"op": "deny"})

        assert resp.status_code == 302
        assert resp["Location"] == "https://example.com?error=access_denied"

        assert not ApiGrant.objects.filter(user=self.user).exists()
        assert not ApiToken.objects.filter(user=self.user).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_oauth_authorize.py" startline="324" endline="343" pcid="9309">
    def test_minimal_params_code_deny_flow(self):
        self.login_as(self.user)

        resp = self.client.get(
            f"{self.path}?response_type=token&client_id={self.application.client_id}"
        )

        assert resp.status_code == 200
        self.assertTemplateUsed("sentry/oauth-authorize.html")
        assert resp.context["application"] == self.application

        resp = self.client.post(self.path, {"op": "deny"})

        assert resp.status_code == 302
        location, fragment = resp["Location"].split("#", 1)
        assert location == "https://example.com"
        fragment = parse_qs(fragment)
        assert fragment == {"error": ["access_denied"]}

        assert not ApiToken.objects.filter(user=self.user).exists()
</source>
</class>

<class classid="329" nclones="3" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_error_page_embed.py" startline="195" endline="207" pcid="9452">
    def make_event(self, **kwargs):
        min_ago = iso_format(before_now(minutes=1))
        result = {
            "event_id": "a" * 32,
            "message": "foo",
            "timestamp": min_ago,
            "level": logging.ERROR,
            "logger": "default",
            "tags": [],
        }
        result.update(kwargs)
        return self.store_event(data=result, project_id=self.project.id, assert_no_errors=False)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1872" endline="1883" pcid="9630">
    def make_event(self, **kwargs):
        result = {
            "event_id": "a" * 32,
            "message": "foo",
            "timestamp": self.timestamp + 0.23,
            "level": logging.ERROR,
            "logger": "default",
            "tags": [],
        }
        result.update(kwargs)
        return result

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_normalization.py" startline="11" endline="23" pcid="9536">
def make_event(**kwargs):
    result = {
        "event_id": "a" * 32,
        "message": "foo",
        "timestamp": int(datetime.now().strftime("%s")),
        "level": logging.ERROR,
        "logger": "default",
        "tags": [],
    }
    result.update(kwargs)
    return result


</source>
</class>

<class classid="330" nclones="2" nlines="10" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_error_page_embed.py" startline="208" endline="219" pcid="9453">
    def test_environment_gets_user_report(self):
        self.make_event(environment=self.environment.name, event_id=self.event_id)
        self.login_as(user=self.user)
        response = self.client.post(
            self.path,
            {"name": "Jane Bloggs", "email": "jane@example.com", "comments": "This is an example!"},
            HTTP_REFERER="http://example.com",
        )

        assert response.status_code == 200, response.content
        assert UserReport.objects.get(event_id=self.event_id).environment_id == self.environment.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/frontend/test_error_page_embed.py" startline="220" endline="229" pcid="9454">
    def test_user_report_gets_environment(self):
        self.login_as(user=self.user)
        response = self.client.post(
            self.path,
            {"name": "Jane Bloggs", "email": "jane@example.com", "comments": "This is an example!"},
            HTTP_REFERER="http://example.com",
        )
        self.make_event(environment=self.environment.name, event_id=self.event_id)
        assert response.status_code == 200, response.content
        assert UserReport.objects.get(event_id=self.event_id).environment_id == self.environment.id
</source>
</class>

<class classid="331" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/web/api/tests.py" startline="82" endline="94" pcid="9473">
    def test_authenticated(self):
        user = self.create_user("foo@example.com")
        self.login_as(user)

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert resp["Content-Type"] == "application/json"

        data = json.loads(resp.content)
        assert data["isAuthenticated"]
        assert data["user"]
        assert data["user"]["email"] == user.email

</source>
<source file="systems/sentry-22.2.0/tests/sentry/web/api/tests.py" startline="95" endline="107" pcid="9474">
    def test_superuser(self):
        user = self.create_user("foo@example.com", is_superuser=True)
        self.login_as(user, superuser=True)

        resp = self.client.get(self.path)
        assert resp.status_code == 200
        assert resp["Content-Type"] == "application/json"

        data = json.loads(resp.content)
        assert data["isAuthenticated"]
        assert data["user"]
        assert data["user"]["email"] == user.email
        assert data["user"]["isSuperuser"]
</source>
</class>

<class classid="332" nclones="2" nlines="15" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="174" endline="193" pcid="9563">
    def test_applies_background_grouping(self, mock_calc_grouping):
        timestamp = time() - 300
        manager = EventManager(
            make_event(message="foo 123", event_id="a" * 32, timestamp=timestamp)
        )
        manager.normalize()
        manager.save(self.project.id)

        assert mock_calc_grouping.call_count == 0

        with self.options(
            {
                "store.background-grouping-config-id": "mobile:2021-02-12",
                "store.background-grouping-sample-rate": 1.0,
            }
        ):
            manager.save(self.project.id)

        assert mock_calc_grouping.call_count == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="195" endline="217" pcid="9564">
    def test_background_grouping_sample_rate(self, mock_calc_grouping):

        timestamp = time() - 300
        manager = EventManager(
            make_event(message="foo 123", event_id="a" * 32, timestamp=timestamp)
        )
        manager.normalize()
        manager.save(self.project.id)

        assert mock_calc_grouping.call_count == 0

        with self.options(
            {
                "store.background-grouping-config-id": "mobile:2021-02-12",
                "store.background-grouping-sample-rate": 0.0,
            }
        ):
            manager.save(self.project.id)

        manager.save(self.project.id)

        assert mock_calc_grouping.call_count == 0

</source>
</class>

<class classid="333" nclones="2" nlines="36" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="379" endline="432" pcid="9570">
    def test_that_release_in_latest_activity_prior_to_regression_is_not_overridden(
        self, plugin_is_regression, mock_send_activity_notifications_delay
    ):
        """
        Test that ensures in the case where a regression occurs, the release prior to the latest
        activity to that regression is not overridden.
        It should only be overridden if the activity was awaiting the upcoming release
        """
        plugin_is_regression.return_value = True

        # Create a release and a group associated with it
        old_release = self.create_release(
            version="foobar", date_added=timezone.now() - timedelta(minutes=30)
        )
        manager = EventManager(
            make_event(
                event_id="a" * 32,
                checksum="a" * 32,
                timestamp=time() - 50000,  # need to work around active_at
                release=old_release.version,
            )
        )
        event = manager.save(1)
        group = event.group
        group.update(status=GroupStatus.RESOLVED)

        # Resolve the group in old_release
        resolution = GroupResolution.objects.create(release=old_release, group=group)
        activity = Activity.objects.create(
            group=group,
            project=group.project,
            type=Activity.SET_RESOLVED_IN_RELEASE,
            ident=resolution.id,
            data={"version": "foobar"},
        )

        # Create a regression
        manager = EventManager(
            make_event(event_id="c" * 32, checksum="a" * 32, timestamp=time(), release="b")
        )
        event = manager.save(1)
        assert event.group_id == group.id

        group = Group.objects.get(id=group.id)
        assert group.status == GroupStatus.UNRESOLVED

        activity = Activity.objects.get(id=activity.id)
        assert activity.data["version"] == "foobar"

        regressed_activity = Activity.objects.get(group=group, type=Activity.SET_REGRESSION)
        assert regressed_activity.data["version"] == "b"

        mock_send_activity_notifications_delay.assert_called_once_with(regressed_activity.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="435" endline="489" pcid="9571">
    def test_current_release_version_in_latest_activity_prior_to_regression_is_not_overridden(
        self, plugin_is_regression, mock_send_activity_notifications_delay
    ):
        """
        Test that ensures in the case where a regression occurs, the release prior to the latest
        activity to that regression is overridden with the release regression occurred in but the
        value of `current_release_version` used for semver is not lost in the update.
        """
        plugin_is_regression.return_value = True

        # Create a release and a group associated with it
        old_release = self.create_release(
            version="a", date_added=timezone.now() - timedelta(minutes=30)
        )
        manager = EventManager(
            make_event(
                event_id="a" * 32,
                checksum="a" * 32,
                timestamp=time() - 50000,  # need to work around active_at
                release=old_release.version,
            )
        )
        event = manager.save(1)
        group = event.group
        group.update(status=GroupStatus.RESOLVED)

        # Resolve the group in old_release
        resolution = GroupResolution.objects.create(release=old_release, group=group)
        activity = Activity.objects.create(
            group=group,
            project=group.project,
            type=Activity.SET_RESOLVED_IN_RELEASE,
            ident=resolution.id,
            data={"version": "", "current_release_version": "pre foobar"},
        )

        # Create a regression
        manager = EventManager(
            make_event(event_id="c" * 32, checksum="a" * 32, timestamp=time(), release="b")
        )
        event = manager.save(1)
        assert event.group_id == group.id

        group = Group.objects.get(id=group.id)
        assert group.status == GroupStatus.UNRESOLVED

        activity = Activity.objects.get(id=activity.id)
        assert activity.data["version"] == "b"
        assert activity.data["current_release_version"] == "pre foobar"

        regressed_activity = Activity.objects.get(group=group, type=Activity.SET_REGRESSION)
        assert regressed_activity.data["version"] == "b"

        mock_send_activity_notifications_delay.assert_called_once_with(regressed_activity.id)

</source>
</class>

<class classid="334" nclones="2" nlines="28" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="671" endline="705" pcid="9575">
    def test_does_not_mark_as_unresolved_with_pending_commit(
        self, plugin_is_regression, mock_send_activity_notifications_delay
    ):
        plugin_is_regression.return_value = True

        repo = self.create_repo(project=self.project)
        commit = self.create_commit(repo=repo)

        manager = EventManager(
            make_event(
                event_id="a" * 32,
                checksum="a" * 32,
                timestamp=time() - 50000,  # need to work around active_at
            )
        )
        event = manager.save(self.project.id)

        group = event.group

        group.update(status=GroupStatus.RESOLVED)
        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_id=commit.id,
            linked_type=GroupLink.LinkedType.commit,
            relationship=GroupLink.Relationship.resolves,
        )

        manager = EventManager(make_event(event_id="b" * 32, checksum="a" * 32, timestamp=time()))
        event = manager.save(self.project.id)
        assert event.group_id == group.id

        group = Group.objects.get(id=group.id)
        assert group.status == GroupStatus.RESOLVED

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="708" endline="745" pcid="9576">
    def test_mark_as_unresolved_with_released_commit(
        self, plugin_is_regression, mock_send_activity_notifications_delay
    ):
        plugin_is_regression.return_value = True

        release = self.create_release(project=self.project)
        repo = self.create_repo(project=self.project)
        commit = self.create_commit(repo=repo, release=release, project=self.project)

        manager = EventManager(
            make_event(
                event_id="a" * 32,
                checksum="a" * 32,
                timestamp=time() - 50000,  # need to work around active_at
            )
        )
        event = manager.save(self.project.id)

        group = event.group

        group.update(status=GroupStatus.RESOLVED)

        GroupLink.objects.create(
            group_id=group.id,
            project_id=group.project_id,
            linked_id=commit.id,
            linked_type=GroupLink.LinkedType.commit,
            relationship=GroupLink.Relationship.resolves,
        )

        manager = EventManager(make_event(event_id="b" * 32, checksum="a" * 32, timestamp=time()))

        event = manager.save(self.project.id)
        assert event.group_id == group.id

        group = Group.objects.get(id=group.id)
        assert group.status == GroupStatus.UNRESOLVED

</source>
</class>

<class classid="335" nclones="3" nlines="30" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="785" endline="825" pcid="9581">
    def test_culprit_after_stacktrace_processing(self):
        from sentry.grouping.enhancer import Enhancements

        enhancement = Enhancements.from_config_string(
            """
            function:in_app_function +app
            function:not_in_app_function -app
            """,
        )

        manager = EventManager(
            make_event(
                platform="native",
                exception={
                    "values": [
                        {
                            "type": "Hello",
                            "stacktrace": {
                                "frames": [
                                    {
                                        "function": "not_in_app_function",
                                    },
                                    {
                                        "function": "in_app_function",
                                    },
                                ]
                            },
                        }
                    ]
                },
            )
        )
        manager.normalize()
        manager.get_data()["grouping_config"] = {
            "enhancements": enhancement.dumps(),
            "id": "legacy:2019-03-12",
        }
        event1 = manager.save(1)
        assert event1.transaction is None
        assert event1.culprit == "in_app_function"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1750" endline="1799" pcid="9626">
    def test_category_match_group(self):
        """
        Regression test to ensure categories are applied consistently and don't
        produce hash mismatches.
        """
        from sentry.grouping.enhancer import Enhancements

        enhancement = Enhancements.from_config_string(
            """
            function:foo category=foo_like
            category:foo_like -group
            """,
        )

        event = make_event(
            platform="native",
            exception={
                "values": [
                    {
                        "type": "Hello",
                        "stacktrace": {
                            "frames": [
                                {
                                    "function": "foo",
                                },
                                {
                                    "function": "bar",
                                },
                            ]
                        },
                    }
                ]
            },
        )

        manager = EventManager(event)
        manager.normalize()

        grouping_config = {
            "enhancements": enhancement.dumps(),
            "id": "mobile:2021-02-12",
        }

        manager.get_data()["grouping_config"] = grouping_config
        event1 = manager.save(1)

        event2 = Event(event1.project_id, event1.event_id, data=event1.data)

        assert event1.get_hashes().hashes == event2.get_hashes(grouping_config).hashes

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1800" endline="1833" pcid="9627">
    def test_write_none_tree_labels(self):
        """Write tree labels even if None"""

        event = make_event(
            platform="native",
            exception={
                "values": [
                    {
                        "type": "Hello",
                        "stacktrace": {
                            "frames": [
                                {
                                    "function": "<redacted>",
                                },
                                {
                                    "function": "<redacted>",
                                },
                            ]
                        },
                    }
                ]
            },
        )

        manager = EventManager(event)
        manager.normalize()

        manager.get_data()["grouping_config"] = {
            "id": "mobile:2021-02-12",
        }
        event = manager.save(1)

        assert event.data["hierarchical_tree_labels"] == [None]

</source>
</class>

<class classid="336" nclones="3" nlines="10" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1303" endline="1314" pcid="9608">
    def test_sdk(self):
        manager = EventManager(make_event(**{"sdk": {"name": "sentry-unity", "version": "1.0"}}))
        manager.normalize()
        event = manager.save(self.project.id)

        assert event.data["sdk"] == {
            "name": "sentry-unity",
            "version": "1.0",
            "integrations": None,
            "packages": None,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1378" endline="1389" pcid="9615">
    def test_message_attribute_interface_both_strings(self):
        manager = EventManager(
            make_event(**{"logentry": "a plain string", "message": "another string"})
        )
        manager.normalize()
        event = manager.save(self.project.id)
        assert event.data["logentry"] == {
            "formatted": "a plain string",
            "message": None,
            "params": None,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1365" endline="1377" pcid="9614">
    def test_message_attribute_shadowing(self):
        # Logentry shadows the legacy message attribute.
        manager = EventManager(
            make_event(**{"message": "world hello", "logentry": {"message": "hello world"}})
        )
        manager.normalize()
        event = manager.save(self.project.id)
        assert event.data["logentry"] == {
            "formatted": "hello world",
            "message": None,
            "params": None,
        }

</source>
</class>

<class classid="337" nclones="2" nlines="22" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1508" endline="1535" pcid="9619">
    def test_attachment_accepted_outcomes(self):
        manager = EventManager(make_event(message="foo"), project=self.project)
        manager.normalize()

        a1 = CachedAttachment(name="a1", data=b"hello")
        a2 = CachedAttachment(name="a2", data=b"limited", rate_limited=True)
        a3 = CachedAttachment(name="a3", data=b"world")

        cache_key = cache_key_for_event(manager.get_data())
        attachment_cache.set(cache_key, attachments=[a1, a2, a3])

        mock_track_outcome = mock.Mock()
        with mock.patch("sentry.event_manager.track_outcome", mock_track_outcome):
            with self.feature("organizations:event-attachments"):
                manager.save(1, cache_key=cache_key)

        assert mock_track_outcome.call_count == 3

        for o in mock_track_outcome.mock_calls:
            assert o.kwargs["outcome"] == Outcome.ACCEPTED

        for o in mock_track_outcome.mock_calls[:2]:
            assert o.kwargs["category"] == DataCategory.ATTACHMENT
            assert o.kwargs["quantity"] == 5

        final = mock_track_outcome.mock_calls[2]
        assert final.kwargs["category"] == DataCategory.ERROR

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1536" endline="1571" pcid="9620">
    def test_attachment_filtered_outcomes(self):
        manager = EventManager(make_event(message="foo"), project=self.project)
        manager.normalize()

        # Disable storing all crash reports, which will drop the minidump but save the other
        a1 = CachedAttachment(name="a1", data=b"minidump", type="event.minidump")
        a2 = CachedAttachment(name="a2", data=b"limited", rate_limited=True)
        a3 = CachedAttachment(name="a3", data=b"world")

        cache_key = cache_key_for_event(manager.get_data())
        attachment_cache.set(cache_key, attachments=[a1, a2, a3])

        mock_track_outcome = mock.Mock()
        with mock.patch("sentry.event_manager.track_outcome", mock_track_outcome):
            with self.feature("organizations:event-attachments"):
                manager.save(1, cache_key=cache_key)

        assert mock_track_outcome.call_count == 3

        # First outcome is the rejection of the minidump
        o = mock_track_outcome.mock_calls[0]
        assert o.kwargs["outcome"] == Outcome.FILTERED
        assert o.kwargs["category"] == DataCategory.ATTACHMENT
        assert o.kwargs["reason"] == FilterStatKeys.CRASH_REPORT_LIMIT

        # Second outcome is acceptance of the "a3" attachment
        o = mock_track_outcome.mock_calls[1]
        assert o.kwargs["outcome"] == Outcome.ACCEPTED
        assert o.kwargs["category"] == DataCategory.ATTACHMENT
        assert o.kwargs["quantity"] == 5

        # Last outcome is the event
        o = mock_track_outcome.mock_calls[2]
        assert o.kwargs["outcome"] == Outcome.ACCEPTED
        assert o.kwargs["category"] == DataCategory.ERROR

</source>
</class>

<class classid="338" nclones="2" nlines="28" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1604" endline="1633" pcid="9623">
    def test_save_issueless_event(self):
        manager = EventManager(
            make_event(
                transaction="wait",
                contexts={
                    "trace": {
                        "parent_span_id": "bce14471e0e9654d",
                        "op": "foobar",
                        "trace_id": "a0fa8803753e40fd8124b21eeb2986b5",
                        "span_id": "bf5be759039ede9a",
                    }
                },
                spans=[],
                timestamp="2019-06-14T14:01:40Z",
                start_timestamp="2019-06-14T14:01:40Z",
                type="transaction",
                platform="python",
            )
        )

        event = manager.save(self.project.id)

        assert event.group is None
        assert (
            tsdb.get_sums(tsdb.models.project, [self.project.id], event.datetime, event.datetime)[
                self.project.id
            ]
            == 1
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1634" endline="1675" pcid="9624">
    def test_fingerprint_ignored(self):
        manager1 = EventManager(make_event(event_id="a" * 32, fingerprint="fingerprint1"))
        event1 = manager1.save(self.project.id)

        manager2 = EventManager(
            make_event(
                event_id="b" * 32,
                fingerprint="fingerprint1",
                transaction="wait",
                contexts={
                    "trace": {
                        "parent_span_id": "bce14471e0e9654d",
                        "op": "foobar",
                        "trace_id": "a0fa8803753e40fd8124b21eeb2986b5",
                        "span_id": "bf5be759039ede9a",
                    }
                },
                spans=[],
                timestamp="2019-06-14T14:01:40Z",
                start_timestamp="2019-06-14T14:01:40Z",
                type="transaction",
                platform="python",
            )
        )
        event2 = manager2.save(self.project.id)

        assert event1.group is not None
        assert event2.group is None
        assert (
            tsdb.get_sums(tsdb.models.project, [self.project.id], event1.datetime, event1.datetime)[
                self.project.id
            ]
            == 2
        )

        assert (
            tsdb.get_sums(tsdb.models.group, [event1.group.id], event1.datetime, event1.datetime)[
                event1.group.id
            ]
            == 1
        )

</source>
</class>

<class classid="339" nclones="3" nlines="23" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1915" endline="1940" pcid="9634">
    def test_different_groups(self):
        event1 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment1.name,
            project_id=self.project.id,
            checksum="a" * 32,
            timestamp=self.timestamp,
        )
        self.assert_release_project_environment(
            event=event1, new_issues_count=1, last_seen=self.timestamp, first_seen=self.timestamp
        )

        event2 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment1.name,
            project_id=self.project.id,
            checksum="b" * 32,
            timestamp=self.timestamp + 100,
        )
        self.assert_release_project_environment(
            event=event2,
            new_issues_count=2,
            last_seen=self.timestamp + 100,
            first_seen=self.timestamp,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1966" endline="1992" pcid="9636">
    def test_same_group_different_environment(self):
        event1 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment1.name,
            project_id=self.project.id,
            checksum="a" * 32,
            timestamp=self.timestamp,
        )
        self.assert_release_project_environment(
            event=event1, new_issues_count=1, last_seen=self.timestamp, first_seen=self.timestamp
        )
        event2 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment2.name,
            project_id=self.project.id,
            checksum="a" * 32,
            timestamp=self.timestamp + 100,
        )
        self.assert_release_project_environment(
            event=event1, new_issues_count=1, last_seen=self.timestamp, first_seen=self.timestamp
        )
        self.assert_release_project_environment(
            event=event2,
            new_issues_count=1,
            last_seen=self.timestamp + 100,
            first_seen=self.timestamp + 100,
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_event_manager.py" startline="1941" endline="1965" pcid="9635">
    def test_same_group(self):
        event1 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment1.name,
            project_id=self.project.id,
            checksum="a" * 32,
            timestamp=self.timestamp,
        )
        self.assert_release_project_environment(
            event=event1, new_issues_count=1, last_seen=self.timestamp, first_seen=self.timestamp
        )
        event2 = self.make_release_event(
            release_version=self.release.version,
            environment_name=self.environment1.name,
            project_id=self.project.id,
            checksum="a" * 32,
            timestamp=self.timestamp + 100,
        )
        self.assert_release_project_environment(
            event=event2,
            new_issues_count=1,
            last_seen=self.timestamp + 100,
            first_seen=self.timestamp,
        )

</source>
</class>

<class classid="340" nclones="2" nlines="11" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_generate_culprit.py" startline="31" endline="44" pcid="9638">
def test_with_missing_exception_stacktrace():
    data = {
        "exception": {
            "values": [
                {"stacktrace": None},
                {"stacktrace": {"frames": None}},
                {"stacktrace": {"frames": [None]}},
            ]
        },
        "request": {"url": "http://example.com"},
    }
    assert generate_culprit(data) == "http://example.com"


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/test_generate_culprit.py" startline="45" endline="57" pcid="9639">
def test_with_stacktrace_interface():
    data = {
        "stacktrace": {
            "frames": [
                {"lineno": 1, "filename": "NOTME.py"},
                {"lineno": 1, "filename": "PLZNOTME.py", "in_app": True},
            ]
        },
        "request": {"url": "http://example.com"},
    }
    assert generate_culprit(data) == "PLZNOTME.py in ?"


</source>
</class>

<class classid="341" nclones="4" nlines="21" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_debug_meta.py" startline="34" endline="62" pcid="9657">
def test_apple_behavior(make_debug_meta_snapshot):
    image_name = (
        "/var/containers/Bundle/Application/"
        "B33C37A8-F933-4B6B-9FFA-152282BFDF13/SentryTest.app/SentryTest"
    )
    make_debug_meta_snapshot(
        {
            "images": [
                {
                    "type": "apple",
                    "cpu_subtype": 0,
                    "uuid": "C05B4DDD-69A7-3840-A649-32180D341587",
                    "image_vmaddr": 4294967296,
                    "image_addr": "0x100020000",
                    "cpu_type": 16777228,
                    "image_size": 32768,
                    "name": image_name,
                }
            ],
            "sdk_info": {
                "sdk_name": "iOS",
                "version_major": 9,
                "version_minor": 3,
                "version_patchlevel": 0,
            },
        }
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_debug_meta.py" startline="93" endline="114" pcid="9659">
def test_symbolic_behavior(make_debug_meta_snapshot):
    make_debug_meta_snapshot(
        {
            "images": [
                {
                    "type": "symbolic",
                    "id": "3249d99d-0c40-4931-8610-f4e4fb0b6936-1",
                    "image_addr": 2752512,
                    "image_size": 36864,
                    "name": "C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe",
                }
            ],
            "sdk_info": {
                "sdk_name": "Windows",
                "version_major": 10,
                "version_minor": 0,
                "version_patchlevel": 14393,
            },
        }
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_debug_meta.py" startline="63" endline="92" pcid="9658">
def test_apple_behavior_with_arch(make_debug_meta_snapshot):
    image_name = (
        "/var/containers/Bundle/Application/"
        "B33C37A8-F933-4B6B-9FFA-152282BFDF13/SentryTest.app/SentryTest"
    )
    make_debug_meta_snapshot(
        {
            "images": [
                {
                    "type": "apple",
                    "arch": "x86_64",
                    "cpu_subtype": 0,
                    "uuid": "C05B4DDD-69A7-3840-A649-32180D341587",
                    "image_vmaddr": 4294967296,
                    "image_addr": "0x100020000",
                    "cpu_type": 16777228,
                    "image_size": 32768,
                    "name": image_name,
                }
            ],
            "sdk_info": {
                "sdk_name": "iOS",
                "version_major": 9,
                "version_minor": 3,
                "version_patchlevel": 0,
            },
        }
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_debug_meta.py" startline="115" endline="137" pcid="9660">
def test_symbolic_behavior_with_arch(make_debug_meta_snapshot):
    make_debug_meta_snapshot(
        {
            "images": [
                {
                    "type": "symbolic",
                    "arch": "x86",
                    "id": "3249d99d-0c40-4931-8610-f4e4fb0b6936-1",
                    "image_addr": 2752512,
                    "image_size": 36864,
                    "name": "C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe",
                }
            ],
            "sdk_info": {
                "sdk_name": "Windows",
                "version_major": 10,
                "version_minor": 0,
                "version_patchlevel": 14393,
            },
        }
    )


</source>
</class>

<class classid="342" nclones="6" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_exception.py" startline="10" endline="29" pcid="9672">
def make_exception_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(data={"exception": data})
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())

        interface = evt.interfaces.get("exception")

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "get_api_context": interface and interface.get_api_context(),
                "to_string": interface and interface.to_string(evt),
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_template.py" startline="8" endline="26" pcid="9749">
def make_template_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(data={"template": data})
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())

        interface = evt.interfaces.get("template")
        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "api_context": interface and interface.get_api_context(),
                "to_string": interface and interface.to_string(evt),
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_threads.py" startline="8" endline="25" pcid="9795">
def make_threads_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(data={"threads": data})
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())

        interface = evt.interfaces.get("threads")
        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "api_context": interface and interface.get_api_context(),
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_stacktrace.py" startline="27" endline="46" pcid="9779">
def make_stacktrace_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(data={"stacktrace": data})
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())

        interface = evt.interfaces.get("stacktrace")

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "get_stacktrace": interface and interface.get_stacktrace(evt),
                "to_string": interface and interface.to_string(evt),
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_contexts.py" startline="8" endline="25" pcid="9730">
def make_ctx_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(data={"contexts": data})
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())
        interface = evt.interfaces.get("contexts")

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface.to_json(),
                "tags": sorted(interface.iter_tags()),
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_mechanism.py" startline="9" endline="28" pcid="9763">
def make_mechanism_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(
            data={"exception": {"values": [{"type": "FooError", "mechanism": data}]}}
        )
        mgr.normalize()
        evt = eventstore.create_event(data=mgr.get_data())
        mechanism = evt.interfaces["exception"].values[0].mechanism

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": mechanism.to_json(),
                "tags": sorted(mechanism.iter_tags()),
            }
        )

    return inner


</source>
</class>

<class classid="343" nclones="4" nlines="18" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_exception.py" startline="30" endline="54" pcid="9674">
def test_basic(make_exception_snapshot):
    make_exception_snapshot(
        dict(
            values=[
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": True}]
                    },
                },
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": True}]
                    },
                },
            ]
        )
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_stacktrace.py" startline="118" endline="136" pcid="9794">
def test_get_stacktrace_with_filename_function_lineno_and_context(make_stacktrace_snapshot):
    make_stacktrace_snapshot(
        dict(
            frames=[
                {
                    "filename": "foo",
                    "function": "biz",
                    "lineno": 3,
                    "context_line": "  def foo(r):",
                },
                {
                    "filename": "bar",
                    "function": "baz",
                    "lineno": 5,
                    "context_line": "    return None",
                },
            ]
        )
    )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_exception.py" startline="119" endline="143" pcid="9680">
def test_context_with_only_system_frames(make_exception_snapshot):
    make_exception_snapshot(
        dict(
            values=[
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": False}]
                    },
                },
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": False}]
                    },
                },
            ]
        )
    )


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_exception.py" startline="69" endline="93" pcid="9678">
def test_context_with_mixed_frames(make_exception_snapshot):
    make_exception_snapshot(
        dict(
            values=[
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": True}]
                    },
                },
                {
                    "type": "ValueError",
                    "value": "hello world",
                    "module": "foo.bar",
                    "stacktrace": {
                        "frames": [{"filename": "foo/baz.py", "lineno": 1, "in_app": False}]
                    },
                },
            ]
        )
    )


</source>
</class>

<class classid="344" nclones="3" nlines="21" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_expectstaple.py" startline="8" endline="33" pcid="9722">
def make_csp_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(
            data={
                "expectstaple": data,
                "logentry": {"message": "XXX EXPECTSTAPLE MESSAGE NOT THROUGH RELAY XXX"},
            }
        )
        mgr.normalize()
        data = mgr.get_data()
        event_type = get_event_type(data)
        event_metadata = event_type.get_metadata(data)
        data.update(materialize_metadata(data, event_type, event_metadata))
        evt = eventstore.create_event(data=data)
        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": evt.interfaces.get("expectstaple").to_json(),
                "metadata": evt.get_event_metadata(),
                "title": evt.title,
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_expectct.py" startline="8" endline="36" pcid="9760">
def make_expectct_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(
            data={
                "expectct": data,
                "logentry": {"message": "XXX EXPECTCT MESSAGE NOT THROUGH RELAY XXX"},
            }
        )
        mgr.normalize()
        data = mgr.get_data()
        event_type = get_event_type(data)
        event_metadata = event_type.get_metadata(data)
        data.update(materialize_metadata(data, event_type, event_metadata))
        evt = eventstore.create_event(data=data)

        interface = evt.interfaces.get("expectct")

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "metadata": evt.get_event_metadata(),
                "title": evt.title,
            }
        )

    return inner


</source>
<source file="systems/sentry-22.2.0/tests/sentry/event_manager/interfaces/test_csp.py" startline="8" endline="32" pcid="9744">
def make_csp_snapshot(insta_snapshot):
    def inner(data):
        mgr = EventManager(
            data={"csp": data, "logentry": {"message": "XXX CSP MESSAGE NOT THROUGH RELAY XXX"}}
        )
        mgr.normalize()
        data = mgr.get_data()
        event_type = get_event_type(data)
        event_metadata = event_type.get_metadata(data)
        data.update(materialize_metadata(data, event_type, event_metadata))
        evt = eventstore.create_event(data=data)
        interface = evt.interfaces.get("csp")

        insta_snapshot(
            {
                "errors": evt.data.get("errors"),
                "to_json": interface and interface.to_json(),
                "metadata": evt.get_event_metadata(),
                "title": evt.title,
            }
        )

    return inner


</source>
</class>

<class classid="345" nclones="2" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/mail/activity/test_note.py" startline="30" endline="46" pcid="9833">
    def test_allow_self_notifications(self):
        NotificationSetting.objects.update_settings(
            ExternalProviders.EMAIL,
            NotificationSettingTypes.WORKFLOW,
            NotificationSettingOptionValues.ALWAYS,
            user=self.user,
        )
        UserOption.objects.create(user=self.user, key="self_notifications", value="1")

        participants = self.email.get_participants_with_group_subscription_reason()[
            ExternalProviders.EMAIL
        ]
        assert len(participants) == 1
        assert participants == {
            self.user: GroupSubscriptionReason.implicit,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mail/activity/test_note.py" startline="47" endline="59" pcid="9834">
    def test_disable_self_notifications(self):
        NotificationSetting.objects.update_settings(
            ExternalProviders.EMAIL,
            NotificationSettingTypes.WORKFLOW,
            NotificationSettingOptionValues.ALWAYS,
            user=self.user,
        )
        UserOption.objects.create(user=self.user, key="self_notifications", value="0")

        participants = self.email.get_participants_with_group_subscription_reason()[
            ExternalProviders.EMAIL
        ]
        assert len(participants) == 0
</source>
</class>

<class classid="346" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/test_sdk_updates.py" startline="48" endline="61" pcid="9838">
def test_enable_django_integration():
    setup = SdkSetupState(
        sdk_name="sentry.python", sdk_version="0.9.1", integrations=[], modules={"django": "1.8"}
    )
    assert list(get_suggested_updates(setup, PYTHON_INDEX_STATE)) == [
        {
            "type": "enableIntegration",
            "enables": [],
            "integrationName": "django",
            "integrationUrl": "https://docs.sentry.io/platforms/python/django/",
        }
    ]


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_sdk_updates.py" startline="62" endline="76" pcid="9839">
def test_update_sdk():
    setup = SdkSetupState(
        sdk_name="sentry.python", sdk_version="0.1.0", integrations=[], modules={}
    )
    assert list(get_suggested_updates(setup, PYTHON_INDEX_STATE)) == [
        {
            "enables": [],
            "newSdkVersion": "0.9.1",
            "sdkName": "sentry.python",
            "sdkUrl": None,
            "type": "updateSdk",
        }
    ]


</source>
</class>

<class classid="347" nclones="3" nlines="20" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/test_sdk_updates.py" startline="121" endline="147" pcid="9842">
def test_add_aspnetcore_sdk(some_dotnet_sdk):
    setup = SdkSetupState(
        sdk_name=some_dotnet_sdk,
        sdk_version="1.2.0",
        integrations=[],
        modules={
            "Sentry.Serilog": "1.2.0",
            "Microsoft.AspNetCore.Hosting": "2.2.0",
            "Serilog": "2.7.1",
        },
    )

    suggestions = list(get_suggested_updates(setup, DOTNET_INDEX_STATE))

    if some_dotnet_sdk == "sentry.dotnet.aspnetcore":
        assert not suggestions
    else:
        assert suggestions == [
            {
                "enables": [],
                "newSdkName": "sentry.dotnet.aspnetcore",
                "sdkUrl": None,
                "type": "changeSdk",
            }
        ]


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_sdk_updates.py" startline="148" endline="169" pcid="9843">
def test_add_serilog_sdk(some_dotnet_sdk):
    setup = SdkSetupState(
        sdk_name=some_dotnet_sdk,
        sdk_version="1.2.0",
        integrations=[],
        modules={"Sentry.AspNetCore": "1.2.0", "Microsoft.AspNetCore": "2.2.0", "Serilog": "2.7.1"},
    )

    suggestions = list(get_suggested_updates(setup, DOTNET_INDEX_STATE))
    if some_dotnet_sdk == "sentry.dotnet.serilog":
        assert not suggestions
    else:
        assert suggestions == [
            {
                "enables": [],
                "newSdkName": "sentry.dotnet.serilog",
                "sdkUrl": None,
                "type": "changeSdk",
            }
        ]


</source>
<source file="systems/sentry-22.2.0/tests/sentry/test_sdk_updates.py" startline="187" endline="212" pcid="9845">
def test_more_specific_dotnet_sdk(some_dotnet_sdk):
    setup = SdkSetupState(
        sdk_name=some_dotnet_sdk,
        sdk_version="1.2.0",
        integrations=[],
        modules={
            "Microsoft.AspNetCore.Hosting": "2.1.0",
            "Microsoft.Extensions.Logging.Configuration": "2.1.0",
        },
    )

    suggestions = list(get_suggested_updates(setup, DOTNET_INDEX_STATE))
    if some_dotnet_sdk == "sentry.dotnet.aspnetcore":
        assert not suggestions
    else:
        # Do not show suggestion for sentry.dotnet.extensions.logging. The user
        # has a aspnetcore application and the aspnetcore SDK instruments
        # logging too.
        assert suggestions == [
            {
                "enables": [],
                "newSdkName": "sentry.dotnet.aspnetcore",
                "sdkUrl": None,
                "type": "changeSdk",
            }
        ]
</source>
</class>

<class classid="348" nclones="2" nlines="18" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_integration.py" startline="11" endline="30" pcid="9852">
    def setUp(self):
        self.base_url = "https://api.bitbucket.org"
        self.shared_secret = "234567890"
        self.subject = "connect:1234567"
        self.integration = Integration.objects.create(
            provider="bitbucket",
            external_id=self.subject,
            name="sentryuser",
            metadata={
                "base_url": self.base_url,
                "shared_secret": self.shared_secret,
                "subject": self.subject,
            },
        )
        self.login_as(self.user)
        self.integration.add_organization(self.organization, self.user)
        self.path = reverse(
            "sentry-extensions-bitbucket-search", args=[self.organization.slug, self.integration.id]
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_search.py" startline="9" endline="29" pcid="9856">
    def setUp(self):
        self.base_url = "https://api.bitbucket.org"
        self.shared_secret = "234567890"
        self.subject = "connect:1234567"
        self.integration = Integration.objects.create(
            provider="bitbucket",
            external_id=self.subject,
            name="meredithanya",
            metadata={
                "base_url": self.base_url,
                "shared_secret": self.shared_secret,
                "subject": self.subject,
            },
        )

        self.login_as(self.user)
        self.integration.add_organization(self.organization, self.user)
        self.path = reverse(
            "sentry-extensions-bitbucket-search", args=[self.organization.slug, self.integration.id]
        )

</source>
</class>

<class classid="349" nclones="2" nlines="43" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_integration.py" startline="46" endline="92" pcid="9854">
    def test_get_repositories_exact_match(self):
        querystring = urlencode({"q": 'name="stuf"'})
        responses.add(
            responses.GET,
            f"https://api.bitbucket.org/2.0/repositories/sentryuser?{querystring}",
            json={"values": [{"full_name": "sentryuser/stuf"}]},
        )

        querystring = urlencode({"q": 'name~"stuf"'})
        responses.add(
            responses.GET,
            f"https://api.bitbucket.org/2.0/repositories/sentryuser?{querystring}",
            json={
                "values": [
                    {"full_name": "sentryuser/stuff"},
                    {"full_name": "sentryuser/stuff-2010"},
                    {"full_name": "sentryuser/stuff-2011"},
                    {"full_name": "sentryuser/stuff-2012"},
                    {"full_name": "sentryuser/stuff-2013"},
                    {"full_name": "sentryuser/stuff-2014"},
                    {"full_name": "sentryuser/stuff-2015"},
                    {"full_name": "sentryuser/stuff-2016"},
                    {"full_name": "sentryuser/stuff-2016"},
                    {"full_name": "sentryuser/stuff-2017"},
                    {"full_name": "sentryuser/stuff-2018"},
                    {"full_name": "sentryuser/stuff-2019"},
                ]
            },
        )

        installation = self.integration.get_installation(self.organization)
        result = installation.get_repositories("stuf")
        assert result == [
            {"identifier": "sentryuser/stuf", "name": "sentryuser/stuf"},
            {"identifier": "sentryuser/stuff", "name": "sentryuser/stuff"},
            {"identifier": "sentryuser/stuff-2010", "name": "sentryuser/stuff-2010"},
            {"identifier": "sentryuser/stuff-2011", "name": "sentryuser/stuff-2011"},
            {"identifier": "sentryuser/stuff-2012", "name": "sentryuser/stuff-2012"},
            {"identifier": "sentryuser/stuff-2013", "name": "sentryuser/stuff-2013"},
            {"identifier": "sentryuser/stuff-2014", "name": "sentryuser/stuff-2014"},
            {"identifier": "sentryuser/stuff-2015", "name": "sentryuser/stuff-2015"},
            {"identifier": "sentryuser/stuff-2016", "name": "sentryuser/stuff-2016"},
            {"identifier": "sentryuser/stuff-2017", "name": "sentryuser/stuff-2017"},
            {"identifier": "sentryuser/stuff-2018", "name": "sentryuser/stuff-2018"},
            {"identifier": "sentryuser/stuff-2019", "name": "sentryuser/stuff-2019"},
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_integration.py" startline="94" endline="138" pcid="9855">
    def test_get_repositories_no_exact_match(self):
        querystring = urlencode({"q": 'name~"stu"'})
        responses.add(
            responses.GET,
            f"https://api.bitbucket.org/2.0/repositories/sentryuser?{querystring}",
            json={
                "values": [
                    {"full_name": "sentryuser/stuff"},
                    {"full_name": "sentryuser/stuff-2010"},
                    {"full_name": "sentryuser/stuff-2011"},
                    {"full_name": "sentryuser/stuff-2012"},
                    {"full_name": "sentryuser/stuff-2013"},
                    {"full_name": "sentryuser/stuff-2014"},
                    {"full_name": "sentryuser/stuff-2015"},
                    {"full_name": "sentryuser/stuff-2016"},
                    {"full_name": "sentryuser/stuff-2016"},
                    {"full_name": "sentryuser/stuff-2017"},
                    {"full_name": "sentryuser/stuff-2018"},
                    {"full_name": "sentryuser/stuff-2019"},
                ]
            },
        )

        querystring = urlencode({"q": 'name="stu"'})
        responses.add(
            responses.GET,
            f"https://api.bitbucket.org/2.0/repositories/sentryuser?{querystring}",
            json={"values": []},
        )

        installation = self.integration.get_installation(self.organization)
        result = installation.get_repositories("stu")
        assert result == [
            {"identifier": "sentryuser/stuff", "name": "sentryuser/stuff"},
            {"identifier": "sentryuser/stuff-2010", "name": "sentryuser/stuff-2010"},
            {"identifier": "sentryuser/stuff-2011", "name": "sentryuser/stuff-2011"},
            {"identifier": "sentryuser/stuff-2012", "name": "sentryuser/stuff-2012"},
            {"identifier": "sentryuser/stuff-2013", "name": "sentryuser/stuff-2013"},
            {"identifier": "sentryuser/stuff-2014", "name": "sentryuser/stuff-2014"},
            {"identifier": "sentryuser/stuff-2015", "name": "sentryuser/stuff-2015"},
            {"identifier": "sentryuser/stuff-2016", "name": "sentryuser/stuff-2016"},
            {"identifier": "sentryuser/stuff-2017", "name": "sentryuser/stuff-2017"},
            {"identifier": "sentryuser/stuff-2018", "name": "sentryuser/stuff-2018"},
            {"identifier": "sentryuser/stuff-2019", "name": "sentryuser/stuff-2019"},
        ]
</source>
</class>

<class classid="350" nclones="2" nlines="18" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_search.py" startline="31" endline="52" pcid="9857">
    def test_search_issues(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/2.0/repositories/meredithanya/apples/issues",
            json={
                "values": [
                    {"id": "123", "title": "Issue Title 123"},
                    {"id": "456", "title": "Issue Title 456"},
                ]
            },
        )
        resp = self.client.get(
            self.path,
            data={"field": "externalIssue", "query": "issue", "repo": "meredithanya/apples"},
        )

        assert resp.status_code == 200
        assert resp.data == [
            {"label": "#123 Issue Title 123", "value": "123"},
            {"label": "#456 Issue Title 456", "value": "456"},
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="89" endline="107" pcid="10119">
    def test_finds_repo_results(self):
        responses.add(
            responses.GET,
            self.base_url + "/search/repositories?q=org:test%20ex",
            json={
                "items": [
                    {"name": "example", "full_name": "test/example"},
                    {"name": "exhaust", "full_name": "test/exhaust"},
                ]
            },
        )
        resp = self.client.get(self.url, data={"field": "repo", "query": "ex"})

        assert resp.status_code == 200
        assert resp.data == [
            {"value": "test/example", "label": "example"},
            {"value": "test/exhaust", "label": "exhaust"},
        ]

</source>
</class>

<class classid="351" nclones="4" nlines="13" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_issues.py" startline="95" endline="115" pcid="9874">
    def test_default_repo_link_fields(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/2.0/repositories/myaccount",
            body=b"""{
                "values": [
                    {"full_name": "myaccount/repo1"},
                    {"full_name": "myaccount/repo2"}
                ]
            }""",
            content_type="application/json",
        )
        self.org_integration.config = {
            "project_issue_defaults": {str(self.group.project_id): {"repo": "myaccount/repo1"}}
        }
        self.org_integration.save()
        installation = self.integration.get_installation(self.organization.id)
        fields = installation.get_link_issue_config(self.group)
        repo_field = [field for field in fields if field["name"] == "repo"][0]
        assert repo_field["default"] == "myaccount/repo1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_issues.py" startline="142" endline="157" pcid="9876">
    def test_default_repo_link_fields_no_repos(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/2.0/repositories/myaccount",
            body=b"""{
                "values": []
            }""",
            content_type="application/json",
        )

        installation = self.integration.get_installation(self.organization.id)
        fields = installation.get_link_issue_config(self.group)
        repo_field = [field for field in fields if field["name"] == "repo"][0]
        assert repo_field["default"] == ""
        assert repo_field["choices"] == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_issues.py" startline="159" endline="174" pcid="9877">
    def test_default_repo_create_fields_no_repos(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/2.0/repositories/myaccount",
            body=b"""{
                "values": []
            }""",
            content_type="application/json",
        )

        installation = self.integration.get_installation(self.organization.id)
        fields = installation.get_create_issue_config(self.group, self.user)
        repo_field = [field for field in fields if field["name"] == "repo"][0]
        assert repo_field["default"] == ""
        assert repo_field["choices"] == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_issues.py" startline="117" endline="140" pcid="9875">
    def test_default_repo_create_fields(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/2.0/repositories/myaccount",
            body=b"""{
                "values": [
                    {"full_name": "myaccount/repo1"},
                    {"full_name": "myaccount/repo2"}
                ]
            }""",
            content_type="application/json",
        )
        self.org_integration.config = {
            "project_issue_defaults": {str(self.group.project_id): {"repo": "myaccount/repo1"}}
        }
        self.org_integration.save()
        installation = self.integration.get_installation(self.organization.id)
        fields = installation.get_create_issue_config(self.group, self.user)
        for field in fields:
            if field["name"] == "repo":
                repo_field = field
                break
        assert repo_field["default"] == "myaccount/repo1"

</source>
</class>

<class classid="352" nclones="2" nlines="24" similarity="92">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_repository.py" startline="17" endline="40" pcid="9881">
    def setUp(self):
        super().setUp()
        self.base_url = "https://api.bitbucket.org"
        self.shared_secret = "234567890"
        self.subject = "connect:1234567"
        self.integration = Integration.objects.create(
            provider="bitbucket",
            external_id=self.subject,
            name="MyBitBucket",
            metadata={
                "base_url": self.base_url,
                "shared_secret": self.shared_secret,
                "subject": self.subject,
            },
        )
        self.integration.add_organization(self.organization, self.user)
        self.repo = Repository.objects.create(
            provider="bitbucket",
            name="sentryuser/newsdiffs",
            organization_id=self.organization.id,
            config={"name": "sentryuser/newsdiffs"},
            integration_id=self.integration.id,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_repository.py" startline="141" endline="166" pcid="9888">
    def setUp(self):
        super().setUp()
        self.base_url = "https://api.bitbucket.org"
        self.shared_secret = "234567890"
        self.subject = "connect:1234567"
        self.integration = Integration.objects.create(
            provider="bitbucket",
            external_id=self.subject,
            name="MyBitBucket",
            metadata={
                "base_url": self.base_url,
                "shared_secret": self.shared_secret,
                "subject": self.subject,
            },
        )
        self.integration.get_provider().setup()
        self.integration.add_organization(self.organization, self.user)
        self.repo = Repository.objects.create(
            provider="bitbucket",
            name="sentryuser/newsdiffs",
            organization_id=self.organization.id,
            config={"name": "sentryuser/newsdiffs"},
            integration_id=self.integration.id,
        )
        self.default_repository_config = {"full_name": "getsentry/example-repo", "id": "123"}

</source>
</class>

<class classid="353" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket/test_repository.py" startline="167" endline="178" pcid="9889">
    def add_create_repository_responses(self, repository_config):
        responses.add(
            responses.GET,
            f"{self.base_url}/2.0/repositories/{self.repo.name}",
            json=repository_config,
        )
        responses.add(
            responses.POST,
            f"{self.base_url}/2.0/repositories/{self.repo.name}/hooks",
            json={"uuid": "99"},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="58" endline="69" pcid="10396">
    def add_create_repository_responses(self, repository_config):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % self.gitlab_id,
            json=repository_config,
        )
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/%s/hooks" % self.gitlab_id,
            json={"id": 99},
        )

</source>
</class>

<class classid="354" nclones="4" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="24" endline="38" pcid="9897">
    def test_validate_url(self):
        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Enter a valid URL")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="26" endline="40" pcid="9923">
    def test_validate_url(self):
        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Enter a valid URL")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="64" endline="78" pcid="9899">
    def test_validate_consumer_key_length(self):
        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "x" * 201,
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Consumer key is limited to 200")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="66" endline="80" pcid="9925">
    def test_validate_consumer_key_length(self):
        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "x" * 201,
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Consumer key is limited to 200")

</source>
</class>

<class classid="355" nclones="8" nlines="17" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="40" endline="62" pcid="9898">
    def test_validate_private_key(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=503,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": "hot-garbage",
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(
            resp, "Private key must be a valid SSH private key encoded in a PEM format."
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="105" endline="126" pcid="9901">
    def test_authentication_request_token_fails(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=503,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "request token from Bitbucket")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="130" endline="153" pcid="9928">
    def test_authentication_request_token_redirect(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )

        # Start pipeline
        self.client.get(self.init_path)

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        redirect = "https://jira.example.com/plugins/servlet/oauth/authorize?oauth_token=abc123"
        assert redirect == resp["Location"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="107" endline="128" pcid="9927">
    def test_authentication_request_token_fails(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=503,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "request token from Jira")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="42" endline="64" pcid="9924">
    def test_validate_private_key(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=503,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": "hot-garbage",
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(
            resp, "Private key must be a valid SSH private key encoded in a PEM format."
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="82" endline="105" pcid="9926">
    def test_authentication_request_token_timeout(self):
        timeout = ReadTimeout("Read timed out. (read timeout=30)")
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            body=timeout,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "request token from Jira")
        self.assertContains(resp, "Timed out")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="128" endline="153" pcid="9902">
    def test_authentication_request_token_redirect(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )

        # Start pipeline
        self.client.get(self.init_path)

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        redirect = (
            "https://bitbucket.example.com/plugins/servlet/oauth/authorize?oauth_token=abc123"
        )
        assert redirect == resp["Location"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="80" endline="103" pcid="9900">
    def test_authentication_request_token_timeout(self):
        timeout = ReadTimeout("Read timed out. (read timeout=30)")
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            body=timeout,
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "request token from Bitbucket")
        self.assertContains(resp, "Timed out")

</source>
</class>

<class classid="356" nclones="2" nlines="30" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="155" endline="190" pcid="9903">
    def test_authentication_access_token_failure(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/access-token",
            status=500,
            content_type="text/plain",
            body="<html>it broke</html>",
        )

        # Get config page
        resp = self.client.get(self.init_path)
        assert resp.status_code == 200

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        assert resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "access token from Bitbucket")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="155" endline="190" pcid="9929">
    def test_authentication_access_token_failure(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=500,
            content_type="text/plain",
            body="<html>it broke</html>",
        )

        # Get config page
        resp = self.client.get(self.init_path)
        assert resp.status_code == 200

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        assert resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200
        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "access token from Jira")

</source>
</class>

<class classid="357" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="191" endline="211" pcid="9904">
    def install_integration(self):
        # Get config page
        resp = self.client.get(self.setup_path)
        assert resp.status_code == 200

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        assert resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200

        return resp

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="191" endline="211" pcid="9930">
    def install_integration(self):
        # Get config page
        resp = self.client.get(self.setup_path)
        assert resp.status_code == 200

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "sentry-bot",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        assert resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200

        return resp

</source>
</class>

<class classid="358" nclones="4" nlines="21" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="213" endline="235" pcid="9905">
    def test_authentication_verifier_expired(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/access-token",
            status=404,
            content_type="text/plain",
            body="oauth_error=token+expired",
        )

        # Try getting the token but it has expired for some reason,
        # perhaps a stale reload/history navigate.
        resp = self.install_integration()

        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "access token from Bitbucket")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="371" endline="397" pcid="9936">
    def test_setup_create_webhook_failure(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/rest/webhooks/1.0/webhook",
            status=502,
            body="Bad things",
        )

        resp = self.install_integration()
        self.assertContains(resp, "webhook")

        assert Integration.objects.count() == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="213" endline="235" pcid="9931">
    def test_authentication_verifier_expired(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=404,
            content_type="text/plain",
            body="oauth_error=token+expired",
        )

        # Try getting the token but it has expired for some reason,
        # perhaps a stale reload/history navigate.
        resp = self.install_integration()

        self.assertContains(resp, "Setup Error")
        self.assertContains(resp, "access token from Jira")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="399" endline="430" pcid="9937">
    def test_setup_create_webhook_failure_forbidden(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/rest/webhooks/1.0/webhook",
            status=403,
            json={
                "messages": [
                    {"key": "You do not have permission to create WebHook 'Sentry Issue Sync'."}
                ]
            },
        )

        resp = self.install_integration()
        self.assertContains(resp, "You do not have permission to create")
        self.assertContains(resp, "Could not create issue webhook")

        assert Integration.objects.count() == 0

</source>
</class>

<class classid="359" nclones="2" nlines="38" similarity="97">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="237" endline="280" pcid="9906">
    def test_authentication_success(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/rest/webhooks/1.0/webhook",
            status=204,
            body="",
        )

        self.install_integration()

        integration = Integration.objects.get()
        assert integration.name == "sentry-bot"
        assert integration.metadata["domain_name"] == "bitbucket.example.com"
        assert integration.metadata["base_url"] == "https://bitbucket.example.com"
        assert integration.metadata["verify_ssl"] is False

        org_integration = OrganizationIntegration.objects.get(
            integration=integration, organization=self.organization
        )
        assert org_integration.config == {}

        idp = IdentityProvider.objects.get(type="bitbucket_server")
        identity = Identity.objects.get(
            idp=idp, user=self.user, external_id="bitbucket.example.com:sentry-bot"
        )
        assert identity.data["consumer_key"] == "sentry-bot"
        assert identity.data["access_token"] == "valid-token"
        assert identity.data["access_token_secret"] == "valid-secret"
        assert identity.data["private_key"] == EXAMPLE_PRIVATE_KEY

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="237" endline="281" pcid="9932">
    def test_authentication_success(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/rest/webhooks/1.0/webhook",
            status=204,
            body="",
        )

        self.install_integration()

        integration = Integration.objects.get()
        assert integration.name == "sentry-bot"
        assert integration.metadata["domain_name"] == "jira.example.com"
        assert integration.metadata["base_url"] == "https://jira.example.com"
        assert integration.metadata["verify_ssl"] is False
        assert integration.metadata["webhook_secret"]

        org_integration = OrganizationIntegration.objects.get(
            integration=integration, organization=self.organization
        )
        assert org_integration.config == {}

        idp = IdentityProvider.objects.get(type="jira_server")
        identity = Identity.objects.get(
            idp=idp, user=self.user, external_id="jira.example.com:sentry-bot"
        )
        assert identity.data["consumer_key"] == "sentry-bot"
        assert identity.data["access_token"] == "valid-token"
        assert identity.data["access_token_secret"] == "valid-secret"
        assert identity.data["private_key"] == EXAMPLE_PRIVATE_KEY

</source>
</class>

<class classid="360" nclones="2" nlines="39" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/bitbucket_server/test_integration.py" startline="282" endline="328" pcid="9907">
    def test_setup_external_id_length(self):
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://bitbucket.example.com/rest/webhooks/1.0/webhook",
            status=204,
            body="",
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://bitbucket.example.com/",
            "verify_ssl": False,
            "consumer_key": "a-very-long-consumer-key-that-when-combined-with-host-would-overflow",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        redirect = (
            "https://bitbucket.example.com/plugins/servlet/oauth/authorize?oauth_token=abc123"
        )
        assert redirect == resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200

        integration = Integration.objects.get(provider="bitbucket_server")
        assert (
            integration.external_id
            == "bitbucket.example.com:a-very-long-consumer-key-that-when-combine"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_integration.py" startline="324" endline="369" pcid="9935">
    def test_setup_external_id_length(self):
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/request-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=abc123&oauth_token_secret=def456",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/plugins/servlet/oauth/access-token",
            status=200,
            content_type="text/plain",
            body="oauth_token=valid-token&oauth_token_secret=valid-secret",
        )
        responses.add(
            responses.POST,
            "https://jira.example.com/rest/webhooks/1.0/webhook",
            status=204,
            body="",
        )

        # Start pipeline and go to setup page.
        self.client.get(self.setup_path)

        # Submit credentials
        data = {
            "url": "https://jira.example.com/",
            "verify_ssl": False,
            "consumer_key": "a-very-long-consumer-key-that-when-combined-with-host-would-overflow",
            "private_key": EXAMPLE_PRIVATE_KEY,
        }
        resp = self.client.post(self.setup_path, data=data)
        assert resp.status_code == 302
        redirect = "https://jira.example.com/plugins/servlet/oauth/authorize?oauth_token=abc123"
        assert redirect == resp["Location"]

        resp = self.client.get(self.setup_path + "?oauth_token=xyz789")
        assert resp.status_code == 200

        integration = Integration.objects.get(provider="jira_server")
        assert (
            integration.external_id
            == "jira.example.com:a-very-long-consumer-key-that-when-combined-wit"
        )

</source>
</class>

<class classid="361" nclones="6" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_ticket_rules.py" startline="25" endline="42" pcid="9917">
    def setUp(self):
        super().setUp()
        self.project_name = "Jira Cloud"
        self.integration = Integration.objects.create(
            provider="jira",
            name=self.project_name,
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        self.integration.add_organization(self.organization, self.user)
        self.installation = self.integration.get_installation(self.organization.id)

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_webhooks.py" startline="14" endline="28" pcid="10243">
    def setUp(self):
        super().setUp()
        self.integration = Integration.objects.create(
            provider="jira",
            name="Example Jira",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        self.integration.add_organization(self.organization, self.user)
        self.path = reverse("sentry-extensions-jira-issue-updated")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_notify_action.py" startline="17" endline="30" pcid="10197">
    def setUp(self):
        self.integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        self.integration.add_organization(self.organization, self.user)
        self.installation = self.integration.get_installation(self.organization.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="14" endline="27" pcid="10252">
    def integration(self):
        integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        integration.add_organization(self.organization, self.user)
        return integration

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="34" endline="47" pcid="10216">
    def integration(self):
        integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        integration.add_organization(self.organization, self.user)
        return integration

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_client.py" startline="20" endline="34" pcid="10272">
    def setUp(self):
        integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        integration.add_organization(self.organization, self.user)
        install = integration.get_installation(self.organization.id)
        self.client = install.get_client()

</source>
</class>

<class classid="362" nclones="2" nlines="35" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_ticket_rules.py" startline="57" endline="113" pcid="9920">
    def test_ticket_rules(self):
        with mock.patch(
            "sentry.integrations.jira.integration.JiraIntegration.get_client", self.get_client
        ):
            # Create a new Rule
            response = self.client.post(
                reverse(
                    "sentry-api-0-project-rules",
                    kwargs={
                        "organization_slug": self.organization.slug,
                        "project_slug": self.project.slug,
                    },
                ),
                format="json",
                data={
                    "name": "hello world",
                    "owner": self.user.id,
                    "environment": None,
                    "actionMatch": "any",
                    "frequency": 5,
                    "actions": [
                        {
                            "id": "sentry.integrations.jira.notify_action.JiraCreateTicketAction",
                            "integration": self.integration.id,
                            "dynamic_form_fields": [{"name": "project"}],
                            "issuetype": "1",
                            "name": "Create a Jira ticket in the Jira Cloud account",
                            "project": "10000",
                        }
                    ],
                    "conditions": [],
                },
            )
            assert response.status_code == 200

            # Get the rule from DB
            rule_object = Rule.objects.get(id=response.data["id"])
            event = self.get_event()

            # Trigger its `after`
            self.trigger(event, rule_object)

            # assert ticket created in DB
            key = self.get_key(event)
            external_issue_count = len(ExternalIssue.objects.filter(key=key))
            assert external_issue_count == 1

            # assert ticket created on jira
            data = self.installation.get_issue(key)
            assert event.message in data["description"]

            # Trigger its `after` _again_
            self.trigger(event, rule_object)

            # assert new ticket NOT created in DB
            assert ExternalIssue.objects.count() == external_issue_count

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_ticket_rules.py" startline="114" endline="148" pcid="9921">
    def test_fails_validation(self):
        """
        Test that the absence of dynamic_form_fields in the action fails validation
        """
        with mock.patch(
            "sentry.integrations.jira.integration.JiraIntegration.get_client", self.get_client
        ):
            # Create a new Rule
            response = self.client.post(
                reverse(
                    "sentry-api-0-project-rules",
                    kwargs={
                        "organization_slug": self.organization.slug,
                        "project_slug": self.project.slug,
                    },
                ),
                format="json",
                data={
                    "name": "hello world",
                    "environment": None,
                    "actionMatch": "any",
                    "frequency": 5,
                    "actions": [
                        {
                            "id": "sentry.integrations.jira.notify_action.JiraCreateTicketAction",
                            "integration": self.integration.id,
                            "issuetype": "1",
                            "name": "Create a Jira ticket in the Jira Cloud account",
                            "project": "10000",
                        }
                    ],
                    "conditions": [],
                },
            )
            assert response.status_code == 400
</source>
</class>

<class classid="363" nclones="6" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_search.py" startline="18" endline="34" pcid="9950">
    def test_get_success_text_search(self):
        org = self.organization
        integration = self.integration
        responses.add(
            responses.GET,
            'https://jira.example.org/rest/api/2/search/?jql=text ~ "test"',
            body=EXAMPLE_ISSUE_SEARCH,
            content_type="json",
        )

        self.login_as(self.user)
        path = reverse("sentry-extensions-jiraserver-search", args=[org.slug, integration.id])
        resp = self.client.get(f"{path}?field=externalIssue&query=test")

        assert resp.status_code == 200
        assert resp.data == [{"label": "(HSP-1) this is a test issue summary", "value": "HSP-1"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_search.py" startline="54" endline="69" pcid="9952">
    def test_get_network_error(self):
        org = self.organization
        integration = self.integration
        responses.add(
            responses.GET,
            'https://jira.example.org/rest/api/2/search/?jql=id="HSP-1"',
            status=502,
            body="<p>We are down</p>",
        )

        self.login_as(self.user)
        path = reverse("sentry-extensions-jiraserver-search", args=[org.slug, integration.id])
        resp = self.client.get(f"{path}?field=externalIssue&query=HSP-1")

        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="29" endline="45" pcid="10253">
    def test_issue_search_text(self):
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/search/",
            body=StubService.get_stub_json("jira", "search_response.json"),
            content_type="json",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?field=externalIssue&query=test")
        assert resp.status_code == 200
        assert resp.data == [{"label": "(HSP-1) this is a test issue summary", "value": "HSP-1"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_search.py" startline="36" endline="52" pcid="9951">
    def test_get_success_id_search(self):
        org = self.organization
        integration = self.integration
        responses.add(
            responses.GET,
            'https://jira.example.org/rest/api/2/search/?jql=id="HSP-1"',
            body=EXAMPLE_ISSUE_SEARCH,
            content_type="json",
        )

        self.login_as(self.user)
        path = reverse("sentry-extensions-jiraserver-search", args=[org.slug, integration.id])
        resp = self.client.get(f"{path}?field=externalIssue&query=HSP-1")

        assert resp.status_code == 200
        assert resp.data == [{"label": "(HSP-1) this is a test issue summary", "value": "HSP-1"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="174" endline="191" pcid="10262">
    def test_customfield_search_error(self):
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/jql/autocompletedata/suggestions",
            status=500,
            body="Totally broken",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?field=customfield_0123&query=sp")
        assert resp.status_code == 400
        assert resp.data == {
            "detail": "Unable to fetch autocomplete for customfield_0123 from Jira"
        }
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="74" endline="93" pcid="10256">
    def test_issue_search_error(self):
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/search/",
            status=500,
            body="Totally broken",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        for field in ("externalIssue", "parent"):
            resp = self.client.get(f"{path}?field={field}&query=test")
            assert resp.status_code == 400
            assert resp.data == {
                "detail": "Error Communicating with Jira (HTTP 500): unknown error"
            }

</source>
</class>

<class classid="364" nclones="6" nlines="22" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_search.py" startline="80" endline="109" pcid="9954">
    def test_assignee_search(self):
        responses.add(
            responses.GET,
            "https://jira.example.org/rest/api/2/project",
            json=[{"key": "HSP", "id": "10000"}],
            match_querystring=False,
        )

        def responder(request):
            query = parse_qs(urlparse(request.url).query)
            assert "HSP" == query["project"][0]
            assert "bob" == query["username"][0]
            return (200, {}, EXAMPLE_USER_SEARCH_RESPONSE)

        responses.add_callback(
            responses.GET,
            "https://jira.example.org/rest/api/2/user/assignable/search",
            callback=responder,
            content_type="json",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jiraserver-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?project=10000&field=assignee&query=bob")
        assert resp.status_code == 200
        assert resp.data == [{"value": "bob", "label": "Bobby - bob@example.org (bob)"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira_server/test_search.py" startline="111" endline="131" pcid="9956">
    def test_assignee_search_error(self):
        responses.add(
            responses.GET,
            "https://jira.example.org/rest/api/2/project",
            json=[{"key": "HSP", "id": "10000"}],
            match_querystring=False,
        )
        responses.add(
            responses.GET,
            "https://jira.example.org/rest/api/2/user/assignable/search",
            status=500,
            body="Bad things",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jiraserver-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?project=10000&field=assignee&query=bob")
        assert resp.status_code == 400
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="127" endline="148" pcid="10259">
    def test_assignee_search_error(self):
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/project",
            json=[{"key": "HSP", "id": "10000"}],
            match_querystring=False,
        )
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/user/assignable/search",
            status=500,
            body="Bad things",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?project=10000&field=assignee&query=bob")
        assert resp.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="150" endline="172" pcid="10260">
    def test_customfield_search(self):
        def responder(request):
            query = parse_qs(urlparse(request.url).query)
            assert "cf[0123]" == query["fieldName"][0]
            assert "sp" == query["fieldValue"][0]
            return 200, {}, '{"results": [{"displayName": "<b>Sp</b>rint 1 (1)", "value": "1"}]}'

        responses.add_callback(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/jql/autocompletedata/suggestions",
            callback=responder,
            content_type="application/json",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?field=customfield_0123&query=sp")
        assert resp.status_code == 200
        assert resp.data == [{"label": "Sprint 1 (1)", "value": "1"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="95" endline="125" pcid="10257">
    def test_assignee_search(self):
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/project",
            json=[{"key": "HSP", "id": "10000"}],
            match_querystring=False,
        )

        def responder(request):
            query = parse_qs(urlparse(request.url).query)
            assert "HSP" == query["project"][0]
            assert "bob" == query["query"][0]
            data = StubService.get_stub_json("jira", "user_search_response.json")
            return 200, {}, data

        responses.add_callback(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/user/assignable/search",
            callback=responder,
            content_type="json",
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        resp = self.client.get(f"{path}?project=10000&field=assignee&query=bob")
        assert resp.status_code == 200
        assert resp.data == [{"value": "deadbeef123", "label": "Bobby - bob@example.org"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="47" endline="72" pcid="10254">
    def test_issue_search_id(self):
        def responder(request):
            query = parse_qs(urlparse(request.url).query)
            assert 'id="hsp-1"' == query["jql"][0]
            data = StubService.get_stub_json("jira", "search_response.json")
            return 200, {}, data

        responses.add_callback(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/search/",
            callback=responder,
            match_querystring=False,
        )
        org = self.organization
        self.login_as(self.user)

        path = reverse("sentry-extensions-jira-search", args=[org.slug, self.integration.id])

        # queries come through from the front end lowercased, so HSP-1 -> hsp-1
        for field in ("externalIssue", "parent"):
            resp = self.client.get(f"{path}?field={field}&query=hsp-1")
            assert resp.status_code == 200
            assert resp.data == [
                {"label": "(HSP-1) this is a test issue summary", "value": "HSP-1"}
            ]

</source>
</class>

<class classid="365" nclones="2" nlines="28" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vsts/test_integration.py" startline="177" endline="208" pcid="9972">
    def test_create_subscription_forbidden(self, mock_get_scopes):
        responses.replace(
            responses.POST,
            f"https://{self.vsts_account_name.lower()}.visualstudio.com/_apis/hooks/subscriptions",
            status=403,
            json={
                "$id": 1,
                "message": "The user bob is does not have permission to access this resource",
                "typeKey": "UnauthorizedRequestException",
                "errorCode": 0,
                "eventId": 3000,
            },
        )
        state = {
            "account": {"accountName": self.vsts_account_name, "accountId": self.vsts_account_id},
            "base_url": self.vsts_base_url,
            "identity": {
                "data": {
                    "access_token": self.access_token,
                    "expires_in": "3600",
                    "refresh_token": self.refresh_token,
                    "token_type": "jwt-bearer",
                }
            },
        }

        integration = VstsIntegrationProvider()

        with pytest.raises(IntegrationProviderError) as err:
            integration.build_integration(state)
        assert "sufficient account access to create webhooks" in str(err)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vsts/test_integration.py" startline="210" endline="242" pcid="9973">
    def test_create_subscription_unauthorized(self, mock_get_scopes):
        responses.replace(
            responses.POST,
            f"https://{self.vsts_account_name.lower()}.visualstudio.com/_apis/hooks/subscriptions",
            status=401,
            json={
                "$id": 1,
                "message": "The user bob is not authorized to access this resource",
                "typeKey": "UnauthorizedRequestException",
                "errorCode": 0,
                "eventId": 3000,
            },
        )
        state = {
            "account": {"accountName": self.vsts_account_name, "accountId": self.vsts_account_id},
            "base_url": self.vsts_base_url,
            "identity": {
                "data": {
                    "access_token": self.access_token,
                    "expires_in": "3600",
                    "refresh_token": self.refresh_token,
                    "token_type": "jwt-bearer",
                }
            },
        }

        integration = VstsIntegrationProvider()

        with pytest.raises(IntegrationProviderError) as err:
            integration.build_integration(state)
        assert "sufficient account access to create webhooks" in str(err)


</source>
</class>

<class classid="366" nclones="2" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vsts/test_integration.py" startline="260" endline="277" pcid="9975">
    def test_get_organization_config_failure(self):
        self.assert_installation()
        integration = Integration.objects.get(provider="vsts")
        installation = integration.get_installation(integration.organizations.first().id)

        # Set the `default_identity` property and force token expiration
        installation.get_client()
        installation.default_identity.data["expires"] = 1566851050

        responses.replace(
            responses.POST,
            "https://app.vssps.visualstudio.com/oauth2/token",
            status=400,
            json={"error": "invalid_grant", "message": "The provided authorization grant failed"},
        )
        fields = installation.get_organization_config()
        assert fields[0]["disabled"], "Fields should be disabled"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vsts/test_integration.py" startline="431" endline="447" pcid="9981">
    def test_get_repositories_identity_error(self):
        self.assert_installation()
        integration = Integration.objects.get(provider="vsts")
        installation = integration.get_installation(self.organization.id)

        # Set the `default_identity` property and force token expiration
        installation.get_client()
        installation.default_identity.data["expires"] = 1566851050
        responses.replace(
            responses.POST,
            "https://app.vssps.visualstudio.com/oauth2/token",
            status=400,
            json={"error": "invalid_grant", "message": "The provided authorization grant failed"},
        )
        with pytest.raises(IntegrationError):
            installation.get_repositories()

</source>
</class>

<class classid="367" nclones="2" nlines="15" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/pagerduty/test_notify_action.py" startline="23" endline="37" pcid="10061">
    def setUp(self):
        self.integration = Integration.objects.create(
            provider="pagerduty",
            name="Example",
            external_id=EXTERNAL_ID,
            metadata={"services": SERVICES},
        )
        self.integration.add_organization(self.organization, self.user)
        self.service = PagerDutyService.objects.create(
            service_name=SERVICES[0]["service_name"],
            integration_key=SERVICES[0]["integration_key"],
            organization_integration=self.integration.organizationintegration_set.first(),
        )
        self.installation = self.integration.get_installation(self.organization.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/pagerduty/test_client.py" startline="25" endline="41" pcid="10079">
    def setUp(self):
        self.login_as(self.user)
        self.integration = Integration.objects.create(
            provider=self.provider,
            name="Example PagerDuty",
            external_id=EXTERNAL_ID,
            metadata={"services": SERVICES},
        )
        self.integration.add_organization(self.organization, self.user)
        self.service = PagerDutyService.objects.create(
            service_name=SERVICES[0]["service_name"],
            integration_key=SERVICES[0]["integration_key"],
            organization_integration=self.integration.organizationintegration_set.first(),
        )
        self.installation = self.integration.get_installation(self.organization.id)
        self.min_ago = iso_format(before_now(minutes=1))

</source>
</class>

<class classid="368" nclones="2" nlines="16" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/pagerduty/test_integration.py" startline="98" endline="118" pcid="10073">
    def test_basic_flow(self):
        with self.tasks():
            self.assert_setup_flow()

        integration = Integration.objects.get(provider=self.provider.key)

        assert integration.external_id == self.account_slug
        assert integration.name == "Test App"
        assert integration.metadata["services"] == [
            {
                "integration_key": "key1",
                "name": "Super Cool Service",
                "id": "PD12345",
                "type": "service",
            }
        ]
        oi = OrganizationIntegration.objects.get(
            integration=integration, organization=self.organization
        )
        assert oi.config == {}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_integration.py" startline="127" endline="148" pcid="10089">
    def test_basic_flow(self):
        with self.tasks():
            self.assert_setup_flow()

        integration = Integration.objects.get(provider=self.provider.key)

        assert integration.external_id == self.installation_id
        assert integration.name == "Test Organization"
        assert integration.metadata == {
            "access_token": None,
            # The metadata doesn't get saved with the timezone "Z" character
            # for some reason, so just compare everything but that.
            "expires_at": None,
            "icon": "http://example.com/avatar.png",
            "domain_name": "github.com/Test-Organization",
            "account_type": "Organization",
        }
        oi = OrganizationIntegration.objects.get(
            integration=integration, organization=self.organization
        )
        assert oi.config == {}

</source>
</class>

<class classid="369" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/pagerduty/test_integration.py" startline="164" endline="175" pcid="10076">
    def test_delete_pagerduty_service(self):
        with self.tasks():
            self.assert_setup_flow()
        integration = Integration.objects.get(provider=self.provider.key)
        service_id = PagerDutyService.objects.get(integration_key="key1").id
        config_data = {
            "service_table": [{"service": "new_service", "integration_key": "new_key", "id": None}]
        }
        integration.get_installation(self.organization).update_organization_config(config_data)
        assert len(PagerDutyService.objects.all()) == 1
        assert not PagerDutyService.objects.filter(id=service_id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/pagerduty/test_integration.py" startline="177" endline="188" pcid="10077">
    def test_no_name(self):
        with self.tasks():
            self.assert_setup_flow()
        integration = Integration.objects.get(provider=self.provider.key)
        service_id = PagerDutyService.objects.get(integration_key="key1").id
        config_data = {
            "service_table": [{"service": "new_service", "integration_key": "", "id": service_id}]
        }
        with pytest.raises(IntegrationError) as error:
            integration.get_installation(self.organization).update_organization_config(config_data)
        assert str(error.value) == "Name and key are required"

</source>
</class>

<class classid="370" nclones="3" nlines="24" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_integration.py" startline="285" endline="309" pcid="10094">
    def test_get_stacktrace_link_file_exists(self):
        self.assert_setup_flow()
        integration = Integration.objects.get(provider=self.provider.key)
        repo = Repository.objects.create(
            organization_id=self.organization.id,
            name="Test-Organization/foo",
            url="https://github.com/Test-Organization/foo",
            provider="integrations:github",
            external_id=123,
            config={"name": "Test-Organization/foo"},
            integration_id=integration.id,
        )

        path = "README.md"
        version = "1234567"
        default = "master"
        responses.add(
            responses.HEAD,
            self.base_url + f"/repos/{repo.name}/contents/{path}?ref={version}",
        )
        installation = integration.get_installation(self.organization)
        result = installation.get_stacktrace_link(repo, path, default, version)

        assert result == "https://github.com/Test-Organization/foo/blob/1234567/README.md"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_integration.py" startline="338" endline="367" pcid="10096">
    def test_get_stacktrace_link_use_default_if_version_404(self):
        self.assert_setup_flow()
        integration = Integration.objects.get(provider=self.provider.key)

        repo = Repository.objects.create(
            organization_id=self.organization.id,
            name="Test-Organization/foo",
            url="https://github.com/Test-Organization/foo",
            provider="integrations:github",
            external_id=123,
            config={"name": "Test-Organization/foo"},
            integration_id=integration.id,
        )
        path = "README.md"
        version = "12345678"
        default = "master"
        responses.add(
            responses.HEAD,
            self.base_url + f"/repos/{repo.name}/contents/{path}?ref={version}",
            status=404,
        )
        responses.add(
            responses.HEAD,
            self.base_url + f"/repos/{repo.name}/contents/{path}?ref={default}",
        )
        installation = integration.get_installation(self.organization)
        result = installation.get_stacktrace_link(repo, path, default, version)

        assert result == "https://github.com/Test-Organization/foo/blob/master/README.md"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_integration.py" startline="311" endline="336" pcid="10095">
    def test_get_stacktrace_link_file_doesnt_exists(self):
        self.assert_setup_flow()
        integration = Integration.objects.get(provider=self.provider.key)

        repo = Repository.objects.create(
            organization_id=self.organization.id,
            name="Test-Organization/foo",
            url="https://github.com/Test-Organization/foo",
            provider="integrations:github",
            external_id=123,
            config={"name": "Test-Organization/foo"},
            integration_id=integration.id,
        )
        path = "README.md"
        version = "master"
        default = "master"
        responses.add(
            responses.HEAD,
            self.base_url + f"/repos/{repo.name}/contents/{path}?ref={version}",
            status=404,
        )
        installation = integration.get_installation(self.organization)
        result = installation.get_stacktrace_link(repo, path, default, version)

        assert not result

</source>
</class>

<class classid="371" nclones="8" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="28" endline="46" pcid="10100">
    def test_unregistered_event(self):
        project = self.project  # noqa force creation
        url = "/extensions/github/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        options.set("github-app.webhook-secret", secret)

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="UnregisteredEvent",
            HTTP_X_HUB_SIGNATURE="sha1=56a3df597e02adbc17fb617502c70e19d96a6136",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="40" endline="54" pcid="10281">
    def test_unregistered_event(self):
        project = self.project  # noqa force creation
        url = "/extensions/github-enterprise/webhook/"

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="UnregisteredEvent",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=56a3df597e02adbc17fb617502c70e19d96a6136",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )
        assert response.status_code == 204

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="57" endline="79" pcid="11628">
    def test_invalid_signature_event(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "2d7565c3537847b789d6995dca8d9f84"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=33521abeaaf9a57c2abf486e0ccd54d23cf36fec",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 401


</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="47" endline="66" pcid="10101">
    def test_invalid_signature_event(self):

        url = "/extensions/github/webhook/"

        secret = "2d7565c3537847b789d6995dca8d9f84"

        options.set("github-app.webhook-secret", secret)

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=33521abeaaf9a57c2abf486e0ccd54d23cf36fec",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 401


</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/bitbucket/endpoints/test_webhooks.py" startline="48" endline="63" pcid="11505">
    def test_invalid_signature_ip(self):
        project = self.project  # force creation

        url = f"/plugins/bitbucket/organizations/{project.organization.id}/webhook/"

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_EVENT_KEY="repo:push",
            REMOTE_ADDR=BAD_IP,
        )

        assert response.status_code == 401


</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="36" endline="56" pcid="11627">
    def test_unregistered_event(self):
        project = self.project  # force creation
        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="UnregisteredEvent",
            HTTP_X_HUB_SIGNATURE="sha1=98196e70369945ffa6b248cf70f7dc5e46dff241",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="256" endline="274" pcid="11632">
    def test_simple(self):
        url = "/plugins/github/installations/webhook/"

        response = self.client.post(
            path=url,
            data=INSTALLATION_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="installation",
            HTTP_X_HUB_SIGNATURE="sha1=348e46312df2901e8cb945616ee84ce30d9987c9",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        assert Integration.objects.filter(
            provider="github_apps", external_id=2, name="octocat"
        ).exists()


</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="25" endline="39" pcid="10280">
    def test_unknown_host_event(self):
        # No integration defined in the database, so event should be rejected
        # because we can't find metadata and secret for it
        url = "/extensions/github-enterprise/webhook/"

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_GITHUB_ENTERPRISE_HOST="99.99.99.99",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )
        assert response.status_code == 400

</source>
</class>

<class classid="372" nclones="18" nlines="41" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="69" endline="132" pcid="10102">
    def test_simple(self, mock_get_jwt):
        mock_get_jwt.return_value = ""

        project = self.project  # force creation

        url = "/extensions/github/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        options.set("github-app.webhook-secret", secret)
        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github",
            name="baxterthehacker/public-repo",
        )

        future_expires = datetime.now().replace(microsecond=0) + timedelta(minutes=5)
        integration = Integration.objects.create(
            external_id="12345",
            provider="github",
            metadata={"access_token": "1234", "expires_at": future_expires.isoformat()},
        )
        integration.add_organization(project.organization, self.user)

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=56a3df597e02adbc17fb617502c70e19d96a6136",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(
                # organization_id=project.organization_id,
            )
            .select_related("author")
            .order_by("-date_added")
        )

        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="105" endline="176" pcid="10284">
    def test_simple(self, mock_get_installation_metadata, mock_get_jwt):
        mock_get_jwt.return_value = b""

        project = self.project  # force creation

        url = "/extensions/github-enterprise/webhook/"
        mock_get_installation_metadata.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github_enterprise",
            name="baxterthehacker/public-repo",
        )
        integration = Integration.objects.create(
            external_id="35.232.149.196:12345",
            provider="github_enterprise",
            metadata={
                "domain_name": "35.232.149.196/baxterthehacker",
                "installation_id": "12345",
                "installation": {"id": "2", "private_key": "private_key", "verify_ssl": True},
            },
        )
        integration.add_organization(project.organization, self.user)

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=2a0586cc46490b17441834e1e143ec3d8c1fe032",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(
                # organization_id=project.organization_id,
            )
            .select_related("author")
            .order_by("-date_added")
        )

        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="133" endline="200" pcid="10103">
    def test_anonymous_lookup(self):
        project = self.project  # force creation

        url = "/extensions/github/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        options.set("github-app.webhook-secret", secret)

        future_expires = datetime.now().replace(microsecond=0) + timedelta(minutes=5)
        integration = Integration.objects.create(
            provider="github",
            external_id="12345",
            name="octocat",
            metadata={"access_token": "1234", "expires_at": future_expires.isoformat()},
        )
        integration.add_organization(project.organization, self.user)

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github",
            name="baxterthehacker/public-repo",
        )

        CommitAuthor.objects.create(
            external_id="github:baxterthehacker",
            organization_id=project.organization_id,
            email="baxterthehacker@example.com",
            name="bxterthehacker",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=56a3df597e02adbc17fb617502c70e19d96a6136",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        # should be skipping the #skipsentry commit
        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="136" endline="197" pcid="11630">
    def test_anonymous_lookup(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github",
            name="baxterthehacker/public-repo",
        )

        CommitAuthor.objects.create(
            external_id="github:baxterthehacker",
            organization_id=project.organization_id,
            email="baxterthehacker@example.com",
            name="bxterthehacker",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=98196e70369945ffa6b248cf70f7dc5e46dff241",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        # should be skipping the #skipsentry commit
        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)


</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="81" endline="135" pcid="11629">
    def test_simple(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=98196e70369945ffa6b248cf70f7dc5e46dff241",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="199" endline="254" pcid="11631">
    def test_simple(self):
        project = self.project  # force creation

        url = "/plugins/github/installations/webhook/"

        inst = Integration.objects.create(
            provider="github_apps", external_id="12345", name="dummyorg"
        )

        inst.add_organization(self.project.organization)

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github_apps",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_HUB_SIGNATURE="sha1=56a3df597e02adbc17fb617502c70e19d96a6136",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@users.noreply.github.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)


</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="178" endline="252" pcid="10285">
    def test_anonymous_lookup(self, mock_get_installation_metadata):
        project = self.project  # force creation

        url = "/extensions/github-enterprise/webhook/"
        mock_get_installation_metadata.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }

        integration = Integration.objects.create(
            provider="github_enterprise",
            external_id="35.232.149.196:12345",
            name="octocat",
            metadata={
                "domain_name": "35.232.149.196/baxterthehacker",
                "installation": {"id": "2", "private_key": "private_key", "verify_ssl": True},
            },
        )
        integration.add_organization(project.organization, self.user)

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github_enterprise",
            name="baxterthehacker/public-repo",
        )

        CommitAuthor.objects.create(
            external_id="github_enterprise:baxterthehacker",
            organization_id=project.organization_id,
            email="baxterthehacker@example.com",
            name="bxterthehacker",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=2a0586cc46490b17441834e1e143ec3d8c1fe032",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        # should be skipping the #skipsentry commit
        assert len(commit_list) == 2

        commit = commit_list[0]

        assert commit.key == "133d60480286590a610a0eb7352ff6e02b9674c4"
        assert commit.message == "Update README.md (gain)"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 45, 15, tzinfo=timezone.utc)

        commit = commit_list[1]

        assert commit.key == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
        assert commit.message == "Update README.md"
        assert commit.author.name == "bxterthehacker"
        assert commit.author.email == "baxterthehacker@example.com"
        assert commit.date_added == datetime(2015, 5, 5, 23, 40, 15, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/bitbucket/endpoints/test_webhooks.py" startline="104" endline="149" pcid="11507">
    def test_anonymous_lookup(self):
        project = self.project  # force creation

        url = f"/plugins/bitbucket/organizations/{project.organization.id}/webhook/"

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="{c78dfb25-7882-4550-97b1-4e0d38f32859}",
            provider="bitbucket",
            name="maxbittker/newsdiffs",
        )

        CommitAuthor.objects.create(
            external_id="bitbucket:baxterthehacker",
            organization_id=project.organization_id,
            email="baxterthehacker@example.com",
            name="bxterthehacker",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_EVENT_KEY="repo:push",
            REMOTE_ADDR=BITBUCKET_IP,
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        # should be skipping the #skipsentry commit
        assert len(commit_list) == 1

        commit = commit_list[0]

        assert commit.key == "e0e377d186e4f0e937bdb487a23384fe002df649"
        assert commit.message == "README.md edited online with Bitbucket"
        assert commit.author.name == "Max Bittker"
        assert commit.author.email == "max@getsentry.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2017, 5, 24, 1, 5, 47, tzinfo=timezone.utc)
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/bitbucket/endpoints/test_webhooks.py" startline="65" endline="103" pcid="11506">
    def test_simple(self):
        project = self.project  # force creation

        url = f"/plugins/bitbucket/organizations/{project.organization.id}/webhook/"

        Repository.objects.create(
            organization_id=project.organization.id,
            external_id="{c78dfb25-7882-4550-97b1-4e0d38f32859}",
            provider="bitbucket",
            name="maxbittker/newsdiffs",
        )

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_EVENT_KEY="repo:push",
            REMOTE_ADDR=BITBUCKET_IP,
        )

        assert response.status_code == 204

        commit_list = list(
            Commit.objects.filter(organization_id=project.organization_id)
            .select_related("author")
            .order_by("-date_added")
        )

        assert len(commit_list) == 1

        commit = commit_list[0]

        assert commit.key == "e0e377d186e4f0e937bdb487a23384fe002df649"
        assert commit.message == "README.md edited online with Bitbucket"
        assert commit.author.name == "Max Bittker"
        assert commit.author.email == "max@getsentry.com"
        assert commit.author.external_id is None
        assert commit.date_added == datetime(2017, 5, 24, 1, 5, 47, tzinfo=timezone.utc)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="341" endline="382" pcid="11635">
    def test_opened(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github_apps",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_OPENED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=aa5b11bc52b9fac082cb59f9ee8667cb222c3aff",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert pr.message == "This is a pretty simple change that we need to pull into master."
        assert pr.title == "Update the README with new information"
        assert pr.author.name == "baxterthehacker"

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="423" endline="464" pcid="11637">
    def test_closed(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github_apps",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_CLOSED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=dff1c803cf1e48c1b9aefe4a17952ea132758806",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert pr.message == "new closed body"
        assert pr.title == "new closed title"
        assert pr.author.name == "baxterthehacker"
        assert pr.merge_commit_sha == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="373" endline="422" pcid="10107">
    def test_closed(self):
        project = self.project  # force creation

        url = "/extensions/github/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        options.set("github-app.webhook-secret", secret)

        future_expires = datetime.now().replace(microsecond=0) + timedelta(minutes=5)
        integration = Integration.objects.create(
            provider="github",
            external_id="12345",
            name="octocat",
            metadata={"access_token": "1234", "expires_at": future_expires.isoformat()},
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_CLOSED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=49db856f5658b365b73a2fa73a7cffa543f4d3af",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert pr.message == "new closed body"
        assert pr.title == "new closed title"
        assert pr.author.name == "baxterthehacker"
        assert pr.merge_commit_sha == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/endpoints/test_webhooks.py" startline="383" endline="422" pcid="11636">
    def test_edited(self):
        project = self.project  # force creation

        url = f"/plugins/github/organizations/{project.organization.id}/webhook/"

        secret = "b3002c3e321d4b7880360d397db2ccfd"

        OrganizationOption.objects.set_value(
            organization=project.organization, key="github:webhook_secret", value=secret
        )

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="github_apps",
            name="baxterthehacker/public-repo",
        )

        pr = PullRequest.objects.create(
            key="1", repository_id=repo.id, organization_id=project.organization.id
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_EDITED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=b50a13afd33b514e8e62e603827ea62530f0690e",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        pr = PullRequest.objects.get(id=pr.id)

        assert pr.key == "1"
        assert pr.message == "new edited body"
        assert pr.title == "new edited title"
        assert pr.author.name == "baxterthehacker"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="453" endline="508" pcid="10289">
    def test_closed(self, mock_get_installation_metadata):
        project = self.project  # force creation

        url = "/extensions/github-enterprise/webhook/"
        mock_get_installation_metadata.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }

        integration = Integration.objects.create(
            provider="github_enterprise",
            external_id="35.232.149.196:234",
            name="octocat",
            metadata={
                "domain_name": "35.232.149.196/baxterthehacker",
                "installation": {"id": "2", "private_key": "private_key", "verify_ssl": True},
            },
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github_enterprise",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_CLOSED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=dff1c803cf1e48c1b9aefe4a17952ea132758806",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert pr.message == "new closed body"
        assert pr.title == "new closed title"
        assert pr.author.name == "baxterthehacker"
        assert pr.merge_commit_sha == "0d1a26e67d8f5eaf1f6ba5c57fc3c7d91ac0fd1c"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="341" endline="396" pcid="10287">
    def test_opened(self, mock_get_installation_metadata):
        project = self.project  # force creation

        url = "/extensions/github-enterprise/webhook/"
        mock_get_installation_metadata.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }

        integration = Integration.objects.create(
            provider="github_enterprise",
            external_id="35.232.149.196:234",
            name="octocat",
            metadata={
                "domain_name": "35.232.149.196/baxterthehacker",
                "installation": {"id": "2", "private_key": "private_key", "verify_ssl": True},
            },
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github_enterprise",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_OPENED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=aa5b11bc52b9fac082cb59f9ee8667cb222c3aff",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert pr.message == "This is a pretty simple change that we need to pull into master."
        assert pr.title == "Update the README with new information"
        assert pr.author.name == "baxterthehacker"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="325" endline="372" pcid="10106">
    def test_edited(self):
        project = self.project  # force creation
        group = self.create_group(project=project, short_id=7)

        url = "/extensions/github/webhook/"
        secret = "b3002c3e321d4b7880360d397db2ccfd"
        options.set("github-app.webhook-secret", secret)

        future_expires = datetime.now().replace(microsecond=0) + timedelta(minutes=5)
        integration = Integration.objects.create(
            provider="github",
            external_id="12345",
            name="octocat",
            metadata={"access_token": "1234", "expires_at": future_expires.isoformat()},
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github",
            name="baxterthehacker/public-repo",
        )

        pr = PullRequest.objects.create(
            key="1", repository_id=repo.id, organization_id=project.organization.id
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_EDITED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=83100642f0cf5d7f6145cf8d04da5d00a09f890f",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        pr = PullRequest.objects.get(id=pr.id)

        assert pr.key == "1"
        assert pr.message == "new edited body. Fixes BAR-7"
        assert pr.title == "new edited title"
        assert pr.author.name == "baxterthehacker"

        self.assert_group_link(group, pr)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_webhooks.py" startline="273" endline="324" pcid="10105">
    def test_opened(self):
        project = self.project  # force creation
        group = self.create_group(project=project, short_id=7)
        url = "/extensions/github/webhook/"
        secret = "b3002c3e321d4b7880360d397db2ccfd"
        options.set("github-app.webhook-secret", secret)

        future_expires = datetime.now().replace(microsecond=0) + timedelta(minutes=5)
        integration = Integration.objects.create(
            provider="github",
            external_id="12345",
            name="octocat",
            metadata={"access_token": "1234", "expires_at": future_expires.isoformat()},
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github",
            name="baxterthehacker/public-repo",
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_OPENED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_HUB_SIGNATURE="sha1=bc7ce12fc1058a35bf99355e6fc0e6da72c35de3",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        prs = PullRequest.objects.filter(
            repository_id=repo.id, organization_id=project.organization.id
        )

        assert len(prs) == 1

        pr = prs[0]

        assert pr.key == "1"
        assert (
            pr.message
            == "This is a pretty simple change that we need to pull into master. Fixes BAR-7"
        )
        assert pr.title == "Update the README with new information"
        assert pr.author.name == "baxterthehacker"

        self.assert_group_link(group, pr)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="398" endline="451" pcid="10288">
    def test_edited(self, mock_get_installation_metadata):
        project = self.project  # force creation

        url = "/extensions/github-enterprise/webhook/"
        mock_get_installation_metadata.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }

        integration = Integration.objects.create(
            provider="github_enterprise",
            external_id="35.232.149.196:234",
            name="octocat",
            metadata={
                "domain_name": "35.232.149.196/baxterthehacker",
                "installation": {"id": "2", "private_key": "private_key", "verify_ssl": True},
            },
        )
        integration.add_organization(project.organization, self.user)

        repo = Repository.objects.create(
            organization_id=project.organization.id,
            external_id="35129377",
            provider="integrations:github_enterprise",
            name="baxterthehacker/public-repo",
        )

        pr = PullRequest.objects.create(
            key="1", repository_id=repo.id, organization_id=project.organization.id
        )

        response = self.client.post(
            path=url,
            data=PULL_REQUEST_EDITED_EVENT_EXAMPLE,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="pull_request",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=b50a13afd33b514e8e62e603827ea62530f0690e",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )

        assert response.status_code == 204

        pr = PullRequest.objects.get(id=pr.id)

        assert pr.key == "1"
        assert pr.message == "new edited body"
        assert pr.title == "new edited title"
        assert pr.author.name == "baxterthehacker"

</source>
</class>

<class classid="373" nclones="2" nlines="19" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_client.py" startline="55" endline="75" pcid="10111">
    def test_check_file(self, get_jwt):
        responses.add(
            method=responses.POST,
            url="https://api.github.com/app/installations/1/access_tokens",
            body='{"token": "12345token", "expires_at": "2030-01-01T00:00:00Z"}',
            content_type="application/json",
        )

        path = "src/sentry/integrations/github/client.py"
        version = "master"
        url = f"https://api.github.com/repos/{self.repo.name}/contents/{path}?ref={version}"

        responses.add(
            method=responses.HEAD,
            url=url,
            json={"text": 200},
        )

        resp = self.client.check_file(self.repo, path, version)
        assert resp.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_client.py" startline="98" endline="123" pcid="10113">
    def test_get_stacktrace_link(self, get_jwt):
        responses.add(
            method=responses.POST,
            url="https://api.github.com/app/installations/1/access_tokens",
            body='{"token": "12345token", "expires_at": "2030-01-01T00:00:00Z"}',
            content_type="application/json",
        )

        path = "/src/sentry/integrations/github/client.py"
        version = "master"
        url = "https://api.github.com/repos/{}/contents/{}?ref={}".format(
            self.repo.name, path.lstrip("/"), version
        )

        responses.add(
            method=responses.HEAD,
            url=url,
            json={"text": 200},
        )

        source_url = self.install.get_stacktrace_link(self.repo, path, "master", version)
        assert (
            source_url
            == "https://github.com/Test-Organization/foo/blob/master/src/sentry/integrations/github/client.py"
        )

</source>
</class>

<class classid="374" nclones="2" nlines="16" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="16" endline="29" pcid="10115">
    def create_integration(self):
        future = datetime.now() + timedelta(hours=1)
        return Integration.objects.create(
            provider=self.provider,
            name="test",
            external_id=9999,
            metadata={
                "domain_name": "github.com/test",
                "account_type": "Organization",
                "access_token": "123456789",
                "expires_at": future.replace(microsecond=0).isoformat(),
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_search.py" startline="14" endline="31" pcid="10290">
    def create_integration(self):
        future = datetime.now() + timedelta(hours=1)
        return Integration.objects.create(
            provider=self.provider,
            name="test",
            external_id=9999,
            metadata={
                "domain_name": "github.example.org",
                "account_type": "Organization",
                "access_token": "123456789",
                "expires_at": future.replace(microsecond=0).isoformat(),
                "installation": {
                    "private_key": "some private key",
                    "id": 123456,
                    "verify_ssl": True,
                },
            },
        )
</source>
</class>

<class classid="375" nclones="7" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="75" endline="87" pcid="10118">
    def test_finds_external_issue_results_with_id(self):
        responses.add(
            responses.GET,
            self.base_url + "/search/issues?q=repo:example%2025",
            json={"items": [{"number": 25, "title": "AEIOU Error"}]},
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "25", "repo": "example"}
        )

        assert resp.status_code == 200
        assert resp.data == [{"value": 25, "label": "#25 AEIOU Error"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_search.py" startline="46" endline="58" pcid="10344">
    def test_finds_external_issue_results_with_iid(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/5/issues?scope=all&iids=25",
            json=[{"iid": 25, "title": "AEIOU Error", "project_id": "5"}],
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "25", "project": "5"}
        )

        assert resp.status_code == 200
        assert resp.data == [{"value": "5#25", "label": "(#25) AEIOU Error"}]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_search.py" startline="122" endline="134" pcid="10348">
    def test_finds_no_external_issues_results(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/5/issues?scope=all&search=XYZ",
            json=[],
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "XYZ", "project": "5"}
        )

        assert resp.status_code == 200
        assert resp.data == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="124" endline="136" pcid="10121">
    def test_finds_no_external_issues_results(self):
        responses.add(
            responses.GET,
            self.base_url + "/search/issues?q=repo:example%20nope",
            json={"items": []},
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "nope", "repo": "example"}
        )

        assert resp.status_code == 200
        assert resp.data == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_search.py" startline="136" endline="148" pcid="10349">
    def test_finds_no_external_issues_results_iid(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/5/issues?scope=all&iids=11",
            json=[],
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "11", "project": "5"}
        )

        assert resp.status_code == 200
        assert resp.data == []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="381" endline="392" pcid="10390">
    def test_after_link_issue(self):
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/2/issues/321/notes",
            json=[],
        )
        data = {"externalIssue": "2#321", "comment": "This is not good."}
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=self.integration.id, key="2#321"
        )
        self.installation.after_link_issue(external_issue, data=data)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="402" endline="413" pcid="10392">
    def test_after_link_issue_failure(self):
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/2/issues/321/notes",
            status=502,
        )
        data = {"externalIssue": "2#321", "comment": "This is not good."}
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=self.integration.id, key="2#321"
        )
        with self.assertRaises(IntegrationError):
            self.installation.after_link_issue(external_issue, data=data)
</source>
</class>

<class classid="376" nclones="2" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="148" endline="162" pcid="10123">
    def test_search_issues_rate_limit(self):
        responses.add(
            responses.GET,
            self.base_url + "/search/issues?q=repo:example%20ex",
            status=403,
            json={
                "message": "API rate limit exceeded",
                "documentation_url": "https://developer.github.com/v3/#rate-limiting",
            },
        )
        resp = self.client.get(
            self.url, data={"field": "externalIssue", "query": "ex", "repo": "example"}
        )
        assert resp.status_code == 429

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_search.py" startline="164" endline="177" pcid="10124">
    def test_search_project_rate_limit(self):
        responses.add(
            responses.GET,
            self.base_url + "/search/repositories?q=org:test%20ex",
            status=403,
            json={
                "message": "API rate limit exceeded",
                "documentation_url": "https://developer.github.com/v3/#rate-limiting",
            },
        )
        resp = self.client.get(self.url, data={"field": "repo", "query": "ex"})
        assert resp.status_code == 429

    # Request Validations
</source>
</class>

<class classid="377" nclones="4" nlines="19" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_issues.py" startline="31" endline="55" pcid="10134">
    def test_get_allowed_assignees(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://api.github.com/app/installations/github_external_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/sentry/assignees",
            json=[{"login": "MeredithAnya"}],
        )

        repo = "getsentry/sentry"
        assert self.integration.get_allowed_assignees(repo) == (
            ("", "Unassigned"),
            ("MeredithAnya", "MeredithAnya"),
        )

        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="104" endline="124" pcid="10295">
    def test_get_repo_issues(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/app/installations/installation_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://35.232.149.196/api/v3/repos/getsentry/sentry/issues",
            json=[{"number": 321, "title": "hello", "body": "This is the description"}],
        )
        repo = "getsentry/sentry"
        assert self.integration.get_repo_issues(repo) == ((321, "#321 hello"),)

        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_issues.py" startline="99" endline="119" pcid="10136">
    def test_get_repo_issues(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://api.github.com/app/installations/github_external_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/sentry/issues",
            json=[{"number": 321, "title": "hello", "body": "This is the description"}],
        )
        repo = "getsentry/sentry"
        assert self.integration.get_repo_issues(repo) == ((321, "#321 hello"),)

        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="36" endline="60" pcid="10293">
    def test_get_allowed_assignees(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/app/installations/installation_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://35.232.149.196/api/v3/repos/getsentry/sentry/assignees",
            json=[{"login": "MeredithAnya"}],
        )

        repo = "getsentry/sentry"
        assert self.integration.get_allowed_assignees(repo) == (
            ("", "Unassigned"),
            ("MeredithAnya", "MeredithAnya"),
        )

        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
</class>

<class classid="378" nclones="4" nlines="33" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_issues.py" startline="58" endline="96" pcid="10135">
    def test_create_issue(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://api.github.com/app/installations/github_external_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.POST,
            "https://api.github.com/repos/getsentry/sentry/issues",
            json={
                "number": 321,
                "title": "hello",
                "body": "This is the description",
                "html_url": "https://github.com/getsentry/sentry/issues/231",
            },
        )

        form_data = {
            "repo": "getsentry/sentry",
            "title": "hello",
            "description": "This is the description",
        }

        assert self.integration.create_issue(form_data) == {
            "key": 321,
            "description": "This is the description",
            "title": "hello",
            "url": "https://github.com/getsentry/sentry/issues/231",
            "repo": "getsentry/sentry",
        }
        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"
        payload = json.loads(request.body)
        assert payload == {"body": "This is the description", "assignee": None, "title": "hello"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="63" endline="101" pcid="10294">
    def test_create_issue(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/app/installations/installation_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/repos/getsentry/sentry/issues",
            json={
                "number": 321,
                "title": "hello",
                "body": "This is the description",
                "html_url": "https://35.232.149.196/getsentry/sentry/issues/231",
            },
        )

        form_data = {
            "repo": "getsentry/sentry",
            "title": "hello",
            "description": "This is the description",
        }

        assert self.integration.create_issue(form_data) == {
            "key": 321,
            "description": "This is the description",
            "title": "hello",
            "url": "https://35.232.149.196/getsentry/sentry/issues/231",
            "repo": "getsentry/sentry",
        }
        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"
        payload = json.loads(request.body)
        assert payload == {"body": "This is the description", "assignee": None, "title": "hello"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="127" endline="160" pcid="10296">
    def test_link_issue(self, mock_get_jwt):
        issue_id = 321
        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/app/installations/installation_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://35.232.149.196/api/v3/repos/getsentry/sentry/issues/321",
            json={
                "number": issue_id,
                "title": "hello",
                "body": "This is the description",
                "html_url": "https://35.232.149.196/getsentry/sentry/issues/231",
            },
        )

        data = {"repo": "getsentry/sentry", "externalIssue": issue_id, "comment": "hello"}

        assert self.integration.get_issue(issue_id, data=data) == {
            "key": issue_id,
            "description": "This is the description",
            "title": "hello",
            "url": "https://35.232.149.196/getsentry/sentry/issues/231",
            "repo": "getsentry/sentry",
        }
        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_issues.py" startline="122" endline="155" pcid="10137">
    def test_link_issue(self, mock_get_jwt):
        issue_id = 321
        responses.add(
            responses.POST,
            "https://api.github.com/app/installations/github_external_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/sentry/issues/321",
            json={
                "number": issue_id,
                "title": "hello",
                "body": "This is the description",
                "html_url": "https://github.com/getsentry/sentry/issues/231",
            },
        )

        data = {"repo": "getsentry/sentry", "externalIssue": issue_id, "comment": "hello"}

        assert self.integration.get_issue(issue_id, data=data) == {
            "key": issue_id,
            "description": "This is the description",
            "title": "hello",
            "url": "https://github.com/getsentry/sentry/issues/231",
            "repo": "getsentry/sentry",
        }
        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"

</source>
</class>

<class classid="379" nclones="2" nlines="21" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_issues.py" startline="212" endline="239" pcid="10139">
    def after_link_issue(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://api.github.com/app/installations/github_external_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.POST,
            "https://api.github.com/repos/getsentry/sentry/issues/321/comments",
            json={"body": "hello"},
        )

        data = {"comment": "hello"}
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=self.model.id, key="hello#321"
        )

        self.integration.after_link_issue(external_issue, data=data)

        request = responses.calls[0].request
        assert request.headers["Authorization"] == b"Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"
        payload = json.loads(request.body)
        assert payload == {"body": "hello"}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_issues.py" startline="163" endline="189" pcid="10297">
    def after_link_issue(self, mock_get_jwt):
        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/installations/installation_id/access_tokens",
            json={"token": "token_1", "expires_at": "2018-10-11T22:14:10Z"},
        )

        responses.add(
            responses.POST,
            "https://35.232.149.196/api/v3/repos/getsentry/sentry/issues/321/comments",
            json={"body": "hello"},
        )

        data = {"comment": "hello"}
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=self.model.id, key="hello#321"
        )

        self.integration.after_link_issue(external_issue, data=data)

        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer jwt_token_1"

        request = responses.calls[1].request
        assert request.headers["Authorization"] == "token token_1"
        payload = json.loads(request.body)
        assert payload == {"body": "hello"}
</source>
</class>

<class classid="380" nclones="2" nlines="15" similarity="93">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_repository.py" startline="73" endline="88" pcid="10150">
    def test_compare_commits_no_start(self, get_jwt):
        stub_installation_token()
        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/example-repo/commits?sha=abcdef",
            json=json.loads(GET_LAST_COMMITS_EXAMPLE),
        )
        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/example-repo/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e",
            json=json.loads(GET_COMMIT_EXAMPLE),
        )
        result = self.provider.compare_commits(self.repository, None, "abcdef")
        for commit in result:
            assert_commit_shape(commit)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github/test_repository.py" startline="102" endline="117" pcid="10152">
    def test_compare_commits(self, get_jwt):
        stub_installation_token()
        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/example-repo/compare/xyz123...abcdef",
            json=json.loads(COMPARE_COMMITS_EXAMPLE),
        )
        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/example-repo/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e",
            json=json.loads(GET_COMMIT_EXAMPLE),
        )
        result = self.provider.compare_commits(self.repository, "xyz123", "abcdef")
        for commit in result:
            assert_commit_shape(commit)

</source>
</class>

<class classid="381" nclones="2" nlines="77" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_integration.py" startline="130" endline="219" pcid="10164">
    def test_update_organization_config(self):
        """Test that Vercel environment variables are created"""
        with self.tasks():
            self.assert_setup_flow()

        org = self.organization
        project_id = self.project.id
        enabled_dsn = ProjectKey.get_default(project=Project.objects.get(id=project_id)).get_dsn(
            public=True
        )
        sentry_auth_token = SentryAppInstallationToken.objects.get_token(org.id, "vercel")

        env_var_map = {
            "SENTRY_ORG": {"type": "encrypted", "value": org.slug},
            "SENTRY_PROJECT": {"type": "encrypted", "value": self.project.slug},
            "SENTRY_DSN": {"type": "encrypted", "value": enabled_dsn},
            "SENTRY_AUTH_TOKEN": {"type": "encrypted", "value": sentry_auth_token},
            "VERCEL_GIT_COMMIT_SHA": {"type": "system", "value": "VERCEL_GIT_COMMIT_SHA"},
        }

        # mock get_project API call
        responses.add(
            responses.GET,
            "https://api.vercel.com/v1/projects/%s"
            % "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H",
            json={"link": {"type": "github"}, "framework": "nextjs"},
        )

        # mock create the env vars
        for env_var, details in env_var_map.items():
            responses.add(
                responses.POST,
                "https://api.vercel.com/v7/projects/%s/env"
                % "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H",
                json={
                    "key": env_var,
                    "value": details["value"],
                    "target": ["production"],
                    "type": details["type"],
                },
            )

        integration = Integration.objects.get(provider=self.provider.key)
        installation = integration.get_installation(org.id)
        org_integration = OrganizationIntegration.objects.get(
            organization_id=org.id, integration_id=integration.id
        )
        assert org_integration.config == {}
        data = {
            "project_mappings": [[project_id, "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H"]]
        }

        installation.update_organization_config(data)
        org_integration = OrganizationIntegration.objects.get(
            organization_id=org.id, integration_id=integration.id
        )
        assert org_integration.config == {
            "project_mappings": [[project_id, "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H"]]
        }

        # assert the env vars were created correctly
        req_params = json.loads(responses.calls[5].request.body)
        assert req_params["key"] == "SENTRY_ORG"
        assert req_params["value"] == org.slug
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[6].request.body)
        assert req_params["key"] == "SENTRY_PROJECT"
        assert req_params["value"] == self.project.slug
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[7].request.body)
        assert req_params["key"] == "NEXT_PUBLIC_SENTRY_DSN"
        assert req_params["value"] == enabled_dsn
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[8].request.body)
        assert req_params["key"] == "SENTRY_AUTH_TOKEN"
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[9].request.body)
        assert req_params["key"] == "VERCEL_GIT_COMMIT_SHA"
        assert req_params["value"] == "VERCEL_GIT_COMMIT_SHA"
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "system"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_integration.py" startline="221" endline="327" pcid="10165">
    def test_update_org_config_vars_exist(self):
        """Test the case wherein the secret and env vars already exist"""

        with self.tasks():
            self.assert_setup_flow()

        org = self.organization
        project_id = self.project.id
        enabled_dsn = ProjectKey.get_default(project=Project.objects.get(id=project_id)).get_dsn(
            public=True
        )
        sentry_auth_token = SentryAppInstallationToken.objects.get_token(org.id, "vercel")

        env_var_map = {
            "SENTRY_ORG": {"type": "encrypted", "value": org.slug},
            "SENTRY_PROJECT": {"type": "encrypted", "value": self.project.slug},
            "SENTRY_DSN": {"type": "encrypted", "value": enabled_dsn},
            "SENTRY_AUTH_TOKEN": {"type": "secret", "value": sentry_auth_token},
            "VERCEL_GIT_COMMIT_SHA": {"type": "system", "value": "VERCEL_GIT_COMMIT_SHA"},
        }

        # mock get_project API call
        responses.add(
            responses.GET,
            "https://api.vercel.com/v1/projects/%s"
            % "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H",
            json={"link": {"type": "github"}, "framework": "gatsby"},
        )

        # mock update env vars
        count = 0
        for env_var, details in env_var_map.items():
            # mock try to create env var
            responses.add(
                responses.POST,
                "https://api.vercel.com/v7/projects/%s/env"
                % "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H",
                json={"error": {"code": "ENV_ALREADY_EXISTS"}},
                status=400,
            )
            # mock get env var
            responses.add(
                responses.GET,
                "https://api.vercel.com/v7/projects/%s/env"
                % "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H",
                json={"envs": [{"id": count, "key": env_var}]},
            )
            # mock update env var
            responses.add(
                responses.PATCH,
                "https://api.vercel.com/v7/projects/%s/env/%s"
                % ("Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H", count),
                json={
                    "key": env_var,
                    "value": details["value"],
                    "target": ["production"],
                    "type": details["type"],
                },
            )
            count += 1

        data = {
            "project_mappings": [[project_id, "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H"]]
        }
        integration = Integration.objects.get(provider=self.provider.key)
        installation = integration.get_installation(org.id)
        org_integration = OrganizationIntegration.objects.get(
            organization_id=org.id, integration_id=integration.id
        )
        assert org_integration.config == {}
        installation.update_organization_config(data)
        org_integration = OrganizationIntegration.objects.get(
            organization_id=org.id, integration_id=integration.id
        )
        assert org_integration.config == {
            "project_mappings": [[project_id, "Qme9NXBpguaRxcXssZ1NWHVaM98MAL6PHDXUs1jPrgiM8H"]]
        }

        req_params = json.loads(responses.calls[5].request.body)
        assert req_params["key"] == "SENTRY_ORG"
        assert req_params["value"] == org.slug
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[8].request.body)
        assert req_params["key"] == "SENTRY_PROJECT"
        assert req_params["value"] == self.project.slug
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[11].request.body)
        assert req_params["key"] == "SENTRY_DSN"
        assert req_params["value"] == enabled_dsn
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[14].request.body)
        assert req_params["key"] == "SENTRY_AUTH_TOKEN"
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "encrypted"

        req_params = json.loads(responses.calls[17].request.body)
        assert req_params["key"] == "VERCEL_GIT_COMMIT_SHA"
        assert req_params["value"] == "VERCEL_GIT_COMMIT_SHA"
        assert req_params["target"] == ["production"]
        assert req_params["type"] == "system"

</source>
</class>

<class classid="382" nclones="2" nlines="15" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_uninstall.py" startline="43" endline="58" pcid="10170">
    def setUp(self):
        self.url = "/extensions/vercel/delete/"
        metadata = {
            "access_token": "my_access_token",
            "installation_id": "my_config_id",
            "installation_type": "team",
            "webhook_id": "my_webhook_id",
        }
        self.integration = Integration.objects.create(
            provider="vercel",
            external_id="vercel_team_id",
            name="My Vercel Team",
            metadata=metadata,
        )
        self.integration.add_organization(self.organization)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="853" endline="867" pcid="10240">
    def setUp(self):
        super().setUp()
        self.metadata = {
            "oauth_client_id": "oauth-client-id",
            "shared_secret": "a-super-secret-key-from-atlassian",
            "base_url": "https://example.atlassian.net",
            "domain_name": "example.atlassian.net",
        }
        self.integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            external_id="my-external-id",
            metadata=self.metadata,
        )

</source>
</class>

<class classid="383" nclones="2" nlines="22" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_uninstall.py" startline="119" endline="152" pcid="10174">
    def test_uninstall_primary_configuration(self):
        """
        Test uninstalling the configuration whose credentials
            * access_token
            * webhook_id
            * installation_id
        are used in the primary metadata for the integration.
        """

        assert len(OrganizationIntegration.objects.all()) == 2
        response = self.client.delete(
            path=self.url,
            data=PRIMARY_UNINSTALL_RESPONSE,
            content_type="application/json",
        )

        assert response.status_code == 204
        assert len(OrganizationIntegration.objects.all()) == 1

        integration = Integration.objects.get(id=self.integration.id)
        assert integration.metadata == {
            "access_token": "my_access_token2",
            "installation_id": "my_config_id2",
            "installation_type": "team",
            "webhook_id": "my_webhook_id2",
            "configurations": {
                "my_config_id2": {
                    "access_token": "my_access_token2",
                    "webhook_id": "my_webhook_id2",
                    "organization_id": self.second_org.id,
                }
            },
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_uninstall.py" startline="153" endline="184" pcid="10175">
    def test_uninstall_non_primary_configuration(self):
        """
        Test uninstalling a configuration that is only stored
        in the "configurations" metadata.
        """

        assert len(OrganizationIntegration.objects.all()) == 2

        response = self.client.delete(
            path=self.url,
            data=NONPRIMARY_UNINSTALL_RESPONSE,
            content_type="application/json",
        )

        assert response.status_code == 204
        assert len(OrganizationIntegration.objects.all()) == 1

        integration = Integration.objects.get(id=self.integration.id)
        assert integration.metadata == {
            "access_token": "my_access_token",
            "installation_id": "my_config_id",
            "installation_type": "team",
            "webhook_id": "my_webhook_id",
            "configurations": {
                "my_config_id": {
                    "access_token": "my_access_token",
                    "webhook_id": "my_webhook_id",
                    "organization_id": self.organization.id,
                }
            },
        }

</source>
</class>

<class classid="384" nclones="7" nlines="12" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="138" endline="153" pcid="10185">
    def test_no_match(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )

        self.org_integration.config = {}
        self.org_integration.save()

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 0
            assert response.status_code == 204

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="171" endline="185" pcid="10187">
    def test_no_project(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )
        self.project.delete()

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 0
            assert response.status_code == 404
            assert response.data["detail"] == "Project not found"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="187" endline="201" pcid="10188">
    def test_no_installation(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )
        self.installation_for_provider.delete()

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 0
            assert response.status_code == 404
            assert response.data["detail"] == "Installation not found"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="155" endline="169" pcid="10186">
    def test_no_integration(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )
        self.integration.delete()

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 0
            assert response.status_code == 404
            assert response.data["detail"] == "Integration not found"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="203" endline="218" pcid="10189">
    def test_no_token(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )

        SentryAppInstallationToken.objects.filter().delete()

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 0
            assert response.status_code == 404
            assert response.data["detail"] == "Token not found"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="280" endline="294" pcid="10196">
    def test_release_already_created(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
        )

        self.create_release(
            project=self.project, version="7488658dfcf24d9b735e015992b316e2a8340d9d"
        )

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert response.status_code == 201
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/vercel/test_webhook.py" startline="220" endline="234" pcid="10190">
    def test_create_release_fails(self):
        responses.add(
            responses.POST,
            absolute_uri("/api/0/organizations/%s/releases/" % self.organization.slug),
            json={},
            status=400,
        )

        with override_options({"vercel.client-secret": SECRET}):
            response = self._get_response(EXAMPLE_DEPLOYMENT_WEBHOOK_RESPONSE, SIGNATURE)

            assert len(responses.calls) == 1
            assert response.status_code == 400
            assert "Error creating release" in response.data["detail"]

</source>
</class>

<class classid="385" nclones="3" nlines="27" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="271" endline="302" pcid="10221">
    def test_get_create_issue_config_with_default_and_param(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "message",
                "timestamp": self.min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
            },
            project_id=self.project.id,
        )
        group = event.group
        installation = self.integration.get_installation(self.organization.id)
        installation.org_integration.config = {
            "project_issue_defaults": {str(group.project_id): {"project": "10001"}}
        }
        installation.org_integration.save()

        with mock.patch.object(installation, "get_client", get_client):
            fields = installation.get_create_issue_config(
                group, self.user, params={"project": "10000"}
            )
            project_field = [field for field in fields if field["name"] == "project"][0]

            assert project_field == {
                "default": "10000",
                "choices": [("10000", "EX"), ("10001", "ABC")],
                "type": "select",
                "name": "project",
                "label": "Jira Project",
                "updatesForm": True,
            }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="333" endline="363" pcid="10223">
    def test_get_create_issue_config_with_label_default(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "message",
                "timestamp": self.min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
            },
            project_id=self.project.id,
        )
        group = event.group
        label_default = "hi"

        installation = self.integration.get_installation(self.organization.id)
        installation.org_integration.config = {
            "project_issue_defaults": {str(group.project_id): {"labels": label_default}}
        }
        installation.org_integration.save()

        with mock.patch.object(installation, "get_client", get_client):
            fields = installation.get_create_issue_config(group, self.user)
            label_field = [field for field in fields if field["name"] == "labels"][0]

            assert label_field == {
                "required": False,
                "type": "text",
                "name": "labels",
                "label": "Labels",
                "default": label_default,
            }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="303" endline="332" pcid="10222">
    def test_get_create_issue_config_with_default(self):
        event = self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "message",
                "timestamp": self.min_ago,
                "stacktrace": copy.deepcopy(DEFAULT_EVENT_DATA["stacktrace"]),
            },
            project_id=self.project.id,
        )
        group = event.group
        installation = self.integration.get_installation(self.organization.id)
        installation.org_integration.config = {
            "project_issue_defaults": {str(group.project_id): {"project": "10001"}}
        }
        installation.org_integration.save()

        with mock.patch.object(installation, "get_client", get_client):
            fields = installation.get_create_issue_config(group, self.user)
            project_field = [field for field in fields if field["name"] == "project"][0]

            assert project_field == {
                "default": "10001",
                "choices": [("10000", "EX"), ("10001", "ABC")],
                "type": "select",
                "name": "project",
                "label": "Jira Project",
                "updatesForm": True,
            }

</source>
</class>

<class classid="386" nclones="3" nlines="19" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="526" endline="550" pcid="10231">
    def test_sync_assignee_outbound_case_insensitive(self):
        self.user = self.create_user(email="bob@example.com")
        issue_id = "APP-123"
        installation = self.integration.get_installation(self.organization.id)
        assign_issue_url = "https://example.atlassian.net/rest/api/2/issue/%s/assignee" % issue_id
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=installation.model.id, key=issue_id
        )
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/user/assignable/search",
            json=[{"accountId": "deadbeef123", "emailAddress": "Bob@example.com"}],
            match_querystring=False,
        )
        responses.add(responses.PUT, assign_issue_url, json={}, match_querystring=False)
        installation.sync_assignee_outbound(external_issue, self.user)

        assert len(responses.calls) == 2

        # assert user above was successfully assigned
        assign_issue_response = responses.calls[1][1]
        assert assign_issue_url in assign_issue_response.url
        assert assign_issue_response.status_code == 200
        assert assign_issue_response.request.body == b'{"accountId": "deadbeef123"}'

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="552" endline="569" pcid="10232">
    def test_sync_assignee_outbound_no_email(self):
        self.user = self.create_user(email="bob@example.com")
        issue_id = "APP-123"
        installation = self.integration.get_installation(self.organization.id)
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=installation.model.id, key=issue_id
        )
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/user/assignable/search",
            json=[{"accountId": "deadbeef123", "displayName": "Dead Beef"}],
            match_querystring=False,
        )
        installation.sync_assignee_outbound(external_issue, self.user)

        # No sync made as jira users don't have email addresses
        assert len(responses.calls) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="572" endline="604" pcid="10233">
    def test_sync_assignee_outbound_use_email_api(self):
        self.user = self.create_user(email="bob@example.com")
        issue_id = "APP-123"
        installation = self.integration.get_installation(self.organization.id)
        assign_issue_url = "https://example.atlassian.net/rest/api/2/issue/%s/assignee" % issue_id
        external_issue = ExternalIssue.objects.create(
            organization_id=self.organization.id, integration_id=installation.model.id, key=issue_id
        )
        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/2/user/assignable/search",
            json=[{"accountId": "deadbeef123", "displayName": "Dead Beef", "emailAddress": ""}],
            match_querystring=False,
        )

        responses.add(
            responses.GET,
            "https://example.atlassian.net/rest/api/3/user/email",
            json={"accountId": "deadbeef123", "email": "bob@example.com"},
            match_querystring=False,
        )
        responses.add(responses.PUT, assign_issue_url, json={}, match_querystring=False)

        installation.sync_assignee_outbound(external_issue, self.user)

        # extra call to get email address
        assert len(responses.calls) == 3

        assign_issue_response = responses.calls[2][1]
        assert assign_issue_url in assign_issue_response.url
        assert assign_issue_response.status_code == 200
        assert assign_issue_response.request.body == b'{"accountId": "deadbeef123"}'

</source>
</class>

<class classid="387" nclones="4" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_webhooks.py" startline="30" endline="41" pcid="10244">
    def test_simple_assign(self, mock_sync_group_assignee_inbound):
        with patch(
            "sentry.integrations.jira.webhooks.get_integration_from_jwt",
            return_value=self.integration,
        ):
            data = StubService.get_stub_data("jira", "edit_issue_assignee_payload.json")
            resp = self.client.post(self.path, data=data, HTTP_AUTHORIZATION="JWT anexampletoken")
            assert resp.status_code == 200
            mock_sync_group_assignee_inbound.assert_called_with(
                self.integration, "jess@sentry.io", "APP-123", assign=True
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_webhooks.py" startline="77" endline="88" pcid="10247">
    def test_simple_deassign(self, mock_sync_group_assignee_inbound):
        with patch(
            "sentry.integrations.jira.webhooks.get_integration_from_jwt",
            return_value=self.integration,
        ):
            data = StubService.get_stub_data("jira", "edit_issue_no_assignee_payload.json")
            resp = self.client.post(self.path, data=data, HTTP_AUTHORIZATION="JWT anexampletoken")
            assert resp.status_code == 200
            mock_sync_group_assignee_inbound.assert_called_with(
                self.integration, None, "APP-123", assign=False
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_webhooks.py" startline="90" endline="101" pcid="10248">
    def test_simple_deassign_assignee_missing(self, mock_sync_group_assignee_inbound):
        with patch(
            "sentry.integrations.jira.webhooks.get_integration_from_jwt",
            return_value=self.integration,
        ):
            data = StubService.get_stub_data("jira", "edit_issue_assignee_missing_payload.json")
            resp = self.client.post(self.path, data=data, HTTP_AUTHORIZATION="JWT anexampletoken")
            assert resp.status_code == 200
            mock_sync_group_assignee_inbound.assert_called_with(
                self.integration, None, "APP-123", assign=False
            )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_webhooks.py" startline="65" endline="75" pcid="10246">
    def test_assign_missing_email(self, mock_sync_group_assignee_inbound):
        with patch(
            "sentry.integrations.jira.webhooks.get_integration_from_jwt",
            return_value=self.integration,
        ):
            data = StubService.get_stub_data("jira", "edit_issue_assignee_payload.json")
            data["issue"]["fields"]["assignee"]["emailAddress"] = ""
            resp = self.client.post(self.path, data=data, HTTP_AUTHORIZATION="JWT anexampletoken")
            assert resp.status_code == 200
            assert not mock_sync_group_assignee_inbound.called

</source>
</class>

<class classid="388" nclones="4" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_uninstalled.py" startline="18" endline="30" pcid="10264">
    def jwt_token_secret(self):
        jira_signing_algorithm = "HS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            self.shared_secret,
            algorithm=jira_signing_algorithm,
            headers={"alg": jira_signing_algorithm},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="31" endline="43" pcid="10276">
    def jwt_token_cdn(self):
        jira_signing_algorithm = "RS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            RS256_KEY,
            algorithm=jira_signing_algorithm,
            headers={"kid": self.kid, "alg": jira_signing_algorithm},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_uninstalled.py" startline="31" endline="43" pcid="10265">
    def jwt_token_cdn(self):
        jira_signing_algorithm = "RS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            RS256_KEY,
            algorithm=jira_signing_algorithm,
            headers={"kid": self.kid, "alg": jira_signing_algorithm},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="18" endline="30" pcid="10275">
    def jwt_token_secret(self):
        jira_signing_algorithm = "HS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            self.shared_secret,
            algorithm=jira_signing_algorithm,
            headers={"alg": jira_signing_algorithm},
        )

</source>
</class>

<class classid="389" nclones="2" nlines="12" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_client.py" startline="36" endline="48" pcid="10273">
    def test_get_field_autocomplete_for_non_customfield(self):
        body = {"results": [{"value": "ISSUE-1", "displayName": "My Issue (ISSUE-1)"}]}
        responses.add(
            method=responses.GET,
            url="https://example.atlassian.net/rest/api/2/jql/autocompletedata/suggestions?fieldName=my_field&fieldValue=abc&jwt=my-jwt-token",
            body=json.dumps(body),
            status=200,
            content_type="application/json",
            match_querystring=True,
        )
        res = self.client.get_field_autocomplete("my_field", "abc")
        assert res == body

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_client.py" startline="50" endline="61" pcid="10274">
    def test_get_field_autocomplete_for_customfield(self):
        body = {"results": [{"value": "ISSUE-1", "displayName": "My Issue (ISSUE-1)"}]}
        responses.add(
            method=responses.GET,
            url="https://example.atlassian.net/rest/api/2/jql/autocompletedata/suggestions?fieldName=cf[0123]&fieldValue=abc&jwt=my-jwt-token",
            body=json.dumps(body),
            status=200,
            content_type="application/json",
            match_querystring=True,
        )
        res = self.client.get_field_autocomplete("customfield_0123", "abc")
        assert res == body
</source>
</class>

<class classid="390" nclones="2" nlines="22" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="44" endline="63" pcid="10277">
    def test_with_shared_secret(self):
        resp = self.client.post(
            self.path,
            data={
                "jira": {
                    "metadata": {},
                    "external_id": self.external_id,
                },
                "clientKey": "limepie",
                "oauthClientId": "EFG",
                "publicKey": "yourCar",
                "sharedSecret": self.shared_secret,
                "baseUrl": "https://sentry.io.org.xyz.online.dev.sentry.io",
            },
            HTTP_AUTHORIZATION="JWT " + self.jwt_token_secret(),
        )
        integration = Integration.objects.get(provider="jira", external_id=self.external_id)
        assert integration.status == ObjectStatus.VISIBLE
        assert resp.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="65" endline="89" pcid="10278">
    def test_with_key_id(self):
        responses.add(
            responses.GET,
            f"https://connect-install-keys.atlassian.com/{self.kid}",
            body=RS256_PUB_KEY,
        )

        resp = self.client.post(
            self.path,
            data={
                "jira": {
                    "metadata": {},
                    "external_id": self.external_id,
                },
                "clientKey": "limepie",
                "oauthClientId": "EFG",
                "publicKey": "yourCar",
                "sharedSecret": self.shared_secret,
                "baseUrl": "https://sentry.io.org.xyz.online.dev.sentry.io",
            },
            HTTP_AUTHORIZATION="JWT " + self.jwt_token_cdn(),
        )
        integration = Integration.objects.get(provider="jira", external_id=self.external_id)
        assert integration.status == ObjectStatus.VISIBLE
        assert resp.status_code == 200
</source>
</class>

<class classid="391" nclones="2" nlines="20" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="56" endline="77" pcid="10282">
    def test_invalid_signature_event(self, mock_installation):
        mock_installation.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }
        url = "/extensions/github-enterprise/webhook/"

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_HUB_SIGNATURE="sha1=33521abeaaf9a57c2abf486e0ccd54d23cf36fec",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )
        assert response.status_code == 401

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/github_enterprise/test_webhooks.py" startline="79" endline="101" pcid="10283">
    def test_missing_signature_ok(self, mock_installation):
        # Old Github:e doesn't send a signature, so we have to accept that.
        mock_installation.return_value = {
            "url": "35.232.149.196",
            "id": "2",
            "name": "test-app",
            "webhook_secret": "b3002c3e321d4b7880360d397db2ccfd",
            "private_key": "private_key",
            "verify_ssl": True,
        }
        url = "/extensions/github-enterprise/webhook/"

        response = self.client.post(
            path=url,
            data=PUSH_EVENT_EXAMPLE_INSTALLATION,
            content_type="application/json",
            HTTP_X_GITHUB_EVENT="push",
            HTTP_X_GITHUB_ENTERPRISE_HOST="35.232.149.196",
            HTTP_X_GITHUB_DELIVERY=str(uuid4()),
        )
        assert response.status_code == 204


</source>
</class>

<class classid="392" nclones="2" nlines="21" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="51" endline="71" pcid="10301">
    def test_render_cloudformation_view(self, mock_react_view):
        self.pipeline.state.step_index = 1
        resp = self.client.get(self.setup_path)
        assert resp.status_code == 200
        mock_react_view.assert_called_with(
            ANY,
            "awsLambdaCloudformation",
            {
                "baseCloudformationUrl": "https://console.aws.amazon.com/cloudformation/home#/stacks/create/review",
                "templateUrl": "https://example.com/file.json",
                "stackName": "Sentry-Monitoring-Stack",
                "regionList": ALL_AWS_REGIONS,
                "region": None,
                "accountNumber": None,
                "error": None,
                "initialStepNumber": 1,
                "organization": serialize(self.organization),
                "awsExternalId": None,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="83" endline="105" pcid="10303">
    def test_set_arn_with_error(self, mock_react_view, mock_gen_aws_client):
        self.pipeline.state.step_index = 1
        mock_gen_aws_client.side_effect = ClientError({"Error": {}}, "assume_role")
        data = {"region": region, "accountNumber": account_number, "awsExternalId": "my-id"}
        resp = self.client.get(self.setup_path + "?" + urlencode(data))
        assert resp.status_code == 200
        mock_react_view.assert_called_with(
            ANY,
            "awsLambdaCloudformation",
            {
                "baseCloudformationUrl": "https://console.aws.amazon.com/cloudformation/home#/stacks/create/review",
                "templateUrl": "https://example.com/file.json",
                "stackName": "Sentry-Monitoring-Stack",
                "regionList": ALL_AWS_REGIONS,
                "region": region,
                "accountNumber": account_number,
                "error": "Please validate the Cloudformation stack was created successfully",
                "initialStepNumber": 1,
                "organization": serialize(self.organization),
                "awsExternalId": "my-id",
            },
        )

</source>
</class>

<class classid="393" nclones="2" nlines="53" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="147" endline="214" pcid="10305">
    def test_lambda_setup_layer_success(self, mock_gen_aws_client, mock_get_supported_functions):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock()
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaA",
                "Runtime": "nodejs12.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaA",
            },
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
            },
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        sentry_project_dsn = ProjectKey.get_default(project=self.projectA).get_dsn(public=True)

        # TODO: pass in lambdaA=false
        # having issues with reading json data
        # request.POST looks like {"lambdaB": "True"}
        # string instead of boolean
        resp = self.client.post(
            self.setup_path,
            data={"lambdaB": "true", "lambdaA": "false"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200

        mock_client.update_function_configuration.assert_called_once_with(
            FunctionName="lambdaB",
            Layers=["arn:aws:lambda:us-east-2:1234:layer:my-layer:3"],
            Environment={
                "Variables": {
                    "NODE_OPTIONS": "-r @sentry/serverless/dist/awslambda-auto",
                    "SENTRY_DSN": sentry_project_dsn,
                    "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                }
            },
        )

        integration = Integration.objects.get(provider=self.provider.key)
        assert integration.name == "my_name us-east-2"
        assert integration.external_id == "599817902985-us-east-2"
        assert integration.metadata == {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
        }
        assert OrganizationIntegration.objects.filter(
            integration=integration, organization=self.organization
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="217" endline="279" pcid="10306">
    def test_python_lambda_setup_layer_success(
        self, mock_gen_aws_client, mock_get_supported_functions
    ):
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock()
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaA",
                "Handler": "lambda_handler.test_handler",
                "Runtime": "python3.6",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaA",
            }
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        sentry_project_dsn = ProjectKey.get_default(project=self.projectA).get_dsn(public=True)

        resp = self.client.post(
            self.setup_path,
            data={"lambdaA": "true"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200

        mock_client.update_function_configuration.assert_called_once_with(
            FunctionName="lambdaA",
            Layers=["arn:aws:lambda:us-east-2:1234:layer:my-python-layer:34"],
            Environment={
                "Variables": {
                    "SENTRY_INITIAL_HANDLER": "lambda_handler.test_handler",
                    "SENTRY_DSN": sentry_project_dsn,
                    "SENTRY_TRACES_SAMPLE_RATE": "1.0",
                }
            },
            Handler="sentry_sdk.integrations.init_serverless_sdk.sentry_lambda_handler",
        )

        integration = Integration.objects.get(provider=self.provider.key)
        assert integration.name == "my_name us-east-2"
        assert integration.external_id == "599817902985-us-east-2"
        assert integration.metadata == {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
        }
        assert OrganizationIntegration.objects.filter(
            integration=integration, organization=self.organization
        )

</source>
</class>

<class classid="394" nclones="4" nlines="44" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="283" endline="337" pcid="10307">
    def test_lambda_setup_layer_error(
        self, mock_react_view, mock_gen_aws_client, mock_get_supported_functions
    ):
        class MockException(Exception):
            pass

        bad_layer = "arn:aws:lambda:us-east-2:546545:layer:another-layer:5"
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock(
            side_effect=Exception(f"Layer version {bad_layer} does not exist")
        )
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})
        mock_client.exceptions = MagicMock()
        mock_client.exceptions.ResourceConflictException = MockException

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaA",
                "Runtime": "nodejs12.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaA",
            },
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
            },
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        resp = self.client.post(
            self.setup_path,
            {"lambdaB": "true"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200
        assert not Integration.objects.filter(provider=self.provider.key).exists()

        failures = [{"name": "lambdaB", "error": "Invalid existing layer another-layer"}]

        mock_react_view.assert_called_with(
            ANY, "awsLambdaFailureDetails", {"lambdaFunctionFailures": failures, "successCount": 0}
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="401" endline="459" pcid="10309">
    def test_lambda_setup_layer_too_many_requests_exception(
        self, mock_react_view, mock_gen_aws_client, mock_get_supported_functions
    ):
        class MockException(Exception):
            pass

        too_many_requests_err = (
            "An error occurred (TooManyRequestsException) when calling the "
            "UpdateFunctionConfiguration operation (reached max retries: 4): "
            "Rate exceeded"
        )
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock(
            side_effect=Exception(too_many_requests_err)
        )
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})
        mock_client.exceptions = MagicMock()
        mock_client.exceptions.ResourceConflictException = MockException

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
            },
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        resp = self.client.post(
            self.setup_path,
            {"lambdaB": "true"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200
        assert not Integration.objects.filter(provider=self.provider.key).exists()

        failures = [
            {
                "name": "lambdaB",
                "error": "Something went wrong! Please enable function manually after installation",
            }
        ]

        mock_react_view.assert_called_with(
            ANY, "awsLambdaFailureDetails", {"lambdaFunctionFailures": failures, "successCount": 0}
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="463" endline="522" pcid="10310">
    def test_lambda_setup_layer_env_vars_limit_exceeded_exception(
        self, mock_react_view, mock_gen_aws_client, mock_get_supported_functions
    ):
        class MockException(Exception):
            pass

        env_vars_size_limit_err = (
            "An error occurred (InvalidParameterValueException) when calling the "
            "UpdateFunctionConfiguration operation: Lambda was unable to configure "
            "your environment variables because the environment variables you have "
            "provided exceeded the 4KB limit. String measured: {'MESSAGE':'This is production "
            "environment','TARGET_ENV' :'pre-production','IS_SERVERLESS':'true','STAGE':'pre-prod'"
        )
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock(
            side_effect=Exception(env_vars_size_limit_err)
        )
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})
        mock_client.exceptions = MagicMock()
        mock_client.exceptions.ResourceConflictException = MockException

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
            },
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        resp = self.client.post(
            self.setup_path,
            {"lambdaB": "true"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200
        assert not Integration.objects.filter(provider=self.provider.key).exists()

        failures = [
            {
                "name": "lambdaB",
                "error": "Environment variables size limit of 4KB was exceeded",
            }
        ]

        mock_react_view.assert_called_with(
            ANY, "awsLambdaFailureDetails", {"lambdaFunctionFailures": failures, "successCount": 0}
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/aws_lambda/test_integration.py" startline="341" endline="397" pcid="10308">
    def test_lambda_setup_layer_missing_role_error(
        self, mock_react_view, mock_gen_aws_client, mock_get_supported_functions
    ):
        class MockException(Exception):
            pass

        missing_role_err = (
            "An error occurred (InvalidParameterValueException) when "
            "calling the UpdateFunctionConfiguration operation: "
            "The role defined for the function cannot be "
            "assumed by Lambda."
        )
        mock_client = Mock()
        mock_gen_aws_client.return_value = mock_client
        mock_client.update_function_configuration = MagicMock(
            side_effect=Exception(missing_role_err)
        )
        mock_client.describe_account = MagicMock(return_value={"Account": {"Name": "my_name"}})
        mock_client.exceptions = MagicMock()
        mock_client.exceptions.ResourceConflictException = MockException

        mock_get_supported_functions.return_value = [
            {
                "FunctionName": "lambdaB",
                "Runtime": "nodejs10.x",
                "FunctionArn": "arn:aws:lambda:us-east-2:599817902985:function:lambdaB",
            },
        ]

        aws_external_id = "12-323"
        self.pipeline.state.step_index = 2
        self.pipeline.state.data = {
            "region": region,
            "account_number": account_number,
            "aws_external_id": aws_external_id,
            "project_id": self.projectA.id,
        }

        resp = self.client.post(
            self.setup_path,
            {"lambdaB": "true"},
            format="json",
            HTTP_ACCEPT="application/json",
            headers={"Content-Type": "application/json", "Accept": "application/json"},
        )

        assert resp.status_code == 200
        assert not Integration.objects.filter(provider=self.provider.key).exists()

        failures = [
            {"name": "lambdaB", "error": "Invalid role associated with the lambda function"}
        ]

        mock_react_view.assert_called_with(
            ANY, "awsLambdaFailureDetails", {"lambdaFunctionFailures": failures, "successCount": 0}
        )

</source>
</class>

<class classid="395" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_client.py" startline="130" endline="142" pcid="10339">
    def test_check_file(self):
        path = "src/file.py"
        ref = "537f2e94fbc489b2564ca3d6a5f0bd9afa38c3c3"
        responses.add(
            responses.HEAD,
            f"https://example.gitlab.com/api/v4/projects/{self.gitlab_id}/repository/files/src%2Ffile.py?ref={ref}",
            json={"text": 200},
        )

        resp = self.client.check_file(self.repo, path, ref)
        assert responses.calls[0].response.status_code == 200
        assert resp.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_client.py" startline="144" endline="155" pcid="10340">
    def test_check_no_file(self):
        path = "src/file.py"
        ref = "537f2e94fbc489b2564ca3d6a5f0bd9afa38c3c3"
        responses.add(
            responses.HEAD,
            f"https://example.gitlab.com/api/v4/projects/{self.gitlab_id}/repository/files/src%2Ffile.py?ref={ref}",
            status=404,
        )
        with self.assertRaises(ApiError):
            self.client.check_file(self.repo, path, ref)
        assert responses.calls[0].response.status_code == 404

</source>
</class>

<class classid="396" nclones="2" nlines="19" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="96" endline="117" pcid="10368">
    def test_push_event_multiple_organizations_one_missing_repo(self):
        # Create a repo on the primary organization
        repo = self.create_repo("getsentry/sentry")

        # Second org with no repo.
        other_org = self.create_organization(owner=self.user)
        self.integration.add_organization(other_org, self.user)

        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )
        assert response.status_code == 204
        commits = Commit.objects.all()
        assert len(commits) == 2
        for commit in commits:
            assert commit.organization_id == self.organization.id
            assert commit.repository_id == repo.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="118" endline="145" pcid="10369">
    def test_push_event_multiple_organizations(self):
        # Create a repo on the primary organization
        repo = self.create_repo("getsentry/sentry")

        # Second org with the same repo
        other_org = self.create_organization(owner=self.user)
        self.integration.add_organization(other_org, self.user)
        other_repo = self.create_repo("getsentry/sentry", organization_id=other_org.id)

        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )
        assert response.status_code == 204

        commits = Commit.objects.filter(repository_id=repo.id).all()
        assert len(commits) == 2
        for commit in commits:
            assert commit.organization_id == self.organization.id

        commits = Commit.objects.filter(repository_id=other_repo.id).all()
        assert len(commits) == 2
        for commit in commits:
            assert commit.organization_id == other_org.id

</source>
</class>

<class classid="397" nclones="3" nlines="17" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="280" endline="302" pcid="10377">
    def test_update_repo_name(self):
        repo_out_of_date_name = self.create_repo(
            name="Uncool Group / Sentry",  # name out of date
            url="http://example.com/cool-group/sentry",
        )
        repo_out_of_date_name.update(
            config=dict(repo_out_of_date_name.config, path="cool-group/sentry")
        )

        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )

        assert response.status_code == 204

        # name has been updated
        repo_out_of_date_name.refresh_from_db()
        assert repo_out_of_date_name.name == "Cool Group / Sentry"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="329" endline="350" pcid="10379">
    def test_update_repo_url(self):
        repo_out_of_date_url = self.create_repo(
            name="Cool Group / Sentry",
            url="http://example.com/uncool-group/sentry",  # url out of date
        )
        repo_out_of_date_url.update(
            config=dict(repo_out_of_date_url.config, path="cool-group/sentry")
        )

        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )

        assert response.status_code == 204

        # url has been updated
        repo_out_of_date_url.refresh_from_db()
        assert repo_out_of_date_url.url == "http://example.com/cool-group/sentry"
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_webhook.py" startline="304" endline="327" pcid="10378">
    def test_update_repo_path(self):
        repo_out_of_date_path = self.create_repo(
            name="Cool Group / Sentry", url="http://example.com/cool-group/sentry"
        )
        repo_out_of_date_path.update(
            config=dict(
                repo_out_of_date_path.config, path="uncool-group/sentry"  # path out of date
            )
        )

        response = self.client.post(
            self.url,
            data=PUSH_EVENT,
            content_type="application/json",
            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
            HTTP_X_GITLAB_EVENT="Push Hook",
        )

        assert response.status_code == 204

        # path has been updated
        repo_out_of_date_path.refresh_from_db()
        assert repo_out_of_date_path.config["path"] == "cool-group/sentry"

</source>
</class>

<class classid="398" nclones="2" nlines="40" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="45" endline="90" pcid="10383">
    def test_get_create_issue_config(self):
        group_description = (
            "Sentry Issue: [%s](%s)\n\n"
            "```\nStacktrace (most recent call first):\n\n"
            '  File "sentry/models/foo.py", line 29, in build_msg\n'
            "    string_max_length=self.string_max_length)\n\nmessage\n```"
        ) % (
            self.group.qualified_short_id,
            absolute_uri(self.group.get_absolute_url(params={"referrer": "gitlab_integration"})),
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/groups/%s/projects"
            % self.installation.model.metadata["group_id"],
            json=[
                {"name_with_namespace": "getsentry / sentry", "id": 1},
                {"name_with_namespace": "getsentry / hello", "id": 22},
            ],
        )
        assert self.installation.get_create_issue_config(self.group, self.user) == [
            {
                "url": "/extensions/gitlab/search/baz/%d/" % self.installation.model.id,
                "name": "project",
                "required": True,
                "type": "select",
                "label": "GitLab Project",
                "choices": [(1, "getsentry / sentry"), (22, "getsentry / hello")],
                "defaultValue": 1,
            },
            {
                "name": "title",
                "label": "Title",
                "default": self.group.get_latest_event().title,
                "type": "string",
                "required": True,
            },
            {
                "name": "description",
                "label": "Description",
                "default": group_description,
                "type": "textarea",
                "autosize": True,
                "maxRows": 10,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="336" endline="379" pcid="10389">
    def test_create_issue_no_projects(self):
        group_description = (
            "Sentry Issue: [%s](%s)\n\n"
            "```\nStacktrace (most recent call first):\n\n"
            '  File "sentry/models/foo.py", line 29, in build_msg\n'
            "    string_max_length=self.string_max_length)\n\nmessage\n```"
        ) % (
            self.group.qualified_short_id,
            absolute_uri(self.group.get_absolute_url(params={"referrer": "gitlab_integration"})),
        )

        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/groups/%s/projects"
            % self.installation.model.metadata["group_id"],
            json=[],
        )
        assert self.installation.get_create_issue_config(self.group, self.user) == [
            {
                "url": "/extensions/gitlab/search/baz/%d/" % self.installation.model.id,
                "name": "project",
                "required": True,
                "choices": [],
                "defaultValue": "",
                "type": "select",
                "label": "GitLab Project",
            },
            {
                "name": "title",
                "label": "Title",
                "default": self.group.get_latest_event().title,
                "type": "string",
                "required": True,
            },
            {
                "name": "description",
                "label": "Description",
                "default": group_description,
                "type": "textarea",
                "autosize": True,
                "maxRows": 10,
            },
        ]

</source>
</class>

<class classid="399" nclones="2" nlines="32" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="138" endline="173" pcid="10385">
    def test_create_issue(self):
        issue_iid = "1"
        project_id = "10"
        project_name = "getsentry/sentry"
        key = f"{project_name}#{issue_iid}"
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/%s/issues" % project_id,
            json={
                "id": 8,
                "iid": issue_iid,
                "title": "hello",
                "description": "This is the description",
                "web_url": f"https://example.gitlab.com/{project_name}/issues/{issue_iid}",
            },
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % project_id,
            json={"path_with_namespace": project_name, "id": 10},
        )
        form_data = {
            "project": project_id,
            "title": "hello",
            "description": "This is the description",
        }

        assert self.installation.create_issue(form_data) == {
            "key": key,
            "description": "This is the description",
            "title": "hello",
            "url": f"https://example.gitlab.com/{project_name}/issues/{issue_iid}",
            "project": project_id,
            "metadata": {"display_name": key},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="175" endline="205" pcid="10386">
    def test_get_issue(self):
        project_id = "12"
        project_name = "getsentry/sentry"
        issue_iid = "13"
        key = f"{project_name}#{issue_iid}"
        responses.add(
            responses.GET,
            f"https://example.gitlab.com/api/v4/projects/{project_id}/issues/{issue_iid}",
            json={
                "id": 18,
                "iid": issue_iid,
                "title": "hello",
                "description": "This is the description",
                "web_url": f"https://example.gitlab.com/{project_name}/issues/{issue_iid}",
            },
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % project_id,
            json={"id": project_id, "path_with_namespace": project_name},
        )

        assert self.installation.get_issue(issue_id=f"{project_id}#{issue_iid}", data={}) == {
            "key": key,
            "description": "This is the description",
            "title": "hello",
            "url": f"https://example.gitlab.com/{project_name}/issues/{issue_iid}",
            "project": project_id,
            "metadata": {"display_name": key},
        }

</source>
</class>

<class classid="400" nclones="2" nlines="57" similarity="98">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="207" endline="270" pcid="10387">
    def test_create_issue_default_project_in_group_api_call(self):
        group_description = (
            "Sentry Issue: [%s](%s)\n\n"
            "```\nStacktrace (most recent call first):\n\n"
            '  File "sentry/models/foo.py", line 29, in build_msg\n'
            "    string_max_length=self.string_max_length)\n\nmessage\n```"
        ) % (
            self.group.qualified_short_id,
            absolute_uri(self.group.get_absolute_url(params={"referrer": "gitlab_integration"})),
        )
        project_id = 10
        project_name = "This_is / a_project"
        org_integration = self.installation.org_integration
        org_integration.config["project_issue_defaults"] = {
            str(self.group.project_id): {"project": project_id}
        }
        org_integration.save()

        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/groups/%s/projects"
            % self.installation.model.metadata["group_id"],
            json=[
                {"name_with_namespace": "getsentry / sentry", "id": 1},
                {"name_with_namespace": project_name, "id": project_id},
                {"name_with_namespace": "getsentry / hello", "id": 22},
            ],
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % project_id,
            json={"path_with_namespace": project_name, "id": project_id},
        )
        assert self.installation.get_create_issue_config(self.group, self.user) == [
            {
                "url": "/extensions/gitlab/search/baz/%d/" % self.installation.model.id,
                "name": "project",
                "required": True,
                "choices": [
                    (1, "getsentry / sentry"),
                    (10, "This_is / a_project"),
                    (22, "getsentry / hello"),
                ],
                "defaultValue": project_id,
                "type": "select",
                "label": "GitLab Project",
            },
            {
                "name": "title",
                "label": "Title",
                "default": self.group.get_latest_event().title,
                "type": "string",
                "required": True,
            },
            {
                "name": "description",
                "label": "Description",
                "default": group_description,
                "type": "textarea",
                "autosize": True,
                "maxRows": 10,
            },
        ]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_issues.py" startline="272" endline="334" pcid="10388">
    def test_create_issue_default_project_not_in_api_call(self):
        group_description = (
            "Sentry Issue: [%s](%s)\n\n"
            "```\nStacktrace (most recent call first):\n\n"
            '  File "sentry/models/foo.py", line 29, in build_msg\n'
            "    string_max_length=self.string_max_length)\n\nmessage\n```"
        ) % (
            self.group.qualified_short_id,
            absolute_uri(self.group.get_absolute_url(params={"referrer": "gitlab_integration"})),
        )
        project_id = 10
        project_name = "This_is / a_project"
        org_integration = self.installation.org_integration
        org_integration.config["project_issue_defaults"] = {
            str(self.group.project_id): {"project": project_id}
        }
        org_integration.save()

        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/groups/%s/projects"
            % self.installation.model.metadata["group_id"],
            json=[
                {"name_with_namespace": "getsentry / sentry", "id": 1},
                {"name_with_namespace": "getsentry / hello", "id": 22},
            ],
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % project_id,
            json={"name_with_namespace": project_name, "id": project_id},
        )
        assert self.installation.get_create_issue_config(self.group, self.user) == [
            {
                "url": "/extensions/gitlab/search/baz/%d/" % self.installation.model.id,
                "name": "project",
                "required": True,
                "choices": [
                    (10, "This_is / a_project"),
                    (1, "getsentry / sentry"),
                    (22, "getsentry / hello"),
                ],
                "defaultValue": project_id,
                "type": "select",
                "label": "GitLab Project",
            },
            {
                "name": "title",
                "label": "Title",
                "default": self.group.get_latest_event().title,
                "type": "string",
                "required": True,
            },
            {
                "name": "description",
                "label": "Description",
                "default": group_description,
                "type": "textarea",
                "autosize": True,
                "maxRows": 10,
            },
        ]

</source>
</class>

<class classid="401" nclones="2" nlines="16" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="119" endline="139" pcid="10401">
    def test_create_repository_request_invalid_url(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % self.gitlab_id,
            status=200,
            json=self.default_repository_config,
        )
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/%s/hooks" % self.gitlab_id,
            status=422,
            json={"error": "Invalid url given"},
        )
        response = self.create_repository(
            self.default_repository_config, self.integration.id, add_responses=False
        )
        assert response.status_code == 400
        self.assert_error_message(
            response, "validation", "Error Communicating with GitLab (HTTP 422): Invalid url given"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="175" endline="190" pcid="10406">
    def test_create_repository_integration_create_webhook_failure(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s" % self.gitlab_id,
            json=self.default_repository_config,
        )
        responses.add(
            responses.POST,
            "https://example.gitlab.com/api/v4/projects/%s/hooks" % self.gitlab_id,
            status=503,
        )
        response = self.create_repository(
            self.default_repository_config, self.integration.id, add_responses=False
        )
        assert response.status_code == 503

</source>
</class>

<class classid="402" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="192" endline="204" pcid="10407">
    def test_on_delete_repository_remove_webhook(self):
        response = self.create_repository(self.default_repository_config, self.integration.id)
        responses.reset()

        responses.add(
            responses.DELETE,
            "https://example.gitlab.com/api/v4/projects/%s/hooks/99" % self.gitlab_id,
            status=204,
        )
        repo = Repository.objects.get(pk=response.data["id"])
        self.provider.on_delete_repository(repo)
        assert len(responses.calls) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="206" endline="218" pcid="10408">
    def test_on_delete_repository_remove_webhook_missing_hook(self):
        response = self.create_repository(self.default_repository_config, self.integration.id)
        responses.reset()

        responses.add(
            responses.DELETE,
            "https://example.gitlab.com/api/v4/projects/%s/hooks/99" % self.gitlab_id,
            status=404,
        )
        repo = Repository.objects.get(pk=response.data["id"])
        self.provider.on_delete_repository(repo)
        assert len(responses.calls) == 1

</source>
</class>

<class classid="403" nclones="2" nlines="27" similarity="79">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="220" endline="245" pcid="10409">
    def test_compare_commits_start_and_end(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/compare?from=abc&to=xyz"
            % self.gitlab_id,
            json=json.loads(COMPARE_RESPONSE),
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/12d65c8dd2b2676fa3ac47d955accc085a37a9c1/diff"
            % self.gitlab_id,
            json=json.loads(COMMIT_DIFF_RESPONSE),
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/8b090c1b79a14f2bd9e8a738f717824ff53aebad/diff"
            % self.gitlab_id,
            json=json.loads(COMMIT_DIFF_RESPONSE),
        )
        response = self.create_repository(self.default_repository_config, self.integration.id)
        repo = Repository.objects.get(pk=response.data["id"])
        commits = self.provider.compare_commits(repo, "abc", "xyz")
        assert 2 == len(commits)
        for commit in commits:
            assert_commit_shape(commit)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="260" endline="290" pcid="10411">
    def test_compare_commits_no_start(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/xyz" % self.gitlab_id,
            json={"created_at": "2018-09-19T13:14:15Z"},
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits?until=2018-09-19T13:14:15Z"
            % self.gitlab_id,
            json=json.loads(COMMIT_LIST_RESPONSE),
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/ed899a2f4b50b4370feeea94676502b42383c746/diff"
            % self.gitlab_id,
            json=json.loads(COMMIT_DIFF_RESPONSE),
        )
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/6104942438c14ec7bd21c6cd5bd995272b3faff6/diff"
            % self.gitlab_id,
            json=json.loads(COMMIT_DIFF_RESPONSE),
        )

        response = self.create_repository(self.default_repository_config, self.integration.id)
        repo = Repository.objects.get(pk=response.data["id"])
        commits = self.provider.compare_commits(repo, None, "xyz")
        for commit in commits:
            assert_commit_shape(commit)

</source>
</class>

<class classid="404" nclones="2" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="247" endline="258" pcid="10410">
    def test_compare_commits_start_and_end_gitlab_failure(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/compare?from=abc&to=xyz"
            % self.gitlab_id,
            status=502,
        )
        response = self.create_repository(self.default_repository_config, self.integration.id)
        repo = Repository.objects.get(pk=response.data["id"])
        with pytest.raises(IntegrationError):
            self.provider.compare_commits(repo, "abc", "xyz")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/gitlab/test_repository.py" startline="292" endline="302" pcid="10412">
    def test_compare_commits_no_start_gitlab_failure(self):
        responses.add(
            responses.GET,
            "https://example.gitlab.com/api/v4/projects/%s/repository/commits/abc" % self.gitlab_id,
            status=502,
        )
        response = self.create_repository(self.default_repository_config, self.integration.id)
        repo = Repository.objects.get(pk=response.data["id"])
        with pytest.raises(IntegrationError):
            self.provider.compare_commits(repo, None, "abc")

</source>
</class>

<class classid="405" nclones="5" nlines="19" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/cloudflare/test_webhook.py" startline="95" endline="122" pcid="10428">
    def test_prefills_data(self):
        webhook_data = json.loads(
            self.load_fixture("cloudflare/preview-webhook-authenticated.json")
        )
        webhook_data["install"]["options"]["organization"] = str(self.org.id)
        resp = self.post_webhook(data=webhook_data)

        assert resp.status_code == 200, resp.content
        assert resp.data["proceed"]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enum"] == [
            str(self.org.id)
        ]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enumNames"] == {
            str(self.org.id): self.org.slug
        }
        assert resp.data["install"]["options"]["organization"] == str(self.org.id)
        assert resp.data["install"]["schema"]["properties"]["project"]["enum"] == [
            str(self.project.id)
        ]
        assert resp.data["install"]["schema"]["properties"]["project"]["enumNames"] == {
            str(self.project.id): self.project.slug
        }
        assert resp.data["install"]["options"]["project"] == str(self.project.id)
        assert resp.data["install"]["schema"]["properties"]["dsn"]["enum"] == [
            self.key.get_dsn(public=True)
        ]
        assert resp.data["install"]["options"]["dsn"] == str(self.key.get_dsn(public=True))

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/cloudflare/test_webhook.py" startline="123" endline="147" pcid="10429">
    def test_multiple_projects(self):
        project2 = self.create_project(name="b", teams=[self.team])

        webhook_data = json.loads(
            self.load_fixture("cloudflare/preview-webhook-authenticated.json")
        )
        webhook_data["install"]["options"]["organization"] = str(self.org.id)
        resp = self.post_webhook(webhook_data)

        assert resp.status_code == 200, resp.content
        assert resp.data["proceed"]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enum"] == [
            str(self.org.id)
        ]
        assert resp.data["install"]["options"]["organization"] == str(self.org.id)
        assert resp.data["install"]["schema"]["properties"]["project"]["enum"] == [
            str(self.project.id),
            str(project2.id),
        ]
        assert resp.data["install"]["options"]["project"] == str(self.project.id)
        assert resp.data["install"]["schema"]["properties"]["dsn"]["enum"] == [
            self.key.get_dsn(public=True)
        ]
        assert resp.data["install"]["options"]["dsn"] == str(self.key.get_dsn(public=True))

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/cloudflare/test_webhook.py" startline="198" endline="220" pcid="10433">
    def test_with_invalid_organization_selected(self):
        webhook_data = json.loads(
            self.load_fixture("cloudflare/option-change-account-webhook.json")
        )
        webhook_data["install"]["options"]["organization"] = -1

        resp = self.post_webhook(webhook_data)

        assert resp.status_code == 200, resp.content
        assert resp.data["proceed"]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enum"] == [
            str(self.org.id)
        ]
        assert resp.data["install"]["options"]["organization"] == str(self.org.id)
        assert resp.data["install"]["schema"]["properties"]["project"]["enum"] == [
            str(self.project.id)
        ]
        assert resp.data["install"]["options"]["project"] == str(self.project.id)
        assert resp.data["install"]["schema"]["properties"]["dsn"]["enum"] == [
            self.key.get_dsn(public=True)
        ]
        assert resp.data["install"]["options"]["dsn"] == str(self.key.get_dsn(public=True))

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/cloudflare/test_webhook.py" startline="177" endline="197" pcid="10432">
    def test_prefills_data(self):
        webhook_data = json.loads(
            self.load_fixture("cloudflare/option-change-account-webhook.json")
        )
        resp = self.post_webhook(webhook_data)

        assert resp.status_code == 200, resp.content
        assert resp.data["proceed"]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enum"] == [
            str(self.org.id)
        ]
        assert resp.data["install"]["options"]["organization"] == str(self.org.id)
        assert resp.data["install"]["schema"]["properties"]["project"]["enum"] == [
            str(self.project.id)
        ]
        assert resp.data["install"]["options"]["project"] == str(self.project.id)
        assert resp.data["install"]["schema"]["properties"]["dsn"]["enum"] == [
            self.key.get_dsn(public=True)
        ]
        assert resp.data["install"]["options"]["dsn"] == str(self.key.get_dsn(public=True))

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/cloudflare/test_webhook.py" startline="221" endline="246" pcid="10434">
    def test_with_existing_project_selected_and_no_keys(self):
        project2 = self.create_project(name="b", teams=[self.team])
        # kill the automatically generated keys
        ProjectKey.objects.filter(project=project2).delete()

        webhook_data = json.loads(
            self.load_fixture("cloudflare/option-change-account-webhook.json")
        )
        webhook_data["install"]["options"]["organization"] = str(self.org.id)
        webhook_data["install"]["options"]["project"] = str(project2.id)

        resp = self.post_webhook(webhook_data)

        assert resp.status_code == 200, resp.content
        assert resp.data["proceed"]
        assert resp.data["install"]["schema"]["properties"]["organization"]["enum"] == [
            str(self.org.id)
        ]
        assert resp.data["install"]["options"]["organization"] == str(self.org.id)
        assert resp.data["install"]["schema"]["properties"]["project"]["enum"] == [
            str(self.project.id),
            str(project2.id),
        ]
        assert resp.data["install"]["options"]["project"] == str(project2.id)
        assert resp.data["install"]["schema"]["properties"]["dsn"]["enum"] == []
        assert "dsn" not in resp.data["install"]["options"]
</source>
</class>

<class classid="406" nclones="2" nlines="14" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="43" endline="62" pcid="10447">
    def test_with_data(self, *args):
        data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
        }
        self.pipeline.state.data = data
        resp = self.pipeline.finish_pipeline()

        self.assertDialogSuccess(resp)

        integration = Integration.objects.get(
            provider=self.provider.key, external_id=self.external_id
        )
        assert integration.name == data["name"]
        assert integration.metadata == data["metadata"]
        assert OrganizationIntegration.objects.filter(
            organization_id=self.organization.id, integration_id=integration.id
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="63" endline="81" pcid="10448">
    def test_aliased_integration_key(self, *args):
        self.provider = AliasedIntegrationProvider
        self.setUp()

        data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
        }
        self.pipeline.state.data = data
        resp = self.pipeline.finish_pipeline()

        self.assertDialogSuccess(resp)

        # Creates the Integration using ``integration_key`` instead of ``key``
        assert Integration.objects.filter(
            provider=self.provider.integration_key, external_id=self.external_id
        ).exists()

</source>
</class>

<class classid="407" nclones="3" nlines="33" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="155" endline="191" pcid="10452">
    def test_default_identity_does_update(self, *args):
        self.provider.needs_default_identity = True
        old_identity_id = 234567
        integration = Integration.objects.create(
            provider=self.provider.key,
            external_id=self.external_id,
            metadata={"url": "https://example.com"},
        )
        OrganizationIntegration.objects.create(
            organization=self.organization, integration=integration, default_auth_id=old_identity_id
        )
        self.pipeline.state.data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
            "user_identity": {
                "type": "plugin",
                "external_id": "AccountId",
                "scopes": [],
                "data": {
                    "access_token": "token12345",
                    "expires_in": "123456789",
                    "refresh_token": "refresh12345",
                    "token_type": "typetype",
                },
            },
        }

        resp = self.pipeline.finish_pipeline()
        self.assertDialogSuccess(resp)

        org_integration = OrganizationIntegration.objects.get(
            organization_id=self.organization.id, integration_id=integration.id
        )
        identity = Identity.objects.get(external_id="AccountId")
        assert org_integration.default_auth_id == identity.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="232" endline="272" pcid="10454">
    def test_new_external_id_same_user(self, *args):
        # we need to make sure any other org_integrations have the same
        # identity that we use for the new one
        self.provider.needs_default_identity = True
        integration = Integration.objects.create(
            provider=self.provider.key,
            external_id=self.external_id,
            metadata={"url": "https://example.com"},
        )
        identity_provider = IdentityProvider.objects.create(
            external_id=self.external_id, type="plugin"
        )
        identity = Identity.objects.create(
            idp_id=identity_provider.id, external_id="AccountId", user_id=self.user.id
        )
        org2 = self.create_organization(owner=self.user)
        integration.add_organization(org2, default_auth_id=identity.id)
        self.pipeline.state.data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
            "user_identity": {
                "type": "plugin",
                "external_id": "new_external_id",
                "scopes": [],
                "data": {
                    "access_token": "token12345",
                    "expires_in": "123456789",
                    "refresh_token": "refresh12345",
                    "token_type": "typetype",
                },
            },
        }
        resp = self.pipeline.finish_pipeline()
        self.assertDialogSuccess(resp)

        org_integrations = OrganizationIntegration.objects.filter(integration_id=integration.id)
        identity = Identity.objects.get(idp_id=identity_provider.id, external_id="new_external_id")
        for org_integration in org_integrations:
            assert org_integration.default_auth_id == identity.id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="192" endline="231" pcid="10453">
    def test_existing_identity_becomes_default_auth_on_new_orgintegration(self, *args):
        # The reinstall flow will result in an existing identity provider, identity
        # and integration records. Ensure that the new organizationintegration gets
        # a default_auth_id set.
        self.provider.needs_default_identity = True
        integration = Integration.objects.create(
            provider=self.provider.key,
            external_id=self.external_id,
            metadata={"url": "https://example.com"},
        )
        identity_provider = IdentityProvider.objects.create(
            external_id=self.external_id, type="plugin"
        )
        identity = Identity.objects.create(
            idp_id=identity_provider.id, external_id="AccountId", user_id=self.user.id
        )
        self.pipeline.state.data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
            "user_identity": {
                "type": "plugin",
                "external_id": "AccountId",
                "scopes": [],
                "data": {
                    "access_token": "token12345",
                    "expires_in": "123456789",
                    "refresh_token": "refresh12345",
                    "token_type": "typetype",
                },
            },
        }
        resp = self.pipeline.finish_pipeline()
        self.assertDialogSuccess(resp)

        org_integration = OrganizationIntegration.objects.get(
            organization_id=self.organization.id, integration_id=integration.id
        )
        assert org_integration.default_auth_id == identity.id

</source>
</class>

<class classid="408" nclones="2" nlines="26" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="273" endline="302" pcid="10455">
    def test_different_user_same_external_id_no_default_needed(self, *args):
        new_user = self.create_user()
        integration = Integration.objects.create(
            provider=self.provider.key,
            external_id=self.external_id,
            metadata={"url": "https://example.com"},
        )
        identity_provider = IdentityProvider.objects.create(
            external_id=self.external_id, type=self.provider.key
        )
        Identity.objects.create(
            idp_id=identity_provider.id, external_id="AccountId", user_id=new_user.id
        )
        self.pipeline.state.data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
            "user_identity": {
                "type": self.provider.key,
                "external_id": "AccountId",
                "scopes": [],
                "data": {},
            },
        }
        resp = self.pipeline.finish_pipeline()
        self.assertDialogSuccess(resp)
        assert OrganizationIntegration.objects.filter(
            integration_id=integration.id, organization=self.organization.id
        ).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_pipeline.py" startline="338" endline="365" pcid="10459">
    def test_different_user_same_external_id(self, *args):
        new_user = self.create_user()
        self.setUp()
        integration = Integration.objects.create(
            provider=self.provider.key,
            external_id=self.external_id,
            metadata={"url": "https://example.com"},
        )
        identity_provider = IdentityProvider.objects.create(
            external_id=self.external_id, type=self.provider.key
        )
        Identity.objects.create(
            idp_id=identity_provider.id, external_id="AccountId", user_id=new_user.id
        )
        self.pipeline.state.data = {
            "external_id": self.external_id,
            "name": "Name",
            "metadata": {"url": "https://example.com"},
            "user_identity": {
                "type": self.provider.key,
                "external_id": "AccountId",
                "scopes": [],
                "data": {},
            },
        }
        resp = self.pipeline.finish_pipeline()
        assert not OrganizationIntegration.objects.filter(integration_id=integration.id)
        assert "account is linked to a different Sentry user" in str(resp.content)
</source>
</class>

<class classid="409" nclones="2" nlines="20" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="121" endline="142" pcid="10463">
    def create_incident_and_related_objects(self, field="sessions"):
        self.alert_rule = self.create_alert_rule(
            query="",
            aggregate=f"percentage({field}_crashed, {field}) AS _crash_rate_alert_aggregate",
            dataset=QueryDatasets.SESSIONS,
            time_window=60,
        )
        self.incident = self.create_incident(
            self.organization,
            title="Incident #1",
            projects=[self.project],
            alert_rule=self.alert_rule,
            status=IncidentStatus.CLOSED.value,
            date_started=self.now - timedelta(minutes=120),
        )
        trigger = self.create_alert_rule_trigger(self.alert_rule, CRITICAL_TRIGGER_LABEL, 95)
        self.action = self.create_alert_rule_trigger_action(
            alert_rule_trigger=trigger, triggered_for_incident=self.incident
        )
        for _ in range(2):
            self.store_session(self.build_session(status="exited", started=self._5_min_ago))

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="222" endline="242" pcid="10469">
    def create_incident_and_related_objects(self, field="sessions"):
        self.alert_rule = self.create_alert_rule(
            query="",
            aggregate=f"percentage({field}_crashed, {field}) AS _crash_rate_alert_aggregate",
            dataset=QueryDatasets.METRICS,
            time_window=60,
        )
        self.incident = self.create_incident(
            self.organization,
            title="Incident #1",
            projects=[self.project],
            alert_rule=self.alert_rule,
            status=IncidentStatus.CLOSED.value,
            date_started=self.now - timedelta(minutes=120),
        )
        trigger = self.create_alert_rule_trigger(self.alert_rule, CRITICAL_TRIGGER_LABEL, 95)
        self.action = self.create_alert_rule_trigger_action(
            alert_rule_trigger=trigger, triggered_for_incident=self.incident
        )
        for _ in range(2):
            self.store_session(self.build_session(status="exited", started=self._5_min_ago))
</source>
</class>

<class classid="410" nclones="4" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="143" endline="155" pcid="10464">
    def test_with_incident_trigger_sessions(self):
        self.create_incident_and_related_objects()
        data = incident_attachment_info(self.incident, 92, self.action, method="fire")

        assert data["title"] == f"Critical: {self.alert_rule.name}"
        assert data["status"] == "Critical"
        assert data["text"] == "92% sessions crash free rate in the last 60 minutes"
        assert data["ts"] == self.date_started
        assert (
            data["logo_url"]
            == "http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="156" endline="167" pcid="10465">
    def test_with_incident_trigger_sessions_resolve(self):
        self.create_incident_and_related_objects()
        data = incident_attachment_info(self.incident, None, self.action, method="resolve")
        assert data["title"] == f"Resolved: {self.alert_rule.name}"
        assert data["status"] == "Resolved"
        assert data["text"] == "100.0% sessions crash free rate in the last 60 minutes"
        assert data["ts"] == self.date_started
        assert (
            data["logo_url"]
            == "http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="180" endline="191" pcid="10467">
    def test_with_incident_trigger_users_resolve(self):
        self.create_incident_and_related_objects(field="users")
        data = incident_attachment_info(self.incident, None, self.action, method="resolve")
        assert data["title"] == f"Resolved: {self.alert_rule.name}"
        assert data["status"] == "Resolved"
        assert data["text"] == "100.0% users crash free rate in the last 60 minutes"
        assert data["ts"] == self.date_started
        assert (
            data["logo_url"]
            == "http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/test_metric_alerts.py" startline="168" endline="179" pcid="10466">
    def test_with_incident_trigger_users(self):
        self.create_incident_and_related_objects(field="users")
        data = incident_attachment_info(self.incident, 92, self.action, method="fire")
        assert data["title"] == f"Critical: {self.alert_rule.name}"
        assert data["status"] == "Critical"
        assert data["text"] == "92% users crash free rate in the last 60 minutes"
        assert data["ts"] == self.date_started
        assert (
            data["logo_url"]
            == "http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png"
        )

</source>
</class>

<class classid="411" nclones="2" nlines="20" similarity="85">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="36" endline="61" pcid="10474">
    def test_no_upgrade_notice_bot_app(self):
        event = self.get_event()

        rule = self.get_rule(data={"workspace": self.integration.id, "channel": "#my-channel"})

        results = list(rule.after(event=event, state=self.get_state()))
        assert len(results) == 1

        responses.add(
            method=responses.POST,
            url="https://slack.com/api/chat.postMessage",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        # Trigger rule callback
        results[0].callback(event, futures=[])
        data = parse_qs(responses.calls[0].request.body)

        assert "attachments" in data
        attachments = json.loads(data["attachments"][0])

        assert len(attachments) == 1
        assert attachments[0]["title"] == event.title

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="367" endline="395" pcid="10487">
    def test_additional_attachment(self):
        manager.attachment_generators[ExternalProviders.SLACK] = additional_attachment_generator
        event = self.get_event()

        rule = self.get_rule(data={"workspace": self.integration.id, "channel": "#my-channel"})

        results = list(rule.after(event=event, state=self.get_state()))
        assert len(results) == 1

        responses.add(
            method=responses.POST,
            url="https://slack.com/api/chat.postMessage",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        # Trigger rule callback
        results[0].callback(event, futures=[])
        data = parse_qs(responses.calls[0].request.body)

        assert "attachments" in data
        attachments = json.loads(data["attachments"][0])

        assert len(attachments) == 2
        assert attachments[0]["title"] == event.title
        assert attachments[1]["title"] == self.organization.slug
        assert attachments[1]["text"] == self.integration.id

</source>
</class>

<class classid="412" nclones="2" nlines="12" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="62" endline="76" pcid="10475">
    def test_render_label(self):
        rule = self.get_rule(
            data={
                "workspace": self.integration.id,
                "channel": "#my-channel",
                "channel_id": "",
                "tags": "one, two",
            }
        )

        assert (
            rule.render_label()
            == "Send a notification to the Awesome Team Slack workspace to #my-channel (optionally, an ID: ) and show tags [one, two] in notification"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="77" endline="94" pcid="10476">
    def test_render_label_without_integration(self):
        self.integration.delete()

        rule = self.get_rule(
            data={
                "workspace": self.integration.id,
                "channel": "#my-channel",
                "channel_id": "",
                "tags": "",
            }
        )

        label = rule.render_label()
        assert (
            label
            == "Send a notification to the [removed] Slack workspace to #my-channel (optionally, an ID: ) and show tags [] in notification"
        )

</source>
</class>

<class classid="413" nclones="3" nlines="18" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="241" endline="260" pcid="10481">
    def test_channel_id_provided(self):
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.info",
            status=200,
            content_type="application/json",
            body=json.dumps({"ok": "true", "channel": {"name": "my-channel", "id": "C2349874"}}),
        )
        rule = self.get_rule(
            data={
                "workspace": self.integration.id,
                "channel": "#my-channel",
                "input_channel_id": "C2349874",
                "tags": "",
            }
        )

        form = rule.get_form_instance()
        assert form.is_valid()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="262" endline="282" pcid="10482">
    def test_invalid_channel_id_provided(self):
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.info",
            status=200,
            content_type="application/json",
            body=json.dumps({"ok": False, "error": "channel_not_found"}),
        )
        rule = self.get_rule(
            data={
                "workspace": self.integration.id,
                "channel": "#my-chanel",
                "input_channel_id": "C1234567",
                "tags": "",
            }
        )

        form = rule.get_form_instance()
        assert not form.is_valid()
        assert "Channel not found. Invalid ID provided." in str(form.errors.values())

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_notify_action.py" startline="284" endline="307" pcid="10483">
    def test_invalid_channel_name_provided(self):
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/conversations.info",
            status=200,
            content_type="application/json",
            body=json.dumps({"ok": "true", "channel": {"name": "my-channel", "id": "C2349874"}}),
        )
        rule = self.get_rule(
            data={
                "workspace": self.integration.id,
                "channel": "#my-chanel",
                "input_channel_id": "C1234567",
                "tags": "",
            }
        )

        form = rule.get_form_instance()
        assert not form.is_valid()
        assert (
            "Received channel name my-channel does not match inputted channel name my-chanel."
            in str(form.errors.values())
        )

</source>
</class>

<class classid="414" nclones="10" nlines="31" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="100" endline="132" pcid="10511">
    def test_unfurl_discover(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=title&field=event.type&field=project&field=user.display&field=timestamp&name=All+Events&project={self.project.id}&query=&sort=-timestamp&statsPeriod=24h"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(["organizations:discover-basic"]):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="204" endline="236" pcid="10514">
    def test_unfurl_discover_html_escaped(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=title&amp;field=event.type&amp;field=project&amp;field=user.display&amp;field=timestamp&amp;name=All+Events&amp;project={self.project.id}&amp;query=&amp;sort=-timestamp&amp;statsPeriod=24h"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(["organizations:discover-basic"]):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="169" endline="202" pcid="10513">
    def test_unfurl_discover_multi_y_axis(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=title&field=event.type&field=project&field=user.display&field=timestamp&name=All+Events&project={self.project.id}&query=&sort=-timestamp&statsPeriod=24h&yAxis=count_unique%28user%29&yAxis=count%28%29"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(["organizations:discover-basic"]):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1
        chart_data = mock_generate_chart.call_args[0][1]

        assert len(chart_data["stats"]["count()"]["data"]) == 288
        assert len(chart_data["stats"]["count_unique(user)"]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="134" endline="167" pcid="10512">
    def test_unfurl_discover_previous_period(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?display=previous&field=title&field=event.type&field=project&field=user.display&field=timestamp&name=All+Events&project={self.project.id}&query=&sort=-timestamp&statsPeriod=24h"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(["organizations:discover-basic"]):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1
        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_PREVIOUS_PERIOD
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"]["data"]) == 48

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="508" endline="545" pcid="10520">
    def test_unfurl_discover_without_project_ids(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=title&field=event.type&field=project&field=user.display&field=timestamp&name=All+Events&query=&sort=-timestamp&statsPeriod=24h"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="407" endline="451" pcid="10518">
    def test_top_daily_events_renders_bar_chart(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"message": "first", "fingerprint": ["group1"], "timestamp": min_ago},
            project_id=self.project.id,
        )
        self.store_event(
            data={"message": "second", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=message&field=event.type&field=count()&name=All+Events&query=message:[first,second]&sort=-count&statsPeriod=24h&display=dailytop5&topEvents=2"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1

        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_TOP5_DAILY
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"].keys()) == 2
        first_key = list(chart_data["stats"].keys())[0]
        # Two buckets
        assert len(chart_data["stats"][first_key]["data"]) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="362" endline="405" pcid="10517">
    def test_top_events_url_param(self, mock_generate_chart):
        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"message": "first", "fingerprint": ["group1"], "timestamp": min_ago},
            project_id=self.project.id,
        )
        self.store_event(
            data={"message": "second", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?field=message&field=event.type&field=count()&name=All+Events&query=message:[first,second]&sort=-count&statsPeriod=24h&display=top5&topEvents=2"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1

        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_TOP5_PERIOD
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count()"
        assert len(chart_data["stats"].keys()) == 2
        first_key = list(chart_data["stats"].keys())[0]
        assert len(chart_data["stats"][first_key]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="238" endline="299" pcid="10515">
    def test_unfurl_discover_short_url(self, mock_generate_chart):
        query = {
            "fields": ["message", "event.type", "project", "user.display", "count_unique(user)"],
            "query": "message:[first,second]",
            "yAxis": "count_unique(user)",
            "display": "top5",
            "topEvents": 2,
        }
        saved_query = DiscoverSavedQuery.objects.create(
            organization=self.organization,
            created_by=self.user,
            name="Test query",
            query=query,
            version=2,
        )
        saved_query.set_projects([self.project.id])

        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"message": "first", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )
        self.store_event(
            data={"message": "second", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?id={saved_query.id}&statsPeriod=24h&project={self.project.id}"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1

        # Line chart expected since yAxis is count_unique(user)
        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_TOP5_PERIOD_LINE
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count_unique(user)"
        # 2 + 1 cause of Other
        assert len(chart_data["stats"].keys()) == 2
        first_key = list(chart_data["stats"].keys())[0]
        assert len(chart_data["stats"][first_key]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="301" endline="360" pcid="10516">
    def test_unfurl_correct_y_axis_for_saved_query(self, mock_generate_chart):
        query = {
            "fields": [
                "message",
                "event.type",
                "project",
                "user.display",
                "p50(transaction.duration)",
            ],
        }
        saved_query = DiscoverSavedQuery.objects.create(
            organization=self.organization,
            created_by=self.user,
            name="Test query",
            query=query,
            version=2,
        )
        saved_query.set_projects([self.project.id])

        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"message": "first", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )
        self.store_event(
            data={"message": "second", "fingerprint": ["group2"], "timestamp": min_ago},
            project_id=self.project.id,
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?id={saved_query.id}&statsPeriod=24h&project={self.project.id}"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1

        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_TOTAL_PERIOD
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "p50(transaction.duration)"
        assert len(chart_data["stats"]["data"]) == 288

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_unfurl.py" startline="453" endline="506" pcid="10519">
    def test_unfurl_discover_short_url_without_project_ids(self, mock_generate_chart):
        query = {
            "fields": ["title", "event.type", "project", "user.display", "timestamp"],
            "query": "",
            "yAxis": "count_unique(users)",
        }
        saved_query = DiscoverSavedQuery.objects.create(
            organization=self.organization,
            created_by=self.user,
            name="Test query",
            query=query,
            version=2,
        )
        saved_query.set_projects([self.project.id])

        min_ago = iso_format(before_now(minutes=1))
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )
        self.store_event(
            data={"fingerprint": ["group2"], "timestamp": min_ago}, project_id=self.project.id
        )

        url = f"https://sentry.io/organizations/{self.organization.slug}/discover/results/?id={saved_query.id}&statsPeriod=24h"
        link_type, args = match_link(url)

        if not args or not link_type:
            raise Exception("Missing link_type/args")

        links = [
            UnfurlableUrl(url=url, args=args),
        ]

        with self.feature(
            [
                "organizations:discover",
                "organizations:discover-basic",
            ]
        ):
            unfurls = link_handlers[link_type].fn(self.request, self.integration, links, self.user)

        assert (
            unfurls[url]
            == SlackDiscoverMessageBuilder(
                title=args["query"].get("name"), chart_url="chart-url"
            ).build()
        )
        assert len(mock_generate_chart.mock_calls) == 1

        assert mock_generate_chart.call_args[0][0] == ChartType.SLACK_DISCOVER_TOTAL_PERIOD
        chart_data = mock_generate_chart.call_args[0][1]
        assert chart_data["seriesName"] == "count_unique(users)"
        assert len(chart_data["stats"]["data"]) == 288

</source>
</class>

<class classid="415" nclones="2" nlines="37" similarity="81">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="68" endline="110" pcid="10524">
    def test_task_new_rule(self, mock_set_value):
        data = {
            "name": "New Rule",
            "environment": None,
            "project": self.project,
            "action_match": "all",
            "filter_match": "all",
            "conditions": [
                {"id": "sentry.rules.conditions.first_seen_event.FirstSeenEventCondition"}
            ],
            "actions": [
                {
                    "channel": "#my-channel",
                    "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                    "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                    "tags": "",
                    "workspace": self.integration.id,
                }
            ],
            "frequency": 5,
            "uuid": self.uuid,
            "user_id": self.user.id,
        }

        with self.tasks():
            find_channel_id_for_rule(**data)

        rule = Rule.objects.exclude(label=DEFAULT_RULE_LABEL).get(project_id=self.project.id)
        mock_set_value.assert_called_with("success", rule.id)
        assert rule.label == "New Rule"
        # check that the channel_id got added
        assert rule.data["actions"] == [
            {
                "channel": "#my-channel",
                "channel_id": "chan-id",
                "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                "tags": "",
                "workspace": self.integration.id,
            }
        ]
        assert rule.created_by == self.user

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="113" endline="158" pcid="10525">
    def test_task_existing_rule(self, mock_set_value):
        action_data = {"id": "sentry.rules.actions.notify_event.NotifyEventAction"}
        condition_data = {"id": "sentry.rules.conditions.every_event.EveryEventCondition"}
        rule = Rule.objects.create(
            project=self.project, data={"actions": [action_data], "conditions": [condition_data]}
        )

        data = {
            "name": "Test Rule",
            "environment": None,
            "project": self.project,
            "action_match": "all",
            "filter_match": "all",
            "conditions": [condition_data],
            "actions": [
                {
                    "channel": "#my-channel",
                    "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                    "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                    "tags": "",
                    "workspace": self.integration.id,
                }
            ],
            "frequency": 5,
            "uuid": self.uuid,
            "rule_id": rule.id,
        }

        with self.tasks():
            find_channel_id_for_rule(**data)

        updated_rule = Rule.objects.get(id=rule.id)
        mock_set_value.assert_called_with("success", rule.id)
        assert updated_rule.label == "Test Rule"
        # check that the channel_id got added
        assert updated_rule.data["actions"] == [
            {
                "channel": "#my-channel",
                "channel_id": "chan-id",
                "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                "tags": "",
                "workspace": self.integration.id,
            }
        ]

</source>
</class>

<class classid="416" nclones="2" nlines="30" similarity="89">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="161" endline="195" pcid="10526">
    def test_task_failed_channel_id_lookup(self, mock_set_value):
        members = {"ok": "true", "members": [{"name": "morty", "id": "morty-id"}]}
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/users.list",
            status=200,
            content_type="application/json",
            body=json.dumps(members),
        )

        data = {
            "name": "Test Rule",
            "environment": None,
            "project": self.project,
            "action_match": "all",
            "filter_match": "all",
            "conditions": [{"id": "sentry.rules.conditions.every_event.EveryEventCondition"}],
            "actions": [
                {
                    "channel": "#some-channel",
                    "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                    "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                    "tags": "",
                    "workspace": self.integration.id,
                }
            ],
            "frequency": 5,
            "uuid": self.uuid,
        }

        with self.tasks():
            find_channel_id_for_rule(**data)

        mock_set_value.assert_called_with("failed")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="198" endline="232" pcid="10527">
    def test_task_rate_limited_channel_id_lookup(self, mock_set_value):
        """Should set the correct error value when rate limited"""
        responses.add(
            method=responses.GET,
            url="https://slack.com/api/users.list",
            status=429,
            content_type="application/json",
            body=json.dumps({"ok": "true", "error": "ratelimited"}),
        )

        data = {
            "name": "Test Rule",
            "environment": None,
            "project": self.project,
            "action_match": "all",
            "filter_match": "all",
            "conditions": [{"id": "sentry.rules.conditions.every_event.EveryEventCondition"}],
            "actions": [
                {
                    "channel": "@user",
                    "id": "sentry.integrations.slack.notify_action.SlackNotifyServiceAction",
                    "name": "Send a notification to the funinthesun Slack workspace to #secrets and show tags [] in notification",
                    "tags": "",
                    "workspace": self.integration.id,
                }
            ],
            "frequency": 5,
            "uuid": self.uuid,
        }

        with self.tasks():
            find_channel_id_for_rule(**data)

        mock_set_value.assert_called_with("failed", None, SLACK_RATE_LIMITED_MESSAGE)

</source>
</class>

<class classid="417" nclones="2" nlines="18" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="238" endline="259" pcid="10528">
    def test_task_new_alert_rule(self, mock_get_channel_id, mock_set_value):
        alert_rule_data = self.metric_alert_data

        data = {
            "data": alert_rule_data,
            "uuid": self.uuid,
            "organization_id": self.organization.id,
            "user_id": self.user.id,
        }

        with self.tasks():
            with self.feature(["organizations:incidents"]):
                find_channel_id_for_alert_rule(**data)

        rule = AlertRule.objects.get(name="New Rule")
        assert rule.created_by == self.user
        mock_set_value.assert_called_with("success", rule.id)
        mock_get_channel_id.assert_called_with(self.integration, "my-channel", 180)

        trigger_action = AlertRuleTriggerAction.objects.get(integration=self.integration.id)
        assert trigger_action.target_identifier == "chan-id"

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="309" endline="333" pcid="10531">
    def test_task_existing_metric_alert(self, mock_get_channel_id, mock_set_value):
        alert_rule_data = self.metric_alert_data
        alert_rule = self.create_alert_rule(
            organization=self.organization, projects=[self.project], name="New Rule", user=self.user
        )

        data = {
            "data": alert_rule_data,
            "uuid": self.uuid,
            "organization_id": self.organization.id,
            "alert_rule_id": alert_rule.id,
        }

        with self.tasks():
            with self.feature(["organizations:incidents"]):
                find_channel_id_for_alert_rule(**data)

        rule = AlertRule.objects.get(name="New Rule")
        mock_set_value.assert_called_with("success", rule.id)
        mock_get_channel_id.assert_called_with(self.integration, "my-channel", 180)

        trigger_action = AlertRuleTriggerAction.objects.get(integration=self.integration.id)
        assert trigger_action.target_identifier == "chan-id"
        assert AlertRule.objects.get(id=alert_rule.id)

</source>
</class>

<class classid="418" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="265" endline="281" pcid="10529">
    def test_task_failed_id_lookup(self, mock_get_channel_id, mock_set_value):
        alert_rule_data = self.metric_alert_data

        data = {
            "data": alert_rule_data,
            "uuid": self.uuid,
            "organization_id": self.organization.id,
        }

        with self.tasks():
            with self.feature(["organizations:incidents"]):
                find_channel_id_for_alert_rule(**data)

        assert not AlertRule.objects.filter(name="New Rule").exists()
        mock_set_value.assert_called_with("failed")
        mock_get_channel_id.assert_called_with(self.integration, "my-channel", 180)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="287" endline="303" pcid="10530">
    def test_task_timeout_id_lookup(self, mock_get_channel_id, mock_set_value):
        alert_rule_data = self.metric_alert_data

        data = {
            "data": alert_rule_data,
            "uuid": self.uuid,
            "organization_id": self.organization.id,
        }

        with self.tasks():
            with self.feature(["organizations:incidents"]):
                find_channel_id_for_alert_rule(**data)

        assert not AlertRule.objects.filter(name="New Rule").exists()
        mock_set_value.assert_called_with("failed")
        mock_get_channel_id.assert_called_with(self.integration, "my-channel", 180)

</source>
</class>

<class classid="419" nclones="2" nlines="18" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="336" endline="354" pcid="10532">
    def test_post_message_success(self, mock_log_info):
        responses.add(
            responses.POST,
            "https://slack.com/api/chat.postMessage",
            json={"ok": True},
            status=200,
        )
        with self.tasks():
            post_message.apply_async(
                kwargs={
                    "payload": {"key": ["val"]},
                    "log_error_message": "my_message",
                    "log_params": {"log_key": "log_value"},
                }
            )
        data = parse_qs(responses.calls[0].request.body)
        assert data == {"key": ["val"]}
        assert mock_log_info.call_count == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_tasks.py" startline="357" endline="376" pcid="10533">
    def test_post_message_failure(self, mock_log_info):
        responses.add(
            responses.POST,
            "https://slack.com/api/chat.postMessage",
            json={"ok": False, "error": "my_error"},
            status=200,
        )
        with self.tasks():
            post_message.apply_async(
                kwargs={
                    "payload": {"key": ["val"]},
                    "log_error_message": "my_message",
                    "log_params": {"log_key": "log_value"},
                }
            )
        data = parse_qs(responses.calls[0].request.body)
        assert data == {"key": ["val"]}
        mock_log_info.assert_called_once_with(
            "my_message", extra={"log_key": "log_value", "error": "my_error"}
        )
</source>
</class>

<class classid="420" nclones="3" nlines="16" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_link_team.py" startline="99" endline="122" pcid="10554">
    def test_link_team(self):
        """Test that we successfully link a team to a Slack channel"""
        response = self.get_success_response()
        self.assertTemplateUsed(response, "sentry/integrations/slack/link-team.html")

        response = self.get_success_response(data={"team": self.team.id})
        self.assertTemplateUsed(response, "sentry/integrations/slack/post-linked-team.html")

        external_actors = self.get_linked_teams()
        assert len(external_actors) == 1
        assert external_actors[0].actor_id == self.team.actor_id

        assert len(responses.calls) >= 1
        data = json.loads(str(responses.calls[0].request.body.decode("utf-8")))
        assert (
            f"The {self.team.slug} team will now receive issue alert notifications in the {external_actors[0].external_name} channel."
            in get_response_text(data)
        )

        team_settings = NotificationSetting.objects.filter(
            scope_type=NotificationScopeType.TEAM.value, target=self.team.actor.id
        )
        assert len(team_settings) == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_link_team.py" startline="178" endline="200" pcid="10559">
    def test_unlink_team(self):
        """Test that a team can be unlinked from a Slack channel"""
        response = self.get_success_response()
        self.assertTemplateUsed(response, "sentry/integrations/slack/unlink-team.html")

        response = self.get_success_response(data={})
        self.assertTemplateUsed(response, "sentry/integrations/slack/unlinked-team.html")

        external_actors = self.get_linked_teams()
        assert len(external_actors) == 0

        assert len(responses.calls) >= 1
        data = json.loads(str(responses.calls[0].request.body.decode("utf-8")))
        assert (
            f"This channel will no longer receive issue alert notifications for the {self.team.slug} team."
            in get_response_text(data)
        )

        team_settings = NotificationSetting.objects.filter(
            scope_type=NotificationScopeType.TEAM.value, target=self.team.actor.id
        )
        assert len(team_settings) == 0

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_link_team.py" startline="202" endline="235" pcid="10560">
    def test_unlink_multiple_teams(self):
        """
        Test that if you have linked multiple teams to a single channel, when
        you type `/sentry unlink team`, we unlink all teams from that channel.
        This should only apply to the one organization who did this before we
        blocked users from doing so.
        """
        team2 = self.create_team(organization=self.organization, name="Team Hellboy")
        self.link_team(team2)

        external_actors = self.get_linked_teams([self.team.actor_id, team2.actor_id])
        assert len(external_actors) == 2

        response = self.get_success_response()
        self.assertTemplateUsed(response, "sentry/integrations/slack/unlink-team.html")

        response = self.get_success_response(data={})
        self.assertTemplateUsed(response, "sentry/integrations/slack/unlinked-team.html")

        external_actors = self.get_linked_teams([self.team.actor_id, team2.actor_id])
        assert len(external_actors) == 0

        assert len(responses.calls) >= 1
        data = json.loads(str(responses.calls[0].request.body.decode("utf-8")))
        assert (
            f"This channel will no longer receive issue alert notifications for the {self.team.slug} team."
            in get_response_text(data)
        )

        team_settings = NotificationSetting.objects.filter(
            scope_type=NotificationScopeType.TEAM.value, target=self.team.actor.id
        )
        assert len(team_settings) == 0

</source>
</class>

<class classid="421" nclones="2" nlines="42" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="250" endline="301" pcid="10571">
    def test_resolve_issue(self):
        status_action = {"name": "resolve_dialog", "value": "resolve_dialog"}

        # Expect request to open dialog on slack
        responses.add(
            method=responses.POST,
            url="https://slack.com/api/dialog.open",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        resp = self.post_webhook(action_data=[status_action])
        assert resp.status_code == 200, resp.content

        # Opening dialog should *not* cause the current message to be updated
        assert resp.content == b""

        data = parse_qs(responses.calls[0].request.body)
        assert data["token"][0] == self.integration.metadata["access_token"]
        assert data["trigger_id"][0] == self.trigger_id
        assert "dialog" in data

        dialog = json.loads(data["dialog"][0])
        callback_data = json.loads(dialog["callback_id"])
        assert int(callback_data["issue"]) == self.group.id
        assert callback_data["orig_response_url"] == self.response_url

        # Completing the dialog will update the message
        responses.add(
            method=responses.POST,
            url=self.response_url,
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        resp = self.post_webhook(
            type="dialog_submission",
            callback_id=dialog["callback_id"],
            data={"submission": {"resolve_type": "resolved"}},
        )
        self.group = Group.objects.get(id=self.group.id)

        assert resp.status_code == 200, resp.content
        assert self.group.get_status() == GroupStatus.RESOLVED

        update_data = json.loads(responses.calls[1].request.body)

        expect_status = f"*Issue resolved by <@{self.external_id}>*"
        assert update_data["text"].endswith(expect_status)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="333" endline="392" pcid="10573">
    def test_handle_submission_fail(self):
        status_action = {"name": "resolve_dialog", "value": "resolve_dialog"}

        # Expect request to open dialog on slack
        responses.add(
            method=responses.POST,
            url="https://slack.com/api/dialog.open",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        resp = self.post_webhook(action_data=[status_action])
        assert resp.status_code == 200, resp.content

        # Opening dialog should *not* cause the current message to be updated
        assert resp.content == b""

        data = parse_qs(responses.calls[0].request.body)
        assert data["token"][0] == self.integration.metadata["access_token"]
        assert data["trigger_id"][0] == self.trigger_id
        assert "dialog" in data

        dialog = json.loads(data["dialog"][0])
        callback_data = json.loads(dialog["callback_id"])
        assert int(callback_data["issue"]) == self.group.id
        assert callback_data["orig_response_url"] == self.response_url

        # Completing the dialog will update the message
        responses.add(
            method=responses.POST,
            url=self.response_url,
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        # Remove the user from the organization.
        member = OrganizationMember.objects.get(user=self.user, organization=self.organization)
        member.remove_user()
        member.save()

        response = self.post_webhook(
            type="dialog_submission",
            callback_id=dialog["callback_id"],
            data={"submission": {"resolve_type": "resolved"}},
        )

        assert response.status_code == 200, response.content
        assert response.data["text"] == UNLINK_IDENTITY_MESSAGE.format(
            associate_url=build_unlinking_url(
                integration_id=self.integration.id,
                slack_id=self.external_id,
                channel_id="C065W1189",
                response_url=self.response_url,
            ),
            user_email=self.user.email,
            org_name=self.organization.name,
        )

</source>
</class>

<class classid="422" nclones="7" nlines="16" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="429" endline="455" pcid="10577">
    def test_approve_join_request(self):
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_JOIN.value,
        )

        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content

        member.refresh_from_db()
        assert member.invite_status == InviteStatus.APPROVED.value

        manage_url = absolute_uri(
            reverse("sentry-organization-members", args=[self.organization.slug])
        )
        assert (
            resp.data["text"]
            == f"Join request for hello@sentry.io has been approved. <{manage_url}|See Members and Requests>."
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="514" endline="533" pcid="10581">
    def test_invitation_validation_error(self):
        OrganizationMember.objects.filter(user=self.user).update(role="manager")
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="owner",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )
        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert (
            resp.data["text"]
            == "You do not have permission approve a member invitation with the role owner."
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="456" endline="480" pcid="10578">
    def test_rejected_invite_request(self):
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )

        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "reject_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert not OrganizationMember.objects.filter(id=member.id).exists()

        manage_url = absolute_uri(
            reverse("sentry-organization-members", args=[self.organization.slug])
        )
        assert (
            resp.data["text"]
            == f"Invite request for hello@sentry.io has been rejected. <{manage_url}|See Members and Requests>."
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="481" endline="497" pcid="10579">
    def test_invitation_removed(self):
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )
        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})
        member.delete()

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert resp.data["text"] == "Member invitation for hello@sentry.io no longer exists."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="498" endline="513" pcid="10580">
    def test_invitation_already_accepted(self):
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.APPROVED.value,
        )
        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert resp.data["text"] == "Member invitation for hello@sentry.io no longer exists."

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="558" endline="575" pcid="10584">
    def test_no_member_admin(self):
        OrganizationMember.objects.filter(user=self.user).update(role="admin")
        other_user = self.create_user()
        member = OrganizationMember.objects.create(
            organization=self.organization,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )
        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert resp.data["text"] == "You do not have permission to approve member invitations."


</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/endpoints/test_action.py" startline="541" endline="557" pcid="10583">
    def test_wrong_organization(self):
        other_user = self.create_user()
        another_org = self.create_organization()
        member = OrganizationMember.objects.create(
            organization=another_org,
            email="hello@sentry.io",
            role="member",
            inviter=other_user,
            invite_status=InviteStatus.REQUESTED_TO_BE_INVITED.value,
        )
        callback_id = json.dumps({"member_id": member.id, "member_email": "hello@sentry.io"})

        resp = self.post_webhook(action_data=[{"value": "approve_member"}], callback_id=callback_id)

        assert resp.status_code == 200, resp.content
        assert resp.data["text"] == "You do not have access to the organization for the invitation."

</source>
</class>

<class classid="423" nclones="6" nlines="19" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_note.py" startline="15" endline="43" pcid="10614">
    def test_note(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when a comment is made on an issue
        """
        notification = NoteActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.NOTE,
                data={"text": "text", "mentions": []},
            )
        )
        with self.tasks():
            notification.send()

        attachment, text = get_attachment()

        assert text == f"New comment by {self.name}"
        assert attachment["title"] == f"{self.group.title}"
        assert (
            attachment["title_link"]
            == f"http://testserver/organizations/{self.organization.slug}/issues/{self.group.id}/?referrer=note-activity-slack"
        )
        assert attachment["text"] == notification.activity.data["text"]
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=note-activity-slack-user|Notification Settings>"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_assigned.py" startline="125" endline="146" pcid="10622">
    def test_assignment(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when an issue is assigned
        """
        notification = AssignedActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.ASSIGNED,
                data={"assignee": self.user.id},
            )
        )
        with self.tasks():
            notification.send()
        attachment, text = get_attachment()
        assert text == f"Issue assigned to {self.name} by themselves"
        assert attachment["title"] == self.group.title
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=assigned-activity-slack-user|Notification Settings>"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_resolved.py" startline="15" endline="39" pcid="10615">
    def test_resolved(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when an issue is resolved
        """
        notification = ResolvedActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.SET_RESOLVED,
                data={"assignee": ""},
            )
        )
        with self.tasks():
            notification.send()

        attachment, text = get_attachment()
        assert (
            text
            == f"{self.name} marked <http://testserver/organizations/{self.organization.slug}/issues/{self.group.id}/?referrer=activity_notification|{self.short_id}> as resolved"
        )
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=resolved-activity-slack-user|Notification Settings>"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_unassigned.py" startline="15" endline="37" pcid="10618">
    def test_unassignment(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when an issue is unassigned
        """
        notification = UnassignedActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.ASSIGNED,
                data={"assignee": ""},
            )
        )
        with self.tasks():
            notification.send()

        attachment, text = get_attachment()
        assert text == f"Issue unassigned by {self.name}"
        assert attachment["title"] == self.group.title
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=unassigned-activity-slack-user|Notification Settings>"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_regression.py" startline="15" endline="36" pcid="10619">
    def test_regression(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when an issue regresses
        """
        notification = RegressionActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.SET_REGRESSION,
                data={},
            )
        )
        with self.tasks():
            notification.send()

        attachment, text = get_attachment()
        assert text == "Issue marked as regression"
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=regression-activity-slack-user|Notification Settings>"
        )
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_resolved_in_release.py" startline="15" endline="37" pcid="10616">
    def test_resolved_in_release(self, mock_func):
        """
        Test that a Slack message is sent with the expected payload when an issue is resolved in a release
        """
        notification = ResolvedInReleaseActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.SET_RESOLVED_IN_RELEASE,
                data={"version": "meow"},
            )
        )
        with self.tasks():
            notification.send()

        attachment, text = get_attachment()
        release_name = notification.activity.data["version"]
        assert text == f"Issue marked as resolved in {release_name} by {self.name}"
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=resolved-in-release-activity-slack-user|Notification Settings>"
        )
</source>
</class>

<class classid="424" nclones="2" nlines="44" similarity="84">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_assigned.py" startline="16" endline="69" pcid="10620">
    def test_multiple_identities(self, mock_func):
        """
        Test that we notify a user with multiple Identities in each place
        """
        integration2 = Integration.objects.create(
            provider="slack",
            name="Team B",
            external_id="TXXXXXXX2",
            metadata={
                "access_token": "xoxp-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx",
                "installation_type": "born_as_bot",
            },
        )
        integration2.add_organization(self.organization, self.user)
        idp2 = IdentityProvider.objects.create(type="slack", external_id="TXXXXXXX2", config={})
        identity2 = Identity.objects.create(
            external_id="UXXXXXXX2",
            idp=idp2,
            user=self.user,
            status=IdentityStatus.VALID,
            scopes=[],
        )
        # create a second response
        responses.add(
            method=responses.POST,
            url="https://slack.com/api/chat.postMessage",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        notification = AssignedActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.ASSIGNED,
                data={"assignee": self.user.id},
            )
        )
        with self.tasks():
            notification.send()

        assert len(responses.calls) >= 2
        data = parse_qs(responses.calls[0].request.body)
        assert "channel" in data
        channel = data["channel"][0]
        assert channel == self.identity.external_id

        data = parse_qs(responses.calls[1].request.body)
        assert "channel" in data
        channel = data["channel"][0]
        assert channel == identity2.external_id

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/notifications/test_assigned.py" startline="72" endline="122" pcid="10621">
    def test_multiple_orgs(self, mock_func):
        """
        Test that if a user is in 2 orgs with Slack and has an Identity linked in each,
        we're only going to notify them for the relevant org
        """
        org2 = self.create_organization(owner=self.user)
        integration2 = Integration.objects.create(
            provider="slack",
            name="Team B",
            external_id="TXXXXXXX2",
            metadata={
                "access_token": "xoxp-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx",
                "installation_type": "born_as_bot",
            },
        )
        integration2.add_organization(org2, self.user)
        idp2 = IdentityProvider.objects.create(type="slack", external_id="TXXXXXXX2", config={})
        Identity.objects.create(
            external_id="UXXXXXXX2",
            idp=idp2,
            user=self.user,
            status=IdentityStatus.VALID,
            scopes=[],
        )
        # create a second response that won't actually be used, but here to make sure it's not a false positive
        responses.add(
            method=responses.POST,
            url="https://slack.com/api/chat.postMessage",
            body='{"ok": true}',
            status=200,
            content_type="application/json",
        )

        notification = AssignedActivityNotification(
            Activity(
                project=self.project,
                group=self.group,
                user=self.user,
                type=ActivityType.ASSIGNED,
                data={"assignee": self.user.id},
            )
        )
        with self.tasks():
            notification.send()

        assert len(responses.calls) == 1
        data = parse_qs(responses.calls[0].request.body)
        assert "channel" in data
        channel = data["channel"][0]
        assert channel == self.identity.external_id

</source>
</class>

<class classid="425" nclones="3" nlines="14" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_requests.py" startline="16" endline="31" pcid="10624">
    def setUp(self):
        super().setUp()

        self.request = mock.Mock()
        self.request.data = {
            "type": "foo",
            "team_id": "T001",
            "channel": {"id": "1"},
            "user": {"id": "2"},
            "api_app_id": "S1",
        }
        self.request.body = urlencode(self.request.data).encode("utf-8")
        self.request.META = set_signing_secret(
            options.get("slack.signing-secret"), self.request.body
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_requests.py" startline="92" endline="109" pcid="10635">
    def setUp(self):
        super().setUp()

        self.request = mock.Mock()
        self.request.data = {
            "type": "foo",
            "team_id": "T001",
            "event_id": "E1",
            "event": {"type": "bar"},
            "channel": {"id": "1"},
            "user": {"id": "2"},
            "api_app_id": "S1",
        }
        self.request.body = urlencode(self.request.data).encode("utf-8")
        self.request.META = set_signing_secret(
            options.get("slack.signing-secret"), self.request.body
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/slack/test_requests.py" startline="175" endline="195" pcid="10644">
    def setUp(self):
        super().setUp()

        self.request = mock.Mock()
        self.request.data = {
            "payload": json.dumps(
                {
                    "type": "foo",
                    "team": {"id": "T001"},
                    "channel": {"id": "1"},
                    "user": {"id": "2"},
                    "token": options.get("slack.verification-token"),
                    "callback_id": '{"issue":"I1"}',
                }
            )
        }
        self.request.body = urlencode(self.request.data).encode("utf-8")
        self.request.META = set_signing_secret(
            options.get("slack.signing-secret"), self.request.body
        )

</source>
</class>

<class classid="426" nclones="2" nlines="19" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_notify_action.py" startline="95" endline="122" pcid="10656">
    def test_valid_member_selected(self):
        rule = self.get_rule(data={"team": self.integration.id, "channel": "Darth Vader"})

        channels = [{"id": "i_s_d", "name": "Imperial Star Destroyer"}]

        responses.add(
            method=responses.GET,
            url="https://smba.trafficmanager.net/amer/v3/teams/D4r7h_Pl4gu315_th3_w153/conversations",
            json={"conversations": channels},
        )

        members = [{"name": "Darth Vader", "id": "d_v", "tenantId": "1428-5714-2857"}]

        responses.add(
            method=responses.GET,
            url="https://smba.trafficmanager.net/amer/v3/conversations/D4r7h_Pl4gu315_th3_w153/pagedmembers?pageSize=500",
            json={"members": members},
        )

        responses.add(
            method=responses.POST,
            url="https://smba.trafficmanager.net/amer/v3/conversations",
            json={"id": "i_am_your_father"},
        )

        form = rule.get_form_instance()
        self.assert_form_valid(form, "i_am_your_father", "Darth Vader")

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_notify_action.py" startline="124" endline="146" pcid="10657">
    def test_invalid_channel_selected(self):
        rule = self.get_rule(data={"team": self.integration.id, "channel": "Alderaan"})

        channels = [{"name": "Hoth", "id": "hh"}]

        responses.add(
            method=responses.GET,
            url="https://smba.trafficmanager.net/amer/v3/teams/D4r7h_Pl4gu315_th3_w153/conversations",
            json={"conversations": channels},
        )

        members = [{"name": "Darth Sidious", "id": "d_s", "tenantId": "0102-0304-0506"}]

        responses.add(
            method=responses.GET,
            url="https://smba.trafficmanager.net/amer/v3/conversations/D4r7h_Pl4gu315_th3_w153/pagedmembers?pageSize=500",
            json={"members": members},
        )

        form = rule.get_form_instance()

        assert not form.is_valid()
        assert len(form.errors) == 1
</source>
</class>

<class classid="427" nclones="2" nlines="40" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_link_identity.py" startline="46" endline="96" pcid="10679">
    def test_basic_flow(self, unsign):
        unsign.return_value = {
            "integration_id": self.integration.id,
            "organization_id": self.org.id,
            "teams_user_id": "a_p_w_b_d",
            "team_id": "1_50l3mnly_5w34r",
            "tenant_id": "h0g5m34d3",
        }

        linking_url = build_linking_url(
            self.integration,
            self.org,
            "a_p_w_b_d",
            "1_50l3mnly_5w34r",
            "h0g5m34d3",
        )

        resp = self.client.get(linking_url)

        assert resp.status_code == 200
        self.assertTemplateUsed(resp, "sentry/auth-link-identity.html")

        def user_conversation_id_callback(request):
            payload = json.loads(request.body)
            if payload["members"] == [{"id": "a_p_w_b_d"}] and payload["channelData"] == {
                "tenant": {"id": "h0g5m34d3"}
            }:
                return (200, {}, json.dumps({"id": "dumbl3d0r3"}))

        responses.add_callback(
            method=responses.POST,
            url="https://smba.trafficmanager.net/amer/v3/conversations",
            callback=user_conversation_id_callback,
        )

        responses.add(
            method=responses.POST,
            url="https://smba.trafficmanager.net/amer/v3/conversations/dumbl3d0r3/activities",
            status=200,
            json={},
        )

        resp = self.client.post(linking_url)

        identity = Identity.objects.filter(external_id="a_p_w_b_d", user=self.user1)

        assert len(identity) == 1
        assert identity[0].idp == self.idp
        assert identity[0].status == IdentityStatus.VALID
        assert len(responses.calls) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_link_identity.py" startline="99" endline="148" pcid="10681">
    def test_overwrites_existing_identities(self, unsign):
        Identity.objects.create(
            user=self.user1, idp=self.idp, external_id="h_p", status=IdentityStatus.VALID
        )
        Identity.objects.create(
            user=self.user2, idp=self.idp, external_id="g_w", status=IdentityStatus.VALID
        )

        unsign.return_value = {
            "integration_id": self.integration.id,
            "organization_id": self.org.id,
            "teams_user_id": "g_w",
            "team_id": "1_50l3mnly_5w34r",
            "tenant_id": "th3_burr0w",
        }

        linking_url = build_linking_url(
            self.integration,
            self.org,
            "g_w",
            "1_50l3mnly_5w34r",
            "th3_burr0w",
        )

        def user_conversation_id_callback(request):
            payload = json.loads(request.body)
            if payload["members"] == [{"id": "g_w"}] and payload["channelData"] == {
                "tenant": {"id": "th3_burr0w"}
            }:
                return (200, {}, json.dumps({"id": "g1nny_w345l3y"}))
            return (404, {}, json.dumps({}))

        responses.add_callback(
            method=responses.POST,
            url="https://smba.trafficmanager.net/amer/v3/conversations",
            callback=user_conversation_id_callback,
        )

        responses.add(
            method=responses.POST,
            url="https://smba.trafficmanager.net/amer/v3/conversations/g1nny_w345l3y/activities",
            status=200,
            json={},
        )

        self.client.post(linking_url)

        Identity.objects.get(external_id="g_w", user=self.user1)
        assert not Identity.objects.filter(external_id="h_p", user=self.user1).exists()
        assert not Identity.objects.filter(external_id="g_w", user=self.user2).exists()
</source>
</class>

<class classid="428" nclones="7" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="83" endline="94" pcid="10686">
    def test_decode_token_fails(self, mock_decode):
        mock_decode.side_effect = jwt.DecodeError("fail")
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_TEAM_MEMBER_ADDED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.data["detail"] == "Could not validate JWT. Got fail"
        assert resp.status_code == 403

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="112" endline="124" pcid="10688">
    def test_service_url_does_not_match(self, mock_decode):
        bad_token = DECODED_TOKEN.copy()
        bad_token["serviceurl"] = "bad"
        mock_decode.return_value = bad_token
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_TEAM_MEMBER_ADDED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )
        assert resp.data["detail"] == "The field serviceUrl does not match"
        assert resp.status_code == 403

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="128" endline="140" pcid="10689">
    def test_expired_token(self, mock_time, mock_decode):
        mock_time.return_value = 1594839999 + 6 * 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_TEAM_MEMBER_ADDED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.data["detail"] == "Token is expired"
        assert resp.status_code == 403

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="97" endline="109" pcid="10687">
    def test_iss_does_not_match(self, mock_decode):
        bad_token = DECODED_TOKEN.copy()
        bad_token["iss"] = "bad"
        mock_decode.return_value = bad_token
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_TEAM_MEMBER_ADDED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )
        assert resp.data["detail"] == "The field iss does not match"
        assert resp.status_code == 403

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="215" endline="228" pcid="10692">
    def test_member_removed(self, mock_time, mock_decode):
        integration = Integration.objects.create(external_id=team_id, provider="msteams")
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_TEAM_MEMBER_REMOVED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert not Integration.objects.filter(id=integration.id)

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="310" endline="326" pcid="10696">
    def test_different_user_mentioned(self, mock_time, mock_decode):
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN

        different_user_mentioned = deepcopy(EXAMPLE_MENTIONED)
        different_user_mentioned["entities"][0]["mentioned"]["id"] = "28:another-id"

        resp = self.client.post(
            path=webhook_url,
            data=different_user_mentioned,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert len(responses.calls) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="231" endline="246" pcid="10693">
    def test_different_member_removed(self, mock_time, mock_decode):
        different_member_removed = deepcopy(EXAMPLE_TEAM_MEMBER_REMOVED)
        different_member_removed["membersRemoved"][0]["id"] = "28:another-id"
        integration = Integration.objects.create(external_id=team_id, provider="msteams")
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=different_member_removed,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert Integration.objects.filter(id=integration.id)

</source>
</class>

<class classid="429" nclones="8" nlines="25" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="185" endline="212" pcid="10691">
    def test_different_member_added(self, mock_time, mock_decode):
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities" % team_id,
            json={},
        )

        different_member_added = deepcopy(EXAMPLE_TEAM_MEMBER_ADDED)
        different_member_added["membersAdded"][0]["id"] = "28:another-id"

        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=different_member_added,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert len(responses.calls) == 2

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="330" endline="357" pcid="10697">
    def test_unlink_user(self, mock_time, mock_decode):
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % EXAMPLE_UNLINK_COMMAND["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_UNLINK_COMMAND,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert "Click below to unlink your identity" in responses.calls[3].request.body.decode(
            "utf-8"
        )
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="464" endline="492" pcid="10701">
    def test_other_command(self, mock_time, mock_decode):
        other_command = deepcopy(EXAMPLE_UNLINK_COMMAND)
        other_command["text"] = "other"
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % other_command["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=other_command,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert "Sorry, I didn't understand 'other'" in responses.calls[3].request.body.decode(
            "utf-8"
        )
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]
</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="394" endline="424" pcid="10699">
    def test_link_command(self, mock_time, mock_decode):
        other_command = deepcopy(EXAMPLE_UNLINK_COMMAND)
        other_command["text"] = "link"
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % other_command["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=other_command,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert (
            "Your Microsoft Teams identity will be linked to your Sentry account"
            in responses.calls[3].request.body.decode("utf-8")
        )
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="250" endline="275" pcid="10694">
    def test_personal_member_added(self, mock_time, mock_decode):
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % EXAMPLE_PERSONAL_MEMBER_ADDED["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_PERSONAL_MEMBER_ADDED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert "Personal Installation of Sentry" in responses.calls[3].request.body.decode("utf-8")
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="361" endline="390" pcid="10698">
    def test_help_command(self, mock_time, mock_decode):
        other_command = deepcopy(EXAMPLE_UNLINK_COMMAND)
        other_command["text"] = "Help"
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % other_command["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=other_command,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert "Please use one of the following commands for Sentry" in responses.calls[
            3
        ].request.body.decode("utf-8")
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="279" endline="306" pcid="10695">
    def test_mentioned(self, mock_time, mock_decode):
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % EXAMPLE_PERSONAL_MEMBER_ADDED["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=EXAMPLE_MENTIONED,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert "Sentry for Microsoft Teams does not support any commands" in responses.calls[
            3
        ].request.body.decode("utf-8")
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/msteams/test_webhook.py" startline="428" endline="460" pcid="10700">
    def test_link_command_already_linked(self, mock_time, mock_decode):
        other_command = deepcopy(EXAMPLE_UNLINK_COMMAND)
        other_command["text"] = "link"
        idp = IdentityProvider.objects.create(type="msteams", external_id=team_id, config={})
        Identity.objects.create(external_id=other_command["from"]["id"], idp=idp, user=self.user)
        access_json = {"expires_in": 86399, "access_token": "my_token"}
        responses.add(
            responses.POST,
            "https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token",
            json=access_json,
        )
        responses.add(
            responses.POST,
            "https://smba.trafficmanager.net/amer/v3/conversations/%s/activities"
            % other_command["conversation"]["id"],
            json={},
        )
        mock_time.return_value = 1594839999 + 60
        mock_decode.return_value = DECODED_TOKEN
        resp = self.client.post(
            path=webhook_url,
            data=other_command,
            format="json",
            HTTP_AUTHORIZATION=f"Bearer {TOKEN}",
        )

        assert resp.status_code == 204
        assert (
            "Your Microsoft Teams identity is already linked to a Sentry account"
            in responses.calls[3].request.body.decode("utf-8")
        )
        assert "Bearer my_token" in responses.calls[3].request.headers["Authorization"]

</source>
</class>

<class classid="430" nclones="4" nlines="16" similarity="72">
<source file="systems/sentry-22.2.0/tests/sentry/notifications/test_notifications.py" startline="98" endline="129" pcid="10856">
    def test_sends_note_notification(self):
        """
        Test that an email AND Slack notification are sent with
        the expected values when a comment is created on an issue.
        """

        # leave a comment
        url = f"/api/0/issues/{self.group.id}/comments/"
        with self.tasks():
            response = self.client.post(url, format="json", data={"text": "blah blah"})
        assert response.status_code == 201, response.content

        msg = mail.outbox[0]
        # check the txt version
        assert "blah blah" in msg.body
        # check the html version
        assert "blah blah</p></div>" in msg.alternatives[0][0]

        attachment, text = get_attachment()
        # check the Slack version
        assert text == f"New comment by {self.name}"
        assert attachment["title"] == f"{self.group.title}"
        assert (
            attachment["title_link"]
            == f"http://testserver/organizations/{self.organization.slug}/issues/{self.group.id}/?referrer=note-activity-slack"
        )
        assert attachment["text"] == "blah blah"
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=note-activity-slack-user|Notification Settings>"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/test_notifications.py" startline="158" endline="185" pcid="10858">
    def test_sends_unassignment_notification(self):
        """
        Test that an email AND Slack notification are sent with
        the expected values when an issue is unassigned.
        """
        url = f"/api/0/issues/{self.group.id}/"
        GroupAssignee.objects.create(
            group=self.group, project=self.project, user=self.user, date_added=timezone.now()
        )
        with self.tasks():
            response = self.client.put(url, format="json", data={"assignedTo": ""})
        assert response.status_code == 200, response.content

        msg = mail.outbox[0]
        # check the txt version
        assert f"Unassigned\n\n{self.user.username} unassigned {self.short_id}" in msg.body
        # check the html version
        assert f"{self.user.username}</strong> unassigned" in msg.alternatives[0][0]

        attachment, text = get_attachment()

        assert text == f"Issue unassigned by {self.name}"
        assert attachment["title"] == self.group.title
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=unassigned-activity-slack-user|Notification Settings>"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/test_notifications.py" startline="187" endline="214" pcid="10859">
    def test_sends_resolution_notification(self):
        """
        Test that an email AND Slack notification are sent with
        the expected values when an issue is resolved.
        """
        url = f"/api/0/issues/{self.group.id}/"
        with self.tasks():
            response = self.client.put(url, format="json", data={"status": "resolved"})
        assert response.status_code == 200, response.content

        msg = mail.outbox[0]
        # check the txt version
        assert f"{self.user.username} marked {self.short_id} as resolved" in msg.body
        # check the html version
        assert f"{self.short_id}</a> as resolved</p>" in msg.alternatives[0][0]

        attachment, text = get_attachment()

        assert (
            text
            == f"{self.name} marked <http://testserver/organizations/{self.organization.slug}/issues/{self.group.id}/?referrer=activity_notification|{self.short_id}> as resolved"
        )
        assert attachment["title"] == self.group.title
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=resolved-activity-slack-user|Notification Settings>"
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/test_notifications.py" startline="131" endline="156" pcid="10857">
    def test_sends_assignment_notification(self):
        """
        Test that an email AND Slack notification are sent with
        the expected values when an issue is assigned.
        """

        url = f"/api/0/issues/{self.group.id}/"
        with self.tasks():
            response = self.client.put(url, format="json", data={"assignedTo": self.user.username})
        assert response.status_code == 200, response.content

        msg = mail.outbox[0]
        # check the txt version
        assert f"assigned {self.short_id} to themselves" in msg.body
        # check the html version
        assert f"{self.short_id}</a> to themselves</p>" in msg.alternatives[0][0]

        attachment, text = get_attachment()

        assert text == f"Issue assigned to {self.name} by themselves"
        assert attachment["title"] == self.group.title
        assert (
            attachment["footer"]
            == f"{self.project.slug} | <http://testserver/settings/account/notifications/workflow/?referrer=assigned-activity-slack-user|Notification Settings>"
        )

</source>
</class>

<class classid="431" nclones="5" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_get_setting_mapping_from_mapping.py" startline="17" endline="34" pcid="10869">
    def test_get_setting_mapping_from_mapping_issue_alerts(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS
                }
            }
        }
        mapping = _get_setting_mapping_from_mapping(
            notification_settings,
            self.user,
            NotificationSettingTypes.ISSUE_ALERTS,
        )
        assert mapping == {
            ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS,
            ExternalProviders.SLACK: NotificationSettingOptionValues.NEVER,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_get_setting_mapping_from_mapping.py" startline="35" endline="52" pcid="10870">
    def test_get_setting_mapping_from_mapping_deploy(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.EMAIL: NotificationSettingOptionValues.COMMITTED_ONLY
                }
            }
        }
        mapping = _get_setting_mapping_from_mapping(
            notification_settings,
            self.user,
            NotificationSettingTypes.DEPLOY,
        )
        assert mapping == {
            ExternalProviders.EMAIL: NotificationSettingOptionValues.COMMITTED_ONLY,
            ExternalProviders.SLACK: NotificationSettingOptionValues.NEVER,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_get_setting_mapping_from_mapping.py" startline="53" endline="70" pcid="10871">
    def test_get_setting_mapping_from_mapping_workflow(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.EMAIL: NotificationSettingOptionValues.SUBSCRIBE_ONLY
                }
            }
        }
        mapping = _get_setting_mapping_from_mapping(
            notification_settings,
            self.user,
            NotificationSettingTypes.WORKFLOW,
        )
        assert mapping == {
            ExternalProviders.EMAIL: NotificationSettingOptionValues.SUBSCRIBE_ONLY,
            ExternalProviders.SLACK: NotificationSettingOptionValues.NEVER,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_get_setting_mapping_from_mapping.py" startline="99" endline="117" pcid="10874">
    def test_get_setting_mapping_from_mapping_slack_always(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.SLACK: NotificationSettingOptionValues.ALWAYS
                }
            }
        }

        mapping = _get_setting_mapping_from_mapping(
            notification_settings,
            self.user,
            NotificationSettingTypes.ISSUE_ALERTS,
        )
        assert mapping == {
            ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS,
            ExternalProviders.SLACK: NotificationSettingOptionValues.ALWAYS,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_get_setting_mapping_from_mapping.py" startline="80" endline="98" pcid="10873">
    def test_get_setting_mapping_from_mapping_slack_never(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.SLACK: NotificationSettingOptionValues.NEVER
                }
            }
        }

        mapping = _get_setting_mapping_from_mapping(
            notification_settings,
            self.user,
            NotificationSettingTypes.ISSUE_ALERTS,
        )
        assert mapping == {
            ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS,
            ExternalProviders.SLACK: NotificationSettingOptionValues.NEVER,
        }

</source>
</class>

<class classid="432" nclones="2" nlines="16" similarity="76">
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_tasks.py" startline="26" endline="41" pcid="10887">
    def test_call_task(self, mock_delay):
        register()(AnotherDummyNotification)
        async_send_notification(AnotherDummyNotification, self.organization, "some_value")
        assert mock_delay.called_with(
            "AnotherDummyNotification",
            [
                {
                    "type": "model",
                    "app_label": "sentry",
                    "model_name": "organization",
                    "pk": self.organization.pk,
                },
                {"type": "other", "value": "some_value"},
            ],
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_tasks.py" startline="45" endline="63" pcid="10888">
    def test_send_notification(self, notification):
        notification.__name__ = "AnotherDummyNotification"
        register()(notification)

        _send_notification(
            "AnotherDummyNotification",
            [
                {
                    "type": "model",
                    "app_label": "sentry",
                    "model_name": "organization",
                    "pk": self.organization.pk,
                },
                {"type": "other", "value": "some_value"},
            ],
        )
        assert notification.call_args.args == (self.organization, "some_value")
        notification.return_value.send.assert_called_once_with()

</source>
</class>

<class classid="433" nclones="2" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_should_be_participating.py" startline="57" endline="75" pcid="10909">
    def test_where_should_be_participating(self):
        subscription = GroupSubscription(is_active=True)
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS,
                    ExternalProviders.SLACK: NotificationSettingOptionValues.SUBSCRIBE_ONLY,
                    ExternalProviders.PAGERDUTY: NotificationSettingOptionValues.NEVER,
                }
            }
        }

        providers = where_should_be_participating(
            self.user,
            subscription,
            notification_settings,
        )
        assert providers == [ExternalProviders.EMAIL, ExternalProviders.SLACK]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/notifications/utils/test_should_be_participating.py" startline="76" endline="92" pcid="10910">
    def test_subscription_null(self):
        notification_settings = {
            self.user: {
                NotificationScopeType.USER: {
                    ExternalProviders.EMAIL: NotificationSettingOptionValues.ALWAYS,
                    ExternalProviders.SLACK: NotificationSettingOptionValues.SUBSCRIBE_ONLY,
                    ExternalProviders.PAGERDUTY: NotificationSettingOptionValues.NEVER,
                }
            }
        }

        providers = where_should_be_participating(
            self.user,
            None,
            notification_settings,
        )
        assert providers == [ExternalProviders.EMAIL]
</source>
</class>

<class classid="434" nclones="5" nlines="10" similarity="77">
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="229" endline="239" pcid="10951">
    def test_event_timestamp_syntax(self):
        result = self.parse_query("event.timestamp:2016-01-02")
        assert result == {
            "query": "",
            "date_from": datetime(2016, 1, 2, tzinfo=timezone.utc),
            "date_from_inclusive": True,
            "date_to": datetime(2016, 1, 3, tzinfo=timezone.utc),
            "date_to_inclusive": False,
            "tags": {},
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="246" endline="256" pcid="10953">
    def test_greater_than_comparator(self):
        result = self.parse_query("timesSeen:>10 event.timestamp:>2016-01-02")
        assert result == {
            "tags": {},
            "query": "",
            "times_seen_lower": 10,
            "times_seen_lower_inclusive": False,
            "date_from": datetime(2016, 1, 2, tzinfo=timezone.utc),
            "date_from_inclusive": False,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="257" endline="267" pcid="10954">
    def test_greater_than_equal_comparator(self):
        result = self.parse_query("timesSeen:>=10 event.timestamp:>=2016-01-02")
        assert result == {
            "tags": {},
            "query": "",
            "times_seen_lower": 10,
            "times_seen_lower_inclusive": True,
            "date_from": datetime(2016, 1, 2, tzinfo=timezone.utc),
            "date_from_inclusive": True,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="281" endline="291" pcid="10956">
    def test_less_than_equal_comparator(self):
        result = self.parse_query("event.timestamp:<=2016-01-02 timesSeen:<=10")
        assert result == {
            "tags": {},
            "query": "",
            "times_seen_upper": 10,
            "times_seen_upper_inclusive": True,
            "date_to": datetime(2016, 1, 2, tzinfo=timezone.utc),
            "date_to_inclusive": True,
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="268" endline="279" pcid="10955">
    def test_less_than_comparator(self):
        result = self.parse_query("event.timestamp:<2016-01-02 timesSeen:<10")
        assert result == {
            "tags": {},
            "query": "",
            "times_seen_upper": 10,
            "times_seen_upper_inclusive": False,
            "date_to": datetime(2016, 1, 2, tzinfo=timezone.utc),
            "date_to_inclusive": False,
        }

    # TODO: query parser for '<=' timestamp should set inclusive to True.
</source>
</class>

<class classid="435" nclones="2" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="388" endline="403" pcid="10980">
    def test_first_release_latest(self):
        result = self.parse_query("first-release:latest")
        assert result == {"first_release": [""], "tags": {}, "query": ""}
        release = self.create_release(
            project=self.project,
            version="older_release",
            date_added=datetime.now() - timedelta(days=1),
        )
        result = self.parse_query("first-release:latest")
        assert result == {"first_release": [release.version], "tags": {}, "query": ""}
        release = self.create_release(
            project=self.project, version="new_release", date_added=datetime.now()
        )
        result = self.parse_query("first-release:latest")
        assert result == {"first_release": [release.version], "tags": {}, "query": ""}

</source>
<source file="systems/sentry-22.2.0/tests/sentry/search/test_utils.py" startline="408" endline="424" pcid="10982">
    def test_release_latest(self):
        result = self.parse_query("release:latest")
        assert result == {"tags": {"sentry:release": [""]}, "query": ""}

        release = self.create_release(
            project=self.project,
            version="older_release",
            date_added=datetime.now() - timedelta(days=1),
        )
        result = self.parse_query("release:latest")
        assert result == {"tags": {"sentry:release": [release.version]}, "query": ""}
        release = self.create_release(
            project=self.project, version="new_release", date_added=datetime.now()
        )
        result = self.parse_query("release:latest")
        assert result == {"tags": {"sentry:release": [release.version]}, "query": ""}

</source>
</class>

<class classid="436" nclones="2" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/sentry/analytics/test_base.py" startline="15" endline="25" pcid="11026">
    def test_record(self):
        organization = self.create_organization()
        provider = DummyAnalytics()
        provider.record("organization.created", organization)
        assert len(provider.events) == 1
        event = provider.events.pop(0)
        assert event.type == "organization.created"
        assert event.datetime
        assert event.data["slug"] == organization.slug
        assert not event.data["actor_id"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry/analytics/test_base.py" startline="26" endline="35" pcid="11027">
    def test_record_with_attrs(self):
        organization = self.create_organization()
        provider = DummyAnalytics()
        provider.record("organization.created", organization, actor_id=1)
        assert len(provider.events) == 1
        event = provider.events.pop(0)
        assert event.type == "organization.created"
        assert event.datetime
        assert event.data["slug"] == organization.slug
        assert event.data["actor_id"] == "1"
</source>
</class>

<class classid="437" nclones="2" nlines="18" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry/deletions/test_organization.py" startline="126" endline="153" pcid="11036">
    def test_large_child_relation_deletion(self):
        org = self.create_organization(name="test")
        self.create_team(organization=org, name="test1")
        repo = Repository.objects.create(organization_id=org.id, name=org.name, provider="dummy")
        author_bob = CommitAuthor.objects.create(
            organization_id=org.id, name="bob", email="bob@example.com"
        )
        author_sally = CommitAuthor.objects.create(
            organization_id=org.id, name="sally", email="sally@example.com"
        )
        # Make >100 commits so we can ensure that all commits are removed before authors are.
        for i in range(0, 150):
            author = author_bob if i % 2 == 0 else author_sally
            Commit.objects.create(
                repository_id=repo.id, organization_id=org.id, author=author, key=uuid4().hex
            )

        org.update(status=OrganizationStatus.PENDING_DELETION)
        deletion = ScheduledDeletion.schedule(org, days=0)
        deletion.update(in_progress=True)

        with self.tasks():
            run_deletion(deletion.id)

        assert not Organization.objects.filter(id=org.id).exists()
        assert not Commit.objects.filter(organization_id=org.id).exists()
        assert not CommitAuthor.objects.filter(organization_id=org.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/deletions/test_organization.py" startline="173" endline="199" pcid="11038">
    def test_orphan_commits(self):
        # We have had a few orgs get into a state where they have commits
        # but no repositories. Ensure that we can proceed.
        org = self.create_organization(name="test")

        repo = Repository.objects.create(organization_id=org.id, name=org.name, provider="dummy")
        author = CommitAuthor.objects.create(
            organization_id=org.id, name="foo", email="foo@example.com"
        )
        commit = Commit.objects.create(
            repository_id=repo.id, organization_id=org.id, author=author, key="a" * 40
        )

        # Simulate the project being deleted but the deletion crashing.
        repo.delete()

        org.update(status=OrganizationStatus.PENDING_DELETION)
        deletion = ScheduledDeletion.schedule(org, days=0)
        deletion.update(in_progress=True)

        with self.tasks():
            run_deletion(deletion.id)

        assert not Organization.objects.filter(id=org.id).exists()
        assert not Commit.objects.filter(id=commit.id).exists()
        assert not CommitAuthor.objects.filter(id=author.id).exists()

</source>
</class>

<class classid="438" nclones="2" nlines="18" similarity="94">
<source file="systems/sentry-22.2.0/tests/sentry/deletions/test_repository.py" startline="54" endline="76" pcid="11053">
    def test_delete_fail_email(self, mock_delete_repo):
        mock_delete_repo.side_effect = PluginError("foo")

        org = self.create_organization()
        repo = Repository.objects.create(
            organization_id=org.id,
            provider="dummy",
            name="example/example",
            status=ObjectStatus.PENDING_DELETION,
        )

        deletion = ScheduledDeletion.schedule(repo, actor=self.user, days=0)
        deletion.update(in_progress=True)

        with self.tasks():
            run_deletion(deletion.id)

        msg = mail.outbox[-1]
        assert msg.subject == "Unable to Delete Repository Webhooks"
        assert msg.to == [self.user.email]
        assert "foo" in msg.body
        assert not Repository.objects.filter(id=repo.id).exists()

</source>
<source file="systems/sentry-22.2.0/tests/sentry/deletions/test_repository.py" startline="78" endline="99" pcid="11054">
    def test_delete_fail_email_random(self, mock_delete_repo):
        mock_delete_repo.side_effect = Exception("secrets")

        org = self.create_organization()
        repo = Repository.objects.create(
            organization_id=org.id,
            provider="dummy",
            name="example/example",
            status=ObjectStatus.PENDING_DELETION,
        )

        deletion = ScheduledDeletion.schedule(repo, actor=self.user, days=0)
        deletion.update(in_progress=True)

        with self.tasks():
            run_deletion(deletion.id)

        msg = mail.outbox[-1]
        assert msg.subject == "Unable to Delete Repository Webhooks"
        assert msg.to == [self.user.email]
        assert "secrets" not in msg.body
        assert not Repository.objects.filter(id=repo.id).exists()
</source>
</class>

<class classid="439" nclones="3" nlines="13" similarity="73">
<source file="systems/sentry-22.2.0/tests/sentry/attachments/test_base.py" startline="61" endline="81" pcid="11077">
def test_basic_chunked():
    data = InMemoryCache()
    cache = BaseAttachmentCache(data)

    cache.set_chunk("c:foo", 123, 0, b"Hello World! ")
    cache.set_chunk("c:foo", 123, 1, b"")
    cache.set_chunk("c:foo", 123, 2, b"Bye.")

    att = CachedAttachment(key="c:foo", id=123, name="lol.txt", content_type="text/plain", chunks=3)
    cache.set("c:foo", [att])

    (att2,) = cache.get("c:foo")
    assert att2.key == att.key == "c:foo"
    assert att2.id == att.id == 123
    assert att2.data == att.data == b"Hello World! Bye."
    assert att2.rate_limited is None

    cache.delete("c:foo")
    assert not list(cache.get("c:foo"))


</source>
<source file="systems/sentry-22.2.0/tests/sentry/attachments/test_base.py" startline="82" endline="98" pcid="11078">
def test_basic_unchunked():
    data = InMemoryCache()
    cache = BaseAttachmentCache(data)

    att = CachedAttachment(name="lol.txt", content_type="text/plain", data=b"Hello World! Bye.")
    cache.set("c:foo", [att])

    (att2,) = cache.get("c:foo")
    assert att2.key == att.key == "c:foo"
    assert att2.id == att.id == 0
    assert att2.data == att.data == b"Hello World! Bye."
    assert att2.rate_limited is None

    cache.delete("c:foo")
    assert not list(cache.get("c:foo"))


</source>
<source file="systems/sentry-22.2.0/tests/sentry/attachments/test_base.py" startline="99" endline="112" pcid="11079">
def test_basic_rate_limited():
    data = InMemoryCache()
    cache = BaseAttachmentCache(data)

    att = CachedAttachment(
        name="lol.txt", content_type="text/plain", data=b"Hello World! Bye.", rate_limited=True
    )
    cache.set("c:foo", [att])

    (att2,) = cache.get("c:foo")
    assert att2.key == att.key == "c:foo"
    assert att2.id == att.id == 0
    assert att2.data == att.data == b"Hello World! Bye."
    assert att2.rate_limited is True
</source>
</class>

<class classid="440" nclones="10" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_activity.py" startline="8" endline="19" pcid="11080">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/activity/"
        self.project.update(first_event=timezone.now())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_project_user_feedback.py" startline="7" endline="18" pcid="11438">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.path = f"/{self.org.slug}/{self.project.slug}/user-feedback/"
        self.project.update(first_event=timezone.now())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_overview.py" startline="20" endline="32" pcid="11322">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/performance/"

        self.page = BasePage(self.browser)

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_landing.py" startline="20" endline="32" pcid="11185">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/performance/"

        self.page = BasePage(self.browser)

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_user_feedback.py" startline="7" endline="18" pcid="11298">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/user-feedback/"
        self.project.update(first_event=timezone.now())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_issue_details_workflow.py" startline="12" endline="23" pcid="11401">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.page = IssueDetailsPage(self.browser, self.client)
        self.dismiss_assistant()

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_releases.py" startline="11" endline="26" pcid="11085">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.project2 = self.create_project(
            organization=self.org, teams=[self.team], name="Bengal 2"
        )
        self.create_project(organization=self.org, teams=[self.team], name="Bengal 3")
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/releases/"
        self.project.update(first_event=timezone.now())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_project_servicehooks.py" startline="6" endline="17" pcid="11230">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.create_member(user=self.user, organization=self.org, role="owner", teams=[self.team])

        self.login_as(self.user)
        self.list_hooks_path = f"/settings/{self.org.slug}/projects/{self.project.slug}/hooks/"
        self.new_hook_path = f"/settings/{self.org.slug}/projects/{self.project.slug}/hooks/new/"

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_group_index.py" startline="17" endline="31" pcid="11093">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.other_project = self.create_project(
            organization=self.org, teams=[self.team], name="Sumatra"
        )
        self.login_as(self.user)
        self.page = IssueListPage(self.browser, self.client)
        self.dismiss_assistant()

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="134" endline="145" pcid="11200">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com", is_superuser=True)
        self.org = self.create_organization(name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.create_member(user=self.user, organization=self.org, role="owner", teams=[self.team])

        self.login_as(self.user)
        self.landing_path = f"/organizations/{self.org.slug}/discover/queries/"
        self.result_path = f"/organizations/{self.org.slug}/discover/results/"

</source>
</class>

<class classid="441" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_group_index.py" startline="80" endline="93" pcid="11098">
    def test_resolve_issues(self, mock_now):
        mock_now.return_value = datetime.utcnow().replace(tzinfo=pytz.utc)
        self.create_issues()
        self.page.visit_issue_list(self.org.slug)
        self.page.wait_for_stream()

        self.page.select_issue(1)
        self.page.select_issue(2)
        self.page.resolve_issues()
        self.page.wait_for_resolved_issue()
        resolved_groups = self.page.find_resolved_issues()

        assert len(resolved_groups) == 2

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_group_index.py" startline="95" endline="110" pcid="11099">
    def test_resolve_issues_multi_projects(self, mock_now):
        mock_now.return_value = datetime.utcnow().replace(tzinfo=pytz.utc)
        self.create_issues()

        with self.feature("organizations:global-views"):
            self.page.visit_issue_list(self.org.slug)
            self.page.wait_for_stream()

            self.page.select_issue(1)
            self.page.select_issue(2)
            self.page.resolve_issues()
            self.page.wait_for_resolved_issue()
            resolved_groups = self.page.find_resolved_issues()

            assert len(resolved_groups) == 2

</source>
</class>

<class classid="442" nclones="8" nlines="12" similarity="70">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_security_privacy.py" startline="37" endline="49" pcid="11173">
    def test_setting_2fa_without_2fa_enabled(self):
        self.browser.get(self.path)
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        assert not self.browser.element_exists(
            '[data-test-id="organization-settings-security-and-privacy"] .error'
        )
        self.browser.click("#require2FA")
        self.browser.wait_until("[role='dialog']")
        self.browser.click("[role='dialog'] [data-test-id='confirm-button']")
        self.browser.wait_until_not("[role='dialog']")
        self.browser.wait_until_test_id("toast-error")
        self.load_organization_helper("setting 2fa without 2fa enabled")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_api.py" startline="11" endline="24" pcid="11398">
    def test_simple(self):
        self.browser.get(self.path)
        self.browser.wait_until_not(".loading")
        self.browser.snapshot("api tokens - no tokens")

        self.browser.click_when_visible('[data-test-id="create-token"]')
        self.browser.wait_until_not(".loading")
        self.browser.snapshot("api tokens - new token")

        self.browser.click_when_visible('[data-test-id="form-submit"]')
        self.browser.wait_until_not(".loading")
        self.browser.snapshot("api tokens - single token")


</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_project_alert_settings.py" startline="45" endline="58" pcid="11313">
    def test_settings_load(self):
        self.browser.get(self.path1)
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.snapshot("project alert settings")
        self.browser.wait_until(".ref-plugin-enable-webhooks")
        self.browser.click(".ref-plugin-enable-webhooks")
        self.browser.wait_until(".ref-plugin-config-webhooks")
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')

        # flakey Toast animation being snapshotted in CI
        # click it to clear it before snapshotting
        self.browser.click_when_visible('[data-test-id="toast-success"]')
        self.browser.wait_until_not('[data-test-id="toast-success"]')
        self.browser.snapshot("project alert settings webhooks enabled")
</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_sidebar.py" startline="13" endline="27" pcid="11431">
    def test_new_sidebar(self):
        self.browser.get(self.path)
        self.browser.wait_until_not(".loading")
        self.browser.click('[data-test-id="sidebar-dropdown"]')
        self.browser.move_to('[data-test-id="sidebar-switch-org"]')
        self.browser.wait_until_test_id("sidebar-switch-org-menu")
        self.browser.snapshot("sidebar - switch org expanded")
        self.browser.click('[data-test-id="sidebar-collapse"]')
        self.browser.snapshot("sidebar - collapsed")
        self.browser.click('[data-test-id="sidebar-broadcasts"]')
        self.browser.wait_until_test_id("sidebar-broadcasts-panel")
        self.browser.snapshot("sidebar - broadcasts panel")
        self.browser.click("footer")
        self.browser.wait_until_not('[data-test-id="sidebar-broadcasts-panel"]')

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_create_team.py" startline="16" endline="31" pcid="11332">
    def test_create(self):
        self.browser.get(self.path)
        self.browser.wait_until_test_id("team-list")

        # Open the modal
        self.browser.click('button[aria-label="Create Team"]')
        self.browser.wait_until("[role='dialog']")
        self.browser.element('input[id="slug"]').send_keys("new-team")
        self.browser.click("[role='dialog'] button[aria-label='Create Team']")

        # Wait for modal to go away.
        self.browser.wait_until_not("[role='dialog']")

        # New team should be in dom
        assert self.browser.find_element_by_xpath("//span[contains(text(), 'new-team')]")
        assert Team.objects.filter(slug="new-team", organization=self.org).exists()
</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_teams_list.py" startline="18" endline="38" pcid="11463">
    def test_simple(self):
        self.project.update(first_event=timezone.now())
        self.browser.get(self.path)
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.wait_until_test_id("team-list")
        self.browser.snapshot("organization teams list")

        # team details link
        self.browser.click('[data-test-id="team-list"] a[href]:first-child')
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.snapshot("organization team - members list")

        # Click projects tab
        self.browser.click(".nav-tabs li:nth-child(2) a")
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.snapshot("organization team - projects list")

        # Click projects tab
        self.browser.click(".nav-tabs li:nth-child(3) a")
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.snapshot("organization team - settings")
</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_dashboard.py" startline="81" endline="100" pcid="11454">
    def test_rename_team_and_navigate_back(self):
        self.create_sample_event()
        self.browser.get(self.path)
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.click('[data-test-id="badge-display-name"]')
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')
        self.browser.click(".nav-tabs li:nth-child(4) a")
        self.browser.wait_until('input[name="slug"]')
        self.browser.element('input[name="slug"]').send_keys("-new-slug")
        self.browser.click('[aria-label="Save"]')
        self.browser.wait_until_not('[aria-label="Save"]')
        self.browser.wait_until('[data-test-id="toast-success"]')

        # Go to projects
        self.browser.click(f'[href="/organizations/{self.organization.slug}/projects/"]')
        self.browser.wait_until_not('[data-test-id="loading-indicator"]')

        assert self.browser.element('[data-test-id="badge-display-name"]').text == "#foo-new-slug"


</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_api.py" startline="32" endline="51" pcid="11400">
    def test_simple(self):
        self.browser.get(self.path)
        self.browser.wait_until_not(".loading")
        self.browser.snapshot("api applications - no applications")

        self.browser.click_when_visible('[aria-label="Create New Application"]')
        self.browser.wait_until_not(".loading")
        self.browser.snapshot("api applications - new application")

        self.browser.click('[href="/settings/account/api/applications/"]')
        self.browser.wait_until_not(".loading")
        self.browser.click_when_visible('[data-test-id="toast-success"]')
        self.browser.wait_until_not('[data-test-id="toast-success"]')
        self.browser.snapshot("api applications - single application")

        self.browser.get(self.path)
        self.browser.wait_until_not(".loading")
        self.browser.click_when_visible('[aria-label="Remove"]')
        self.browser.wait_until_not('[data-test-id="toast-loading"]')
        self.browser.wait_until_test_id("empty-message")
</source>
</class>

<class classid="443" nclones="2" nlines="14" similarity="80">
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_vital_detail.py" startline="18" endline="33" pcid="11179">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = "/organizations/{}/performance/vitaldetail/?{}".format(
            self.org.slug,
            urlencode({"query": "transaction.duration:>0"}),
        )

        self.page = BasePage(self.browser)

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_summary.py" startline="23" endline="42" pcid="11315">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = "/organizations/{}/performance/summary/?{}".format(
            self.org.slug,
            urlencode({"transaction": "/country_by_code/", "project": self.project.id}),
        )

        AssistantActivity.objects.create(
            user=self.user, guide_id=20, viewed_ts=before_now(minutes=1)
        )

        self.page = TransactionSummaryPage(self.browser)

</source>
</class>

<class classid="444" nclones="3" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_vital_detail.py" startline="35" endline="50" pcid="11180">
    def test_with_data(self, mock_now):

        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        event = load_data("transaction", timestamp=before_now(minutes=1))
        self.store_event(data=event, project_id=self.project.id)
        self.project.update(flags=F("flags").bitor(Project.flags.has_transactions))

        with self.feature(FEATURE_NAMES):
            self.browser.get(self.path)
            self.page.wait_until_loaded()

            self.browser.wait_until_not(
                '[data-test-id="grid-editable"] [data-test-id="empty-state"]', timeout=2
            )
            self.browser.snapshot("performance vital detail - with data")
</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_landing.py" startline="34" endline="50" pcid="11186">
    def test_with_data(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        event = load_data("transaction", timestamp=before_now(minutes=1))
        self.store_event(data=event, project_id=self.project.id)
        self.project.update(flags=F("flags").bitor(Project.flags.has_transactions))

        with self.feature(FEATURE_NAMES):
            self.browser.get(self.path)
            self.page.wait_until_loaded()

            # This test is flakey in that we sometimes load this page before the event is processed
            # depend on pytest-retry to reload the page
            self.browser.wait_until_not(
                '[data-test-id="grid-editable"] [data-test-id="empty-state"]', timeout=2
            )
            self.browser.snapshot("performance landing - with data")
</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_overview.py" startline="43" endline="59" pcid="11324">
    def test_with_data(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        event = load_data("transaction", timestamp=before_now(minutes=1))
        self.store_event(data=event, project_id=self.project.id)
        self.project.update(flags=F("flags").bitor(Project.flags.has_transactions))

        with self.feature(FEATURE_NAMES):
            self.browser.get(self.path)
            self.page.wait_until_loaded()

            # This test is flakey in that we sometimes load this page before the event is processed
            # depend on pytest-retry to reload the page
            self.browser.wait_until_not(
                '[data-test-id="grid-editable"] [data-test-id="empty-state"]', timeout=2
            )
            self.browser.snapshot("performance overview - with data")
</source>
</class>

<class classid="445" nclones="2" nlines="42" similarity="72">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="169" endline="217" pcid="11204">
    def test_all_events_query(self, mock_now):
        now = before_now().replace(tzinfo=pytz.utc)
        mock_now.return_value = now
        min_ago = iso_format(now - timedelta(minutes=1))
        two_min_ago = iso_format(now - timedelta(minutes=2))
        self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "oh no",
                "timestamp": min_ago,
                "fingerprint": ["group-1"],
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )
        self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "this is bad.",
                "timestamp": two_min_ago,
                "fingerprint": ["group-2"],
                "user": {
                    "id": "123",
                    "email": "someone@example.com",
                    "username": "haveibeenpwned",
                    "ip_address": "8.8.8.8",
                    "name": "Someone",
                },
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )
        self.wait_for_event_count(self.project.id, 2)

        with self.feature(FEATURE_NAMES):
            self.browser.get(self.result_path + "?" + all_events_query())
            self.wait_until_loaded()
            # This test is flakey in that we sometimes load this page before the event is processed
            # depend on pytest-retry to reload the page
            self.browser.wait_until('[data-test-id="grid-editable"] > tbody > tr:nth-child(2)')
            self.browser.snapshot("events-v2 - all events query - list")

        with self.feature(FEATURE_NAMES):
            # expect table to expand to the right when no tags are provided
            self.browser.get(self.result_path + "?" + all_events_query(tag=[]))
            self.wait_until_loaded()
            self.browser.wait_until('[data-test-id="grid-editable"] > tbody > tr:nth-child(2)')
            self.browser.snapshot("events-v2 - all events query - list - no tags")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="230" endline="272" pcid="11206">
    def test_errors_query(self, mock_now):
        now = before_now().replace(tzinfo=pytz.utc)
        mock_now.return_value = now
        min_ago = iso_format(now - timedelta(minutes=1))
        self.store_event(
            data={
                "event_id": "a" * 32,
                "message": "oh no",
                "timestamp": min_ago,
                "fingerprint": ["group-1"],
                "type": "error",
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )
        self.store_event(
            data={
                "event_id": "b" * 32,
                "message": "oh no",
                "timestamp": min_ago,
                "fingerprint": ["group-1"],
                "type": "error",
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )
        self.store_event(
            data={
                "event_id": "c" * 32,
                "message": "this is bad.",
                "timestamp": min_ago,
                "fingerprint": ["group-2"],
                "type": "error",
            },
            project_id=self.project.id,
            assert_no_errors=False,
        )

        with self.feature(FEATURE_NAMES):
            self.browser.get(self.result_path + "?" + errors_query())
            self.wait_until_loaded()
            self.browser.snapshot("events-v2 - errors")

</source>
</class>

<class classid="446" nclones="2" nlines="26" similarity="72">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="302" endline="338" pcid="11209">
    def test_event_detail_view_from_all_events(self, mock_now):
        now = before_now().replace(tzinfo=pytz.utc)
        mock_now.return_value = now
        min_ago = iso_format(now - timedelta(minutes=1))

        event_data = load_data("python")
        event_data.update(
            {
                "event_id": "a" * 32,
                "timestamp": min_ago,
                "received": min_ago,
                "fingerprint": ["group-1"],
            }
        )
        if "contexts" not in event_data:
            event_data["contexts"] = {}
        event_data["contexts"]["trace"] = {
            "type": "trace",
            "trace_id": "a" * 32,
            "span_id": "b" * 16,
        }
        self.store_event(data=event_data, project_id=self.project.id, assert_no_errors=False)

        with self.feature(FEATURE_NAMES):
            # Get the list page.
            self.browser.get(self.result_path + "?" + all_events_query())
            self.wait_until_loaded()

            # View Event
            self.browser.elements('[data-test-id="view-event"]')[0].click()
            self.wait_until_loaded()

            # header = self.browser.element('[data-test-id="event-header"] div div span')
            # assert event_data["message"] in header.text

            self.browser.snapshot("events-v2 - single error details view")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="340" endline="374" pcid="11210">
    def test_event_detail_view_from_errors_view(self, mock_now):
        now = before_now().replace(tzinfo=pytz.utc)
        mock_now.return_value = now

        event_data = load_data("javascript")
        event_data.update(
            {
                "timestamp": iso_format(now - timedelta(minutes=5)),
                "event_id": "d" * 32,
                "fingerprint": ["group-1"],
            }
        )
        event_data["contexts"]["trace"] = {
            "type": "trace",
            "trace_id": "a" * 32,
            "span_id": "b" * 16,
        }
        self.store_event(data=event_data, project_id=self.project.id)
        self.wait_for_event_count(self.project.id, 1)

        with self.feature(FEATURE_NAMES):
            # Get the list page
            self.browser.get(self.result_path + "?" + errors_query() + "&statsPeriod=24h")
            self.wait_until_loaded()

            # Open the stack
            self.browser.element('[data-test-id="open-group"]').click()
            self.wait_until_loaded()

            # View Event
            self.browser.elements('[data-test-id="view-event"]')[0].click()
            self.wait_until_loaded()

            self.browser.snapshot("events-v2 - error event detail view")

</source>
</class>

<class classid="447" nclones="2" nlines="17" similarity="77">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="521" endline="547" pcid="11215">
    def test_delete_saved_query(self):
        # Create saved query with ORM
        query = DiscoverSavedQuery.objects.create(
            name="Custom query",
            organization=self.org,
            version=2,
            query={"fields": ["title", "project.id", "count()"], "query": "event.type:error"},
        )
        with self.feature(FEATURE_NAMES):
            # View the query list
            self.browser.get(self.landing_path)
            self.wait_until_loaded()

            # Get the card with the new query
            card_selector = f'[data-test-id="card-{query.name}"]'
            card = self.browser.element(card_selector)

            # Open the context menu
            card.find_element_by_css_selector('[data-test-id="menu-trigger"]').click()
            # Delete the query
            card.find_element_by_css_selector('[data-test-id="delete"]').click()

            # Wait for card to clear
            self.browser.wait_until_not(card_selector)

            assert DiscoverSavedQuery.objects.filter(name=query.name).exists() is False

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_events_v2.py" startline="548" endline="579" pcid="11216">
    def test_duplicate_query(self):
        # Create saved query with ORM
        query = DiscoverSavedQuery.objects.create(
            name="Custom query",
            organization=self.org,
            version=2,
            query={"fields": ["title", "project.id", "count()"], "query": "event.type:error"},
        )
        with self.feature(FEATURE_NAMES):
            # View the query list
            self.browser.get(self.landing_path)
            self.wait_until_loaded()

            # Get the card with the new query
            card_selector = f'[data-test-id="card-{query.name}"]'
            card = self.browser.element(card_selector)

            # Open the context menu, and duplicate
            card.find_element_by_css_selector('[data-test-id="menu-trigger"]').click()
            card.find_element_by_css_selector('[data-test-id="duplicate"]').click()

            duplicate_name = f"{query.name} copy"

            # Reload the page
            self.browser.get(self.landing_path)

            # Wait for new element to show up.
            self.browser.element(f'[data-test-id="card-{duplicate_name}"]')

            # Assert the new query exists and has 'copy' added to the name.
            assert DiscoverSavedQuery.objects.filter(name=duplicate_name).exists()

</source>
</class>

<class classid="448" nclones="2" nlines="10" similarity="70">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="101" endline="116" pcid="11268">
    def test_widget_library(self):
        with self.feature(FEATURE_NAMES + EDIT_FEATURE + WIDGET_LIBRARY_FEATURE):
            self.page.visit_default_overview()

            # Open widget library
            self.page.click_dashboard_header_add_widget_button()
            self.browser.element('[data-test-id="library-tab"]').click()

            # Select/deselect widget library cards
            self.browser.element('[data-test-id="widget-library-card-0"]').click()
            self.browser.element('[data-test-id="widget-library-card-2"]').click()
            self.browser.element('[data-test-id="widget-library-card-3"]').click()
            self.browser.element('[data-test-id="widget-library-card-2"]').click()

            self.browser.snapshot("dashboards - widget library")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="117" endline="130" pcid="11269">
    def test_duplicate_widget_in_view_mode(self):
        with self.feature(FEATURE_NAMES + EDIT_FEATURE):
            self.page.visit_dashboard_detail()

            self.browser.element('[aria-haspopup="true"]').click()
            self.browser.element('[data-test-id="duplicate-widget"]').click()
            self.page.wait_until_loaded()

            self.browser.element('[aria-haspopup="true"]').click()
            self.browser.element('[data-test-id="duplicate-widget"]').click()
            self.page.wait_until_loaded()

            self.browser.snapshot("dashboard widget - duplicate")

</source>
</class>

<class classid="449" nclones="2" nlines="19" similarity="89">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="213" endline="235" pcid="11275">
    def test_move_existing_widget_on_existing_dashboard(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Existing Widget",
            display_type=DashboardWidgetDisplayTypes.LINE_CHART,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(widget=existing_widget, fields=["count()"], order=0)
        with self.feature(FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE):
            self.page.visit_dashboard_detail()
            self.page.enter_edit_state()

            # Drag to the right
            dragHandle = self.browser.element(WIDGET_DRAG_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(dragHandle, 1000, 0).perform()

            self.page.save_dashboard()

            self.capture_screenshots("dashboards - move existing widget on existing dashboard")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="412" endline="436" pcid="11282">
    def test_resize_big_number_widget(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Big Number Widget",
            display_type=DashboardWidgetDisplayTypes.BIG_NUMBER,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(
            widget=existing_widget, fields=["count_unique(issue)"], order=0
        )
        with self.feature(FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE):
            self.page.visit_dashboard_detail()
            self.page.enter_edit_state()

            # Resize existing widget
            resizeHandle = self.browser.element(WIDGET_RESIZE_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 200, 200).perform()

            self.page.save_dashboard()

            self.capture_screenshots("dashboards - resize big number widget")

</source>
</class>

<class classid="450" nclones="2" nlines="28" similarity="82">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="328" endline="367" pcid="11280">
    def test_resize_new_and_existing_widgets(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Existing Widget",
            display_type=DashboardWidgetDisplayTypes.LINE_CHART,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(widget=existing_widget, fields=["count()"], order=0)
        with self.feature(FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE):
            self.page.visit_dashboard_detail()
            self.page.enter_edit_state()

            # Resize existing widget
            resizeHandle = self.browser.element(WIDGET_RESIZE_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 500, 0).perform()

            self.page.add_widget_through_dashboard("New Widget")

            # Drag it to the left for consistency
            dragHandle = self.browser.element(
                f".react-grid-item:nth-of-type(2) {WIDGET_DRAG_HANDLE}"
            )
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(dragHandle, -1000, 0).perform()

            # Resize new widget, get the 2nd element instead of the "last" because the "last" is
            # the add widget button
            resizeHandle = self.browser.element(
                f".react-grid-item:nth-of-type(2) {WIDGET_RESIZE_HANDLE}"
            )
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 500, 0).perform()

            self.page.save_dashboard()

            self.capture_screenshots("dashboards - resize new and existing widgets")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="368" endline="411" pcid="11281">
    def test_delete_existing_widget_does_not_trigger_new_widget_layout_reset(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Existing Widget",
            display_type=DashboardWidgetDisplayTypes.LINE_CHART,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(widget=existing_widget, fields=["count()"], order=0)

        with self.feature(FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE):
            self.page.visit_dashboard_detail()
            self.page.enter_edit_state()

            self.page.add_widget_through_dashboard("New Widget")

            # Drag it to the bottom left
            dragHandle = self.browser.element(
                f".react-grid-item:nth-of-type(2) {WIDGET_DRAG_HANDLE}"
            )
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(dragHandle, -500, 500).perform()

            # Resize new widget, get the 2nd element instead of the "last" because the "last" is
            # the add widget button
            resizeHandle = self.browser.element(
                f".react-grid-item:nth-of-type(2) {WIDGET_RESIZE_HANDLE}"
            )
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 500, 0).perform()

            # Delete first existing widget
            delete_widget_button = self.browser.element(
                '.react-grid-item:first-of-type [data-test-id="widget-delete"]'
            )
            delete_widget_button.click()

            self.page.save_dashboard()

            self.capture_screenshots(
                "dashboards - delete existing widget does not reset new widget layout"
            )

</source>
</class>

<class classid="451" nclones="2" nlines="21" similarity="75">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="464" endline="494" pcid="11284">
    def test_duplicate_widget_in_view_mode(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Big Number Widget",
            display_type=DashboardWidgetDisplayTypes.BIG_NUMBER,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(
            widget=existing_widget, fields=["count_unique(issue)"], order=0
        )
        with self.feature(FEATURE_NAMES + EDIT_FEATURE):
            self.page.visit_dashboard_detail()

            self.browser.element('[aria-haspopup="true"]').click()
            self.browser.element('[data-test-id="duplicate-widget"]').click()
            self.page.wait_until_loaded()

            self.browser.element('[aria-haspopup="true"]').click()
            self.browser.element('[data-test-id="duplicate-widget"]').click()
            self.page.wait_until_loaded()

            # Should not trigger alert
            self.page.enter_edit_state()
            self.page.click_cancel_button()
            wait = WebDriverWait(self.browser.driver, 5)
            wait.until_not(EC.alert_is_present())

            self.browser.snapshot("dashboard widget - duplicate with grid")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="495" endline="517" pcid="11285">
    def test_delete_widget_in_view_mode(self):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Big Number Widget",
            display_type=DashboardWidgetDisplayTypes.BIG_NUMBER,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
        )
        DashboardWidgetQuery.objects.create(
            widget=existing_widget, fields=["count_unique(issue)"], order=0
        )
        with self.feature(FEATURE_NAMES + EDIT_FEATURE):
            self.page.visit_dashboard_detail()

            self.browser.element('[aria-haspopup="true"]').click()
            self.browser.element('[data-test-id="delete-widget"]').click()
            self.browser.element('[data-test-id="confirm-button"]').click()

            self.page.wait_until_loaded()

            self.browser.snapshot("dashboard widget - delete with grid")

</source>
</class>

<class classid="452" nclones="2" nlines="17" similarity="82">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="518" endline="544" pcid="11286">
    def test_cancel_without_changes_does_not_trigger_confirm_with_widget_library_through_header(
        self,
    ):
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            # Open widget library
            self.page.click_dashboard_header_add_widget_button()
            self.browser.element('[data-test-id="library-tab"]').click()

            # Select/deselect widget library cards
            self.browser.element('[data-test-id="widget-library-card-0"]').click()
            self.browser.element('[data-test-id="widget-library-card-2"]').click()

            # Save widget library selections
            button = self.browser.element('[data-test-id="confirm-widgets"]')
            button.click()
            self.page.wait_until_loaded()

            # Should not trigger alert
            self.page.enter_edit_state()
            self.page.click_cancel_button()
            wait = WebDriverWait(self.browser.driver, 5)
            wait.until_not(EC.alert_is_present())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="545" endline="565" pcid="11287">
    def test_cancel_without_changes_does_not_trigger_confirm_with_custom_widget_through_header(
        self,
    ):
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            self.page.click_dashboard_header_add_widget_button()
            title_input = self.browser.element(WIDGET_TITLE_FIELD)
            title_input.send_keys("New custom widget")
            button = self.browser.element('[data-test-id="add-widget"]')
            button.click()
            self.page.wait_until_loaded()

            # Should not trigger confirm dialog
            self.page.enter_edit_state()
            self.page.click_cancel_button()
            wait = WebDriverWait(self.browser.driver, 5)
            wait.until_not(EC.alert_is_present())

</source>
</class>

<class classid="453" nclones="2" nlines="17" similarity="73">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="566" endline="586" pcid="11288">
    def test_position_when_adding_multiple_widgets_through_add_widget_tile_in_edit(
        self,
    ):
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()
            self.page.enter_edit_state()

            # Widgets should take up the whole first row and the first spot in second row
            self.page.add_widget_through_dashboard("A")
            self.page.add_widget_through_dashboard("B")
            self.page.add_widget_through_dashboard("C")
            self.page.add_widget_through_dashboard("D")
            self.page.wait_until_loaded()

            self.page.save_dashboard()
            self.capture_screenshots(
                "dashboards - position when adding multiple widgets through Add Widget tile in edit"
            )

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="587" endline="615" pcid="11289">
    def test_position_when_adding_multiple_widgets_through_add_widget_tile_in_create(
        self,
    ):
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_create_dashboard()

            # Widgets should take up the whole first row and the first spot in second row
            self.page.add_widget_through_dashboard("A")
            self.page.add_widget_through_dashboard("B")
            self.page.add_widget_through_dashboard("C")
            self.page.add_widget_through_dashboard("D")
            self.page.wait_until_loaded()

            self.page.save_dashboard()

            # Wait for page redirect, or else loading check passes too early
            wait = WebDriverWait(self.browser.driver, 10)
            wait.until(
                lambda driver: (
                    f"/organizations/{self.organization.slug}/dashboards/new/"
                    not in driver.current_url
                )
            )
            self.capture_screenshots(
                "dashboards - position when adding multiple widgets through Add Widget tile in create"
            )

</source>
</class>

<class classid="454" nclones="2" nlines="41" similarity="77">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="616" endline="666" pcid="11290">
    def test_deleting_stacked_widgets_by_context_menu_does_not_trigger_confirm_on_edit_cancel(
        self,
    ):
        layouts = [
            {"x": 0, "y": 0, "w": 2, "h": 2, "minH": 2},
            {"x": 0, "y": 2, "w": 2, "h": 2, "minH": 2},
        ]
        existing_widgets = DashboardWidget.objects.bulk_create(
            [
                DashboardWidget(
                    dashboard=self.dashboard,
                    order=i,
                    title=f"Existing Widget {i}",
                    display_type=DashboardWidgetDisplayTypes.LINE_CHART,
                    widget_type=DashboardWidgetTypes.DISCOVER,
                    interval="1d",
                    detail={"layout": layout},
                )
                for i, layout in enumerate(layouts)
            ]
        )
        DashboardWidgetQuery.objects.bulk_create(
            DashboardWidgetQuery(widget=widget, fields=["count()"], order=0)
            for widget in existing_widgets
        )
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            dropdown_trigger = self.browser.element('[aria-haspopup="true"]')
            dropdown_trigger.click()

            delete_widget_menu_item = self.browser.element('[data-test-id="delete-widget"]')
            delete_widget_menu_item.click()

            confirm_button = self.browser.element('[data-test-id="confirm-button"]')
            confirm_button.click()

            wait = WebDriverWait(self.browser.driver, 5)
            wait.until(
                EC.presence_of_element_located(
                    (By.XPATH, "//*[contains(text(),'Dashboard updated')]")
                )
            )

            # Should not trigger confirm dialog
            self.page.enter_edit_state()
            self.page.click_cancel_button()
            wait.until_not(EC.alert_is_present())

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="667" endline="726" pcid="11291">
    def test_changing_number_widget_to_area_updates_widget_height(
        self,
    ):
        layouts = [
            {"x": 0, "y": 0, "w": 2, "h": 1, "minH": 1},
            {"x": 0, "y": 1, "w": 2, "h": 1, "minH": 1},
        ]
        existing_widgets = DashboardWidget.objects.bulk_create(
            [
                DashboardWidget(
                    dashboard=self.dashboard,
                    order=i,
                    title=f"Big Number {i}",
                    display_type=DashboardWidgetDisplayTypes.BIG_NUMBER,
                    widget_type=DashboardWidgetTypes.DISCOVER,
                    interval="1d",
                    detail={"layout": layout},
                )
                for i, layout in enumerate(layouts)
            ]
        )
        DashboardWidgetQuery.objects.bulk_create(
            DashboardWidgetQuery(widget=widget, fields=["count()"], order=0)
            for widget in existing_widgets
        )
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            # Open edit modal for first widget
            dropdown_trigger = self.browser.element('[aria-haspopup="true"]')
            dropdown_trigger.click()
            edit_widget_menu_item = self.browser.element('[data-test-id="edit-widget"]')
            edit_widget_menu_item.click()

            # Change the chart type to the first visualization option - Area chart
            chart_type_input = self.browser.element("#react-select-2-input")
            chart_type_input.send_keys("Area", Keys.ENTER)
            button = self.browser.element('[data-test-id="add-widget"]')
            button.click()

            # No confirm dialog because of shifting lower element
            self.page.enter_edit_state()
            self.page.click_cancel_button()
            wait = WebDriverWait(self.browser.driver, 5)
            wait.until_not(EC.alert_is_present())

            # Try to decrease height to 1 row, should stay at 2 rows
            self.page.enter_edit_state()
            resizeHandle = self.browser.element(WIDGET_RESIZE_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 0, -100).perform()

            self.page.save_dashboard()

            self.browser.snapshot(
                "dashboards - change from big number to area chart increases widget to min height"
            )

</source>
</class>

<class classid="455" nclones="2" nlines="34" similarity="94">
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="727" endline="774" pcid="11292">
    def test_changing_number_widget_larger_than_min_height_for_area_chart_keeps_height(
        self,
    ):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Originally Big Number - 3 rows",
            display_type=DashboardWidgetDisplayTypes.BIG_NUMBER,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
            detail={"layout": {"x": 0, "y": 0, "w": 2, "h": 3, "minH": 1}},
        )
        DashboardWidgetQuery.objects.create(widget=existing_widget, fields=["count()"], order=0)
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            # Open edit modal for first widget
            dropdown_trigger = self.browser.element('[aria-haspopup="true"]')
            dropdown_trigger.click()
            edit_widget_menu_item = self.browser.element('[data-test-id="edit-widget"]')
            edit_widget_menu_item.click()

            # Change the chart type to the first visualization option - Area chart
            chart_type_input = self.browser.element("#react-select-2-input")
            chart_type_input.send_keys("Area", Keys.ENTER)
            button = self.browser.element('[data-test-id="add-widget"]')
            button.click()

            self.page.wait_until_loaded()

            self.browser.snapshot(
                "dashboards - change from big number to other chart of more than 2 rows keeps height"
            )

            # Try to decrease height by >1 row, should be at 2 rows
            self.page.enter_edit_state()
            resizeHandle = self.browser.element(WIDGET_RESIZE_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 0, -400).perform()

            self.page.save_dashboard()

            self.browser.snapshot(
                "dashboards - change from big number to other chart enforces min height of 2"
            )

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_organization_dashboards.py" startline="775" endline="821" pcid="11293">
    def test_changing_area_widget_larger_than_min_height_for_number_chart_keeps_height(
        self,
    ):
        existing_widget = DashboardWidget.objects.create(
            dashboard=self.dashboard,
            order=0,
            title="Originally Area Chart - 3 rows",
            display_type=DashboardWidgetDisplayTypes.AREA_CHART,
            widget_type=DashboardWidgetTypes.DISCOVER,
            interval="1d",
            detail={"layout": {"x": 0, "y": 0, "w": 2, "h": 3, "minH": 2}},
        )
        DashboardWidgetQuery.objects.create(widget=existing_widget, fields=["count()"], order=0)
        with self.feature(
            FEATURE_NAMES + EDIT_FEATURE + GRID_LAYOUT_FEATURE + WIDGET_LIBRARY_FEATURE
        ):
            self.page.visit_dashboard_detail()

            # Open edit modal for first widget
            dropdown_trigger = self.browser.element('[aria-haspopup="true"]')
            dropdown_trigger.click()
            edit_widget_menu_item = self.browser.element('[data-test-id="edit-widget"]')
            edit_widget_menu_item.click()

            # Change the chart type to big number
            chart_type_input = self.browser.element("#react-select-2-input")
            chart_type_input.send_keys("Big Number", Keys.ENTER)
            button = self.browser.element('[data-test-id="add-widget"]')
            button.click()

            self.page.wait_until_loaded()

            self.browser.snapshot("dashboards - change from area chart to big number keeps height")

            # Decrease height by >1 row, should stop at 1 row
            self.page.enter_edit_state()
            resizeHandle = self.browser.element(WIDGET_RESIZE_HANDLE)
            action = ActionChains(self.browser.driver)
            action.drag_and_drop_by_offset(resizeHandle, 0, -400).perform()

            self.page.save_dashboard()

            self.browser.snapshot(
                "dashboards - change from area chart to big number allows min height of 1"
            )


</source>
</class>

<class classid="456" nclones="2" nlines="18" similarity="94">
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_summary.py" startline="44" endline="67" pcid="11316">
    def test_with_data(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        # Create a transaction
        event = make_event(load_data("transaction", timestamp=before_now(minutes=3)))
        self.store_event(data=event, project_id=self.project.id)

        self.store_event(
            data={
                "transaction": "/country_by_code/",
                "message": "This is bad",
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
            },
            project_id=self.project.id,
        )

        with self.feature(FEATURES):
            self.browser.get(self.path)
            self.page.wait_until_loaded()
            # We have to wait for this again because there are loaders inside of the table
            self.page.wait_until_loaded()
            self.browser.snapshot("performance summary - with data")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_summary.py" startline="196" endline="217" pcid="11321">
    def test_transaction_threshold_modal(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        # Create a transaction
        event = make_event(load_data("transaction", timestamp=before_now(minutes=3)))
        self.store_event(data=event, project_id=self.project.id)

        self.store_event(
            data={
                "transaction": "/country_by_code/",
                "message": "This is bad",
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(minutes=3)),
            },
            project_id=self.project.id,
        )

        with self.feature(FEATURES):
            self.browser.get(self.path)
            self.page.wait_until_loaded()
            self.browser.click('[data-test-id="set-transaction-threshold"]')
            self.browser.snapshot("transaction threshold modal")
</source>
</class>

<class classid="457" nclones="2" nlines="14" similarity="86">
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_summary.py" startline="89" endline="107" pcid="11318">
    def test_tags_page(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        tags_path = "/organizations/{}/performance/summary/tags/?{}".format(
            self.org.slug,
            urlencode({"transaction": "/country_by_code/", "project": self.project.id}),
        )

        # Create a transaction
        event_data = load_data("transaction", timestamp=before_now(minutes=3))

        event = make_event(event_data)
        self.store_event(data=event, project_id=self.project.id)

        with self.feature(FEATURES):
            self.browser.get(tags_path)
            self.page.wait_until_loaded()
            self.browser.snapshot("transaction summary tags page")

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_summary.py" startline="109" endline="130" pcid="11319">
    def test_transaction_vitals(self, mock_now):
        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)

        vitals_path = "/organizations/{}/performance/summary/vitals/?{}".format(
            self.org.slug,
            urlencode({"transaction": "/country_by_code/", "project": self.project.id}),
        )

        # Create a transaction
        event_data = load_data("transaction", timestamp=before_now(minutes=3))
        # only frontend pageload transactions can be shown on the vitals tab
        event_data["contexts"]["trace"]["op"] = "pageload"
        event_data["measurements"]["fp"]["value"] = 5000
        event = make_event(event_data)
        self.store_event(data=event, project_id=self.project.id)

        with self.feature(FEATURES):
            self.browser.get(vitals_path)
            self.page.wait_until_loaded()

            self.browser.snapshot("real user monitoring")

</source>
</class>

<class classid="458" nclones="2" nlines="16" similarity="87">
<source file="systems/sentry-22.2.0/tests/acceptance/test_project_keys.py" startline="10" endline="28" pcid="11385">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.create_member(user=self.user, organization=self.org, role="owner", teams=[self.team])

        ProjectKey.objects.filter(project=self.project).delete()
        ProjectKey.objects.create(
            project=self.project,
            label="Default",
            public_key="5cc0482a13d248ff99f9717101dd6356",
            secret_key="410fd998318844b8894775f36184ec28",
        )

        self.login_as(self.user)
        self.path = f"/{self.org.slug}/{self.project.slug}/settings/keys/"

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_project_keys.py" startline="37" endline="55" pcid="11387">
    def setUp(self):
        super().setUp()
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.create_member(user=self.user, organization=self.org, role="owner", teams=[self.team])

        self.pk = ProjectKey.objects.create(
            project=self.project,
            label="Default",
            public_key="5cc0482a13d248ff99f9717101dd6356",
            secret_key="410fd998318844b8894775f36184ec28",
            date_added=datetime(2015, 10, 1, 21, 19, 5, 648517, tzinfo=timezone.utc),
        )

        self.login_as(self.user)
        self.path = f"/{self.org.slug}/{self.project.slug}/settings/keys/{self.pk.public_key}/"

</source>
</class>

<class classid="459" nclones="6" nlines="26" similarity="70">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/bitbucket/test_plugin.py" startline="45" endline="84" pcid="11499">
    def test_create_issue(self):
        responses.add(
            responses.POST,
            "https://api.bitbucket.org/1.0/repositories/maxbittker/newsdiffs/issues",
            json={"local_id": 1, "title": "Hello world"},
        )

        self.plugin.set_option("repo", "maxbittker/newsdiffs", self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {
            "title": "Hello",
            "description": "Fix this.",
            "issue_type": "bug",
            "priority": "trivial",
        }
        with self.assertRaises(PluginError):
            self.plugin.create_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user,
            provider=self.plugin.auth_provider,
            extra_data={
                "access_token": (
                    "oauth_token=123456789abcdefghi&"
                    "oauth_token_secret="
                    "123456789123456789abcdefghijklmn"
                )
            },
        )

        assert self.plugin.create_issue(request, group, form_data) == 1

        request = responses.calls[-1].request
        assert request.headers.get("Authorization", b"").startswith(b"OAuth ")

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/bitbucket/test_plugin.py" startline="86" endline="120" pcid="11500">
    def test_link_issue(self):
        responses.add(
            responses.GET,
            "https://api.bitbucket.org/1.0/repositories/maxbittker/newsdiffs/issues/1",
            json={"local_id": 1, "title": "Hello world"},
        )
        responses.add(
            responses.POST,
            "https://api.bitbucket.org/1.0/repositories/maxbittker/newsdiffs/issues/1/comments",
            json={"body": "Hello"},
        )

        self.plugin.set_option("repo", "maxbittker/newsdiffs", self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {"comment": "Hello", "issue_id": "1"}
        with self.assertRaises(PluginError):
            self.plugin.link_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user,
            provider=self.plugin.auth_provider,
            extra_data={
                "access_token": (
                    "oauth_token=123456789abcdefghi&oauth_token_secret="
                    "123456789123456789abcdefghijklmn"
                )
            },
        )

        assert self.plugin.link_issue(request, group, form_data) == {"title": "Hello world"}
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_plugin.py" startline="72" endline="103" pcid="11613">
    def test_link_issue(self):
        responses.add(
            responses.GET,
            "https://api.github.com/repos/getsentry/sentry/issues/1",
            json={"number": 1, "title": "Hello world"},
        )
        responses.add(
            responses.POST,
            "https://api.github.com/repos/getsentry/sentry/issues/1/comments",
            json={"body": "Hello"},
        )

        self.plugin.set_option("repo", "getsentry/sentry", self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {"comment": "Hello", "issue_id": "1"}
        with self.assertRaises(PluginError):
            self.plugin.link_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user, provider=self.plugin.auth_provider, extra_data={"access_token": "foo"}
        )

        assert self.plugin.link_issue(request, group, form_data) == {"title": "Hello world"}
        request = responses.calls[-1].request
        assert request.headers["Authorization"] == "Bearer foo"
        payload = json.loads(request.body)
        assert payload == {"body": "Hello"}
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_plugin.py" startline="43" endline="70" pcid="11612">
    def test_create_issue(self):
        responses.add(
            responses.POST,
            "https://api.github.com/repos/getsentry/sentry/issues",
            json={"number": 1, "title": "Hello world"},
        )

        self.plugin.set_option("repo", "getsentry/sentry", self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {"title": "Hello", "description": "Fix this."}
        with self.assertRaises(PluginError):
            self.plugin.create_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user, provider=self.plugin.auth_provider, extra_data={"access_token": "foo"}
        )

        assert self.plugin.create_issue(request, group, form_data) == 1
        request = responses.calls[0].request
        assert request.headers["Authorization"] == "Bearer foo"
        payload = json.loads(request.body)
        assert payload == {"title": "Hello", "body": "Fix this.", "assignee": None}

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/asana/test_plugin.py" startline="71" endline="101" pcid="11656">
    def test_link_issue(self):
        responses.add(
            responses.GET,
            "https://app.asana.com/api/1.0/tasks/1",
            json={"data": {"gid": 1, "name": "Hello", "notes": "Fix this."}},
        )
        responses.add(
            responses.POST,
            "https://app.asana.com/api/1.0/tasks/1/stories/",
            json={"data": {"text": "hello"}},
        )

        self.plugin.set_option("workspace", 12345678, self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {"comment": "please fix this", "issue_id": "1"}
        with self.assertRaises(PluginError):
            self.plugin.link_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user, provider=self.plugin.auth_provider, extra_data={"access_token": "foo"}
        )

        assert self.plugin.link_issue(request, group, form_data) == {"title": "Hello"}
        request = responses.calls[-1].request
        payload = json.loads(request.body)
        assert payload == {"data": {"text": "please fix this"}}
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/asana/test_plugin.py" startline="43" endline="69" pcid="11655">
    def test_create_issue(self):
        responses.add(
            responses.POST,
            "https://app.asana.com/api/1.0/tasks",
            json={"data": {"name": "Hello world!", "notes": "Fix this.", "gid": 1}},
        )

        self.plugin.set_option("workspace", "12345678", self.project)
        group = self.create_group(message="Hello world", culprit="foo.bar")

        request = self.request.get("/")
        request.user = AnonymousUser()
        form_data = {"title": "Hello", "description": "Fix this."}
        with self.assertRaises(PluginError):
            self.plugin.create_issue(request, group, form_data)

        request.user = self.user
        self.login_as(self.user)
        UserSocialAuth.objects.create(
            user=self.user, provider=self.plugin.auth_provider, extra_data={"access_token": "foo"}
        )

        assert self.plugin.create_issue(request, group, form_data) == 1
        request = responses.calls[0].request
        payload = json.loads(request.body)
        assert payload == {"data": {"notes": "Fix this.", "name": "Hello", "workspace": "12345678"}}

</source>
</class>

<class classid="460" nclones="4" nlines="19" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/pivotal/test_pivotal_plugin.py" startline="34" endline="51" pcid="11514">
    def test_no_secrets(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.plugin.set_option("token", "abcdef", self.project)
        url = reverse(
            "sentry-api-0-project-plugin-details",
            args=[self.org.slug, self.project.slug, "pivotal"],
        )
        res = self.client.get(url)
        config = json.loads(res.content)["config"]
        token_config = [item for item in config if item["name"] == "token"][0]
        assert token_config.get("type") == "secret"
        assert token_config.get("value") is None
        assert token_config.get("hasSavedValue") is True
        assert token_config.get("prefix") == "abcd"
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/pushover/test_plugin.py" startline="105" endline="128" pcid="11572">
    def test_no_secrets(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.plugin.set_option("userkey", "abcdef", self.project)
        self.plugin.set_option("apikey", "abcdef", self.project)
        url = reverse(
            "sentry-api-0-project-plugin-details",
            args=[self.org.slug, self.project.slug, "pushover"],
        )
        res = self.client.get(url)
        config = json.loads(res.content)["config"]
        userkey_config = [item for item in config if item["name"] == "userkey"][0]
        apikey_config = [item for item in config if item["name"] == "apikey"][0]
        assert userkey_config.get("type") == "secret"
        assert userkey_config.get("value") is None
        assert userkey_config.get("hasSavedValue") is True
        assert userkey_config.get("prefix") == "abcd"
        assert apikey_config.get("type") == "secret"
        assert apikey_config.get("value") is None
        assert apikey_config.get("hasSavedValue") is True
        assert apikey_config.get("prefix") == "abcd"
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/pagerduty/test_plugin.py" startline="98" endline="115" pcid="11560">
    def test_no_secrets(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.plugin.set_option("service_key", "abcdef", self.project)
        url = reverse(
            "sentry-api-0-project-plugin-details",
            args=[self.org.slug, self.project.slug, "pagerduty"],
        )
        res = self.client.get(url)
        config = json.loads(res.content)["config"]
        key_config = [item for item in config if item["name"] == "service_key"][0]
        assert key_config.get("type") == "secret"
        assert key_config.get("value") is None
        assert key_config.get("hasSavedValue") is True
        assert key_config.get("prefix") == "abcd"
</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/gitlab/test_plugin.py" startline="107" endline="125" pcid="11647">
    def test_no_secrets(self):
        self.user = self.create_user("foo@example.com")
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(organization=self.org, name="Mariachi Band")
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.login_as(self.user)
        self.plugin.set_option("gitlab_url", "https://gitlab.com", self.project)
        self.plugin.set_option("gitlab_repo", "getsentry/sentry", self.project)
        self.plugin.set_option("gitlab_token", "abcdefg", self.project)
        url = reverse(
            "sentry-api-0-project-plugin-details", args=[self.org.slug, self.project.slug, "gitlab"]
        )
        res = self.client.get(url)
        config = json.loads(res.content)["config"]
        token_config = [item for item in config if item["name"] == "gitlab_token"][0]
        assert token_config.get("type") == "secret"
        assert token_config.get("value") is None
        assert token_config.get("hasSavedValue") is True
        assert token_config.get("prefix") == "abcd"
</source>
</class>

<class classid="461" nclones="2" nlines="12" similarity="83">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/splunk/test_plugin.py" startline="42" endline="59" pcid="11519">
    def test_dont_reraise_error(self):
        responses.add(
            responses.POST, "https://splunk.example.com:8088/services/collector", status=404
        )

        self.plugin.set_option("token", "12345678-1234-1234-1234-1234567890AB", self.project)
        self.plugin.set_option("index", "main", self.project)
        self.plugin.set_option("instance", "https://splunk.example.com:8088", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning"}, project_id=self.project.id
        )
        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.post_process(event)

        resp = responses.calls[0].response
        assert resp.status_code == 404

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/splunk/test_plugin.py" startline="61" endline="76" pcid="11520">
    def test_reraise_error(self):
        responses.add(
            responses.POST, "https://splunk.example.com:8088/services/collector", status=500
        )

        self.plugin.set_option("token", "12345678-1234-1234-1234-1234567890AB", self.project)
        self.plugin.set_option("index", "main", self.project)
        self.plugin.set_option("instance", "https://splunk.example.com:8088", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning"}, project_id=self.project.id
        )
        with self.options({"system.url-prefix": "http://example.com"}):
            with self.assertRaises(ApiError):
                self.plugin.post_process(event)

</source>
</class>

<class classid="462" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/splunk/test_plugin.py" startline="77" endline="93" pcid="11521">
    def test_http_payload(self):
        event = self.store_event(
            data={
                "request": {
                    "url": "http://example.com",
                    "method": "POST",
                    "headers": {"Referer": "http://example.com/foo"},
                }
            },
            project_id=self.project.id,
        )

        result = self.plugin.get_event_payload(event)
        assert result["event"]["request_url"] == "http://example.com/"
        assert result["event"]["request_method"] == "POST"
        assert result["event"]["request_referer"] == "http://example.com/foo"

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/splunk/test_plugin.py" startline="94" endline="107" pcid="11522">
    def test_error_payload(self):
        event = self.store_event(
            data={
                "exception": {"values": [{"type": "ValueError", "value": "foo bar"}]},
                "type": "error",
            },
            project_id=self.project.id,
        )

        result = self.plugin.get_event_payload(event)
        assert result["event"]["type"] == "error"
        assert result["event"]["exception_type"] == "ValueError"
        assert result["event"]["exception_value"] == "foo bar"

</source>
</class>

<class classid="463" nclones="2" nlines="13" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/heroku/test_plugin.py" startline="126" endline="138" pcid="11562">
    def test_user_success(self):
        user = self.create_user()
        organization = self.create_organization(owner=user)
        project = self.create_project(organization=organization)
        hook = HerokuReleaseHook(project)
        hook.set_refs = Mock()

        req = Mock()
        req.POST = {"head_long": "abcd123", "url": "http://example.com", "user": user.email}
        hook.handle(req)
        assert Release.objects.filter(version=req.POST["head_long"]).exists()
        assert hook.set_refs.call_count == 1

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/heroku/test_plugin.py" startline="139" endline="155" pcid="11563">
    def test_actor_email_success(self):
        user = self.create_user()
        organization = self.create_organization(owner=user)
        project = self.create_project(organization=organization)
        hook = HerokuReleaseHook(project)
        hook.set_refs = Mock()

        req = Mock()
        req.POST = {
            "head_long": "v999",
            "url": "http://example.com",
            "actor": {"email": user.email},
        }
        hook.handle(req)
        assert Release.objects.filter(version=req.POST["head_long"]).exists()
        assert hook.set_refs.call_count == 1

</source>
</class>

<class classid="464" nclones="2" nlines="27" similarity="88">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/pushover/test_plugin.py" startline="35" endline="67" pcid="11570">
    def test_simple_notification(self):
        responses.add("POST", "https://api.pushover.net/1/messages.json", body=SUCCESS)
        self.plugin.set_option("userkey", "abcdef", self.project)
        self.plugin.set_option("apikey", "ghijkl", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning"}, project_id=self.project.id
        )
        group = event.group

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        request = responses.calls[0].request
        payload = parse_qs(request.body)
        assert payload == {
            "message": [f"{event.title}\n\nTags: level=warning"],
            "title": ["Bar: Hello world"],
            "url": [
                f"http://example.com/organizations/baz/issues/{group.id}/?referrer=pushover_plugin"
            ],
            "url_title": ["Issue Details"],
            "priority": ["0"],
            "user": ["abcdef"],
            "token": ["ghijkl"],
            "expire": ["90"],
            "retry": ["30"],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/pushover/test_plugin.py" startline="69" endline="104" pcid="11571">
    def test_emergency_notification(self):
        responses.add("POST", "https://api.pushover.net/1/messages.json", body=SUCCESS)
        self.plugin.set_option("userkey", "abcdef", self.project)
        self.plugin.set_option("apikey", "ghijkl", self.project)
        self.plugin.set_option("priority", "2", self.project)
        self.plugin.set_option("expire", 90, self.project)
        self.plugin.set_option("retry", 30, self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning"}, project_id=self.project.id
        )
        group = event.group

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        request = responses.calls[0].request
        payload = parse_qs(request.body)
        assert payload == {
            "message": [f"{event.title}\n\nTags: level=warning"],
            "title": ["Bar: Hello world"],
            "url": [
                f"http://example.com/organizations/baz/issues/{group.id}/?referrer=pushover_plugin"
            ],
            "url_title": ["Issue Details"],
            "priority": ["2"],
            "user": ["abcdef"],
            "token": ["ghijkl"],
            "expire": ["90"],
            "retry": ["30"],
        }

</source>
</class>

<class classid="465" nclones="2" nlines="33" similarity="96">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/trello/test_plugin.py" startline="192" endline="231" pcid="11598">
    def test_view_autocomplete(self):
        responses.add(
            responses.GET,
            "https://api.trello.com/1/search",
            json={
                "cards": [
                    {"id": "4fsdafad", "name": "KeyError", "idShort": 1, "shortLink": "0lr"},
                    {"id": "f4usdfa", "name": "Key Missing", "idShort": 3, "shortLink": "9lf"},
                ]
            },
        )

        request = self.make_request(user=self.user, method="GET")
        request.GET["autocomplete_field"] = "issue_id"
        request.GET["autocomplete_query"] = "Key"

        response = self.plugin.view_autocomplete(request, self.group)
        assert response.data == {
            "issue_id": [
                {"id": "0lr", "text": "(#1) KeyError"},
                {"id": "9lf", "text": "(#3) Key Missing"},
            ]
        }

        request = responses.calls[0].request
        url = urlparse(request.url)
        query = dict(parse_qsl(url.query))

        assert url.path == "/1/search"
        assert query == {
            "cards_limit": "100",
            "partial": "true",
            "modelTypes": "cards",
            "token": "7c8951d1",
            "card_fields": "name,shortLink,idShort",
            "key": "39g",
            "query": "Key",
            "idOrganizations": "f187",
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/trello/test_plugin.py" startline="233" endline="272" pcid="11599">
    def test_view_autocomplete_no_org(self):
        self.plugin.unset_option("organization", self.project)

        responses.add(
            responses.GET,
            "https://api.trello.com/1/search",
            json={
                "cards": [
                    {"id": "4fsdafad", "name": "KeyError", "idShort": 1, "shortLink": "0lr"},
                    {"id": "f4usdfa", "name": "Key Missing", "idShort": 3, "shortLink": "9lf"},
                ]
            },
        )

        request = self.make_request(user=self.user, method="GET")
        request.GET["autocomplete_field"] = "issue_id"
        request.GET["autocomplete_query"] = "Key"

        response = self.plugin.view_autocomplete(request, self.group)
        assert response.data == {
            "issue_id": [
                {"id": "0lr", "text": "(#1) KeyError"},
                {"id": "9lf", "text": "(#3) Key Missing"},
            ]
        }

        request = responses.calls[0].request
        url = urlparse(request.url)
        query = dict(parse_qsl(url.query))

        assert url.path == "/1/search"
        assert query == {
            "cards_limit": "100",
            "partial": "true",
            "modelTypes": "cards",
            "token": "7c8951d1",
            "card_fields": "name,shortLink,idShort",
            "key": "39g",
            "query": "Key",
        }
</source>
</class>

<class classid="466" nclones="3" nlines="20" similarity="71">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="94" endline="117" pcid="11618">
    def test_delete_repository(self):
        responses.add(
            responses.DELETE,
            "https://api.github.com/repos/getsentry/example-repo/hooks/123456",
            json={},
        )
        user = self.create_user()
        organization = self.create_organization()
        UserSocialAuth.objects.create(
            user=user, provider="github", extra_data={"access_token": "abcdefg"}
        )
        repo = Repository.objects.create(
            provider="github",
            name="example-repo",
            organization_id=organization.id,
            config={
                "name": "getsentry/example-repo",
                "external_id": "654321",
                "webhook_id": "123456",
            },
        )

        self.provider.delete_repository(repo, user)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="119" endline="141" pcid="11619">
    def test_update_repository_without_webhook(self):
        responses.add(
            responses.POST,
            "https://api.github.com/repos/getsentry/example-repo/hooks",
            json={"id": "123456", "events": ["push", "pull_request"]},
        )
        user = self.create_user()
        organization = self.create_organization()
        UserSocialAuth.objects.create(
            user=user, provider="github", extra_data={"access_token": "abcdefg"}
        )
        repo = Repository.objects.create(
            provider="github",
            name="example-repo",
            organization_id=organization.id,
            config={"name": "getsentry/example-repo", "external_id": "654321"},
        )

        self.provider.update_repository(repo, user)

        assert repo.config["webhook_id"] == "123456"
        assert repo.config["webhook_events"] == ["push", "pull_request"]

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="143" endline="170" pcid="11620">
    def test_update_repository_with_webhook(self):
        responses.add(
            responses.PATCH,
            "https://api.github.com/repos/getsentry/example-repo/hooks/123456",
            json={"id": "123456", "events": ["push", "pull_request"]},
        )
        user = self.create_user()
        organization = self.create_organization()
        UserSocialAuth.objects.create(
            user=user, provider="github", extra_data={"access_token": "abcdefg"}
        )
        repo = Repository.objects.create(
            provider="github",
            name="example-repo",
            organization_id=organization.id,
            config={
                "name": "getsentry/example-repo",
                "external_id": "654321",
                "webhook_id": "123456",
            },
        )

        self.provider.update_repository(repo, user)

        assert repo.config["webhook_id"] == "123456"
        assert repo.config["webhook_events"] == ["push", "pull_request"]


</source>
</class>

<class classid="467" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="214" endline="228" pcid="11624">
    def test_compare_commits_no_start(self, mock_get_last_commits):
        organization = self.create_organization()
        integration = Integration.objects.create(provider="github_apps", external_id="1")
        repo = Repository.objects.create(
            name="example-repo",
            provider="github_apps",
            organization_id=organization.id,
            integration_id=integration.id,
            config={"name": "example-repo"},
        )

        self.provider.compare_commits(repo, None, "a" * 40)

        assert mock_get_last_commits.called

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/github/test_provider.py" startline="230" endline="243" pcid="11625">
    def test_compare_commits(self, mock_compare_commits):
        organization = self.create_organization()
        integration = Integration.objects.create(provider="github_apps", external_id="1")
        repo = Repository.objects.create(
            name="example-repo",
            provider="github_apps",
            organization_id=organization.id,
            integration_id=integration.id,
            config={"name": "example-repo"},
        )

        self.provider.compare_commits(repo, "b" * 40, "a" * 40)

        assert mock_compare_commits.called
</source>
</class>

<class classid="468" nclones="3" nlines="27" similarity="75">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/slack/test_plugin.py" startline="28" endline="63" pcid="11674">
    def test_simple_notification(self):
        responses.add("POST", "http://example.com/slack")
        self.plugin.set_option("webhook", "http://example.com/slack", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning", "culprit": "foo.bar"},
            project_id=self.project.id,
        )
        group = event.group

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        request = responses.calls[0].request
        payload = json.loads(parse_qs(request.body)["payload"][0])
        assert payload == {
            "username": "Sentry",
            "attachments": [
                {
                    "color": LEVEL_TO_COLOR["warning"],
                    "fields": [
                        {"short": False, "value": "foo.bar", "title": "Culprit"},
                        {"short": True, "value": "bar", "title": "Project"},
                    ],
                    "fallback": "[bar] Hello world",
                    "title": "Hello world",
                    "title_link": "http://example.com/organizations/baz/issues/%s/?referrer=slack"
                    % group.id,
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/slack/test_plugin.py" startline="99" endline="132" pcid="11676">
    def test_notification_without_project(self):
        responses.add("POST", "http://example.com/slack")
        self.plugin.set_option("webhook", "http://example.com/slack", self.project)
        self.plugin.set_option("exclude_project", True, self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning", "culprit": "foo.bar"},
            project_id=self.project.id,
        )
        group = event.group

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        request = responses.calls[0].request
        payload = json.loads(parse_qs(request.body)["payload"][0])
        assert payload == {
            "username": "Sentry",
            "attachments": [
                {
                    "color": LEVEL_TO_COLOR["warning"],
                    "fields": [{"short": False, "value": "foo.bar", "title": "Culprit"}],
                    "fallback": "[bar] Hello world",
                    "title": "Hello world",
                    "title_link": "http://example.com/organizations/baz/issues/%s/?referrer=slack"
                    % group.id,
                }
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/slack/test_plugin.py" startline="65" endline="97" pcid="11675">
    def test_notification_without_culprit(self):
        responses.add("POST", "http://example.com/slack")
        self.plugin.set_option("webhook", "http://example.com/slack", self.project)
        self.plugin.set_option("exclude_culprit", True, self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning"}, project_id=self.project.id
        )
        group = event.group

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        request = responses.calls[0].request
        payload = json.loads(parse_qs(request.body)["payload"][0])
        assert payload == {
            "username": "Sentry",
            "attachments": [
                {
                    "color": LEVEL_TO_COLOR["warning"],
                    "fields": [{"short": True, "value": "bar", "title": "Project"}],
                    "fallback": "[bar] Hello world",
                    "title": "Hello world",
                    "title_link": "http://example.com/organizations/baz/issues/%s/?referrer=slack"
                    % group.id,
                }
            ],
        }

</source>
</class>

<class classid="469" nclones="2" nlines="15" similarity="86">
<source file="systems/sentry-22.2.0/tests/sentry_plugins/slack/test_plugin.py" startline="134" endline="157" pcid="11677">
    def test_no_error_on_404(self):
        responses.add("POST", "http://example.com/slack", status=404)
        self.plugin.set_option("webhook", "http://example.com/slack", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning", "culprit": "foo.bar"},
            project_id=self.project.id,
        )

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        # No exception since 404s are supposed to be ignored
        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        responses.replace("POST", "http://example.com/slack", status=400)

        # Other exceptions should not be ignored
        with self.options({"system.url-prefix": "http://example.com"}):
            with pytest.raises(ApiError):
                self.plugin.notify(notification)

</source>
<source file="systems/sentry-22.2.0/tests/sentry_plugins/slack/test_plugin.py" startline="159" endline="181" pcid="11678">
    def test_no_error_on_ignorable_slack_errors(self):
        responses.add("POST", "http://example.com/slack", status=403, body="action_prohibited")
        self.plugin.set_option("webhook", "http://example.com/slack", self.project)

        event = self.store_event(
            data={"message": "Hello world", "level": "warning", "culprit": "foo.bar"},
            project_id=self.project.id,
        )

        rule = Rule.objects.create(project=self.project, label="my rule")

        notification = Notification(event=event, rule=rule)

        # No exception since certain errors are supposed to be ignored
        with self.options({"system.url-prefix": "http://example.com"}):
            self.plugin.notify(notification)

        responses.replace("POST", "http://example.com/slack", status=403, body="some_other_error")

        # Other exceptions should not be ignored
        with self.options({"system.url-prefix": "http://example.com"}):
            with pytest.raises(ApiError):
                self.plugin.notify(notification)
</source>
</class>

<class classid="470" nclones="4" nlines="22" similarity="71">
<source file="systems/sentry-22.2.0/tests/snuba/sessions/test_sessions_v2.py" startline="297" endline="327" pcid="11705">
def test_massage_simple_timeseries():
    """A timeseries is filled up when it only receives partial data"""

    query = _make_query("statsPeriod=1d&interval=6h&field=sum(session)")
    result_totals = [{"sessions": 4}]
    # snuba returns the datetimes as strings for now
    result_timeseries = [
        {"sessions": 2, "bucketed_started": "2020-12-18T06:00:00+00:00"},
        {"sessions": 2, "bucketed_started": "2020-12-17T12:00:00+00:00"},
    ]

    expected_result = {
        "start": "2020-12-17T12:00:00Z",
        "end": "2020-12-18T11:15:00Z",
        "query": "",
        "intervals": [
            "2020-12-17T12:00:00Z",
            "2020-12-17T18:00:00Z",
            "2020-12-18T00:00:00Z",
            "2020-12-18T06:00:00Z",
        ],
        "groups": [
            {"by": {}, "series": {"sum(session)": [2, 0, 0, 2]}, "totals": {"sum(session)": 4}}
        ],
    }

    actual_result = result_sorted(massage_sessions_result(query, result_totals, result_timeseries))

    assert actual_result == expected_result


</source>
<source file="systems/sentry-22.2.0/tests/snuba/sessions/test_sessions_v2.py" startline="386" endline="415" pcid="11708">
def test_massage_exact_timeseries():
    query = _make_query(
        "start=2020-12-17T15:12:34Z&end=2020-12-18T11:14:17Z&interval=6h&field=sum(session)"
    )
    result_totals = [{"sessions": 4}]
    result_timeseries = [
        {"sessions": 2, "bucketed_started": "2020-12-18T06:00:00+00:00"},
        {"sessions": 2, "bucketed_started": "2020-12-17T12:00:00+00:00"},
    ]

    expected_result = {
        "start": "2020-12-17T12:00:00Z",
        "end": "2020-12-18T12:00:00Z",
        "query": "",
        "intervals": [
            "2020-12-17T12:00:00Z",
            "2020-12-17T18:00:00Z",
            "2020-12-18T00:00:00Z",
            "2020-12-18T06:00:00Z",
        ],
        "groups": [
            {"by": {}, "series": {"sum(session)": [2, 0, 0, 2]}, "totals": {"sum(session)": 4}}
        ],
    }

    actual_result = result_sorted(massage_sessions_result(query, result_totals, result_timeseries))

    assert actual_result == expected_result


</source>
<source file="systems/sentry-22.2.0/tests/snuba/sessions/test_sessions_v2.py" startline="329" endline="359" pcid="11706">
def test_massage_unordered_timeseries():
    query = _make_query("statsPeriod=1d&interval=6h&field=sum(session)")
    result_totals = [{"sessions": 10}]
    # snuba returns the datetimes as strings for now
    result_timeseries = [
        {"sessions": 3, "bucketed_started": "2020-12-18T00:00:00+00:00"},
        {"sessions": 2, "bucketed_started": "2020-12-17T18:00:00+00:00"},
        {"sessions": 4, "bucketed_started": "2020-12-18T06:00:00+00:00"},
        {"sessions": 1, "bucketed_started": "2020-12-17T12:00:00+00:00"},
    ]

    expected_result = {
        "start": "2020-12-17T12:00:00Z",
        "end": "2020-12-18T11:15:00Z",
        "query": "",
        "intervals": [
            "2020-12-17T12:00:00Z",
            "2020-12-17T18:00:00Z",
            "2020-12-18T00:00:00Z",
            "2020-12-18T06:00:00Z",
        ],
        "groups": [
            {"by": {}, "series": {"sum(session)": [1, 2, 3, 4]}, "totals": {"sum(session)": 10}}
        ],
    }

    actual_result = result_sorted(massage_sessions_result(query, result_totals, result_timeseries))

    assert actual_result == expected_result


</source>
<source file="systems/sentry-22.2.0/tests/snuba/sessions/test_sessions_v2.py" startline="361" endline="385" pcid="11707">
def test_massage_no_timeseries():

    query = _make_query("statsPeriod=1d&interval=6h&field=sum(session)&groupby=projects")
    result_totals = [{"sessions": 4}]
    # snuba returns the datetimes as strings for now
    result_timeseries = None

    expected_result = {
        "start": "2020-12-17T12:00:00Z",
        "end": "2020-12-18T11:15:00Z",
        "query": "",
        "intervals": [
            "2020-12-17T12:00:00Z",
            "2020-12-17T18:00:00Z",
            "2020-12-18T00:00:00Z",
            "2020-12-18T06:00:00Z",
        ],
        "groups": [{"by": {}, "totals": {"sum(session)": 4}}],
    }

    actual_result = result_sorted(massage_sessions_result(query, result_totals, result_timeseries))

    assert actual_result == expected_result


</source>
</class>

<class classid="471" nclones="2" nlines="19" similarity="73">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="85" endline="106" pcid="11719">
    def test_transaction_event(self):
        data = {
            "event_id": "a" * 32,
            "type": "transaction",
            "transaction": "api.issue.delete",
            "spans": [],
            "contexts": {"trace": {"op": "foobar", "trace_id": "a" * 32, "span_id": "a" * 16}},
            "tags": {"important": "yes"},
            "timestamp": iso_format(before_now(minutes=1)),
            "start_timestamp": iso_format(before_now(minutes=1, seconds=3)),
        }
        self.store_event(data=data, project_id=self.project.id)
        url = reverse(
            "sentry-api-0-organization-events-meta",
            kwargs={"organization_slug": self.project.organization.slug},
        )
        with self.feature(self.features):
            response = self.client.get(url, {"query": "transaction.duration:>1"}, format="json")

        assert response.status_code == 200, response.content
        assert response.data["count"] == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="107" endline="126" pcid="11720">
    def test_transaction_event_with_last_seen(self):
        data = {
            "event_id": "a" * 32,
            "type": "transaction",
            "transaction": "api.issue.delete",
            "spans": [],
            "contexts": {"trace": {"op": "foobar", "trace_id": "a" * 32, "span_id": "a" * 16}},
            "tags": {"important": "yes"},
            "timestamp": iso_format(before_now(minutes=1)),
            "start_timestamp": iso_format(before_now(minutes=1, seconds=3)),
        }
        self.store_event(data=data, project_id=self.project.id)
        with self.feature(self.features):
            response = self.client.get(
                self.url, {"query": "event.type:transaction last_seen():>2012-12-31"}, format="json"
            )

        assert response.status_code == 200, response.content
        assert response.data["count"] == 1

</source>
</class>

<class classid="472" nclones="2" nlines="12" similarity="91">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="127" endline="139" pcid="11721">
    def test_out_of_retention(self):
        with self.feature(self.features):
            with self.options({"system.event-retention-days": 10}):
                response = self.client.get(
                    self.url,
                    format="json",
                    data={
                        "start": iso_format(before_now(days=20)),
                        "end": iso_format(before_now(days=15)),
                    },
                )
        assert response.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="552" endline="564" pcid="12157">
    def test_out_of_retention(self):
        with self.options({"system.event-retention-days": 10}):
            with self.feature(self.features):
                response = self.client.get(
                    self.url,
                    format="json",
                    data={
                        "start": iso_format(before_now(days=20)),
                        "end": iso_format(before_now(days=15)),
                    },
                )
        assert response.status_code == 400

</source>
</class>

<class classid="473" nclones="2" nlines="25" similarity="96">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="151" endline="183" pcid="11723">
    def test_quantize_dates(self, mock_quantize):
        mock_quantize.return_value = before_now(days=1).replace(tzinfo=utc)
        with self.feature(self.features):
            # Don't quantize short time periods
            self.client.get(
                self.url,
                format="json",
                data={"statsPeriod": "1h", "query": "", "field": ["id", "timestamp"]},
            )
            # Don't quantize absolute date periods
            self.client.get(
                self.url,
                format="json",
                data={
                    "start": iso_format(before_now(days=20)),
                    "end": iso_format(before_now(days=15)),
                    "query": "",
                    "field": ["id", "timestamp"],
                },
            )

            assert len(mock_quantize.mock_calls) == 0

            # Quantize long date periods
            self.client.get(
                self.url,
                format="json",
                data={"field": ["id", "timestamp"], "statsPeriod": "90d", "query": ""},
            )

            assert len(mock_quantize.mock_calls) == 2


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="566" endline="598" pcid="12158">
    def test_quantize_dates(self, mock_quantize):
        mock_quantize.return_value = before_now(days=1).replace(tzinfo=utc)
        with self.feature("organizations:discover-basic"):
            # Don't quantize short time periods
            self.client.get(
                self.url,
                format="json",
                data={"statsPeriod": "1h", "query": "", "field": ["id", "timestamp"]},
            )
            # Don't quantize absolute date periods
            self.client.get(
                self.url,
                format="json",
                data={
                    "start": iso_format(before_now(days=20)),
                    "end": iso_format(before_now(days=15)),
                    "query": "",
                    "field": ["id", "timestamp"],
                },
            )

            assert len(mock_quantize.mock_calls) == 0

            # Quantize long date periods
            self.client.get(
                self.url,
                format="json",
                data={"field": ["id", "timestamp"], "statsPeriod": "90d", "query": ""},
            )

            assert len(mock_quantize.mock_calls) == 2


</source>
</class>

<class classid="474" nclones="3" nlines="15" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="194" endline="213" pcid="11726">
    def test_find_related_issue(self):
        self.login_as(user=self.user)

        project = self.create_project()
        event1 = self.store_event(
            data={"timestamp": iso_format(before_now(minutes=1)), "transaction": "/beth/sanchez"},
            project_id=project.id,
        )

        url = reverse(
            "sentry-api-0-organization-related-issues",
            kwargs={"organization_slug": project.organization.slug},
        )
        response = self.client.get(url, {"transaction": "/beth/sanchez"}, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["shortId"] == event1.group.qualified_short_id
        assert int(response.data[0]["id"]) == event1.group_id

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="235" endline="252" pcid="11728">
    def test_related_issues_no_matching_groups(self):
        self.login_as(user=self.user)

        project = self.create_project()
        self.store_event(
            data={"timestamp": iso_format(before_now(minutes=1)), "transaction": "/beth/sanchez"},
            project_id=project.id,
        )

        url = reverse(
            "sentry-api-0-organization-related-issues",
            kwargs={"organization_slug": project.organization.slug},
        )
        response = self.client.get(url, {"transaction": "/morty/sanchez"}, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 0

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="214" endline="234" pcid="11727">
    def test_related_issues_no_transaction(self):
        self.login_as(user=self.user)

        project = self.create_project()
        self.store_event(
            data={"timestamp": iso_format(before_now(minutes=1)), "transaction": "/beth/sanchez"},
            project_id=project.id,
        )

        url = reverse(
            "sentry-api-0-organization-related-issues",
            kwargs={"organization_slug": project.organization.slug},
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 400, response.content
        assert (
            response.data["detail"]
            == "Must provide one of ['transaction'] in order to find related events"
        )

</source>
</class>

<class classid="475" nclones="2" nlines="31" similarity="78">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="253" endline="286" pcid="11729">
    def test_related_issues_only_issues_in_date(self):
        self.login_as(user=self.user)

        project = self.create_project()
        self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(days=2)),
                "transaction": "/beth/sanchez",
            },
            project_id=project.id,
        )
        event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "transaction": "/beth/sanchez",
            },
            project_id=project.id,
        )

        url = reverse(
            "sentry-api-0-organization-related-issues",
            kwargs={"organization_slug": project.organization.slug},
        )
        response = self.client.get(
            url, {"transaction": "/beth/sanchez", "statsPeriod": "24h"}, format="json"
        )

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["shortId"] == event2.group.qualified_short_id
        assert int(response.data[0]["id"]) == event2.group_id

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_meta.py" startline="287" endline="323" pcid="11730">
    def test_related_issues_transactions_from_different_projects(self):
        self.login_as(user=self.user)

        project1 = self.create_project()
        project2 = self.create_project()
        event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "transaction": "/beth/sanchez",
            },
            project_id=project1.id,
        )
        self.store_event(
            data={
                "event_id": "b" * 32,
                "timestamp": iso_format(before_now(minutes=1)),
                "transaction": "/beth/sanchez",
            },
            project_id=project2.id,
        )

        url = reverse(
            "sentry-api-0-organization-related-issues",
            kwargs={"organization_slug": project1.organization.slug},
        )
        response = self.client.get(
            url,
            {"transaction": "/beth/sanchez", "project": project1.id},
            format="json",
        )

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["shortId"] == event1.group.qualified_short_id
        assert int(response.data[0]["id"]) == event1.group_id

</source>
</class>

<class classid="476" nclones="19" nlines="17" similarity="72">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="55" endline="74" pcid="11733">
    def test(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["environment", "platform.name"],
                    "start": iso_format(datetime.now() - timedelta(seconds=10)),
                    "end": iso_format(datetime.now()),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert response.data["data"][0]["environment"] == "production"
        assert response.data["data"][0]["platform.name"] == "python"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="260" endline="277" pcid="11741">
    def test_strip_double_quotes_in_condition_strings(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["environment"],
                    "conditions": [["environment", "=", '"production"']],
                    "range": "14d",
                    "orderby": "-timestamp",
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert response.data["data"][0]["environment"] == "production"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="296" endline="313" pcid="11743">
    def test_array_condition_equals(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "conditions": [["error.type", "=", "ValidationError"]],
                    "fields": ["message"],
                    "start": (datetime.now() - timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "end": (datetime.now()).strftime("%Y-%m-%dT%H:%M:%S"),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="515" endline="535" pcid="11754">
    def test_superuser(self):
        self.new_org = self.create_organization(name="foo_new")
        self.new_project = self.create_project(name="bar_new", organization=self.new_org)
        self.login_as(user=self.user, superuser=True)

        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.new_org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.new_project.id],
                    "fields": ["message", "platform"],
                    "start": iso_format(datetime.now() - timedelta(seconds=10)),
                    "end": iso_format(datetime.now()),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )

        assert response.status_code == 200, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="75" endline="92" pcid="11734">
    def test_with_discover_basic(self):
        # Dashboards requires access to the discover1 endpoints for now.
        # But newer saas plans don't include discover1, only discover2 (discover-basic).
        with self.feature("organizations:discover-basic"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["environment", "platform.name"],
                    "start": iso_format(datetime.now() - timedelta(seconds=10)),
                    "end": iso_format(datetime.now()),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )
        assert response.status_code == 200, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="314" endline="332" pcid="11744">
    def test_array_condition_not_equals(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "conditions": [["error.type", "!=", "ValidationError"]],
                    "fields": ["message"],
                    "start": (datetime.now() - timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "end": (datetime.now()).strftime("%Y-%m-%dT%H:%M:%S"),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 0

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="220" endline="237" pcid="11739">
    def test_invalid_aggregation_function(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["message", "platform"],
                    "aggregations": [["test", "test", "test"]],
                    "range": "14d",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="203" endline="219" pcid="11738">
    def test_invalid_range_value(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["message", "platform"],
                    "range": "1x",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )

        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="442" endline="459" pcid="11750">
    def test_uniq_project_name(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "aggregations": [["uniq", "project.name", "uniq_project_name"]],
                    "range": "14d",
                    "orderby": "-uniq_project_name",
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert (response.data["data"][0]["uniq_project_name"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="93" endline="112" pcid="11735">
    def test_relative_dates(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["environment", "platform.name"],
                    "range": "1d",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert response.data["data"][0]["environment"] == "production"
        assert response.data["data"][0]["platform.name"] == "python"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="333" endline="351" pcid="11745">
    def test_array_condition_custom_tag(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "conditions": [["error.custom", "!=", "custom"]],
                    "fields": ["message"],
                    "start": (datetime.now() - timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "end": (datetime.now()).strftime("%Y-%m-%dT%H:%M:%S"),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 0

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="239" endline="259" pcid="11740">
    def test_boolean_condition(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["environment", "platform.name"],
                    "conditions": [["stack.in_app", "=", True]],
                    "start": (datetime.now() - timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "end": (datetime.now()).strftime("%Y-%m-%dT%H:%M:%S"),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert response.data["data"][0]["environment"] == "production"
        assert response.data["data"][0]["platform.name"] == "python"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="278" endline="295" pcid="11742">
    def test_array_join(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["message", "error.type"],
                    "start": (datetime.now() - timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "end": (datetime.now() + timedelta(seconds=10)).strftime("%Y-%m-%dT%H:%M:%S"),
                    "orderby": "-timestamp",
                    "range": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert response.data["data"][0]["error.type"] == "ValidationError"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="498" endline="514" pcid="11753">
    def test_invalid_project(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.other_project.id],
                    "fields": ["message", "platform"],
                    "range": "14d",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )

        assert response.status_code == 403, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="352" endline="369" pcid="11746">
    def test_select_project_name(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["project.name"],
                    "range": "14d",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert (response.data["data"][0]["project.name"]) == "bar"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="370" endline="389" pcid="11747">
    def test_groupby_project_name(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "aggregations": [["count()", "", "count"]],
                    "fields": ["project.name"],
                    "range": "14d",
                    "orderby": "-count",
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 1
        assert (response.data["data"][0]["project.name"]) == "bar"
        assert (response.data["data"][0]["count"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="482" endline="497" pcid="11752">
    def test_no_feature_access(self):
        url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
        with self.feature({"organizations:discover": False, "organizations:discover-basic": False}):
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["message", "platform"],
                    "range": "14d",
                    "orderby": "-timestamp",
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 404, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="460" endline="481" pcid="11751">
    def test_meta_types(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "fields": ["project.id", "project.name"],
                    "aggregations": [["count()", "", "count"]],
                    "range": "14d",
                    "orderby": "-count",
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 200, response.content
        assert response.data["meta"] == [
            {"name": "project.id", "type": "integer"},
            {"name": "project.name", "type": "string"},
            {"name": "count", "type": "integer"},
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_query.py" startline="390" endline="412" pcid="11748">
    def test_zerofilled_dates_when_rollup_relative(self):
        with self.feature("organizations:discover"):
            url = reverse("sentry-api-0-discover-query", args=[self.org.slug])
            response = self.client.post(
                url,
                {
                    "projects": [self.project.id],
                    "aggregations": [["count()", "", "count"]],
                    "fields": ["project.name"],
                    "groupby": ["time"],
                    "orderby": "time",
                    "range": "5d",
                    "rollup": 86400,
                    "start": None,
                    "end": None,
                },
            )
        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 6
        assert (response.data["data"][5]["time"]) > response.data["data"][4]["time"]
        assert (response.data["data"][5]["project.name"]) == "bar"
        assert (response.data["data"][5]["count"]) == 1

</source>
</class>

<class classid="477" nclones="2" nlines="24" similarity="70">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_tagkey_values.py" startline="120" endline="147" pcid="11765">
    def test_snuba_column(self):
        self.store_event(
            data={"timestamp": iso_format(self.day_ago), "user": {"email": "foo@example.com"}},
            project_id=self.project.id,
        )
        self.store_event(
            data={"timestamp": iso_format(self.min_ago), "user": {"email": "bar@example.com"}},
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "timestamp": iso_format(before_now(seconds=10)),
                "user": {"email": "baz@example.com"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "timestamp": iso_format(before_now(seconds=10)),
                "user": {"email": "baz@example.com"},
            },
            project_id=self.project.id,
        )
        self.run_test(
            "user.email",
            expected=[("baz@example.com", 2), ("bar@example.com", 1), ("foo@example.com", 1)],
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_tagkey_values.py" startline="148" endline="169" pcid="11766">
    def test_release(self):
        self.store_event(
            data={"timestamp": iso_format(self.day_ago), "tags": {"sentry:release": "3.1.2"}},
            project_id=self.project.id,
        )
        self.store_event(
            data={"timestamp": iso_format(self.min_ago), "tags": {"sentry:release": "4.1.2"}},
            project_id=self.project.id,
        )
        self.store_event(
            data={"timestamp": iso_format(self.day_ago), "tags": {"sentry:release": "3.1.2"}},
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "timestamp": iso_format(before_now(seconds=10)),
                "tags": {"sentry:release": "5.1.2"},
            },
            project_id=self.project.id,
        )
        self.run_test("release", expected=[("5.1.2", 1), ("4.1.2", 1), ("3.1.2", 2)])

</source>
</class>

<class classid="478" nclones="4" nlines="15" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_event_details.py" startline="49" endline="65" pcid="11790">
    def test_simple(self):
        url = reverse(
            "sentry-api-0-project-event-details",
            kwargs={
                "event_id": self.cur_event.event_id,
                "project_slug": self.cur_event.project.slug,
                "organization_slug": self.cur_event.project.organization.slug,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.cur_event.event_id)
        assert response.data["nextEventID"] == str(self.next_event.event_id)
        assert response.data["previousEventID"] == str(self.prev_event.event_id)
        assert response.data["groupID"] == str(self.cur_event.group.id)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_event_details.py" startline="83" endline="101" pcid="11792">
    def test_snuba_with_environment(self):
        url = reverse(
            "sentry-api-0-project-event-details",
            kwargs={
                "event_id": self.cur_event.event_id,
                "project_slug": self.cur_event.project.slug,
                "organization_slug": self.cur_event.project.organization.slug,
            },
        )
        response = self.client.get(
            url, format="json", data={"environment": ["production", "staging"]}
        )

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.cur_event.event_id)
        assert response.data["previousEventID"] is None
        assert response.data["nextEventID"] == self.next_event.event_id
        assert response.data["groupID"] == str(self.prev_event.group.id)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_event_details.py" startline="102" endline="117" pcid="11793">
    def test_ignores_different_group(self):
        url = reverse(
            "sentry-api-0-project-event-details",
            kwargs={
                "event_id": self.next_event.event_id,
                "project_slug": self.next_event.project.slug,
                "organization_slug": self.next_event.project.organization.slug,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.next_event.event_id)
        assert response.data["nextEventID"] is None


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_event_details.py" startline="66" endline="82" pcid="11791">
    def test_snuba_no_prev(self):
        url = reverse(
            "sentry-api-0-project-event-details",
            kwargs={
                "event_id": self.prev_event.event_id,
                "project_slug": self.prev_event.project.slug,
                "organization_slug": self.prev_event.project.organization.slug,
            },
        )
        response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.prev_event.event_id)
        assert response.data["previousEventID"] is None
        assert response.data["nextEventID"] == self.cur_event.event_id
        assert response.data["groupID"] == str(self.prev_event.group.id)

</source>
</class>

<class classid="479" nclones="2" nlines="11" similarity="90">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_saved_query_detail.py" startline="40" endline="53" pcid="11802">
    def test_get(self):
        with self.feature(self.feature_name):
            url = reverse(
                "sentry-api-0-discover-saved-query-detail", args=[self.org.slug, self.query_id]
            )
            response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.query_id)
        assert set(response.data["projects"]) == set(self.project_ids)
        assert response.data["fields"] == ["test"]
        assert response.data["conditions"] == []
        assert response.data["limit"] == 10

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_saved_query_detail.py" startline="54" endline="67" pcid="11803">
    def test_get_discover_query_flag(self):
        with self.feature("organizations:discover-query"):
            url = reverse(
                "sentry-api-0-discover-saved-query-detail", args=[self.org.slug, self.query_id]
            )
            response = self.client.get(url)

        assert response.status_code == 200, response.content
        assert response.data["id"] == str(self.query_id)
        assert set(response.data["projects"]) == set(self.project_ids)
        assert response.data["fields"] == ["test"]
        assert response.data["conditions"] == []
        assert response.data["limit"] == 10

</source>
</class>

<class classid="480" nclones="2" nlines="18" similarity="88">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_saved_query_detail.py" startline="139" endline="159" pcid="11808">
    def test_put_query_with_team(self):
        team = self.create_team(organization=self.org, members=[self.user])
        project = self.create_project(organization=self.org, teams=[team])
        query = DiscoverSavedQuery.objects.create(
            organization=self.org,
            created_by=self.user,
            name="Test query",
            query={"fields": ["test"], "conditions": [], "limit": 10},
        )
        query.set_projects([project.id])

        with self.feature(self.feature_name):
            url = reverse(
                "sentry-api-0-discover-saved-query-detail",
                args=[self.org.slug, query.id],
            )

            response = self.client.put(url, {"name": "New query", "projects": [], "range": "24h"})

            assert response.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_discover_saved_query_detail.py" startline="160" endline="181" pcid="11809">
    def test_put_query_without_team(self):
        team = self.create_team(organization=self.org, members=[])
        project = self.create_project(organization=self.org, teams=[team])
        query = DiscoverSavedQuery.objects.create(
            organization=self.org,
            created_by=self.user,
            name="Test query",
            query={"fields": ["test"], "conditions": [], "limit": 10},
        )
        query.set_projects([project.id])

        with self.feature(self.feature_name):
            url = reverse(
                "sentry-api-0-discover-saved-query-detail",
                args=[self.org.slug, query.id],
            )

            response = self.client.put(url, {"name": "New query", "projects": [], "range": "24h"})

            assert response.status_code == 400
            assert "No Projects found, join a Team" == response.data["detail"]

</source>
</class>

<class classid="481" nclones="2" nlines="18" similarity="72">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="112" endline="129" pcid="11823">
    def test_no_projects_available(self):
        response = self.do_request(
            {
                "groupBy": ["project"],
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "category": ["error", "transaction"],
            },
            user=self.user2,
            org=self.org3,
        )

        assert response.status_code == 400, response.content
        assert result_sorted(response.data) == {
            "detail": "No projects available",
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="272" endline="293" pcid="11831">
    def test_user_org_total_all_accessible(self):
        response = self.do_request(
            {
                "project": [-1],
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "category": ["error", "transaction"],
            },
            user=self.user2,
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-14T00:00:00Z"],
            "groups": [
                {"by": {}, "series": {"sum(quantity)": [7]}, "totals": {"sum(quantity)": 7}}
            ],
        }

</source>
</class>

<class classid="482" nclones="4" nlines="11" similarity="80">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="130" endline="143" pcid="11824">
    def test_unknown_field(self):
        response = self.do_request(
            {
                "field": ["summ(qarntenty)"],
                "statsPeriod": "1d",
                "interval": "1d",
            }
        )

        assert response.status_code == 400, response.content
        assert result_sorted(response.data) == {
            "detail": 'Invalid field: "summ(qarntenty)"',
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="144" endline="158" pcid="11825">
    def test_unknown_category(self):
        response = self.do_request(
            {
                "field": ["sum(quantity)"],
                "statsPeriod": "1d",
                "interval": "1d",
                "category": "scoobydoo",
            }
        )

        assert response.status_code == 400, response.content
        assert result_sorted(response.data) == {
            "detail": 'Invalid category: "scoobydoo"',
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="159" endline="174" pcid="11826">
    def test_unknown_outcome(self):
        response = self.do_request(
            {
                "field": ["sum(quantity)"],
                "statsPeriod": "1d",
                "interval": "1d",
                "category": "error",
                "outcome": "scoobydoo",
            }
        )

        assert response.status_code == 400, response.content
        assert result_sorted(response.data) == {
            "detail": 'Invalid outcome: "scoobydoo"',
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="175" endline="187" pcid="11827">
    def test_unknown_groupby(self):
        response = self.do_request(
            {
                "field": ["sum(quantity)"],
                "groupBy": ["cattygory"],
                "statsPeriod": "1d",
                "interval": "1d",
            }
        )

        assert response.status_code == 400, response.content
        assert result_sorted(response.data) == {"detail": 'Invalid groupBy: "cattygory"'}

</source>
</class>

<class classid="483" nclones="3" nlines="29" similarity="71">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="368" endline="398" pcid="11834">
    def test_open_membership_semantics(self):
        self.org.flags.allow_joinleave = True
        self.org.save()
        response = self.do_request(
            {
                "project": [-1],
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "category": ["error", "transaction"],
                "groupBy": ["project"],
            },
            user=self.user2,
        )

        assert response.status_code == 200
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "groups": [
                {
                    "by": {"project": self.project.id},
                    "totals": {"sum(quantity)": 6},
                },
                {
                    "by": {"project": self.project2.id},
                    "totals": {"sum(quantity)": 1},
                },
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="492" endline="522" pcid="11837">
    def test_org_group_by_project(self):
        make_request = functools.partial(
            self.client.get,
            reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug]),
        )
        response = make_request(
            {
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(times_seen)"],
                "groupBy": ["project"],
                "category": ["error", "transaction"],
            }
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "groups": [
                {
                    "by": {"project": self.project.id},
                    "totals": {"sum(times_seen)": 6},
                },
                {
                    "by": {"project": self.project2.id},
                    "totals": {"sum(times_seen)": 1},
                },
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="583" endline="616" pcid="11840">
    def test_reason_filter(self):
        make_request = functools.partial(
            self.client.get,
            reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug]),
        )
        response = make_request(
            {
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(times_seen)"],
                "reason": ["spike_protection"],
                "groupBy": ["category"],
            }
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-14T00:00:00Z"],
            "groups": [
                {
                    "by": {"category": "attachment"},
                    "totals": {"sum(times_seen)": 1},
                    "series": {"sum(times_seen)": [1]},
                },
                {
                    "by": {"category": "transaction"},
                    "totals": {"sum(times_seen)": 1},
                    "series": {"sum(times_seen)": [1]},
                },
            ],
        }

</source>
</class>

<class classid="484" nclones="2" nlines="41" similarity="82">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="400" endline="444" pcid="11835">
    def test_org_simple(self):
        make_request = functools.partial(
            self.client.get, reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug])
        )
        response = make_request(
            {
                "statsPeriod": "2d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "groupBy": ["category", "outcome", "reason"],
            }
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-13T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-13T00:00:00Z", "2021-03-14T00:00:00Z"],
            "groups": [
                {
                    "by": {
                        "outcome": "rate_limited",
                        "reason": "spike_protection",
                        "category": "attachment",
                    },
                    "totals": {"sum(quantity)": 1024},
                    "series": {"sum(quantity)": [0, 1024]},
                },
                {
                    "by": {"outcome": "accepted", "reason": "none", "category": "error"},
                    "totals": {"sum(quantity)": 6},
                    "series": {"sum(quantity)": [0, 6]},
                },
                {
                    "by": {
                        "category": "transaction",
                        "reason": "spike_protection",
                        "outcome": "rate_limited",
                    },
                    "totals": {"sum(quantity)": 1},
                    "series": {"sum(quantity)": [0, 1]},
                },
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="446" endline="490" pcid="11836">
    def test_org_multiple_fields(self):
        make_request = functools.partial(
            self.client.get, reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug])
        )
        response = make_request(
            {
                "statsPeriod": "2d",
                "interval": "1d",
                "field": ["sum(quantity)", "sum(times_seen)"],
                "groupBy": ["category", "outcome", "reason"],
            }
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-13T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-13T00:00:00Z", "2021-03-14T00:00:00Z"],
            "groups": [
                {
                    "by": {
                        "outcome": "rate_limited",
                        "category": "attachment",
                        "reason": "spike_protection",
                    },
                    "totals": {"sum(quantity)": 1024, "sum(times_seen)": 1},
                    "series": {"sum(quantity)": [0, 1024], "sum(times_seen)": [0, 1]},
                },
                {
                    "by": {"outcome": "accepted", "reason": "none", "category": "error"},
                    "totals": {"sum(quantity)": 6, "sum(times_seen)": 6},
                    "series": {"sum(quantity)": [0, 6], "sum(times_seen)": [0, 6]},
                },
                {
                    "by": {
                        "category": "transaction",
                        "reason": "spike_protection",
                        "outcome": "rate_limited",
                    },
                    "totals": {"sum(quantity)": 1, "sum(times_seen)": 1},
                    "series": {"sum(quantity)": [0, 1], "sum(times_seen)": [0, 1]},
                },
            ],
        }

</source>
</class>

<class classid="485" nclones="3" nlines="21" similarity="90">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="557" endline="581" pcid="11839">
    def test_project_filter(self):
        make_request = functools.partial(
            self.client.get,
            reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug]),
        )
        response = make_request(
            {
                "project": self.project.id,
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "category": ["error", "transaction"],
            }
        )

        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-14T00:00:00Z"],
            "groups": [
                {"by": {}, "totals": {"sum(quantity)": 6}, "series": {"sum(quantity)": [6]}}
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="643" endline="665" pcid="11842">
    def test_category_filter(self):
        make_request = functools.partial(
            self.client.get,
            reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug]),
        )
        response = make_request(
            {
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "category": "error",
            }
        )
        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-14T00:00:00Z"],
            "groups": [
                {"by": {}, "totals": {"sum(quantity)": 6}, "series": {"sum(quantity)": [6]}}
            ],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_stats_v2.py" startline="618" endline="641" pcid="11841">
    def test_outcome_filter(self):
        make_request = functools.partial(
            self.client.get,
            reverse("sentry-api-0-organization-stats-v2", args=[self.org.slug]),
        )
        response = make_request(
            {
                "statsPeriod": "1d",
                "interval": "1d",
                "field": ["sum(quantity)"],
                "outcome": "accepted",
                "category": ["error", "transaction"],
            }
        )
        assert response.status_code == 200, response.content
        assert result_sorted(response.data) == {
            "start": "2021-03-14T00:00:00Z",
            "end": "2021-03-14T12:28:00Z",
            "intervals": ["2021-03-14T00:00:00Z"],
            "groups": [
                {"by": {}, "totals": {"sum(quantity)": 6}, "series": {"sum(quantity)": [6]}}
            ],
        }

</source>
</class>

<class classid="486" nclones="2" nlines="25" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_group_events_latest.py" startline="7" endline="36" pcid="11851">
    def setUp(self):
        super().setUp()
        self.login_as(user=self.user)

        project = self.create_project()
        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))

        self.event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "staging",
                "fingerprint": ["group_1"],
                "timestamp": two_min_ago,
            },
            project_id=project.id,
        )

        self.event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "fingerprint": ["group_1"],
                "timestamp": min_ago,
            },
            project_id=project.id,
        )

        self.group = Group.objects.first()

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_group_events_oldest.py" startline="7" endline="35" pcid="11918">
    def setUp(self):
        super().setUp()
        self.login_as(user=self.user)

        project = self.create_project()
        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))

        self.event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "staging",
                "fingerprint": ["group_1"],
                "timestamp": two_min_ago,
            },
            project_id=project.id,
        )
        self.event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "fingerprint": ["group_1"],
                "timestamp": min_ago,
            },
            project_id=project.id,
        )

        self.group = Group.objects.first()

</source>
</class>

<class classid="487" nclones="2" nlines="42" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="57" endline="110" pcid="11857">
    def create_event(self, **kwargs):
        if "span_id" not in kwargs:
            kwargs["span_id"] = "a" * 16

        if "start_timestamp" not in kwargs:
            kwargs["start_timestamp"] = self.min_ago

        if "timestamp" not in kwargs:
            kwargs["timestamp"] = self.min_ago + timedelta(seconds=8)

        if "trace_context" not in kwargs:
            # should appear for all of the pXX metrics
            kwargs["trace_context"] = {
                "op": "http.server",
                "hash": "ab" * 8,
                "exclusive_time": 4.0,
            }

        if "spans" not in kwargs:
            kwargs["spans"] = [
                # should appear for the sum metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=1)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "op": "django.middleware",
                    "description": "middleware span",
                    "hash": "cd" * 8,
                    "exclusive_time": 3.0,
                }
                for x in ["b", "c"]
            ] + [
                # should appear for the count metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=5)),
                    "op": "django.view",
                    "description": "view span",
                    "hash": "ef" * 8,
                    "exclusive_time": 1.0,
                }
                for x in ["d", "e", "f"]
            ]

        data = load_data("transaction", **kwargs)
        data["transaction"] = "root transaction"

        return self.store_event(data, project_id=self.project.id)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_span_ops.py" startline="25" endline="78" pcid="12105">
    def create_event(self, **kwargs):
        if "span_id" not in kwargs:
            kwargs["span_id"] = "a" * 16

        if "start_timestamp" not in kwargs:
            kwargs["start_timestamp"] = self.min_ago

        if "timestamp" not in kwargs:
            kwargs["timestamp"] = self.min_ago + timedelta(seconds=8)

        if "trace_context" not in kwargs:
            # should appear for all of the pXX metrics
            kwargs["trace_context"] = {
                "op": "http.server",
                "hash": "ab" * 8,
                "exclusive_time": 4.0,
            }

        if "spans" not in kwargs:
            kwargs["spans"] = [
                # should appear for the sum metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=1)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "op": "django.middleware",
                    "description": "middleware span",
                    "hash": "cd" * 8,
                    "exclusive_time": 3.0,
                }
                for x in ["b", "c"]
            ] + [
                # should appear for the count metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=5)),
                    "op": "django.view",
                    "description": "view span",
                    "hash": "ef" * 8,
                    "exclusive_time": 1.0,
                }
                for x in ["d", "e", "f"]
            ]

        data = load_data("transaction", **kwargs)
        data["transaction"] = "root transaction"

        return self.store_event(data, project_id=self.project.id)

</source>
</class>

<class classid="488" nclones="2" nlines="48" similarity="77">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="205" endline="257" pcid="11862">
    def suspect_span_group_snuba_results(self, op, event):
        results = {
            "array_join_spans_op": op,
            "any_id": event.event_id,
        }

        if op == "http.server":
            results.update(
                {
                    "array_join_spans_group": "ab" * 8,
                    "count_unique_id": 1,
                    "count": 1,
                    "equation[0]": 1,
                    "sumArray_spans_exclusive_time": 4.0,
                    "percentileArray_spans_exclusive_time_0_50": 4.0,
                    "percentileArray_spans_exclusive_time_0_75": 4.0,
                    "percentileArray_spans_exclusive_time_0_95": 4.0,
                    "percentileArray_spans_exclusive_time_0_99": 4.0,
                }
            )
        elif op == "django.middleware":
            results.update(
                {
                    "array_join_spans_group": "cd" * 8,
                    "count_unique_id": 1,
                    "count": 2,
                    "equation[0]": 2,
                    "sumArray_spans_exclusive_time": 6.0,
                    "percentileArray_spans_exclusive_time_0_50": 3.0,
                    "percentileArray_spans_exclusive_time_0_75": 3.0,
                    "percentileArray_spans_exclusive_time_0_95": 3.0,
                    "percentileArray_spans_exclusive_time_0_99": 3.0,
                }
            )
        elif op == "django.view":
            results.update(
                {
                    "array_join_spans_group": "ef" * 8,
                    "count_unique_id": 1,
                    "count": 3,
                    "equation[0]": 3,
                    "sumArray_spans_exclusive_time": 3.0,
                    "percentileArray_spans_exclusive_time_0_50": 1.0,
                    "percentileArray_spans_exclusive_time_0_75": 1.0,
                    "percentileArray_spans_exclusive_time_0_95": 1.0,
                    "percentileArray_spans_exclusive_time_0_99": 1.0,
                }
            )
        else:
            assert False, f"Unexpected Op: {op}"

        return results

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="349" endline="407" pcid="11864">
    def suspect_span_results(self, op, event):
        results = self.span_example_results(op, event)

        if op == "http.server":
            results.update(
                {
                    "projectId": self.project.id,
                    "project": self.project.slug,
                    "transaction": event.transaction,
                    "op": op,
                    "group": "ab" * 8,
                    "frequency": 1,
                    "count": 1,
                    "sumExclusiveTime": 4.0,
                    "p50ExclusiveTime": 4.0,
                    "p75ExclusiveTime": 4.0,
                    "p95ExclusiveTime": 4.0,
                    "p99ExclusiveTime": 4.0,
                }
            )

        elif op == "django.middleware":
            results.update(
                {
                    "projectId": self.project.id,
                    "project": self.project.slug,
                    "transaction": event.transaction,
                    "frequency": 1,
                    "count": 2,
                    "sumExclusiveTime": 6.0,
                    "p50ExclusiveTime": 3.0,
                    "p75ExclusiveTime": 3.0,
                    "p95ExclusiveTime": 3.0,
                    "p99ExclusiveTime": 3.0,
                }
            )

        elif op == "django.view":
            results.update(
                {
                    "projectId": self.project.id,
                    "project": self.project.slug,
                    "transaction": event.transaction,
                    "frequency": 1,
                    "count": 3,
                    "sumExclusiveTime": 3.0,
                    "p50ExclusiveTime": 1.0,
                    "p75ExclusiveTime": 1.0,
                    "p95ExclusiveTime": 1.0,
                    "p99ExclusiveTime": 1.0,
                }
            )

        else:
            assert False, f"Unexpected Op: {op}"

        return results


</source>
</class>

<class classid="489" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="415" endline="428" pcid="11866">
    def test_no_projects(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        self.login_as(user=user)

        url = reverse(
            self.URL,
            kwargs={"organization_slug": org.slug},
        )

        with self.feature(self.FEATURES):
            response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="976" endline="989" pcid="11882">
    def test_no_projects(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        self.login_as(user=user)

        url = reverse(
            self.URL,
            kwargs={"organization_slug": org.slug},
        )

        with self.feature(self.FEATURES):
            response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content

</source>
</class>

<class classid="490" nclones="2" nlines="15" similarity="70">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="464" endline="478" pcid="11868">
    def test_bad_sort(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-stuff",
                },
                format="json",
            )
        assert response.status_code == 400, response.content
        assert response.data == {
            "detail": "Can only order by one of count, avgOccurrence, sumExclusiveTime, p50ExclusiveTime, p75ExclusiveTime, p95ExclusiveTime, p99ExclusiveTime"
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="782" endline="802" pcid="11875">
    def test_bad_group_filter(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "spanGroup": "cd",
                },
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "spanGroup": [
                ErrorDetail(
                    "spanGroup must be a valid 16 character hex (containing only digits, or a-f characters)",
                    code="invalid",
                )
            ]
        }

</source>
</class>

<class classid="491" nclones="4" nlines="45" similarity="74">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="515" endline="565" pcid="11870">
    def test_sort_sum(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_group_snuba_results("django.middleware", event),
                    self.suspect_span_group_snuba_results("http.server", event),
                    self.suspect_span_group_snuba_results("django.view", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-sumExclusiveTime",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        self.assert_suspect_span(
            response.data,
            [
                self.suspect_span_results("django.middleware", event),
                self.suspect_span_results("http.server", event),
                self.suspect_span_results("django.view", event),
            ],
        )

        assert mock_raw_snql_query.call_count == 1

        # the first call is the get the suspects, and should be using the specified sort
        assert mock_raw_snql_query.call_args_list[0][0][0].orderby == [
            OrderBy(
                exp=Function(
                    "sum",
                    [Function("arrayJoin", [Column("spans.exclusive_time")])],
                    "sumArray_spans_exclusive_time",
                ),
                direction=Direction.DESC,
            )
        ]
        assert (
            mock_raw_snql_query.call_args_list[0][0][1]
            == "api.organization-events-spans-performance-suspects"
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="567" endline="618" pcid="11871">
    def test_sort_count(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_group_snuba_results("django.view", event),
                    self.suspect_span_group_snuba_results("django.middleware", event),
                    self.suspect_span_group_snuba_results("http.server", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-count",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        self.assert_suspect_span(
            response.data,
            [
                self.suspect_span_results("django.view", event),
                self.suspect_span_results("django.middleware", event),
                self.suspect_span_results("http.server", event),
            ],
        )

        assert mock_raw_snql_query.call_count == 1

        # the first call is the get the suspects, and should be using the specified sort
        assert mock_raw_snql_query.call_args_list[0][0][0].orderby == [
            OrderBy(exp=Function("count", [], "count"), direction=Direction.DESC),
            OrderBy(
                exp=Function(
                    "sum",
                    [Function("arrayJoin", [Column("spans.exclusive_time")])],
                    "sumArray_spans_exclusive_time",
                ),
                direction=Direction.DESC,
            ),
        ]
        assert (
            mock_raw_snql_query.call_args_list[0][0][1]
            == "api.organization-events-spans-performance-suspects"
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="620" endline="683" pcid="11872">
    def test_sort_avg_occurrence(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_group_snuba_results("django.view", event),
                    self.suspect_span_group_snuba_results("django.middleware", event),
                    self.suspect_span_group_snuba_results("http.server", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-avgOccurrence",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        self.assert_suspect_span(
            response.data,
            [
                self.suspect_span_results("django.view", event),
                self.suspect_span_results("django.middleware", event),
                self.suspect_span_results("http.server", event),
            ],
        )

        assert mock_raw_snql_query.call_count == 1

        # the first call is the get the suspects, and should be using the specified sort
        assert mock_raw_snql_query.call_args_list[0][0][0].orderby == [
            OrderBy(
                exp=Function(
                    "divide",
                    [
                        Function("count", [], "count"),
                        Function(
                            "nullIf", [Function("uniq", [Column("event_id")], "count_unique_id"), 0]
                        ),
                    ],
                    "equation[0]",
                ),
                direction=Direction.DESC,
            ),
            OrderBy(
                exp=Function(
                    "sum",
                    [Function("arrayJoin", [Column("spans.exclusive_time")])],
                    "sumArray_spans_exclusive_time",
                ),
                direction=Direction.DESC,
            ),
        ]
        assert (
            mock_raw_snql_query.call_args_list[0][0][1]
            == "api.organization-events-spans-performance-suspects"
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="685" endline="745" pcid="11873">
    def test_sort_percentiles(self, mock_raw_snql_query):
        event = self.create_event()

        for i, sort in enumerate(
            [
                "p50ExclusiveTime",
                "p75ExclusiveTime",
                "p95ExclusiveTime",
                "p99ExclusiveTime",
            ]
        ):
            mock_raw_snql_query.side_effect = [
                {
                    "data": [
                        self.suspect_span_group_snuba_results("http.server", event),
                        self.suspect_span_group_snuba_results("django.middleware", event),
                        self.suspect_span_group_snuba_results("django.view", event),
                    ],
                },
            ]

            with self.feature(self.FEATURES):
                response = self.client.get(
                    self.url,
                    data={
                        "project": self.project.id,
                        "sort": f"-{sort}",
                    },
                    format="json",
                )

            assert response.status_code == 200, response.content
            self.assert_suspect_span(
                response.data,
                [
                    self.suspect_span_results("http.server", event),
                    self.suspect_span_results("django.middleware", event),
                    self.suspect_span_results("django.view", event),
                ],
            )

            percentile = sort[1:3]

            assert mock_raw_snql_query.call_count == i + 1

            # the first call is the get the suspects, and should be using the specified sort
            assert mock_raw_snql_query.call_args_list[i][0][0].orderby == [
                OrderBy(
                    exp=Function(
                        f"quantile(0.{percentile.rstrip('0')})",
                        [Function("arrayJoin", [Column("spans.exclusive_time")])],
                        f"percentileArray_spans_exclusive_time_0_{percentile}",
                    ),
                    direction=Direction.DESC,
                )
            ]
            assert (
                mock_raw_snql_query.call_args_list[i][0][1]
                == "api.organization-events-spans-performance-suspects"
            )

</source>
</class>

<class classid="492" nclones="2" nlines="27" similarity="92">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="747" endline="781" pcid="11874">
    def test_op_filter(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {"data": [self.suspect_span_group_snuba_results("django.middleware", event)]},
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "spanOp": "django.middleware",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        self.assert_suspect_span(
            response.data,
            [self.suspect_span_results("django.middleware", event)],
        )

        assert mock_raw_snql_query.call_count == 1

        # the first call should also contain the additional condition on the span op
        assert (
            Condition(
                lhs=Function("arrayJoin", [Column("spans.op")], "array_join_spans_op"),
                op=Op.IN,
                rhs=Function("tuple", ["django.middleware"]),
            )
            in mock_raw_snql_query.call_args_list[0][0][0].where
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="804" endline="838" pcid="11876">
    def test_group_filter(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {"data": [self.suspect_span_group_snuba_results("django.middleware", event)]},
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "spanGroup": "cd" * 8,
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        self.assert_suspect_span(
            response.data,
            [self.suspect_span_results("django.middleware", event)],
        )

        assert mock_raw_snql_query.call_count == 1

        # the first call should also contain the additional condition on the span op
        assert (
            Condition(
                lhs=Function("arrayJoin", [Column("spans.group")], "array_join_spans_group"),
                op=Op.IN,
                rhs=Function("tuple", ["cd" * 8]),
            )
            in mock_raw_snql_query.call_args_list[0][0][0].where
        )

</source>
</class>

<class classid="493" nclones="4" nlines="25" similarity="73">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="840" endline="871" pcid="11877">
    def test_pagination_first_page(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_group_snuba_results("django.middleware", event),
                    # make sure to return 1 extra result to indicate that there is a next page
                    self.suspect_span_group_snuba_results("http.server", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-sumExclusiveTime",
                    "per_page": 1,
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        links = parse_link_header(response["Link"])
        for link, info in links.items():
            assert f"project={self.project.id}" in link
            assert "sort=-sumExclusiveTime" in link
            # first page does not have a previous page, only next
            assert info["results"] == "true" if info["rel"] == "next" else "false"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="907" endline="933" pcid="11879">
    def test_pagination_last_page(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {"data": [self.suspect_span_group_snuba_results("http.server", event)]},
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-sumExclusiveTime",
                    "per_page": 1,
                    "cursor": "0:2:0",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        links = parse_link_header(response["Link"])
        for link, info in links.items():
            assert f"project={self.project.id}" in link
            assert "sort=-sumExclusiveTime" in link
            # last page does not have a next page, only previous
            assert info["results"] == ("true" if info["rel"] == "previous" else "false")

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="1059" endline="1090" pcid="11886">
    def test_per_page(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_examples_snuba_results("http.server", event),
                    self.suspect_span_examples_snuba_results("http.server", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "span": [f"http.server:{'ab' * 8}"],
                    "per_page": 1,
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        assert mock_raw_snql_query.call_count == 1

        self.assert_span_examples(
            response.data,
            [self.span_example_results("http.server", event)],
        )


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="873" endline="905" pcid="11878">
    def test_pagination_middle_page(self, mock_raw_snql_query):
        event = self.create_event()

        mock_raw_snql_query.side_effect = [
            {
                "data": [
                    self.suspect_span_group_snuba_results("http.server", event),
                    # make sure to return 1 extra result to indicate that there is a next page
                    self.suspect_span_group_snuba_results("django.view", event),
                ],
            },
        ]

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={
                    "project": self.project.id,
                    "sort": "-sumExclusiveTime",
                    "per_page": 1,
                    "cursor": "0:1:0",
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        links = parse_link_header(response["Link"])
        for link, info in links.items():
            assert f"project={self.project.id}" in link
            assert "sort=-sumExclusiveTime" in link
            # middle page has both a previous and next
            assert info["results"] == "true"

</source>
</class>

<class classid="494" nclones="2" nlines="27" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="1001" endline="1035" pcid="11884">
    def test_bad_span_param(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "span must consist of of a span op and a valid 16 character hex delimited by a colon (:)",
                    code="invalid",
                )
            ]
        }

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server:ab"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "spanGroup must be a valid 16 character hex (containing only digits, or a-f characters)",
                    code="invalid",
                )
            ]
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="1109" endline="1143" pcid="11889">
    def test_bad_span_param(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "span must consist of of a span op and a valid 16 character hex delimited by a colon (:)",
                    code="invalid",
                )
            ]
        }

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server:ab"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "spanGroup must be a valid 16 character hex (containing only digits, or a-f characters)",
                    code="invalid",
                )
            ]
        }

</source>
</class>

<class classid="495" nclones="4" nlines="12" similarity="76">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="17" endline="31" pcid="11904">
    def do_request(self, query, features=None):
        if features is None:
            features = {
                "organizations:discover-basic": True,
                "organizations:global-views": True,
            }
        features.update(self.features)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-organization-events-has-measurements",
            kwargs={"organization_slug": self.organization.slug},
        )
        with self.feature(features):
            return self.client.get(url, query, format="json")

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="61" endline="72" pcid="12063">
    def do_request(self, query, features=None):
        if features is None:
            features = {"organizations:performance-view": True}
        features.update(self.features)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-organization-events-histogram",
            kwargs={"organization_slug": self.organization.slug},
        )
        with self.feature(features):
            return self.client.get(url, query, format="json")

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_geo.py" startline="13" endline="24" pcid="12126">
    def do_request(self, query, features=None):
        if features is None:
            features = {"organizations:dashboards-basic": True}
        features.update(self.features)
        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-organization-events-geo",
            kwargs={"organization_slug": self.organization.slug},
        )
        with self.feature(features):
            return self.client.get(url, query, format="json")

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_vitals.py" startline="34" endline="49" pcid="12109">
    def do_request(self, query=None, features=None):
        if features is None:
            features = {"organizations:discover-basic": True}
        features.update(self.features)
        if query is None:
            query = self.query

        self.login_as(user=self.user)
        url = reverse(
            "sentry-api-0-organization-events-vitals",
            kwargs={"organization_slug": self.organization.slug},
        )

        with self.feature(features):
            return self.client.get(url, query, format="json")

</source>
</class>

<class classid="496" nclones="9" nlines="11" similarity="72">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="42" endline="57" pcid="11907">
    def test_more_than_one_project(self):
        project = self.create_project()

        response = self.do_request(
            {
                "project": [self.project.id, project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "web",
            }
        )

        assert response.status_code == 400, response.content
        assert response.data == {
            "non_field_errors": [ErrorDetail("Only 1 project allowed.", code="invalid")],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="71" endline="83" pcid="11909">
    def test_no_type(self):
        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
            }
        )

        assert response.status_code == 400, response.content
        assert response.data == {
            "type": [ErrorDetail("This field may not be null.", code="null")],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="58" endline="70" pcid="11908">
    def test_no_transaction(self):
        response = self.do_request(
            {
                "project": [self.project.id],
                "type": "web",
            }
        )

        assert response.status_code == 400, response.content
        assert response.data == {
            "transaction": [ErrorDetail("This field may not be null.", code="null")],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="84" endline="97" pcid="11910">
    def test_unknown_type(self):
        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "foo",
            }
        )

        assert response.status_code == 400, response.content
        assert response.data == {
            "type": [ErrorDetail('"foo" is not a valid choice.', code="invalid_choice")],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="178" endline="194" pcid="11916">
    def test_has_event_and_mobile_measurements(self):
        # make sure the transaction has some mobile measurements
        self.transaction_data["measurements"] = {"app_start_cold": {"value": 100}}
        self.store_event(self.transaction_data, self.project.id)

        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "mobile",
            }
        )

        assert response.status_code == 200, response.content
        assert response.data == {"measurements": True}


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="144" endline="159" pcid="11914">
    def test_has_event_and_web_measurements(self):
        # make sure the transaction has some web measurements
        self.transaction_data["measurements"] = {"lcp": {"value": 100}}
        self.store_event(self.transaction_data, self.project.id)

        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "web",
            }
        )

        assert response.status_code == 200, response.content
        assert response.data == {"measurements": True}

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="110" endline="125" pcid="11912">
    def test_has_event_but_no_web_measurements(self):
        # make sure the transaction doesnt have measurements
        self.transaction_data["measurements"] = {}
        self.store_event(self.transaction_data, self.project.id)

        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "web",
            }
        )

        assert response.status_code == 200, response.content
        assert response.data == {"measurements": False}

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="126" endline="143" pcid="11913">
    def test_has_event_and_no_recent_web_measurements(self):
        # make sure the event is older than 7 days
        transaction_data = load_data("transaction", timestamp=before_now(days=8))
        # make sure the transaction has some web measurements
        transaction_data["measurements"] = {"lcp": {"value": 100}}
        self.store_event(transaction_data, self.project.id)

        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "web",
            }
        )

        assert response.status_code == 200, response.content
        assert response.data == {"measurements": False}

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_has_measurements.py" startline="160" endline="177" pcid="11915">
    def test_has_event_and_no_recent_mobile_measurements(self):
        # make sure the event is older than 7 days
        transaction_data = load_data("transaction", timestamp=before_now(days=8))
        # make sure the transaction has some web measurements
        transaction_data["measurements"] = {"app_start_cold": {"value": 100}}
        self.store_event(transaction_data, self.project.id)

        response = self.do_request(
            {
                "project": [self.project.id],
                "transaction": self.transaction_data["transaction"],
                "type": "mobile",
            }
        )

        assert response.status_code == 200, response.content
        assert response.data == {"measurements": False}

</source>
</class>

<class classid="497" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_tags.py" startline="68" endline="86" pcid="11925">
    def test_tag_caching(self, mock_snuba_query):
        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org)
        self.create_member(organization=org, user=user, teams=[team])
        self.create_project(organization=org, teams=[team])
        self.login_as(user=user)

        with self.options({"snuba.tagstore.cache-tagkeys-rate": 1.0}):
            url = reverse("sentry-api-0-organization-tags", kwargs={"organization_slug": org.slug})
            response = self.client.get(url, {"use_cache": "1", "statsPeriod": "14d"}, format="json")
            assert response.status_code == 200, response.content
            assert mock_snuba_query.call_count == 1

            response = self.client.get(url, {"use_cache": "1", "statsPeriod": "14d"}, format="json")
            assert response.status_code == 200, response.content
            # Cause we're caching, we shouldn't call snuba again
            assert mock_snuba_query.call_count == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_tags.py" startline="88" endline="107" pcid="11926">
    def test_different_statsperiod_caching(self, mock_snuba_query):
        user = self.create_user()
        org = self.create_organization()
        team = self.create_team(organization=org)
        self.create_member(organization=org, user=user, teams=[team])
        self.create_project(organization=org, teams=[team])
        self.login_as(user=user)

        with self.options({"snuba.tagstore.cache-tagkeys-rate": 1.0}):
            url = reverse("sentry-api-0-organization-tags", kwargs={"organization_slug": org.slug})
            response = self.client.get(url, {"use_cache": "1", "statsPeriod": "14d"}, format="json")
            assert response.status_code == 200, response.content
            # Empty cache, we should query snuba
            assert mock_snuba_query.call_count == 1

            response = self.client.get(url, {"use_cache": "1", "statsPeriod": "30d"}, format="json")
            assert response.status_code == 200, response.content
            # With a different statsPeriod, we shouldn't use cache and still query snuba
            assert mock_snuba_query.call_count == 2

</source>
</class>

<class classid="498" nclones="6" nlines="10" similarity="80">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="79" endline="90" pcid="11931">
    def test_simple(self):
        response = self.do_request(
            {
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
            },
        )

        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 1}], [{"count": 2}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="167" endline="179" pcid="11936">
    def test_with_event_count_flag(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "event_count",
            },
        )

        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 1}], [{"count": 2}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="318" endline="328" pcid="11942">
    def test_aggregate_invalid(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "nope(lol)",
            },
        )
        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="283" endline="294" pcid="11939">
    def test_aggregate_function_count(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "count()",
            },
        )
        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 1}], [{"count": 2}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="295" endline="305" pcid="11940">
    def test_invalid_aggregate(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "rubbish",
            },
        )
        assert response.status_code == 400, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="306" endline="317" pcid="11941">
    def test_aggregate_function_user_count(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "count_unique(user)",
            },
        )
        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 1}], [{"count": 1}]]

</source>
</class>

<class classid="499" nclones="7" nlines="16" similarity="70">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="91" endline="107" pcid="11932">
    def test_misaligned_last_bucket(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago - timedelta(minutes=30)),
                "end": iso_format(self.day_ago + timedelta(hours=1, minutes=30)),
                "interval": "1h",
                "partial": "1",
            },
        )

        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [
            [{"count": 0}],
            [{"count": 1}],
            [{"count": 2}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="744" endline="760" pcid="11960">
    def test_with_zerofill(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "30m",
            },
        )

        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [
            [{"count": 1}],
            [{"count": 0}],
            [{"count": 2}],
            [{"count": 0}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="555" endline="576" pcid="11951">
    def test_simple_multiple_yaxis(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": ["user_count", "event_count"],
            },
        )

        assert response.status_code == 200, response.content
        assert response.data["user_count"]["order"] == 0
        assert [attrs for time, attrs in response.data["user_count"]["data"]] == [
            [{"count": 1}],
            [{"count": 1}],
        ]
        assert response.data["event_count"]["order"] == 1
        assert [attrs for time, attrs in response.data["event_count"]["data"]] == [
            [{"count": 1}],
            [{"count": 2}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="594" endline="615" pcid="11953">
    def test_equation_mixed_multi_yaxis(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": ["count()", "equation|count() * 100"],
            },
        )

        assert response.status_code == 200, response.content
        assert response.data["count()"]["order"] == 0
        assert [attrs for time, attrs in response.data["count()"]["data"]] == [
            [{"count": 1}],
            [{"count": 2}],
        ]
        assert response.data["equation|count() * 100"]["order"] == 1
        assert [attrs for time, attrs in response.data["equation|count() * 100"]["data"]] == [
            [{"count": 100}],
            [{"count": 200}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="881" endline="900" pcid="11966">
    def test_equations_divide_by_zero(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                # force a 0 in the denominator by doing 1 - 1
                # since a 0 literal is illegal as the denominator
                "yAxis": ["equation|count() / (1-1)"],
            },
        )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 2
        assert [attrs for time, attrs in response.data["data"]] == [
            [{"count": None}],
            [{"count": None}],
        ]


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="577" endline="593" pcid="11952">
    def test_equation_yaxis(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": ["equation|count() / 100"],
            },
        )

        assert response.status_code == 200, response.content
        assert len(response.data["data"]) == 2
        assert [attrs for time, attrs in response.data["data"]] == [
            [{"count": 0.01}],
            [{"count": 0.02}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="616" endline="637" pcid="11954">
    def test_equation_multi_yaxis(self):
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": ["equation|count() / 100", "equation|count() * 100"],
            },
        )

        assert response.status_code == 200, response.content
        assert response.data["equation|count() / 100"]["order"] == 0
        assert [attrs for time, attrs in response.data["equation|count() / 100"]["data"]] == [
            [{"count": 0.01}],
            [{"count": 0.02}],
        ]
        assert response.data["equation|count() * 100"]["order"] == 1
        assert [attrs for time, attrs in response.data["equation|count() * 100"]["data"]] == [
            [{"count": 100}],
            [{"count": 200}],
        ]

</source>
</class>

<class classid="500" nclones="2" nlines="22" similarity="77">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="120" endline="141" pcid="11934">
    def test_user_count(self):
        self.store_event(
            data={
                "event_id": "d" * 32,
                "message": "something",
                "timestamp": iso_format(self.day_ago + timedelta(minutes=2)),
                "tags": {"sentry:user": self.user2.email},
                "fingerprint": ["group2"],
            },
            project_id=self.project2.id,
        )
        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(hours=2)),
                "interval": "1h",
                "yAxis": "user_count",
            },
        )
        assert response.status_code == 200, response.content
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 2}], [{"count": 1}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="638" endline="661" pcid="11955">
    def test_large_interval_no_drop_values(self):
        self.store_event(
            data={
                "event_id": "d" * 32,
                "message": "not good",
                "timestamp": iso_format(self.day_ago - timedelta(minutes=10)),
                "fingerprint": ["group3"],
            },
            project_id=self.project.id,
        )

        response = self.do_request(
            data={
                "project": self.project.id,
                "end": iso_format(self.day_ago),
                "start": iso_format(self.day_ago - timedelta(hours=24)),
                "query": 'message:"not good"',
                "interval": "1d",
                "yAxis": "count()",
            },
        )
        assert response.status_code == 200
        assert [attrs for time, attrs in response.data["data"]] == [[{"count": 0}], [{"count": 1}]]

</source>
</class>

<class classid="501" nclones="4" nlines="13" similarity="73">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="180" endline="195" pcid="11937">
    def test_performance_view_feature(self):
        response = self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=2)),
                "query": "project_id:1",
                "interval": "30m",
                "yAxis": "count()",
            },
            features={
                "organizations:performance-view": True,
                "organizations:discover-basic": False,
            },
        )
        assert response.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="513" endline="524" pcid="11948">
    def test_project_id_query_filter(self):
        response = self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=2)),
                "query": "project_id:1",
                "interval": "30m",
                "yAxis": "count()",
            },
        )
        assert response.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="525" endline="537" pcid="11949">
    def test_latest_release_query_filter(self):
        response = self.do_request(
            data={
                "project": self.project.id,
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=2)),
                "query": "release:latest",
                "interval": "30m",
                "yAxis": "count()",
            },
        )
        assert response.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="704" endline="716" pcid="11958">
    def test_out_of_retention(self):
        with self.options({"system.event-retention-days": 10}):
            response = self.do_request(
                data={
                    "start": iso_format(before_now(days=20)),
                    "end": iso_format(before_now(days=15)),
                    "query": "",
                    "interval": "30m",
                    "yAxis": "count()",
                },
            )
        assert response.status_code == 400

</source>
</class>

<class classid="502" nclones="4" nlines="31" similarity="87">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="329" endline="365" pcid="11943">
    def test_throughput_epm_hour_rollup(self):
        project = self.create_project()
        # Each of these denotes how many events to create in each hour
        event_counts = [6, 0, 6, 3, 0, 3]
        for hour, count in enumerate(event_counts):
            for minute in range(count):
                self.store_event(
                    data={
                        "event_id": str(uuid.uuid1()),
                        "message": "very bad",
                        "timestamp": iso_format(
                            self.day_ago + timedelta(hours=hour, minutes=minute)
                        ),
                        "fingerprint": ["group1"],
                        "tags": {"sentry:user": self.user.email},
                    },
                    project_id=project.id,
                )

        for axis in ["epm()", "tpm()"]:
            response = self.do_request(
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=6)),
                    "interval": "1h",
                    "yAxis": axis,
                    "project": project.id,
                },
            )
            assert response.status_code == 200, response.content
            data = response.data["data"]
            assert len(data) == 6

            rows = data[0:6]
            for test in zip(event_counts, rows):
                assert test[1][1][0]["count"] == test[0] / (3600.0 / 60.0)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="366" endline="400" pcid="11944">
    def test_throughput_epm_day_rollup(self):
        project = self.create_project()
        # Each of these denotes how many events to create in each minute
        event_counts = [6, 0, 6, 3, 0, 3]
        for hour, count in enumerate(event_counts):
            for minute in range(count):
                self.store_event(
                    data={
                        "event_id": str(uuid.uuid1()),
                        "message": "very bad",
                        "timestamp": iso_format(
                            self.day_ago + timedelta(hours=hour, minutes=minute)
                        ),
                        "fingerprint": ["group1"],
                        "tags": {"sentry:user": self.user.email},
                    },
                    project_id=project.id,
                )

        for axis in ["epm()", "tpm()"]:
            response = self.do_request(
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=24)),
                    "interval": "24h",
                    "yAxis": axis,
                    "project": project.id,
                },
            )
            assert response.status_code == 200, response.content
            data = response.data["data"]
            assert len(data) == 2

            assert data[0][1][0]["count"] == sum(event_counts) / (86400.0 / 60.0)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="438" endline="476" pcid="11946">
    def test_throughput_eps_no_rollup(self):
        project = self.create_project()
        # Each of these denotes how many events to create in each minute
        event_counts = [6, 0, 6, 3, 0, 3]
        for minute, count in enumerate(event_counts):
            for second in range(count):
                self.store_event(
                    data={
                        "event_id": str(uuid.uuid1()),
                        "message": "very bad",
                        "timestamp": iso_format(
                            self.day_ago + timedelta(minutes=minute, seconds=second)
                        ),
                        "fingerprint": ["group1"],
                        "tags": {"sentry:user": self.user.email},
                    },
                    project_id=project.id,
                )

        response = self.do_request(
            data={
                "start": iso_format(self.day_ago),
                "end": iso_format(self.day_ago + timedelta(minutes=1)),
                "interval": "1s",
                "yAxis": "eps()",
                "project": project.id,
            },
        )
        assert response.status_code == 200, response.content
        data = response.data["data"]

        # expect 60 data points between time span of 0 and 60 seconds
        assert len(data) == 60

        rows = data[0:6]

        for row in rows:
            assert row[1][0]["count"] == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="401" endline="437" pcid="11945">
    def test_throughput_eps_minute_rollup(self):
        project = self.create_project()
        # Each of these denotes how many events to create in each minute
        event_counts = [6, 0, 6, 3, 0, 3]
        for minute, count in enumerate(event_counts):
            for second in range(count):
                self.store_event(
                    data={
                        "event_id": str(uuid.uuid1()),
                        "message": "very bad",
                        "timestamp": iso_format(
                            self.day_ago + timedelta(minutes=minute, seconds=second)
                        ),
                        "fingerprint": ["group1"],
                        "tags": {"sentry:user": self.user.email},
                    },
                    project_id=project.id,
                )

        for axis in ["eps()", "tps()"]:
            response = self.do_request(
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(minutes=6)),
                    "interval": "1m",
                    "yAxis": axis,
                    "project": project.id,
                },
            )
            assert response.status_code == 200, response.content
            data = response.data["data"]
            assert len(data) == 6

            rows = data[0:6]
            for test in zip(event_counts, rows):
                assert test[1][1][0]["count"] == test[0] / 60.0

</source>
</class>

<class classid="503" nclones="2" nlines="23" similarity="91">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="677" endline="703" pcid="11957">
    def test_invalid_interval(self, mock_query):
        self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=24)),
                "query": "",
                "interval": "1s",
                "yAxis": "count()",
            },
        )
        assert mock_query.call_count == 1
        # Should've reset to the default for 24h
        assert mock_query.mock_calls[0].args[0][0].rollup == 300

        self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=24)),
                "query": "",
                "interval": "0d",
                "yAxis": "count()",
            },
        )
        assert mock_query.call_count == 2
        # Should've reset to the default for 24h
        assert mock_query.mock_calls[0].args[0][0].rollup == 300

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="854" endline="880" pcid="11965">
    def test_invalid_interval(self, mock_query):
        self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=24)),
                "query": "",
                "interval": "1s",
                "yAxis": "count()",
            },
        )
        assert mock_query.call_count == 1
        # Should've reset to the default for 24h
        assert mock_query.mock_calls[0].args[0][0].granularity.granularity == 300

        self.do_request(
            data={
                "end": iso_format(before_now()),
                "start": iso_format(before_now(hours=24)),
                "query": "",
                "interval": "0d",
                "yAxis": "count()",
            },
        )
        assert mock_query.call_count == 2
        # Should've reset to the default for 24h
        assert mock_query.mock_calls[1].args[0][0].granularity.granularity == 300

</source>
</class>

<class classid="504" nclones="24" nlines="25" similarity="70">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1004" endline="1028" pcid="11968">
    def test_no_top_events_with_project_field(self):
        project = self.create_project()
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    # make sure to query the project with 0 events
                    "project": project.id,
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "project"],
                    "topEvents": 5,
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        # When there are no top events, we do not return an empty dict.
        # Instead, we return a single zero-filled series for an empty graph.
        data = response.data["data"]
        assert [attrs for time, attrs in data] == [[{"count": 0}], [{"count": 0}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1029" endline="1053" pcid="11969">
    def test_no_top_events(self):
        project = self.create_project()
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    # make sure to query the project with 0 events
                    "project": project.id,
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "user.email"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data["data"]
        assert response.status_code == 200, response.content
        # When there are no top events, we do not return an empty dict.
        # Instead, we return a single zero-filled series for an empty graph.
        assert [attrs for time, attrs in data] == [[{"count": 0}], [{"count": 0}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1247" endline="1271" pcid="11976">
    def test_top_events_with_functions(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-p99()"],
                    "field": ["transaction", "avg(transaction.duration)", "p99()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 1

        results = data[self.transaction.transaction]
        assert results["order"] == 0
        assert [attrs for time, attrs in results["data"]] == [[{"count": 3}], [{"count": 0}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="2202" endline="2220" pcid="12002">
    def test_top_events_boolean_condition_and_project_field(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["project", "count()"],
                    "topEvents": 5,
                    "query": "event.type:transaction (transaction:*a OR transaction:b*)",
                },
                format="json",
            )

        assert response.status_code == 200

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1549" endline="1572" pcid="11985">
    def test_top_events_with_int(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "transaction.duration"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 1

        results = data[",".join([self.transaction.transaction, "120000"])]
        assert results["order"] == 0
        assert [attrs for time, attrs in results["data"]] == [[{"count": 3}], [{"count": 0}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1707" endline="1732" pcid="11990">
    def test_top_events_one_field_with_none(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "query": "event.type:transaction",
                    "field": ["count()", "issue"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 1

        results = data["unknown"]
        assert [attrs for time, attrs in results["data"]] == [[{"count": 3}], [{"count": 0}]]
        assert results["order"] == 0

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1272" endline="1306" pcid="11977">
    def test_top_events_with_functions_on_different_transactions(self):
        """Transaction2 has less events, but takes longer so order should be self.transaction then transaction2"""
        transaction_data = load_data("transaction")
        transaction_data["start_timestamp"] = iso_format(self.day_ago + timedelta(minutes=2))
        transaction_data["timestamp"] = iso_format(self.day_ago + timedelta(minutes=6))
        transaction_data["transaction"] = "/foo_bar/"
        transaction2 = self.store_event(transaction_data, project_id=self.project.id)
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-p99()"],
                    "field": ["transaction", "avg(transaction.duration)", "p99()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 2

        results = data[self.transaction.transaction]
        assert results["order"] == 1
        assert [attrs for time, attrs in results["data"]] == [[{"count": 3}], [{"count": 0}]]

        results = data[transaction2.transaction]
        assert results["order"] == 0
        assert [attrs for time, attrs in results["data"]] == [[{"count": 1}], [{"count": 0}]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1222" endline="1246" pcid="11975">
    def test_top_events_with_issue_check_query_conditions(self, mock_query):
        """ "Intentionally separate from test_top_events_with_issue

        This is to test against a bug where the condition for issues wasn't included and we'd be missing data for
        the interval since we'd cap out the max rows. This was not caught by the previous test since the results
        would still be correct given the smaller interval & lack of data
        """
        with self.feature(self.enabled_features):
            self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "issue"],
                    "topEvents": 5,
                    "query": "!event.type:transaction",
                },
                format="json",
            )

        assert ["group_id", "IN", [1]] in mock_query.mock_calls[1].kwargs["conditions"]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1341" endline="1374" pcid="11979">
    def test_top_events_with_negated_condition(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "query": f"!message:{self.events[0].message}",
                    "field": ["message", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[1:5]):
            message = event.message or event.transaction
            results = data[message]
            assert results["order"] == index
            assert [{"count": self.event_data[index + 1]["count"]}] in [
                attrs for _, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 1}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1187" endline="1217" pcid="11974">
    def test_top_events_with_unknown_issue(self, mock_issues_mapping):
        event = self.events[0]
        event_data = self.event_data[0]

        # ensure that the issue mapping returns None for the issue
        mock_issues_mapping.return_value = {event.group.id: None}

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "issue"],
                    "topEvents": 5,
                    # narrow the search to just one issue
                    "query": f"issue.id:{event.group.id}",
                },
                format="json",
            )
        assert response.status_code == 200, response.content

        data = response.data
        assert len(data) == 1
        results = data["unknown"]
        assert results["order"] == 0
        assert [{"count": event_data["count"]}] in [attrs for time, attrs in results["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1307" endline="1340" pcid="11978">
    def test_top_events_with_query(self):
        transaction_data = load_data("transaction")
        transaction_data["start_timestamp"] = iso_format(self.day_ago + timedelta(minutes=2))
        transaction_data["timestamp"] = iso_format(self.day_ago + timedelta(minutes=6))
        transaction_data["transaction"] = "/foo_bar/"
        self.store_event(transaction_data, project_id=self.project.id)
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-p99()"],
                    "query": "transaction:/foo_bar/",
                    "field": ["transaction", "avg(transaction.duration)", "p99()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 1

        transaction2_data = data["/foo_bar/"]
        assert transaction2_data["order"] == 0
        assert [attrs for time, attrs in transaction2_data["data"]] == [
            [{"count": 1}],
            [{"count": 0}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="2174" endline="2201" pcid="12001">
    def test_top_events_with_issue_check_query_conditions(self, mock_query):
        """ "Intentionally separate from test_top_events_with_issue

        This is to test against a bug where the condition for issues wasn't included and we'd be missing data for
        the interval since we'd cap out the max rows. This was not caught by the previous test since the results
        would still be correct given the smaller interval & lack of data
        """
        with self.feature(self.enabled_features):
            self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "issue"],
                    "topEvents": 5,
                    "query": "!event.type:transaction",
                },
                format="json",
            )

        assert (
            Condition(Function("coalesce", [Column("group_id"), 0], "issue.id"), Op.IN, [1])
            in mock_query.mock_calls[1].args[0].where
        )

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1514" endline="1548" pcid="11984">
    def test_top_events_with_timestamp(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "query": "event.type:default",
                    "field": ["count()", "message", "timestamp"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6
        # Transactions won't be in the results because of the query
        del self.events[4]
        del self.event_data[4]

        for index, event in enumerate(self.events[:5]):
            results = data[",".join([event.message, event.timestamp])]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 1}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1375" endline="1408" pcid="11980">
    def test_top_events_with_epm(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "epm()",
                    "orderby": ["-count()"],
                    "field": ["message", "user.email", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[
                ",".join([message, self.event_data[index]["data"]["user"].get("email", "None")])
            ]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"] / (3600.0 / 60.0)}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 0.05}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1633" endline="1667" pcid="11988">
    def test_top_events_with_user_display(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["message", "user.display", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            user = self.event_data[index]["data"]["user"]
            results = data[
                ",".join([message, user.get("email", None) or user.get("ip_address", "None")])
            ]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for _, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 3}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1054" endline="1087" pcid="11970">
    def test_simple_top_events(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "user.email"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[
                ",".join([message, self.event_data[index]["data"]["user"].get("email", "None")])
            ]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for _, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 3}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1863" endline="1896" pcid="11994">
    def test_top_events_with_equations(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "equation|count() / 100",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "user.email", "equation|count() / 100"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[
                ",".join([message, self.event_data[index]["data"]["user"].get("email", "None")])
            ]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"] / 100}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 0.03}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1110" endline="1141" pcid="11972">
    def test_top_events_with_projects(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "project"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 6
        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[",".join([message, event.project.slug])]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 3}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="2012" endline="2043" pcid="11997">
    def test_top_events_other_with_matching_columns(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "tags[shared-tag]", "message"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[",".join([message, "yup"])]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for _, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 3}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1669" endline="1705" pcid="11989">
    def test_top_events_none_filter(self):
        """When a field is None in one of the top events, make sure we filter by it

        In this case event[4] is a transaction and has no issue
        """
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "issue"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 5

        for index, event in enumerate(self.events[:5]):
            if event.group is None:
                issue = "unknown"
            else:
                issue = event.group.qualified_short_id

            results = data[issue]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1452" endline="1483" pcid="11982">
    def test_top_events_with_boolean(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "device.charging"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[",".join(["False", message])]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 3}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1787" endline="1815" pcid="11992">
    def test_top_events_with_aggregate_condition(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["message", "count()"],
                    "query": "count():>4",
                    "topEvents": 5,
                },
                format="json",
            )

        assert response.status_code == 200, response.content
        data = response.data
        assert len(data) == 3

        for index, event in enumerate(self.events[:3]):
            message = event.message or event.transaction
            results = data[message]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1142" endline="1185" pcid="11973">
    def test_top_events_with_issue(self):
        # delete a group to make sure if this happens the value becomes unknown
        event_group = self.events[0].group
        event_group.delete()

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()"],
                    "field": ["count()", "message", "issue"],
                    "topEvents": 5,
                    "query": "!event.type:transaction",
                },
                format="json",
            )

        data = response.data

        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:4]):
            message = event.message
            # Because we deleted the group for event 0
            if index == 0 or event.group is None:
                issue = "unknown"
            else:
                issue = event.group.qualified_short_id

            results = data[",".join([issue, message])]
            assert results["order"] == index
            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert [{"count": 1}] in [attrs for _, attrs in other["data"]]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1409" endline="1451" pcid="11981">
    def test_top_events_with_multiple_yaxis(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": ["epm()", "count()"],
                    "orderby": ["-count()"],
                    "field": ["message", "user.email", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 6

        for index, event in enumerate(self.events[:5]):
            message = event.message or event.transaction
            results = data[
                ",".join([message, self.event_data[index]["data"]["user"].get("email", "None")])
            ]
            assert results["order"] == index
            assert results["epm()"]["order"] == 0
            assert results["count()"]["order"] == 1
            assert [{"count": self.event_data[index]["count"] / (3600.0 / 60.0)}] in [
                attrs for time, attrs in results["epm()"]["data"]
            ]

            assert [{"count": self.event_data[index]["count"]}] in [
                attrs for time, attrs in results["count()"]["data"]
            ]

        other = data["Other"]
        assert other["order"] == 5
        assert other["epm()"]["order"] == 0
        assert other["count()"]["order"] == 1
        assert [{"count": 0.05}] in [attrs for _, attrs in other["epm()"]["data"]]
        assert [{"count": 3}] in [attrs for _, attrs in other["count()"]["data"]]

</source>
</class>

<class classid="505" nclones="2" nlines="27" similarity="96">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1573" endline="1602" pcid="11986">
    def test_top_events_with_user(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()", "user"],
                    "field": ["user", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 5

        assert data["email:bar@example.com"]["order"] == 1
        assert [attrs for time, attrs in data["email:bar@example.com"]["data"]] == [
            [{"count": 7}],
            [{"count": 0}],
        ]
        assert [attrs for time, attrs in data["ip:127.0.0.1"]["data"]] == [
            [{"count": 3}],
            [{"count": 0}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1603" endline="1632" pcid="11987">
    def test_top_events_with_user_and_email(self):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                data={
                    "start": iso_format(self.day_ago),
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "yAxis": "count()",
                    "orderby": ["-count()", "user"],
                    "field": ["user", "user.email", "count()"],
                    "topEvents": 5,
                },
                format="json",
            )

        data = response.data
        assert response.status_code == 200, response.content
        assert len(data) == 5

        assert data["email:bar@example.com,bar@example.com"]["order"] == 1
        assert [attrs for time, attrs in data["email:bar@example.com,bar@example.com"]["data"]] == [
            [{"count": 7}],
            [{"count": 0}],
        ]
        assert [attrs for time, attrs in data["ip:127.0.0.1,None"]["data"]] == [
            [{"count": 3}],
            [{"count": 0}],
        ]

</source>
</class>

<class classid="506" nclones="2" nlines="67" similarity="95">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="1899" endline="1975" pcid="11995">
    def test_invalid_interval(self, mock_raw_query, mock_bulk_query):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    # 7,200 points for each event
                    "start": iso_format(before_now(seconds=7200)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                },
            )
        assert response.status_code == 200
        assert mock_bulk_query.call_count == 1

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    "start": iso_format(before_now(seconds=7200)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                    # 7,200 points for each event * 2, should error
                    "topEvents": 2,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 2
        # Should've reset to the default for between 1 and 24h
        assert mock_raw_query.mock_calls[1].kwargs["rollup"] == 300

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    # 1999 points * 5 events should just be enough to not error
                    "start": iso_format(before_now(seconds=1999)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                    "topEvents": 5,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 4
        # Should've left the interval alone since we're just below the limit
        assert mock_raw_query.mock_calls[3].kwargs["rollup"] == 1

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    "start": iso_format(before_now(hours=24)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "0d",
                    "yAxis": "count()",
                    "topEvents": 5,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 6
        # Should've default to 24h's default of 5m
        assert mock_raw_query.mock_calls[5].kwargs["rollup"] == 300

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_stats.py" startline="2093" endline="2169" pcid="12000">
    def test_invalid_interval(self, mock_raw_query, mock_bulk_query):
        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    # 7,200 points for each event
                    "start": iso_format(before_now(seconds=7200)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                },
            )
        assert response.status_code == 200
        assert mock_bulk_query.call_count == 1

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    "start": iso_format(before_now(seconds=7200)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                    # 7,200 points for each event * 2, should error
                    "topEvents": 2,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 2
        # Should've reset to the default for between 1 and 24h
        assert mock_raw_query.mock_calls[1].args[0].granularity.granularity == 300

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    # 1999 points * 5 events should just be enough to not error
                    "start": iso_format(before_now(seconds=1999)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "1s",
                    "yAxis": "count()",
                    "topEvents": 5,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 4
        # Should've left the interval alone since we're just below the limit
        assert mock_raw_query.mock_calls[3].args[0].granularity.granularity == 1

        with self.feature(self.enabled_features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(before_now()),
                    "start": iso_format(before_now(hours=24)),
                    "field": ["count()", "issue"],
                    "query": "",
                    "interval": "0d",
                    "yAxis": "count()",
                    "topEvents": 5,
                },
            )
        assert response.status_code == 200
        assert mock_raw_query.call_count == 6
        # Should've default to 24h's default of 5m
        assert mock_raw_query.mock_calls[5].args[0].granularity.granularity == 300

</source>
</class>

<class classid="507" nclones="17" nlines="28" similarity="72">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="60" endline="89" pcid="12007">
    def test_simple(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendType": "regression",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 2000,
                "count_percentage": 3.0,
                "trend_difference": 0.0,
                "trend_percentage": 1.0,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="526" endline="563" pcid="12023">
    def test_p95(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p95()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 9200,
                "count_percentage": 3.0,
                "trend_difference": 7200.0,
                "trend_percentage": 4.6,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 9200}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="152" endline="181" pcid="12010">
    def test_p95(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p95()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 9200,
                "count_percentage": 3.0,
                "trend_difference": 7200.0,
                "trend_percentage": 4.6,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="450" endline="487" pcid="12021">
    def test_web_vital(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p50(measurements.lcp)",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 2000,
                "count_percentage": 3.0,
                "trend_difference": 0.0,
                "trend_percentage": 1.0,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 2000}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="602" endline="639" pcid="12025">
    def test_avg_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "interval": "1h",
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "avg(transaction.duration)",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 4000,
                "count_percentage": 3.0,
                "trend_difference": 2000.0,
                "trend_percentage": 2.0,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 4000}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="488" endline="525" pcid="12022">
    def test_p75(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p75()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 6000,
                "count_percentage": 3.0,
                "trend_difference": 4000.0,
                "trend_percentage": 3.0,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 6000}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="338" endline="369" pcid="12017">
    def test_divide_by_zero(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    # Set the timeframe to where the second range has no transactions so all the counts/percentile are 0
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago - timedelta(hours=2)),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "count_range_2": 4,
                "count_range_1": 0,
                "aggregate_range_1": 0,
                "aggregate_range_2": 2000.0,
                "count_percentage": None,
                "trend_difference": 0,
                "trend_percentage": None,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="564" endline="601" pcid="12024">
    def test_p99(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p99()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 9840,
                "count_percentage": 3.0,
                "trend_difference": 7840.0,
                "trend_percentage": 4.92,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 9840}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="182" endline="211" pcid="12011">
    def test_p99(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p99()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 9840,
                "count_percentage": 3.0,
                "trend_difference": 7840.0,
                "trend_percentage": 4.92,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="370" endline="403" pcid="12018">
    def test_auto_aggregation(self):
        # absolute_correlation is automatically added, and not a part of data otherwise
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    # Set the timeframe to where the second range has no transactions so all the counts/percentile are 0
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago - timedelta(hours=2)),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction absolute_correlation():>0.2",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "count_range_2": 4,
                "count_range_1": 0,
                "aggregate_range_1": 0,
                "aggregate_range_2": 2000.0,
                "count_percentage": None,
                "trend_difference": 0,
                "trend_percentage": None,
            }
        )
        self.assert_event(events["data"][0])


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="122" endline="151" pcid="12009">
    def test_p75(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "p75()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 6000,
                "count_percentage": 3.0,
                "trend_difference": 4000.0,
                "trend_percentage": 3.0,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="292" endline="321" pcid="12015">
    def test_avg_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "avg(transaction.duration)",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 4000,
                "count_percentage": 3.0,
                "trend_difference": 2000.0,
                "trend_percentage": 2.0,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="90" endline="121" pcid="12008">
    def test_web_vital(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendType": "regression",
                    "trendFunction": "p50(measurements.lcp)",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1
        # LCP values are identical to duration
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 2000,
                "count_percentage": 3.0,
                "trend_difference": 0.0,
                "trend_percentage": 1.0,
            }
        )
        self.assert_event(events["data"][0])

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="413" endline="449" pcid="12020">
    def test_simple(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "aggregate_range_1": 2000,
                "aggregate_range_2": 2000,
                "count_percentage": 3.0,
                "trend_difference": 0.0,
                "trend_percentage": 1.0,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 2000}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="790" endline="832" pcid="12030">
    def test_divide_by_zero(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    # Set the timeframe to where the second range has no transactions so all the counts/percentile are 0
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago - timedelta(hours=2)),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "count_range_2": 4,
                "count_range_1": 0,
                "aggregate_range_1": 0,
                "aggregate_range_2": 2000.0,
                "count_percentage": None,
                "trend_difference": 0,
                "trend_percentage": None,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 0}],
            [{"count": 0}],
            [{"count": 2000}],
            [{"count": 2000}],
        ]


</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="686" endline="726" pcid="12027">
    def test_trend_with_middle(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "middle": iso_format(self.day_ago + timedelta(hours=1, minutes=31)),
                    "start": iso_format(self.day_ago),
                    "interval": "1h",
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "avg(transaction.duration)",
                    "project": [self.project.id],
                },
            )
        assert response.status_code == 200, response.content

        events = response.data["events"]
        result_stats = response.data["stats"]

        assert len(events["data"]) == 1
        self.expected_data.update(
            {
                "count_range_2": 2,
                "count_range_1": 2,
                "aggregate_range_1": 1000,
                "aggregate_range_2": 6000,
                "count_percentage": 1.0,
                "trend_difference": 5000.0,
                "trend_percentage": 6.0,
            }
        )
        self.assert_event(events["data"][0])

        stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
        assert [attrs for time, attrs in stats["data"]] == [
            [{"count": 2000}],
            [{"count": 4000}],
        ]

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="640" endline="685" pcid="12026">
    def test_alias_in_conditions(self):
        query_parts = [
            "event.type:transaction",
            "count_percentage():>0.25",
            "count_percentage():<4",
            "trend_percentage():>0%",
        ]
        queries = [" ".join(query_parts), " AND ".join(query_parts)]
        for query in queries:
            with self.feature(self.features):
                response = self.client.get(
                    self.url,
                    format="json",
                    data={
                        "end": iso_format(self.day_ago + timedelta(hours=2)),
                        "interval": "1h",
                        "start": iso_format(self.day_ago),
                        "field": ["project", "transaction"],
                        "query": query,
                        "trendFunction": "avg(transaction.duration)",
                        "project": [self.project.id],
                    },
                )
            assert response.status_code == 200, response.content

            events = response.data["events"]
            result_stats = response.data["stats"]

            assert len(events["data"]) == 1
            self.expected_data.update(
                {
                    "aggregate_range_1": 2000,
                    "aggregate_range_2": 4000,
                    "count_percentage": 3.0,
                    "trend_difference": 2000.0,
                    "trend_percentage": 2.0,
                }
            )
            self.assert_event(events["data"][0])

            stats = result_stats[f"{self.project.slug},{self.prototype['transaction']}"]
            assert [attrs for time, attrs in stats["data"]] == [
                [{"count": 2000}],
                [{"count": 4000}],
            ]

</source>
</class>

<class classid="508" nclones="2" nlines="24" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="212" endline="240" pcid="12012">
    def test_trend_percentage_query_alias(self):
        queries = [
            ("trend_percentage():>0%", "regression", 1),
            ("trend_percentage():392%", "regression", 1),
            ("trend_percentage():>0%", "improved", 0),
            ("trend_percentage():392%", "improved", 0),
        ]
        for query_data in queries:
            with self.feature(self.features):
                response = self.client.get(
                    self.url,
                    format="json",
                    data={
                        "end": iso_format(self.day_ago + timedelta(hours=2)),
                        "start": iso_format(self.day_ago),
                        "field": ["project", "transaction"],
                        "query": f"event.type:transaction {query_data[0]}",
                        "trendType": query_data[1],
                        # Use p99 since it has the most significant change
                        "trendFunction": "p99()",
                    },
                )

            assert response.status_code == 200, response.content

            events = response.data

            assert len(events["data"]) == query_data[2], query_data

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="263" endline="291" pcid="12014">
    def test_trend_difference_query_alias(self):
        queries = [
            ("trend_difference():>7s", "regression", 1),
            ("trend_difference():7.84s", "regression", 1),
            ("trend_difference():>7s", "improved", 0),
            ("trend_difference():7.84s", "improved", 0),
        ]
        for query_data in queries:
            with self.feature(self.features):
                response = self.client.get(
                    self.url,
                    format="json",
                    data={
                        "end": iso_format(self.day_ago + timedelta(hours=2)),
                        "start": iso_format(self.day_ago),
                        "field": ["project", "transaction"],
                        "query": f"event.type:transaction {query_data[0]}",
                        "trendType": query_data[1],
                        # Use p99 since it has the most significant change
                        "trendFunction": "p99()",
                    },
                )

            assert response.status_code == 200, response.content

            events = response.data

            assert len(events["data"]) == query_data[2], query_data

</source>
</class>

<class classid="509" nclones="3" nlines="17" similarity="72">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="241" endline="262" pcid="12013">
    def test_trend_percentage_query_alias_as_sort(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendType": "improved",
                    "trendFunction": "p50()",
                    "sort": "trend_percentage()",
                },
            )

        assert response.status_code == 200, response.content

        events = response.data

        assert len(events["data"]) == 1

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="322" endline="337" pcid="12016">
    def test_invalid_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "apdex(450)",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="774" endline="789" pcid="12029">
    def test_invalid_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "apdex(450)",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 400

</source>
</class>

<class classid="510" nclones="2" nlines="21" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="870" endline="898" pcid="12033">
    def test_pagination(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    # Set the timeframe to where the second range has no transactions so all the counts/percentile are 0
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago - timedelta(hours=2)),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 200, response.content

            links = self._parse_links(response["Link"])
            assert links["previous"]["results"] == "false"
            assert links["next"]["results"] == "true"
            assert len(response.data["events"]["data"]) == 5

            response = self.client.get(links["next"]["href"], format="json")
            assert response.status_code == 200, response.content

            links = self._parse_links(response["Link"])
            assert links["previous"]["results"] == "true"
            assert links["next"]["results"] == "false"
            assert len(response.data["events"]["data"]) == 5

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="899" endline="920" pcid="12034">
    def test_pagination_with_query(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    # Set the timeframe to where the second range has no transactions so all the counts/percentile are 0
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago - timedelta(hours=2)),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction transaction:transaction_1*",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 200, response.content

            links = self._parse_links(response["Link"])
            assert links["previous"]["results"] == "false"
            assert links["next"]["results"] == "false"
            assert len(response.data["events"]["data"]) == 5


</source>
</class>

<class classid="511" nclones="3" nlines="31" similarity="77">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets_performance_histogram.py" startline="140" endline="176" pcid="12052">
    def test_tag_key_histograms(self):
        self.setup_transactions()
        request = {
            "aggregateColumn": "transaction.duration",
            "sort": "-frequency",
            "statsPeriod": "14d",
            "per_page": 10,
            "numBucketsPerKey": 10,
            "query": "(color:red or color:blue)",
        }
        # With feature access, no tag key
        error_response = self.do_request(request)

        assert error_response.status_code == 400, error_response.content
        assert error_response.data == {"detail": "'tagKey' must be provided when using histograms."}

        # With feature access and tag key
        request["tagKey"] = "color"
        data_response = self.do_request(request)

        histogram_data = data_response.data["histogram"]["data"]
        assert len(histogram_data) == 2
        assert histogram_data[0]["count"] == 14

        assert histogram_data[0]["histogram_transaction_duration_500000_1000000_1"] == 1000000.0
        assert histogram_data[0]["tags_value"] == "red"
        assert histogram_data[0]["tags_key"] == "color"
        assert histogram_data[1]["count"] == 5
        assert histogram_data[1]["histogram_transaction_duration_500000_1000000_1"] == 4000000.0
        assert histogram_data[1]["tags_value"] == "blue"
        assert histogram_data[1]["tags_key"] == "color"

        tag_data = data_response.data["tags"]["data"]
        assert len(tag_data) == 2
        assert tag_data[0]["tags_value"] == "red"
        assert tag_data[1]["tags_value"] == "blue"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets_performance_histogram.py" startline="239" endline="279" pcid="12055">
    def test_histograms_omit_empty_measurements(self):
        self.setup_transactions()
        request = {
            "aggregateColumn": "transaction.duration",
            "sort": "-frequency",
            "statsPeriod": "14d",
            "per_page": 3,
            "numBucketsPerKey": 2,
            "tagKey": "color",
            "query": "(color:red or color:blue or color:green or color:orange)",
        }

        data_response = self.do_request(request)

        assert data_response.data["tags"]["data"][2]["tags_value"] == "green"

        request["aggregateColumn"] = "measurements.lcp"

        data_response = self.do_request(request)

        tags_data = data_response.data["tags"]["data"]
        assert len(tags_data) == 3
        assert tags_data[2]["tags_value"] == "green"

        histogram_data = data_response.data["histogram"]["data"]
        assert len(histogram_data) == 3
        assert histogram_data[0]["count"] == 14
        assert histogram_data[0]["histogram_measurements_lcp_2500_0_1"] == 0.0
        assert histogram_data[0]["tags_value"] == "red"
        assert histogram_data[0]["tags_key"] == "color"

        assert histogram_data[1]["count"] == 5
        assert histogram_data[1]["histogram_measurements_lcp_2500_0_1"] == 2500.0
        assert histogram_data[1]["tags_value"] == "blue"
        assert histogram_data[1]["tags_key"] == "color"

        assert histogram_data[2]["count"] == 1
        assert histogram_data[2]["histogram_measurements_lcp_2500_0_1"] == 5000.0
        assert histogram_data[2]["tags_value"] == "green"
        assert histogram_data[2]["tags_key"] == "color"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets_performance_histogram.py" startline="197" endline="238" pcid="12054">
    def test_tag_key_histogram_buckets(self):
        self.setup_transactions()
        request = {
            "aggregateColumn": "transaction.duration",
            "sort": "-frequency",
            "statsPeriod": "14d",
            "per_page": 1,
            "numBucketsPerKey": 2,
            "tagKey": "color",
            "query": "(color:red or color:blue or color:green)",
        }

        data_response = self.do_request(request)

        histogram_data = data_response.data["histogram"]["data"]
        assert len(histogram_data) == 1
        assert histogram_data[0]["count"] == 14
        assert histogram_data[0]["histogram_transaction_duration_2500000_0_1"] == 0.0
        assert histogram_data[0]["tags_value"] == "red"
        assert histogram_data[0]["tags_key"] == "color"

        request["per_page"] = 3
        data_response = self.do_request(request)

        histogram_data = data_response.data["histogram"]["data"]
        assert len(histogram_data) == 3

        assert histogram_data[0]["count"] == 14
        assert histogram_data[0]["histogram_transaction_duration_2500000_0_1"] == 0.0
        assert histogram_data[0]["tags_value"] == "red"
        assert histogram_data[0]["tags_key"] == "color"

        assert histogram_data[1]["count"] == 5
        assert histogram_data[1]["histogram_transaction_duration_2500000_0_1"] == 2500000.0
        assert histogram_data[1]["tags_value"] == "blue"
        assert histogram_data[1]["tags_key"] == "color"

        assert histogram_data[2]["count"] == 1
        assert histogram_data[2]["histogram_transaction_duration_2500000_0_1"] == 5000000.0
        assert histogram_data[2]["tags_value"] == "green"
        assert histogram_data[2]["tags_key"] == "color"

</source>
</class>

<class classid="512" nclones="12" nlines="13" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="79" endline="91" pcid="12065">
    def test_good_params(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "query": "event.type:transaction",
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="92" endline="107" pcid="12066">
    def test_good_params_with_optionals(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "query": "event.type:transaction",
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "precision": 0,
                "min": 0,
                "max": 10,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="293" endline="306" pcid="12079">
    def test_histogram_empty(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [(i, i + 1, [(f"{alias}.foo", 0), (f"{alias}.bar", 0)]) for i in range(5)]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="215" endline="228" pcid="12074">
    def test_bad_params_num_buckets_too_large(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 150,
            }
            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "numBuckets": ["Ensure this value is less than or equal to 100."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="245" endline="260" pcid="12076">
    def test_bad_params_invalid_precision_too_big(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "precision": 100,
            }

            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "precision": ["Ensure this value is less than or equal to 4."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="108" endline="123" pcid="12067">
    def test_bad_params_reverse_min_max(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "query": "event.type:transaction",
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "precision": 0,
                "min": 10,
                "max": 5,
            }

            response = self.do_request(query)
            assert response.data == {"non_field_errors": ["min cannot be greater than max."]}

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="261" endline="276" pcid="12077">
    def test_bad_params_invalid_min(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "min": "qux",
            }

            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "min": ["A valid number is required."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="201" endline="214" pcid="12073">
    def test_bad_params_invalid_negative_num_buckets(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": -1,
            }
            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "numBuckets": ["Ensure this value is greater than or equal to 1."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="852" endline="867" pcid="12096">
    def test_bad_params_invalid_data_filter(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "dataFilter": "invalid",
            }

            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "dataFilter": ['"invalid" is not a valid choice.'],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="187" endline="200" pcid="12072">
    def test_bad_params_invalid_num_buckets(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": "baz",
            }
            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "numBuckets": ["A valid integer is required."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="229" endline="244" pcid="12075">
    def test_bad_params_invalid_precision_too_small(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "precision": -1,
            }

            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "precision": ["Ensure this value is greater than or equal to 0."],
            }, f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="277" endline="292" pcid="12078">
    def test_bad_params_invalid_max(self):
        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo", f"{alias}.bar"],
                "numBuckets": 10,
                "max": "qux",
            }

            response = self.do_request(query)
            assert response.status_code == 400, f"failing for {array_column}"
            assert response.data == {
                "max": ["A valid number is required."],
            }, f"failing for {array_column}"

</source>
</class>

<class classid="513" nclones="2" nlines="10" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="124" endline="135" pcid="12068">
    def test_bad_params_missing_fields(self):
        query = {
            "project": [self.project.id],
            "numBuckets": 10,
        }

        response = self.do_request(query)
        assert response.status_code == 400
        assert response.data == {
            "field": [ErrorDetail(string="This field is required.", code="required")],
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="176" endline="186" pcid="12071">
    def test_bad_params_missing_num_buckets(self):
        query = {
            "project": [self.project.id],
            "field": ["foo"],
        }
        response = self.do_request(query)
        assert response.status_code == 400
        assert response.data == {
            "numBuckets": ["This field is required."],
        }

</source>
</class>

<class classid="514" nclones="15" nlines="24" similarity="75">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="307" endline="335" pcid="12080">
    def test_histogram_simple(self):
        # range is [0, 5), so it is divided into 5 buckets of width 1
        specs = [
            (0, 1, [("foo", 1)]),
            (1, 2, [("foo", 1)]),
            (2, 3, [("foo", 1)]),
            (4, 5, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1, [(f"{alias}.foo", 1)]),
                (1, 2, [(f"{alias}.foo", 1)]),
                (2, 3, [(f"{alias}.foo", 1)]),
                (3, 4, [(f"{alias}.foo", 0)]),
                (4, 5, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="570" endline="597" pcid="12089">
    def test_histogram_positive_and_negative_values(self):
        # range is [-50, 49], so it is divided into 5 buckets of width 10
        specs = [
            (-50, -50, [("foo", 1)]),
            (-10, 10, [("foo", 2)]),
            (49, 49, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (-50, -30, [(f"{alias}.foo", 1)]),
                (-30, -10, [(f"{alias}.foo", 0)]),
                (-10, 10, [(f"{alias}.foo", 2)]),
                (10, 30, [(f"{alias}.foo", 0)]),
                (30, 50, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="918" endline="945" pcid="12099">
    def test_histogram_missing_measurement_data(self):
        # make sure there is at least one transaction
        specs = [
            (0, 1, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                # make sure to query a measurement that does not exist
                "field": [f"{alias}.bar"],
                "numBuckets": 5,
                "dataFilter": "exclude_outliers",
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1, [(f"{alias}.bar", 0)]),
                (1, 1, [(f"{alias}.bar", 0)]),
                (2, 2, [(f"{alias}.bar", 0)]),
                (3, 3, [(f"{alias}.bar", 0)]),
                (4, 4, [(f"{alias}.bar", 0)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="367" endline="393" pcid="12082">
    def test_histogram_simple_using_given_min_above_queried_max(self):
        # All these events are out of range of the query parameters,
        # and should not appear in the results.
        specs = [
            (0, 1, [("foo", 1)]),
            (1, 2, [("foo", 1)]),
            (2, 3, [("foo", 1)]),
            (4, 5, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "min": 6,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (6, 7, [(f"{alias}.foo", 0)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="421" endline="448" pcid="12084">
    def test_histogram_large_buckets(self):
        # make sure that it works for large width buckets
        # range is [0, 99], so it is divided into 5 buckets of width 20
        specs = [
            (0, 0, [("foo", 2)]),
            (99, 99, [("foo", 2)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 20, [(f"{alias}.foo", 2)]),
                (20, 40, [(f"{alias}.foo", 0)]),
                (40, 60, [(f"{alias}.foo", 0)]),
                (60, 80, [(f"{alias}.foo", 0)]),
                (80, 100, [(f"{alias}.foo", 2)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="394" endline="420" pcid="12083">
    def test_histogram_simple_using_given_max_below_queried_min(self):
        # All these events are out of range of the query parameters,
        # and should not appear in the results.
        specs = [
            (6, 7, [("foo", 1)]),
            (8, 9, [("foo", 1)]),
            (10, 11, [("foo", 1)]),
            (12, 13, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "max": 6,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (5, 6, [(f"{alias}.foo", 0)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="336" endline="366" pcid="12081">
    def test_histogram_simple_using_min_max(self):
        # range is [0, 5), so it is divided into 5 buckets of width 1
        specs = [
            (0, 1, [("foo", 1)]),
            (1, 2, [("foo", 1)]),
            (2, 3, [("foo", 1)]),
            (4, 5, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "min": 0,
                "max": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1, [(f"{alias}.foo", 1)]),
                (1, 2, [(f"{alias}.foo", 1)]),
                (2, 3, [(f"{alias}.foo", 1)]),
                (3, 4, [(f"{alias}.foo", 0)]),
                (4, 5, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="449" endline="477" pcid="12085">
    def test_histogram_non_zero_offset(self):
        # range is [10, 15), so it is divided into 5 buckets of width 1
        specs = [
            (10, 11, [("foo", 1)]),
            (12, 13, [("foo", 1)]),
            (13, 14, [("foo", 1)]),
            (14, 15, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (10, 11, [(f"{alias}.foo", 1)]),
                (11, 12, [(f"{alias}.foo", 0)]),
                (12, 13, [(f"{alias}.foo", 1)]),
                (13, 14, [(f"{alias}.foo", 1)]),
                (14, 15, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="975" endline="1005" pcid="12101">
    def test_histogram_ignores_aggregate_conditions(self):
        # range is [0, 5), so it is divided into 5 buckets of width 1
        specs = [
            (0, 1, [("foo", 1)]),
            (1, 2, [("foo", 1)]),
            (2, 3, [("foo", 1)]),
            (3, 4, [("foo", 0)]),
            (4, 5, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "query": "tpm():>0.001",
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1, [(f"{alias}.foo", 1)]),
                (1, 2, [(f"{alias}.foo", 1)]),
                (2, 3, [(f"{alias}.foo", 1)]),
                (3, 4, [(f"{alias}.foo", 0)]),
                (4, 5, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="868" endline="894" pcid="12097">
    def test_histogram_all_data_filter(self):
        specs = [
            (0, 1, [("foo", 4)]),
            (4000, 5000, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "dataFilter": "all",
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1000, [(f"{alias}.foo", 4)]),
                (1000, 2000, [(f"{alias}.foo", 0)]),
                (2000, 3000, [(f"{alias}.foo", 0)]),
                (3000, 4000, [(f"{alias}.foo", 0)]),
                (4000, 5000, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="946" endline="974" pcid="12100">
    def test_histogram_missing_measurement_data_with_explicit_bounds(self):
        # make sure there is at least one transaction
        specs = [
            (0, 1, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                # make sure to query a measurement that does not exist
                "field": [f"{alias}.bar"],
                "numBuckets": 5,
                "dataFilter": "exclude_outliers",
                "min": 10,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (10, 11, [(f"{alias}.bar", 0)]),
                (11, 11, [(f"{alias}.bar", 0)]),
                (12, 12, [(f"{alias}.bar", 0)]),
                (13, 13, [(f"{alias}.bar", 0)]),
                (14, 14, [(f"{alias}.bar", 0)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="513" endline="540" pcid="12087">
    def test_histogram_non_zero_min_large_buckets(self):
        # range is [10, 59], so it is divided into 5 buckets of width 10
        specs = [
            (10, 10, [("foo", 1)]),
            (40, 50, [("foo", 1)]),
            (59, 59, [("foo", 2)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (10, 20, [(f"{alias}.foo", 1)]),
                (20, 30, [(f"{alias}.foo", 0)]),
                (30, 40, [(f"{alias}.foo", 0)]),
                (40, 50, [(f"{alias}.foo", 1)]),
                (50, 60, [(f"{alias}.foo", 2)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="478" endline="512" pcid="12086">
    def test_histogram_extra_data(self):
        # range is [11, 16), so it is divided into 5 buckets of width 1
        # make sure every bin has some value
        specs = [
            (10, 11, [("foo", 1)]),
            (11, 12, [("foo", 1)]),
            (12, 13, [("foo", 1)]),
            (13, 14, [("foo", 1)]),
            (14, 15, [("foo", 1)]),
            (15, 16, [("foo", 1)]),
            (16, 17, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "min": 11,
                "max": 16,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (11, 12, [(f"{alias}.foo", 1)]),
                (12, 13, [(f"{alias}.foo", 1)]),
                (13, 14, [(f"{alias}.foo", 1)]),
                (14, 15, [(f"{alias}.foo", 1)]),
                (15, 16, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="895" endline="917" pcid="12098">
    def test_histogram_exclude_outliers_data_filter(self):
        specs = [
            (0, 0, [("foo", 4)]),
            (4000, 4001, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "dataFilter": "exclude_outliers",
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (0, 1, [(f"{alias}.foo", 4)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="542" endline="568" pcid="12088">
    def test_histogram_negative_values(self):
        # range is [-9, -4), so it is divided into 5 buckets of width 1
        specs = [
            (-9, -8, [("foo", 3)]),
            (-5, -4, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (-9, -8, [(f"{alias}.foo", 3)]),
                (-8, -7, [(f"{alias}.foo", 0)]),
                (-7, -6, [(f"{alias}.foo", 0)]),
                (-6, -5, [(f"{alias}.foo", 0)]),
                (-5, -4, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
</class>

<class classid="515" nclones="3" nlines="24" similarity="91">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="598" endline="625" pcid="12090">
    def test_histogram_increased_precision(self):
        # range is [1.00, 2.24], so it is divided into 5 buckets of width 0.25
        specs = [
            (1.00, 1.00, [("foo", 3)]),
            (2.24, 2.24, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "precision": 2,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (1.00, 1.25, [(f"{alias}.foo", 3)]),
                (1.25, 1.50, [(f"{alias}.foo", 0)]),
                (1.50, 1.75, [(f"{alias}.foo", 0)]),
                (1.75, 2.00, [(f"{alias}.foo", 0)]),
                (2.00, 2.25, [(f"{alias}.foo", 1)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="654" endline="682" pcid="12092">
    def test_histogram_increased_precision_large_buckets(self):
        # range is [10.0000, 59.9999] so it is divided into 5 buckets of width 10
        specs = [
            (10.0000, 10.0000, [("foo", 1)]),
            (30.0000, 40.0000, [("foo", 1)]),
            (59.9999, 59.9999, [("foo", 2)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 5,
                "precision": 4,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (10.0000, 20.0000, [(f"{alias}.foo", 1)]),
                (20.0000, 30.0000, [(f"{alias}.foo", 0)]),
                (30.0000, 40.0000, [(f"{alias}.foo", 1)]),
                (40.0000, 50.0000, [(f"{alias}.foo", 0)]),
                (50.0000, 60.0000, [(f"{alias}.foo", 2)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="626" endline="653" pcid="12091">
    def test_histogram_increased_precision_with_min_max(self):
        # range is [1.25, 2.24], so it is divided into 5 buckets of width 0.25
        specs = [
            (1.00, 1.25, [("foo", 3)]),
            (2.00, 2.25, [("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.foo"],
                "numBuckets": 3,
                "precision": 2,
                "min": 1.25,
                "max": 2.00,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (1.25, 1.50, [(f"{alias}.foo", 0)]),
                (1.50, 1.75, [(f"{alias}.foo", 0)]),
                (1.75, 2.00, [(f"{alias}.foo", 0)]),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
</class>

<class classid="516" nclones="2" nlines="46" similarity="95">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="751" endline="801" pcid="12094">
    def test_histogram_max_value_on_edge(self):
        # range is [11, 21] so it is divided into 5 buckets of width 5
        # because using buckets of width 2 will exclude 21, and the next
        # nice number is 5
        specs = [
            (11, 11, [("bar", 0), ("baz", 0), ("foo", 1)]),
            (21, 21, [("bar", 1), ("baz", 1), ("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.bar", f"{alias}.baz", f"{alias}.foo"],
                "numBuckets": 5,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (
                    10,
                    15,
                    [
                        (f"{alias}.bar", 0),
                        (f"{alias}.baz", 0),
                        (f"{alias}.foo", 1),
                    ],
                ),
                (
                    15,
                    20,
                    [
                        (f"{alias}.bar", 0),
                        (f"{alias}.baz", 0),
                        (f"{alias}.foo", 0),
                    ],
                ),
                (
                    20,
                    25,
                    [
                        (f"{alias}.bar", 1),
                        (f"{alias}.baz", 1),
                        (f"{alias}.foo", 1),
                    ],
                ),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_histogram.py" startline="802" endline="851" pcid="12095">
    def test_histogram_bins_exceed_max(self):
        specs = [
            (10, 15, [("bar", 0), ("baz", 0), ("foo", 1)]),
            (30, 30, [("bar", 1), ("baz", 1), ("foo", 1)]),
        ]
        self.populate_events(specs)

        for array_column in ARRAY_COLUMNS:
            alias = get_array_column_alias(array_column)
            query = {
                "project": [self.project.id],
                "field": [f"{alias}.bar", f"{alias}.baz", f"{alias}.foo"],
                "numBuckets": 5,
                "min": 10,
                "max": 21,
            }

            response = self.do_request(query)
            assert response.status_code == 200, f"failing for {array_column}"
            expected = [
                (
                    10,
                    15,
                    [
                        (f"{alias}.bar", 0),
                        (f"{alias}.baz", 0),
                        (f"{alias}.foo", 1),
                    ],
                ),
                (
                    15,
                    20,
                    [
                        (f"{alias}.bar", 0),
                        (f"{alias}.baz", 0),
                        (f"{alias}.foo", 0),
                    ],
                ),
                (
                    20,
                    25,
                    [
                        (f"{alias}.bar", 0),
                        (f"{alias}.baz", 0),
                        (f"{alias}.foo", 0),
                    ],
                ),
            ]
            assert response.data == self.as_response_data(expected), f"failing for {array_column}"

</source>
</class>

<class classid="517" nclones="2" nlines="18" similarity="88">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_events.py" startline="55" endline="77" pcid="12137">
    def test_filters_based_on_retention(self):
        self.login_as(user=self.user)

        project = self.create_project()
        self.store_event(data={"timestamp": iso_format(before_now(days=2))}, project_id=project.id)
        event_2 = self.store_event(
            data={"timestamp": iso_format(before_now(minutes=1))}, project_id=project.id
        )

        with self.options({"system.event-retention-days": 1}):
            url = reverse(
                "sentry-api-0-project-events",
                kwargs={
                    "organization_slug": project.organization.slug,
                    "project_slug": project.slug,
                },
            )
            response = self.client.get(url, format="json")

        assert response.status_code == 200, response.content
        assert len(response.data) == 1
        assert response.data[0]["eventID"] == event_2.event_id

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_project_events.py" startline="78" endline="99" pcid="12138">
    def test_limited_to_week(self):
        self.login_as(user=self.user)

        project = self.create_project()
        event = self.store_event(
            data={"timestamp": iso_format(before_now(days=2))}, project_id=project.id
        )
        self.store_event(data={"timestamp": iso_format(before_now(days=8))}, project_id=project.id)

        url = reverse(
            "sentry-api-0-project-events",
            kwargs={
                "organization_slug": project.organization.slug,
                "project_slug": project.slug,
            },
        )

        with self.feature("organizations:project-event-date-limit"):
            response = self.client.get(url, format="json")
            assert response.status_code == 200, response.content
            assert len(response.data) == 1
            assert response.data[0]["eventID"] == event.event_id
</source>
</class>

<class classid="518" nclones="6" nlines="34" similarity="71">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="52" endline="87" pcid="12142">
    def test_simple(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "one"},
            },
            project_id=self.project2.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "one"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "two"},
            },
            project_id=self.project.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, format="json")

        assert response.status_code == 200, response.content
        expected = [
            {"count": 2, "name": "one", "value": "one"},
            {"count": 1, "name": "two", "value": "two"},
        ]
        self.assert_facet(response, "number", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="127" endline="162" pcid="12144">
    def test_with_condition(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "how to make fast",
                "tags": {"color": "green"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Delet the Data",
                "tags": {"color": "red"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Data the Delet ",
                "tags": {"color": "yellow"},
            },
            project_id=self.project2.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, {"query": "color:yellow"}, format="json")

        assert response.status_code == 200, response.content
        expected = [{"count": 1, "name": "yellow", "value": "yellow"}]
        self.assert_facet(response, "color", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="88" endline="126" pcid="12143">
    def test_with_message_query(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "how to make fast",
                "tags": {"color": "green"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Delet the Data",
                "tags": {"color": "red"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Data the Delet ",
                "tags": {"color": "yellow"},
            },
            project_id=self.project2.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, {"query": "delet"}, format="json")

        assert response.status_code == 200, response.content
        expected = [
            {"count": 1, "name": "yellow", "value": "yellow"},
            {"count": 1, "name": "red", "value": "red"},
        ]
        self.assert_facet(response, "color", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="365" endline="404" pcid="12152">
    def test_project_key(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"color": "green"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "one"},
            },
            project_id=self.project2.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"color": "green"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={"event_id": uuid4().hex, "timestamp": self.min_ago_iso, "tags": {"color": "red"}},
            project_id=self.project.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, format="json")

        assert response.status_code == 200, response.content
        expected = [
            {"count": 3, "name": self.project.slug, "value": self.project.id},
            {"count": 1, "name": self.project2.slug, "value": self.project2.id},
        ]
        self.assert_facet(response, "project", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="163" endline="203" pcid="12145">
    def test_with_conditional_filter(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "how to make fast",
                "tags": {"color": "green"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Delet the Data",
                "tags": {"color": "red"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "message": "Data the Delet ",
                "tags": {"color": "yellow"},
            },
            project_id=self.project2.id,
        )

        with self.feature(self.features):
            response = self.client.get(
                self.url, {"query": "color:yellow OR color:red"}, format="json"
            )

        assert response.status_code == 200, response.content
        expected = [
            {"count": 1, "name": "yellow", "value": "yellow"},
            {"count": 1, "name": "red", "value": "red"},
        ]
        self.assert_facet(response, "color", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="253" endline="293" pcid="12147">
    def test_excluded_tag(self):
        self.user = self.create_user()
        self.user2 = self.create_user()
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": iso_format(self.day_ago),
                "message": "very bad",
                "tags": {"sentry:user": self.user.email},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": iso_format(self.day_ago),
                "message": "very bad",
                "tags": {"sentry:user": self.user2.email},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": iso_format(self.day_ago),
                "message": "very bad",
                "tags": {"sentry:user": self.user2.email},
            },
            project_id=self.project.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, format="json", data={"project": [self.project.id]})

        assert response.status_code == 200, response.content
        expected = [
            {"count": 2, "name": self.user2.email, "value": self.user2.email},
            {"count": 1, "name": self.user.email, "value": self.user.email},
        ]
        self.assert_facet(response, "user", expected)

</source>
</class>

<class classid="519" nclones="2" nlines="23" similarity="91">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="313" endline="337" pcid="12150">
    def test_project_selected(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "two"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "one"},
            },
            project_id=self.project2.id,
        )

        with self.feature(self.features):
            response = self.client.get(self.url, {"project": [self.project.id]}, format="json")

        assert response.status_code == 200, response.content
        expected = [{"name": "two", "value": "two", "count": 1}]
        self.assert_facet(response, "number", expected)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_facets.py" startline="338" endline="364" pcid="12151">
    def test_project_filtered(self):
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "two"},
            },
            project_id=self.project.id,
        )
        self.store_event(
            data={
                "event_id": uuid4().hex,
                "timestamp": self.min_ago_iso,
                "tags": {"number": "one"},
            },
            project_id=self.project2.id,
        )

        with self.feature(self.features):
            response = self.client.get(
                self.url, {"query": f"project:{self.project.slug}"}, format="json"
            )

        assert response.status_code == 200, response.content
        expected = [{"name": "two", "value": "two", "count": 1}]
        self.assert_facet(response, "number", expected)

</source>
</class>

<class classid="520" nclones="3" nlines="33" similarity="70">
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="112" endline="151" pcid="12178">
    def test_comparison(self):
        with freeze_time(before_now(minutes=0)):
            # Test data is 4 events in the current period and 2 events in the comparison period, so
            # a 100% increase.
            event = self.store_event(
                data={
                    "fingerprint": ["something_random"],
                    "timestamp": iso_format(before_now(minutes=1)),
                    "user": {"id": uuid4().hex},
                },
                project_id=self.project.id,
            )
            self.increment(
                event,
                3,
                timestamp=now() - timedelta(minutes=1),
            )
            self.increment(
                event,
                2,
                timestamp=now() - timedelta(days=1, minutes=20),
            )
            data = {
                "interval": "1h",
                "value": 99,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertPasses(rule, event)

            data = {
                "interval": "1h",
                "value": 101,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertDoesNotPass(rule, event)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="152" endline="182" pcid="12179">
    def test_comparison_empty_comparison_period(self):
        with freeze_time(before_now(minutes=0)):
            # Test data is 1 event in the current period and 0 events in the comparison period. This
            # should always result in 0 and never fire.
            event = self.store_event(
                data={
                    "fingerprint": ["something_random"],
                    "timestamp": iso_format(before_now(minutes=1)),
                    "user": {"id": uuid4().hex},
                },
                project_id=self.project.id,
            )
            data = {
                "interval": "1h",
                "value": 0,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertDoesNotPass(rule, event)

            data = {
                "interval": "1h",
                "value": 100,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertDoesNotPass(rule, event)


</source>
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="362" endline="404" pcid="12194">
    def test_comparison(self):
        with freeze_time(before_now(minutes=0)):
            self._make_sessions(10, 1)
            # Create sessions for previous period
            self._make_sessions(10, 60 * 24 + 20)

            # Test data is 2 events in the current period and 1 events in the comparison period.
            # Number of sessions is 20 in each period, so current period is 20% of sessions, prev
            # is 10%. Overall a 100% increase comparitively.
            event = self.store_event(
                data={
                    "fingerprint": ["something_random"],
                    "timestamp": iso_format(before_now(minutes=1)),
                },
                project_id=self.project.id,
            )
            self.increment(
                event,
                1,
                timestamp=now() - timedelta(minutes=1),
            )
            self.increment(
                event,
                1,
                timestamp=now() - timedelta(days=1, minutes=20),
            )
            data = {
                "interval": "1h",
                "value": 99,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertPasses(rule, event)

            data = {
                "interval": "1h",
                "value": 101,
                "comparisonType": "percent",
                "comparisonInterval": "1d",
            }
            rule = self.get_rule(data=data, rule=Rule(environment_id=None))
            self.assertDoesNotPass(rule, event)
</source>
</class>

<class classid="521" nclones="3" nlines="13" similarity="84">
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="188" endline="202" pcid="12180">
    def increment(self, event, count, environment=None, timestamp=None):
        data = {
            "fingerprint": event.data["fingerprint"],
            "timestamp": iso_format(timestamp) if timestamp else iso_format(before_now(minutes=1)),
        }
        if environment:
            data["environment"] = environment

        for _ in range(count):
            self.store_event(
                data=data,
                project_id=self.project.id,
            )


</source>
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="211" endline="227" pcid="12181">
    def increment(self, event, count, environment=None, timestamp=None):
        data = {
            "fingerprint": event.data["fingerprint"],
            "timestamp": iso_format(timestamp) if timestamp else iso_format(before_now(minutes=1)),
        }
        if environment:
            data["environment"] = environment

        for _ in range(count):
            event_data = deepcopy(data)
            event_data["user"] = {"id": uuid4().hex}
            self.store_event(
                data=event_data,
                project_id=self.project.id,
            )


</source>
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="289" endline="304" pcid="12185">
    def increment(self, event, count, environment=None, timestamp=None):
        data = {
            "fingerprint": event.data["fingerprint"],
            "timestamp": iso_format(timestamp) if timestamp else iso_format(before_now(minutes=1)),
        }
        if environment:
            data["environment"] = environment

        for _ in range(count):
            event_data = deepcopy(data)
            event_data["user"] = {"id": uuid4().hex}
            self.store_event(
                data=event_data,
                project_id=self.project.id,
            )

</source>
</class>

<class classid="522" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/tsdb/test_tsdb_backend.py" startline="169" endline="181" pcid="12199">
    def test_range_releases(self):
        dts = [self.now + timedelta(hours=i) for i in range(4)]
        assert self.db.get_range(
            TSDBModel.release, [self.release1.id], dts[0], dts[-1], rollup=3600
        ) == {
            self.release1.id: [
                (timestamp(dts[0]), 0),
                (timestamp(dts[1]), 6),
                (timestamp(dts[2]), 0),
                (timestamp(dts[3]), 0),
            ]
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/tsdb/test_tsdb_backend.py" startline="182" endline="194" pcid="12200">
    def test_range_project(self):
        dts = [self.now + timedelta(hours=i) for i in range(4)]
        assert self.db.get_range(
            TSDBModel.project, [self.proj1.id], dts[0], dts[-1], rollup=3600
        ) == {
            self.proj1.id: [
                (timestamp(dts[0]), 6),
                (timestamp(dts[1]), 6),
                (timestamp(dts[2]), 6),
                (timestamp(dts[3]), 6),
            ]
        }

</source>
</class>

<class classid="523" nclones="2" nlines="14" similarity="78">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/scim/test_group_details.py" startline="30" endline="47" pcid="12254">
    def test_patch_rename(self):
        patch_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
            "Operations": [
                {
                    "op": "replace",
                    "value": {
                        "id": self.team.id,
                        "displayName": "newName",
                    },
                }
            ],
        }

        response = self.client.patch(self.url, patch_data)
        request = RequestFactory().patch(self.url, patch_data)
        self.validate_schema(request, response)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/scim/test_group_details.py" startline="92" endline="105" pcid="12257">
    def test_patch_remove_member(self):
        patch_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
            "Operations": [
                {
                    "op": "remove",
                    "path": f'members[value eq "{self.member.id}"]',
                }
            ],
        }

        response = self.client.patch(self.url, patch_data)
        request = RequestFactory().patch(self.url, patch_data)
        self.validate_schema(request, response)
</source>
</class>

<class classid="524" nclones="2" nlines="19" similarity="88">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/scim/test_group_details.py" startline="48" endline="69" pcid="12255">
    def test_patch_replace(self):
        newmember = self.create_member(user=self.create_user(), organization=self.organization)
        patch_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
            "Operations": [
                {
                    "op": "replace",
                    "path": "members",
                    "value": [
                        {
                            "value": newmember.id,
                            "display": "test2.user@okta.local",
                        },
                    ],
                }
            ],
        }

        response = self.client.patch(self.url, patch_data)
        request = RequestFactory().patch(self.url, patch_data)
        self.validate_schema(request, response)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/scim/test_group_details.py" startline="70" endline="91" pcid="12256">
    def test_patch_add_member(self):
        newmember = self.create_member(user=self.create_user(), organization=self.organization)
        patch_data = {
            "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
            "Operations": [
                {
                    "op": "add",
                    "path": "members",
                    "value": [
                        {
                            "value": newmember.id,
                            "display": newmember.email,
                        }
                    ],
                },
            ],
        }

        response = self.client.patch(self.url, patch_data)
        request = RequestFactory().patch(self.url, patch_data)
        self.validate_schema(request, response)

</source>
</class>

<class classid="525" nclones="4" nlines="20" similarity="71">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_project_release_files.py" startline="9" endline="34" pcid="12272">
    def setUp(self):
        project = self.create_project(name="foo")
        file1 = self.create_file(
            name="blah.js",
            size=42,
            type="release.file",
            headers={"Content-Type": "application/json"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )
        release = self.create_release(project=project, version="1")

        self.create_release_file(
            file=file1, release_id=release.id, name="http://example.com/blah.js"
        )

        self.url = reverse(
            "sentry-api-0-project-release-files",
            kwargs={
                "project_slug": project.slug,
                "organization_slug": project.organization.slug,
                "version": release.version,
            },
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_file_details.py" startline="8" endline="32" pcid="12277">
    def setUp(self):
        self.login_as(user=self.user)

        project = self.create_project(name="foo")
        release = self.create_release(project=project, version="1")
        file1 = self.create_file(
            name="blah.js",
            size=42,
            type="release.file",
            headers={"Content-Type": "application/json"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )
        releasefile = self.create_release_file(
            file=file1, release_id=release.id, name="http://example.com/blah.js"
        )

        self.url = reverse(
            "sentry-api-0-organization-release-file-details",
            kwargs={
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_files.py" startline="9" endline="29" pcid="12280">
    def setUp(self):
        project = self.create_project(name="foo")
        release = self.create_release(project=self.project, version="1")
        file1 = self.create_file(
            name="blah.js",
            size=42,
            type="release.file",
            headers={"Content-Type": "application/json"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )
        self.create_release_file(
            file=file1, release_id=release.id, name="http://example.com/blah.js"
        )

        self.url = reverse(
            "sentry-api-0-organization-release-files",
            kwargs={"organization_slug": project.organization.slug, "version": release.version},
        )

        self.login_as(user=self.user)

</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_project_release_file_details.py" startline="8" endline="32" pcid="12286">
    def setUp(self):
        self.login_as(user=self.user)
        project = self.create_project(name="foo")
        release = self.create_release(project=project, version="1")
        file1 = self.create_file(
            name="blah.js",
            size=42,
            type="release.file",
            headers={"Content-Type": "application/json"},
            checksum="dc1e3f3e411979d336c3057cce64294f3420f93a",
        )
        releasefile = self.create_release_file(
            file=file1, release_id=release.id, name="http://example.com/blah.js"
        )

        self.url = reverse(
            "sentry-api-0-project-release-file-details",
            kwargs={
                "project_slug": project.slug,
                "organization_slug": project.organization.slug,
                "version": release.version,
                "file_id": releasefile.id,
            },
        )

</source>
</class>

<class classid="526" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_project_release_files.py" startline="41" endline="56" pcid="12274">
    def test_post(self):
        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }
        response = self.client.post(
            self.url,
            data,
            format="multipart",
        )
        request = RequestFactory().post(self.url, data=data, content_type="multipart/form-data")

        self.validate_schema(request, response)
</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_files.py" startline="36" endline="51" pcid="12282">
    def test_post(self):
        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }
        response = self.client.post(
            self.url,
            data,
            format="multipart",
        )
        request = RequestFactory().post(self.url, data=data, content_type="multipart/form-data")

        self.validate_schema(request, response)
</source>
</class>

<class classid="527" nclones="2" nlines="10" similarity="88">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/projects/test_user_feedback.py" startline="29" endline="39" pcid="12329">
    def test_post(self):
        data = {
            "event_id": self.event_id,
            "name": "Hellboy",
            "email": "hellboy@sentry.io",
            "comments": "It broke!",
        }
        response = self.client.post(self.url, data)
        request = RequestFactory().post(self.url, data)

        self.validate_schema(request, response)
</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/integration_platform/test_sentry_app_external_issues.py" startline="25" endline="35" pcid="12373">
    def test_post(self):
        data = {
            "issueId": self.group.id,
            "webUrl": "https://somerandom.io/project/issue-id",
            "project": "ExternalProj",
            "identifier": "issue-1",
        }
        response = self.client.post(self.url, data)
        request = RequestFactory().post(self.url, data)

        self.validate_schema(request, response)
</source>
</class>

<class classid="528" nclones="2" nlines="17" similarity="86">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/events/test_group_events.py" startline="8" endline="29" pcid="12351">
    def setUp(self):
        first_release = {
            "firstEvent": before_now(minutes=3),
            "lastEvent": before_now(minutes=2, seconds=30),
        }
        last_release = {
            "firstEvent": before_now(minutes=1, seconds=30),
            "lastEvent": before_now(minutes=1),
        }

        for timestamp in first_release.values():
            self.create_event("a", release="1.0", timestamp=iso_format(timestamp))
        self.create_event("b", release="1.1")

        for timestamp in last_release.values():
            event = self.create_event("c", release="1.0a", timestamp=iso_format(timestamp))

        self.group_id = event.group.id

        self.login_as(user=self.user)


</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/events/test_group_issue_details.py" startline="8" endline="30" pcid="12362">
    def setUp(self):
        self.create_release(project=self.project, version="abcdabc")

        first_release = {
            "firstEvent": before_now(minutes=3),
            "lastEvent": before_now(minutes=2, seconds=30),
        }
        last_release = {
            "firstEvent": before_now(minutes=1, seconds=30),
            "lastEvent": before_now(minutes=1),
        }

        for timestamp in first_release.values():
            self.create_event("a", release="1.0", timestamp=iso_format(timestamp))
        self.create_event("b", release="1.1")

        for timestamp in last_release.values():
            event = self.create_event("c", release="1.0a", timestamp=iso_format(timestamp))

        self.url = f"/api/0/issues/{event.group.id}/"

        self.login_as(user=self.user)

</source>
</class>

<class classid="529" nclones="2" nlines="18" similarity="72">
<source file="systems/sentry-22.2.0/tests/relay_integration/test_integration.py" startline="34" endline="56" pcid="12380">
    def test_hpkp(self):
        event_data = {
            "date-time": "2014-04-06T13:00:50Z",
            "hostname": "www.example.com",
            "port": 443,
            "effective-expiration-date": "2014-05-01T12:40:50Z",
            "include-subdomains": False,
            "served-certificate-chain": [
                "-----BEGIN CERTIFICATE-----\n MIIEBDCCAuygBQUAMEIxCzAJBgNVBAYTAlVT\n -----END CERTIFICATE-----"
            ],
            "validated-certificate-chain": [
                "-----BEGIN CERTIFICATE-----\n MIIEBDCCAuygAwIBAgIDCzAJBgNVBAYTAlVT\n -----END CERTIFICATE-----"
            ],
            "known-pins": [
                'pin-sha256="d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM="',
                'pin-sha256="E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g="',
            ],
        }

        event = self.post_and_retrieve_security_report(event_data)
        assert event.message == "Public key pinning validation failed for 'www.example.com'"
        assert event.group.title == "Public key pinning validation failed for 'www.example.com'"

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/test_integration.py" startline="85" endline="106" pcid="12382">
    def test_expect_staple(self):
        event_data = {
            "expect-staple-report": {
                "date-time": "2014-04-06T13:00:50Z",
                "hostname": "www.example.com",
                "port": 443,
                "response-status": "ERROR_RESPONSE",
                "cert-status": "REVOKED",
                "effective-expiration-date": "2014-05-01T12:40:50Z",
                "served-certificate-chain": [
                    "-----BEGIN CERTIFICATE-----\nABC\n-----END CERTIFICATE-----"
                ],
                "validated-certificate-chain": [
                    "-----BEGIN CERTIFICATE-----\nCDE\n-----END CERTIFICATE-----"
                ],
            }
        }

        event = self.post_and_retrieve_security_report(event_data)
        assert event.message == "Expect-Staple failed for 'www.example.com'"
        assert event.group.title == "Expect-Staple failed for 'www.example.com'"

</source>
</class>

<class classid="530" nclones="2" nlines="14" similarity="73">
<source file="systems/sentry-22.2.0/tests/relay_integration/test_message_filters.py" startline="61" endline="73" pcid="12404">
    def _get_message_from_webcrawler(self):
        message = self._get_message()
        set_path(
            message,
            "request",
            value={
                "url": "http://example.com",
                "method": "GET",
                "headers": [["User-Agent", "Mediapartners-Google"]],
            },
        )
        return message

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/test_message_filters.py" startline="85" endline="101" pcid="12407">
    def _get_message_from_legacy_browser(self):
        ie_5_user_agent = (
            "Mozilla/4.0 (compatible; MSIE 5.50; Windows NT; SiteKiosk 4.9; SiteCoach 1.0)"
        )
        message = self._get_message()
        set_path(message, "platform", value="javascript")
        set_path(
            message,
            "request",
            value={
                "url": "http://example.com",
                "method": "GET",
                "headers": [["User-Agent", ie_5_user_agent]],
            },
        )
        return message

</source>
</class>

<class classid="531" nclones="3" nlines="21" similarity="72">
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="40" endline="61" pcid="12416">
    def test_adds_contexts_without_device(self):
        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "request": {
                "url": "http://example.com",
                "headers": [
                    [
                        "User-Agent",
                        "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) "
                        "Chrome/28.0.1500.72 Safari/537.36",
                    ]
                ],
            },
        }

        event = self.post_and_retrieve_event(data)
        contexts = event.interfaces["contexts"].to_json()
        assert contexts.get("os") == {"name": "Windows", "version": "8", "type": "os"}
        assert contexts.get("device") is None

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="91" endline="118" pcid="12418">
    def test_adds_contexts_with_ps4_device(self):
        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "request": {
                "url": "http://example.com",
                "headers": [
                    [
                        "User-Agent",
                        "Mozilla/5.0 (PlayStation 4 3.55) AppleWebKit/537.78 (KHTML, like Gecko)",
                    ]
                ],
            },
        }

        event = self.post_and_retrieve_event(data)

        contexts = event.interfaces["contexts"].to_json()
        assert contexts.get("os") is None
        assert contexts.get("browser") is None
        assert contexts.get("device") == {
            "family": "PlayStation 4",
            "type": "device",
            "model": "PlayStation 4",
            "brand": "Sony",
        }

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="62" endline="90" pcid="12417">
    def test_adds_contexts_with_device(self):
        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "request": {
                "url": "http://example.com",
                "headers": [
                    [
                        "User-Agent",
                        "Mozilla/5.0 (Linux; U; Android 4.3; en-us; SCH-R530U Build/JSS15J) AppleWebKit/534.30 ("
                        "KHTML, like Gecko) Version/4.0 Mobile Safari/534.30 USCC-R530U",
                    ]
                ],
            },
        }

        event = self.post_and_retrieve_event(data)

        contexts = event.interfaces["contexts"].to_json()
        assert contexts.get("os") == {"name": "Android", "type": "os", "version": "4.3"}
        assert contexts.get("browser") == {"name": "Android", "type": "browser", "version": "4.3"}
        assert contexts.get("device") == {
            "family": "Samsung SCH-R530U",
            "type": "device",
            "model": "SCH-R530U",
            "brand": "Samsung",
        }

</source>
</class>

<class classid="532" nclones="5" nlines="64" similarity="70">
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="269" endline="357" pcid="12422">
    def test_sourcemap_source_expansion(self):
        responses.add(
            responses.GET,
            "http://example.com/file.min.js",
            body=load_fixture("file.min.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file1.js",
            body=load_fixture("file1.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file2.js",
            body=load_fixture("file2.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file.sourcemap.js",
            body=load_fixture("file.sourcemap.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(responses.GET, "http://example.com/index.html", body="Not Found", status=404)

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file.min.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                # NOTE: Intentionally source is not retrieved from this HTML file
                                {
                                    "function": 'function: "HTMLDocument.<anonymous>"',
                                    "abs_path": "http//example.com/index.html",
                                    "filename": "index.html",
                                    "lineno": 283,
                                    "colno": 17,
                                    "in_app": False,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert event.data["errors"] == [
            {"type": "js_no_source", "url": "http//example.com/index.html"}
        ]

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]
        assert frame.pre_context == ["function add(a, b) {", '\t"use strict";']
        expected = "\treturn a + b; // fo"
        assert frame.context_line == expected
        assert frame.post_context == ["}", ""]

        raw_frame_list = exception.values[0].raw_stacktrace.frames
        raw_frame = raw_frame_list[0]
        assert not raw_frame.pre_context
        assert (
            raw_frame.context_line
            == 'function add(a,b){"use strict";return a+b}function multiply(a,b){"use strict";return a*b}function '
            'divide(a,b){"use strict";try{return multip {snip}'
        )
        assert raw_frame.post_context == ["//@ sourceMappingURL=file.sourcemap.js", ""]
        assert raw_frame.lineno == 1

        # Since we couldn't expand source for the 2nd frame, both
        # its raw and original form should be identical
        assert raw_frame_list[1] == frame_list[1]

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="486" endline="587" pcid="12425">
    def test_indexed_sourcemap_source_expansion(self):
        responses.add(
            responses.GET,
            "http://example.com/indexed.min.js",
            body=load_fixture("indexed.min.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file1.js",
            body=load_fixture("file1.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file2.js",
            body=load_fixture("file2.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/indexed.sourcemap.js",
            body=load_fixture("indexed.sourcemap.js"),
            content_type="application/json; charset=utf-8",
        )

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/indexed.min.js",
                                    "filename": "indexed.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/indexed.min.js",
                                    "filename": "indexed.min.js",
                                    "lineno": 2,
                                    "colno": 44,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert "errors" not in event.data

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]
        assert frame.pre_context == ["function add(a, b) {", '\t"use strict";']

        expected = "\treturn a + b; // fo"
        assert frame.context_line == expected
        assert frame.post_context == ["}", ""]

        raw_frame_list = exception.values[0].raw_stacktrace.frames
        raw_frame = raw_frame_list[0]
        assert not raw_frame.pre_context
        assert raw_frame.context_line == 'function add(a,b){"use strict";return a+b}'
        assert raw_frame.post_context == [
            'function multiply(a,b){"use strict";return a*b}function divide(a,b){"use strict";try{return multiply('
            "add(a,b),a,b)/c}catch(e){Raven.captureE {snip}",
            "//# sourceMappingURL=indexed.sourcemap.js",
            "",
        ]
        assert raw_frame.lineno == 1

        frame = frame_list[1]
        assert frame.pre_context == ["function multiply(a, b) {", '\t"use strict";']
        assert frame.context_line == "\treturn a * b;"
        assert frame.post_context == [
            "}",
            "function divide(a, b) {",
            '\t"use strict";',
            "\ttry {",
            "\t\treturn multiply(add(a, b), a, b) / c;",
        ]

        raw_frame = raw_frame_list[1]
        assert raw_frame.pre_context == ['function add(a,b){"use strict";return a+b}']
        assert (
            raw_frame.context_line
            == 'function multiply(a,b){"use strict";return a*b}function divide(a,b){"use strict";try{return multiply('
            "add(a,b),a,b)/c}catch(e){Raven.captureE {snip}"
        )
        assert raw_frame.post_context == ["//# sourceMappingURL=indexed.sourcemap.js", ""]
        assert raw_frame.lineno == 2

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="359" endline="420" pcid="12423">
    def test_sourcemap_embedded_source_expansion(self):
        responses.add(
            responses.GET,
            "http://example.com/embedded.js",
            body=load_fixture("embedded.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/embedded.js.map",
            body=load_fixture("embedded.js.map"),
            content_type="application/json; charset=utf-8",
        )
        responses.add(responses.GET, "http://example.com/index.html", body="Not Found", status=404)

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/embedded.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                # NOTE: Intentionally source is not retrieved from this HTML file
                                {
                                    "function": 'function: "HTMLDocument.<anonymous>"',
                                    "abs_path": "http//example.com/index.html",
                                    "filename": "index.html",
                                    "lineno": 283,
                                    "colno": 17,
                                    "in_app": False,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert event.data["errors"] == [
            {"type": "js_no_source", "url": "http//example.com/index.html"}
        ]

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]
        assert frame.pre_context == ["function add(a, b) {", '\t"use strict";']
        expected = "\treturn a + b; // fo"
        assert frame.context_line == expected
        assert frame.post_context == ["}", ""]

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="870" endline="939" pcid="12428">
    def test_sourcemap_expansion_with_missing_source(self):
        """
        Tests a successful sourcemap expansion that points to source files
        that are not found.
        """
        responses.add(
            responses.GET,
            "http://example.com/file.min.js",
            body=load_fixture("file.min.js"),
            content_type="application/javascript; charset=utf-8",
        )
        responses.add(
            responses.GET,
            "http://example.com/file.sourcemap.js",
            body=load_fixture("file.sourcemap.js"),
            content_type="application/json; charset=utf-8",
        )
        responses.add(responses.GET, "http://example.com/file1.js", body="Not Found", status=404)

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            # Add two frames.  We only want to see the
                            # error once though.
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file.min.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/file.min.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert event.data["errors"] == [
            {"url": "http://example.com/file1.js", "type": "fetch_invalid_http_code", "value": 404}
        ]

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]

        # no context information ...
        assert not frame.pre_context
        assert not frame.context_line
        assert not frame.post_context

        # ... but line, column numbers are still correctly mapped
        assert frame.lineno == 3
        assert frame.colno == 9

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="1057" endline="1117" pcid="12432">
    def test_html_response_for_js(self):
        responses.add(
            responses.GET,
            "http://example.com/file1.js",
            body="       <!DOCTYPE html><html><head></head><body></body></html>",
        )
        responses.add(
            responses.GET,
            "http://example.com/file2.js",
            body="<!doctype html><html><head></head><body></body></html>",
        )
        responses.add(
            responses.GET,
            "http://example.com/file.html",
            body=(
                "<!doctype html><html><head></head><body><script>/*legit case*/</script></body></html>"
            ),
        )

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file1.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/file2.js",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/file.html",
                                    "filename": "file.html",
                                    "lineno": 1,
                                    "colno": 1,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert event.data["errors"] == [
            {"url": "http://example.com/file1.js", "type": "js_invalid_content"},
            {"url": "http://example.com/file2.js", "type": "js_invalid_content"},
        ]

</source>
</class>

<class classid="533" nclones="2" nlines="100" similarity="93">
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="589" endline="724" pcid="12426">
    def test_expansion_via_release_artifacts(self):
        project = self.project
        release = Release.objects.create(organization_id=project.organization_id, version="abc")
        release.add_project(project)

        # file.min.js
        # ------------

        f_minified = File.objects.create(
            name="file.min.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f_minified.putfile(open(get_fixture_path("file.min.js"), "rb"))

        # Intentionally omit hostname - use alternate artifact path lookup instead
        # /file1.js vs http://example.com/file1.js
        ReleaseFile.objects.create(
            name=f"~/{f_minified.name}?foo=bar",
            release_id=release.id,
            organization_id=project.organization_id,
            file=f_minified,
        )

        # file1.js
        # ---------

        f1 = File.objects.create(
            name="file1.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f1.putfile(open(get_fixture_path("file1.js"), "rb"))

        ReleaseFile.objects.create(
            name=f"http://example.com/{f1.name}",
            release_id=release.id,
            organization_id=project.organization_id,
            file=f1,
        )

        # file2.js
        # ----------

        f2 = File.objects.create(
            name="file2.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f2.putfile(open(get_fixture_path("file2.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"http://example.com/{f2.name}",
            release_id=release.id,
            organization_id=project.organization_id,
            file=f2,
        )

        # To verify that the full url has priority over the relative url,
        # we will also add a second ReleaseFile alias for file2.js (f3) w/o
        # hostname that points to an empty file. If the processor chooses
        # this empty file over the correct file2.js, it will not locate
        # context for the 2nd frame.
        f2_empty = File.objects.create(
            name="empty.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f2_empty.putfile(open(get_fixture_path("empty.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"~/{f2.name}",  # intentionally using f2.name ("file2.js")
            release_id=release.id,
            organization_id=project.organization_id,
            file=f2_empty,
        )

        # sourcemap
        # ----------

        f_sourcemap = File.objects.create(
            name="file.sourcemap.js",
            type="release.file",
            headers={"Content-Type": "application/json"},
        )
        f_sourcemap.putfile(open(get_fixture_path("file.sourcemap.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"http://example.com/{f_sourcemap.name}",
            release_id=release.id,
            organization_id=project.organization_id,
            file=f_sourcemap,
        )

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "release": "abc",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file.min.js?foo=bar",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/file.min.js?foo=bar",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 79,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert "errors" not in event.data

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]
        assert frame.pre_context == ["function add(a, b) {", '\t"use strict";']
        assert frame.context_line == "\treturn a + b; // fo"
        assert frame.post_context == ["}", ""]

        frame = frame_list[1]
        assert frame.pre_context == ["function multiply(a, b) {", '\t"use strict";']
        assert frame.context_line == "\treturn a * b;"
        assert frame.post_context == [
            "}",
            "function divide(a, b) {",
            '\t"use strict";',
            "\ttry {",
            "\t\treturn multiply(add(a, b), a, b) / c;",
        ]

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="726" endline="868" pcid="12427">
    def test_expansion_via_distribution_release_artifacts(self):
        project = self.project
        release = Release.objects.create(organization_id=project.organization_id, version="abc")
        release.add_project(project)
        dist = release.add_dist("foo")

        # file.min.js
        # ------------

        f_minified = File.objects.create(
            name="file.min.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f_minified.putfile(open(get_fixture_path("file.min.js"), "rb"))

        # Intentionally omit hostname - use alternate artifact path lookup instead
        # /file1.js vs http://example.com/file1.js
        ReleaseFile.objects.create(
            name=f"~/{f_minified.name}?foo=bar",
            release_id=release.id,
            dist_id=dist.id,
            organization_id=project.organization_id,
            file=f_minified,
        )

        # file1.js
        # ---------

        f1 = File.objects.create(
            name="file1.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f1.putfile(open(get_fixture_path("file1.js"), "rb"))

        ReleaseFile.objects.create(
            name=f"http://example.com/{f1.name}",
            release_id=release.id,
            dist_id=dist.id,
            organization_id=project.organization_id,
            file=f1,
        )

        # file2.js
        # ----------

        f2 = File.objects.create(
            name="file2.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f2.putfile(open(get_fixture_path("file2.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"http://example.com/{f2.name}",
            release_id=release.id,
            dist_id=dist.id,
            organization_id=project.organization_id,
            file=f2,
        )

        # To verify that the full url has priority over the relative url,
        # we will also add a second ReleaseFile alias for file2.js (f3) w/o
        # hostname that points to an empty file. If the processor chooses
        # this empty file over the correct file2.js, it will not locate
        # context for the 2nd frame.
        f2_empty = File.objects.create(
            name="empty.js", type="release.file", headers={"Content-Type": "application/json"}
        )
        f2_empty.putfile(open(get_fixture_path("empty.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"~/{f2.name}",  # intentionally using f2.name ("file2.js")
            release_id=release.id,
            dist_id=dist.id,
            organization_id=project.organization_id,
            file=f2_empty,
        )

        # sourcemap
        # ----------

        f_sourcemap = File.objects.create(
            name="file.sourcemap.js",
            type="release.file",
            headers={"Content-Type": "application/json"},
        )
        f_sourcemap.putfile(open(get_fixture_path("file.sourcemap.js"), "rb"))
        ReleaseFile.objects.create(
            name=f"http://example.com/{f_sourcemap.name}",
            release_id=release.id,
            dist_id=dist.id,
            organization_id=project.organization_id,
            file=f_sourcemap,
        )

        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "release": "abc",
            "dist": "foo",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file.min.js?foo=bar",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 39,
                                },
                                {
                                    "abs_path": "http://example.com/file.min.js?foo=bar",
                                    "filename": "file.min.js",
                                    "lineno": 1,
                                    "colno": 79,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert "errors" not in event.data

        exception = event.interfaces["exception"]
        frame_list = exception.values[0].stacktrace.frames

        frame = frame_list[0]
        assert frame.pre_context == ["function add(a, b) {", '\t"use strict";']
        assert frame.context_line == "\treturn a + b; // fo"
        assert frame.post_context == ["}", ""]

        frame = frame_list[1]
        assert frame.pre_context == ["function multiply(a, b) {", '\t"use strict";']
        assert frame.context_line == "\treturn a * b;"
        assert frame.post_context == [
            "}",
            "function divide(a, b) {",
            '\t"use strict";',
            "\ttry {",
            "\t\treturn multiply(add(a, b), a, b) / c;",
        ]

</source>
</class>

<class classid="534" nclones="2" nlines="30" similarity="80">
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="1018" endline="1055" pcid="12431">
    def test_failed_sourcemap_expansion_missing_location_entirely(self):
        responses.add(
            responses.GET,
            "http://example.com/indexed.min.js",
            body="//# sourceMappingURL=indexed.sourcemap.js",
        )
        responses.add(responses.GET, "http://example.com/indexed.sourcemap.js", body="{}")
        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/indexed.min.js",
                                    "filename": "indexed.min.js",
                                    "lineno": 1,
                                    "colno": 1,
                                },
                                {
                                    "abs_path": "http://example.com/indexed.min.js",
                                    "filename": "indexed.min.js",
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert "errors" not in event.data

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/javascript/test_plugin.py" startline="1427" endline="1460" pcid="12438">
    def test_html_file_with_query_param_ending_with_js_extension(self):
        responses.add(
            responses.GET,
            "http://example.com/file.html",
            body=(
                "<!doctype html><html><head></head><body><script>/*legit case*/</script></body></html>"
            ),
        )
        data = {
            "timestamp": self.min_ago,
            "message": "hello",
            "platform": "javascript",
            "exception": {
                "values": [
                    {
                        "type": "Error",
                        "stacktrace": {
                            "frames": [
                                {
                                    "abs_path": "http://example.com/file.html?sw=iddqd1337.js",
                                    "filename": "file.html",
                                    "lineno": 1,
                                    "colno": 1,
                                },
                            ]
                        },
                    }
                ]
            },
        }

        event = self.post_and_retrieve_event(data)

        assert "errors" not in event.data
</source>
</class>

<class classid="535" nclones="3" nlines="75" similarity="70">
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/java/test_plugin.py" startline="47" endline="141" pcid="12439">
    def test_basic_resolving(self):
        url = reverse(
            "sentry-api-0-dsym-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
            },
        )

        self.login_as(user=self.user)

        out = BytesIO()
        f = zipfile.ZipFile(out, "w")
        f.writestr("proguard/%s.txt" % PROGUARD_UUID, PROGUARD_SOURCE)
        f.writestr("ignored-file.txt", b"This is just some stuff")
        f.close()

        response = self.client.post(
            url,
            {
                "file": SimpleUploadedFile(
                    "symbols.zip", out.getvalue(), content_type="application/zip"
                )
            },
            format="multipart",
        )
        assert response.status_code == 201, response.content
        assert len(response.data) == 1

        event_data = {
            "user": {"ip_address": "31.172.207.97"},
            "extra": {},
            "project": self.project.id,
            "platform": "java",
            "debug_meta": {"images": [{"type": "proguard", "uuid": PROGUARD_UUID}]},
            "exception": {
                "values": [
                    {
                        "stacktrace": {
                            "frames": [
                                {
                                    "function": "a",
                                    "abs_path": None,
                                    "module": "org.a.b.g$a",
                                    "filename": None,
                                    "lineno": 67,
                                },
                                {
                                    "function": "a",
                                    "abs_path": None,
                                    "module": "org.a.b.g$a",
                                    "filename": None,
                                    "lineno": 69,
                                },
                            ]
                        },
                        "module": "org.a.b",
                        "type": "g$a",
                        "value": "Shit broke yo",
                    }
                ]
            },
            "timestamp": iso_format(before_now(seconds=1)),
        }

        event = self.post_and_retrieve_event(event_data)
        if not self.use_relay():
            # We measure the number of queries after an initial post,
            # because there are many queries polluting the array
            # before the actual "processing" happens (like, auth_user)
            with self.assertWriteQueries(
                {
                    "nodestore_node": 2,
                    "sentry_eventuser": 1,
                    "sentry_groupedmessage": 1,
                    "sentry_userreport": 1,
                }
            ):
                self.post_and_retrieve_event(event_data)

        exc = event.interfaces["exception"].values[0]
        bt = exc.stacktrace
        frames = bt.frames

        assert exc.type == "Util$ClassContextSecurityManager"
        assert exc.module == "org.slf4j.helpers"
        assert frames[0].function == "getClassContext"
        assert frames[0].module == "org.slf4j.helpers.Util$ClassContextSecurityManager"
        assert frames[1].function == "getExtraClassContext"
        assert frames[1].module == "org.slf4j.helpers.Util$ClassContextSecurityManager"

        assert event.culprit == (
            "org.slf4j.helpers.Util$ClassContextSecurityManager " "in getExtraClassContext"
        )

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/java/test_plugin.py" startline="142" endline="241" pcid="12440">
    def test_resolving_inline(self):
        url = reverse(
            "sentry-api-0-dsym-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
            },
        )

        self.login_as(user=self.user)

        out = BytesIO()
        f = zipfile.ZipFile(out, "w")
        f.writestr("proguard/%s.txt" % PROGUARD_INLINE_UUID, PROGUARD_INLINE_SOURCE)
        f.writestr("ignored-file.txt", b"This is just some stuff")
        f.close()

        response = self.client.post(
            url,
            {
                "file": SimpleUploadedFile(
                    "symbols.zip", out.getvalue(), content_type="application/zip"
                )
            },
            format="multipart",
        )
        assert response.status_code == 201, response.content
        assert len(response.data) == 1

        event_data = {
            "user": {"ip_address": "31.172.207.97"},
            "extra": {},
            "project": self.project.id,
            "platform": "java",
            "debug_meta": {"images": [{"type": "proguard", "uuid": PROGUARD_INLINE_UUID}]},
            "exception": {
                "values": [
                    {
                        "stacktrace": {
                            "frames": [
                                {
                                    "function": "onClick",
                                    "abs_path": None,
                                    "module": "e.a.c.a",
                                    "filename": None,
                                    "lineno": 2,
                                },
                                {
                                    "function": "t",
                                    "abs_path": None,
                                    "module": "io.sentry.sample.MainActivity",
                                    "filename": "MainActivity.java",
                                    "lineno": 1,
                                },
                            ]
                        },
                        "module": "org.a.b",
                        "type": "g$a",
                        "value": "Shit broke yo",
                    }
                ]
            },
            "timestamp": iso_format(before_now(seconds=1)),
        }

        event = self.post_and_retrieve_event(event_data)
        if not self.use_relay():
            # We measure the number of queries after an initial post,
            # because there are many queries polluting the array
            # before the actual "processing" happens (like, auth_user)
            with self.assertWriteQueries(
                {
                    "nodestore_node": 2,
                    "sentry_eventuser": 1,
                    "sentry_groupedmessage": 1,
                    "sentry_userreport": 1,
                }
            ):
                self.post_and_retrieve_event(event_data)

        exc = event.interfaces["exception"].values[0]
        bt = exc.stacktrace
        frames = bt.frames

        assert len(frames) == 4

        assert frames[0].function == "onClick"
        assert frames[0].module == "io.sentry.sample.-$$Lambda$r3Avcbztes2hicEObh02jjhQqd4"

        assert frames[1].filename == "MainActivity.java"
        assert frames[1].module == "io.sentry.sample.MainActivity"
        assert frames[1].function == "onClickHandler"
        assert frames[1].lineno == 40
        assert frames[2].function == "foo"
        assert frames[2].lineno == 44
        assert frames[3].function == "bar"
        assert frames[3].lineno == 54
        assert frames[3].filename == "MainActivity.java"
        assert frames[3].module == "io.sentry.sample.MainActivity"

</source>
<source file="systems/sentry-22.2.0/tests/relay_integration/lang/java/test_plugin.py" startline="242" endline="311" pcid="12441">
    def test_error_on_resolving(self):
        url = reverse(
            "sentry-api-0-dsym-files",
            kwargs={
                "organization_slug": self.project.organization.slug,
                "project_slug": self.project.slug,
            },
        )

        self.login_as(user=self.user)

        out = BytesIO()
        f = zipfile.ZipFile(out, "w")
        f.writestr("proguard/%s.txt" % PROGUARD_BUG_UUID, PROGUARD_BUG_SOURCE)
        f.close()

        response = self.client.post(
            url,
            {
                "file": SimpleUploadedFile(
                    "symbols.zip", out.getvalue(), content_type="application/zip"
                )
            },
            format="multipart",
        )
        assert response.status_code == 201, response.content
        assert len(response.data) == 1

        event_data = {
            "user": {"ip_address": "31.172.207.97"},
            "extra": {},
            "project": self.project.id,
            "platform": "java",
            "debug_meta": {"images": [{"type": "proguard", "uuid": PROGUARD_BUG_UUID}]},
            "exception": {
                "values": [
                    {
                        "stacktrace": {
                            "frames": [
                                {
                                    "function": "a",
                                    "abs_path": None,
                                    "module": "org.a.b.g$a",
                                    "filename": None,
                                    "lineno": 67,
                                },
                                {
                                    "function": "a",
                                    "abs_path": None,
                                    "module": "org.a.b.g$a",
                                    "filename": None,
                                    "lineno": 69,
                                },
                            ]
                        },
                        "type": "RuntimeException",
                        "value": "Shit broke yo",
                    }
                ]
            },
            "timestamp": iso_format(before_now(seconds=1)),
        }

        event = self.post_and_retrieve_event(event_data)

        assert len(event.data["errors"]) == 1
        assert event.data["errors"][0] == {
            "mapping_uuid": "071207ac-b491-4a74-957c-2c94fd9594f2",
            "type": "proguard_missing_lineno",
        }
</source>
</class>

</clones>
