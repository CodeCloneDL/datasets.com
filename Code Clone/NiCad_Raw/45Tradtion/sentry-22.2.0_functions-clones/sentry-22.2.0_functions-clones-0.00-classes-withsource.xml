<clones>
<systeminfo processor="nicad6" system="sentry-22.2.0" granularity="functions" threshold="0%" minlines="10" maxlines="2500"/>
<cloneinfo npcs="12453" npairs="20"/>
<runinfo ncompares="536453" cputime="179200"/>
<classinfo nclasses="18"/>

<class classid="1" nclones="2" nlines="33" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/migrations/0237_recreate_subscriptions_in_snuba.py" startline="12" endline="56" pcid="1371">
def migrate_subscriptions(apps, schema_editor):
    QuerySubscription = apps.get_model("sentry", "QuerySubscription")
    AppSnubaQueryEventType = apps.get_model("sentry", "SnubaQueryEventType")

    for subscription in RangeQuerySetWrapperWithProgressBar(
        QuerySubscription.objects.select_related("snuba_query").all()
    ):
        if subscription.subscription_id is not None:
            # The migration apps don't build this property, so manually set it.
            raw_event_types = AppSnubaQueryEventType.objects.filter(
                snuba_query=subscription.snuba_query
            ).all()
            event_types = [SnubaQueryEventType.EventType(ev.type) for ev in raw_event_types]
            setattr(subscription.snuba_query, "event_types", event_types)

            subscription_id = None
            try:
                subscription_id = _create_in_snuba(subscription)
            except Exception as e:
                logging.exception(f"failed to recreate {subscription.subscription_id}: {e}")
                continue

            try:
                _delete_from_snuba(
                    QueryDatasets(subscription.snuba_query.dataset),
                    subscription.subscription_id,
                )
            except Exception as e:
                try:
                    # Delete the subscription we just created to avoid orphans
                    _delete_from_snuba(
                        QueryDatasets(subscription.snuba_query.dataset),
                        subscription_id,
                    )
                except Exception as oe:
                    logging.exception(f"failed to delete orphan {subscription_id}: {oe}")

                logging.exception(f"failed to delete {subscription.subscription_id}: {e}")
                continue

            QuerySubscription.objects.filter(id=subscription.id).update(
                subscription_id=subscription_id
            )


</source>
<source file="systems/sentry-22.2.0/src/sentry/migrations/0233_recreate_subscriptions_in_snuba.py" startline="12" endline="56" pcid="1374">
def migrate_subscriptions(apps, schema_editor):
    QuerySubscription = apps.get_model("sentry", "QuerySubscription")
    AppSnubaQueryEventType = apps.get_model("sentry", "SnubaQueryEventType")

    for subscription in RangeQuerySetWrapperWithProgressBar(
        QuerySubscription.objects.select_related("snuba_query").all()
    ):
        if subscription.subscription_id is not None:
            # The migration apps don't build this property, so manually set it.
            raw_event_types = AppSnubaQueryEventType.objects.filter(
                snuba_query=subscription.snuba_query
            ).all()
            event_types = [SnubaQueryEventType.EventType(ev.type) for ev in raw_event_types]
            setattr(subscription.snuba_query, "event_types", event_types)

            subscription_id = None
            try:
                subscription_id = _create_in_snuba(subscription)
            except Exception as e:
                logging.exception(f"failed to recreate {subscription.subscription_id}: {e}")
                continue

            try:
                _delete_from_snuba(
                    QueryDatasets(subscription.snuba_query.dataset),
                    subscription.subscription_id,
                )
            except Exception as e:
                try:
                    # Delete the subscription we just created to avoid orphans
                    _delete_from_snuba(
                        QueryDatasets(subscription.snuba_query.dataset),
                        subscription_id,
                    )
                except Exception as oe:
                    logging.exception(f"failed to delete orphan {subscription_id}: {oe}")

                logging.exception(f"failed to delete {subscription.subscription_id}: {e}")
                continue

            QuerySubscription.objects.filter(id=subscription.id).update(
                subscription_id=subscription_id
            )


</source>
</class>

<class classid="2" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_code_mapping_codeowners.py" startline="13" endline="27" pcid="2681">
    def convert_args(self, request: Request, organization_slug, config_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, organization_slug, config_id, *args, **kwargs)

        try:
            kwargs["config"] = RepositoryProjectPathConfig.objects.get(
                id=config_id,
                organization_integration__in=OrganizationIntegration.objects.filter(
                    organization=kwargs["organization"]
                ).values_list("id", flat=True),
            )
        except RepositoryProjectPathConfig.DoesNotExist:
            raise Http404

        return (args, kwargs)

</source>
<source file="systems/sentry-22.2.0/src/sentry/api/endpoints/organization_code_mapping_details.py" startline="20" endline="34" pcid="2981">
    def convert_args(self, request: Request, organization_slug, config_id, *args, **kwargs):
        args, kwargs = super().convert_args(request, organization_slug, config_id, *args, **kwargs)

        try:
            kwargs["config"] = RepositoryProjectPathConfig.objects.get(
                id=config_id,
                organization_integration__in=OrganizationIntegration.objects.filter(
                    organization=kwargs["organization"]
                ).values_list("id", flat=True),
            )
        except RepositoryProjectPathConfig.DoesNotExist:
            raise Http404

        return (args, kwargs)

</source>
</class>

<class classid="3" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/src/sentry/integrations/bitbucket_server/client.py" startline="59" endline="78" pcid="3722">
    def get_access_token(self, request_token, verifier):
        """
        Step 3 of the oauth flow.
        Use the verifier and request token from step 1 to get an access token.
        """
        if not verifier:
            raise ApiError("Missing OAuth token verifier")
        auth = OAuth1(
            client_key=self.consumer_key,
            resource_owner_key=request_token["oauth_token"],
            resource_owner_secret=request_token["oauth_token_secret"],
            verifier=verifier,
            rsa_key=self.private_key,
            signature_method=SIGNATURE_RSA,
            signature_type="auth_header",
        )
        url = self.access_token_url.format(self.base_url)
        resp = self.post(url, auth=auth, allow_text=True)
        return dict(parse_qsl(resp.text))

</source>
<source file="systems/sentry-22.2.0/src/sentry/integrations/jira_server/client.py" startline="52" endline="71" pcid="3755">
    def get_access_token(self, request_token, verifier):
        """
        Step 3 of the oauth flow.
        Use the verifier and request token from step 1 to get an access token.
        """
        if not verifier:
            raise ApiError("Missing OAuth token verifier")
        auth = OAuth1(
            client_key=self.consumer_key,
            resource_owner_key=request_token["oauth_token"],
            resource_owner_secret=request_token["oauth_token_secret"],
            verifier=verifier,
            rsa_key=self.private_key,
            signature_method=SIGNATURE_RSA,
            signature_type="auth_header",
        )
        url = self.access_token_url.format(self.base_url)
        resp = self.post(url, auth=auth, allow_text=True)
        return dict(parse_qsl(resp.text))

</source>
</class>

<class classid="4" nclones="3" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_requests/test_issue_link_requester.py" startline="11" endline="26" pcid="5222">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_issues/test_creator.py" startline="7" endline="22" pcid="5262">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/mediators/external_issues/test_issue_link_creator.py" startline="10" endline="25" pcid="5264">
    def setUp(self):
        super().setUp()

        self.user = self.create_user(name="foo")
        self.org = self.create_organization(owner=self.user)
        self.project = self.create_project(slug="boop", organization=self.org)
        self.group = self.create_group(project=self.project)

        self.sentry_app = self.create_sentry_app(
            name="foo", organization=self.org, webhook_url="https://example.com", scopes=()
        )

        self.install = self.create_sentry_app_installation(
            slug="foo", organization=self.org, user=self.user
        )

</source>
</class>

<class classid="5" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_symbolication.py" startline="19" endline="38" pcid="6055">
    def get_event_preprocessors(self, data):
        def remove_extra(data):
            del data["extra"]
            return data

        def put_on_hold(data):
            data["unprocessed"] = True
            return data

        if data.get("platform") == "mattlang":
            return [remove_extra, lambda x: None]

        if data.get("platform") == "noop":
            return [lambda data: None]

        if data.get("platform") == "holdmeclose":
            return [put_on_hold]

        return []

</source>
<source file="systems/sentry-22.2.0/tests/sentry/tasks/test_store.py" startline="21" endline="40" pcid="6085">
    def get_event_preprocessors(self, data):
        def remove_extra(data):
            del data["extra"]
            return data

        def put_on_hold(data):
            data["unprocessed"] = True
            return data

        if data.get("platform") == "mattlang":
            return [remove_extra, lambda x: None]

        if data.get("platform") == "noop":
            return [lambda data: None]

        if data.get("platform") == "holdmeclose":
            return [put_on_hold]

        return []

</source>
</class>

<class classid="6" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_comment_index.py" startline="69" endline="80" pcid="6624">
    def test_access(self):
        other_user = self.create_user()
        self.login_as(other_user)
        other_team = self.create_team()
        self.create_member(
            user=self.user, organization=self.organization, role="member", teams=[self.team]
        )
        other_project = self.create_project(teams=[other_team])
        incident = self.create_incident(projects=[other_project])
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, incident.identifier, comment="hi")
            assert resp.status_code == 403
</source>
<source file="systems/sentry-22.2.0/tests/sentry/incidents/endpoints/test_organization_incident_subscription_index.py" startline="23" endline="36" pcid="6664">
    def test_access(self):
        other_user = self.create_user()
        self.login_as(other_user)
        other_team = self.create_team()
        self.create_member(
            user=self.user, organization=self.organization, role="member", teams=[self.team]
        )
        other_project = self.create_project(teams=[other_team])
        incident = self.create_incident(projects=[other_project])
        with self.feature("organizations:incidents"):
            resp = self.get_response(self.organization.slug, incident.identifier, comment="hi")
            assert resp.status_code == 403


</source>
</class>

<class classid="7" nclones="2" nlines="31" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_events_latest.py" startline="6" endline="39" pcid="7915">
    def setUp(self):
        super().setUp()

        self.login_as(user=self.user)
        project = self.create_project()

        self.event_a = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "development",
                "timestamp": iso_format(before_now(days=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_b = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "timestamp": iso_format(before_now(minutes=5)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_c = self.store_event(
            data={
                "event_id": "c" * 32,
                "environment": "staging",
                "timestamp": iso_format(before_now(minutes=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/api/endpoints/test_group_events_oldest.py" startline="6" endline="39" pcid="8051">
    def setUp(self):
        super().setUp()

        self.login_as(user=self.user)
        project = self.create_project()

        self.event_a = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "development",
                "timestamp": iso_format(before_now(days=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_b = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "timestamp": iso_format(before_now(minutes=5)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )
        self.event_c = self.store_event(
            data={
                "event_id": "c" * 32,
                "environment": "staging",
                "timestamp": iso_format(before_now(minutes=1)),
                "fingerprint": ["group-1"],
            },
            project_id=project.id,
        )

</source>
</class>

<class classid="8" nclones="2" nlines="13" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_integration.py" startline="34" endline="47" pcid="10216">
    def integration(self):
        integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        integration.add_organization(self.organization, self.user)
        return integration

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_search_endpoint.py" startline="14" endline="27" pcid="10252">
    def integration(self):
        integration = Integration.objects.create(
            provider="jira",
            name="Jira Cloud",
            metadata={
                "oauth_client_id": "oauth-client-id",
                "shared_secret": "a-super-secret-key-from-atlassian",
                "base_url": "https://example.atlassian.net",
                "domain_name": "example.atlassian.net",
            },
        )
        integration.add_organization(self.organization, self.user)
        return integration

</source>
</class>

<class classid="9" nclones="2" nlines="12" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_uninstalled.py" startline="18" endline="30" pcid="10264">
    def jwt_token_secret(self):
        jira_signing_algorithm = "HS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            self.shared_secret,
            algorithm=jira_signing_algorithm,
            headers={"alg": jira_signing_algorithm},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="18" endline="30" pcid="10275">
    def jwt_token_secret(self):
        jira_signing_algorithm = "HS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            self.shared_secret,
            algorithm=jira_signing_algorithm,
            headers={"alg": jira_signing_algorithm},
        )

</source>
</class>

<class classid="10" nclones="2" nlines="12" similarity="100">
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_uninstalled.py" startline="31" endline="43" pcid="10265">
    def jwt_token_cdn(self):
        jira_signing_algorithm = "RS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            RS256_KEY,
            algorithm=jira_signing_algorithm,
            headers={"kid": self.kid, "alg": jira_signing_algorithm},
        )

</source>
<source file="systems/sentry-22.2.0/tests/sentry/integrations/jira/test_installed.py" startline="31" endline="43" pcid="10276">
    def jwt_token_cdn(self):
        jira_signing_algorithm = "RS256"
        return jwt.encode(
            {
                "iss": self.external_id,
                "aud": absolute_uri(),
                "qsh": get_query_hash(self.path, method="POST", query_params={}),
            },
            RS256_KEY,
            algorithm=jira_signing_algorithm,
            headers={"kid": self.kid, "alg": jira_signing_algorithm},
        )

</source>
</class>

<class classid="11" nclones="2" nlines="10" similarity="100">
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_landing.py" startline="20" endline="32" pcid="11185">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/performance/"

        self.page = BasePage(self.browser)

</source>
<source file="systems/sentry-22.2.0/tests/acceptance/test_performance_overview.py" startline="20" endline="32" pcid="11322">
    def setUp(self):
        super().setUp()
        self.org = self.create_organization(owner=self.user, name="Rowdy Tiger")
        self.team = self.create_team(
            organization=self.org, name="Mariachi Band", members=[self.user]
        )
        self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
        self.group = self.create_group(project=self.project)
        self.login_as(self.user)
        self.path = f"/organizations/{self.org.slug}/performance/"

        self.page = BasePage(self.browser)

</source>
</class>

<class classid="12" nclones="2" nlines="25" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_group_events_latest.py" startline="7" endline="36" pcid="11851">
    def setUp(self):
        super().setUp()
        self.login_as(user=self.user)

        project = self.create_project()
        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))

        self.event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "staging",
                "fingerprint": ["group_1"],
                "timestamp": two_min_ago,
            },
            project_id=project.id,
        )

        self.event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "fingerprint": ["group_1"],
                "timestamp": min_ago,
            },
            project_id=project.id,
        )

        self.group = Group.objects.first()

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_group_events_oldest.py" startline="7" endline="35" pcid="11918">
    def setUp(self):
        super().setUp()
        self.login_as(user=self.user)

        project = self.create_project()
        min_ago = iso_format(before_now(minutes=1))
        two_min_ago = iso_format(before_now(minutes=2))

        self.event1 = self.store_event(
            data={
                "event_id": "a" * 32,
                "environment": "staging",
                "fingerprint": ["group_1"],
                "timestamp": two_min_ago,
            },
            project_id=project.id,
        )
        self.event2 = self.store_event(
            data={
                "event_id": "b" * 32,
                "environment": "production",
                "fingerprint": ["group_1"],
                "timestamp": min_ago,
            },
            project_id=project.id,
        )

        self.group = Group.objects.first()

</source>
</class>

<class classid="13" nclones="2" nlines="42" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="57" endline="110" pcid="11857">
    def create_event(self, **kwargs):
        if "span_id" not in kwargs:
            kwargs["span_id"] = "a" * 16

        if "start_timestamp" not in kwargs:
            kwargs["start_timestamp"] = self.min_ago

        if "timestamp" not in kwargs:
            kwargs["timestamp"] = self.min_ago + timedelta(seconds=8)

        if "trace_context" not in kwargs:
            # should appear for all of the pXX metrics
            kwargs["trace_context"] = {
                "op": "http.server",
                "hash": "ab" * 8,
                "exclusive_time": 4.0,
            }

        if "spans" not in kwargs:
            kwargs["spans"] = [
                # should appear for the sum metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=1)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "op": "django.middleware",
                    "description": "middleware span",
                    "hash": "cd" * 8,
                    "exclusive_time": 3.0,
                }
                for x in ["b", "c"]
            ] + [
                # should appear for the count metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=5)),
                    "op": "django.view",
                    "description": "view span",
                    "hash": "ef" * 8,
                    "exclusive_time": 1.0,
                }
                for x in ["d", "e", "f"]
            ]

        data = load_data("transaction", **kwargs)
        data["transaction"] = "root transaction"

        return self.store_event(data, project_id=self.project.id)

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_span_ops.py" startline="25" endline="78" pcid="12105">
    def create_event(self, **kwargs):
        if "span_id" not in kwargs:
            kwargs["span_id"] = "a" * 16

        if "start_timestamp" not in kwargs:
            kwargs["start_timestamp"] = self.min_ago

        if "timestamp" not in kwargs:
            kwargs["timestamp"] = self.min_ago + timedelta(seconds=8)

        if "trace_context" not in kwargs:
            # should appear for all of the pXX metrics
            kwargs["trace_context"] = {
                "op": "http.server",
                "hash": "ab" * 8,
                "exclusive_time": 4.0,
            }

        if "spans" not in kwargs:
            kwargs["spans"] = [
                # should appear for the sum metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=1)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "op": "django.middleware",
                    "description": "middleware span",
                    "hash": "cd" * 8,
                    "exclusive_time": 3.0,
                }
                for x in ["b", "c"]
            ] + [
                # should appear for the count metric
                {
                    "same_process_as_parent": True,
                    "parent_span_id": "a" * 16,
                    "span_id": x * 16,
                    "start_timestamp": iso_format(self.min_ago + timedelta(seconds=4)),
                    "timestamp": iso_format(self.min_ago + timedelta(seconds=5)),
                    "op": "django.view",
                    "description": "view span",
                    "hash": "ef" * 8,
                    "exclusive_time": 1.0,
                }
                for x in ["d", "e", "f"]
            ]

        data = load_data("transaction", **kwargs)
        data["transaction"] = "root transaction"

        return self.store_event(data, project_id=self.project.id)

</source>
</class>

<class classid="14" nclones="2" nlines="11" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="415" endline="428" pcid="11866">
    def test_no_projects(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        self.login_as(user=user)

        url = reverse(
            self.URL,
            kwargs={"organization_slug": org.slug},
        )

        with self.feature(self.FEATURES):
            response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="976" endline="989" pcid="11882">
    def test_no_projects(self):
        user = self.create_user()
        org = self.create_organization(owner=user)
        self.login_as(user=user)

        url = reverse(
            self.URL,
            kwargs={"organization_slug": org.slug},
        )

        with self.feature(self.FEATURES):
            response = self.client.get(url, format="json")
        assert response.status_code == 404, response.content

</source>
</class>

<class classid="15" nclones="2" nlines="27" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="1001" endline="1035" pcid="11884">
    def test_bad_span_param(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "span must consist of of a span op and a valid 16 character hex delimited by a colon (:)",
                    code="invalid",
                )
            ]
        }

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server:ab"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "spanGroup must be a valid 16 character hex (containing only digits, or a-f characters)",
                    code="invalid",
                )
            ]
        }

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_spans_performance.py" startline="1109" endline="1143" pcid="11889">
    def test_bad_span_param(self):
        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "span must consist of of a span op and a valid 16 character hex delimited by a colon (:)",
                    code="invalid",
                )
            ]
        }

        with self.feature(self.FEATURES):
            response = self.client.get(
                self.url,
                data={"project": self.project.id, "span": ["http.server:ab"]},
                format="json",
            )

        assert response.status_code == 400, response.content
        assert response.data == {
            "span": [
                ErrorDetail(
                    "spanGroup must be a valid 16 character hex (containing only digits, or a-f characters)",
                    code="invalid",
                )
            ]
        }

</source>
</class>

<class classid="16" nclones="2" nlines="15" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="322" endline="337" pcid="12016">
    def test_invalid_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "apdex(450)",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 400

</source>
<source file="systems/sentry-22.2.0/tests/snuba/api/endpoints/test_organization_events_trends.py" startline="774" endline="789" pcid="12029">
    def test_invalid_trend_function(self):
        with self.feature(self.features):
            response = self.client.get(
                self.url,
                format="json",
                data={
                    "end": iso_format(self.day_ago + timedelta(hours=2)),
                    "start": iso_format(self.day_ago),
                    "field": ["project", "transaction"],
                    "query": "event.type:transaction",
                    "trendFunction": "apdex(450)",
                    "project": [self.project.id],
                },
            )
            assert response.status_code == 400

</source>
</class>

<class classid="17" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="211" endline="227" pcid="12181">
    def increment(self, event, count, environment=None, timestamp=None):
        data = {
            "fingerprint": event.data["fingerprint"],
            "timestamp": iso_format(timestamp) if timestamp else iso_format(before_now(minutes=1)),
        }
        if environment:
            data["environment"] = environment

        for _ in range(count):
            event_data = deepcopy(data)
            event_data["user"] = {"id": uuid4().hex}
            self.store_event(
                data=event_data,
                project_id=self.project.id,
            )


</source>
<source file="systems/sentry-22.2.0/tests/snuba/rules/conditions/test_event_frequency.py" startline="289" endline="304" pcid="12185">
    def increment(self, event, count, environment=None, timestamp=None):
        data = {
            "fingerprint": event.data["fingerprint"],
            "timestamp": iso_format(timestamp) if timestamp else iso_format(before_now(minutes=1)),
        }
        if environment:
            data["environment"] = environment

        for _ in range(count):
            event_data = deepcopy(data)
            event_data["user"] = {"id": uuid4().hex}
            self.store_event(
                data=event_data,
                project_id=self.project.id,
            )

</source>
</class>

<class classid="18" nclones="2" nlines="14" similarity="100">
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_project_release_files.py" startline="41" endline="56" pcid="12274">
    def test_post(self):
        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }
        response = self.client.post(
            self.url,
            data,
            format="multipart",
        )
        request = RequestFactory().post(self.url, data=data, content_type="multipart/form-data")

        self.validate_schema(request, response)
</source>
<source file="systems/sentry-22.2.0/tests/apidocs/endpoints/releases/test_organization_release_files.py" startline="36" endline="51" pcid="12282">
    def test_post(self):
        data = {
            "name": "http://example.com/application.js",
            "header": "X-SourceMap: http://example.com",
            "file": SimpleUploadedFile(
                "application.js", b"function() { }", content_type="application/javascript"
            ),
        }
        response = self.client.post(
            self.url,
            data,
            format="multipart",
        )
        request = RequestFactory().post(self.url, data=data, content_type="multipart/form-data")

        self.validate_schema(request, response)
</source>
</class>

</clones>
