<html>
<head>
    <title>NiCad6 Clone Report</title>
    <style type="text/css">
        body {font-family:sans-serif;}
        table {background-color:white; border:0px; padding:0px; border-spacing:4px; width:auto; margin-left:30px; margin-right:auto;}
        td {background-color:rgba(192,212,238,0.8); border:0px; padding:8px; width:auto; vertical-align:top; border-radius:8px}
        pre {background-color:white; padding:4px;}
        a {color:darkblue;}
    </style>
</head>
<body>
<h2>NiCad6 Clone Report</h2>
<table>
<tr style="font-size:14pt">
<td><b>System:</b> &nbsp; zulip-5.0-rc1</td>
<td><b>Clone pairs:</b> &nbsp; 1092</td>
<td><b>Clone classes:</b> &nbsp; 44</td>
</tr>
<tr style="font-size:12pt">
<td style="background-color:white">Clone type: &nbsp; 3-2</td>
<td style="background-color:white">Granularity: &nbsp; functions-blind</td>
<td style="background-color:white">Max diff threshold: &nbsp; 30%</td>
<td style="background-color:white">Clone size: &nbsp; 10 - 2500 lines</td>
<td style="background-color:white">Total functions-blind: &nbsp; 2151</td>
</tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 1:</b> &nbsp; 2 fragments, nominal size 12 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag33')" href="javascript:;">
zulip-5.0-rc1/tools/droplets/create.py: 44-57
</a>
<div class="mid" id="frag33" style="display:none"><pre>
def assert_github_user_exists(github_username: str) -&gt; bool:
    print(f"Checking to see if GitHub user {github_username} exists...")
    user_api_url = f"https://api.github.com/users/{github_username}"
    try:
        response = urllib.request.urlopen(user_api_url)
        json.load(response)
        print("...user exists!")
        return True
    except urllib.error.HTTPError as err:
        print(err)
        print(f"Does the GitHub user {github_username} exist?")
        sys.exit(1)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag35')" href="javascript:;">
zulip-5.0-rc1/tools/droplets/create.py: 77-90
</a>
<div class="mid" id="frag35" style="display:none"><pre>
def assert_user_forked_zulip_server_repo(username: str) -&gt; bool:
    print("Checking to see GitHub user has forked zulip/zulip...")
    apiurl_fork = f"https://api.github.com/repos/{username}/zulip"
    try:
        response = urllib.request.urlopen(apiurl_fork)
        json.load(response)
        print("...fork found!")
        return True
    except urllib.error.HTTPError as err:
        print(err)
        print(f"Has user {username} forked zulip/zulip?")
        sys.exit(1)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 2:</b> &nbsp; 3 fragments, nominal size 12 lines, similarity 71%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag98')" href="javascript:;">
zulip-5.0-rc1/tools/tests/test_template_parser.py: 145-162
</a>
<div class="mid" id="frag98" style="display:none"><pre>
    def test_validate_incomplete_html_tag_2(self) -&gt; None:
        my_html = """
            &lt;a href="
        """
        my_html1 = """
            &lt;a href=""
        """
        self._assert_validate_error(
            '''Tag missing "&gt;" at line 2 col 13:"&lt;a href=""
        "''',
            text=my_html1,
        )
        self._assert_validate_error(
            '''Unbalanced quotes at line 2 col 13:"&lt;a href="
        "''',
            text=my_html,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1352')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/travis/tests.py: 102-116
</a>
<div class="mid" id="frag1352" style="display:none"><pre>
    def test_travis_exclude_glob_events(self) -&gt; None:
        self.url = f'{self.build_webhook_url()}&amp;exclude_events=["*"]&amp;ignore_pull_requests=false'

        self.check_webhook(
            "pull_request",
            content_type="application/x-www-form-urlencoded",
            expect_noop=True,
        )

        self.check_webhook(
            "build",
            content_type="application/x-www-form-urlencoded",
            expect_noop=True,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1351')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/travis/tests.py: 85-101
</a>
<div class="mid" id="frag1351" style="display:none"><pre>
    def test_travis_include_glob_events(self) -&gt; None:
        self.url = f'{self.build_webhook_url()}&amp;include_events=["*"]&amp;ignore_pull_requests=false'

        self.check_webhook(
            "pull_request",
            self.TOPIC,
            self.EXPECTED_MESSAGE,
            content_type="application/x-www-form-urlencoded",
        )

        self.check_webhook(
            "build",
            self.TOPIC,
            self.EXPECTED_MESSAGE,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 3:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag182')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0352_migrate_twenty_four_hour_time_to_realmuserdefault.py: 9-21
</a>
<div class="mid" id="frag182" style="display:none"><pre>
def migrate_twenty_four_hour_time_to_realmuserdefault(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    realm_user_default_objects = RealmUserDefault.objects.exclude(
        twenty_four_hour_time=F("realm__default_twenty_four_hour_time")
    )
    for realm_user_default in realm_user_default_objects:
        realm = realm_user_default.realm
        realm_user_default.twenty_four_hour_time = realm.default_twenty_four_hour_time
        realm_user_default.save(update_fields=["twenty_four_hour_time"])


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag183')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0352_migrate_twenty_four_hour_time_to_realmuserdefault.py: 22-34
</a>
<div class="mid" id="frag183" style="display:none"><pre>
def reverse_migrate_twenty_four_hour_time_to_realmuserdefault(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    realm_user_default_objects = RealmUserDefault.objects.exclude(
        realm__default_twenty_four_hour_time=F("twenty_four_hour_time")
    )
    for realm_user_default in realm_user_default_objects:
        realm = realm_user_default.realm
        realm.default_twenty_four_hour_time = realm_user_default.twenty_four_hour_time
        realm.save(update_fields=["default_twenty_four_hour_time"])


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 4:</b> &nbsp; 3 fragments, nominal size 16 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag188')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0322_realm_create_audit_log_backfill.py: 8-27
</a>
<div class="mid" id="frag188" style="display:none"><pre>
def backfill_realm_creation_log_events(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.REALM_CREATED = 215

    Realm = apps.get_model("zerver", "Realm")

    objects_to_create = []
    for realm in Realm.objects.all():
        entry = RealmAuditLog(
            realm=realm,
            event_type=RealmAuditLog.REALM_CREATED,
            event_time=realm.date_created,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2092')" href="javascript:;">
zulip-5.0-rc1/zilencer/migrations/0022_remotezulipserver_create_audit_log_backfill.py: 6-24
</a>
<div class="mid" id="frag2092" style="display:none"><pre>
def backfill_remote_zulip_server_creation_log_events(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    RemoteZulipServer = apps.get_model("zilencer", "RemoteZulipServer")
    RemoteZulipServerAuditLog = apps.get_model("zilencer", "RemoteZulipServerAuditLog")
    RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED = 10215

    objects_to_create = []
    for remote_server in RemoteZulipServer.objects.all():
        entry = RemoteZulipServerAuditLog(
            server=remote_server,
            event_type=RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED,
            event_time=remote_server.last_updated,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RemoteZulipServerAuditLog.objects.bulk_create(objects_to_create)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag217')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0374_backfill_user_delete_realmauditlog.py: 6-28
</a>
<div class="mid" id="frag217" style="display:none"><pre>
def backfill_user_deleted_logs(apps: StateApps, schema_editor: DatabaseSchemaEditor) -&gt; None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.USER_DELETED = 106

    UserProfile = apps.get_model("zerver", "UserProfile")

    objects_to_create = []
    for user_profile in UserProfile.objects.filter(
        is_mirror_dummy=True, is_active=False, delivery_email__regex=r"^deleteduser\d+@.+"
    ):
        entry = RealmAuditLog(
            realm_id=user_profile.realm_id,
            modified_user=user_profile,
            acting_user=user_profile,
            event_type=RealmAuditLog.USER_DELETED,
            # For old dummy users, the date_joined is the time of the deletion.
            event_time=user_profile.date_joined,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 5:</b> &nbsp; 2 fragments, nominal size 11 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag199')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0244_message_copy_pub_date_to_date_sent.py: 13-30
</a>
<div class="mid" id="frag199" style="display:none"><pre>
def sql_copy_pub_date_to_date_sent(id_range_lower_bound: int, id_range_upper_bound: int) -&gt; None:
    query = SQL(
        """
            UPDATE zerver_message
            SET date_sent = pub_date
            WHERE id BETWEEN %(lower_bound)s AND %(upper_bound)s
    """
    )
    with connection.cursor() as cursor:
        cursor.execute(
            query,
            {
                "lower_bound": id_range_lower_bound,
                "upper_bound": id_range_upper_bound,
            },
        )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag248')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0239_usermessage_copy_id_to_bigint_id.py: 14-31
</a>
<div class="mid" id="frag248" style="display:none"><pre>
def sql_copy_id_to_bigint_id(id_range_lower_bound: int, id_range_upper_bound: int) -&gt; None:
    query = SQL(
        """
            UPDATE zerver_usermessage
            SET bigint_id = id
            WHERE id BETWEEN %(lower_bound)s AND %(upper_bound)s
    """
    )
    with connection.cursor() as cursor:
        cursor.execute(
            query,
            {
                "lower_bound": id_range_lower_bound,
                "upper_bound": id_range_upper_bound,
            },
        )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 6:</b> &nbsp; 2 fragments, nominal size 16 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag200')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0244_message_copy_pub_date_to_date_sent.py: 31-57
</a>
<div class="mid" id="frag200" style="display:none"><pre>
def copy_pub_date_to_date_sent(apps: StateApps, schema_editor: DatabaseSchemaEditor) -&gt; None:
    Message = apps.get_model("zerver", "Message")
    if not Message.objects.exists():
        # Nothing to do
        return

    first_uncopied_id = Message.objects.filter(date_sent__isnull=True).aggregate(Min("id"))[
        "id__min"
    ]
    # Note: the below id can fall in a segment
    # where date_sent = pub_date already, but it's not a big problem
    # this will just do some redundant UPDATEs.
    last_id = Message.objects.latest("id").id

    id_range_lower_bound = first_uncopied_id
    id_range_upper_bound = first_uncopied_id + BATCH_SIZE
    while id_range_upper_bound &lt;= last_id:
        sql_copy_pub_date_to_date_sent(id_range_lower_bound, id_range_upper_bound)
        id_range_lower_bound = id_range_upper_bound + 1
        id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
        time.sleep(0.1)

    if last_id &gt; id_range_lower_bound:
        # Copy for the last batch.
        sql_copy_pub_date_to_date_sent(id_range_lower_bound, last_id)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag249')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0239_usermessage_copy_id_to_bigint_id.py: 32-59
</a>
<div class="mid" id="frag249" style="display:none"><pre>
def copy_id_to_bigid(apps: StateApps, schema_editor: DatabaseSchemaEditor) -&gt; None:
    UserMessage = apps.get_model("zerver", "UserMessage")
    if not UserMessage.objects.exists():
        # Nothing to do
        return

    #  TODO: is  the below lookup fast enough, considering there's no index on bigint_id?
    first_uncopied_id = UserMessage.objects.filter(bigint_id__isnull=True).aggregate(Min("id"))[
        "id__min"
    ]
    # Note: the below id can fall in a segment
    # where bigint_id = id already, but it's not a big problem
    # this will just do some redundant UPDATEs.
    last_id = UserMessage.objects.latest("id").id

    id_range_lower_bound = first_uncopied_id
    id_range_upper_bound = first_uncopied_id + BATCH_SIZE
    while id_range_upper_bound &lt;= last_id:
        sql_copy_id_to_bigint_id(id_range_lower_bound, id_range_upper_bound)
        id_range_lower_bound = id_range_upper_bound + 1
        id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
        time.sleep(0.1)

    if last_id &gt; id_range_lower_bound:
        # Copy for the last batch.
        sql_copy_id_to_bigint_id(id_range_lower_bound, last_id)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 7:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag211')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0328_migrate_to_edit_topic_policy.py: 20-33
</a>
<div class="mid" id="frag211" style="display:none"><pre>
def reverse_migrate_to_edit_topic_policy(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.POLICY_EVERYONE = 5
    Realm.POLICY_ADMINS_ONLY = 2
    Realm.objects.filter(edit_topic_policy=Realm.POLICY_ADMINS_ONLY).update(
        allow_community_topic_editing=False
    )
    Realm.objects.filter(edit_topic_policy=Realm.POLICY_EVERYONE).update(
        allow_community_topic_editing=True
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag245')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0338_migrate_to_add_custom_emoji_policy.py: 22-35
</a>
<div class="mid" id="frag245" style="display:none"><pre>
def reverse_migrate_to_add_custom_emoji_policy(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.ADD_CUSTOM_EMOJI_MEMBERS_ONLY = 1
    Realm.ADD_CUSTOM_EMOJI_ADMINS_ONLY = 2
    Realm.objects.filter(add_custom_emoji_policy=Realm.ADD_CUSTOM_EMOJI_MEMBERS_ONLY).update(
        add_emoji_by_admins_only=False
    )
    Realm.objects.filter(add_custom_emoji_policy=Realm.ADD_CUSTOM_EMOJI_ADMINS_ONLY).update(
        add_emoji_by_admins_only=True
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 8:</b> &nbsp; 2 fragments, nominal size 16 lines, similarity 72%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag229')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0221_subscription_notifications_data_migration.py: 16-31
</a>
<div class="mid" id="frag229" style="display:none"><pre>
def update_notification_settings(apps: StateApps, schema_editor: DatabaseSchemaEditor) -&gt; None:
    Subscription = apps.get_model("zerver", "Subscription")
    UserProfile = apps.get_model("zerver", "UserProfile")

    for setting_value in [True, False]:
        for sub_setting_name, user_setting_name in SETTINGS_MAP.items():
            sub_filter_kwargs = {sub_setting_name: setting_value}
            user_filter_kwargs = {user_setting_name: setting_value}
            update_kwargs = {sub_setting_name: None}
            Subscription.objects.filter(
                user_profile__in=UserProfile.objects.filter(**user_filter_kwargs),
                recipient__type=RECIPIENT_STREAM,
                **sub_filter_kwargs,
            ).update(**update_kwargs)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag230')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0221_subscription_notifications_data_migration.py: 32-54
</a>
<div class="mid" id="frag230" style="display:none"><pre>
def reverse_notification_settings(apps: StateApps, schema_editor: DatabaseSchemaEditor) -&gt; None:
    Subscription = apps.get_model("zerver", "Subscription")
    UserProfile = apps.get_model("zerver", "UserProfile")

    for setting_value in [True, False]:
        for sub_setting_name, user_setting_name in SETTINGS_MAP.items():
            sub_filter_kwargs = {sub_setting_name: None}
            user_filter_kwargs = {user_setting_name: setting_value}
            update_kwargs = {sub_setting_name: setting_value}
            Subscription.objects.filter(
                user_profile__in=UserProfile.objects.filter(**user_filter_kwargs),
                recipient__type=RECIPIENT_STREAM,
                **sub_filter_kwargs,
            ).update(**update_kwargs)

    for sub_setting_name, user_setting_name in SETTINGS_MAP.items():
        sub_filter_kwargs = {sub_setting_name: None}
        update_kwargs = {sub_setting_name: True}
        Subscription.objects.filter(recipient__type__in=[1, 3], **sub_filter_kwargs).update(
            **update_kwargs
        )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 9:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag240')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0356_migrate_to_delete_own_message_policy.py: 8-21
</a>
<div class="mid" id="frag240" style="display:none"><pre>
def migrate_to_delete_own_message_policy(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.POLICY_EVERYONE = 5
    Realm.POLICY_ADMINS_ONLY = 2
    Realm.objects.filter(allow_message_deleting=False).update(
        delete_own_message_policy=Realm.POLICY_ADMINS_ONLY
    )
    Realm.objects.filter(allow_message_deleting=True).update(
        delete_own_message_policy=Realm.POLICY_EVERYONE
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag244')" href="javascript:;">
zulip-5.0-rc1/zerver/migrations/0338_migrate_to_add_custom_emoji_policy.py: 8-21
</a>
<div class="mid" id="frag244" style="display:none"><pre>
def migrate_to_add_custom_emoji_policy(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.ADD_CUSTOM_EMOJI_MEMBERS_ONLY = 1
    Realm.ADD_CUSTOM_EMOJI_ADMINS_ONLY = 2
    Realm.objects.filter(add_emoji_by_admins_only=False).update(
        add_custom_emoji_policy=Realm.ADD_CUSTOM_EMOJI_MEMBERS_ONLY
    )
    Realm.objects.filter(add_emoji_by_admins_only=True).update(
        add_custom_emoji_policy=Realm.ADD_CUSTOM_EMOJI_ADMINS_ONLY
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 10:</b> &nbsp; 3 fragments, nominal size 10 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag272')" href="javascript:;">
zulip-5.0-rc1/zerver/views/user_groups.py: 32-43
</a>
<div class="mid" id="frag272" style="display:none"><pre>
def add_user_group(
    request: HttpRequest,
    user_profile: UserProfile,
    name: str = REQ(),
    members: Sequence[int] = REQ(json_validator=check_list(check_int), default=[]),
    description: str = REQ(),
) -&gt; HttpResponse:
    user_profiles = user_ids_to_users(members, user_profile.realm)
    check_add_user_group(user_profile.realm, name, user_profiles, description)
    return json_success(request)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2005')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/zendesk/view.py: 19-33
</a>
<div class="mid" id="frag2005" style="display:none"><pre>
def api_zendesk_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    ticket_title: str = REQ(),
    ticket_id: str = REQ(),
    message: str = REQ(),
) -&gt; HttpResponse:
    """
    Zendesk uses triggers with message templates. This webhook uses the
    ticket_id and ticket_title to create a subject. And passes with zendesk
    user's configured message to zulip.
    """
    subject = truncate(f"#{ticket_id}: {ticket_title}", 60)
    check_send_webhook_message(request, user_profile, subject, message)
    return json_success(request)
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1422')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/heroku/view.py: 21-33
</a>
<div class="mid" id="frag1422" style="display:none"><pre>
def api_heroku_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    head: str = REQ(),
    app: str = REQ(),
    user: str = REQ(),
    url: str = REQ(),
    git_log: str = REQ(),
) -&gt; HttpResponse:
    content = TEMPLATE.format(user=user, head=head, app=app, url=url, git_log=git_log)

    check_send_webhook_message(request, user_profile, app, content)
    return json_success(request)
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 11:</b> &nbsp; 3 fragments, nominal size 11 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag417')" href="javascript:;">
zulip-5.0-rc1/zerver/lib/transfer.py: 35-47
</a>
<div class="mid" id="frag417" style="display:none"><pre>
def transfer_avatars_to_s3(processes: int) -&gt; None:
    users = list(UserProfile.objects.all())
    if processes == 1:
        for user in users:
            _transfer_avatar_to_s3(user)
    else:  # nocoverage
        connection.close()
        cache._cache.disconnect_all()
        with multiprocessing.Pool(processes) as p:
            for out in p.imap_unordered(_transfer_avatar_to_s3, users):
                pass


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag419')" href="javascript:;">
zulip-5.0-rc1/zerver/lib/transfer.py: 65-77
</a>
<div class="mid" id="frag419" style="display:none"><pre>
def transfer_message_files_to_s3(processes: int) -&gt; None:
    attachments = list(Attachment.objects.all())
    if processes == 1:
        for attachment in attachments:
            _transfer_message_files_to_s3(attachment)
    else:  # nocoverage
        connection.close()
        cache._cache.disconnect_all()
        with multiprocessing.Pool(processes) as p:
            for out in p.imap_unordered(_transfer_message_files_to_s3, attachments):
                pass


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag421')" href="javascript:;">
zulip-5.0-rc1/zerver/lib/transfer.py: 94-104
</a>
<div class="mid" id="frag421" style="display:none"><pre>
def transfer_emoji_to_s3(processes: int) -&gt; None:
    realm_emojis = list(RealmEmoji.objects.filter())
    if processes == 1:
        for realm_emoji in realm_emojis:
            _transfer_emoji_to_s3(realm_emoji)
    else:  # nocoverage
        connection.close()
        cache._cache.disconnect_all()
        with multiprocessing.Pool(processes) as p:
            for out in p.imap_unordered(_transfer_emoji_to_s3, realm_emojis):
                pass
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 12:</b> &nbsp; 2 fragments, nominal size 14 lines, similarity 71%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag489')" href="javascript:;">
zulip-5.0-rc1/zerver/lib/logging_util.py: 229-243
</a>
<div class="mid" id="frag489" style="display:none"><pre>
    def _compute_fmt(self) -&gt; str:
        basic = super()._compute_fmt()
        multiline = [
            basic,
            "user: %(user)s",
            "client: %(client)s",
            "url: %(url)s",
            "content_type: %(content_type)s",
            "custom_headers:",
            "%(custom_headers)s",
            "payload:",
            "%(payload)s",
        ]
        return "\n".join(multiline)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1644')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/github/tests.py: 429-446
</a>
<div class="mid" id="frag1644" style="display:none"><pre>
    def test_ignored_events(self) -&gt; None:
        # The payload for these events never gets looked at in the
        # webhook itself; it only needs to be valid JSON.
        payload = "{}"

        ignored_events = [
            "check_suite",
            "label",
            "meta",
            "milestone",
            "organization",
            "project_card",
            "repository_vulnerability_alert",
        ]

        for event in ignored_events:
            self.verify_post_is_ignored(payload, event)

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 13:</b> &nbsp; 14 fragments, nominal size 18 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag594')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 237-267
</a>
<div class="mid" id="frag594" style="display:none"><pre>
    def test_receive_stream_email_messages_success(self) -&gt; None:

        # build dummy messages for stream
        # test valid incoming stream message is processed properly
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestStreamEmailMessages body")
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

    # Test receiving an email with the address on an UnstructuredHeader
    # (e.g. Envelope-To) instead of an AddressHeader (e.g. To).
    # https://github.com/zulip/zulip/issues/15864
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag610')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 759-782
</a>
<div class="mid" id="frag610" style="display:none"><pre>
    def test_receive_stream_email_messages_empty_body(self) -&gt; None:
        # build dummy messages for stream
        # test message with empty body is not sent
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_to_address = encode_email_address(stream)

        # empty body
        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        with self.assertLogs(logger_name, level="INFO") as m:
            process_message(incoming_valid_message)
        self.assertEqual(
            m.output, [f"INFO:{logger_name}:Email has no nonempty body sections; ignoring."]
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag601')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 435-463
</a>
<div class="mid" id="frag601" style="display:none"><pre>
    def test_receive_stream_email_include_footer_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        parts = stream_to_address.split("@")
        parts[0] += "+include-footer"
        stream_to_address = "@".join(parts)

        text = """Test message
        --
        Footer"""

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content(text)
        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, text)
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag602')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 464-495
</a>
<div class="mid" id="frag602" style="display:none"><pre>
    def test_receive_stream_email_include_quotes_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        parts = stream_to_address.split("@")
        parts[0] += "+include-quotes"
        stream_to_address = "@".join(parts)

        text = """Reply

        -----Original Message-----

        Quote"""

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content(text)
        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, text)
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag612')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 815-839
</a>
<div class="mid" id="frag612" style="display:none"><pre>
    def test_receive_stream_email_messages_empty_body_after_stripping(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        headers = {}
        headers["Reply-To"] = self.example_email("othello")

        # empty body
        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("-- \nFooter")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "(No email body)")


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag598')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 346-374
</a>
<div class="mid" id="frag598" style="display:none"><pre>
    def test_receive_stream_email_multiple_recipient_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        # stream address is angle-addr within multiple addresses
        stream_to_addresses = [
            "A.N. Other &lt;another@example.org&gt;",
            f"Denmark &lt;{encode_email_address(stream)}&gt;",
        ]

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = ", ".join(stream_to_addresses)
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestStreamEmailMessages body")
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag637')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1444-1467
</a>
<div class="mid" id="frag637" style="display:none"><pre>
    def test_process_message_strips_subject(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_to_address = encode_email_address(stream)
        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")
        incoming_valid_message["Subject"] = "Re: Fwd: Re: Test"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)
        self.assertEqual("Test", message.topic_name())

        # If after stripping we get an empty subject, it should get set to (no topic)
        del incoming_valid_message["Subject"]
        incoming_valid_message["Subject"] = "Re: Fwd: Re: "
        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)
        self.assertEqual("(no topic)", message.topic_name())

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag596')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 295-319
</a>
<div class="mid" id="frag596" style="display:none"><pre>
    def test_receive_stream_email_messages_blank_subject_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")

        incoming_valid_message["Subject"] = ""
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestStreamEmailMessages body")
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), "(no topic)")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag597')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 320-345
</a>
<div class="mid" id="frag597" style="display:none"><pre>
    def test_receive_private_stream_email_messages_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.make_stream("private_stream", invite_only=True)
        self.subscribe(user_profile, "private_stream")
        stream = get_stream("private_stream", user_profile.realm)

        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestStreamEmailMessages body")
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag609')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 731-757
</a>
<div class="mid" id="frag609" style="display:none"><pre>
    def test_receive_only_plaintext_with_prefer_html_option(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_address_prefer_html = f"Denmark.{stream.email_token}.prefer-html@testserver"

        text = "Test message"
        # This should be correctly identified as empty html body:
        html = "&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"

        incoming_valid_message = EmailMessage()
        incoming_valid_message.add_alternative(text)
        incoming_valid_message.add_alternative(html, subtype="html")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_address_prefer_html
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        # HTML body is empty, so the plaintext content should be picked, despite prefer-html option.
        self.assertEqual(message.content, "Test message")


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag595')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 268-294
</a>
<div class="mid" id="frag595" style="display:none"><pre>
    def test_receive_stream_email_messages_other_header_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        # Simulate a mailing list
        incoming_valid_message["To"] = "foo-mailinglist@example.com"
        incoming_valid_message["Envelope-To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestStreamEmailMessages body")
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag599')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 375-402
</a>
<div class="mid" id="frag599" style="display:none"><pre>
    def test_receive_stream_email_show_sender_success(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        parts = stream_to_address.split("@")
        parts[0] += "+show-sender"
        stream_to_address = "@".join(parts)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")
        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(
            message.content,
            "From: {}\n{}".format(self.example_email("hamlet"), "TestStreamEmailMessages body"),
        )
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag608')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 698-730
</a>
<div class="mid" id="frag608" style="display:none"><pre>
    def test_receive_plaintext_and_html_prefer_text_html_options(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_address = f"Denmark.{stream.email_token}@testserver"
        stream_address_prefer_html = f"Denmark.{stream.email_token}.prefer-html@testserver"

        text = "Test message"
        html = "&lt;html&gt;&lt;body&gt;&lt;b&gt;Test html message&lt;/b&gt;&lt;/body&gt;&lt;/html&gt;"

        incoming_valid_message = EmailMessage()
        incoming_valid_message.add_alternative(text)
        incoming_valid_message.add_alternative(html, subtype="html")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "Test message")

        del incoming_valid_message["To"]
        incoming_valid_message["To"] = stream_address_prefer_html

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "**Test html message**")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag600')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 403-434
</a>
<div class="mid" id="frag600" style="display:none"><pre>
    def test_receive_stream_email_show_sender_utf8_encoded_sender(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        parts = stream_to_address.split("@")
        parts[0] += "+show-sender"
        stream_to_address = "@".join(parts)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestStreamEmailMessages body")
        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message[
            "From"
        ] = "Test =?utf-8?b?VXNlcsOzxIXEmQ==?= &lt;=?utf-8?q?hamlet=5F=C4=99?=@zulip.com&gt;"
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)

        self.assertEqual(
            message.content,
            "From: {}\n{}".format(
                "Test Useróąę &lt;hamlet_ę@zulip.com&gt;", "TestStreamEmailMessages body"
            ),
        )
        self.assertEqual(get_display_recipient(message.recipient), stream.name)
        self.assertEqual(message.topic_name(), incoming_valid_message["Subject"])

</pre></div>
</td>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 14:</b> &nbsp; 3 fragments, nominal size 35 lines, similarity 91%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag603')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 497-538
</a>
<div class="mid" id="frag603" style="display:none"><pre>
    def test_message_with_valid_attachment(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("Test body")
        with open(
            os.path.join(settings.DEPLOY_ROOT, "static/images/default-avatar.png"), "rb"
        ) as f:
            image_bytes = f.read()

        incoming_valid_message.add_attachment(
            image_bytes,
            maintype="image",
            subtype="png",
            filename="image.png",
        )

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        with mock.patch(
            "zerver.lib.email_mirror.upload_message_file", return_value="https://test_url"
        ) as upload_message_file:
            process_message(incoming_valid_message)
            upload_message_file.assert_called_with(
                "image.png",
                len(image_bytes),
                "image/png",
                image_bytes,
                get_system_bot(settings.EMAIL_GATEWAY_BOT, stream.realm_id),
                target_realm=user_profile.realm,
            )

        message = most_recent_message(user_profile)
        self.assertEqual(message.content, "Test body\n[image.png](https://test_url)")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag605')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 579-621
</a>
<div class="mid" id="frag605" style="display:none"><pre>
    def test_message_with_attachment_utf8_filename(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("Test body")
        with open(
            os.path.join(settings.DEPLOY_ROOT, "static/images/default-avatar.png"), "rb"
        ) as f:
            image_bytes = f.read()

        utf8_filename = "image_ąęó.png"
        incoming_valid_message.add_attachment(
            image_bytes,
            maintype="image",
            subtype="png",
            filename=utf8_filename,
        )

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        with mock.patch(
            "zerver.lib.email_mirror.upload_message_file", return_value="https://test_url"
        ) as upload_message_file:
            process_message(incoming_valid_message)
            upload_message_file.assert_called_with(
                utf8_filename,
                len(image_bytes),
                "image/png",
                image_bytes,
                get_system_bot(settings.EMAIL_GATEWAY_BOT, stream.realm_id),
                target_realm=user_profile.realm,
            )

        message = most_recent_message(user_profile)
        self.assertEqual(message.content, f"Test body\n[{utf8_filename}](https://test_url)")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag606')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 622-667
</a>
<div class="mid" id="frag606" style="display:none"><pre>
    def test_message_with_valid_nested_attachment(self) -&gt; None:
        user_profile = self.example_user("hamlet")
        self.login_user(user_profile)
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)
        stream_to_address = encode_email_address(stream)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("Test body")

        nested_multipart = EmailMessage()
        nested_multipart.set_content("Nested text that should get skipped.")
        with open(
            os.path.join(settings.DEPLOY_ROOT, "static/images/default-avatar.png"), "rb"
        ) as f:
            image_bytes = f.read()

        nested_multipart.add_attachment(
            image_bytes,
            maintype="image",
            subtype="png",
            filename="image.png",
        )
        incoming_valid_message.add_attachment(nested_multipart)

        incoming_valid_message["Subject"] = "Subject"
        incoming_valid_message["From"] = self.example_email("hamlet")
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        with mock.patch(
            "zerver.lib.email_mirror.upload_message_file", return_value="https://test_url"
        ) as upload_message_file:
            process_message(incoming_valid_message)
            upload_message_file.assert_called_with(
                "image.png",
                len(image_bytes),
                "image/png",
                image_bytes,
                get_system_bot(settings.EMAIL_GATEWAY_BOT, stream.realm_id),
                target_realm=user_profile.realm,
            )

        message = most_recent_message(user_profile)
        self.assertEqual(message.content, "Test body\n[image.png](https://test_url)")

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 15:</b> &nbsp; 7 fragments, nominal size 30 lines, similarity 72%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag613')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 841-883
</a>
<div class="mid" id="frag613" style="display:none"><pre>
    def test_receive_missed_personal_message_email_messages(self) -&gt; None:

        # build dummy messages for message notification email reply
        # have Hamlet send Othello a PM. Othello will reply via email
        # Hamlet will receive the message.
        self.login("hamlet")
        othello = self.example_user("othello")
        result = self.client_post(
            "/json/messages",
            {
                "type": "private",
                "content": "test_receive_missed_message_email_messages",
                "to": orjson.dumps([othello.id]).decode(),
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        usermessage = most_recent_usermessage(user_profile)

        # we don't want to send actual emails but we do need to create and store the
        # token for looking up who did reply.
        mm_address = create_missed_message_address(user_profile, usermessage.message)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("othello")
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = self.example_email("othello")

        process_message(incoming_valid_message)

        # confirm that Hamlet got the message
        user_profile = self.example_user("hamlet")
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestMissedMessageEmailMessages body")
        self.assertEqual(message.sender, self.example_user("othello"))
        self.assertEqual(message.recipient.type_id, user_profile.id)
        self.assertEqual(message.recipient.type, Recipient.PERSONAL)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag614')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 884-934
</a>
<div class="mid" id="frag614" style="display:none"><pre>
    def test_receive_missed_huddle_message_email_messages(self) -&gt; None:

        # build dummy messages for message notification email reply
        # have Othello send Iago and Cordelia a PM. Cordelia will reply via email
        # Iago and Othello will receive the message.
        self.login("othello")
        cordelia = self.example_user("cordelia")
        iago = self.example_user("iago")
        result = self.client_post(
            "/json/messages",
            {
                "type": "private",
                "content": "test_receive_missed_message_email_messages",
                "to": orjson.dumps([cordelia.id, iago.id]).decode(),
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("cordelia")
        usermessage = most_recent_usermessage(user_profile)

        # we don't want to send actual emails but we do need to create and store the
        # token for looking up who did reply.
        mm_address = create_missed_message_address(user_profile, usermessage.message)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedHuddleMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedHuddleMessageEmailMessages subject"
        incoming_valid_message["From"] = self.example_email("cordelia")
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = self.example_email("cordelia")

        process_message(incoming_valid_message)

        # Confirm Iago received the message.
        user_profile = self.example_user("iago")
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestMissedHuddleMessageEmailMessages body")
        self.assertEqual(message.sender, self.example_user("cordelia"))
        self.assertEqual(message.recipient.type, Recipient.HUDDLE)

        # Confirm Othello received the message.
        user_profile = self.example_user("othello")
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestMissedHuddleMessageEmailMessages body")
        self.assertEqual(message.sender, self.example_user("cordelia"))
        self.assertEqual(message.recipient.type, Recipient.HUDDLE)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag615')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 935-978
</a>
<div class="mid" id="frag615" style="display:none"><pre>
    def test_receive_missed_stream_message_email_messages(self) -&gt; None:
        # build dummy messages for message notification email reply
        # have Hamlet send a message to stream Denmark, that Othello
        # will receive a message notification email about.
        # Othello will reply via email.
        # Hamlet will see the message in the stream.
        self.subscribe(self.example_user("hamlet"), "Denmark")
        self.subscribe(self.example_user("othello"), "Denmark")
        self.login("hamlet")
        result = self.client_post(
            "/json/messages",
            {
                "type": "stream",
                "topic": "test topic",
                "content": "test_receive_missed_stream_message_email_messages",
                "to": "Denmark",
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        usermessage = most_recent_usermessage(user_profile)

        mm_address = create_missed_message_address(user_profile, usermessage.message)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        process_message(incoming_valid_message)

        # confirm that Hamlet got the message
        user_profile = self.example_user("hamlet")
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "TestMissedMessageEmailMessages body")
        self.assertEqual(message.sender, self.example_user("othello"))
        self.assertEqual(message.recipient.type, Recipient.STREAM)
        self.assertEqual(message.recipient.id, usermessage.message.recipient.id)

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag617')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1023-1067
</a>
<div class="mid" id="frag617" style="display:none"><pre>
    def test_missed_stream_message_email_response_tracks_topic_change(self) -&gt; None:
        self.subscribe(self.example_user("hamlet"), "Denmark")
        self.subscribe(self.example_user("othello"), "Denmark")
        self.login("hamlet")
        result = self.client_post(
            "/json/messages",
            {
                "type": "stream",
                "topic": "test topic",
                "content": "test_receive_missed_stream_message_email_messages",
                "to": "Denmark",
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        usermessage = most_recent_usermessage(user_profile)

        mm_address = create_missed_message_address(user_profile, usermessage.message)

        # The mm address has been generated, now we change the topic of the message and see
        # if the response to the mm address will be correctly posted with the updated topic.
        usermessage.message.subject = "updated topic"
        usermessage.message.save(update_fields=["subject"])

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        process_message(incoming_valid_message)

        # confirm that Hamlet got the message
        user_profile = self.example_user("hamlet")
        message = most_recent_message(user_profile)

        self.assertEqual(message.subject, "updated topic")
        self.assertEqual(message.content, "TestMissedMessageEmailMessages body")
        self.assertEqual(message.sender, self.example_user("othello"))
        self.assertEqual(message.recipient.type, Recipient.STREAM)
        self.assertEqual(message.recipient.id, usermessage.message.recipient.id)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag620')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1140-1174
</a>
<div class="mid" id="frag620" style="display:none"><pre>
    def test_missed_message_email_multiple_responses(self) -&gt; None:
        self.subscribe(self.example_user("hamlet"), "Denmark")
        self.subscribe(self.example_user("othello"), "Denmark")
        self.login("hamlet")

        result = self.client_post(
            "/json/messages",
            {
                "type": "stream",
                "topic": "test topic",
                "content": "test_receive_missed_stream_message_email_messages",
                "to": "Denmark",
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        message = most_recent_message(user_profile)

        mm_address = create_missed_message_address(user_profile, message)
        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        for i in range(0, MissedMessageEmailAddress.ALLOWED_USES):
            process_missed_message(mm_address, incoming_valid_message)

        with self.assertRaises(ZulipEmailForwardError):
            process_missed_message(mm_address, incoming_valid_message)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag618')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1068-1103
</a>
<div class="mid" id="frag618" style="display:none"><pre>
    def test_missed_message_email_response_from_deactivated_user(self) -&gt; None:
        self.subscribe(self.example_user("hamlet"), "Denmark")
        self.subscribe(self.example_user("othello"), "Denmark")
        self.login("hamlet")
        result = self.client_post(
            "/json/messages",
            {
                "type": "stream",
                "topic": "test topic",
                "content": "test_receive_missed_stream_message_email_messages",
                "to": "Denmark",
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        message = most_recent_message(user_profile)

        mm_address = create_missed_message_address(user_profile, message)

        do_deactivate_user(user_profile, acting_user=None)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        initial_last_message = self.get_last_message()
        process_message(incoming_valid_message)

        # Since othello is deactivated, his message shouldn't be posted:
        self.assertEqual(initial_last_message, self.get_last_message())

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag619')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1104-1139
</a>
<div class="mid" id="frag619" style="display:none"><pre>
    def test_missed_message_email_response_from_deactivated_realm(self) -&gt; None:
        self.subscribe(self.example_user("hamlet"), "Denmark")
        self.subscribe(self.example_user("othello"), "Denmark")
        self.login("hamlet")
        result = self.client_post(
            "/json/messages",
            {
                "type": "stream",
                "topic": "test topic",
                "content": "test_receive_missed_stream_message_email_messages",
                "to": "Denmark",
            },
        )
        self.assert_json_success(result)

        user_profile = self.example_user("othello")
        message = most_recent_message(user_profile)

        mm_address = create_missed_message_address(user_profile, message)

        do_deactivate_realm(user_profile.realm, acting_user=None)

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content("TestMissedMessageEmailMessages body")

        incoming_valid_message["Subject"] = "TestMissedMessageEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = mm_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        initial_last_message = self.get_last_message()
        process_message(incoming_valid_message)

        # Since othello's realm is deactivated, his message shouldn't be posted:
        self.assertEqual(initial_last_message, self.get_last_message())

</pre></div>
</td>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 16:</b> &nbsp; 2 fragments, nominal size 21 lines, similarity 90%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag624')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1214-1251
</a>
<div class="mid" id="frag624" style="display:none"><pre>
    def test_reply_is_extracted_from_plain(self) -&gt; None:

        # build dummy messages for stream
        # test valid incoming stream message is processed properly
        self.login("hamlet")
        user_profile = self.example_user("hamlet")
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        text = """Reply

        -----Original Message-----

        Quote"""

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content(text)

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "Reply")

        # Don't extract if Subject indicates the email has been forwarded into the mirror:
        del incoming_valid_message["Subject"]
        incoming_valid_message["Subject"] = "FWD: TestStreamEmailMessages subject"
        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)
        self.assertEqual(message.content, text)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag625')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_email_mirror.py: 1252-1303
</a>
<div class="mid" id="frag625" style="display:none"><pre>
    def test_reply_is_extracted_from_html(self) -&gt; None:

        # build dummy messages for stream
        # test valid incoming stream message is processed properly
        self.login("hamlet")
        user_profile = self.example_user("hamlet")
        self.subscribe(user_profile, "Denmark")
        stream = get_stream("Denmark", user_profile.realm)

        stream_to_address = encode_email_address(stream)
        html = """
        &lt;html&gt;
            &lt;body&gt;
                &lt;p&gt;Reply&lt;/p&gt;
                &lt;blockquote&gt;

                    &lt;div&gt;
                        On 11-Apr-2011, at 6:54 PM, Bob &amp;lt;bob@example.com&amp;gt; wrote:
                    &lt;/div&gt;

                    &lt;div&gt;
                        Quote
                    &lt;/div&gt;

                &lt;/blockquote&gt;
            &lt;/body&gt;
        &lt;/html&gt;
        """

        incoming_valid_message = EmailMessage()
        incoming_valid_message.set_content(html, subtype="html")

        incoming_valid_message["Subject"] = "TestStreamEmailMessages subject"
        incoming_valid_message["From"] = user_profile.delivery_email
        incoming_valid_message["To"] = stream_to_address
        incoming_valid_message["Reply-to"] = user_profile.delivery_email

        process_message(incoming_valid_message)

        # Hamlet is subscribed to this stream so should see the email message from Othello.
        message = most_recent_message(user_profile)

        self.assertEqual(message.content, "Reply")

        # Don't extract if Subject indicates the email has been forwarded into the mirror:
        del incoming_valid_message["Subject"]
        incoming_valid_message["Subject"] = "FWD: TestStreamEmailMessages subject"
        process_message(incoming_valid_message)
        message = most_recent_message(user_profile)
        self.assertEqual(message.content, convert_html_to_markdown(html))


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 17:</b> &nbsp; 2 fragments, nominal size 12 lines, similarity 81%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag681')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_realm_playgrounds.py: 7-24
</a>
<div class="mid" id="frag681" style="display:none"><pre>
    def test_create_one_playground_entry(self) -&gt; None:
        iago = self.example_user("iago")

        payload = {
            "name": "Python playground",
            "pygments_language": "Python",
            "url_prefix": "https://python.example.com",
        }
        # Now send a POST request to the API endpoint.
        resp = self.api_post(iago, "/json/realm/playgrounds", payload)
        self.assert_json_success(resp)

        # Check if the actual object exists
        realm = get_realm("zulip")
        self.assertTrue(
            RealmPlayground.objects.filter(realm=realm, name="Python playground").exists()
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag684')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_realm_playgrounds.py: 68-83
</a>
<div class="mid" id="frag684" style="display:none"><pre>
    def test_create_already_existing_playground(self) -&gt; None:
        iago = self.example_user("iago")

        payload = {
            "name": "Python playground",
            "pygments_language": "Python",
            "url_prefix": "https://python.example.com",
        }
        resp = self.api_post(iago, "/json/realm/playgrounds", payload)
        self.assert_json_success(resp)

        resp = self.api_post(iago, "/json/realm/playgrounds", payload)
        self.assert_json_error(
            resp, "Realm playground with this Realm, Pygments language and Name already exists."
        )

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 18:</b> &nbsp; 4 fragments, nominal size 12 lines, similarity 75%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag689')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_zcommand.py: 24-38
</a>
<div class="mid" id="frag689" style="display:none"><pre>
    def test_night_zcommand(self) -&gt; None:
        self.login("hamlet")
        user = self.example_user("hamlet")
        user.color_scheme = UserProfile.COLOR_SCHEME_LIGHT
        user.save()

        payload = dict(command="/night")
        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assertIn("Changed to dark theme", result.json()["msg"])

        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assertIn("still in dark theme", result.json()["msg"])

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag690')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_zcommand.py: 39-53
</a>
<div class="mid" id="frag690" style="display:none"><pre>
    def test_day_zcommand(self) -&gt; None:
        self.login("hamlet")
        user = self.example_user("hamlet")
        user.color_scheme = UserProfile.COLOR_SCHEME_NIGHT
        user.save()

        payload = dict(command="/day")
        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assertIn("Changed to light theme", result.json()["msg"])

        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assertIn("still in light theme", result.json()["msg"])

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag691')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_zcommand.py: 54-68
</a>
<div class="mid" id="frag691" style="display:none"><pre>
    def test_fluid_zcommand(self) -&gt; None:
        self.login("hamlet")
        user = self.example_user("hamlet")
        user.fluid_layout_width = False
        user.save()

        payload = dict(command="/fluid-width")
        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assert_in_response("Changed to fluid-width mode!", result)

        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assert_in_response("You are still in fluid width mode", result)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag692')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_zcommand.py: 69-82
</a>
<div class="mid" id="frag692" style="display:none"><pre>
    def test_fixed_zcommand(self) -&gt; None:
        self.login("hamlet")
        user = self.example_user("hamlet")
        user.fluid_layout_width = True
        user.save()

        payload = dict(command="/fixed-width")
        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assert_in_response("Changed to fixed-width mode!", result)

        result = self.client_post("/json/zcommand", payload)
        self.assert_json_success(result)
        self.assert_in_response("You are still in fixed width mode", result)
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 19:</b> &nbsp; 9 fragments, nominal size 10 lines, similarity 90%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag695')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 35-47
</a>
<div class="mid" id="frag695" style="display:none"><pre>
    def test_response_to_pm_for_app(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["app", "Apps"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "You can [download](/apps) the [mobile and desktop apps](/apps). "
                "Zulip also works great in a browser."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag703')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 152-165
</a>
<div class="mid" id="frag703" style="display:none"><pre>
    def test_response_to_pm_for_undefined(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["Hello", "HAHAHA", "OKOK", "LalulaLapas"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "I’m sorry, I did not understand your message. Please try one of the following commands: "
                "`apps`, `profile`, `theme`, `streams`, "
                "`topics`, `message formatting`, `keyboard shortcuts`, `help`."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag701')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 120-135
</a>
<div class="mid" id="frag701" style="display:none"><pre>
    def test_response_to_pm_for_formatting(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["message formatting", "Formatting"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "Zulip uses [Markdown](/help/format-your-message-using-markdown), "
                "an intuitive format for **bold**, *italics*, bulleted lists, and more. "
                "Click [here](#message-formatting) for a cheat sheet.\n\n"
                "Check out our [messaging tips](/help/messaging-tips) to learn about emoji reactions, "
                "code blocks and much more!"
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag699')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 91-105
</a>
<div class="mid" id="frag699" style="display:none"><pre>
    def test_response_to_pm_for_topic(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["Topics", "topics"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "In Zulip, topics [tell you what a message is about](/help/streams-and-topics). "
                "They are light-weight subjects, very similar to the subject line of an email.\n\n"
                "Check out [Recent topics](#recent_topics) to see what's happening! "
                'You can return to this conversation by clicking "Private messages" in the upper left.'
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag698')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 77-90
</a>
<div class="mid" id="frag698" style="display:none"><pre>
    def test_response_to_pm_for_stream(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["Streams", "streams", "channels"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "In Zulip, streams [determine who gets a message](/help/streams-and-topics). "
                "They are similar to channels in other chat apps.\n\n"
                "[Browse and subscribe to streams](#streams/all)."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag700')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 106-119
</a>
<div class="mid" id="frag700" style="display:none"><pre>
    def test_response_to_pm_for_shortcuts(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["Keyboard shortcuts", "shortcuts", "Shortcuts"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "Zulip's [keyboard shortcuts](#keyboard-shortcuts) "
                "let you navigate the app quickly and efficiently.\n\n"
                "Press `?` any time to see a [cheat sheet](#keyboard-shortcuts)."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag696')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 48-61
</a>
<div class="mid" id="frag696" style="display:none"><pre>
    def test_response_to_pm_for_edit(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["profile", "Profile"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "Go to [Profile settings](#settings/profile) "
                "to add a [profile picture](/help/change-your-profile-picture) "
                "and edit your [profile information](/help/edit-your-profile)."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag697')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 62-76
</a>
<div class="mid" id="frag697" style="display:none"><pre>
    def test_response_to_pm_for_theme(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["theme", "Theme"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "Go to [Display settings](#settings/display-settings) "
                "to [switch between the light and dark themes](/help/dark-theme), "
                "[pick your favorite emoji theme](/help/emoji-and-emoticons#change-your-emoji-set), "
                "[change your language](/help/change-your-language), and make other tweaks to your Zulip experience."
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag702')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_tutorial.py: 136-151
</a>
<div class="mid" id="frag702" style="display:none"><pre>
    def test_response_to_pm_for_help(self) -&gt; None:
        user = self.example_user("hamlet")
        bot = get_system_bot(settings.WELCOME_BOT, user.realm_id)
        messages = ["help", "Help", "?"]
        self.login_user(user)
        for content in messages:
            self.send_personal_message(user, bot, content)
            expected_response = (
                "Here are a few messages I understand: "
                "`apps`, `profile`, `theme`, "
                "`streams`, `topics`, `message formatting`, `keyboard shortcuts`.\n\n"
                "Check out our [Getting started guide](/help/getting-started-with-zulip), "
                "or browse the [Help center](/help/) to learn more!"
            )
            self.assertEqual(most_recent_message(user).content, expected_response)

</pre></div>
</td>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 20:</b> &nbsp; 2 fragments, nominal size 21 lines, similarity 76%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag746')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_integrations_dev_panel.py: 73-95
</a>
<div class="mid" id="frag746" style="display:none"><pre>
    def test_check_send_webhook_fixture_message_for_success_with_headers(self) -&gt; None:
        bot = get_user("webhook-bot@zulip.com", self.zulip_realm)
        url = f"/api/v1/external/github?api_key={bot.api_key}&amp;stream=Denmark&amp;topic=GitHub notifications"
        target_url = "/devtools/integrations/check_send_webhook_fixture_message"
        with open("zerver/webhooks/github/fixtures/ping__organization.json") as f:
            body = f.read()

        data = {
            "url": url,
            "body": body,
            "custom_headers": orjson.dumps({"X_GITHUB_EVENT": "ping"}).decode(),
            "is_json": "true",
        }

        response = self.client_post(target_url, data)
        self.assertEqual(response.status_code, 200)

        latest_msg = Message.objects.latest("id")
        expected_message = "GitHub webhook has been successfully configured by eeshangarg."
        self.assertEqual(latest_msg.content, expected_message)
        self.assertEqual(Stream.objects.get(id=latest_msg.recipient.type_id).name, "Denmark")
        self.assertEqual(latest_msg.topic_name(), "GitHub notifications")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag747')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_integrations_dev_panel.py: 96-122
</a>
<div class="mid" id="frag747" style="display:none"><pre>
    def test_check_send_webhook_fixture_message_for_success_with_headers_and_non_json_fixtures(
        self,
    ) -&gt; None:
        bot = get_user("webhook-bot@zulip.com", self.zulip_realm)
        url = f"/api/v1/external/wordpress?api_key={bot.api_key}&amp;stream=Denmark&amp;topic=WordPress notifications"
        target_url = "/devtools/integrations/check_send_webhook_fixture_message"
        with open("zerver/webhooks/wordpress/fixtures/publish_post_no_data_provided.txt") as f:
            body = f.read()

        data = {
            "url": url,
            "body": body,
            "custom_headers": orjson.dumps(
                {"Content-Type": "application/x-www-form-urlencoded"}
            ).decode(),
            "is_json": "false",
        }

        response = self.client_post(target_url, data)
        self.assertEqual(response.status_code, 200)

        latest_msg = Message.objects.latest("id")
        expected_message = "New post published:\n* [New WordPress post](WordPress post URL)"
        self.assertEqual(latest_msg.content, expected_message)
        self.assertEqual(Stream.objects.get(id=latest_msg.recipient.type_id).name, "Denmark")
        self.assertEqual(latest_msg.topic_name(), "WordPress notifications")

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 21:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 77%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag756')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_templates.py: 23-94
</a>
<div class="mid" id="frag756" style="display:none"><pre>
    def test_markdown_tabbed_sections_extension(self) -&gt; None:
        template = get_template("tests/test_markdown.html")
        context = {
            "markdown_test_file": "zerver/tests/markdown/test_tabbed_sections.md",
        }
        content = template.render(context)
        content_sans_whitespace = content.replace(" ", "").replace("\n", "")

        # Note that the expected HTML has a lot of stray &lt;p&gt; tags. This is a
        # consequence of how the Markdown renderer converts newlines to HTML
        # and how elements are delimited by newlines and so forth. However,
        # stray &lt;p&gt; tags are usually matched with closing tags by HTML renderers
        # so this doesn't affect the final rendered UI in any visible way.
        expected_html = """
header

&lt;h1 id="heading"&gt;Heading&lt;/h1&gt;
&lt;p&gt;
  &lt;div class="code-section has-tabs" markdown="1"&gt;
    &lt;ul class="nav"&gt;
      &lt;li data-language="ios" tabindex="0"&gt;iOS&lt;/li&gt;
      &lt;li data-language="desktop-web" tabindex="0"&gt;Desktop/Web&lt;/li&gt;
    &lt;/ul&gt;
    &lt;div class="blocks"&gt;
      &lt;div data-language="ios" markdown="1"&gt;&lt;/p&gt;
        &lt;p&gt;iOS instructions&lt;/p&gt;
      &lt;p&gt;&lt;/div&gt;
      &lt;div data-language="desktop-web" markdown="1"&gt;&lt;/p&gt;
        &lt;p&gt;Desktop/browser instructions&lt;/p&gt;
      &lt;p&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/p&gt;

&lt;h2 id="heading-2"&gt;Heading 2&lt;/h2&gt;
&lt;p&gt;
  &lt;div class="code-section has-tabs" markdown="1"&gt;
    &lt;ul class="nav"&gt;
      &lt;li data-language="desktop-web" tabindex="0"&gt;Desktop/Web&lt;/li&gt;
      &lt;li data-language="android" tabindex="0"&gt;Android&lt;/li&gt;
    &lt;/ul&gt;
    &lt;div class="blocks"&gt;
      &lt;div data-language="desktop-web" markdown="1"&gt;&lt;/p&gt;
        &lt;p&gt;Desktop/browser instructions&lt;/p&gt;
      &lt;p&gt;&lt;/div&gt;
      &lt;div data-language="android" markdown="1"&gt;&lt;/p&gt;
        &lt;p&gt;Android instructions&lt;/p&gt;
      &lt;p&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/p&gt;

&lt;h2 id="heading-3"&gt;Heading 3&lt;/h2&gt;
&lt;p&gt;
  &lt;div class="code-section no-tabs" markdown="1"&gt;
    &lt;ul class="nav"&gt;
      &lt;li data-language="instructions-for-all-platforms" tabindex="0"&gt;Instructions for all platforms&lt;/li&gt;
    &lt;/ul&gt;
    &lt;div class="blocks"&gt;
      &lt;div data-language="instructions-for-all-platforms" markdown="1"&gt;&lt;/p&gt;
        &lt;p&gt;Instructions for all platforms&lt;/p&gt;
      &lt;p&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/p&gt;

footer
"""

        expected_html_sans_whitespace = expected_html.replace(" ", "").replace("\n", "")
        self.assertEqual(content_sans_whitespace, expected_html_sans_whitespace)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag758')" href="javascript:;">
zulip-5.0-rc1/zerver/tests/test_templates.py: 104-120
</a>
<div class="mid" id="frag758" style="display:none"><pre>
    def test_markdown_nested_code_blocks(self) -&gt; None:
        template = get_template("tests/test_markdown.html")
        context = {
            "markdown_test_file": "zerver/tests/markdown/test_nested_code_blocks.md",
        }
        content = template.render(context)

        content_sans_whitespace = content.replace(" ", "").replace("\n", "")
        expected = (
            'header&lt;h1id="this-is-a-heading"&gt;Thisisaheading.&lt;/h1&gt;&lt;ol&gt;'
            '&lt;li&gt;&lt;p&gt;Alistitemwithanindentedcodeblock:&lt;/p&gt;&lt;divclass="codehilite"&gt;'
            "&lt;pre&gt;indentedcodeblockwithmultiplelines&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ol&gt;"
            '&lt;divclass="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;'
            "non-indentedcodeblockwithmultiplelines&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;footer"
        )
        self.assertEqual(content_sans_whitespace, expected)

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 22:</b> &nbsp; 2 fragments, nominal size 16 lines, similarity 87%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag808')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/lidarr/view.py: 118-133
</a>
<div class="mid" id="frag808" style="display:none"><pre>
def get_body_for_http_request(payload: Dict[str, Any]) -&gt; str:
    if payload["eventType"] == "Test":
        return get_setup_webhook_message("Lidarr")
    elif payload["eventType"] == "Grab":
        return get_body_for_album_grabbed_event(payload)
    elif payload["eventType"] == "Rename":
        return get_body_for_tracks_renamed_event(payload)
    elif payload["eventType"] == "Retag":
        return get_body_for_tracks_retagged_event(payload)
    elif payload["eventType"] == "Download" and "isUpgrade" in payload:
        if payload["isUpgrade"]:
            return get_body_for_tracks_imported_upgrade_event(payload)
        else:
            return get_body_for_tracks_imported_event(payload)
    else:
        raise UnsupportedWebhookEventType(payload["eventType"])
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1035')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/radarr/view.py: 78-93
</a>
<div class="mid" id="frag1035" style="display:none"><pre>
def get_body_for_http_request(payload: Dict[str, Any]) -&gt; str:
    if payload["eventType"] == "Test":
        return get_setup_webhook_message("Radarr")
    elif payload["eventType"] == "Health":
        return get_body_for_health_check_event(payload)
    elif payload["eventType"] == "Rename":
        return get_body_for_movie_renamed_event(payload)
    elif payload["eventType"] == "Download" and "isUpgrade" in payload:
        if payload["isUpgrade"]:
            return get_body_for_movie_imported_upgrade_event(payload)
        else:
            return get_body_for_movie_imported_event(payload)
    elif payload["eventType"] == "Grab":
        return get_body_for_movie_grabbed_event(payload)
    else:
        raise UnsupportedWebhookEventType(payload["eventType"])
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 23:</b> &nbsp; 2 fragments, nominal size 18 lines, similarity 83%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag817')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/sonarqube/view.py: 66-90
</a>
<div class="mid" id="frag817" style="display:none"><pre>
def render_body_with_branch(payload: Mapping[str, Any]) -&gt; str:
    project_name = payload["project"]["name"]
    project_url = payload["project"]["url"]
    quality_gate_status = payload["qualityGate"]["status"].lower()
    if quality_gate_status == "ok":
        quality_gate_status = "success"
    else:
        quality_gate_status = "error"
    branch = payload["branch"]["name"]

    conditions = payload["qualityGate"]["conditions"]
    conditions = parse_conditions(conditions)

    if not conditions:
        return MESSAGE_WITH_BRANCH_AND_WITHOUT_CONDITIONS.format(
            project_name, project_url, branch, quality_gate_status
        )
    msg = MESSAGE_WITH_BRANCH_AND_CONDITIONS.format(
        project_name, project_url, branch, quality_gate_status
    )
    msg += conditions

    return msg


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag818')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/sonarqube/view.py: 91-113
</a>
<div class="mid" id="frag818" style="display:none"><pre>
def render_body_without_branch(payload: Mapping[str, Any]) -&gt; str:
    project_name = payload["project"]["name"]
    project_url = payload["project"]["url"]
    quality_gate_status = payload["qualityGate"]["status"].lower()
    if quality_gate_status == "ok":
        quality_gate_status = "success"
    else:
        quality_gate_status = "error"
    conditions = payload["qualityGate"]["conditions"]
    conditions = parse_conditions(conditions)

    if not conditions:
        return MESSAGE_WITHOUT_BRANCH_AND_CONDITIONS.format(
            project_name, project_url, quality_gate_status
        )
    msg = MESSAGE_WITHOUT_BRANCH_AND_WITH_CONDITIONS.format(
        project_name, project_url, quality_gate_status
    )
    msg += conditions

    return msg


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 24:</b> &nbsp; 48 fragments, nominal size 10 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag837')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/beanstalk/tests.py: 31-45
</a>
<div class="mid" id="frag837" style="display:none"><pre>
    def test_git_multiple_committers(self) -&gt; None:
        expected_topic = "work-test / master"
        expected_message = """Leo Franchi [pushed](http://lfranchi-svn.beanstalkapp.com/work-test) 3 commits to branch master. Commits by Leo Franchi (2) and Tomasz Kolek (1).

* Added new file ([edf529c](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/edf529c7))
* Filled in new file with some stuff ([c2a191b](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/c2a191b9))
* More work to fix some bugs ([2009815](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/20098158))"""
        self.api_stream_message(
            self.test_user,
            "git_multiple_committers",
            expected_topic,
            expected_message,
            content_type=None,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1420')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/heroku/tests.py: 24-47
</a>
<div class="mid" id="frag1420" style="display:none"><pre>
    def test_deployment_multiple_commits(self) -&gt; None:
        expected_topic = "sample-project"
        expected_message = """user@example.com deployed version 3eb5f44 of \
[sample-project](http://sample-project.herokuapp.com)
``` quote
  * Example User: Test commit for Deploy Hook
  * Example User: Second test commit for Deploy Hook 2
```"""

        expected_message = """
user@example.com deployed version 3eb5f44 of [sample-project](http://sample-project.herokuapp.com):

``` quote
  * Example User: Test commit for Deploy Hook
  * Example User: Second test commit for Deploy Hook 2
```
""".strip()
        self.check_webhook(
            "deploy_multiple_commits",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag860')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/librato/tests.py: 29-39
</a>
<div class="mid" id="frag860" style="display:none"><pre>
    def test_alert_message_with_custom_topic(self) -&gt; None:
        custom_topic = "custom_name"
        self.url = self.build_webhook_url(topic=custom_topic)
        expected_message = "Alert [alert_name](https://metrics.librato.com/alerts#/6294535) has triggered! [Reaction steps](http://www.google.pl):\n * Metric `librato.cpu.percent.idle`, sum was below 44 by 300s, recorded at 2016-03-31 09:11:42 UTC.\n * Metric `librato.swap.swap.cached`, average was absent  by 300s, recorded at 2016-03-31 09:11:42 UTC.\n * Metric `librato.swap.swap.cached`, derivative was above 9 by 300s, recorded at 2016-03-31 09:11:42 UTC."
        self.check_webhook(
            "alert",
            custom_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1678')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/helloworld/tests.py: 64-75
</a>
<div class="mid" id="frag1678" style="display:none"><pre>
    def test_custom_topic(self) -&gt; None:
        # Note that this is really just a test for check_send_webhook_message
        expected_topic = "Custom Topic"
        self.url = self.build_webhook_url(topic=expected_topic)
        expected_message = "Hello! I am happy to be here! :smile:\nThe Wikipedia featured article for today is **[Goodbye](https://en.wikipedia.org/wiki/Goodbye)**"

        self.check_webhook(
            "goodbye",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1179')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 214-224
</a>
<div class="mid" id="frag1179" style="display:none"><pre>
    def test_bitbucket2_on_pull_request_comment_created_with_custom_topic_in_url(self) -&gt; None:
        self.url = self.build_webhook_url(topic="notifications")
        expected_topic = "notifications"
        expected_message = "Tomasz [commented](https://bitbucket.org/kolaszek/repository-name/pull-requests/3/_/diff#comment-20576503) on [PR #1 new commit](https://bitbucket.org/kolaszek/repository-name/pull-requests/3):\n\n~~~ quote\nComment1\n~~~"
        self.check_webhook(
            "pull_request_comment_action",
            expected_topic,
            expected_message,
            HTTP_X_EVENT_KEY="pullrequest:comment_created",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2028')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 66-77
</a>
<div class="mid" id="frag2028" style="display:none"><pre>
    def test_customer_created(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = (
            "[Customer](https://dashboard.stripe.com/customers/cus_00000000000000) created"
        )
        self.check_webhook(
            "customer_created",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1985')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/tests.py: 37-56
</a>
<div class="mid" id="frag1985" style="display:none"><pre>
    def test_status_change(self) -&gt; None:
        """
        Messages are generated when a ticket's status changes through
        Freshdesk's "Observer" service.
        """
        expected_topic = "#11: Test ticket subject ☃"
        expected_message = """
Requester Bob &lt;requester-bob@example.com&gt; updated [ticket #11](http://test1234zzz.freshdesk.com/helpdesk/tickets/11):

* **Status**: Resolved -&gt; Waiting on Customer
""".strip()

        self.api_stream_message(
            self.test_user,
            "status_changed",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2025')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 32-44
</a>
<div class="mid" id="frag2025" style="display:none"><pre>
    def test_charge_failed(self) -&gt; None:
        expected_topic = "charges"
        expected_message = (
            "[Charge](https://dashboard.stripe.com/charges/ch_00000000000000) for 1.00 AUD failed"
        )
        self.check_webhook(
            "charge_failed",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

    # Credit card charge
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1740')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/deskdotcom/tests.py: 19-31
</a>
<div class="mid" id="frag1740" style="display:none"><pre>
    def test_static_text_message(self) -&gt; None:

        expected_topic = "static text notification"
        expected_message = "This is a custom action."

        self.api_stream_message(
            self.test_user,
            "static_text",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1487')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gosquared/tests.py: 11-23
</a>
<div class="mid" id="frag1487" style="display:none"><pre>
    def test_traffic_message(self) -&gt; None:
        expected_topic = "GoSquared - requestb.in"
        expected_message = (
            "[requestb.in](https://www.gosquared.com/now/GSN-595854-T) has 33 visitors online."
        )

        self.check_webhook(
            "traffic_spike",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1181')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 234-244
</a>
<div class="mid" id="frag1181" style="display:none"><pre>
    def test_bitbucket2_on_pull_request_comment_updated_with_custom_topic_in_url(self) -&gt; None:
        self.url = self.build_webhook_url(topic="notifications")
        expected_topic = "notifications"
        expected_message = "Tomasz updated a [comment](https://bitbucket.org/kolaszek/repository-name/pull-requests/3/_/diff#comment-20576503) on [PR #1 new commit](https://bitbucket.org/kolaszek/repository-name/pull-requests/3):\n\n~~~ quote\nComment1\n~~~"
        self.check_webhook(
            "pull_request_comment_action",
            expected_topic,
            expected_message,
            HTTP_X_EVENT_KEY="pullrequest:comment_updated",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag841')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/beanstalk/tests.py: 85-98
</a>
<div class="mid" id="frag841" style="display:none"><pre>
    def test_git_more_than_limit(self) -&gt; None:
        commits_info = "* add some stuff ([e50508d](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/e50508df))\n"
        expected_topic = "work-test / master"
        expected_message = f"""Leo Franchi [pushed](http://lfranchi-svn.beanstalkapp.com/work-test) 50 commits to branch master.

{(commits_info * COMMITS_LIMIT)}[and {50 - COMMITS_LIMIT} more commit(s)]"""
        self.api_stream_message(
            self.test_user,
            "git_morethanlimitcommits",
            expected_topic,
            expected_message,
            content_type=None,
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1991')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/tests.py: 117-133
</a>
<div class="mid" id="frag1991" style="display:none"><pre>
    def test_inline_image(self) -&gt; None:
        """
        Freshdesk sends us descriptions as HTML, so we have to make the
        descriptions Zulip Markdown-friendly while still doing our best to
        preserve links and images.
        """
        expected_topic = "#12: Not enough ☃ guinea pigs"
        expected_message = """
Requester \u2603 Bob &lt;requester-bob@example.com&gt; created [ticket #12](http://test1234zzz.freshdesk.com/helpdesk/tickets/12):\n\n``` quote\nThere are too many cat pictures on the internet \u2603. We need more guinea pigs.\nExhibit 1:\n\n  \n\n[guinea_pig.png](http://cdn.freshdesk.com/data/helpdesk/attachments/production/12744808/original/guinea_pig.png)\n```\n\n* **Type**: Problem\n* **Priority**: Urgent\n* **Status**: Open
""".strip()
        self.api_stream_message(
            self.test_user,
            "inline_images",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag838')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/beanstalk/tests.py: 46-61
</a>
<div class="mid" id="frag838" style="display:none"><pre>
    def test_git_multiple_committers_filtered_by_branches(self) -&gt; None:
        self.url = self.build_webhook_url(branches="master,development")
        expected_topic = "work-test / master"
        expected_message = """Leo Franchi [pushed](http://lfranchi-svn.beanstalkapp.com/work-test) 3 commits to branch master. Commits by Leo Franchi (2) and Tomasz Kolek (1).

* Added new file ([edf529c](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/edf529c7))
* Filled in new file with some stuff ([c2a191b](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/c2a191b9))
* More work to fix some bugs ([2009815](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/20098158))"""
        self.api_stream_message(
            self.test_user,
            "git_multiple_committers",
            expected_topic,
            expected_message,
            content_type=None,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1119')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 149-167
</a>
<div class="mid" id="frag1119" style="display:none"><pre>
    def test_splunk_missing_raw(self) -&gt; None:

        self.url = self.build_webhook_url(topic="New Search Alert")

        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [sudo](http://example.com:8000/app/search/search?q=%7Cloadjob%20rt_scheduler__admin__search__sudo_at_1483557185_2.2%20%7C%20head%201%20%7C%20tail%201&amp;earliest=0&amp;latest=now)
* **Host**: myserver
* **Source**: `/var/log/auth.log`
* **Raw**: `Missing _raw`
""".strip()

        self.check_webhook(
            "missing_raw",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1112')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 10-30
</a>
<div class="mid" id="frag1112" style="display:none"><pre>
    def test_splunk_search_one_result(self) -&gt; None:
        self.url = self.build_webhook_url(topic="New Search Alert")

        # define the expected message contents
        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [sudo](http://example.com:8000/app/search/search?q=%7Cloadjob%20rt_scheduler__admin__search__sudo_at_1483557185_2.2%20%7C%20head%201%20%7C%20tail%201&amp;earliest=0&amp;latest=now)
* **Host**: myserver
* **Source**: `/var/log/auth.log`
* **Raw**: `Jan  4 11:14:32 myserver sudo: pam_unix(sudo:session): session closed for user root`
""".strip()

        # using fixture named splunk_search_one_result, execute this test
        self.check_webhook(
            "search_one_result",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2030')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 88-99
</a>
<div class="mid" id="frag2030" style="display:none"><pre>
    def test_customer_deleted(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = (
            "[Customer](https://dashboard.stripe.com/customers/cus_00000000000000) deleted"
        )
        self.check_webhook(
            "customer_deleted",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1375')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/front/tests.py: 96-111
</a>
<div class="mid" id="frag1375" style="display:none"><pre>
    def test_mention_all(self) -&gt; None:
        expected_topic = "cnv_keo696"
        expected_message = (
            "**Leela Turanga** left a comment:\n"
            "```quote\n@all Could someone else take this?\n```"
        )

        self.check_webhook(
            "mention_all",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

    # Scenario 2: Conversation starts from an inbound message.

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1369')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/front/tests.py: 25-40
</a>
<div class="mid" id="frag1369" style="display:none"><pre>
    def test_outbound_message(self) -&gt; None:
        expected_topic = "cnv_keo696"
        expected_message = (
            "[Outbound message](https://app.frontapp.com/open/msg_1176ie2) "
            "from **support@planet-express.com** "
            "to **calculon@momsbot.com**:\n"
            "```quote\n*Subject*: Your next delivery is on Epsilon 96Z\n```"
        )

        self.check_webhook(
            "outbound_message",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1174')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 165-175
</a>
<div class="mid" id="frag1174" style="display:none"><pre>
    def test_bitbucket2_on_pull_request_approved_with_custom_topic_in_url(self) -&gt; None:
        self.url = self.build_webhook_url(topic="notifications")
        expected_topic = "notifications"
        expected_message = "Tomasz approved [PR #1 new commit](https://bitbucket.org/kolaszek/repository-name/pull-requests/1)."
        self.check_webhook(
            "pull_request_approved_or_unapproved",
            expected_topic,
            expected_message,
            HTTP_X_EVENT_KEY="pullrequest:approved",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag863')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/librato/tests.py: 60-70
</a>
<div class="mid" id="frag863" style="display:none"><pre>
    def test_snapshot(self) -&gt; None:
        self.IS_ATTACHMENT = True
        expected_topic = "Snapshots"
        expected_message = "**Hamlet** sent a [snapshot](http://snapshots.librato.com/chart/nr5l3n0c-82162.png) of [metric](https://metrics.librato.com/s/spaces/167315/explore/1731491?duration=72039&amp;end_time=1460569409)."
        self.check_webhook(
            "snapshot",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
        self.IS_ATTACHMENT = False
</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1741')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/deskdotcom/tests.py: 32-47
</a>
<div class="mid" id="frag1741" style="display:none"><pre>
    def test_case_updated_message(self) -&gt; None:
        expected_topic = "case updated notification"
        expected_message = (
            "Case 2 updated. "
            "Link: &lt;a href='https://deskdotcomtest.desk.com/web/agent/case/2'&gt;"
            "I have a question&lt;/a&gt;"
        )

        self.api_stream_message(
            self.test_user,
            "case_updated",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2037')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 180-191
</a>
<div class="mid" id="frag2037" style="display:none"><pre>
    def test_invoice_payment_failed(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = (
            "[Invoice](https://dashboard.stripe.com/invoices/in_00000000000000) payment failed"
        )
        self.check_webhook(
            "invoice_payment_failed",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1115')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 69-88
</a>
<div class="mid" id="frag1115" style="display:none"><pre>
    def test_splunk_missing_results_link(self) -&gt; None:

        self.url = self.build_webhook_url(topic="New Search Alert")

        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [sudo](Missing results_link)
* **Host**: myserver
* **Source**: `/var/log/auth.log`
* **Raw**: `Jan  4 11:14:32 myserver sudo: pam_unix(sudo:session): session closed for user root`
""".strip()

        self.check_webhook(
            "missing_results_link",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1984')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/tests.py: 11-36
</a>
<div class="mid" id="frag1984" style="display:none"><pre>
    def test_ticket_creation(self) -&gt; None:
        """
        Messages are generated on ticket creation through Freshdesk's
        "Dispatch'r" service.
        """
        expected_topic = "#11: Test ticket subject ☃"
        expected_message = """
Requester ☃ Bob &lt;requester-bob@example.com&gt; created [ticket #11](http://test1234zzz.freshdesk.com/helpdesk/tickets/11):

``` quote
Test ticket description ☃.
```

* **Type**: Incident
* **Priority**: High
* **Status**: Pending
""".strip()

        self.api_stream_message(
            self.test_user,
            "ticket_created",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1171')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 136-146
</a>
<div class="mid" id="frag1171" style="display:none"><pre>
    def test_bitbucket2_on_pull_request_created_with_custom_topic_in_url(self) -&gt; None:
        self.url = self.build_webhook_url(topic="notifications")
        expected_topic = "notifications"
        expected_message = "Tomasz created [PR #1 new commit](https://bitbucket.org/kolaszek/repository-name/pull-requests/1) (assigned to Tomasz Kolek) from `new-branch` to `master`:\n\n~~~ quote\ndescription\n~~~"
        self.check_webhook(
            "pull_request_created_or_updated",
            expected_topic,
            expected_message,
            HTTP_X_EVENT_KEY="pullrequest:created",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2034')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 144-156
</a>
<div class="mid" id="frag2034" style="display:none"><pre>
    def test_customer_subscription_trial_will_end(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = "[Subscription](https://dashboard.stripe.com/subscriptions/sub_00000000000000) trial will end in 3 days"
        # 3 days before the end of the trial, plus a little bit to make sure the rounding is working
        with mock.patch("time.time", return_value=1480892861 - 3 * 3600 * 24 + 100):
            # use fixture named stripe_customer_subscription_trial_will_end
            self.check_webhook(
                "customer_subscription_trial_will_end",
                expected_topic,
                expected_message,
                content_type="application/x-www-form-urlencoded",
            )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1381')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/front/tests.py: 177-190
</a>
<div class="mid" id="frag1381" style="display:none"><pre>
    def test_mention(self) -&gt; None:
        expected_topic = "cnv_keocka"
        expected_message = (
            "**Leela Turanga** left a comment:\n"
            "```quote\n@bender Could you take it from here?\n```"
        )

        self.check_webhook(
            "mention",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1743')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/deskdotcom/tests.py: 65-81
</a>
<div class="mid" id="frag1743" style="display:none"><pre>
    def test_unicode_text_japanese(self) -&gt; None:

        expected_topic = "case updated notification"
        expected_message = (
            "Case 2 updated. "
            "Link: &lt;a href='https://deskdotcomtest.desk.com/web/agent/case/2'&gt;"
            "私のホバークラフトは鰻でいっぱいです&lt;/a&gt;"
        )

        self.api_stream_message(
            self.test_user,
            "unicode_text_japanese",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag842')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/beanstalk/tests.py: 99-113
</a>
<div class="mid" id="frag842" style="display:none"><pre>
    def test_git_more_than_limit_filtered_by_branches(self) -&gt; None:
        self.url = self.build_webhook_url(branches="master,development")
        commits_info = "* add some stuff ([e50508d](http://lfranchi-svn.beanstalkapp.com/work-test/changesets/e50508df))\n"
        expected_topic = "work-test / master"
        expected_message = f"""Leo Franchi [pushed](http://lfranchi-svn.beanstalkapp.com/work-test) 50 commits to branch master.

{(commits_info * COMMITS_LIMIT)}[and {50 - COMMITS_LIMIT} more commit(s)]"""
        self.api_stream_message(
            self.test_user,
            "git_morethanlimitcommits",
            expected_topic,
            expected_message,
            content_type=None,
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1117')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 109-128
</a>
<div class="mid" id="frag1117" style="display:none"><pre>
    def test_splunk_missing_host(self) -&gt; None:

        self.url = self.build_webhook_url(topic="New Search Alert")

        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [sudo](http://example.com:8000/app/search/search?q=%7Cloadjob%20rt_scheduler__admin__search__sudo_at_1483557185_2.2%20%7C%20head%201%20%7C%20tail%201&amp;earliest=0&amp;latest=now)
* **Host**: Missing host
* **Source**: `/var/log/auth.log`
* **Raw**: `Jan  4 11:14:32 myserver sudo: pam_unix(sudo:session): session closed for user root`
""".strip()

        self.check_webhook(
            "missing_host",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1742')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/deskdotcom/tests.py: 48-64
</a>
<div class="mid" id="frag1742" style="display:none"><pre>
    def test_unicode_text_italian(self) -&gt; None:

        expected_topic = "case updated notification"
        expected_message = (
            "Case 2 updated. "
            "Link: &lt;a href='https://deskdotcomtest.desk.com/web/agent/case/2'&gt;"
            "Il mio hovercraft è pieno di anguille.&lt;/a&gt;"
        )

        self.api_stream_message(
            self.test_user,
            "unicode_text_italian",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2066')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/slack/tests.py: 20-32
</a>
<div class="mid" id="frag2066" style="display:none"><pre>
    def test_slack_channel_to_stream(self) -&gt; None:

        self.STREAM_NAME = "general"
        self.url = "{}{}".format(self.url, "&amp;channels_map_to_topics=0")
        expected_topic = "Message from Slack"
        expected_message = "**slack_user**: test"
        self.check_webhook(
            "message_info",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1118')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 129-148
</a>
<div class="mid" id="frag1118" style="display:none"><pre>
    def test_splunk_missing_source(self) -&gt; None:

        self.url = self.build_webhook_url(topic="New Search Alert")

        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [sudo](http://example.com:8000/app/search/search?q=%7Cloadjob%20rt_scheduler__admin__search__sudo_at_1483557185_2.2%20%7C%20head%201%20%7C%20tail%201&amp;earliest=0&amp;latest=now)
* **Host**: myserver
* **Source**: `Missing source`
* **Raw**: `Jan  4 11:14:32 myserver sudo: pam_unix(sudo:session): session closed for user root`
""".strip()

        self.check_webhook(
            "missing_source",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1376')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/front/tests.py: 112-127
</a>
<div class="mid" id="frag1376" style="display:none"><pre>
    def test_inbound_message(self) -&gt; None:
        expected_topic = "cnv_keocka"
        expected_message = (
            "[Inbound message](https://app.frontapp.com/open/msg_1176r8y) "
            "from **calculon@momsbot.com** "
            "to **support@planet-express.com**:\n"
            "```quote\n*Subject*: Being a robot is great, but...\n```"
        )

        self.check_webhook(
            "inbound_message",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1986')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/tests.py: 57-75
</a>
<div class="mid" id="frag1986" style="display:none"><pre>
    def test_priority_change(self) -&gt; None:
        """
        Messages are generated when a ticket's priority changes through
        Freshdesk's "Observer" service.
        """
        expected_topic = "#11: Test ticket subject"
        expected_message = """
Requester Bob &lt;requester-bob@example.com&gt; updated [ticket #11](http://test1234zzz.freshdesk.com/helpdesk/tickets/11):

* **Priority**: High -&gt; Low
""".strip()
        self.api_stream_message(
            self.test_user,
            "priority_changed",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2032')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 114-125
</a>
<div class="mid" id="frag2032" style="display:none"><pre>
    def test_customer_subscription_deleted(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = (
            "[Subscription](https://dashboard.stripe.com/subscriptions/sub_00000000000000) deleted"
        )
        self.check_webhook(
            "customer_subscription_deleted",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1379')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/front/tests.py: 151-165
</a>
<div class="mid" id="frag1379" style="display:none"><pre>
    def test_outbound_reply(self) -&gt; None:
        expected_topic = "cnv_keocka"
        expected_message = (
            "[Outbound reply](https://app.frontapp.com/open/msg_1176ryy) "
            "from **support@planet-express.com** "
            "to **calculon@momsbot.com**."
        )

        self.check_webhook(
            "outbound_reply",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1116')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/splunk/tests.py: 89-108
</a>
<div class="mid" id="frag1116" style="display:none"><pre>
    def test_splunk_missing_search_name(self) -&gt; None:

        self.url = self.build_webhook_url(topic="New Search Alert")

        expected_topic = "New Search Alert"
        expected_message = """
Splunk alert from saved search:
* **Search**: [Missing search_name](http://example.com:8000/app/search/search?q=%7Cloadjob%20rt_scheduler__admin__search__sudo_at_1483557185_2.2%20%7C%20head%201%20%7C%20tail%201&amp;earliest=0&amp;latest=now)
* **Host**: myserver
* **Source**: `/var/log/auth.log`
* **Raw**: `Jan  4 11:14:32 myserver sudo: pam_unix(sudo:session): session closed for user root`
""".strip()

        self.check_webhook(
            "missing_search_name",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1734')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/wordpress/tests.py: 58-71
</a>
<div class="mid" id="frag1734" style="display:none"><pre>
    def test_user_register(self) -&gt; None:

        expected_topic = "New Blog Users"
        expected_message = (
            "New blog user registered:\n* **Name**: test_user\n* **Email**: test_user@example.com"
        )

        self.check_webhook(
            "user_register",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag958')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/beeminder/tests.py: 12-26
</a>
<div class="mid" id="frag958" style="display:none"><pre>
    def test_beeminder_derail(self, time: MagicMock) -&gt; None:
        time.return_value = 1517739100  # 5.6 hours from fixture value
        expected_topic = "beekeeper"
        expected_message = """
You are going to derail from goal **gainweight** in **5.6 hours**. You need **+2 in 7 days (60)** to avoid derailing.
* Pledge: **0$** :relieved:
""".strip()

        self.check_webhook(
            "derail",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1147')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/delighted/tests.py: 26-47
</a>
<div class="mid" id="frag1147" style="display:none"><pre>
    def test_feedback_message_non_promoter(self) -&gt; None:
        expected_topic = "Survey response"
        expected_message = (
            "Great! You have new feedback.\n"
            "&gt;Score of 5/10 from paul_gravis@example.com"
            "\n&gt;Your service is slow, but nearly flawless! "
            "Keep up the good work!"
        )
        expected_message = """
Great! You have new feedback. Score of 5/10 from paul_gravis@example.com:

``` quote
Your service is slow, but nearly flawless! Keep up the good work!
```
""".strip()

        self.check_webhook(
            "survey_response_updated_non_promoter",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2035')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/stripe/tests.py: 157-169
</a>
<div class="mid" id="frag2035" style="display:none"><pre>
    def test_customer_updated__account_balance(self) -&gt; None:
        expected_topic = "cus_00000000000000"
        expected_message = (
            "[Customer](https://dashboard.stripe.com/customers/cus_00000000000000) updated"
            + "\n* Account balance is now 100"
        )
        self.check_webhook(
            "customer_updated__account_balance",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1801')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/thinkst/tests.py: 154-176
</a>
<div class="mid" id="frag1801" style="display:none"><pre>
    def test_canary_with_specific_topic(self) -&gt; None:
        self.url = self.build_webhook_url(topic="foo")
        expected_message = (
            "**:alert: Canary *0000000testnode* has been triggered!**\n\n"
            "This is a dummy incident.\n\n"
            "**Incident ID:** `aa875f255f94e3ffe40dc85cf1a8b1e0`\n"
            "**Kind:** Dummy Incident\n"
            "**Timestamp:** 2020-06-09 13:59:38 (UTC)\n"
            "**Canary IP:** `1.1.1.1`\n"
            "**Source IP:** `2.2.2.2`\n"
            "**Reverse DNS:** `attacker-ip.local`\n"
            "**Field1:** VALUE1\n"
            "**Field2:** VALUE2\n"
            "**Field3:** VALUE3"
        )

        self.check_webhook(
            "canary_dummy",
            "foo",
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1804')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/thinkst/tests.py: 234-260
</a>
<div class="mid" id="frag1804" style="display:none"><pre>
    def test_canarytoken_with_specific_topic(self) -&gt; None:
        self.url = self.build_webhook_url(topic="foo")
        expected_message = (
            "**:alert: Canarytoken *test document* has been triggered!**\n\n"
            "A MS Word .docx Document Canarytoken has been triggered over doc-msword "
            "by the source IP 1.1.1.1.\n\n"
            "**Incident ID:** `db6f9b5528c6c6c385cb3bb63f5949c8`\n"
            "**Token:** `dbwx4d68flwh2u5zku56nogu6`\n"
            "**Kind:** MS Word .docx Document\n"
            "**Timestamp:** 2020-07-20 14:40:15 (UTC)\n"
            "**Triggered:** 5 times\n"
            "**Accept:** `*/*`\n"
            "**Accept-Encoding:** gzip, deflate\n"
            "**Accept-Language:** en-gb\n"
            "**Background Context:** You have had 21 incidents from 1.1.1.1 "
            "previously.\n"
            "**Connection:** keep-alive\n"
            "**Dst Port:** 80\n"
            "**User-Agent:** Mozilla/4.0 (compatible; ms-office; MSOffice 16)"
        )

        self.check_webhook(
            "canarytoken_msword",
            "foo",
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
</tr><tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1813')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/canarytoken/tests.py: 39-54
</a>
<div class="mid" id="frag1813" style="display:none"><pre>
    def test_canarytoken_with_specific_topic(self) -&gt; None:
        self.url = self.build_webhook_url(topic="foo")
        expected_message = (
            "**:alert: Canarytoken has been triggered on 2020-06-09 14:04:47 "
            "(UTC)!**\n\n"
            "Canarytoken example \n\n"
            "[Manage this canarytoken]"
            "(https://canarytokens.org/manage?token=foo&amp;auth=bar)"
        )

        self.check_webhook(
            "canarytoken_real",
            "foo",
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1066')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/hellosign/tests.py: 39-53
</a>
<div class="mid" id="frag1066" style="display:none"><pre>
    def test_signatures_message_with_own_subject(self) -&gt; None:
        expected_topic = "Our own subject."
        self.url = self.build_webhook_url(topic=expected_topic)
        expected_message = (
            "The `NDA with Acme Co.` document is awaiting the signature of "
            "Jack, and was just signed by Jill."
        )
        self.check_webhook(
            "signatures_with_own_subject",
            expected_topic,
            expected_message,
            content_type=None,
            topic=expected_topic,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1650')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/appfollow/tests.py: 37-59
</a>
<div class="mid" id="frag1650" style="display:none"><pre>
    def test_reviews_with_topic(self) -&gt; None:
        # This temporary patch of URL_TEMPLATE is code smell but required due to the way
        # WebhookTestCase is built.
        original_url_template = self.URL_TEMPLATE
        self.URL_TEMPLATE = original_url_template + "&amp;topic=foo"
        self.url = self.build_webhook_url()
        expected_topic = "foo"
        expected_message = """Acme - Group chat
App Store, Acme Technologies, Inc.
★★★★★ United States
**Great for Information Management**
Acme enables me to manage the flow of information quite well. I only wish I could create and edit my Acme Post files in the iOS app.
*by* **Mr RESOLUTIONARY** *for v3.9*
[Permalink](http://appfollow.io/permalink) · [Add tag](http://watch.appfollow.io/add_tag)"""
        self.check_webhook(
            "review",
            expected_topic,
            expected_message,
            content_type="application/x-www-form-urlencoded",
        )
        self.URL_TEMPLATE = original_url_template


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 25:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag854')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/codeship/view.py: 26-38
</a>
<div class="mid" id="frag854" style="display:none"><pre>
def api_codeship_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: WildValue = REQ(argument_type="body", converter=to_wild_value),
) -&gt; HttpResponse:
    payload = payload["build"]
    subject = get_subject_for_http_request(payload)
    body = get_body_for_http_request(payload)

    check_send_webhook_message(request, user_profile, subject, body)
    return json_success(request)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2016')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshping/view.py: 24-38
</a>
<div class="mid" id="frag2016" style="display:none"><pre>
def api_freshping_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:

    body = get_body_for_http_request(payload)
    subject = get_subject_for_http_request(payload)

    check_send_webhook_message(
        request, user_profile, subject, body, payload["webhook_event_data"]["check_state_name"]
    )
    return json_success(request)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 26:</b> &nbsp; 3 fragments, nominal size 12 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1102')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshstatus/tests.py: 192-208
</a>
<div class="mid" id="frag1102" style="display:none"><pre>
    def test_freshstatus_invalid_payload_with_missing_data(self) -&gt; None:
        """
        Tests if invalid Freshstatus payloads are handled correctly
        """
        self.url = self.build_webhook_url()
        payload = self.get_body("freshstatus_invalid_payload_with_missing_data")
        result = self.client_post(self.url, payload, content_type="application/json")
        self.assert_json_error(result, "Invalid payload")

        expected_message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=self.test_user.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()

        msg = self.get_last_message()
        self.assertEqual(msg.content, expected_message)
        self.assertEqual(msg.recipient.type, Recipient.PERSONAL)
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1980')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/zabbix/tests.py: 20-36
</a>
<div class="mid" id="frag1980" style="display:none"><pre>
    def test_zabbix_invalid_payload_with_missing_data(self) -&gt; None:
        """
        Tests if invalid Zabbix payloads are handled correctly
        """
        self.url = self.build_webhook_url()
        payload = self.get_body("zabbix_invalid_payload_with_missing_data")
        result = self.client_post(self.url, payload, content_type="application/json")
        self.assert_json_error(result, "Invalid payload")

        expected_message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=self.test_user.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()

        msg = self.get_last_message()
        self.assertEqual(msg.content, expected_message)
        self.assertEqual(msg.recipient.type, Recipient.PERSONAL)
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1301')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/uptimerobot/tests.py: 31-47
</a>
<div class="mid" id="frag1301" style="display:none"><pre>
    def test_uptimerobot_invalid_payload_with_missing_data(self) -&gt; None:
        """
        Tests if invalid UptimeRobot payloads are handled correctly
        """
        self.url = self.build_webhook_url()
        payload = self.get_body("uptimerobot_invalid_payload_with_missing_data")
        result = self.client_post(self.url, payload, content_type="application/json")
        self.assert_json_error(result, "Invalid payload")

        expected_message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=self.test_user.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()

        msg = self.get_last_message()
        self.assertEqual(msg.content, expected_message)
        self.assertEqual(msg.recipient.type, Recipient.PERSONAL)
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 27:</b> &nbsp; 3 fragments, nominal size 19 lines, similarity 76%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1103')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshstatus/view.py: 81-104
</a>
<div class="mid" id="frag1103" style="display:none"><pre>
def api_freshstatus_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:

    try:
        body = get_body_for_http_request(payload)
        subject = get_subject_for_http_request(payload)
    except KeyError:
        message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=user_profile.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()
        send_rate_limited_pm_notification_to_bot_owner(user_profile, user_profile.realm, message)

        raise JsonableError(_("Invalid payload"))

    check_send_webhook_message(
        request, user_profile, subject, body, payload["event_data"]["event_type"]
    )
    return json_success(request)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1302')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/uptimerobot/view.py: 36-61
</a>
<div class="mid" id="frag1302" style="display:none"><pre>
def api_uptimerobot_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:
    if payload["alert_type_friendly_name"] == "Up":
        event = "up"
    elif payload["alert_type_friendly_name"] == "Down":
        event = "down"

    try:
        body = get_body_for_http_request(payload)
        subject = get_subject_for_http_request(payload)
    except KeyError:
        message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=user_profile.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()
        send_rate_limited_pm_notification_to_bot_owner(user_profile, user_profile.realm, message)

        raise JsonableError(_("Invalid payload"))

    check_send_webhook_message(request, user_profile, subject, body, event)
    return json_success(request)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1981')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/zabbix/view.py: 34-55
</a>
<div class="mid" id="frag1981" style="display:none"><pre>
def api_zabbix_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:

    try:
        body = get_body_for_http_request(payload)
        subject = get_subject_for_http_request(payload)
    except KeyError:
        message = MISCONFIGURED_PAYLOAD_ERROR_MESSAGE.format(
            bot_name=user_profile.full_name,
            support_email=FromAddress.SUPPORT,
        ).strip()
        send_rate_limited_pm_notification_to_bot_owner(user_profile, user_profile.realm, message)

        raise JsonableError(_("Invalid payload"))

    check_send_webhook_message(request, user_profile, subject, body)
    return json_success(request)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 28:</b> &nbsp; 3 fragments, nominal size 13 lines, similarity 71%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1123')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/homeassistant/view.py: 14-33
</a>
<div class="mid" id="frag1123" style="display:none"><pre>
def api_homeassistant_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, str] = REQ(argument_type="body"),
) -&gt; HttpResponse:

    # construct the body of the message
    body = payload["message"]

    # set the topic to the topic parameter, if given
    if "topic" in payload:
        topic = payload["topic"]
    else:
        topic = "homeassistant"

    # send the message
    check_send_webhook_message(request, user_profile, topic, body)

    # return json result
    return json_success(request)
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1367')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/flock/view.py: 15-31
</a>
<div class="mid" id="frag1367" style="display:none"><pre>
def api_flock_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:

    if len(payload["text"]) != 0:
        message_body = payload["text"]
    else:
        message_body = payload["notification"]

    topic = "Flock notifications"
    body = f"{message_body}"

    check_send_webhook_message(request, user_profile, topic, body)

    return json_success(request)
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1832')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/jotform/view.py: 15-31
</a>
<div class="mid" id="frag1832" style="display:none"><pre>
def api_jotform_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:
    topic = payload["formTitle"]
    submission_id = payload["submissionID"]
    fields_dict = list(payload["pretty"].split(", "))

    form_response = f"A new submission (ID {submission_id}) was received:\n"
    for field in fields_dict:
        form_response += f"* {field}\n"

    message = form_response.strip()

    check_send_webhook_message(request, user_profile, topic, message)
    return json_success(request)
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 29:</b> &nbsp; 5 fragments, nominal size 25 lines, similarity 84%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1186')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 277-306
</a>
<div class="mid" id="frag1186" style="display:none"><pre>
    def test_bitbucket2_on_push_more_than_one_tag_event(self) -&gt; None:
        expected_message = "Tomasz pushed tag [{name}](https://bitbucket.org/kolaszek/repository-name/commits/tag/{name})."

        self.subscribe(self.test_user, self.STREAM_NAME)
        payload = self.get_body("push_more_than_one_tag")

        msg = self.send_webhook_payload(
            self.test_user,
            self.url,
            payload,
            content_type="application/json",
            HTTP_X_EVENT_KEY="pullrequest:push",
        )

        msg = self.get_second_to_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC,
            content=expected_message.format(name="a"),
        )

        msg = self.get_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC,
            content=expected_message.format(name="b"),
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1291')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/updown/tests.py: 24-54
</a>
<div class="mid" id="frag1291" style="display:none"><pre>
    def test_updown_check_up_multiple_events(self) -&gt; None:
        topic_name = "https://updown.io"

        down_content = "Service is `down`. It returned a 500 error at 2016-02-07 13:11:43 UTC."
        up_content = "Service is `up` again after 1 second."

        self.subscribe(self.test_user, self.STREAM_NAME)
        payload = self.get_body("check_multiple_events")

        msg = self.send_webhook_payload(
            self.test_user,
            self.url,
            payload,
            content_type="application/json",
        )

        msg = self.get_second_to_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=topic_name,
            content=down_content,
        )

        msg = self.get_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=topic_name,
            content=up_content,
        )
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1188')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 335-364
</a>
<div class="mid" id="frag1188" style="display:none"><pre>
    def test_bitbucket2_on_more_than_one_push_event_filtered_by_branches(self) -&gt; None:
        self.url = self.build_webhook_url(branches="master,development")

        self.subscribe(self.test_user, self.STREAM_NAME)
        payload = self.get_body("more_than_one_push_event")

        msg = self.send_webhook_payload(
            self.test_user,
            self.url,
            payload,
            content_type="application/json",
            HTTP_X_EVENT_KEY="pullrequest:push",
        )

        msg = self.get_second_to_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC_BRANCH_EVENTS,
            content="Tomasz [pushed](https://bitbucket.org/kolaszek/repository-name/branch/master) 1 commit to branch master.\n\n* first commit ([84b96ad](https://bitbucket.org/kolaszek/repository-name/commits/84b96adc644a30fd6465b3d196369d880762afed))",
        )

        msg = self.get_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC,
            content="Tomasz pushed tag [a](https://bitbucket.org/kolaszek/repository-name/commits/tag/a).",
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1209')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket3/tests.py: 80-109
</a>
<div class="mid" id="frag1209" style="display:none"><pre>
    def test_push_update_multiple_branches(self) -&gt; None:
        branch1_content = """[hypro999](http://139.59.64.214:7990/users/hypro999) pushed to branch branch1. Head is now 3980c2be32a7e23c795741d5dc1a2eecb9b85d6d."""
        master_content = """[hypro999](http://139.59.64.214:7990/users/hypro999) pushed to branch master. Head is now fc43d13cff1abb28631196944ba4fc4ad06a2cf2."""

        self.subscribe(self.test_user, self.STREAM_NAME)
        payload = self.get_body("repo_push_update_multiple_branches")

        msg = self.send_webhook_payload(
            self.test_user,
            self.url,
            payload,
            content_type="application/json",
        )

        msg = self.get_second_to_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC_BRANCH_EVENTS.format(branch="branch1"),
            content=branch1_content,
        )

        msg = self.get_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC_BRANCH_EVENTS.format(branch="master"),
            content=master_content,
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1187')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/bitbucket2/tests.py: 307-334
</a>
<div class="mid" id="frag1187" style="display:none"><pre>
    def test_bitbucket2_on_more_than_one_push_event(self) -&gt; None:
        self.subscribe(self.test_user, self.STREAM_NAME)
        payload = self.get_body("more_than_one_push_event")

        msg = self.send_webhook_payload(
            self.test_user,
            self.url,
            payload,
            content_type="application/json",
            HTTP_X_EVENT_KEY="pullrequest:push",
        )

        msg = self.get_second_to_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC_BRANCH_EVENTS,
            content="Tomasz [pushed](https://bitbucket.org/kolaszek/repository-name/branch/master) 1 commit to branch master.\n\n* first commit ([84b96ad](https://bitbucket.org/kolaszek/repository-name/commits/84b96adc644a30fd6465b3d196369d880762afed))",
        )

        msg = self.get_last_message()
        self.assert_stream_message(
            message=msg,
            stream_name=self.STREAM_NAME,
            topic_name=TOPIC,
            content="Tomasz pushed tag [a](https://bitbucket.org/kolaszek/repository-name/commits/tag/a).",
        )

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 30:</b> &nbsp; 4 fragments, nominal size 31 lines, similarity 74%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1278')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/clubhouse/tests.py: 217-248
</a>
<div class="mid" id="frag1278" style="display:none"><pre>
    def test_story_update_add_github_multiple_pull_requests(
        self, check_send_webhook_message_mock: MagicMock
    ) -&gt; None:
        payload = self.get_body("story_update_add_github_multiple_pull_requests")
        self.client_post(self.url, payload, content_type="application/json")
        expected_message = "New GitHub PR [#2](https://github.com/PIG208/test-clubhouse/pull/2) opened for story [{name}]({url}) (Unscheduled -&gt; In Development)."
        request, user_profile = (
            check_send_webhook_message_mock.call_args_list[0][0][0],
            check_send_webhook_message_mock.call_args_list[0][0][1],
        )
        expected_list = [
            call(
                request,
                user_profile,
                "Story1",
                expected_message.format(
                    name="Story1", url="https://app.clubhouse.io/pig208/story/17"
                ),
                "pull-request_create",
            ),
            call(
                request,
                user_profile,
                "Story2",
                expected_message.format(
                    name="Story2", url="https://app.clubhouse.io/pig208/story/18"
                ),
                "pull-request_create",
            ),
        ]
        self.assertEqual(check_send_webhook_message_mock.call_args_list, expected_list)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1283')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/clubhouse/tests.py: 337-377
</a>
<div class="mid" id="frag1283" style="display:none"><pre>
    def test_story_update_batch_skip_removed_labels(
        self, check_send_webhook_message_mock: MagicMock
    ) -&gt; None:
        payload = self.get_body("story_update_everything_at_once_skip_removed_labels")
        self.client_post(self.url, payload, content_type="application/json")
        expected_message = "The story [{name}]({url}) was moved from Epic **epic** to **testeipc**, Project **Product Development** to **test2**, and changed from type **feature** to **bug** (In Development -&gt; Ready for Review)."
        request, user_profile = (
            check_send_webhook_message_mock.call_args_list[0][0][0],
            check_send_webhook_message_mock.call_args_list[0][0][1],
        )
        expected_list = [
            call(
                request,
                user_profile,
                "asd4",
                expected_message.format(
                    name="asd4", url="https://app.clubhouse.io/pig208/story/17"
                ),
                "story_update_batch",
            ),
            call(
                request,
                user_profile,
                "new1",
                expected_message.format(
                    name="new1", url="https://app.clubhouse.io/pig208/story/26"
                ),
                "story_update_batch",
            ),
            call(
                request,
                user_profile,
                "new2",
                expected_message.format(
                    name="new2", url="https://app.clubhouse.io/pig208/story/27"
                ),
                "story_update_batch",
            ),
        ]
        self.assertEqual(check_send_webhook_message_mock.call_args_list, expected_list)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1282')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/clubhouse/tests.py: 297-335
</a>
<div class="mid" id="frag1282" style="display:none"><pre>
    def test_story_update_batch(self, check_send_webhook_message_mock: MagicMock) -&gt; None:
        payload = self.get_body("story_update_everything_at_once")
        self.client_post(self.url, payload, content_type="application/json")
        expected_message = "The story [{name}]({url}) was moved from Epic **epic** to **testeipc**, Project **Product Development** to **test2**, and changed from type **feature** to **bug**, and added with the new label **low priority** (In Development -&gt; Ready for Review)."
        request, user_profile = (
            check_send_webhook_message_mock.call_args_list[0][0][0],
            check_send_webhook_message_mock.call_args_list[0][0][1],
        )
        expected_list = [
            call(
                request,
                user_profile,
                "asd4",
                expected_message.format(
                    name="asd4", url="https://app.clubhouse.io/pig208/story/17"
                ),
                "story_update_batch",
            ),
            call(
                request,
                user_profile,
                "new1",
                expected_message.format(
                    name="new1", url="https://app.clubhouse.io/pig208/story/26"
                ),
                "story_update_batch",
            ),
            call(
                request,
                user_profile,
                "new2",
                expected_message.format(
                    name="new2", url="https://app.clubhouse.io/pig208/story/27"
                ),
                "story_update_batch",
            ),
        ]
        self.assertEqual(check_send_webhook_message_mock.call_args_list, expected_list)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1280')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/clubhouse/tests.py: 258-289
</a>
<div class="mid" id="frag1280" style="display:none"><pre>
    def test_story_update_add_github_multiple_pull_requests_with_comment(
        self, check_send_webhook_message_mock: MagicMock
    ) -&gt; None:
        payload = self.get_body("story_update_add_github_multiple_pull_requests_with_comment")
        self.client_post(self.url, payload, content_type="application/json")
        expected_message = "Existing GitHub PR [#1](https://github.com/PIG208/test-clubhouse/pull/1) associated with story [{name}]({url}) (Unscheduled -&gt; In Development)."
        request, user_profile = (
            check_send_webhook_message_mock.call_args_list[0][0][0],
            check_send_webhook_message_mock.call_args_list[0][0][1],
        )
        expected_list = [
            call(
                request,
                user_profile,
                "new1",
                expected_message.format(
                    name="new1", url="https://app.clubhouse.io/pig208/story/26"
                ),
                "pull-request_comment",
            ),
            call(
                request,
                user_profile,
                "new2",
                expected_message.format(
                    name="new2", url="https://app.clubhouse.io/pig208/story/27"
                ),
                "pull-request_comment",
            ),
        ]
        self.assertEqual(check_send_webhook_message_mock.call_args_list, expected_list)

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 31:</b> &nbsp; 2 fragments, nominal size 11 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1430')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/reviewboard/view.py: 73-85
</a>
<div class="mid" id="frag1430" style="display:none"><pre>
def get_review_published_body(payload: Dict[str, Any]) -&gt; str:
    kwargs = {
        "review_url": payload["review"]["absolute_url"],
        "id": payload["review_request"]["id"],
        "review_request_title": payload["review_request"]["summary"],
        "review_request_url": payload["review_request"]["absolute_url"],
        "user_name": payload["review"]["links"]["user"]["title"],
        "review_body_top": payload["review"]["body_top"],
    }

    return REVIEW_PUBLISHED.format(**kwargs).strip()


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1431')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/reviewboard/view.py: 86-99
</a>
<div class="mid" id="frag1431" style="display:none"><pre>
def get_reply_published_body(payload: Dict[str, Any]) -&gt; str:
    kwargs = {
        "reply_url": payload["reply"]["links"]["self"]["href"],
        "id": payload["review_request"]["id"],
        "review_request_title": payload["review_request"]["summary"],
        "review_request_url": payload["review_request"]["links"]["self"]["href"],
        "user_name": payload["reply"]["links"]["user"]["title"],
        "user_url": payload["reply"]["links"]["user"]["href"],
        "reply_body_top": payload["reply"]["body_top"],
    }

    return REPLY_PUBLISHED.format(**kwargs).strip()


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 32:</b> &nbsp; 3 fragments, nominal size 17 lines, similarity 81%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1432')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/reviewboard/view.py: 100-120
</a>
<div class="mid" id="frag1432" style="display:none"><pre>
def get_review_request_published_body(payload: Dict[str, Any]) -&gt; str:
    kwargs = {
        "id": payload["review_request"]["id"],
        "review_request_title": payload["review_request"]["summary"],
        "review_request_url": payload["review_request"]["absolute_url"],
        "user_name": payload["review_request"]["links"]["submitter"]["title"],
        "description": payload["review_request"]["description"],
        "status": payload["review_request"]["status"],
        "target_people": get_target_people_string(payload),
        "extra_info": "",
    }

    message = REVIEW_REQUEST_PUBLISHED + REVIEW_REQUEST_DETAILS
    branch = payload["review_request"].get("branch")
    if branch and branch is not None:
        branch_info = BRANCH_TEMPLATE.format(branch_name=branch)
        kwargs["extra_info"] = branch_info

    return message.format(**kwargs).strip()


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1433')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/reviewboard/view.py: 121-141
</a>
<div class="mid" id="frag1433" style="display:none"><pre>
def get_review_request_reopened_body(payload: Dict[str, Any]) -&gt; str:
    kwargs = {
        "id": payload["review_request"]["id"],
        "review_request_title": payload["review_request"]["summary"],
        "review_request_url": payload["review_request"]["absolute_url"],
        "user_name": payload["reopened_by"]["username"],
        "description": payload["review_request"]["description"],
        "status": payload["review_request"]["status"],
        "target_people": get_target_people_string(payload),
        "extra_info": "",
    }

    message = REVIEW_REQUEST_REOPENED + REVIEW_REQUEST_DETAILS
    branch = payload["review_request"].get("branch")
    if branch and branch is not None:
        branch_info = BRANCH_TEMPLATE.format(branch_name=branch)
        kwargs["extra_info"] = branch_info

    return message.format(**kwargs).strip()


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1434')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/reviewboard/view.py: 142-162
</a>
<div class="mid" id="frag1434" style="display:none"><pre>
def get_review_request_closed_body(payload: Dict[str, Any]) -&gt; str:
    kwargs = {
        "id": payload["review_request"]["id"],
        "review_request_title": payload["review_request"]["summary"],
        "review_request_url": payload["review_request"]["absolute_url"],
        "user_name": payload["closed_by"]["username"],
        "description": payload["review_request"]["description"],
        "status": payload["review_request"]["status"],
        "target_people": get_target_people_string(payload),
        "extra_info": "**Close type**: {}".format(payload["close_type"]),
    }

    message = REVIEW_REQUEST_CLOSED + REVIEW_REQUEST_DETAILS
    branch = payload["review_request"].get("branch")
    if branch and branch is not None:
        branch_info = BRANCH_TEMPLATE.format(branch_name=branch)
        kwargs["extra_info"] = "{}\n{}".format(kwargs["extra_info"], branch_info)

    return message.format(**kwargs).strip()


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 33:</b> &nbsp; 2 fragments, nominal size 12 lines, similarity 91%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1637')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/github/tests.py: 379-391
</a>
<div class="mid" id="frag1637" style="display:none"><pre>
    def test_ignored_pull_request_actions(self) -&gt; None:
        ignored_actions = [
            "approved",
            "converted_to_draft",
            "labeled",
            "review_request_removed",
            "unlabeled",
        ]
        for action in ignored_actions:
            data = dict(action=action)
            payload = orjson.dumps(data).decode()
            self.verify_post_is_ignored(payload, "pull_request")

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1638')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/github/tests.py: 392-403
</a>
<div class="mid" id="frag1638" style="display:none"><pre>
    def test_ignored_team_actions(self) -&gt; None:
        ignored_actions = [
            "added_to_repository",
            "created",
            "deleted",
            "removed_from_repository",
        ]
        for action in ignored_actions:
            data = dict(action=action)
            payload = orjson.dumps(data).decode()
            self.verify_post_is_ignored(payload, "team")

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 34:</b> &nbsp; 2 fragments, nominal size 14 lines, similarity 73%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1687')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/raygun/view.py: 18-47
</a>
<div class="mid" id="frag1687" style="display:none"><pre>
def api_raygun_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:
    # The payload contains 'event' key. This 'event' key has a value of either
    # 'error_notification' or 'error_activity'. 'error_notification' happens
    # when an error is caught in an application, where as 'error_activity'
    # happens when an action is being taken for the error itself
    # (ignored/resolved/assigned/etc.).
    event = payload["event"]

    # Because we wanted to create a message for all of the payloads, it is best
    # to handle them separately. This is because some payload keys don't exist
    # in the other event.

    if event == "error_notification":
        message = compose_notification_message(payload)
    elif event == "error_activity":
        message = compose_activity_message(payload)
    else:
        raise UnsupportedWebhookEventType(event)

    topic = "test"

    check_send_webhook_message(request, user_profile, topic, message, event)

    return json_success(request)


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1827')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/pingdom/view.py: 44-60
</a>
<div class="mid" id="frag1827" style="display:none"><pre>
def api_pingdom_webhook(
    request: HttpRequest,
    user_profile: UserProfile,
    payload: Dict[str, Any] = REQ(argument_type="body"),
) -&gt; HttpResponse:
    check_type = get_check_type(payload)

    if check_type in SUPPORTED_CHECK_TYPES:
        subject = get_subject_for_http_request(payload)
        body = get_body_for_http_request(payload)
    else:
        raise UnsupportedWebhookEventType(check_type)

    check_send_webhook_message(request, user_profile, subject, body, check_type)
    return json_success(request)


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 35:</b> &nbsp; 2 fragments, nominal size 12 lines, similarity 83%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1701')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/jira/tests.py: 67-87
</a>
<div class="mid" id="frag1701" style="display:none"><pre>
    def test_created_with_stream_with_spaces_escaped(self) -&gt; None:
        self.STREAM_NAME = quote("jira alerts")
        self.url = self.build_webhook_url()
        self.subscribe(self.test_user, unquote(self.STREAM_NAME))

        payload = self.get_body("created_v1")
        result = self.client_post(self.url, payload, content_type="application/json")

        self.assert_json_success(result)

        expected_topic = "BUG-15: New bug with hook"
        expected_message = """
Leo Franchi created [BUG-15: New bug with hook](http://lfranchi.com:8080/browse/BUG-15):

* **Priority**: Major
* **Assignee**: no one
""".strip()
        msg = self.get_last_message()
        self.assertEqual(msg.content, expected_message)
        self.assertEqual(msg.topic_name(), expected_topic)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1702')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/jira/tests.py: 88-108
</a>
<div class="mid" id="frag1702" style="display:none"><pre>
    def test_created_with_stream_with_spaces_double_escaped(self) -&gt; None:
        self.STREAM_NAME = quote(quote("jira alerts"))
        self.url = self.build_webhook_url()
        self.subscribe(self.test_user, unquote(unquote(self.STREAM_NAME)))

        payload = self.get_body("created_v1")
        result = self.client_post(self.url, payload, content_type="application/json")

        self.assert_json_success(result)

        expected_topic = "BUG-15: New bug with hook"
        expected_message = """
Leo Franchi created [BUG-15: New bug with hook](http://lfranchi.com:8080/browse/BUG-15):

* **Priority**: Major
* **Assignee**: no one
""".strip()
        msg = self.get_last_message()
        self.assertEqual(msg.content, expected_message)
        self.assertEqual(msg.topic_name(), expected_topic)

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 36:</b> &nbsp; 4 fragments, nominal size 11 lines, similarity 75%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1719')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/jira/tests.py: 238-250
</a>
<div class="mid" id="frag1719" style="display:none"><pre>
    def test_anomalous_webhook_payload_error(self) -&gt; None:
        with self.assertRaises(AssertionError) as e:
            self.check_webhook(
                fixture_name="example_anomalous_payload",
                expected_topic="",
                expected_message="",
                expect_noop=True,
            )

        self.assertIn(
            "Unable to parse request: Did Jira generate this event?",
            e.exception.args[0],
        )
</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1723')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/newrelic/tests.py: 51-63
</a>
<div class="mid" id="frag1723" style="display:none"><pre>
    def test_not_recognized(self) -&gt; None:
        with self.assertRaises(AssertionError) as e:
            self.check_webhook(
                "incident_state_not_recognized",
                "",
                "",
                content_type="application/json",
            )
        self.assertIn(
            "The newrelic webhook requires current_state be in [open|acknowledged|closed]",
            e.exception.args[0],
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1725')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/newrelic/tests.py: 80-92
</a>
<div class="mid" id="frag1725" style="display:none"><pre>
    def test_missing_current_state(self) -&gt; None:
        with self.assertRaises(AssertionError) as e:
            self.check_webhook(
                "incident_missing_current_state",
                "",
                "",
                content_type="application/json",
            )
        self.assertIn(
            "The newrelic webhook requires current_state be in [open|acknowledged|closed]",
            e.exception.args[0],
        )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1726')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/newrelic/tests.py: 93-104
</a>
<div class="mid" id="frag1726" style="display:none"><pre>
    def test_missing_timestamp(self) -&gt; None:
        with self.assertRaises(AssertionError) as e:
            self.check_webhook(
                "incident_missing_timestamp",
                "",
                "",
                content_type="application/json",
            )
        self.assertIn(
            "The newrelic webhook requires timestamp in milliseconds", e.exception.args[0]
        )

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 37:</b> &nbsp; 2 fragments, nominal size 12 lines, similarity 75%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1788')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/basecamp/view.py: 122-136
</a>
<div class="mid" id="frag1788" style="display:none"><pre>
def get_questions_answer_body(event: str, payload: WildValue) -&gt; str:
    verb = get_verb(event, "question_answer_")
    question = payload["recording"]["parent"]
    title = question["title"].tame(check_string)
    template = add_punctuation_if_necessary(QUESTIONS_ANSWER_TEMPLATE, title)

    return template.format(
        user_name=get_event_creator(payload),
        verb=verb,
        answer_url=get_subject_url(payload),
        question_title=title,
        question_url=question["app_url"].tame(check_string),
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1789')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/basecamp/view.py: 137-150
</a>
<div class="mid" id="frag1789" style="display:none"><pre>
def get_comment_body(event: str, payload: WildValue) -&gt; str:
    verb = get_verb(event, "comment_")
    task = payload["recording"]["parent"]
    template = add_punctuation_if_necessary(COMMENT_TEMPLATE, task["title"].tame(check_string))

    return template.format(
        user_name=get_event_creator(payload),
        verb=verb,
        answer_url=get_subject_url(payload),
        task_title=task["title"].tame(check_string),
        task_url=task["app_url"].tame(check_string),
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 38:</b> &nbsp; 2 fragments, nominal size 14 lines, similarity 75%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1922')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gitlab/view.py: 130-143
</a>
<div class="mid" id="frag1922" style="display:none"><pre>
def get_merge_request_event_body(
    payload: Dict[str, Any], action: str, include_title: bool = False
) -&gt; str:
    pull_request = payload["object_attributes"]
    return get_pull_request_event_message(
        get_issue_user_name(payload),
        action,
        pull_request.get("url"),
        pull_request.get("iid"),
        type="MR",
        title=payload["object_attributes"].get("title") if include_title else None,
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1923')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gitlab/view.py: 144-161
</a>
<div class="mid" id="frag1923" style="display:none"><pre>
def get_merge_request_open_or_updated_body(
    payload: Dict[str, Any], action: str, include_title: bool = False
) -&gt; str:
    pull_request = payload["object_attributes"]
    return get_pull_request_event_message(
        get_issue_user_name(payload),
        action,
        pull_request.get("url"),
        pull_request.get("iid"),
        pull_request.get("source_branch"),
        pull_request.get("target_branch"),
        pull_request.get("description"),
        assignees=replace_assignees_username_with_name(get_assignees(payload)),
        type="MR",
        title=payload["object_attributes"].get("title") if include_title else None,
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 39:</b> &nbsp; 3 fragments, nominal size 17 lines, similarity 83%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1927')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gitlab/view.py: 197-217
</a>
<div class="mid" id="frag1927" style="display:none"><pre>
def get_commented_merge_request_event_body(
    payload: Dict[str, Any], include_title: bool = False
) -&gt; str:
    comment = payload["object_attributes"]
    action = "[commented]({}) on".format(comment["url"])
    url = "{}/merge_requests/{}".format(
        payload["project"].get("web_url"),
        payload["merge_request"].get("iid"),
    )

    return get_pull_request_event_message(
        get_issue_user_name(payload),
        action,
        url,
        payload["merge_request"].get("iid"),
        message=comment["note"],
        type="MR",
        title=payload["merge_request"].get("title") if include_title else None,
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1928')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gitlab/view.py: 218-236
</a>
<div class="mid" id="frag1928" style="display:none"><pre>
def get_commented_issue_event_body(payload: Dict[str, Any], include_title: bool = False) -&gt; str:
    comment = payload["object_attributes"]
    action = "[commented]({}) on".format(comment["url"])
    url = "{}/issues/{}".format(
        payload["project"].get("web_url"),
        payload["issue"].get("iid"),
    )

    return get_pull_request_event_message(
        get_issue_user_name(payload),
        action,
        url,
        payload["issue"].get("iid"),
        message=comment["note"],
        type="issue",
        title=payload["issue"].get("title") if include_title else None,
    )


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1929')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/gitlab/view.py: 237-255
</a>
<div class="mid" id="frag1929" style="display:none"><pre>
def get_commented_snippet_event_body(payload: Dict[str, Any], include_title: bool = False) -&gt; str:
    comment = payload["object_attributes"]
    action = "[commented]({}) on".format(comment["url"])
    url = "{}/snippets/{}".format(
        payload["project"].get("web_url"),
        payload["snippet"].get("id"),
    )

    return get_pull_request_event_message(
        get_issue_user_name(payload),
        action,
        url,
        payload["snippet"].get("id"),
        message=comment["note"],
        type="snippet",
        title=payload["snippet"].get("title") if include_title else None,
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 40:</b> &nbsp; 2 fragments, nominal size 11 lines, similarity 72%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag1995')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/view.py: 96-109
</a>
<div class="mid" id="frag1995" style="display:none"><pre>
def format_freshdesk_note_message(ticket: TicketDict, event_info: List[str]) -&gt; str:
    """There are public (visible to customers) and private note types."""
    note_type = event_info[1]
    content = NOTE_TEMPLATE.format(
        name=ticket.requester_name,
        email=ticket.requester_email,
        note_type=note_type,
        ticket_id=ticket.id,
        ticket_url=ticket.url,
    )

    return content


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag1996')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/freshdesk/view.py: 110-127
</a>
<div class="mid" id="frag1996" style="display:none"><pre>
def format_freshdesk_property_change_message(ticket: TicketDict, event_info: List[str]) -&gt; str:
    """Freshdesk will only tell us the first event to match our webhook
    configuration, so if we change multiple properties, we only get the before
    and after data for the first one.
    """
    content = PROPERTY_CHANGE_TEMPLATE.format(
        name=ticket.requester_name,
        email=ticket.requester_email,
        ticket_id=ticket.id,
        ticket_url=ticket.url,
        property_name=event_info[0].capitalize(),
        old=event_info[1],
        new=event_info[2],
    )

    return content


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 41:</b> &nbsp; 2 fragments, nominal size 10 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2019')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/transifex/tests.py: 17-27
</a>
<div class="mid" id="frag2019" style="display:none"><pre>
    def test_transifex_reviewed_message(self) -&gt; None:
        expected_topic = f"{self.PROJECT} in {self.LANGUAGE}"
        expected_message = f"Resource {self.RESOURCE} fully reviewed."
        self.url = self.build_webhook_url(
            self.URL_REVIEWED_METHOD_TEMPLATE,
            project=self.PROJECT,
            language=self.LANGUAGE,
            resource=self.RESOURCE,
        )
        self.check_webhook("", expected_topic, expected_message)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2020')" href="javascript:;">
zulip-5.0-rc1/zerver/webhooks/transifex/tests.py: 28-38
</a>
<div class="mid" id="frag2020" style="display:none"><pre>
    def test_transifex_translated_message(self) -&gt; None:
        expected_topic = f"{self.PROJECT} in {self.LANGUAGE}"
        expected_message = f"Resource {self.RESOURCE} fully translated."
        self.url = self.build_webhook_url(
            self.URL_TRANSLATED_METHOD_TEMPLATE,
            project=self.PROJECT,
            language=self.LANGUAGE,
            resource=self.RESOURCE,
        )
        self.check_webhook("", expected_topic, expected_message)

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 42:</b> &nbsp; 2 fragments, nominal size 14 lines, similarity 100%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2124')" href="javascript:;">
zulip-5.0-rc1/analytics/migrations/0009_remove_messages_to_stream_stat.py: 6-22
</a>
<div class="mid" id="frag2124" style="display:none"><pre>
def delete_messages_sent_to_stream_stat(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    UserCount = apps.get_model("analytics", "UserCount")
    StreamCount = apps.get_model("analytics", "StreamCount")
    RealmCount = apps.get_model("analytics", "RealmCount")
    InstallationCount = apps.get_model("analytics", "InstallationCount")
    FillState = apps.get_model("analytics", "FillState")

    property = "messages_sent_to_stream:is_bot"
    UserCount.objects.filter(property=property).delete()
    StreamCount.objects.filter(property=property).delete()
    RealmCount.objects.filter(property=property).delete()
    InstallationCount.objects.filter(property=property).delete()
    FillState.objects.filter(property=property).delete()


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2125')" href="javascript:;">
zulip-5.0-rc1/analytics/migrations/0010_clear_messages_sent_values.py: 6-22
</a>
<div class="mid" id="frag2125" style="display:none"><pre>
def clear_message_sent_by_message_type_values(
    apps: StateApps, schema_editor: DatabaseSchemaEditor
) -&gt; None:
    UserCount = apps.get_model("analytics", "UserCount")
    StreamCount = apps.get_model("analytics", "StreamCount")
    RealmCount = apps.get_model("analytics", "RealmCount")
    InstallationCount = apps.get_model("analytics", "InstallationCount")
    FillState = apps.get_model("analytics", "FillState")

    property = "messages_sent:message_type:day"
    UserCount.objects.filter(property=property).delete()
    StreamCount.objects.filter(property=property).delete()
    RealmCount.objects.filter(property=property).delete()
    InstallationCount.objects.filter(property=property).delete()
    FillState.objects.filter(property=property).delete()


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 43:</b> &nbsp; 2 fragments, nominal size 22 lines, similarity 75%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2133')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 72-92
</a>
<div class="mid" id="frag2133" style="display:none"><pre>
        def check_zulip_realm_query_result(result: HttpResponse) -&gt; None:
            zulip_realm = get_realm("zulip")
            first_human_user = zulip_realm.get_first_human_user()
            assert first_human_user is not None
            self.assert_in_success_response(
                [
                    f"&lt;b&gt;First human user&lt;/b&gt;: {first_human_user.delivery_email}\n",
                    f'&lt;input type="hidden" name="realm_id" value="{zulip_realm.id}"',
                    "Zulip Dev&lt;/h3&gt;",
                    '&lt;option value="1" selected&gt;Self-hosted&lt;/option&gt;',
                    '&lt;option value="2" &gt;Limited&lt;/option&gt;',
                    'input type="number" name="discount" value="None"',
                    '&lt;option value="active" selected&gt;Active&lt;/option&gt;',
                    '&lt;option value="deactivated" &gt;Deactivated&lt;/option&gt;',
                    f'&lt;option value="{zulip_realm.org_type}" selected&gt;',
                    'scrub-realm-button"&gt;',
                    'data-string-id="zulip"',
                ],
                result,
            )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2134')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 93-117
</a>
<div class="mid" id="frag2134" style="display:none"><pre>
        def check_lear_realm_query_result(result: HttpResponse) -&gt; None:
            lear_realm = get_realm("lear")
            self.assert_in_success_response(
                [
                    f'&lt;input type="hidden" name="realm_id" value="{lear_realm.id}"',
                    "Lear &amp;amp; Co.&lt;/h3&gt;",
                    '&lt;option value="1" selected&gt;Self-hosted&lt;/option&gt;',
                    '&lt;option value="2" &gt;Limited&lt;/option&gt;',
                    'input type="number" name="discount" value="None"',
                    '&lt;option value="active" selected&gt;Active&lt;/option&gt;',
                    '&lt;option value="deactivated" &gt;Deactivated&lt;/option&gt;',
                    'scrub-realm-button"&gt;',
                    'data-string-id="lear"',
                    "&lt;b&gt;Name&lt;/b&gt;: Zulip Cloud Standard",
                    "&lt;b&gt;Status&lt;/b&gt;: Active",
                    "&lt;b&gt;Billing schedule&lt;/b&gt;: Annual",
                    "&lt;b&gt;Licenses&lt;/b&gt;: 2/10 (Manual)",
                    "&lt;b&gt;Price per license&lt;/b&gt;: $80.0",
                    "&lt;b&gt;Next invoice date&lt;/b&gt;: 02 January 2017",
                    '&lt;option value="send_invoice" selected&gt;',
                    '&lt;option value="charge_automatically" &gt;',
                ],
                result,
            )

</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 44:</b> &nbsp; 5 fragments, nominal size 18 lines, similarity 71%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag2141')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 337-367
</a>
<div class="mid" id="frag2141" style="display:none"><pre>
    def test_change_realm_plan_type(self) -&gt; None:
        cordelia = self.example_user("cordelia")
        self.login_user(cordelia)

        result = self.client_post(
            "/activity/support", {"realm_id": f"{cordelia.realm_id}", "plan_type": "2"}
        )
        self.assertEqual(result.status_code, 302)
        self.assertEqual(result["Location"], "/login/")

        iago = self.example_user("iago")
        self.login_user(iago)

        with mock.patch("analytics.views.support.do_change_realm_plan_type") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{iago.realm_id}", "plan_type": "2"}
            )
            m.assert_called_once_with(get_realm("zulip"), 2, acting_user=iago)
            self.assert_in_success_response(
                ["Plan type of zulip changed from self-hosted to limited"], result
            )

        with mock.patch("analytics.views.support.do_change_realm_plan_type") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{iago.realm_id}", "plan_type": "10"}
            )
            m.assert_called_once_with(get_realm("zulip"), 10, acting_user=iago)
            self.assert_in_success_response(
                ["Plan type of zulip changed from self-hosted to plus"], result
            )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2142')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 368-389
</a>
<div class="mid" id="frag2142" style="display:none"><pre>
    def test_change_org_type(self) -&gt; None:
        cordelia = self.example_user("cordelia")
        self.login_user(cordelia)

        result = self.client_post(
            "/activity/support", {"realm_id": f"{cordelia.realm_id}", "org_type": "70"}
        )
        self.assertEqual(result.status_code, 302)
        self.assertEqual(result["Location"], "/login/")

        iago = self.example_user("iago")
        self.login_user(iago)

        with mock.patch("analytics.views.support.do_change_realm_org_type") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{iago.realm_id}", "org_type": "70"}
            )
            m.assert_called_once_with(get_realm("zulip"), 70, acting_user=iago)
            self.assert_in_success_response(
                ["Org type of zulip changed from Business to Government"], result
            )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2146')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 479-507
</a>
<div class="mid" id="frag2146" style="display:none"><pre>
    def test_activate_or_deactivate_realm(self) -&gt; None:
        cordelia = self.example_user("cordelia")
        lear_realm = get_realm("lear")
        self.login_user(cordelia)

        result = self.client_post(
            "/activity/support", {"realm_id": f"{lear_realm.id}", "status": "deactivated"}
        )
        self.assertEqual(result.status_code, 302)
        self.assertEqual(result["Location"], "/login/")

        self.login("iago")

        with mock.patch("analytics.views.support.do_deactivate_realm") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{lear_realm.id}", "status": "deactivated"}
            )
            m.assert_called_once_with(lear_realm, acting_user=self.example_user("iago"))
            self.assert_in_success_response(["lear deactivated"], result)

        with mock.patch("analytics.views.support.do_send_realm_reactivation_email") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{lear_realm.id}", "status": "active"}
            )
            m.assert_called_once_with(lear_realm, acting_user=self.example_user("iago"))
            self.assert_in_success_response(
                ["Realm reactivation email sent to admins of lear"], result
            )

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2143')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 390-410
</a>
<div class="mid" id="frag2143" style="display:none"><pre>
    def test_attach_discount(self) -&gt; None:
        cordelia = self.example_user("cordelia")
        lear_realm = get_realm("lear")
        self.login_user(cordelia)

        result = self.client_post(
            "/activity/support", {"realm_id": f"{lear_realm.id}", "discount": "25"}
        )
        self.assertEqual(result.status_code, 302)
        self.assertEqual(result["Location"], "/login/")

        iago = self.example_user("iago")
        self.login("iago")

        with mock.patch("analytics.views.support.attach_discount_to_realm") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{lear_realm.id}", "discount": "25"}
            )
            m.assert_called_once_with(get_realm("lear"), 25, acting_user=iago)
            self.assert_in_success_response(["Discount of lear changed to 25% from 0%"], result)

</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag2149')" href="javascript:;">
zulip-5.0-rc1/analytics/tests/test_support_views.py: 609-632
</a>
<div class="mid" id="frag2149" style="display:none"><pre>
    def test_scrub_realm(self) -&gt; None:
        cordelia = self.example_user("cordelia")
        lear_realm = get_realm("lear")
        self.login_user(cordelia)

        result = self.client_post(
            "/activity/support", {"realm_id": f"{lear_realm.id}", "discount": "25"}
        )
        self.assertEqual(result.status_code, 302)
        self.assertEqual(result["Location"], "/login/")

        self.login("iago")

        with mock.patch("analytics.views.support.do_scrub_realm") as m:
            result = self.client_post(
                "/activity/support", {"realm_id": f"{lear_realm.id}", "scrub_realm": "true"}
            )
            m.assert_called_once_with(lear_realm, acting_user=self.example_user("iago"))
            self.assert_in_success_response(["lear scrubbed"], result)

        with mock.patch("analytics.views.support.do_scrub_realm") as m:
            result = self.client_post("/activity/support", {"realm_id": f"{lear_realm.id}"})
            self.assert_json_error(result, "Invalid parameters")
            m.assert_not_called()
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<script language="JavaScript">
function ShowHide(divId) { 
    if(document.getElementById(divId).style.display == 'none') {
        document.getElementById(divId).style.display='block';
    } else { 
        document.getElementById(divId).style.display = 'none';
    } 
}
</script>
</body>
</html>
